import{j as e}from"./radix-B6Y-MRu0.js";import{a as r}from"./vendor-DEQSVNfj.js";import{m as Ce}from"./ArrowsClockwise.es-DS70dwCP.js";import{c as Y,i as A,f as Q,p as Ne,k as y,h as D,C as W,B as x,j as G,I as J,L as Ae}from"./index-vswyqp58.js";import{a as k,b as Se}from"./Globe.es-CtUoIY1T.js";import{m as we}from"./FloppyDisk.es-CJlG_KS3.js";import{c as P}from"./Lightning.es-C-Sz8AXK.js";import{n as T}from"./Plus.es-DN9hvW10.js";import{n as V}from"./Trash.es-DhgoD9TD.js";import{M as Ee}from"./Modal-7_eTIvz3.js";import{B as S}from"./Badge-CZ5NzBfK.js";import{S as X}from"./Select-PwXyFoxR.js";import{H as _}from"./HelpCard-BINCqYIf.js";import{S as L}from"./StatusIndicator-59tXXk5o.js";import{C as Me,a as ke,b as u,c as $,d as f}from"./DetailCard-BKBzFg8i.js";import{R as _e}from"./ResponsiveDataTable-kYvH3TtM.js";import{R as ze}from"./ResponsiveLayout-BgG2EW8C.js";import{c as Re}from"./cas.service-CAbj5j2-.js";import{a as d}from"./acme.service-CvmaI0ze.js";import"./CaretDown.es-DuThAI6u.js";import"./Fingerprint.es-a52JDt2Q.js";import"./CaretUp.es-CYK8cpGg.js";import"./CaretRight.es-B3hFfvz_.js";import"./ArrowLeft.es-CZcTzWfI.js";import"./UnifiedPageHeader-Cbwye_R6.js";function ct(){const{showSuccess:m,showError:i,showConfirm:v,showWarning:j}=Y(),[n,z]=r.useState([]),[s,l]=r.useState(null),[p,Z]=r.useState([]),[h,ee]=r.useState([]),[c,F]=r.useState({}),[te,se]=r.useState([]),[ae,O]=r.useState(!0),[I,q]=r.useState(!1),[w,re]=r.useState("config"),[E,U]=r.useState("account"),[ce,C]=r.useState(!1),[N,ne]=r.useState(""),[M,B]=r.useState("");r.useEffect(()=>{g()},[]);const g=async()=>{O(!0);try{const[t,a,o]=await Promise.all([d.getAccounts(),d.getSettings(),Re.getAll()]);z(t.data||t.accounts||[]),F(a.data||a||{}),se(o.data||o.cas||[])}catch{i("Failed to load ACME data")}finally{O(!1)}},H=r.useCallback(async t=>{try{const[a,o,K]=await Promise.all([d.getAccountById(t.id),d.getOrders(t.id),d.getChallenges(t.id)]);l(a.data||a),Z(o.data?.orders||o.orders||[]),ee(K.data?.challenges||K.challenges||[]),U("account")}catch{i("Failed to load account details")}},[i]),ie=async()=>{q(!0);try{await d.updateSettings(c),m("ACME settings saved")}catch(t){i(t.message||"Failed to save settings")}finally{q(!1)}},R=(t,a)=>{F(o=>({...o,[t]:a}))},le=async()=>{if(!M){i("Email is required");return}try{await d.registerProxy(M),m("Proxy account registered"),B(""),g()}catch(t){i(t.message||"Failed to register proxy")}},oe=async()=>{if(await v("Unregister Let's Encrypt proxy account?"))try{await d.unregisterProxy(),m("Proxy account unregistered"),g()}catch(a){i(a.message||"Failed to unregister")}},de=async t=>{try{const a=await d.createAccount(t);m("ACME account created"),C(!1),g(),H(a)}catch(a){i(a.message||"Failed to create account")}},xe=async t=>{if(await v("Deactivate this ACME account?",{title:"Deactivate Account",confirmText:"Deactivate",variant:"danger"}))try{await d.deactivateAccount(t),m("Account deactivated"),l(null),g()}catch(o){i(o.message||"Failed to deactivate")}},me=async t=>{if(await v("Delete this ACME account?",{title:"Delete Account",confirmText:"Delete",variant:"danger"}))try{await d.deleteAccount(t),m("Account deleted"),l(null),g()}catch(o){i(o.message||"Failed to delete")}},b=r.useMemo(()=>({total:n.length,active:n.filter(t=>t.status==="valid").length,orders:p.length,pending:h.filter(t=>t.status==="pending").length}),[n,p,h]),ue=r.useMemo(()=>{if(!N)return n;const t=N.toLowerCase();return n.filter(a=>a.email?.toLowerCase().includes(t)||a.contact?.[0]?.toLowerCase().includes(t))},[n,N]),pe=r.useMemo(()=>[{key:"email",label:"Email",render:(t,a)=>e.jsx("span",{className:"font-medium text-text-primary",children:a.contact?.[0]?.replace("mailto:","")||a.email||`Account #${a.id}`})},{key:"status",label:"Status",render:t=>e.jsxs(S,{variant:t==="valid"?"success":"secondary",size:"sm",children:[t==="valid"&&e.jsx(A,{size:10,weight:"fill"}),t]})},{key:"created_at",label:"Created",render:t=>Q(t)}],[]),he=[{id:"config",label:"Configuration",icon:Ne},{id:"accounts",label:"Accounts",icon:y,count:n.length}],ge=[{id:"account",label:"Details",icon:y},{id:"orders",label:"Orders",icon:k,count:p.length},{id:"challenges",label:"Challenges",icon:D,count:h.length}],ye=e.jsxs(e.Fragment,{children:[e.jsxs(x,{variant:"secondary",size:"sm",onClick:g,className:"hidden md:inline-flex",children:[e.jsx(Ce,{size:14}),"Refresh"]}),w==="accounts"&&e.jsxs(x,{size:"sm",onClick:()=>C(!0),children:[e.jsx(T,{size:14}),e.jsx("span",{className:"hidden sm:inline",children:"New Account"})]})]}),je=e.jsxs("div",{className:"p-4 space-y-4",children:[e.jsxs(W,{className:"p-4 space-y-3 bg-gradient-to-br from-accent-primary/5 to-transparent",children:[e.jsxs("h3",{className:"text-sm font-semibold text-text-primary flex items-center gap-2",children:[e.jsx(Se,{size:16,className:"text-accent-primary"}),"ACME Statistics"]}),e.jsxs("div",{className:"grid grid-cols-2 gap-3",children:[e.jsxs("div",{className:"text-center p-3 bg-bg-tertiary rounded-lg",children:[e.jsx("p",{className:"text-2xl font-bold text-text-primary",children:b.total}),e.jsx("p",{className:"text-xs text-text-secondary",children:"Accounts"})]}),e.jsxs("div",{className:"text-center p-3 bg-bg-tertiary rounded-lg",children:[e.jsx("p",{className:"text-2xl font-bold status-success-text",children:b.active}),e.jsx("p",{className:"text-xs text-text-secondary",children:"Active"})]}),e.jsxs("div",{className:"text-center p-3 bg-bg-tertiary rounded-lg",children:[e.jsx("p",{className:"text-2xl font-bold text-accent-primary",children:b.orders}),e.jsx("p",{className:"text-xs text-text-secondary",children:"Orders"})]}),e.jsxs("div",{className:"text-center p-3 bg-bg-tertiary rounded-lg",children:[e.jsx("p",{className:"text-2xl font-bold status-warning-text",children:b.pending}),e.jsx("p",{className:"text-xs text-text-secondary",children:"Pending"})]})]})]}),e.jsxs(W,{className:`p-4 space-y-3 ${c.enabled?"stat-card-success":"stat-card-warning"}`,children:[e.jsxs("h3",{className:"text-sm font-semibold text-text-primary flex items-center gap-2",children:[e.jsx(P,{size:16,className:"text-accent-primary"}),"Server Status"]}),e.jsxs("div",{className:"space-y-2",children:[e.jsxs("div",{className:"flex items-center justify-between",children:[e.jsx("span",{className:"text-sm text-text-secondary",children:"ACME Server"}),e.jsx(L,{status:c.enabled?"success":"warning",children:c.enabled?"Enabled":"Disabled"})]}),e.jsxs("div",{className:"flex items-center justify-between",children:[e.jsx("span",{className:"text-sm text-text-secondary",children:"LE Proxy"}),e.jsx(L,{status:c.proxy_enabled?c.proxy_registered?"success":"warning":"inactive",children:c.proxy_enabled?c.proxy_registered?"Active":"Setup Required":"Disabled"})]})]})]}),e.jsxs("div",{className:"space-y-3",children:[e.jsx(_,{variant:"info",title:"About ACME",children:"ACME (Automatic Certificate Management Environment) enables automated certificate issuance. Compatible with certbot, acme.sh, and other ACME clients."}),e.jsx(_,{variant:"tip",title:"Let's Encrypt Proxy",children:"Enable the LE Proxy to forward requests to Let's Encrypt while maintaining centralized audit logging and control."}),e.jsx(_,{variant:"warning",title:"Account Security",children:"ACME accounts contain private keys. Deactivate or delete unused accounts to minimize security exposure."})]})]}),be=s&&e.jsxs("div",{className:"p-3 space-y-3",children:[e.jsx(Me,{icon:y,iconClass:s.status==="valid"?"bg-status-success/20":"bg-bg-tertiary",title:s.contact?.[0]?.replace("mailto:","")||s.email||"Account",subtitle:`ID: ${s.account_id?.substring(0,24)}...`,badge:e.jsxs(S,{variant:s.status==="valid"?"success":"secondary",size:"sm",children:[s.status==="valid"&&e.jsx(A,{size:10,weight:"fill"}),s.status]})}),e.jsx(ke,{stats:[{icon:y,value:s.key_type||"RSA-2048"},{icon:k,value:`${p.length} orders`},{icon:D,value:`${h.length} challenges`}]}),e.jsxs("div",{className:"flex gap-2",children:[e.jsxs(x,{size:"sm",variant:"secondary",className:"flex-1",onClick:()=>xe(s.id),disabled:s.status!=="valid",children:[e.jsx(G,{size:14}),"Deactivate"]}),e.jsx(x,{size:"sm",variant:"danger",onClick:()=>me(s.id),children:e.jsx(V,{size:14})})]}),e.jsx("div",{className:"flex gap-1 border-b border-border",children:ge.map(t=>e.jsxs("button",{onClick:()=>U(t.id),className:`flex items-center gap-1.5 px-3 py-2 text-xs font-medium border-b-2 transition-colors ${E===t.id?"border-accent-primary text-accent-primary":"border-transparent text-text-secondary hover:text-text-primary"}`,children:[e.jsx(t.icon,{size:14}),t.label,t.count>0&&e.jsx("span",{className:"ml-1 px-1.5 py-0.5 text-[10px] rounded-full bg-bg-tertiary",children:t.count})]},t.id))}),E==="account"&&e.jsxs("div",{className:"space-y-3",children:[e.jsx(u,{title:"Account Information",children:e.jsxs($,{children:[e.jsx(f,{label:"Email",value:s.contact?.[0]?.replace("mailto:","")||s.email}),e.jsx(f,{label:"Status",children:e.jsx(L,{status:s.status==="valid"?"active":"inactive",children:s.status})}),e.jsx(f,{label:"Key Type",value:s.key_type||"RSA-2048"}),e.jsx(f,{label:"Created",value:Q(s.created_at)})]})}),e.jsx(u,{title:"Account ID",collapsible:!0,defaultOpen:!1,children:e.jsx("p",{className:"font-mono text-[10px] text-text-secondary break-all bg-bg-tertiary/50 p-2 rounded",children:s.account_id})}),e.jsx(u,{title:"Terms of Service",children:e.jsx("div",{className:"flex items-center gap-2 text-xs",children:s.terms_of_service_agreed||s.tos_agreed?e.jsxs(e.Fragment,{children:[e.jsx(A,{size:14,className:"status-success-text",weight:"fill"}),e.jsx("span",{className:"status-success-text",children:"Accepted"})]}):e.jsxs(e.Fragment,{children:[e.jsx(G,{size:14,className:"status-danger-text",weight:"fill"}),e.jsx("span",{className:"status-danger-text",children:"Not Accepted"})]})})})]}),E==="orders"&&e.jsx(u,{title:`${p.length} Orders`,children:p.length===0?e.jsx("p",{className:"text-xs text-text-tertiary py-4 text-center",children:"No certificate orders"}):e.jsx("div",{className:"space-y-2 max-h-64 overflow-y-auto",children:p.map((t,a)=>e.jsxs("div",{className:"flex items-center justify-between p-2 bg-bg-tertiary/30 rounded text-xs",children:[e.jsx("span",{className:"text-text-primary truncate flex-1",children:t.domain||t.identifier}),e.jsx(S,{variant:t.status==="valid"?"success":"warning",size:"sm",children:t.status})]},a))})}),E==="challenges"&&e.jsx(u,{title:`${h.length} Challenges`,children:h.length===0?e.jsx("p",{className:"text-xs text-text-tertiary py-4 text-center",children:"No active challenges"}):e.jsx("div",{className:"space-y-2 max-h-64 overflow-y-auto",children:h.map((t,a)=>e.jsxs("div",{className:"p-2 bg-bg-tertiary/30 rounded text-xs space-y-1",children:[e.jsxs("div",{className:"flex items-center justify-between",children:[e.jsx(S,{variant:"secondary",size:"sm",children:t.type}),e.jsx(S,{variant:t.status==="valid"?"success":t.status==="pending"?"warning":"danger",size:"sm",children:t.status})]}),e.jsx("p",{className:"text-text-secondary truncate",children:t.domain})]},a))})})]}),fe=e.jsxs("div",{className:"p-4 space-y-4",children:[e.jsx(_,{variant:"info",title:"About ACME Protocol",compact:!0,children:"ACME enables automated certificate issuance. Configure the server below, then use the directory URL with any ACME client (certbot, acme.sh, etc.)."}),e.jsx(u,{title:"ACME Server",icon:k,children:e.jsxs("div",{className:"space-y-3",children:[e.jsxs("label",{className:"flex items-center gap-3 cursor-pointer p-2 rounded-lg hover:bg-bg-tertiary/50 transition-colors",children:[e.jsx("input",{type:"checkbox",checked:c.enabled||!1,onChange:t=>R("enabled",t.target.checked),className:"w-4 h-4 rounded border-border bg-bg-tertiary text-accent-primary focus:ring-accent-primary/50"}),e.jsxs("div",{children:[e.jsx("p",{className:"text-sm text-text-primary font-medium",children:"Enable ACME Server"}),e.jsx("p",{className:"text-xs text-text-secondary",children:"Allow automated certificate issuance via ACME"})]})]}),e.jsx(X,{label:"Default Issuing CA",value:c.issuing_ca_id?.toString()||"",onChange:t=>R("issuing_ca_id",t?parseInt(t):null),disabled:!c.enabled,placeholder:"Select a CA...",options:te.map(t=>({value:t.id.toString(),label:t.name||t.common_name}))})]})}),e.jsxs(u,{title:"ACME Endpoints",icon:P,children:[e.jsx($,{columns:1,children:e.jsx(f,{label:"Directory URL",value:`${window.location.origin}/acme/directory`,mono:!0,copyable:!0})}),e.jsxs("p",{className:"text-xs text-text-tertiary mt-2",children:["Use this URL with certbot: ",e.jsxs("code",{className:"bg-bg-tertiary px-1 rounded",children:["--server ",window.location.origin,"/acme/directory"]})]})]}),e.jsx(u,{title:"Let's Encrypt Proxy",icon:D,children:e.jsxs("div",{className:"space-y-3",children:[e.jsxs("label",{className:"flex items-center gap-3 cursor-pointer p-2 rounded-lg hover:bg-bg-tertiary/50 transition-colors",children:[e.jsx("input",{type:"checkbox",checked:c.proxy_enabled||!1,onChange:t=>R("proxy_enabled",t.target.checked),className:"w-4 h-4 rounded border-border bg-bg-tertiary text-accent-primary focus:ring-accent-primary/50"}),e.jsxs("div",{children:[e.jsx("p",{className:"text-sm text-text-primary font-medium",children:"Enable Let's Encrypt Proxy"}),e.jsx("p",{className:"text-xs text-text-secondary",children:"Forward requests to Let's Encrypt with audit logging"})]})]}),c.proxy_enabled&&e.jsxs(e.Fragment,{children:[e.jsx($,{columns:1,children:e.jsx(f,{label:"Proxy Endpoint",value:`${window.location.origin}/api/v2/acme/proxy`,mono:!0,copyable:!0})}),c.proxy_registered?e.jsx("div",{className:"p-3 rounded-lg status-success-bg status-success-border border",children:e.jsxs("div",{className:"flex items-center justify-between",children:[e.jsxs("div",{className:"flex items-center gap-2",children:[e.jsx(A,{size:18,className:"status-success-text",weight:"fill"}),e.jsxs("div",{children:[e.jsx("p",{className:"text-sm font-medium text-text-primary",children:"Proxy Registered"}),e.jsx("p",{className:"text-xs text-text-secondary",children:c.proxy_email})]})]}),e.jsx(x,{variant:"ghost",size:"sm",onClick:oe,className:"status-danger-text hover:status-danger-bg",children:e.jsx(V,{size:14})})]})}):e.jsxs("div",{className:"space-y-3 p-3 bg-bg-tertiary/30 rounded-lg",children:[e.jsx(J,{label:"Email Address",type:"email",value:M,onChange:t=>B(t.target.value),placeholder:"admin@example.com",helperText:"Required for Let's Encrypt account registration"}),e.jsxs(x,{variant:"secondary",size:"sm",onClick:le,disabled:!M,children:[e.jsx(y,{size:14}),"Register Account"]})]})]})]})}),e.jsx("div",{className:"flex gap-2 pt-3 border-t border-border",children:e.jsxs(x,{onClick:ie,disabled:I,children:[e.jsx(we,{size:14}),I?"Saving...":"Save Configuration"]})})]}),ve=e.jsx(_e,{data:ue,columns:pe,searchable:!0,searchPlaceholder:"Search accounts...",onSearch:ne,onRowClick:H,selectedRow:s,getRowId:t=>t.id,emptyState:{icon:y,title:"No ACME Accounts",description:N?"No accounts match your search":"Create your first ACME account to get started",action:!N&&e.jsxs(x,{onClick:()=>C(!0),children:[e.jsx(T,{size:14}),"Create Account"]})}});return ae?e.jsx("div",{className:"flex items-center justify-center h-full",children:e.jsx(Ae,{})}):e.jsxs(e.Fragment,{children:[e.jsx(ze,{title:"ACME Protocol",subtitle:`${n.length} account${n.length!==1?"s":""}`,icon:P,stats:[{icon:y,label:"Accounts",value:n.length},{icon:A,label:"Active",value:b.active,variant:"success"},{icon:k,label:"Orders",value:b.orders,variant:"primary"}],tabs:he,activeTab:w,onTabChange:t=>{re(t),t==="config"&&l(null)},actions:ye,helpContent:je,helpTitle:"ACME Help",splitView:w==="accounts",slideOverOpen:!!s,slideOverTitle:s?.email||"Account Details",slideOverContent:be,onSlideOverClose:()=>l(null),children:w==="config"?fe:ve}),e.jsx(Ee,{open:ce,onClose:()=>C(!1),title:"Create ACME Account",children:e.jsx(De,{onSubmit:de,onCancel:()=>C(!1)})})]})}function De({onSubmit:m,onCancel:i}){const{showWarning:v}=Y(),[j,n]=r.useState({email:"",key_type:"RSA-2048",agree_tos:!1}),z=s=>{if(s.preventDefault(),!j.agree_tos){v("You must agree to the Terms of Service");return}m(j)};return e.jsxs("form",{onSubmit:z,className:"p-4 space-y-4",children:[e.jsx(J,{label:"Email Address",type:"email",value:j.email,onChange:s=>n(l=>({...l,email:s.target.value})),required:!0,helperText:"Contact email for certificate expiry notifications"}),e.jsx(X,{label:"Key Type",value:j.key_type,onChange:s=>n(l=>({...l,key_type:s})),options:[{value:"RSA-2048",label:"RSA 2048-bit"},{value:"RSA-4096",label:"RSA 4096-bit"},{value:"EC-P256",label:"ECDSA P-256"},{value:"EC-P384",label:"ECDSA P-384"}]}),e.jsxs("label",{className:"flex items-start gap-2 cursor-pointer",children:[e.jsx("input",{type:"checkbox",checked:j.agree_tos,onChange:s=>n(l=>({...l,agree_tos:s.target.checked})),className:"rounded border-border bg-bg-tertiary mt-1"}),e.jsx("span",{className:"text-sm text-text-primary",children:"I agree to the ACME Terms of Service"})]}),e.jsxs("div",{className:"flex justify-end gap-2 pt-4 border-t border-border",children:[e.jsx(x,{type:"button",variant:"secondary",onClick:i,children:"Cancel"}),e.jsxs(x,{type:"submit",children:[e.jsx(T,{size:14}),"Create Account"]})]})]})}export{ct as default};

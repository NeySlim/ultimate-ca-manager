import{j as e}from"./radix-B6Y-MRu0.js";import{a as m}from"./vendor-DEQSVNfj.js";import{c as Y,a as b,x as o,y as C,B as p,I as P,i as h,z as Z,v as ee,j as $}from"./index-vswyqp58.js";import{n as M}from"./Plus.es-DN9hvW10.js";import{n as D}from"./Trash.es-DhgoD9TD.js";import{M as se}from"./Modal-7_eTIvz3.js";import{B as E}from"./Badge-CZ5NzBfK.js";import{H as A}from"./HelpCard-BINCqYIf.js";import{C as te,a as ae,b as N,c as ie,d as B}from"./DetailCard-BKBzFg8i.js";import{U as re}from"./UnifiedManagementLayout-Wib7G_7r.js";import{u as ne}from"./useCommon-lRatzZ8x.js";import"./CaretDown.es-DuThAI6u.js";import"./Globe.es-CtUoIY1T.js";import"./Fingerprint.es-a52JDt2Q.js";import"./ui-bTlm5Mct.js";import"./ResponsiveDataTable-kYvH3TtM.js";import"./CaretUp.es-CYK8cpGg.js";import"./CaretRight.es-B3hFfvz_.js";import"./UnifiedPageHeader-Cbwye_R6.js";import"./HelpModal-BnkmCwhU.js";import"./ArrowLeft.es-CZcTzWfI.js";const S={certificates:{label:"Certificates",permissions:["read:certs","write:certs","delete:certs","revoke:certs","export:certs"]},cas:{label:"Certificate Authorities",permissions:["read:cas","write:cas","delete:cas","export:cas"]},users:{label:"User Management",permissions:["read:users","write:users","delete:users"]},settings:{label:"System Settings",permissions:["read:settings","write:settings"]},audit:{label:"Audit Logs",permissions:["read:audit","export:audit"]},scep:{label:"SCEP Protocol",permissions:["read:scep","write:scep","approve:scep"]},acme:{label:"ACME Protocol",permissions:["read:acme","write:acme"]}},w=Object.values(S).reduce((u,n)=>u+n.permissions.length,0);function ze(){const{showSuccess:u,showError:n}=Y(),{modals:I,open:_,close:j}=ne(["create"]),[F,R]=m.useState(!0),[l,T]=m.useState([]),[a,g]=m.useState(null),[c,v]=m.useState({name:"",description:"",permissions:[],is_system:!1});m.useEffect(()=>{f()},[]);const f=async()=>{R(!0);try{const s=await b.get("/rbac/roles");T(s.data||[])}catch{n("Failed to load roles")}finally{R(!1)}},U=async()=>{try{await b.post("/rbac/roles",c),u("Role created"),j("create"),f(),v({name:"",description:"",permissions:[],is_system:!1})}catch(s){n(s.message||"Failed to create role")}},O=async()=>{if(!(!a||a.is_system))try{await b.put(`/rbac/roles/${a.id}`,{...a,permissions:a.permissions}),u("Role updated"),f()}catch(s){n(s.message||"Failed to update role")}},z=async s=>{if(s.is_system){n("Cannot delete system role");return}if(confirm(`Delete role "${s.name}"? Users with this role will be set to 'viewer'.`))try{await b.delete(`/rbac/roles/${s.id}`),u("Role deleted"),g(null),f()}catch(t){n(t.message||"Failed to delete role")}},L=s=>{if(!a||a.is_system)return;const t=a.permissions||[],i=t.includes(s)?t.filter(d=>d!==s):[...t,s];g({...a,permissions:i})},H=s=>{if(!a||a.is_system)return;const t=S[s].permissions,i=a.permissions||[],x=t.every(y=>i.includes(y))?i.filter(y=>!t.includes(y)):[...new Set([...i,...t])];g({...a,permissions:x})},G=[{key:"name",header:"Role Name",render:(s,t)=>e.jsxs("div",{className:"flex items-center gap-2",children:[t.is_system?e.jsx(C,{size:16,className:"text-text-tertiary shrink-0"}):e.jsx(o,{size:16,className:"text-accent-primary shrink-0"}),e.jsx("span",{className:"font-medium truncate",children:s})]})},{key:"is_system",header:"Type",render:s=>e.jsx(E,{variant:s?"secondary":"primary",size:"sm",children:s?"System":"Custom"})},{key:"permissions",header:"Permissions",render:s=>e.jsxs("span",{className:"text-xs text-text-secondary",children:[s?.length||0," / ",w]})},{key:"user_count",header:"Users",render:s=>s||0}],K=s=>s.is_system?[]:[{label:"Delete",icon:D,variant:"danger",onClick:()=>z(s)}],V=m.useMemo(()=>{const s=l.filter(i=>i.is_system).length,t=l.filter(i=>!i.is_system).length;return[{label:"Total",value:l.length,icon:o},{label:"System",value:s,icon:C,variant:"secondary"},{label:"Custom",value:t,icon:o,variant:"success"}]},[l]),q=s=>e.jsxs("div",{className:"p-3 space-y-3",children:[e.jsx(te,{icon:s.is_system?C:o,iconClass:s.is_system?"bg-bg-tertiary":"bg-accent-primary/20",title:s.name,subtitle:s.description||"No description",badge:e.jsx(E,{variant:s.is_system?"secondary":"primary",size:"sm",children:s.is_system?"System":"Custom"})}),e.jsx(ae,{stats:[{icon:h,value:`${s.permissions?.length||0} perms`},{icon:Z,value:`${s.user_count||0} users`}]}),!s.is_system&&e.jsxs("div",{className:"flex gap-2",children:[e.jsxs(p,{size:"sm",className:"flex-1",onClick:O,children:[e.jsx(h,{size:14}),"Save Changes"]}),e.jsx(p,{size:"sm",variant:"danger",onClick:()=>z(s),children:e.jsx(D,{size:14})})]}),s.is_system&&e.jsx("div",{className:"p-3 rounded-lg status-warning-bg status-warning-border border",children:e.jsxs("div",{className:"flex items-center gap-2 status-warning-text text-xs",children:[e.jsx(ee,{size:14}),e.jsx("span",{children:"System roles cannot be modified"})]})}),e.jsxs(N,{title:"Role Information",children:[e.jsxs(ie,{children:[e.jsx(B,{label:"Name",value:s.name}),e.jsx(B,{label:"Type",value:s.is_system?"System":"Custom"})]}),s.description&&e.jsx("p",{className:"text-xs text-text-secondary mt-2",children:s.description})]}),e.jsx(N,{title:"Permissions",children:e.jsx("div",{className:"space-y-4",children:Object.entries(S).map(([t,i])=>{const d=i.permissions,x=s.permissions||[],y=d.every(r=>x.includes(r)),W=d.some(r=>x.includes(r));return e.jsxs("div",{className:"border-b border-border/30 pb-3 last:border-0 last:pb-0",children:[e.jsxs("button",{onClick:()=>H(t),disabled:s.is_system,className:"flex items-center gap-2 mb-2 text-xs font-medium text-text-primary hover:text-accent-primary transition-colors disabled:opacity-50 disabled:cursor-not-allowed",children:[y?e.jsx(h,{size:14,weight:"fill",className:"status-success-text"}):W?e.jsx(h,{size:14,weight:"duotone",className:"status-warning-text"}):e.jsx($,{size:14,weight:"duotone",className:"text-text-tertiary"}),i.label]}),e.jsx("div",{className:"flex flex-wrap gap-1.5 pl-5",children:d.map(r=>{const k=x.includes(r),X=r.split(":")[0];return e.jsxs("button",{onClick:()=>L(r),disabled:s.is_system,className:`flex items-center gap-1 px-2 py-1 rounded text-[10px] transition-all ${k?"status-success-bg status-success-text status-success-border border":"bg-bg-tertiary text-text-secondary hover:bg-bg-tertiary/80"} disabled:opacity-50 disabled:cursor-not-allowed`,children:[k?e.jsx(h,{size:10,weight:"fill"}):e.jsx($,{size:10}),X]},r)})})]},t)})})}),e.jsx(N,{title:"Coverage",children:e.jsxs("div",{className:"flex items-center gap-4",children:[e.jsx("div",{className:"flex-1 bg-bg-tertiary rounded-full h-2 overflow-hidden",children:e.jsx("div",{className:"h-full bg-accent-primary transition-all",style:{width:`${(s.permissions?.length||0)/w*100}%`}})}),e.jsxs("span",{className:"text-xs text-text-secondary",children:[s.permissions?.length||0,"/",w]})]})})]}),J=e.jsxs("div",{className:"space-y-4",children:[e.jsx(A,{title:"RBAC",variant:"info",children:"Define granular permissions per role. System roles are read-only."}),e.jsx(A,{title:"System Roles",variant:"warning",children:"Built-in roles (admin, operator, viewer) cannot be modified."})]}),Q=[{key:"is_system",label:"Type",options:[{value:!0,label:"System"},{value:!1,label:"Custom"}]}];return e.jsxs(e.Fragment,{children:[e.jsx(re,{title:"Role-Based Access Control",subtitle:`${l.length} role${l.length!==1?"s":""}`,icon:o,stats:V,data:l,columns:G,loading:F,selectedItem:a,onSelectItem:g,renderDetails:q,detailsTitle:"Role Details",splitView:!0,splitEmptyContent:e.jsxs("div",{className:"h-full flex flex-col items-center justify-center p-6 text-center",children:[e.jsx("div",{className:"w-14 h-14 rounded-xl bg-bg-tertiary flex items-center justify-center mb-3",children:e.jsx(o,{size:24,className:"text-text-tertiary",weight:"duotone"})}),e.jsx("p",{className:"text-sm text-text-secondary",children:"Select a role to view permissions"})]}),searchable:!0,searchPlaceholder:"Search roles...",searchKeys:["name","description"],sortable:!0,defaultSort:{key:"name",direction:"asc"},paginated:!1,rowActions:K,filters:Q,emptyIcon:o,emptyTitle:"No roles found",emptyDescription:"Create custom roles for granular access control",emptyAction:e.jsxs(p,{onClick:()=>_("create"),children:[e.jsx(M,{size:16})," Create Role"]}),helpContent:J,actions:e.jsxs(p,{size:"sm",onClick:()=>_("create"),children:[e.jsx(M,{size:16})," Create Role"]})}),e.jsx(se,{open:I.create,onOpenChange:s=>!s&&j("create"),title:"Create Custom Role",children:e.jsxs("div",{className:"space-y-4",children:[e.jsx(P,{label:"Role Name",value:c.name,onChange:s=>v({...c,name:s.target.value}),placeholder:"e.g., Certificate Manager"}),e.jsx(P,{label:"Description",value:c.description,onChange:s=>v({...c,description:s.target.value}),placeholder:"Brief description of this role"}),e.jsxs("div",{className:"flex justify-end gap-2 pt-2",children:[e.jsx(p,{variant:"ghost",onClick:()=>j("create"),children:"Cancel"}),e.jsx(p,{onClick:U,disabled:!c.name,children:"Create"})]})]})})]})}export{ze as default};

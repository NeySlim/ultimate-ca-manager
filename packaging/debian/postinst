#!/bin/bash
# UCM Post-Installation Script (non-interactive)

set -e

PACKAGE="ucm"
UCM_USER="ucm"
UCM_GROUP="ucm"
UCM_HOME="/opt/ucm"
UCM_DATA="/opt/ucm/data"
UCM_CONFIG="/etc/ucm"
V1_DATA="/opt/ucm/backend/data"

case "$1" in
    configure)
        # Create user and group
        if ! getent group "$UCM_GROUP" >/dev/null 2>&1; then
            addgroup --system "$UCM_GROUP" >/dev/null
        fi
        
        if ! getent passwd "$UCM_USER" >/dev/null 2>&1; then
            adduser --system --home "$UCM_HOME" --no-create-home \
                    --ingroup "$UCM_GROUP" --disabled-password \
                    --shell /bin/false "$UCM_USER" >/dev/null
        fi
        
        # Create directories
        mkdir -p "$UCM_DATA"/{ca,certs,backups,sessions,private}
        mkdir -p "$UCM_CONFIG"
        mkdir -p /var/log/ucm
        
        # ============================================================
        # AUTOMATIC MIGRATION FROM v1.8.x
        # ============================================================
        if [ -f "$V1_DATA/ucm.db" ] && [ ! -f "$UCM_DATA/ucm.db" ]; then
            if [ -x "$UCM_HOME/scripts/migrate-v1-to-v2.sh" ]; then
                "$UCM_HOME/scripts/migrate-v1-to-v2.sh"
            elif [ -f "$UCM_HOME/backend/migrate_v1_to_v2.py" ]; then
                echo "Running v1.8.x → v2.0.0 migration..."
                python3 "$UCM_HOME/backend/migrate_v1_to_v2.py" "$UCM_HOME" 2>&1 | tee /var/log/ucm/migration.log
            fi
        fi
        # ============================================================
        
        # Sudoers for service restart
        echo "ucm ALL=(ALL) NOPASSWD: /usr/bin/systemctl restart ucm, /usr/bin/systemctl reload ucm" > /etc/sudoers.d/ucm-service
        chmod 440 /etc/sudoers.d/ucm-service
        
        # Create config if not exists (fresh install)
        if [ ! -f "$UCM_CONFIG/ucm.env" ]; then
            SECRET_KEY=$(python3 -c 'import secrets; print(secrets.token_hex(32))')
            JWT_SECRET=$(python3 -c 'import secrets; print(secrets.token_hex(32))')
            ADMIN_PASS=$(python3 -c 'import secrets; print(secrets.token_hex(8))')
            
            cat > "$UCM_CONFIG/ucm.env" << ENVEOF
# ============================================================
# UCM Configuration File
# ============================================================
# This file is sourced by the UCM service at startup.
# Edit values below and restart UCM: systemctl restart ucm

# ============ REQUIRED (auto-generated) ============
SECRET_KEY=$SECRET_KEY
JWT_SECRET_KEY=$JWT_SECRET
DATABASE_PATH=$UCM_DATA/ucm.db

# ============ NETWORK ============
HTTPS_PORT=8443
# HTTP_PORT=8080
# HTTP_REDIRECT=true
# FQDN=ucm.example.com

# ============ LOGGING ============
LOG_LEVEL=INFO

# ============ SECURITY ============
# SESSION_TIMEOUT=3600
# JWT_ACCESS_TOKEN_EXPIRES=900
# JWT_REFRESH_TOKEN_EXPIRES=604800
# RATE_LIMIT_ENABLED=true
# RATE_LIMIT_PER_MINUTE=60
# RATE_LIMIT_PER_HOUR=1000

# ============ HTTPS CERTIFICATES ============
# HTTPS_CERT_PATH=/opt/ucm/data/https_cert.pem
# HTTPS_KEY_PATH=/opt/ucm/data/https_key.pem
# HTTPS_AUTO_GENERATE=true

# ============ INITIAL ADMIN (first start only) ============
INITIAL_ADMIN_PASSWORD=$ADMIN_PASS
# INITIAL_ADMIN_USERNAME=admin
# INITIAL_ADMIN_EMAIL=admin@ucm.local

# ============ SCEP (optional) ============
# SCEP_ENABLED=false
# SCEP_CHALLENGE_PASSWORD=
# SCEP_CA_ID=
# SCEP_AUTO_APPROVE=false

# ============ DATABASE POOL (advanced) ============
# DB_POOL_SIZE=10
# DB_POOL_TIMEOUT=30
# DB_POOL_RECYCLE=3600
# DB_MAX_OVERFLOW=20

# ============ REDIS (optional, for HA) ============
# REDIS_URL=redis://localhost:6379/0
ENVEOF
            chmod 600 "$UCM_CONFIG/ucm.env"
            
            echo ""
            echo "━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━"
            echo " UCM INSTALLED"
            echo "━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━"
            echo " Admin password: $ADMIN_PASS"
            echo " Config: $UCM_CONFIG/ucm.env"
            echo "━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━"
        fi
        
        # Create venv if not exists
        if [ ! -d "$UCM_HOME/venv" ]; then
            echo "Creating Python virtual environment..."
            python3 -m venv "$UCM_HOME/venv"
            "$UCM_HOME/venv/bin/pip" install --quiet --upgrade pip
            "$UCM_HOME/venv/bin/pip" install --quiet -r "$UCM_HOME/requirements.txt"
        fi
        
        # Set permissions
        chown -R "$UCM_USER":"$UCM_GROUP" "$UCM_HOME"
        chown -R "$UCM_USER":"$UCM_GROUP" "$UCM_DATA"
        chown -R "$UCM_USER":"$UCM_GROUP" "$UCM_CONFIG"
        chown -R "$UCM_USER":"$UCM_GROUP" /var/log/ucm
        chmod 750 "$UCM_DATA"
        
        # Enable and start service
        systemctl daemon-reload
        systemctl enable ucm
        systemctl start ucm || true
        ;;
esac

exit 0

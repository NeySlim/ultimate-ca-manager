import{r as k,j as e,B as S,z as p,a as E}from"./index-G9PPyvAs.js";import{P as _}from"./PageTopBar-D-sz9jyJ.js";import{B as T}from"./Badge-C7mA8cen.js";import{M as w}from"./Modal-6an3rXID.js";import{I as A}from"./Input-Bv1nBHGa.js";import{s as t}from"./CreateCAModal.module-DdQgTClK.js";import{u as K}from"./useQuery-Dy-j4RWm.js";import{u as B}from"./useMutation-v8I2-igc.js";import{a as b}from"./api-ClVrI7m4.js";import{e as L}from"./export-BEFxFx9V.js";function P({isOpen:i,onClose:c}){const[a,x]=k.useState({name:"",description:"",type:"server",validityDays:"365",keySize:"2048",keyUsage:{digitalSignature:!0,keyEncipherment:!0,dataEncipherment:!1,keyAgreement:!1,keyCertSign:!1,crlSign:!1},extendedKeyUsage:{serverAuth:!1,clientAuth:!1,codeSigning:!1,emailProtection:!1,timeStamping:!1}}),[g,f]=k.useState(!1),j=async s=>{if(s.preventDefault(),!a.name){p.error("Template name is required");return}f(!0);try{const n=Object.entries(a.keyUsage).filter(([r,m])=>m).map(([r,m])=>r),d=Object.entries(a.extendedKeyUsage).filter(([r,m])=>m).map(([r,m])=>r),h=await fetch("/api/v2/templates",{method:"POST",headers:{"Content-Type":"application/json"},body:JSON.stringify({name:a.name,description:a.description,type:a.type,validity_days:parseInt(a.validityDays),key_size:parseInt(a.keySize),key_usage:n,extended_key_usage:d})});if(!h.ok){const r=await h.json();throw new Error(r.message||"Failed to create template")}p.success("Template created successfully"),c(),x({name:"",description:"",type:"server",validityDays:"365",keySize:"2048",keyUsage:{digitalSignature:!0,keyEncipherment:!0,dataEncipherment:!1,keyAgreement:!1,keyCertSign:!1,crlSign:!1},extendedKeyUsage:{serverAuth:!1,clientAuth:!1,codeSigning:!1,emailProtection:!1,timeStamping:!1}}),window.location.reload()}catch(n){p.error(n.message||"Failed to create template")}finally{f(!1)}},u=s=>{x(n=>({...n,[s.target.name]:s.target.value}))},y=s=>{x(n=>({...n,keyUsage:{...n.keyUsage,[s]:!n.keyUsage[s]}}))},o=s=>{x(n=>({...n,extendedKeyUsage:{...n.extendedKeyUsage,[s]:!n.extendedKeyUsage[s]}}))},v=s=>{const n=s.target.value;let d={...a.keyUsage},h={...a.extendedKeyUsage};n==="server"?(d={digitalSignature:!0,keyEncipherment:!0,dataEncipherment:!1,keyAgreement:!1,keyCertSign:!1,crlSign:!1},h={serverAuth:!0,clientAuth:!1,codeSigning:!1,emailProtection:!1,timeStamping:!1}):n==="client"?(d={digitalSignature:!0,keyEncipherment:!0,dataEncipherment:!1,keyAgreement:!1,keyCertSign:!1,crlSign:!1},h={serverAuth:!1,clientAuth:!0,codeSigning:!1,emailProtection:!1,timeStamping:!1}):n==="ca"&&(d={digitalSignature:!0,keyEncipherment:!1,dataEncipherment:!1,keyAgreement:!1,keyCertSign:!0,crlSign:!0},h={serverAuth:!1,clientAuth:!1,codeSigning:!1,emailProtection:!1,timeStamping:!1}),x(r=>({...r,type:n,keyUsage:d,extendedKeyUsage:h}))},C=e.jsxs(e.Fragment,{children:[e.jsx(S,{variant:"secondary",onClick:c,disabled:g,children:"Cancel"}),e.jsx(S,{variant:"primary",onClick:j,disabled:g,children:g?"Creating...":"Create Template"})]});return e.jsx(w,{isOpen:i,onClose:c,title:"New Certificate Template",size:"md",footer:C,children:e.jsxs("form",{onSubmit:j,className:t.form,children:[e.jsxs("div",{className:t.section,children:[e.jsx("h3",{className:t.sectionTitle,children:"Template Information"}),e.jsx(A,{label:"Template Name",name:"name",value:a.name,onChange:u,placeholder:"Web Server Template",required:!0}),e.jsx(A,{label:"Description",name:"description",value:a.description,onChange:u,placeholder:"Template for web server certificates"}),e.jsxs("div",{className:t.field,children:[e.jsx("label",{className:t.label,children:"Template Type"}),e.jsxs("select",{name:"type",value:a.type,onChange:v,className:t.select,children:[e.jsx("option",{value:"server",children:"Server Authentication"}),e.jsx("option",{value:"client",children:"Client Authentication"}),e.jsx("option",{value:"ca",children:"Certificate Authority"}),e.jsx("option",{value:"code-signing",children:"Code Signing"}),e.jsx("option",{value:"email",children:"Email Protection"})]})]})]}),e.jsxs("div",{className:t.section,children:[e.jsx("h3",{className:t.sectionTitle,children:"Certificate Settings"}),e.jsxs("div",{className:t.row,children:[e.jsx(A,{label:"Validity Period (Days)",name:"validityDays",type:"number",value:a.validityDays,onChange:u,min:"1",max:"3650"}),e.jsxs("div",{className:t.field,children:[e.jsx("label",{className:t.label,children:"Key Size"}),e.jsxs("select",{name:"keySize",value:a.keySize,onChange:u,className:t.select,children:[e.jsx("option",{value:"2048",children:"2048 bits"}),e.jsx("option",{value:"3072",children:"3072 bits"}),e.jsx("option",{value:"4096",children:"4096 bits"})]})]})]})]}),e.jsxs("div",{className:t.section,children:[e.jsx("h3",{className:t.sectionTitle,children:"Key Usage"}),e.jsxs("div",{className:t.permissionsGrid,children:[e.jsxs("label",{className:t.checkboxLabel,children:[e.jsx("input",{type:"checkbox",checked:a.keyUsage.digitalSignature,onChange:()=>y("digitalSignature"),className:t.checkbox}),e.jsx("span",{children:"Digital Signature"})]}),e.jsxs("label",{className:t.checkboxLabel,children:[e.jsx("input",{type:"checkbox",checked:a.keyUsage.keyEncipherment,onChange:()=>y("keyEncipherment"),className:t.checkbox}),e.jsx("span",{children:"Key Encipherment"})]}),e.jsxs("label",{className:t.checkboxLabel,children:[e.jsx("input",{type:"checkbox",checked:a.keyUsage.dataEncipherment,onChange:()=>y("dataEncipherment"),className:t.checkbox}),e.jsx("span",{children:"Data Encipherment"})]}),e.jsxs("label",{className:t.checkboxLabel,children:[e.jsx("input",{type:"checkbox",checked:a.keyUsage.keyAgreement,onChange:()=>y("keyAgreement"),className:t.checkbox}),e.jsx("span",{children:"Key Agreement"})]}),e.jsxs("label",{className:t.checkboxLabel,children:[e.jsx("input",{type:"checkbox",checked:a.keyUsage.keyCertSign,onChange:()=>y("keyCertSign"),className:t.checkbox}),e.jsx("span",{children:"Certificate Sign"})]}),e.jsxs("label",{className:t.checkboxLabel,children:[e.jsx("input",{type:"checkbox",checked:a.keyUsage.crlSign,onChange:()=>y("crlSign"),className:t.checkbox}),e.jsx("span",{children:"CRL Sign"})]})]})]}),e.jsxs("div",{className:t.section,children:[e.jsx("h3",{className:t.sectionTitle,children:"Extended Key Usage"}),e.jsxs("div",{className:t.permissionsGrid,children:[e.jsxs("label",{className:t.checkboxLabel,children:[e.jsx("input",{type:"checkbox",checked:a.extendedKeyUsage.serverAuth,onChange:()=>o("serverAuth"),className:t.checkbox}),e.jsx("span",{children:"TLS Web Server Authentication"})]}),e.jsxs("label",{className:t.checkboxLabel,children:[e.jsx("input",{type:"checkbox",checked:a.extendedKeyUsage.clientAuth,onChange:()=>o("clientAuth"),className:t.checkbox}),e.jsx("span",{children:"TLS Web Client Authentication"})]}),e.jsxs("label",{className:t.checkboxLabel,children:[e.jsx("input",{type:"checkbox",checked:a.extendedKeyUsage.codeSigning,onChange:()=>o("codeSigning"),className:t.checkbox}),e.jsx("span",{children:"Code Signing"})]}),e.jsxs("label",{className:t.checkboxLabel,children:[e.jsx("input",{type:"checkbox",checked:a.extendedKeyUsage.emailProtection,onChange:()=>o("emailProtection"),className:t.checkbox}),e.jsx("span",{children:"Email Protection"})]}),e.jsxs("label",{className:t.checkboxLabel,children:[e.jsx("input",{type:"checkbox",checked:a.extendedKeyUsage.timeStamping,onChange:()=>o("timeStamping"),className:t.checkbox}),e.jsx("span",{children:"Time Stamping"})]})]})]})]})})}const U={getTemplates:async(i={})=>(await b.get("/api/v2/templates",{params:i})).data,createTemplate:async i=>(await b.post("/api/v2/templates",i)).data,updateTemplate:async({id:i,...c})=>(await b.put(`/api/v2/templates/${i}`,c)).data,deleteTemplate:async i=>(await b.delete(`/api/v2/templates/${i}`)).data},N={all:["templates"],lists:()=>[...N.all,"list"],list:i=>[...N.lists(),i]},D=(i={})=>K({queryKey:N.list(i),queryFn:()=>U.getTemplates(i)}),F=()=>{const i=E();return B({mutationFn:U.deleteTemplate,onSuccess:()=>{i.invalidateQueries({queryKey:N.all}),p.success("Template deleted successfully")},onError:c=>{p.error(c.response?.data?.message||"Failed to delete template")}})},I="_sectionHeader_1humx_2",z="_sectionTitle_1humx_10",O="_filterBtn_1humx_16",$="_tableContainer_1humx_42",M="_templateName_1humx_85",q="_keyUsage_1humx_91",H="_subjectPattern_1humx_97",V="_statusBadge_1humx_107",G="_badgeActive_1humx_118",Q="_badgeSystem_1humx_123",R="_actionsCell_1humx_129",W="_actionBtn_1humx_134",l={sectionHeader:I,sectionTitle:z,filterBtn:O,tableContainer:$,templateName:M,keyUsage:q,subjectPattern:H,statusBadge:V,badgeActive:G,badgeSystem:Q,actionsCell:R,actionBtn:W};function le(){const[i,c]=k.useState(!1),[a,x]=k.useState(!1),{data:g,isLoading:f,error:j}=D(),u=F(),o=(Array.isArray(g)?g:g?.data||[]).map(s=>{try{const n=s.dn_template;let d="N/A";if(typeof n=="string")d=n;else if(n&&typeof n=="object"){const h=Object.entries(n).filter(([r,m])=>m&&m.trim()).map(([r,m])=>`${r}=${m}`);d=h.length>0?h.join(", "):"N/A"}return{id:s.id,name:s.name||"Unnamed",keyUsage:s.extensions_template?.key_usage?.join(", ")||"N/A",validity:s.validity_days?`${s.validity_days} days`:"N/A",subjectPattern:d,usedBy:"0 certs",status:"ACTIVE",isSystem:s.is_system||!1}}catch(n){return console.error("Error mapping template:",s,n),null}}).filter(Boolean),v=()=>{if(o.length===0){p.error("No templates to export");return}L(o,"templates-export",{format:"csv",columns:["id","name","keyUsage","validity","subjectPattern","usedBy","status"]}),p.success("Templates exported successfully")},C=s=>{if(s.isSystem){p.error("Cannot delete system template");return}confirm(`Delete template "${s.name}"?`)&&u.mutate(s.id)};return j?e.jsxs("div",{className:l.templateList,children:[e.jsx(_,{icon:"ph ph-file-text",title:"Certificate Templates",badge:e.jsx(T,{variant:"danger",children:"Error"})}),e.jsxs("div",{style:{padding:"2rem",textAlign:"center",color:"var(--color-danger)"},children:["Error loading templates: ",j.message]})]}):e.jsxs("div",{className:l.templateList,children:[e.jsx(_,{icon:"ph ph-file-text",title:"Certificate Templates",badge:e.jsxs(T,{variant:"success",children:[o.length," Templates"]}),actions:e.jsxs(e.Fragment,{children:[e.jsx(S,{icon:"ph ph-download-simple",onClick:v,children:"Export"}),e.jsx(S,{variant:"primary",icon:"ph ph-plus",onClick:()=>c(!0),children:"New Template"})]})}),e.jsxs("div",{className:l.sectionHeader,children:[e.jsx("span",{className:l.sectionTitle,children:"Available Templates"}),e.jsxs("button",{className:l.filterBtn,onClick:()=>x(!a),children:[e.jsx("i",{className:"ph ph-funnel"}),"Filter"]})]}),e.jsx("div",{className:l.tableContainer,children:e.jsxs("table",{children:[e.jsx("thead",{children:e.jsxs("tr",{children:[e.jsx("th",{style:{width:"15%"},children:"TEMPLATE NAME"}),e.jsx("th",{style:{width:"25%"},children:"KEY USAGE"}),e.jsx("th",{style:{width:"10%"},children:"VALIDITY"}),e.jsx("th",{style:{width:"20%"},children:"SUBJECT PATTERN"}),e.jsx("th",{style:{width:"12%"},children:"USED BY"}),e.jsx("th",{style:{width:"10%"},children:"STATUS"}),e.jsx("th",{style:{width:"8%"},children:"ACTIONS"})]})}),e.jsx("tbody",{children:f?e.jsx("tr",{children:e.jsx("td",{colSpan:"7",style:{textAlign:"center",padding:"2rem"},children:"Loading templates..."})}):o.length===0?e.jsx("tr",{children:e.jsx("td",{colSpan:"7",style:{textAlign:"center",padding:"2rem"},children:"No templates found"})}):o.map(s=>e.jsxs("tr",{children:[e.jsxs("td",{children:[e.jsx("span",{className:l.templateName,children:s.name}),s.isSystem&&e.jsx(T,{variant:"info",style:{marginLeft:"0.5rem"},children:"System"})]}),e.jsx("td",{children:e.jsx("span",{className:l.keyUsage,children:s.keyUsage})}),e.jsx("td",{children:s.validity}),e.jsx("td",{children:e.jsx("code",{className:l.subjectPattern,children:s.subjectPattern})}),e.jsx("td",{children:s.usedBy}),e.jsx("td",{children:e.jsx("span",{className:`${l.statusBadge} ${s.status==="ACTIVE"?l.badgeActive:l.badgeSystem}`,children:s.status})}),e.jsx("td",{children:e.jsx("div",{className:l.actionsCell,children:!s.isSystem&&e.jsxs(e.Fragment,{children:[e.jsx("button",{className:l.actionBtn,title:"Edit",children:e.jsx("i",{className:"ph ph-pencil"})}),e.jsx("button",{className:l.actionBtn,title:"Delete",onClick:()=>C(s),children:e.jsx("i",{className:"ph ph-trash"})})]})})})]},s.id))})]})}),e.jsx(P,{isOpen:i,onClose:()=>c(!1)})]})}export{le as TemplateList,le as default};

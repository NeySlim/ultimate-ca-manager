import{r as x,j as e,B as f,z as c,b as j,d as _}from"./index-gWc9Wuxx.js";import{D as te}from"./DataTable-B-X57U_0.js";import{B as A}from"./Badge-C7kSHm3C.js";import{a as ie,E as ne}from"./ErrorState-DvQycW5G.js";import{E as oe}from"./EmptyState-BVXbz1Ol.js";import{P as R}from"./PageTopBar-DQU6wF4a.js";import{P as B,a as C}from"./PillFilter-BB3Y4lIb.js";import{e as le}from"./export-BEFxFx9V.js";import{M as N}from"./Modal-sdelTJ_G.js";import{I as U}from"./Input-c2F2jU2v.js";import{s as o}from"./SharedModalForm.module-1nz5DqPv.js";import{u as ce}from"./useQuery-Cqzu-coP.js";import{u as E}from"./useMutation-BAq7cHoY.js";function de({isOpen:r,onClose:i}){const[a,n]=x.useState({username:"",password:"",confirmPassword:"",email:"",fullName:"",role:"operator",permissions:{manageCAs:!1,issueCertificates:!0,revokeCertificates:!1,manageUsers:!1,viewLogs:!0,manageSettings:!1}}),[m,h]=x.useState(!1),k=async p=>{if(p.preventDefault(),!a.username||!a.password){c.error("Username and password are required");return}if(a.password!==a.confirmPassword){c.error("Passwords do not match");return}if(a.password.length<8){c.error("Password must be at least 8 characters");return}h(!0);try{const d=await fetch("/api/v2/users",{method:"POST",headers:{"Content-Type":"application/json"},body:JSON.stringify({username:a.username,password:a.password,email:a.email,full_name:a.fullName,role:a.role,permissions:a.permissions})});if(!d.ok){const g=await d.json();throw new Error(g.message||"Failed to create user")}c.success("User created successfully"),i(),n({username:"",password:"",confirmPassword:"",email:"",fullName:"",role:"operator",permissions:{manageCAs:!1,issueCertificates:!0,revokeCertificates:!1,manageUsers:!1,viewLogs:!0,manageSettings:!1}}),window.location.reload()}catch(d){c.error(d.message||"Failed to create user")}finally{h(!1)}},u=p=>{n(d=>({...d,[p.target.name]:p.target.value}))},v=p=>{n(d=>({...d,permissions:{...d.permissions,[p]:!d.permissions[p]}}))},P=p=>{const d=p.target.value;let g={...a.permissions};d==="admin"?g={manageCAs:!0,issueCertificates:!0,revokeCertificates:!0,manageUsers:!0,viewLogs:!0,manageSettings:!0}:d==="operator"?g={manageCAs:!1,issueCertificates:!0,revokeCertificates:!1,manageUsers:!1,viewLogs:!0,manageSettings:!1}:d==="viewer"&&(g={manageCAs:!1,issueCertificates:!1,revokeCertificates:!1,manageUsers:!1,viewLogs:!0,manageSettings:!1}),n(z=>({...z,role:d,permissions:g}))},D=e.jsxs(e.Fragment,{children:[e.jsx(f,{variant:"secondary",onClick:i,disabled:m,children:"Cancel"}),e.jsx(f,{variant:"primary",onClick:k,disabled:m,children:m?"Creating...":"Create User"})]});return e.jsx(N,{isOpen:r,onClose:i,title:"Create User",size:"md",footer:D,children:e.jsxs("form",{onSubmit:k,className:o.form,children:[e.jsxs("div",{className:o.section,children:[e.jsx("h3",{className:o.sectionTitle,children:"Account Information"}),e.jsx(U,{label:"Username",name:"username",value:a.username,onChange:u,placeholder:"john.doe",required:!0}),e.jsx(U,{label:"Full Name",name:"fullName",value:a.fullName,onChange:u,placeholder:"John Doe"}),e.jsx(U,{label:"Email Address",name:"email",type:"email",value:a.email,onChange:u,placeholder:"john.doe@example.com"})]}),e.jsxs("div",{className:o.section,children:[e.jsx("h3",{className:o.sectionTitle,children:"Security"}),e.jsx(U,{label:"Password",name:"password",type:"password",value:a.password,onChange:u,placeholder:"••••••••",required:!0,helpText:"Minimum 8 characters"}),e.jsx(U,{label:"Confirm Password",name:"confirmPassword",type:"password",value:a.confirmPassword,onChange:u,placeholder:"••••••••",required:!0})]}),e.jsxs("div",{className:o.section,children:[e.jsx("h3",{className:o.sectionTitle,children:"Role & Permissions"}),e.jsxs("div",{className:o.field,children:[e.jsx("label",{className:o.label,children:"Role"}),e.jsxs("select",{name:"role",value:a.role,onChange:P,className:o.select,children:[e.jsx("option",{value:"admin",children:"Administrator"}),e.jsx("option",{value:"operator",children:"Operator"}),e.jsx("option",{value:"viewer",children:"Viewer"})]}),e.jsxs("p",{className:o.helpText,children:[a.role==="admin"&&"Full access to all features",a.role==="operator"&&"Can issue and manage certificates",a.role==="viewer"&&"Read-only access"]})]}),e.jsxs("div",{className:o.permissionsGrid,children:[e.jsxs("label",{className:o.checkboxLabel,children:[e.jsx("input",{type:"checkbox",checked:a.permissions.manageCAs,onChange:()=>v("manageCAs"),className:o.checkbox}),e.jsx("span",{children:"Manage CAs"})]}),e.jsxs("label",{className:o.checkboxLabel,children:[e.jsx("input",{type:"checkbox",checked:a.permissions.issueCertificates,onChange:()=>v("issueCertificates"),className:o.checkbox}),e.jsx("span",{children:"Issue Certificates"})]}),e.jsxs("label",{className:o.checkboxLabel,children:[e.jsx("input",{type:"checkbox",checked:a.permissions.revokeCertificates,onChange:()=>v("revokeCertificates"),className:o.checkbox}),e.jsx("span",{children:"Revoke Certificates"})]}),e.jsxs("label",{className:o.checkboxLabel,children:[e.jsx("input",{type:"checkbox",checked:a.permissions.manageUsers,onChange:()=>v("manageUsers"),className:o.checkbox}),e.jsx("span",{children:"Manage Users"})]}),e.jsxs("label",{className:o.checkboxLabel,children:[e.jsx("input",{type:"checkbox",checked:a.permissions.viewLogs,onChange:()=>v("viewLogs"),className:o.checkbox}),e.jsx("span",{children:"View Logs"})]}),e.jsxs("label",{className:o.checkboxLabel,children:[e.jsx("input",{type:"checkbox",checked:a.permissions.manageSettings,onChange:()=>v("manageSettings"),className:o.checkbox}),e.jsx("span",{children:"Manage Settings"})]})]})]})]})})}const S={getUsers:async(r={})=>(await j.get("/api/v2/users",{params:r})).data,createUser:async r=>(await j.post("/api/v2/users",r)).data,updateUser:async({id:r,...i})=>(await j.put(`/api/v2/users/${r}`,i)).data,resetPassword:async(r,i)=>(await j.post(`/api/v2/users/${r}/reset-password`,{new_password:i})).data,toggleStatus:async r=>(await j.patch(`/api/v2/users/${r}/toggle`)).data,deleteUser:async r=>(await j.delete(`/api/v2/users/${r}`)).data,importUsers:async r=>{const i=new FormData;return i.append("file",r),(await j.post("/api/v2/users/import",i,{headers:{"Content-Type":"multipart/form-data"}})).data}},b={all:["users"],lists:()=>[...b.all,"list"],list:r=>[...b.lists(),r]},ue=(r={})=>ce({queryKey:b.list(r),queryFn:()=>S.getUsers(r)}),pe=()=>{const r=_();return E({mutationFn:S.updateUser,onSuccess:()=>{r.invalidateQueries({queryKey:b.all}),c.success("User updated successfully")},onError:i=>{c.error(i.response?.data?.message||"Failed to update user")}})},me=()=>{const r=_();return E({mutationFn:S.deleteUser,onSuccess:()=>{r.invalidateQueries({queryKey:b.all}),c.success("User deleted successfully")},onError:i=>{c.error(i.response?.data?.message||"Failed to delete user")}})},he=()=>{const r=_();return E({mutationFn:S.importUsers,onSuccess:i=>{r.invalidateQueries({queryKey:b.all});const{imported:a=0,skipped:n=0}=i;c.success(`Imported ${a} users, skipped ${n}`)},onError:i=>{c.error(i.response?.data?.message||"Failed to import users")}})},ge=()=>{const r=_();return E({mutationFn:({userId:i,newPassword:a})=>S.resetPassword(i,a),onSuccess:()=>{r.invalidateQueries({queryKey:b.all}),c.success("Password reset successfully")},onError:i=>{c.error(i.response?.data?.message||"Failed to reset password")}})},xe=()=>{const r=_();return E({mutationFn:S.toggleStatus,onSuccess:()=>{r.invalidateQueries({queryKey:b.all}),c.success("User status updated successfully")},onError:i=>{c.error(i.response?.data?.message||"Failed to toggle user status")}})};function fe({isOpen:r,onClose:i,user:a}){const[n,m]=x.useState({email:"",fullName:"",role:"operator",active:!0}),h=pe();if(x.useEffect(()=>{a&&m({email:a.email||"",fullName:a.name||"",role:a.role?.toLowerCase()||"operator",active:a.status==="Active"})},[a]),!a)return null;const k=async u=>{if(u.preventDefault(),!n.email){c.error("Email is required");return}h.mutate({id:a.id,email:n.email,full_name:n.fullName,role:n.role,active:n.active},{onSuccess:()=>{i()}})};return e.jsxs(N,{isOpen:r,onClose:i,size:"medium",children:[e.jsxs(N.Header,{children:[e.jsx("i",{className:"ph ph-pencil-simple",style:{marginRight:"8px"}}),"Edit User: ",a.name]}),e.jsxs("form",{onSubmit:k,children:[e.jsx(N.Body,{children:e.jsxs("div",{style:{display:"flex",flexDirection:"column",gap:"16px"},children:[e.jsxs("div",{children:[e.jsx("label",{style:{display:"block",fontSize:"13px",fontWeight:500,color:"var(--text-primary)",marginBottom:"6px"},children:"Username"}),e.jsx("input",{type:"text",value:a.name,readOnly:!0,disabled:!0,style:{width:"100%",padding:"8px 12px",fontSize:"13px",border:"1px solid var(--border-primary)",borderRadius:"var(--radius)",background:"var(--bg-tertiary)",color:"var(--text-tertiary)",cursor:"not-allowed"}})]}),e.jsxs("div",{children:[e.jsxs("label",{style:{display:"block",fontSize:"13px",fontWeight:500,color:"var(--text-primary)",marginBottom:"6px"},children:["Email ",e.jsx("span",{style:{color:"var(--status-danger)"},children:"*"})]}),e.jsx("input",{type:"email",value:n.email,onChange:u=>m({...n,email:u.target.value}),style:{width:"100%",padding:"8px 12px",fontSize:"13px",border:"1px solid var(--border-primary)",borderRadius:"var(--radius)",background:"var(--bg-primary)",color:"var(--text-primary)"}})]}),e.jsxs("div",{children:[e.jsx("label",{style:{display:"block",fontSize:"13px",fontWeight:500,color:"var(--text-primary)",marginBottom:"6px"},children:"Full Name"}),e.jsx("input",{type:"text",value:n.fullName,onChange:u=>m({...n,fullName:u.target.value}),style:{width:"100%",padding:"8px 12px",fontSize:"13px",border:"1px solid var(--border-primary)",borderRadius:"var(--radius)",background:"var(--bg-primary)",color:"var(--text-primary)"}})]}),e.jsxs("div",{children:[e.jsx("label",{style:{display:"block",fontSize:"13px",fontWeight:500,color:"var(--text-primary)",marginBottom:"6px"},children:"Role"}),e.jsxs("select",{value:n.role,onChange:u=>m({...n,role:u.target.value}),style:{width:"100%",padding:"8px 12px",fontSize:"13px",border:"1px solid var(--border-primary)",borderRadius:"var(--radius)",background:"var(--bg-primary)",color:"var(--text-primary)"},children:[e.jsx("option",{value:"admin",children:"Admin"}),e.jsx("option",{value:"operator",children:"Operator"}),e.jsx("option",{value:"viewer",children:"Viewer"})]})]}),e.jsx("div",{children:e.jsxs("label",{style:{display:"flex",alignItems:"center",fontSize:"13px",fontWeight:500,color:"var(--text-primary)",cursor:"pointer"},children:[e.jsx("input",{type:"checkbox",checked:n.active,onChange:u=>m({...n,active:u.target.checked}),style:{marginRight:"8px"}}),"Active User"]})})]})}),e.jsxs(N.Footer,{children:[e.jsx(N.CloseButton,{onClick:i,disabled:h.isPending,children:"Cancel"}),e.jsx(f,{type:"submit",variant:"primary",icon:"ph ph-check",disabled:h.isPending,children:h.isPending?"Saving...":"Save Changes"})]})]})]})}const ve="_userList_96igz_3",ye="_filtersSection_96igz_9",be="_filterGroup_96igz_21",je="_badge_96igz_35",Ce="_tableContainer_96igz_40",ke="_userInfoCell_96igz_46",we="_userAvatar_96igz_52",Ne="_userDetails_96igz_66",Se="_userName_96igz_72",Ae="_userEmail_96igz_78",Ue="_actionsCell_96igz_83",l={userList:ve,filtersSection:ye,filterGroup:be,badge:je,tableContainer:Ce,userInfoCell:ke,userAvatar:we,userDetails:Ne,userName:Se,userEmail:Ae,actionsCell:Ue};function Oe(){const[r,i]=x.useState("All"),[a,n]=x.useState("All"),[m,h]=x.useState(!1),[k,u]=x.useState(null),[v,P]=x.useState(!1),D=x.useMemo(()=>{const s={};return r!=="All"&&(s.role=r.toLowerCase()),a!=="All"&&(s.active=a==="Active"),s},[r,a]),{data:p,isLoading:d,error:g}=ue(D),z=me(),O=he(),G=ge(),K=xe(),Q=s=>{if(!s)return"??";const t=s.split(" ");return t.length>1?`${t[0][0]}${t[1][0]}`:s.substring(0,2)},I=s=>{if(!s)return"Never";const t=new Date(s),M=new Date-t,q=Math.floor(M/6e4),T=Math.floor(M/36e5),w=Math.floor(M/864e5);return q<60?`${q} min ago`:T<24?`${T} hour${T>1?"s":""} ago`:w<7?`${w} day${w>1?"s":""} ago`:w<30?`${Math.floor(w/7)} week${Math.floor(w/7)>1?"s":""} ago`:t.toLocaleDateString("en-US",{month:"short",year:"numeric"})},y=(Array.isArray(p)?p:p?.data||[]).map(s=>({id:s.id,name:s.username,initials:Q(s.username),email:s.email,role:s.role?s.role.charAt(0).toUpperCase()+s.role.slice(1):"Unknown",status:s.active?"Active":"Disabled",lastLogin:I(s.last_login),created:I(s.created_at)})),L=y,V=y.filter(s=>s.role==="Admin").length,W=y.filter(s=>s.role==="Operator").length,H=y.filter(s=>s.role==="Viewer").length,$=y.filter(s=>s.status==="Active").length,J=y.filter(s=>s.status==="Disabled").length,X=()=>{if(L.length===0){c.error("No data to export");return}le(L,"users-export",{format:"csv",columns:["id","name","email","role","status","lastLogin","created"]}),c.success("Users exported successfully")},Y=s=>{confirm(`Delete user "${s.name}"?`)&&z.mutate(s.id)},Z=s=>{const t=s.target.files[0];t&&(O.mutate(t),s.target.value="")},ee=s=>{u(s),P(!0)},se=s=>{const t=prompt(`Enter new password for ${s.name}:`);t&&t.length>=8?G.mutate({userId:s.id,newPassword:t}):t&&c.error("Password must be at least 8 characters")},ae=s=>{const t=s.status==="Active"?"deactivate":"activate";confirm(`Are you sure you want to ${t} user "${s.name}"?`)&&K.mutate(s.id)};if(d)return e.jsxs("div",{className:l.userList,children:[e.jsx(R,{icon:"ph ph-users",title:"Users",badge:e.jsx(A,{variant:"neutral",children:"Loading..."})}),Array.from({length:6}).map((s,t)=>e.jsx(ie,{width:"100%",height:60,style:{marginBottom:"8px"}},t))]});if(g)return e.jsxs("div",{className:l.userList,children:[e.jsx(R,{icon:"ph ph-users",title:"Users",badge:e.jsx(A,{variant:"danger",children:"Error"})}),e.jsx(ne,{error:g,shake:!0}),e.jsxs("div",{style:{padding:"2rem",textAlign:"center",color:"var(--color-danger)"},children:["Error loading users: ",g.message]})]});const re=[{key:"name",label:"User",render:s=>e.jsxs("div",{className:l.userInfoCell,children:[e.jsx("div",{className:l.userAvatar,children:s.initials}),e.jsxs("div",{className:l.userDetails,children:[e.jsx("div",{className:l.userName,children:s.name}),e.jsx("div",{className:l.userEmail,children:s.email})]})]})},{key:"role",label:"Role",render:s=>{const t=s.role==="Admin"?"error":s.role==="Operator"?"warning":"info";return e.jsx(A,{variant:t,children:s.role})}},{key:"status",label:"Status",render:s=>e.jsx(A,{variant:s.status==="Active"?"success":"error",children:s.status})},{key:"lastLogin",label:"Last Login"},{key:"created",label:"Created"},{key:"actions",label:"Actions",render:s=>e.jsxs("div",{className:l.actionsCell,children:[e.jsx(f,{variant:"default",size:"sm",icon:"ph ph-pencil-simple",onClick:t=>{t.stopPropagation(),ee(s)}}),e.jsx(f,{variant:"default",size:"sm",icon:"ph ph-trash",onClick:t=>{t.stopPropagation(),Y(s)}}),e.jsxs("div",{style:{position:"relative",display:"inline-block"},children:[e.jsx(f,{variant:"default",size:"sm",icon:"ph ph-dots-three-outline-vertical",onClick:t=>{t.stopPropagation();const F=t.currentTarget.nextSibling;F.style.display=F.style.display==="block"?"none":"block"}}),e.jsxs("div",{style:{display:"none",position:"absolute",right:0,top:"100%",marginTop:"4px",background:"var(--bg-secondary)",border:"1px solid var(--border-primary)",borderRadius:"var(--radius)",boxShadow:"0 2px 8px rgba(0,0,0,0.1)",zIndex:1e3,minWidth:"160px"},children:[e.jsxs("button",{onClick:t=>{t.stopPropagation(),se(s),t.currentTarget.parentElement.style.display="none"},style:{width:"100%",padding:"8px 12px",fontSize:"13px",color:"var(--text-primary)",background:"transparent",border:"none",textAlign:"left",cursor:"pointer",display:"flex",alignItems:"center",gap:"8px"},onMouseEnter:t=>t.currentTarget.style.background="var(--bg-hover)",onMouseLeave:t=>t.currentTarget.style.background="transparent",children:[e.jsx("i",{className:"ph ph-key"}),"Reset Password"]}),e.jsxs("button",{onClick:t=>{t.stopPropagation(),ae(s),t.currentTarget.parentElement.style.display="none"},style:{width:"100%",padding:"8px 12px",fontSize:"13px",color:"var(--text-primary)",background:"transparent",border:"none",textAlign:"left",cursor:"pointer",display:"flex",alignItems:"center",gap:"8px"},onMouseEnter:t=>t.currentTarget.style.background="var(--bg-hover)",onMouseLeave:t=>t.currentTarget.style.background="transparent",children:[e.jsx("i",{className:s.status==="Active"?"ph ph-prohibit":"ph ph-check-circle"}),s.status==="Active"?"Deactivate":"Activate"]})]})]})]})}];return e.jsxs("div",{className:l.userList,children:[e.jsx(R,{icon:"ph ph-users",title:"Users",badge:e.jsxs(A,{variant:"info",children:[$," Active"]}),actions:e.jsxs(e.Fragment,{children:[e.jsx("input",{type:"file",id:"import-users",accept:".csv",style:{display:"none"},onChange:Z}),e.jsx(f,{variant:"default",icon:"ph ph-upload-simple",onClick:()=>document.getElementById("import-users").click(),children:"Import"}),e.jsx(f,{variant:"default",icon:"ph ph-download-simple",onClick:X,children:"Export"}),e.jsx(f,{variant:"primary",icon:"ph ph-plus",onClick:()=>h(!0),children:"Create User"})]})}),e.jsxs("div",{className:l.filtersSection,children:[e.jsxs("div",{className:l.filterGroup,children:[e.jsx("label",{children:"Role"}),e.jsxs(B,{children:[e.jsxs(C,{active:r==="All",onClick:()=>i("All"),children:["All ",e.jsxs("span",{className:l.badge,children:["(",y.length,")"]})]}),e.jsxs(C,{active:r==="Admin",onClick:()=>i("Admin"),children:["Admin ",e.jsxs("span",{className:l.badge,children:["(",V,")"]})]}),e.jsxs(C,{active:r==="Operator",onClick:()=>i("Operator"),children:["Operator ",e.jsxs("span",{className:l.badge,children:["(",W,")"]})]}),e.jsxs(C,{active:r==="Viewer",onClick:()=>i("Viewer"),children:["Viewer ",e.jsxs("span",{className:l.badge,children:["(",H,")"]})]})]})]}),e.jsxs("div",{className:l.filterGroup,children:[e.jsx("label",{children:"Status"}),e.jsxs(B,{children:[e.jsxs(C,{active:a==="All",onClick:()=>n("All"),children:["All ",e.jsxs("span",{className:l.badge,children:["(",y.length,")"]})]}),e.jsxs(C,{active:a==="Active",onClick:()=>n("Active"),children:["Active ",e.jsxs("span",{className:l.badge,children:["(",$,")"]})]}),e.jsxs(C,{active:a==="Disabled",onClick:()=>n("Disabled"),children:["Disabled ",e.jsxs("span",{className:l.badge,children:["(",J,")"]})]})]})]})]}),e.jsx("div",{className:l.tableContainer,children:L.length===0?e.jsx(oe,{icon:"ph ph-users",title:"No users found",message:r!=="All"||a!=="All"?"Try adjusting your filters to see more results":"Get started by creating your first user account",action:r==="All"&&a==="All"?{label:"Create User",onClick:()=>h(!0)}:void 0}):e.jsx(te,{columns:re,data:L,loading:d,onRowClick:s=>console.log("User clicked:",s),pageSize:10})}),e.jsx(de,{isOpen:m,onClose:()=>h(!1)}),e.jsx(fe,{isOpen:v,onClose:()=>P(!1),user:k})]})}export{Oe as UserList,Oe as default};

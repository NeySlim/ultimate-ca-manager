import{a as D,r as f,j as e,B as S,z as x}from"./index-BoyhujqD.js";import{P as E}from"./PageTopBar-CUpBz-x1.js";import{F as M,a as z}from"./FiltersBar-CYygxLOy.js";import{P as F,a as _}from"./PillFilter-BQWAxPwF.js";import{B as p}from"./Badge-Dtg0h6Lx.js";import{u as O}from"./useQuery-DXJNeu6S.js";import{u as R}from"./useMutation-ITFuBC1d.js";import{a as w}from"./api-ClVrI7m4.js";import{M as P}from"./Modal-B_9f-3a5.js";import{I as b}from"./Input-CqBYpE9v.js";import{c as U}from"./useCAs-DxkgIl7n.js";import{s as C,F as W}from"./ImportCAModal.module-B70-oila.js";import{e as H}from"./export-BEFxFx9V.js";const T={getAll:async(n={})=>{const r=await w.get("/api/v2/certificates",{params:n}),s=(r.data||[]).map(l=>{const m=new Date(l.valid_to),u=Math.ceil((m-new Date)/(1e3*60*60*24));let o="ACTIVE";l.revoked?o="REVOKED":u<0?o="EXPIRED":u<=7?o="CRITICAL":u<=30&&(o="EXPIRING SOON");const g=l.subject?.match(/CN=([^,]+)/),v=g?g[1]:l.subject||"Unnamed Certificate",d=l.subject?.includes("Server")?"Server":"Client";return{id:l.id,name:v,serial:l.serial||"N/A",type:d,issuer:l.issuer||"Unknown",status:o,issued:l.valid_from?l.valid_from.split("T")[0]:"N/A",expires:l.valid_to?l.valid_to.split("T")[0]:"N/A",daysLeft:u>0?u:0,_raw:l}});return{data:s,meta:r.meta||{page:1,per_page:20,total:s.length}}},getById:async n=>(await w.get(`/api/v2/certificates/${n}`)).data,revoke:async(n,r)=>(await w.post(`/api/v2/certificates/${n}/revoke`,{reason:r})).data,renew:async n=>(await w.post(`/api/v2/certificates/${n}/renew`)).data,download:async(n,r="pem")=>await w.get(`/api/v2/certificates/${n}/download`,{params:{format:r},responseType:"blob"}),issue:async n=>(await w.post("/api/v2/certificates",n)).data},k={all:["certificates"],lists:()=>[...k.all,"list"],list:n=>[...k.lists(),n],details:()=>[...k.all,"detail"],detail:n=>[...k.details(),n]},Q=(n={})=>O({queryKey:k.list(n),queryFn:()=>T.getAll(n)}),V=()=>{const n=D();return R({mutationFn:({id:r,reason:s})=>T.revoke(r,s),onSuccess:()=>{n.invalidateQueries({queryKey:k.all})}})},X=()=>{const n=D();return R({mutationFn:T.issue,onSuccess:()=>{n.invalidateQueries({queryKey:k.all})}})},Y="_form_7q3s3_1",J="_section_7q3s3_7",Z="_sectionTitle_7q3s3_13",ee="_fieldGroup_7q3s3_22",se="_fieldRow_7q3s3_29",ae="_label_7q3s3_35",ie="_fieldHint_7q3s3_43",te="_select_7q3s3_49",ne="_checkboxGroup_7q3s3_75",le="_checkbox_7q3s3_75",i={form:Y,section:J,sectionTitle:Z,fieldGroup:ee,fieldRow:se,label:ae,fieldHint:ie,select:te,checkboxGroup:ne,checkbox:le};function re({isOpen:n,onClose:r}){const[s,l]=f.useState({ca_id:"",common_name:"",organization:"",organizational_unit:"",country:"",state:"",locality:"",san:"",validity_days:"365",key_size:"2048",key_usage:["digitalSignature","keyEncipherment"]}),m=X(),{data:N,isLoading:u}=U(),o=N?.data||[];f.useEffect(()=>{o.length>0&&!s.ca_id&&l(a=>({...a,ca_id:o[0].id.toString()}))},[o,s.ca_id]);const g=a=>{if(a.preventDefault(),!s.ca_id){x.error("Please select a Certificate Authority");return}if(!s.common_name){x.error("Common Name is required");return}const h={ca_id:parseInt(s.ca_id),common_name:s.common_name,organization:s.organization,organizational_unit:s.organizational_unit,country:s.country,state:s.state,locality:s.locality,san:s.san,validity_days:parseInt(s.validity_days),key_size:parseInt(s.key_size),key_usage:s.key_usage};m.mutate(h,{onSuccess:()=>{x.success("Certificate issued successfully"),r(),v()},onError:y=>{x.error(`Failed to issue certificate: ${y.message}`)}})},v=()=>{l({ca_id:o.length>0?o[0].id.toString():"",common_name:"",organization:"",organizational_unit:"",country:"",state:"",locality:"",san:"",validity_days:"365",key_size:"2048",key_usage:["digitalSignature","keyEncipherment"]})},d=(a,h)=>{l(y=>({...y,[a]:h}))},j=a=>{l(h=>({...h,key_usage:h.key_usage.includes(a)?h.key_usage.filter(y=>y!==a):[...h.key_usage,a]}))};return e.jsx(P,{isOpen:n,onClose:r,title:"Issue Certificate",size:"lg",footer:e.jsxs(e.Fragment,{children:[e.jsx(S,{variant:"default",onClick:r,children:"Cancel"}),e.jsx(S,{variant:"primary",onClick:g,disabled:m.isPending,children:m.isPending?"Issuing...":"Issue Certificate"})]}),children:e.jsxs("form",{className:i.form,onSubmit:g,children:[e.jsxs("div",{className:i.fieldGroup,children:[e.jsx("label",{className:i.label,children:"Certificate Authority *"}),e.jsx("select",{className:i.select,value:s.ca_id,onChange:a=>d("ca_id",a.target.value),disabled:u,children:u?e.jsx("option",{children:"Loading CAs..."}):o.length===0?e.jsx("option",{children:"No CAs available"}):o.map(a=>e.jsx("option",{value:a.id,children:a.name},a.id))})]}),e.jsxs("div",{className:i.section,children:[e.jsx("h3",{className:i.sectionTitle,children:"Subject Information"}),e.jsxs("div",{className:i.fieldGroup,children:[e.jsx("label",{className:i.label,children:"Common Name (CN) *"}),e.jsx(b,{value:s.common_name,onChange:a=>d("common_name",a.target.value),placeholder:"example.com",required:!0})]}),e.jsxs("div",{className:i.fieldRow,children:[e.jsxs("div",{className:i.fieldGroup,children:[e.jsx("label",{className:i.label,children:"Organization (O)"}),e.jsx(b,{value:s.organization,onChange:a=>d("organization",a.target.value),placeholder:"My Company"})]}),e.jsxs("div",{className:i.fieldGroup,children:[e.jsx("label",{className:i.label,children:"Organizational Unit (OU)"}),e.jsx(b,{value:s.organizational_unit,onChange:a=>d("organizational_unit",a.target.value),placeholder:"IT Department"})]})]}),e.jsxs("div",{className:i.fieldRow,children:[e.jsxs("div",{className:i.fieldGroup,children:[e.jsx("label",{className:i.label,children:"Country (C)"}),e.jsx(b,{value:s.country,onChange:a=>d("country",a.target.value),placeholder:"US",maxLength:2})]}),e.jsxs("div",{className:i.fieldGroup,children:[e.jsx("label",{className:i.label,children:"State/Province (ST)"}),e.jsx(b,{value:s.state,onChange:a=>d("state",a.target.value),placeholder:"California"})]}),e.jsxs("div",{className:i.fieldGroup,children:[e.jsx("label",{className:i.label,children:"City/Locality (L)"}),e.jsx(b,{value:s.locality,onChange:a=>d("locality",a.target.value),placeholder:"San Francisco"})]})]}),e.jsxs("div",{className:i.fieldGroup,children:[e.jsx("label",{className:i.label,children:"Subject Alternative Names (SAN)"}),e.jsx(b,{value:s.san,onChange:a=>d("san",a.target.value),placeholder:"DNS:example.com, DNS:*.example.com, IP:192.168.1.1"}),e.jsx("span",{className:i.fieldHint,children:"Comma-separated list (e.g., DNS:example.com, IP:192.168.1.1)"})]})]}),e.jsxs("div",{className:i.section,children:[e.jsx("h3",{className:i.sectionTitle,children:"Settings"}),e.jsxs("div",{className:i.fieldRow,children:[e.jsxs("div",{className:i.fieldGroup,children:[e.jsx("label",{className:i.label,children:"Validity (days)"}),e.jsx(b,{type:"number",value:s.validity_days,onChange:a=>d("validity_days",a.target.value),min:"1",max:"36500"})]}),e.jsxs("div",{className:i.fieldGroup,children:[e.jsx("label",{className:i.label,children:"Key Size (bits)"}),e.jsxs("select",{className:i.select,value:s.key_size,onChange:a=>d("key_size",a.target.value),children:[e.jsx("option",{value:"2048",children:"2048"}),e.jsx("option",{value:"4096",children:"4096"})]})]})]})]}),e.jsxs("div",{className:i.section,children:[e.jsx("h3",{className:i.sectionTitle,children:"Key Usage"}),e.jsxs("div",{className:i.checkboxGroup,children:[e.jsxs("label",{className:i.checkbox,children:[e.jsx("input",{type:"checkbox",checked:s.key_usage.includes("digitalSignature"),onChange:()=>j("digitalSignature")}),e.jsx("span",{children:"Digital Signature"})]}),e.jsxs("label",{className:i.checkbox,children:[e.jsx("input",{type:"checkbox",checked:s.key_usage.includes("keyEncipherment"),onChange:()=>j("keyEncipherment")}),e.jsx("span",{children:"Key Encipherment"})]}),e.jsxs("label",{className:i.checkbox,children:[e.jsx("input",{type:"checkbox",checked:s.key_usage.includes("dataEncipherment"),onChange:()=>j("dataEncipherment")}),e.jsx("span",{children:"Data Encipherment"})]}),e.jsxs("label",{className:i.checkbox,children:[e.jsx("input",{type:"checkbox",checked:s.key_usage.includes("keyAgreement"),onChange:()=>j("keyAgreement")}),e.jsx("span",{children:"Key Agreement"})]}),e.jsxs("label",{className:i.checkbox,children:[e.jsx("input",{type:"checkbox",checked:s.key_usage.includes("keyCertSign"),onChange:()=>j("keyCertSign")}),e.jsx("span",{children:"Certificate Signing"})]}),e.jsxs("label",{className:i.checkbox,children:[e.jsx("input",{type:"checkbox",checked:s.key_usage.includes("crlSign"),onChange:()=>j("crlSign")}),e.jsx("span",{children:"CRL Signing"})]})]})]})]})})}function ce({isOpen:n,onClose:r}){const[s,l]=f.useState(null),[m,N]=f.useState("pem"),[u,o]=f.useState(""),[g,v]=f.useState(!1),d=async a=>{if(a.preventDefault(),!s){x.error("Please select a file to import");return}if(m==="pkcs12"&&!u){x.error("Password is required for PKCS#12 files");return}v(!0);try{const h=new FormData;h.append("file",s),h.append("format",m),u&&h.append("password",u);const y=await fetch("/api/v2/certificates/import",{method:"POST",body:h});if(!y.ok){const I=await y.json();throw new Error(I.message||"Failed to import certificate")}x.success("Certificate imported successfully"),r(),l(null),o(""),N("pem"),window.location.reload()}catch(h){x.error(h.message||"Failed to import certificate")}finally{v(!1)}},j=e.jsxs(e.Fragment,{children:[e.jsx(S,{variant:"secondary",onClick:r,disabled:g,children:"Cancel"}),e.jsx(S,{variant:"primary",onClick:d,disabled:g,children:g?"Importing...":"Import Certificate"})]});return e.jsx(P,{isOpen:n,onClose:r,title:"Import Certificate",size:"md",footer:j,children:e.jsxs("form",{onSubmit:d,className:C.form,children:[e.jsxs("div",{className:C.section,children:[e.jsx("label",{className:C.label,children:"Certificate Format"}),e.jsxs("select",{value:m,onChange:a=>N(a.target.value),className:C.select,children:[e.jsx("option",{value:"pem",children:"PEM (Base64 encoded)"}),e.jsx("option",{value:"der",children:"DER (Binary)"}),e.jsx("option",{value:"pkcs12",children:"PKCS#12 (.p12, .pfx)"})]})]}),e.jsx(W,{file:s,onFileChange:l,accept:".pem,.crt,.cer,.der,.p12,.pfx",maxSize:10*1024*1024}),m==="pkcs12"&&e.jsxs("div",{className:C.section,children:[e.jsx("label",{className:C.label,children:"PKCS#12 Password"}),e.jsx("input",{type:"password",value:u,onChange:a=>o(a.target.value),className:C.input,placeholder:"Enter PKCS#12 password"}),e.jsx("p",{className:C.helpText,children:"Required to decrypt PKCS#12 files"})]})]})})}const oe="_tableContainer_2f75z_2",de="_certNameCell_2f75z_45",he="_certName_2f75z_45",ue="_certSerial_2f75z_56",me="_badgeType_2f75z_63",pe="_badgeInfo_2f75z_74",xe="_badgeNeutral_2f75z_79",ge="_badgeStatus_2f75z_84",fe="_badgeSuccess_2f75z_95",je="_badgeWarning_2f75z_100",ye="_badgeError_2f75z_105",ve="_expiresCell_2f75z_111",_e="_badgeDays_2f75z_117",be="_actionsCell_2f75z_130",Ce="_actionBtn_2f75z_135",c={tableContainer:oe,certNameCell:de,certName:he,certSerial:ue,badgeType:me,badgeInfo:pe,badgeNeutral:xe,badgeStatus:ge,badgeSuccess:fe,badgeWarning:je,badgeError:ye,expiresCell:ve,badgeDays:_e,actionsCell:be,actionBtn:Ce};function Be(){const[n,r]=f.useState("all"),[s,l]=f.useState("all"),[m,N]=f.useState("name"),[u,o]=f.useState(!1),[g,v]=f.useState(!1),{data:d,isLoading:j,error:a}=Q(),{mutate:h}=V(),y=t=>{window.confirm(`Revoke certificate ${t.name}?`)&&h({id:t.id,reason:"Revoked by administrator"},{onSuccess:()=>x.success(`Certificate ${t.name} revoked successfully`),onError:K=>x.error(`Failed to revoke certificate: ${K.message}`)})},I=()=>{const t=d?.data||[];if(t.length===0){x.error("No data to export");return}H(t,"certificates-export",{format:"csv",columns:["id","name","type","status","issuedBy","daysLeft","issued","expires"]}),x.success("Certificates exported successfully")},B=t=>{window.open(`/api/v2/certificates/${t.id}/download`,"_blank")},L=t=>t<=7?c.badgeError:t<=30?c.badgeWarning:c.badgeSuccess,q=t=>t==="CRITICAL"?c.badgeError:t==="EXPIRING SOON"?c.badgeWarning:c.badgeSuccess,G=t=>t==="Server"||t==="Client"?c.badgeInfo:c.badgeNeutral;if(j)return e.jsxs("div",{className:c.certificateList,children:[e.jsx(E,{icon:"ph ph-certificate",title:"Certificates",badge:e.jsx(p,{variant:"neutral",children:"Loading..."})}),e.jsx("div",{style:{padding:"2rem",textAlign:"center"},children:"Loading certificates..."})]});if(a)return e.jsxs("div",{className:c.certificateList,children:[e.jsx(E,{icon:"ph ph-certificate",title:"Certificates",badge:e.jsx(p,{variant:"danger",children:"Error"})}),e.jsxs("div",{style:{padding:"2rem",textAlign:"center",color:"var(--color-danger)"},children:["Error loading certificates: ",a.message]})]});const A=d?.data||[],$=A.filter(t=>t.status==="ACTIVE").length;return e.jsxs("div",{className:c.certificateList,children:[e.jsx(E,{icon:"ph ph-certificate",title:"Certificates",badge:e.jsxs(p,{variant:"success",children:[$," Active"]}),actions:e.jsxs(e.Fragment,{children:[e.jsx(S,{icon:"ph ph-upload-simple",onClick:()=>v(!0),children:"Import"}),e.jsx(S,{icon:"ph ph-download-simple",onClick:I,children:"Export"}),e.jsx(S,{variant:"primary",icon:"ph ph-file-plus",onClick:()=>o(!0),children:"Issue Certificate"})]})}),e.jsxs(M,{children:[e.jsx(z,{label:"TYPE",children:e.jsxs(F,{children:[e.jsxs(_,{active:n==="all",onClick:()=>r("all"),children:["All ",e.jsx(p,{variant:"secondary",children:"(247)"})]}),e.jsxs(_,{active:n==="server",onClick:()=>r("server"),children:["Server ",e.jsx(p,{variant:"secondary",children:"(89)"})]}),e.jsxs(_,{active:n==="client",onClick:()=>r("client"),children:["Client ",e.jsx(p,{variant:"secondary",children:"(158)"})]}),e.jsxs(_,{active:n==="acme",onClick:()=>r("acme"),children:["ACME ",e.jsx(p,{variant:"secondary",children:"(34)"})]})]})}),e.jsx(z,{label:"STATUS",children:e.jsxs(F,{children:[e.jsxs(_,{active:s==="all",onClick:()=>l("all"),children:["All ",e.jsx(p,{variant:"secondary",children:"(247)"})]}),e.jsxs(_,{active:s==="active",onClick:()=>l("active"),children:["Active ",e.jsx(p,{variant:"secondary",children:"(235)"})]}),e.jsxs(_,{active:s==="expiring",onClick:()=>l("expiring"),children:["Expiring ",e.jsx(p,{variant:"secondary",children:"(12)"})]}),e.jsxs(_,{active:s==="expired",onClick:()=>l("expired"),children:["Expired ",e.jsx(p,{variant:"secondary",children:"(0)"})]}),e.jsxs(_,{active:s==="revoked",onClick:()=>l("revoked"),children:["Revoked ",e.jsx(p,{variant:"secondary",children:"(0)"})]})]})}),e.jsx(z,{label:"SORT",children:e.jsxs("select",{value:m,onChange:t=>N(t.target.value),children:[e.jsx("option",{value:"name",children:"Name"}),e.jsx("option",{value:"issued",children:"Issued"}),e.jsx("option",{value:"expires",children:"Expires"})]})})]}),e.jsx("div",{className:c.tableContainer,children:e.jsxs("table",{children:[e.jsx("thead",{children:e.jsxs("tr",{children:[e.jsx("th",{style:{width:"40%"},children:"CERTIFICATE"}),e.jsx("th",{style:{width:"10%"},children:"TYPE"}),e.jsx("th",{style:{width:"15%"},children:"ISSUER"}),e.jsx("th",{style:{width:"10%"},children:"STATUS"}),e.jsx("th",{style:{width:"10%"},children:"ISSUED"}),e.jsx("th",{style:{width:"10%"},children:"EXPIRES"}),e.jsx("th",{style:{width:"5%"},children:"ACTIONS"})]})}),e.jsx("tbody",{children:A.map(t=>e.jsxs("tr",{children:[e.jsx("td",{children:e.jsxs("div",{className:c.certNameCell,children:[e.jsx("span",{className:c.certName,children:t.name}),e.jsxs("span",{className:c.certSerial,children:["Serial: ",t.serial]})]})}),e.jsx("td",{children:e.jsx("span",{className:`${c.badgeType} ${G(t.type)}`,children:t.type})}),e.jsx("td",{children:t.issuer}),e.jsx("td",{children:e.jsx("span",{className:`${c.badgeStatus} ${q(t.status)}`,children:t.status})}),e.jsx("td",{children:t.issued}),e.jsx("td",{children:e.jsxs("div",{className:c.expiresCell,children:[e.jsx("span",{children:t.expires}),e.jsxs("span",{className:`${c.badgeDays} ${L(t.daysLeft)}`,children:[t.daysLeft," DAYS"]})]})}),e.jsx("td",{children:e.jsxs("div",{className:c.actionsCell,children:[e.jsx("button",{className:c.actionBtn,title:"Download",onClick:()=>B(t),children:e.jsx("i",{className:"ph ph-download-simple"})}),e.jsx("button",{className:c.actionBtn,title:"Revoke",onClick:()=>y(t),children:e.jsx("i",{className:"ph ph-x-circle"})}),e.jsx("button",{className:c.actionBtn,title:"More",children:e.jsx("i",{className:"ph ph-dots-three-outline-vertical"})})]})})]},t.id))})]})}),e.jsx(re,{isOpen:u,onClose:()=>o(!1)}),e.jsx(ce,{isOpen:g,onClose:()=>v(!1)})]})}export{Be as CertificateList,Be as default};

import{r as v,j as e,B as g,z as d,a as $}from"./index-DvblE3fx.js";import{D as J}from"./DataTable-CnxoHSkw.js";import{B as _}from"./Badge-B80MzN2D.js";import{P as E}from"./PageTopBar-BwgB73XK.js";import{P as I,a as x}from"./PillFilter-915J61Km.js";import{e as H}from"./export-BEFxFx9V.js";import{M as W}from"./Modal-3iP6FGKu.js";import{I as k}from"./Input-RIgYiBtS.js";import{s as t}from"./CreateCAModal.module-DdQgTClK.js";import{u as X}from"./useQuery-B28DX-fo.js";import{u as T}from"./useMutation-Cu_HUv75.js";import{a as w}from"./api-ClVrI7m4.js";function Y({isOpen:r,onClose:i}){const[a,m]=v.useState({username:"",password:"",confirmPassword:"",email:"",fullName:"",role:"operator",permissions:{manageCAs:!1,issueCertificates:!0,revokeCertificates:!1,manageUsers:!1,viewLogs:!0,manageSettings:!1}}),[C,b]=v.useState(!1),A=async c=>{if(c.preventDefault(),!a.username||!a.password){d.error("Username and password are required");return}if(a.password!==a.confirmPassword){d.error("Passwords do not match");return}if(a.password.length<8){d.error("Password must be at least 8 characters");return}b(!0);try{const o=await fetch("/api/v2/users",{method:"POST",headers:{"Content-Type":"application/json"},body:JSON.stringify({username:a.username,password:a.password,email:a.email,full_name:a.fullName,role:a.role,permissions:a.permissions})});if(!o.ok){const h=await o.json();throw new Error(h.message||"Failed to create user")}d.success("User created successfully"),i(),m({username:"",password:"",confirmPassword:"",email:"",fullName:"",role:"operator",permissions:{manageCAs:!1,issueCertificates:!0,revokeCertificates:!1,manageUsers:!1,viewLogs:!0,manageSettings:!1}}),window.location.reload()}catch(o){d.error(o.message||"Failed to create user")}finally{b(!1)}},u=c=>{m(o=>({...o,[c.target.name]:c.target.value}))},f=c=>{m(o=>({...o,permissions:{...o.permissions,[c]:!o.permissions[c]}}))},U=c=>{const o=c.target.value;let h={...a.permissions};o==="admin"?h={manageCAs:!0,issueCertificates:!0,revokeCertificates:!0,manageUsers:!0,viewLogs:!0,manageSettings:!0}:o==="operator"?h={manageCAs:!1,issueCertificates:!0,revokeCertificates:!1,manageUsers:!1,viewLogs:!0,manageSettings:!1}:o==="viewer"&&(h={manageCAs:!1,issueCertificates:!1,revokeCertificates:!1,manageUsers:!1,viewLogs:!0,manageSettings:!1}),m(y=>({...y,role:o,permissions:h}))},S=e.jsxs(e.Fragment,{children:[e.jsx(g,{variant:"secondary",onClick:i,disabled:C,children:"Cancel"}),e.jsx(g,{variant:"primary",onClick:A,disabled:C,children:C?"Creating...":"Create User"})]});return e.jsx(W,{isOpen:r,onClose:i,title:"Create User",size:"md",footer:S,children:e.jsxs("form",{onSubmit:A,className:t.form,children:[e.jsxs("div",{className:t.section,children:[e.jsx("h3",{className:t.sectionTitle,children:"Account Information"}),e.jsx(k,{label:"Username",name:"username",value:a.username,onChange:u,placeholder:"john.doe",required:!0}),e.jsx(k,{label:"Full Name",name:"fullName",value:a.fullName,onChange:u,placeholder:"John Doe"}),e.jsx(k,{label:"Email Address",name:"email",type:"email",value:a.email,onChange:u,placeholder:"john.doe@example.com"})]}),e.jsxs("div",{className:t.section,children:[e.jsx("h3",{className:t.sectionTitle,children:"Security"}),e.jsx(k,{label:"Password",name:"password",type:"password",value:a.password,onChange:u,placeholder:"••••••••",required:!0,helpText:"Minimum 8 characters"}),e.jsx(k,{label:"Confirm Password",name:"confirmPassword",type:"password",value:a.confirmPassword,onChange:u,placeholder:"••••••••",required:!0})]}),e.jsxs("div",{className:t.section,children:[e.jsx("h3",{className:t.sectionTitle,children:"Role & Permissions"}),e.jsxs("div",{className:t.field,children:[e.jsx("label",{className:t.label,children:"Role"}),e.jsxs("select",{name:"role",value:a.role,onChange:U,className:t.select,children:[e.jsx("option",{value:"admin",children:"Administrator"}),e.jsx("option",{value:"operator",children:"Operator"}),e.jsx("option",{value:"viewer",children:"Viewer"})]}),e.jsxs("p",{className:t.helpText,children:[a.role==="admin"&&"Full access to all features",a.role==="operator"&&"Can issue and manage certificates",a.role==="viewer"&&"Read-only access"]})]}),e.jsxs("div",{className:t.permissionsGrid,children:[e.jsxs("label",{className:t.checkboxLabel,children:[e.jsx("input",{type:"checkbox",checked:a.permissions.manageCAs,onChange:()=>f("manageCAs"),className:t.checkbox}),e.jsx("span",{children:"Manage CAs"})]}),e.jsxs("label",{className:t.checkboxLabel,children:[e.jsx("input",{type:"checkbox",checked:a.permissions.issueCertificates,onChange:()=>f("issueCertificates"),className:t.checkbox}),e.jsx("span",{children:"Issue Certificates"})]}),e.jsxs("label",{className:t.checkboxLabel,children:[e.jsx("input",{type:"checkbox",checked:a.permissions.revokeCertificates,onChange:()=>f("revokeCertificates"),className:t.checkbox}),e.jsx("span",{children:"Revoke Certificates"})]}),e.jsxs("label",{className:t.checkboxLabel,children:[e.jsx("input",{type:"checkbox",checked:a.permissions.manageUsers,onChange:()=>f("manageUsers"),className:t.checkbox}),e.jsx("span",{children:"Manage Users"})]}),e.jsxs("label",{className:t.checkboxLabel,children:[e.jsx("input",{type:"checkbox",checked:a.permissions.viewLogs,onChange:()=>f("viewLogs"),className:t.checkbox}),e.jsx("span",{children:"View Logs"})]}),e.jsxs("label",{className:t.checkboxLabel,children:[e.jsx("input",{type:"checkbox",checked:a.permissions.manageSettings,onChange:()=>f("manageSettings"),className:t.checkbox}),e.jsx("span",{children:"Manage Settings"})]})]})]})]})})}const F={getUsers:async(r={})=>(await w.get("/api/v2/users",{params:r})).data,createUser:async r=>(await w.post("/api/v2/users",r)).data,updateUser:async({id:r,...i})=>(await w.put(`/api/v2/users/${r}`,i)).data,deleteUser:async r=>(await w.delete(`/api/v2/users/${r}`)).data,importUsers:async r=>{const i=new FormData;return i.append("file",r),(await w.post("/api/v2/users/import",i,{headers:{"Content-Type":"multipart/form-data"}})).data}},N={all:["users"],lists:()=>[...N.all,"list"],list:r=>[...N.lists(),r]},Z=(r={})=>X({queryKey:N.list(r),queryFn:()=>F.getUsers(r)}),ee=()=>{const r=$();return T({mutationFn:F.deleteUser,onSuccess:()=>{r.invalidateQueries({queryKey:N.all}),d.success("User deleted successfully")},onError:i=>{d.error(i.response?.data?.message||"Failed to delete user")}})},se=()=>{const r=$();return T({mutationFn:F.importUsers,onSuccess:i=>{r.invalidateQueries({queryKey:N.all});const{imported:a=0,skipped:m=0}=i;d.success(`Imported ${a} users, skipped ${m}`)},onError:i=>{d.error(i.response?.data?.message||"Failed to import users")}})},ae="_userList_96igz_3",re="_filtersSection_96igz_9",te="_filterGroup_96igz_21",ie="_badge_96igz_35",ne="_tableContainer_96igz_40",le="_userInfoCell_96igz_46",oe="_userAvatar_96igz_52",ce="_userDetails_96igz_66",de="_userName_96igz_72",me="_userEmail_96igz_78",ue="_actionsCell_96igz_83",l={userList:ae,filtersSection:re,filterGroup:te,badge:ie,tableContainer:ne,userInfoCell:le,userAvatar:oe,userDetails:ce,userName:de,userEmail:me,actionsCell:ue};function Ae(){const[r,i]=v.useState("All"),[a,m]=v.useState("All"),[C,b]=v.useState(!1),A=v.useMemo(()=>{const s={};return r!=="All"&&(s.role=r.toLowerCase()),a!=="All"&&(s.active=a==="Active"),s},[r,a]),{data:u,isLoading:f,error:U}=Z(A),S=ee(),c=se(),o=s=>{if(!s)return"??";const n=s.split(" ");return n.length>1?`${n[0][0]}${n[1][0]}`:s.substring(0,2)},h=s=>{if(!s)return"Never";const n=new Date(s),L=new Date-n,z=Math.floor(L/6e4),P=Math.floor(L/36e5),j=Math.floor(L/864e5);return z<60?`${z} min ago`:P<24?`${P} hour${P>1?"s":""} ago`:j<7?`${j} day${j>1?"s":""} ago`:j<30?`${Math.floor(j/7)} week${Math.floor(j/7)>1?"s":""} ago`:n.toLocaleDateString("en-US",{month:"short",year:"numeric"})},y=Array.isArray(u)?u:u?.data||[];console.log("=== DEBUG ==="),console.log("data type:",typeof u),console.log("rawUsers length:",y.length),console.log("first user:",y[0]);const p=y.map(s=>{try{return{id:s.id,name:s.username,initials:o(s.username),email:s.email,role:s.role?s.role.charAt(0).toUpperCase()+s.role.slice(1):"Unknown",status:s.active?"Active":"Disabled",lastLogin:h(s.last_login),created:h(s.created_at)}}catch(n){return console.error("Error mapping user:",s,n),null}}).filter(Boolean);console.log("usersData length:",p.length),console.log("first transformed:",p[0]);const D=p,q=p.filter(s=>s.role==="Admin").length,R=p.filter(s=>s.role==="Operator").length,O=p.filter(s=>s.role==="Viewer").length,M=p.filter(s=>s.status==="Active").length,B=p.filter(s=>s.status==="Disabled").length,G=()=>{if(D.length===0){d.error("No data to export");return}H(D,"users-export",{format:"csv",columns:["id","name","email","role","status","lastLogin","created"]}),d.success("Users exported successfully")},V=s=>{confirm(`Delete user "${s.name}"?`)&&S.mutate(s.id)},K=s=>{const n=s.target.files[0];n&&(c.mutate(n),s.target.value="")};if(U)return e.jsxs("div",{className:l.userList,children:[e.jsx(E,{icon:"ph ph-users",title:"Users",badge:e.jsx(_,{variant:"danger",children:"Error"})}),e.jsxs("div",{style:{padding:"2rem",textAlign:"center",color:"var(--color-danger)"},children:["Error loading users: ",U.message]})]});const Q=[{key:"name",label:"User",render:s=>e.jsxs("div",{className:l.userInfoCell,children:[e.jsx("div",{className:l.userAvatar,children:s.initials}),e.jsxs("div",{className:l.userDetails,children:[e.jsx("div",{className:l.userName,children:s.name}),e.jsx("div",{className:l.userEmail,children:s.email})]})]})},{key:"role",label:"Role",render:s=>{const n=s.role==="Admin"?"error":s.role==="Operator"?"warning":"info";return e.jsx(_,{variant:n,children:s.role})}},{key:"status",label:"Status",render:s=>e.jsx(_,{variant:s.status==="Active"?"success":"error",children:s.status})},{key:"lastLogin",label:"Last Login"},{key:"created",label:"Created"},{key:"actions",label:"Actions",render:s=>e.jsxs("div",{className:l.actionsCell,children:[e.jsx(g,{variant:"default",size:"sm",icon:"ph ph-pencil-simple",onClick:n=>{n.stopPropagation(),console.log("Edit:",s)}}),e.jsx(g,{variant:"default",size:"sm",icon:"ph ph-trash",onClick:n=>{n.stopPropagation(),V(s)}}),e.jsx(g,{variant:"default",size:"sm",icon:"ph ph-dots-three-outline-vertical",onClick:n=>{n.stopPropagation(),console.log("More:",s)}})]})}];return e.jsxs("div",{className:l.userList,children:[e.jsx(E,{icon:"ph ph-users",title:"Users",badge:e.jsxs(_,{variant:"info",children:[M," Active"]}),actions:e.jsxs(e.Fragment,{children:[e.jsx("input",{type:"file",id:"import-users",accept:".csv",style:{display:"none"},onChange:K}),e.jsx(g,{variant:"default",icon:"ph ph-upload-simple",onClick:()=>document.getElementById("import-users").click(),children:"Import"}),e.jsx(g,{variant:"default",icon:"ph ph-download-simple",onClick:G,children:"Export"}),e.jsx(g,{variant:"primary",icon:"ph ph-plus",onClick:()=>b(!0),children:"Create User"})]})}),e.jsxs("div",{className:l.filtersSection,children:[e.jsxs("div",{className:l.filterGroup,children:[e.jsx("label",{children:"Role"}),e.jsxs(I,{children:[e.jsxs(x,{active:r==="All",onClick:()=>i("All"),children:["All ",e.jsxs("span",{className:l.badge,children:["(",p.length,")"]})]}),e.jsxs(x,{active:r==="Admin",onClick:()=>i("Admin"),children:["Admin ",e.jsxs("span",{className:l.badge,children:["(",q,")"]})]}),e.jsxs(x,{active:r==="Operator",onClick:()=>i("Operator"),children:["Operator ",e.jsxs("span",{className:l.badge,children:["(",R,")"]})]}),e.jsxs(x,{active:r==="Viewer",onClick:()=>i("Viewer"),children:["Viewer ",e.jsxs("span",{className:l.badge,children:["(",O,")"]})]})]})]}),e.jsxs("div",{className:l.filterGroup,children:[e.jsx("label",{children:"Status"}),e.jsxs(I,{children:[e.jsxs(x,{active:a==="All",onClick:()=>m("All"),children:["All ",e.jsxs("span",{className:l.badge,children:["(",p.length,")"]})]}),e.jsxs(x,{active:a==="Active",onClick:()=>m("Active"),children:["Active ",e.jsxs("span",{className:l.badge,children:["(",M,")"]})]}),e.jsxs(x,{active:a==="Disabled",onClick:()=>m("Disabled"),children:["Disabled ",e.jsxs("span",{className:l.badge,children:["(",B,")"]})]})]})]})]}),e.jsx("div",{className:l.tableContainer,children:e.jsx(J,{columns:Q,data:D,loading:f,onRowClick:s=>console.log("User clicked:",s),pageSize:10})}),e.jsx(Y,{isOpen:C,onClose:()=>b(!1)})]})}export{Ae as UserList,Ae as default};

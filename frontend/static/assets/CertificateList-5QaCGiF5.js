import{b as w,d as P,r as g,j as e,B as S,z as x}from"./index-gWc9Wuxx.js";import{P as E}from"./PageTopBar-DQU6wF4a.js";import{F as O,a as T}from"./FiltersBar-CYF7-GM4.js";import{P as D,a as _}from"./PillFilter-BB3Y4lIb.js";import{B as p}from"./Badge-C7kSHm3C.js";import{a as U,E as q}from"./ErrorState-DvQycW5G.js";import{u as W}from"./useQuery-Cqzu-coP.js";import{u as R}from"./useMutation-BAq7cHoY.js";import{M as B}from"./Modal-sdelTJ_G.js";import{I as b}from"./Input-c2F2jU2v.js";import{c as H}from"./useCAs-JAZ7zFUo.js";import{s as C,F as Q}from"./ImportCAModal.module-BLIaiYMC.js";import{e as V}from"./export-BEFxFx9V.js";const A={getAll:async(n={})=>{const c=await w.get("/api/v2/certificates",{params:n}),s=(c.data||[]).map(l=>{const m=new Date(l.valid_to),u=Math.ceil((m-new Date)/(1e3*60*60*24));let o="ACTIVE";l.revoked?o="REVOKED":u<0?o="EXPIRED":u<=7?o="CRITICAL":u<=30&&(o="EXPIRING SOON");const f=l.subject?.match(/CN=([^,]+)/),v=f?f[1]:l.subject||"Unnamed Certificate",d=l.subject?.includes("Server")?"Server":"Client";return{id:l.id,name:v,serial:l.serial||"N/A",type:d,issuer:l.issuer||"Unknown",status:o,issued:l.valid_from?l.valid_from.split("T")[0]:"N/A",expires:l.valid_to?l.valid_to.split("T")[0]:"N/A",daysLeft:u>0?u:0,_raw:l}});return{data:s,meta:c.meta||{page:1,per_page:20,total:s.length}}},getById:async n=>(await w.get(`/api/v2/certificates/${n}`)).data,revoke:async(n,c)=>(await w.post(`/api/v2/certificates/${n}/revoke`,{reason:c})).data,renew:async n=>(await w.post(`/api/v2/certificates/${n}/renew`)).data,download:async(n,c="pem")=>await w.get(`/api/v2/certificates/${n}/download`,{params:{format:c},responseType:"blob"}),issue:async n=>(await w.post("/api/v2/certificates",n)).data},N={all:["certificates"],lists:()=>[...N.all,"list"],list:n=>[...N.lists(),n],details:()=>[...N.all,"detail"],detail:n=>[...N.details(),n]},X=(n={})=>W({queryKey:N.list(n),queryFn:()=>A.getAll(n)}),Y=()=>{const n=P();return R({mutationFn:({id:c,reason:s})=>A.revoke(c,s),onSuccess:()=>{n.invalidateQueries({queryKey:N.all})}})},J=()=>{const n=P();return R({mutationFn:A.issue,onSuccess:()=>{n.invalidateQueries({queryKey:N.all})}})},Z="_form_pko5h_1",ee="_section_pko5h_7",se="_sectionTitle_pko5h_13",ae="_fieldGroup_pko5h_22",te="_fieldRow_pko5h_29",ie="_label_pko5h_35",ne="_fieldHint_pko5h_43",le="_select_pko5h_49",re="_checkboxGroup_pko5h_75",ce="_checkbox_pko5h_75",t={form:Z,section:ee,sectionTitle:se,fieldGroup:ae,fieldRow:te,label:ie,fieldHint:ne,select:le,checkboxGroup:re,checkbox:ce};function oe({isOpen:n,onClose:c}){const[s,l]=g.useState({ca_id:"",common_name:"",organization:"",organizational_unit:"",country:"",state:"",locality:"",san:"",validity_days:"365",key_size:"2048",key_usage:["digitalSignature","keyEncipherment"]}),m=J(),{data:k,isLoading:u}=H(),o=k?.data||[];g.useEffect(()=>{o.length>0&&!s.ca_id&&l(a=>({...a,ca_id:o[0].id.toString()}))},[o,s.ca_id]);const f=a=>{if(a.preventDefault(),!s.ca_id){x.error("Please select a Certificate Authority");return}if(!s.common_name){x.error("Common Name is required");return}const h={ca_id:parseInt(s.ca_id),common_name:s.common_name,organization:s.organization,organizational_unit:s.organizational_unit,country:s.country,state:s.state,locality:s.locality,san:s.san,validity_days:parseInt(s.validity_days),key_size:parseInt(s.key_size),key_usage:s.key_usage};m.mutate(h,{onSuccess:()=>{x.success("Certificate issued successfully"),c(),v()},onError:y=>{x.error(`Failed to issue certificate: ${y.message}`)}})},v=()=>{l({ca_id:o.length>0?o[0].id.toString():"",common_name:"",organization:"",organizational_unit:"",country:"",state:"",locality:"",san:"",validity_days:"365",key_size:"2048",key_usage:["digitalSignature","keyEncipherment"]})},d=(a,h)=>{l(y=>({...y,[a]:h}))},j=a=>{l(h=>({...h,key_usage:h.key_usage.includes(a)?h.key_usage.filter(y=>y!==a):[...h.key_usage,a]}))};return e.jsx(B,{isOpen:n,onClose:c,title:"Issue Certificate",size:"lg",footer:e.jsxs(e.Fragment,{children:[e.jsx(S,{variant:"default",onClick:c,children:"Cancel"}),e.jsx(S,{variant:"primary",onClick:f,disabled:m.isPending,children:m.isPending?"Issuing...":"Issue Certificate"})]}),children:e.jsxs("form",{className:t.form,onSubmit:f,children:[e.jsxs("div",{className:t.fieldGroup,children:[e.jsx("label",{className:t.label,children:"Certificate Authority *"}),e.jsx("select",{className:t.select,value:s.ca_id,onChange:a=>d("ca_id",a.target.value),disabled:u,children:u?e.jsx("option",{children:"Loading CAs..."}):o.length===0?e.jsx("option",{children:"No CAs available"}):o.map(a=>e.jsx("option",{value:a.id,children:a.name},a.id))})]}),e.jsxs("div",{className:t.section,children:[e.jsx("h3",{className:t.sectionTitle,children:"Subject Information"}),e.jsxs("div",{className:t.fieldGroup,children:[e.jsx("label",{className:t.label,children:"Common Name (CN) *"}),e.jsx(b,{value:s.common_name,onChange:a=>d("common_name",a.target.value),placeholder:"example.com",required:!0})]}),e.jsxs("div",{className:t.fieldRow,children:[e.jsxs("div",{className:t.fieldGroup,children:[e.jsx("label",{className:t.label,children:"Organization (O)"}),e.jsx(b,{value:s.organization,onChange:a=>d("organization",a.target.value),placeholder:"My Company"})]}),e.jsxs("div",{className:t.fieldGroup,children:[e.jsx("label",{className:t.label,children:"Organizational Unit (OU)"}),e.jsx(b,{value:s.organizational_unit,onChange:a=>d("organizational_unit",a.target.value),placeholder:"IT Department"})]})]}),e.jsxs("div",{className:t.fieldRow,children:[e.jsxs("div",{className:t.fieldGroup,children:[e.jsx("label",{className:t.label,children:"Country (C)"}),e.jsx(b,{value:s.country,onChange:a=>d("country",a.target.value),placeholder:"US",maxLength:2})]}),e.jsxs("div",{className:t.fieldGroup,children:[e.jsx("label",{className:t.label,children:"State/Province (ST)"}),e.jsx(b,{value:s.state,onChange:a=>d("state",a.target.value),placeholder:"California"})]}),e.jsxs("div",{className:t.fieldGroup,children:[e.jsx("label",{className:t.label,children:"City/Locality (L)"}),e.jsx(b,{value:s.locality,onChange:a=>d("locality",a.target.value),placeholder:"San Francisco"})]})]}),e.jsxs("div",{className:t.fieldGroup,children:[e.jsx("label",{className:t.label,children:"Subject Alternative Names (SAN)"}),e.jsx(b,{value:s.san,onChange:a=>d("san",a.target.value),placeholder:"DNS:example.com, DNS:*.example.com, IP:192.168.1.1"}),e.jsx("span",{className:t.fieldHint,children:"Comma-separated list (e.g., DNS:example.com, IP:192.168.1.1)"})]})]}),e.jsxs("div",{className:t.section,children:[e.jsx("h3",{className:t.sectionTitle,children:"Settings"}),e.jsxs("div",{className:t.fieldRow,children:[e.jsxs("div",{className:t.fieldGroup,children:[e.jsx("label",{className:t.label,children:"Validity (days)"}),e.jsx(b,{type:"number",value:s.validity_days,onChange:a=>d("validity_days",a.target.value),min:"1",max:"36500"})]}),e.jsxs("div",{className:t.fieldGroup,children:[e.jsx("label",{className:t.label,children:"Key Size (bits)"}),e.jsxs("select",{className:t.select,value:s.key_size,onChange:a=>d("key_size",a.target.value),children:[e.jsx("option",{value:"2048",children:"2048"}),e.jsx("option",{value:"4096",children:"4096"})]})]})]})]}),e.jsxs("div",{className:t.section,children:[e.jsx("h3",{className:t.sectionTitle,children:"Key Usage"}),e.jsxs("div",{className:t.checkboxGroup,children:[e.jsxs("label",{className:t.checkbox,children:[e.jsx("input",{type:"checkbox",checked:s.key_usage.includes("digitalSignature"),onChange:()=>j("digitalSignature")}),e.jsx("span",{children:"Digital Signature"})]}),e.jsxs("label",{className:t.checkbox,children:[e.jsx("input",{type:"checkbox",checked:s.key_usage.includes("keyEncipherment"),onChange:()=>j("keyEncipherment")}),e.jsx("span",{children:"Key Encipherment"})]}),e.jsxs("label",{className:t.checkbox,children:[e.jsx("input",{type:"checkbox",checked:s.key_usage.includes("dataEncipherment"),onChange:()=>j("dataEncipherment")}),e.jsx("span",{children:"Data Encipherment"})]}),e.jsxs("label",{className:t.checkbox,children:[e.jsx("input",{type:"checkbox",checked:s.key_usage.includes("keyAgreement"),onChange:()=>j("keyAgreement")}),e.jsx("span",{children:"Key Agreement"})]}),e.jsxs("label",{className:t.checkbox,children:[e.jsx("input",{type:"checkbox",checked:s.key_usage.includes("keyCertSign"),onChange:()=>j("keyCertSign")}),e.jsx("span",{children:"Certificate Signing"})]}),e.jsxs("label",{className:t.checkbox,children:[e.jsx("input",{type:"checkbox",checked:s.key_usage.includes("crlSign"),onChange:()=>j("crlSign")}),e.jsx("span",{children:"CRL Signing"})]})]})]})]})})}function de({isOpen:n,onClose:c}){const[s,l]=g.useState(null),[m,k]=g.useState("pem"),[u,o]=g.useState(""),[f,v]=g.useState(!1),d=async a=>{if(a.preventDefault(),!s){x.error("Please select a file to import");return}if(m==="pkcs12"&&!u){x.error("Password is required for PKCS#12 files");return}v(!0);try{const h=new FormData;h.append("file",s),h.append("format",m),u&&h.append("password",u);const y=await fetch("/api/v2/certificates/import",{method:"POST",body:h});if(!y.ok){const I=await y.json();throw new Error(I.message||"Failed to import certificate")}x.success("Certificate imported successfully"),c(),l(null),o(""),k("pem"),window.location.reload()}catch(h){x.error(h.message||"Failed to import certificate")}finally{v(!1)}},j=e.jsxs(e.Fragment,{children:[e.jsx(S,{variant:"secondary",onClick:c,disabled:f,children:"Cancel"}),e.jsx(S,{variant:"primary",onClick:d,disabled:f,children:f?"Importing...":"Import Certificate"})]});return e.jsx(B,{isOpen:n,onClose:c,title:"Import Certificate",size:"md",footer:j,children:e.jsxs("form",{onSubmit:d,className:C.form,children:[e.jsxs("div",{className:C.section,children:[e.jsx("label",{className:C.label,children:"Certificate Format"}),e.jsxs("select",{value:m,onChange:a=>k(a.target.value),className:C.select,children:[e.jsx("option",{value:"pem",children:"PEM (Base64 encoded)"}),e.jsx("option",{value:"der",children:"DER (Binary)"}),e.jsx("option",{value:"pkcs12",children:"PKCS#12 (.p12, .pfx)"})]})]}),e.jsx(Q,{file:s,onFileChange:l,accept:".pem,.crt,.cer,.der,.p12,.pfx",maxSize:10*1024*1024}),m==="pkcs12"&&e.jsxs("div",{className:C.section,children:[e.jsx("label",{className:C.label,children:"PKCS#12 Password"}),e.jsx("input",{type:"password",value:u,onChange:a=>o(a.target.value),className:C.input,placeholder:"Enter PKCS#12 password"}),e.jsx("p",{className:C.helpText,children:"Required to decrypt PKCS#12 files"})]})]})})}const he="_tableContainer_2f75z_2",ue="_certNameCell_2f75z_45",pe="_certName_2f75z_45",me="_certSerial_2f75z_56",xe="_badgeType_2f75z_63",fe="_badgeInfo_2f75z_74",ge="_badgeNeutral_2f75z_79",je="_badgeStatus_2f75z_84",ye="_badgeSuccess_2f75z_95",ve="_badgeWarning_2f75z_100",_e="_badgeError_2f75z_105",be="_expiresCell_2f75z_111",Ce="_badgeDays_2f75z_117",ke="_actionsCell_2f75z_130",Ne="_actionBtn_2f75z_135",r={tableContainer:he,certNameCell:ue,certName:pe,certSerial:me,badgeType:xe,badgeInfo:fe,badgeNeutral:ge,badgeStatus:je,badgeSuccess:ye,badgeWarning:ve,badgeError:_e,expiresCell:be,badgeDays:Ce,actionsCell:ke,actionBtn:Ne};function Ge(){const[n,c]=g.useState("all"),[s,l]=g.useState("all"),[m,k]=g.useState("name"),[u,o]=g.useState(!1),[f,v]=g.useState(!1),{data:d,isLoading:j,error:a}=X(),{mutate:h}=Y(),y=i=>{window.confirm(`Revoke certificate ${i.name}?`)&&h({id:i.id,reason:"Revoked by administrator"},{onSuccess:()=>x.success(`Certificate ${i.name} revoked successfully`),onError:z=>x.error(`Failed to revoke certificate: ${z.message}`)})},I=()=>{const i=d?.data||[];if(i.length===0){x.error("No data to export");return}V(i,"certificates-export",{format:"csv",columns:["id","name","type","status","issuedBy","daysLeft","issued","expires"]}),x.success("Certificates exported successfully")},L=i=>{window.open(`/api/v2/certificates/${i.id}/download`,"_blank")},G=i=>i<=7?r.badgeError:i<=30?r.badgeWarning:r.badgeSuccess,$=i=>i==="CRITICAL"?r.badgeError:i==="EXPIRING SOON"?r.badgeWarning:r.badgeSuccess,K=i=>i==="Server"||i==="Client"?r.badgeInfo:r.badgeNeutral;if(j)return e.jsxs("div",{className:r.certificateList,children:[e.jsx(E,{icon:"ph ph-certificate",title:"Certificates",badge:e.jsx(p,{variant:"neutral",children:"Loading..."})}),Array.from({length:8}).map((i,z)=>e.jsx(U,{width:"100%",height:60,style:{marginBottom:"8px"}},z))]});if(a)return e.jsxs("div",{className:r.certificateList,children:[e.jsx(E,{icon:"ph ph-certificate",title:"Certificates",badge:e.jsx(p,{variant:"danger",children:"Error"})}),e.jsx(q,{error:a,shake:!0})]});if(a)return e.jsxs("div",{className:r.certificateList,children:[e.jsx(E,{icon:"ph ph-certificate",title:"Certificates",badge:e.jsx(p,{variant:"danger",children:"Error"})}),e.jsxs("div",{style:{padding:"2rem",textAlign:"center",color:"var(--color-danger)"},children:["Error loading certificates: ",a.message]})]});const F=d?.data||[],M=F.filter(i=>i.status==="ACTIVE").length;return e.jsxs("div",{className:r.certificateList,children:[e.jsx(E,{icon:"ph ph-certificate",title:"Certificates",badge:e.jsxs(p,{variant:"success",children:[M," Active"]}),actions:e.jsxs(e.Fragment,{children:[e.jsx(S,{icon:"ph ph-upload-simple",onClick:()=>v(!0),children:"Import"}),e.jsx(S,{icon:"ph ph-download-simple",onClick:I,children:"Export"}),e.jsx(S,{variant:"primary",icon:"ph ph-file-plus",onClick:()=>o(!0),children:"Issue Certificate"})]})}),e.jsxs(O,{children:[e.jsx(T,{label:"TYPE",children:e.jsxs(D,{children:[e.jsxs(_,{active:n==="all",onClick:()=>c("all"),children:["All ",e.jsx(p,{variant:"secondary",children:"(247)"})]}),e.jsxs(_,{active:n==="server",onClick:()=>c("server"),children:["Server ",e.jsx(p,{variant:"secondary",children:"(89)"})]}),e.jsxs(_,{active:n==="client",onClick:()=>c("client"),children:["Client ",e.jsx(p,{variant:"secondary",children:"(158)"})]}),e.jsxs(_,{active:n==="acme",onClick:()=>c("acme"),children:["ACME ",e.jsx(p,{variant:"secondary",children:"(34)"})]})]})}),e.jsx(T,{label:"STATUS",children:e.jsxs(D,{children:[e.jsxs(_,{active:s==="all",onClick:()=>l("all"),children:["All ",e.jsx(p,{variant:"secondary",children:"(247)"})]}),e.jsxs(_,{active:s==="active",onClick:()=>l("active"),children:["Active ",e.jsx(p,{variant:"secondary",children:"(235)"})]}),e.jsxs(_,{active:s==="expiring",onClick:()=>l("expiring"),children:["Expiring ",e.jsx(p,{variant:"secondary",children:"(12)"})]}),e.jsxs(_,{active:s==="expired",onClick:()=>l("expired"),children:["Expired ",e.jsx(p,{variant:"secondary",children:"(0)"})]}),e.jsxs(_,{active:s==="revoked",onClick:()=>l("revoked"),children:["Revoked ",e.jsx(p,{variant:"secondary",children:"(0)"})]})]})}),e.jsx(T,{label:"SORT",children:e.jsxs("select",{value:m,onChange:i=>k(i.target.value),children:[e.jsx("option",{value:"name",children:"Name"}),e.jsx("option",{value:"issued",children:"Issued"}),e.jsx("option",{value:"expires",children:"Expires"})]})})]}),e.jsx("div",{className:r.tableContainer,children:e.jsxs("table",{children:[e.jsx("thead",{children:e.jsxs("tr",{children:[e.jsx("th",{style:{width:"40%"},children:"CERTIFICATE"}),e.jsx("th",{style:{width:"10%"},children:"TYPE"}),e.jsx("th",{style:{width:"15%"},children:"ISSUER"}),e.jsx("th",{style:{width:"10%"},children:"STATUS"}),e.jsx("th",{style:{width:"10%"},children:"ISSUED"}),e.jsx("th",{style:{width:"10%"},children:"EXPIRES"}),e.jsx("th",{style:{width:"5%"},children:"ACTIONS"})]})}),e.jsx("tbody",{children:F.map(i=>e.jsxs("tr",{children:[e.jsx("td",{children:e.jsxs("div",{className:r.certNameCell,children:[e.jsx("span",{className:r.certName,children:i.name}),e.jsxs("span",{className:r.certSerial,children:["Serial: ",i.serial]})]})}),e.jsx("td",{children:e.jsx("span",{className:`${r.badgeType} ${K(i.type)}`,children:i.type})}),e.jsx("td",{children:i.issuer}),e.jsx("td",{children:e.jsx("span",{className:`${r.badgeStatus} ${$(i.status)}`,children:i.status})}),e.jsx("td",{children:i.issued}),e.jsx("td",{children:e.jsxs("div",{className:r.expiresCell,children:[e.jsx("span",{children:i.expires}),e.jsxs("span",{className:`${r.badgeDays} ${G(i.daysLeft)}`,children:[i.daysLeft," DAYS"]})]})}),e.jsx("td",{children:e.jsxs("div",{className:r.actionsCell,children:[e.jsx("button",{className:r.actionBtn,title:"Download",onClick:()=>L(i),children:e.jsx("i",{className:"ph ph-download-simple"})}),e.jsx("button",{className:r.actionBtn,title:"Revoke",onClick:()=>y(i),children:e.jsx("i",{className:"ph ph-x-circle"})}),e.jsx("button",{className:r.actionBtn,title:"More",children:e.jsx("i",{className:"ph ph-dots-three-outline-vertical"})})]})})]},i.id))})]})}),e.jsx(oe,{isOpen:u,onClose:()=>o(!1)}),e.jsx(de,{isOpen:f,onClose:()=>v(!1)})]})}export{Ge as CertificateList,Ge as default};

import{b as I,d as R,r as g,j as e,B as w,z as j}from"./index-BTw3bRnG.js";import{P as z}from"./PageTopBar-Cv7ANMVQ.js";import{F as O,a as A}from"./FiltersBar-BHC5nkyK.js";import{P,a as b}from"./PillFilter-8UWroSa8.js";import{B as x}from"./Badge-DyPH1hyB.js";import{a as U,E as q}from"./ErrorState-DioqpmvI.js";import{u as W}from"./useQuery-DLKUu21d.js";import{u as B}from"./useMutation-jqxeAUVx.js";import{M as L}from"./Modal-Ch2uiDvP.js";import{I as C}from"./Input-QlamGXjP.js";import{S as H}from"./SuccessAnimation-yb74rKAz.js";import{c as Q}from"./useCAs-b4wKvbRu.js";import{s as k,F as V}from"./ImportCAModal.module-DDYaQJpm.js";import{e as X}from"./export-BEFxFx9V.js";const F={getAll:async(n={})=>{const c=await I.get("/api/v2/certificates",{params:n}),d=(c.data||[]).map(l=>{const s=new Date(l.valid_to),h=Math.ceil((s-new Date)/(1e3*60*60*24));let m="ACTIVE";l.revoked?m="REVOKED":h<0?m="EXPIRED":h<=7?m="CRITICAL":h<=30&&(m="EXPIRING SOON");const y=l.subject?.match(/CN=([^,]+)/),u=y?y[1]:l.subject||"Unnamed Certificate",_=l.subject?.includes("Server")?"Server":"Client";return{id:l.id,name:u,serial:l.serial||"N/A",type:_,issuer:l.issuer||"Unknown",status:m,issued:l.valid_from?l.valid_from.split("T")[0]:"N/A",expires:l.valid_to?l.valid_to.split("T")[0]:"N/A",daysLeft:h>0?h:0,_raw:l}});return{data:d,meta:c.meta||{page:1,per_page:20,total:d.length}}},getById:async n=>(await I.get(`/api/v2/certificates/${n}`)).data,revoke:async(n,c)=>(await I.post(`/api/v2/certificates/${n}/revoke`,{reason:c})).data,renew:async n=>(await I.post(`/api/v2/certificates/${n}/renew`)).data,download:async(n,c="pem")=>await I.get(`/api/v2/certificates/${n}/download`,{params:{format:c},responseType:"blob"}),issue:async n=>(await I.post("/api/v2/certificates",n)).data},S={all:["certificates"],lists:()=>[...S.all,"list"],list:n=>[...S.lists(),n],details:()=>[...S.all,"detail"],detail:n=>[...S.details(),n]},Y=(n={})=>W({queryKey:S.list(n),queryFn:()=>F.getAll(n)}),J=()=>{const n=R();return B({mutationFn:({id:c,reason:d})=>F.revoke(c,d),onSuccess:()=>{n.invalidateQueries({queryKey:S.all})}})},Z=()=>{const n=R();return B({mutationFn:F.issue,onSuccess:()=>{n.invalidateQueries({queryKey:S.all})}})},ee="_form_pko5h_1",se="_section_pko5h_7",ae="_sectionTitle_pko5h_13",te="_fieldGroup_pko5h_22",ie="_fieldRow_pko5h_29",ne="_label_pko5h_35",le="_fieldHint_pko5h_43",re="_select_pko5h_49",ce="_checkboxGroup_pko5h_75",oe="_checkbox_pko5h_75",a={form:ee,section:se,sectionTitle:ae,fieldGroup:te,fieldRow:ie,label:ne,fieldHint:le,select:re,checkboxGroup:ce,checkbox:oe};function de({isOpen:n,onClose:c}){const[d,l]=g.useState(!1),[s,v]=g.useState({ca_id:"",common_name:"",organization:"",organizational_unit:"",country:"",state:"",locality:"",san:"",validity_days:"365",key_size:"2048",key_usage:["digitalSignature","keyEncipherment"]}),h=Z(),{data:m,isLoading:y}=Q(),u=m?.data||[];g.useEffect(()=>{u.length>0&&!s.ca_id&&v(t=>({...t,ca_id:u[0].id.toString()}))},[u,s.ca_id]);const _=t=>{if(t.preventDefault(),!s.ca_id){j.error("Please select a Certificate Authority");return}if(!s.common_name){j.error("Common Name is required");return}const f={ca_id:parseInt(s.ca_id),common_name:s.common_name,organization:s.organization,organizational_unit:s.organizational_unit,country:s.country,state:s.state,locality:s.locality,san:s.san,validity_days:parseInt(s.validity_days),key_size:parseInt(s.key_size),key_usage:s.key_usage};h.mutate(f,{onSuccess:()=>{l(!0),j.success("Certificate issued successfully"),setTimeout(()=>{c(),l(!1),E()},2e3)},onError:N=>{j.error(`Failed to issue certificate: ${N.message}`)}})},E=()=>{v({ca_id:u.length>0?u[0].id.toString():"",common_name:"",organization:"",organizational_unit:"",country:"",state:"",locality:"",san:"",validity_days:"365",key_size:"2048",key_usage:["digitalSignature","keyEncipherment"]})},o=(t,f)=>{v(N=>({...N,[t]:f}))},p=t=>{v(f=>({...f,key_usage:f.key_usage.includes(t)?f.key_usage.filter(N=>N!==t):[...f.key_usage,t]}))};return e.jsxs(L,{isOpen:n,onClose:c,title:"Issue Certificate",size:"lg",footer:e.jsxs(e.Fragment,{children:[e.jsx(w,{variant:"default",onClick:c,children:"Cancel"}),e.jsx(w,{variant:"primary",onClick:_,disabled:h.isPending,children:h.isPending?"Issuing...":"Issue Certificate"})]}),children:[e.jsxs("form",{className:a.form,onSubmit:_,children:[e.jsxs("div",{className:a.fieldGroup,children:[e.jsx("label",{className:a.label,children:"Certificate Authority *"}),e.jsx("select",{className:a.select,value:s.ca_id,onChange:t=>o("ca_id",t.target.value),disabled:y,children:y?e.jsx("option",{children:"Loading CAs..."}):u.length===0?e.jsx("option",{children:"No CAs available"}):u.map(t=>e.jsx("option",{value:t.id,children:t.name},t.id))})]}),e.jsxs("div",{className:a.section,children:[e.jsx("h3",{className:a.sectionTitle,children:"Subject Information"}),e.jsxs("div",{className:a.fieldGroup,children:[e.jsx("label",{className:a.label,children:"Common Name (CN) *"}),e.jsx(C,{value:s.common_name,onChange:t=>o("common_name",t.target.value),placeholder:"example.com",required:!0})]}),e.jsxs("div",{className:a.fieldRow,children:[e.jsxs("div",{className:a.fieldGroup,children:[e.jsx("label",{className:a.label,children:"Organization (O)"}),e.jsx(C,{value:s.organization,onChange:t=>o("organization",t.target.value),placeholder:"My Company"})]}),e.jsxs("div",{className:a.fieldGroup,children:[e.jsx("label",{className:a.label,children:"Organizational Unit (OU)"}),e.jsx(C,{value:s.organizational_unit,onChange:t=>o("organizational_unit",t.target.value),placeholder:"IT Department"})]})]}),e.jsxs("div",{className:a.fieldRow,children:[e.jsxs("div",{className:a.fieldGroup,children:[e.jsx("label",{className:a.label,children:"Country (C)"}),e.jsx(C,{value:s.country,onChange:t=>o("country",t.target.value),placeholder:"US",maxLength:2})]}),e.jsxs("div",{className:a.fieldGroup,children:[e.jsx("label",{className:a.label,children:"State/Province (ST)"}),e.jsx(C,{value:s.state,onChange:t=>o("state",t.target.value),placeholder:"California"})]}),e.jsxs("div",{className:a.fieldGroup,children:[e.jsx("label",{className:a.label,children:"City/Locality (L)"}),e.jsx(C,{value:s.locality,onChange:t=>o("locality",t.target.value),placeholder:"San Francisco"})]})]}),e.jsxs("div",{className:a.fieldGroup,children:[e.jsx("label",{className:a.label,children:"Subject Alternative Names (SAN)"}),e.jsx(C,{value:s.san,onChange:t=>o("san",t.target.value),placeholder:"DNS:example.com, DNS:*.example.com, IP:192.168.1.1"}),e.jsx("span",{className:a.fieldHint,children:"Comma-separated list (e.g., DNS:example.com, IP:192.168.1.1)"})]})]}),e.jsxs("div",{className:a.section,children:[e.jsx("h3",{className:a.sectionTitle,children:"Settings"}),e.jsxs("div",{className:a.fieldRow,children:[e.jsxs("div",{className:a.fieldGroup,children:[e.jsx("label",{className:a.label,children:"Validity (days)"}),e.jsx(C,{type:"number",value:s.validity_days,onChange:t=>o("validity_days",t.target.value),min:"1",max:"36500"})]}),e.jsxs("div",{className:a.fieldGroup,children:[e.jsx("label",{className:a.label,children:"Key Size (bits)"}),e.jsxs("select",{className:a.select,value:s.key_size,onChange:t=>o("key_size",t.target.value),children:[e.jsx("option",{value:"2048",children:"2048"}),e.jsx("option",{value:"4096",children:"4096"})]})]})]})]}),e.jsxs("div",{className:a.section,children:[e.jsx("h3",{className:a.sectionTitle,children:"Key Usage"}),e.jsxs("div",{className:a.checkboxGroup,children:[e.jsxs("label",{className:a.checkbox,children:[e.jsx("input",{type:"checkbox",checked:s.key_usage.includes("digitalSignature"),onChange:()=>p("digitalSignature")}),e.jsx("span",{children:"Digital Signature"})]}),e.jsxs("label",{className:a.checkbox,children:[e.jsx("input",{type:"checkbox",checked:s.key_usage.includes("keyEncipherment"),onChange:()=>p("keyEncipherment")}),e.jsx("span",{children:"Key Encipherment"})]}),e.jsxs("label",{className:a.checkbox,children:[e.jsx("input",{type:"checkbox",checked:s.key_usage.includes("dataEncipherment"),onChange:()=>p("dataEncipherment")}),e.jsx("span",{children:"Data Encipherment"})]}),e.jsxs("label",{className:a.checkbox,children:[e.jsx("input",{type:"checkbox",checked:s.key_usage.includes("keyAgreement"),onChange:()=>p("keyAgreement")}),e.jsx("span",{children:"Key Agreement"})]}),e.jsxs("label",{className:a.checkbox,children:[e.jsx("input",{type:"checkbox",checked:s.key_usage.includes("keyCertSign"),onChange:()=>p("keyCertSign")}),e.jsx("span",{children:"Certificate Signing"})]}),e.jsxs("label",{className:a.checkbox,children:[e.jsx("input",{type:"checkbox",checked:s.key_usage.includes("crlSign"),onChange:()=>p("crlSign")}),e.jsx("span",{children:"CRL Signing"})]})]})]})]}),d&&e.jsx(H,{message:"Certificate Issued!",onComplete:()=>l(!1)})]})}function he({isOpen:n,onClose:c}){const[d,l]=g.useState(null),[s,v]=g.useState("pem"),[h,m]=g.useState(""),[y,u]=g.useState(!1),_=async o=>{if(o.preventDefault(),!d){j.error("Please select a file to import");return}if(s==="pkcs12"&&!h){j.error("Password is required for PKCS#12 files");return}u(!0);try{const p=new FormData;p.append("file",d),p.append("format",s),h&&p.append("password",h);const t=await fetch("/api/v2/certificates/import",{method:"POST",body:p});if(!t.ok){const f=await t.json();throw new Error(f.message||"Failed to import certificate")}j.success("Certificate imported successfully"),c(),l(null),m(""),v("pem"),window.location.reload()}catch(p){j.error(p.message||"Failed to import certificate")}finally{u(!1)}},E=e.jsxs(e.Fragment,{children:[e.jsx(w,{variant:"secondary",onClick:c,disabled:y,children:"Cancel"}),e.jsx(w,{variant:"primary",onClick:_,disabled:y,children:y?"Importing...":"Import Certificate"})]});return e.jsx(L,{isOpen:n,onClose:c,title:"Import Certificate",size:"md",footer:E,children:e.jsxs("form",{onSubmit:_,className:k.form,children:[e.jsxs("div",{className:k.section,children:[e.jsx("label",{className:k.label,children:"Certificate Format"}),e.jsxs("select",{value:s,onChange:o=>v(o.target.value),className:k.select,children:[e.jsx("option",{value:"pem",children:"PEM (Base64 encoded)"}),e.jsx("option",{value:"der",children:"DER (Binary)"}),e.jsx("option",{value:"pkcs12",children:"PKCS#12 (.p12, .pfx)"})]})]}),e.jsx(V,{file:d,onFileChange:l,accept:".pem,.crt,.cer,.der,.p12,.pfx",maxSize:10*1024*1024}),s==="pkcs12"&&e.jsxs("div",{className:k.section,children:[e.jsx("label",{className:k.label,children:"PKCS#12 Password"}),e.jsx("input",{type:"password",value:h,onChange:o=>m(o.target.value),className:k.input,placeholder:"Enter PKCS#12 password"}),e.jsx("p",{className:k.helpText,children:"Required to decrypt PKCS#12 files"})]})]})})}const ue="_tableContainer_2f75z_2",pe="_certNameCell_2f75z_45",me="_certName_2f75z_45",xe="_certSerial_2f75z_56",fe="_badgeType_2f75z_63",ge="_badgeInfo_2f75z_74",je="_badgeNeutral_2f75z_79",ye="_badgeStatus_2f75z_84",ve="_badgeSuccess_2f75z_95",_e="_badgeWarning_2f75z_100",be="_badgeError_2f75z_105",Ce="_expiresCell_2f75z_111",ke="_badgeDays_2f75z_117",Ne="_actionsCell_2f75z_130",Se="_actionBtn_2f75z_135",r={tableContainer:ue,certNameCell:pe,certName:me,certSerial:xe,badgeType:fe,badgeInfo:ge,badgeNeutral:je,badgeStatus:ye,badgeSuccess:ve,badgeWarning:_e,badgeError:be,expiresCell:Ce,badgeDays:ke,actionsCell:Ne,actionBtn:Se};function Ke(){const[n,c]=g.useState("all"),[d,l]=g.useState("all"),[s,v]=g.useState("name"),[h,m]=g.useState(!1),[y,u]=g.useState(!1),{data:_,isLoading:E,error:o}=Y(),{mutate:p}=J(),t=i=>{window.confirm(`Revoke certificate ${i.name}?`)&&p({id:i.id,reason:"Revoked by administrator"},{onSuccess:()=>j.success(`Certificate ${i.name} revoked successfully`),onError:T=>j.error(`Failed to revoke certificate: ${T.message}`)})},f=()=>{const i=_?.data||[];if(i.length===0){j.error("No data to export");return}X(i,"certificates-export",{format:"csv",columns:["id","name","type","status","issuedBy","daysLeft","issued","expires"]}),j.success("Certificates exported successfully")},N=i=>{window.open(`/api/v2/certificates/${i.id}/download`,"_blank")},G=i=>i<=7?r.badgeError:i<=30?r.badgeWarning:r.badgeSuccess,$=i=>i==="CRITICAL"?r.badgeError:i==="EXPIRING SOON"?r.badgeWarning:r.badgeSuccess,K=i=>i==="Server"||i==="Client"?r.badgeInfo:r.badgeNeutral;if(E)return e.jsxs("div",{className:r.certificateList,children:[e.jsx(z,{icon:"ph ph-certificate",title:"Certificates",badge:e.jsx(x,{variant:"neutral",children:"Loading..."})}),Array.from({length:8}).map((i,T)=>e.jsx(U,{width:"100%",height:60,style:{marginBottom:"8px"}},T))]});if(o)return e.jsxs("div",{className:r.certificateList,children:[e.jsx(z,{icon:"ph ph-certificate",title:"Certificates",badge:e.jsx(x,{variant:"danger",children:"Error"})}),e.jsx(q,{error:o,shake:!0})]});if(o)return e.jsxs("div",{className:r.certificateList,children:[e.jsx(z,{icon:"ph ph-certificate",title:"Certificates",badge:e.jsx(x,{variant:"danger",children:"Error"})}),e.jsxs("div",{style:{padding:"2rem",textAlign:"center",color:"var(--color-danger)"},children:["Error loading certificates: ",o.message]})]});const D=_?.data||[],M=D.filter(i=>i.status==="ACTIVE").length;return e.jsxs("div",{className:r.certificateList,children:[e.jsx(z,{icon:"ph ph-certificate",title:"Certificates",badge:e.jsxs(x,{variant:"success",children:[M," Active"]}),actions:e.jsxs(e.Fragment,{children:[e.jsx(w,{icon:"ph ph-upload-simple",onClick:()=>u(!0),children:"Import"}),e.jsx(w,{icon:"ph ph-download-simple",onClick:f,children:"Export"}),e.jsx(w,{variant:"primary",icon:"ph ph-file-plus",onClick:()=>m(!0),children:"Issue Certificate"})]})}),e.jsxs(O,{children:[e.jsx(A,{label:"TYPE",children:e.jsxs(P,{children:[e.jsxs(b,{active:n==="all",onClick:()=>c("all"),children:["All ",e.jsx(x,{variant:"secondary",children:"(247)"})]}),e.jsxs(b,{active:n==="server",onClick:()=>c("server"),children:["Server ",e.jsx(x,{variant:"secondary",children:"(89)"})]}),e.jsxs(b,{active:n==="client",onClick:()=>c("client"),children:["Client ",e.jsx(x,{variant:"secondary",children:"(158)"})]}),e.jsxs(b,{active:n==="acme",onClick:()=>c("acme"),children:["ACME ",e.jsx(x,{variant:"secondary",children:"(34)"})]})]})}),e.jsx(A,{label:"STATUS",children:e.jsxs(P,{children:[e.jsxs(b,{active:d==="all",onClick:()=>l("all"),children:["All ",e.jsx(x,{variant:"secondary",children:"(247)"})]}),e.jsxs(b,{active:d==="active",onClick:()=>l("active"),children:["Active ",e.jsx(x,{variant:"secondary",children:"(235)"})]}),e.jsxs(b,{active:d==="expiring",onClick:()=>l("expiring"),children:["Expiring ",e.jsx(x,{variant:"secondary",children:"(12)"})]}),e.jsxs(b,{active:d==="expired",onClick:()=>l("expired"),children:["Expired ",e.jsx(x,{variant:"secondary",children:"(0)"})]}),e.jsxs(b,{active:d==="revoked",onClick:()=>l("revoked"),children:["Revoked ",e.jsx(x,{variant:"secondary",children:"(0)"})]})]})}),e.jsx(A,{label:"SORT",children:e.jsxs("select",{value:s,onChange:i=>v(i.target.value),children:[e.jsx("option",{value:"name",children:"Name"}),e.jsx("option",{value:"issued",children:"Issued"}),e.jsx("option",{value:"expires",children:"Expires"})]})})]}),e.jsx("div",{className:r.tableContainer,children:e.jsxs("table",{children:[e.jsx("thead",{children:e.jsxs("tr",{children:[e.jsx("th",{style:{width:"40%"},children:"CERTIFICATE"}),e.jsx("th",{style:{width:"10%"},children:"TYPE"}),e.jsx("th",{style:{width:"15%"},children:"ISSUER"}),e.jsx("th",{style:{width:"10%"},children:"STATUS"}),e.jsx("th",{style:{width:"10%"},children:"ISSUED"}),e.jsx("th",{style:{width:"10%"},children:"EXPIRES"}),e.jsx("th",{style:{width:"5%"},children:"ACTIONS"})]})}),e.jsx("tbody",{children:D.map(i=>e.jsxs("tr",{children:[e.jsx("td",{children:e.jsxs("div",{className:r.certNameCell,children:[e.jsx("span",{className:r.certName,children:i.name}),e.jsxs("span",{className:r.certSerial,children:["Serial: ",i.serial]})]})}),e.jsx("td",{children:e.jsx("span",{className:`${r.badgeType} ${K(i.type)}`,children:i.type})}),e.jsx("td",{children:i.issuer}),e.jsx("td",{children:e.jsx("span",{className:`${r.badgeStatus} ${$(i.status)}`,children:i.status})}),e.jsx("td",{children:i.issued}),e.jsx("td",{children:e.jsxs("div",{className:r.expiresCell,children:[e.jsx("span",{children:i.expires}),e.jsxs("span",{className:`${r.badgeDays} ${G(i.daysLeft)}`,children:[i.daysLeft," DAYS"]})]})}),e.jsx("td",{children:e.jsxs("div",{className:r.actionsCell,children:[e.jsx("button",{className:r.actionBtn,title:"Download",onClick:()=>N(i),children:e.jsx("i",{className:"ph ph-download-simple"})}),e.jsx("button",{className:r.actionBtn,title:"Revoke",onClick:()=>t(i),children:e.jsx("i",{className:"ph ph-x-circle"})}),e.jsx("button",{className:r.actionBtn,title:"More",children:e.jsx("i",{className:"ph ph-dots-three-outline-vertical"})})]})})]},i.id))})]})}),e.jsx(de,{isOpen:h,onClose:()=>m(!1)}),e.jsx(he,{isOpen:y,onClose:()=>u(!1)})]})}export{Ke as CertificateList,Ke as default};

import{a as V,r as b,j as e,B as y,z as p}from"./index-B1lIGfJA.js";import{P as M}from"./PageTopBar-C_cIABUM.js";import{S as G,a as T}from"./StatsGrid-htYRFFuc.js";import{S as J,T as _}from"./SectionTabs-BQniy51T.js";import{D as O}from"./DataTable-DDmfP4Q6.js";import{S as X}from"./SearchToolbar-DZPwseVo.js";import{B as C}from"./Badge-i8Sa-u3P.js";import{g as D}from"./getBadgeVariant-BF98r0-3.js";import{u as E}from"./useQuery-EiOOdz9l.js";import{u as Y}from"./useMutation-DVmYuee3.js";import{a as A}from"./api-ClVrI7m4.js";import{M as L}from"./Modal-BvRL6OD9.js";import{I as q}from"./Input-D092IEEc.js";import{s as n}from"./CreateCAModal.module-DdQgTClK.js";const S={getSettings:async()=>(await A.get("/api/v2/acme/settings")).data,updateSettings:async a=>(await A.patch("/api/v2/acme/settings",a)).data,getStats:async()=>{const r=(await A.get("/api/v2/acme/stats")).data||{};return{accounts:r.active_accounts||0,activeOrders:r.pending_orders||0,completedOrders:r.valid_orders||0,domains:0,_raw:r}},getAccounts:async(a={})=>{const r=await A.get("/api/v2/acme/accounts",{params:a}),s=(r.data||[]).map(t=>({id:t.id,email:t.email||t.contact_email||"N/A",status:(t.status||"ACTIVE").toUpperCase(),createdAt:t.created_at?t.created_at.split("T")[0]:"N/A",orders:t.total_orders||0,_raw:t}));return{data:s,meta:r.meta||{page:1,per_page:20,total:s.length}}},getOrders:async(a={})=>{const r=await A.get("/api/v2/acme/orders",{params:a}),s=(r.data||[]).map(t=>({id:t.id,domain:t.domain||t.identifier||"N/A",account:t.account_email||t.account_id||"N/A",status:(t.status||"PENDING").toUpperCase(),createdAt:t.created_at?t.created_at.split("T")[0]:"N/A",expiresAt:t.expires_at?t.expires_at.split("T")[0]:"N/A",_raw:t}));return{data:s,meta:r.meta||{page:1,per_page:20,total:s.length}}}},h={all:["acme"],settings:()=>[...h.all,"settings"],stats:()=>[...h.all,"stats"],accounts:a=>[...h.all,"accounts",a],orders:a=>[...h.all,"orders",a]},Z=()=>E({queryKey:h.settings(),queryFn:S.getSettings}),$=()=>E({queryKey:h.stats(),queryFn:S.getStats}),W=(a={})=>E({queryKey:h.accounts(a),queryFn:()=>S.getAccounts(a)}),ee=(a={})=>E({queryKey:h.orders(a),queryFn:()=>S.getOrders(a)}),te=()=>{const a=V();return Y({mutationFn:S.updateSettings,onSuccess:()=>{a.invalidateQueries({queryKey:h.settings()})}})};function se({isOpen:a,onClose:r}){const[s,t]=b.useState({email:"",provider:"letsencrypt",termsAccepted:!1}),[m,g]=b.useState(!1),i=async d=>{if(d.preventDefault(),!s.email){p.error("Email is required");return}if(!s.termsAccepted){p.error("You must accept the terms of service");return}g(!0);try{const c=await fetch("/api/v2/acme/accounts",{method:"POST",headers:{"Content-Type":"application/json"},body:JSON.stringify({email:s.email,provider:s.provider,terms_accepted:s.termsAccepted})});if(!c.ok){const l=await c.json();throw new Error(l.message||"Failed to create ACME account")}p.success("ACME account created successfully"),r(),t({email:"",provider:"letsencrypt",termsAccepted:!1}),window.location.reload()}catch(c){p.error(c.message||"Failed to create ACME account")}finally{g(!1)}},x=d=>{const{name:c,value:l,type:f,checked:N}=d.target;t(k=>({...k,[c]:f==="checkbox"?N:l}))},v=e.jsxs(e.Fragment,{children:[e.jsx(y,{variant:"secondary",onClick:r,disabled:m,children:"Cancel"}),e.jsx(y,{variant:"primary",onClick:i,disabled:m,children:m?"Creating...":"Create Account"})]});return e.jsx(L,{isOpen:a,onClose:r,title:"New ACME Account",size:"sm",footer:v,children:e.jsx("form",{onSubmit:i,className:n.form,children:e.jsxs("div",{className:n.section,children:[e.jsxs("div",{className:n.field,children:[e.jsx("label",{className:n.label,children:"Provider"}),e.jsxs("select",{name:"provider",value:s.provider,onChange:x,className:n.select,children:[e.jsx("option",{value:"letsencrypt",children:"Let's Encrypt"}),e.jsx("option",{value:"letsencrypt-staging",children:"Let's Encrypt (Staging)"}),e.jsx("option",{value:"buypass",children:"Buypass"}),e.jsx("option",{value:"zerossl",children:"ZeroSSL"})]}),e.jsx("p",{className:n.helpText,children:"Let's Encrypt is recommended for production use"})]}),e.jsx(q,{label:"Email Address",name:"email",type:"email",value:s.email,onChange:x,placeholder:"admin@example.com",required:!0,helpText:"Used for certificate expiry notifications and account recovery"}),e.jsx("div",{className:n.field,children:e.jsxs("label",{className:n.checkboxLabel,children:[e.jsx("input",{type:"checkbox",name:"termsAccepted",checked:s.termsAccepted,onChange:x,className:n.checkbox}),e.jsxs("span",{children:["I agree to the"," ",e.jsx("a",{href:s.provider==="letsencrypt"?"https://letsencrypt.org/repository/":"#",target:"_blank",rel:"noopener noreferrer",className:n.link,children:s.provider==="letsencrypt"?"Let's Encrypt Subscriber Agreement":"Terms of Service"})]})]})})]})})})}function ae({isOpen:a,onClose:r}){const[s,t]=b.useState({domains:"",challengeType:"http-01"}),[m,g]=b.useState(!1),i=async d=>{if(d.preventDefault(),!s.domains.trim()){p.error("At least one domain is required");return}const c=s.domains.split(",").map(l=>l.trim()).filter(Boolean);if(c.length===0){p.error("Please enter valid domains");return}g(!0);try{const l=await fetch("/api/v2/acme/orders",{method:"POST",headers:{"Content-Type":"application/json"},body:JSON.stringify({domains:c,challenge_type:s.challengeType})});if(!l.ok){const f=await l.json();throw new Error(f.message||"Failed to create ACME order")}p.success("ACME order created successfully"),r(),t({domains:"",challengeType:"http-01"}),window.location.reload()}catch(l){p.error(l.message||"Failed to create ACME order")}finally{g(!1)}},x=d=>{t(c=>({...c,[d.target.name]:d.target.value}))},v=e.jsxs(e.Fragment,{children:[e.jsx(y,{variant:"secondary",onClick:r,disabled:m,children:"Cancel"}),e.jsx(y,{variant:"primary",onClick:i,disabled:m,children:m?"Creating...":"Create Order"})]});return e.jsx(L,{isOpen:a,onClose:r,title:"New ACME Order",size:"md",footer:v,children:e.jsxs("form",{onSubmit:i,className:n.form,children:[e.jsxs("div",{className:n.section,children:[e.jsx(q,{label:"Domains",name:"domains",value:s.domains,onChange:x,placeholder:"example.com, www.example.com, *.example.com",required:!0,helpText:"Comma-separated list of domains to include in the certificate"}),e.jsxs("div",{className:n.field,children:[e.jsx("label",{className:n.label,children:"Challenge Type"}),e.jsxs("select",{name:"challengeType",value:s.challengeType,onChange:x,className:n.select,children:[e.jsx("option",{value:"http-01",children:"HTTP-01 (Port 80)"}),e.jsx("option",{value:"dns-01",children:"DNS-01 (DNS TXT Record)"}),e.jsx("option",{value:"tls-alpn-01",children:"TLS-ALPN-01 (Port 443)"})]}),e.jsxs("p",{className:n.helpText,children:[s.challengeType==="http-01"&&"Requires HTTP server on port 80. Best for single domains.",s.challengeType==="dns-01"&&"Requires DNS access. Required for wildcard certificates.",s.challengeType==="tls-alpn-01"&&"Requires TLS server on port 443. Alternative to HTTP-01."]})]})]}),e.jsxs("div",{className:n.infoBox,children:[e.jsx("i",{className:"ph ph-info"}),e.jsxs("div",{children:[e.jsx("strong",{children:"Next Steps:"}),e.jsxs("ol",{style:{marginTop:"8px",paddingLeft:"20px"},children:[e.jsx("li",{children:"Order will be created and authorizations started"}),e.jsxs("li",{children:["Complete the ",s.challengeType.toUpperCase()," challenge for each domain"]}),e.jsx("li",{children:"Certificate will be issued automatically upon validation"})]})]})]})]})})}const re="_acmeDashboard_k0xpk_3",ne="_tabContent_k0xpk_8",oe="_section_k0xpk_14",ce="_sectionTitle_k0xpk_20",u={acmeDashboard:re,tabContent:ne,section:oe,sectionTitle:ce};function Ce(){const[a,r]=b.useState("internal"),[s,t]=b.useState(!1),[m,g]=b.useState(!1),{data:i,isLoading:x,error:v}=Z(),{data:d,isLoading:c,error:l}=$(),{data:f,isLoading:N,error:k}=W(),{data:F,isLoading:P,error:R}=ee(),B=te(),I=x||c||N||P,w=v||l||k||R,z=[{key:"email",label:"Email",sortable:!0},{key:"status",label:"Status",sortable:!0,render:o=>e.jsx(C,{variant:D("acme-status",o.status),children:o.status})},{key:"createdAt",label:"Created At",sortable:!0},{key:"orders",label:"Orders",sortable:!0,render:o=>e.jsx("span",{style:{color:"var(--text-tertiary)"},children:o.orders})}],K=[{key:"domain",label:"Domain",sortable:!0},{key:"account",label:"Account",sortable:!0},{key:"status",label:"Status",sortable:!0,render:o=>e.jsx(C,{variant:D("acme-status",o.status),children:o.status})},{key:"createdAt",label:"Created",sortable:!0},{key:"expiresAt",label:"Expires",sortable:!0}],U=[{label:"Status",options:["All Statuses","Valid","Pending","Invalid"]}];if(I)return e.jsxs("div",{className:u.acmeDashboard,children:[e.jsx(M,{icon:"ph ph-globe",title:"ACME",badge:e.jsx(C,{variant:"neutral",children:"Loading..."})}),e.jsx("div",{style:{padding:"2rem",textAlign:"center"},children:"Loading ACME data..."})]});if(w)return e.jsxs("div",{className:u.acmeDashboard,children:[e.jsx(M,{icon:"ph ph-globe",title:"ACME",badge:e.jsx(C,{variant:"danger",children:"Error"})}),e.jsxs("div",{style:{padding:"2rem",textAlign:"center",color:"var(--color-danger)"},children:["Error loading ACME data: ",w.message]})]});const j={stats:d||{accounts:0,activeOrders:0,completedOrders:0,domains:0},accounts:f?.data||[],orders:F?.data||[]},H=()=>e.jsxs("div",{className:u.tabContent,children:[e.jsxs(G,{columns:4,children:[e.jsx(T,{value:j.stats.accounts,label:"Accounts",icon:"ph ph-user"}),e.jsx(T,{value:j.stats.activeOrders,label:"Active Orders",icon:"ph ph-clock"}),e.jsx(T,{value:j.stats.completedOrders,label:"Completed Orders",icon:"ph ph-check-circle"}),e.jsx(T,{value:j.stats.domains,label:"Domains",icon:"ph ph-globe"})]}),e.jsxs("div",{className:u.section,children:[e.jsx("h3",{className:u.sectionTitle,children:"Accounts"}),e.jsx(X,{placeholder:"Search accounts...",filters:U,onSearch:o=>console.log("Search:",o),onFilterChange:(o,Q)=>console.log("Filter:",o,Q)}),e.jsx(O,{columns:z,data:j.accounts,onRowClick:o=>console.log("Account clicked:",o)})]}),e.jsxs("div",{className:u.section,children:[e.jsx("h3",{className:u.sectionTitle,children:"Recent Orders"}),e.jsx(O,{columns:K,data:j.orders,onRowClick:o=>console.log("Order clicked:",o)})]})]});return e.jsxs("div",{className:u.acmeDashboard,children:[e.jsx(M,{icon:"ph ph-globe",title:"ACME",badge:e.jsx(C,{variant:i?.enabled?"success":"secondary",children:i?.enabled?"Enabled":"Disabled"}),actions:e.jsxs(e.Fragment,{children:[e.jsx(y,{onClick:()=>t(!0),icon:"ph ph-plus",children:"New Account"}),e.jsx(y,{onClick:()=>g(!0),icon:"ph ph-certificate",children:"New Order"}),e.jsxs(y,{variant:i?.enabled?"secondary":"primary",onClick:()=>{B.mutate({enabled:!i?.enabled},{onSuccess:()=>p.success(i?.enabled?"ACME disabled":"ACME enabled"),onError:()=>p.error("Failed to update ACME")})},children:[i?.enabled?"Disable":"Enable"," ACME"]})]})}),e.jsxs(J,{children:[e.jsx(_,{active:a==="internal",onClick:()=>r("internal"),children:"Internal ACME"}),e.jsx(_,{active:a==="letsencrypt",onClick:()=>r("letsencrypt"),children:"Let's Encrypt"})]}),e.jsx("div",{className:u.tabContent,children:H()}),e.jsx(se,{isOpen:s,onClose:()=>t(!1)}),e.jsx(ae,{isOpen:m,onClose:()=>g(!1)})]})}export{Ce as ACMEDashboard,Ce as default};

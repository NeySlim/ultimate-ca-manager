import{r as g,j as e,B as f,z as c,b as j,d as A}from"./index-BArQLPjh.js";import{D as te}from"./DataTable-CA2yhyjs.js";import{B as D}from"./Badge-srr-GGeK.js";import{P as q}from"./PageTopBar--IXq1A98.js";import{P as B,a as C}from"./PillFilter-C941r9Yt.js";import{e as ie}from"./export-BEFxFx9V.js";import{M as N}from"./Modal-Dg1C_Qou.js";import{I as U}from"./Input-7QoEBxGh.js";import{s as o}from"./CreateCAModal.module-BDqPs05w.js";import{u as ne}from"./useQuery-sbIOkzkR.js";import{u as _}from"./useMutation-CXWK1Dp7.js";function oe({isOpen:r,onClose:i}){const[a,n]=g.useState({username:"",password:"",confirmPassword:"",email:"",fullName:"",role:"operator",permissions:{manageCAs:!1,issueCertificates:!0,revokeCertificates:!1,manageUsers:!1,viewLogs:!0,manageSettings:!1}}),[m,h]=g.useState(!1),k=async p=>{if(p.preventDefault(),!a.username||!a.password){c.error("Username and password are required");return}if(a.password!==a.confirmPassword){c.error("Passwords do not match");return}if(a.password.length<8){c.error("Password must be at least 8 characters");return}h(!0);try{const u=await fetch("/api/v2/users",{method:"POST",headers:{"Content-Type":"application/json"},body:JSON.stringify({username:a.username,password:a.password,email:a.email,full_name:a.fullName,role:a.role,permissions:a.permissions})});if(!u.ok){const x=await u.json();throw new Error(x.message||"Failed to create user")}c.success("User created successfully"),i(),n({username:"",password:"",confirmPassword:"",email:"",fullName:"",role:"operator",permissions:{manageCAs:!1,issueCertificates:!0,revokeCertificates:!1,manageUsers:!1,viewLogs:!0,manageSettings:!1}}),window.location.reload()}catch(u){c.error(u.message||"Failed to create user")}finally{h(!1)}},d=p=>{n(u=>({...u,[p.target.name]:p.target.value}))},v=p=>{n(u=>({...u,permissions:{...u.permissions,[p]:!u.permissions[p]}}))},P=p=>{const u=p.target.value;let x={...a.permissions};u==="admin"?x={manageCAs:!0,issueCertificates:!0,revokeCertificates:!0,manageUsers:!0,viewLogs:!0,manageSettings:!0}:u==="operator"?x={manageCAs:!1,issueCertificates:!0,revokeCertificates:!1,manageUsers:!1,viewLogs:!0,manageSettings:!1}:u==="viewer"&&(x={manageCAs:!1,issueCertificates:!1,revokeCertificates:!1,manageUsers:!1,viewLogs:!0,manageSettings:!1}),n(z=>({...z,role:u,permissions:x}))},E=e.jsxs(e.Fragment,{children:[e.jsx(f,{variant:"secondary",onClick:i,disabled:m,children:"Cancel"}),e.jsx(f,{variant:"primary",onClick:k,disabled:m,children:m?"Creating...":"Create User"})]});return e.jsx(N,{isOpen:r,onClose:i,title:"Create User",size:"md",footer:E,children:e.jsxs("form",{onSubmit:k,className:o.form,children:[e.jsxs("div",{className:o.section,children:[e.jsx("h3",{className:o.sectionTitle,children:"Account Information"}),e.jsx(U,{label:"Username",name:"username",value:a.username,onChange:d,placeholder:"john.doe",required:!0}),e.jsx(U,{label:"Full Name",name:"fullName",value:a.fullName,onChange:d,placeholder:"John Doe"}),e.jsx(U,{label:"Email Address",name:"email",type:"email",value:a.email,onChange:d,placeholder:"john.doe@example.com"})]}),e.jsxs("div",{className:o.section,children:[e.jsx("h3",{className:o.sectionTitle,children:"Security"}),e.jsx(U,{label:"Password",name:"password",type:"password",value:a.password,onChange:d,placeholder:"••••••••",required:!0,helpText:"Minimum 8 characters"}),e.jsx(U,{label:"Confirm Password",name:"confirmPassword",type:"password",value:a.confirmPassword,onChange:d,placeholder:"••••••••",required:!0})]}),e.jsxs("div",{className:o.section,children:[e.jsx("h3",{className:o.sectionTitle,children:"Role & Permissions"}),e.jsxs("div",{className:o.field,children:[e.jsx("label",{className:o.label,children:"Role"}),e.jsxs("select",{name:"role",value:a.role,onChange:P,className:o.select,children:[e.jsx("option",{value:"admin",children:"Administrator"}),e.jsx("option",{value:"operator",children:"Operator"}),e.jsx("option",{value:"viewer",children:"Viewer"})]}),e.jsxs("p",{className:o.helpText,children:[a.role==="admin"&&"Full access to all features",a.role==="operator"&&"Can issue and manage certificates",a.role==="viewer"&&"Read-only access"]})]}),e.jsxs("div",{className:o.permissionsGrid,children:[e.jsxs("label",{className:o.checkboxLabel,children:[e.jsx("input",{type:"checkbox",checked:a.permissions.manageCAs,onChange:()=>v("manageCAs"),className:o.checkbox}),e.jsx("span",{children:"Manage CAs"})]}),e.jsxs("label",{className:o.checkboxLabel,children:[e.jsx("input",{type:"checkbox",checked:a.permissions.issueCertificates,onChange:()=>v("issueCertificates"),className:o.checkbox}),e.jsx("span",{children:"Issue Certificates"})]}),e.jsxs("label",{className:o.checkboxLabel,children:[e.jsx("input",{type:"checkbox",checked:a.permissions.revokeCertificates,onChange:()=>v("revokeCertificates"),className:o.checkbox}),e.jsx("span",{children:"Revoke Certificates"})]}),e.jsxs("label",{className:o.checkboxLabel,children:[e.jsx("input",{type:"checkbox",checked:a.permissions.manageUsers,onChange:()=>v("manageUsers"),className:o.checkbox}),e.jsx("span",{children:"Manage Users"})]}),e.jsxs("label",{className:o.checkboxLabel,children:[e.jsx("input",{type:"checkbox",checked:a.permissions.viewLogs,onChange:()=>v("viewLogs"),className:o.checkbox}),e.jsx("span",{children:"View Logs"})]}),e.jsxs("label",{className:o.checkboxLabel,children:[e.jsx("input",{type:"checkbox",checked:a.permissions.manageSettings,onChange:()=>v("manageSettings"),className:o.checkbox}),e.jsx("span",{children:"Manage Settings"})]})]})]})]})})}const S={getUsers:async(r={})=>(await j.get("/api/v2/users",{params:r})).data,createUser:async r=>(await j.post("/api/v2/users",r)).data,updateUser:async({id:r,...i})=>(await j.put(`/api/v2/users/${r}`,i)).data,resetPassword:async(r,i)=>(await j.post(`/api/v2/users/${r}/reset-password`,{new_password:i})).data,toggleStatus:async r=>(await j.patch(`/api/v2/users/${r}/toggle`)).data,deleteUser:async r=>(await j.delete(`/api/v2/users/${r}`)).data,importUsers:async r=>{const i=new FormData;return i.append("file",r),(await j.post("/api/v2/users/import",i,{headers:{"Content-Type":"multipart/form-data"}})).data}},b={all:["users"],lists:()=>[...b.all,"list"],list:r=>[...b.lists(),r]},le=(r={})=>ne({queryKey:b.list(r),queryFn:()=>S.getUsers(r)}),ce=()=>{const r=A();return _({mutationFn:S.updateUser,onSuccess:()=>{r.invalidateQueries({queryKey:b.all}),c.success("User updated successfully")},onError:i=>{c.error(i.response?.data?.message||"Failed to update user")}})},de=()=>{const r=A();return _({mutationFn:S.deleteUser,onSuccess:()=>{r.invalidateQueries({queryKey:b.all}),c.success("User deleted successfully")},onError:i=>{c.error(i.response?.data?.message||"Failed to delete user")}})},ue=()=>{const r=A();return _({mutationFn:S.importUsers,onSuccess:i=>{r.invalidateQueries({queryKey:b.all});const{imported:a=0,skipped:n=0}=i;c.success(`Imported ${a} users, skipped ${n}`)},onError:i=>{c.error(i.response?.data?.message||"Failed to import users")}})},pe=()=>{const r=A();return _({mutationFn:({userId:i,newPassword:a})=>S.resetPassword(i,a),onSuccess:()=>{r.invalidateQueries({queryKey:b.all}),c.success("Password reset successfully")},onError:i=>{c.error(i.response?.data?.message||"Failed to reset password")}})},me=()=>{const r=A();return _({mutationFn:S.toggleStatus,onSuccess:()=>{r.invalidateQueries({queryKey:b.all}),c.success("User status updated successfully")},onError:i=>{c.error(i.response?.data?.message||"Failed to toggle user status")}})};function he({isOpen:r,onClose:i,user:a}){const[n,m]=g.useState({email:"",fullName:"",role:"operator",active:!0}),h=ce();if(g.useEffect(()=>{a&&m({email:a.email||"",fullName:a.name||"",role:a.role?.toLowerCase()||"operator",active:a.status==="Active"})},[a]),!a)return null;const k=async d=>{if(d.preventDefault(),!n.email){c.error("Email is required");return}h.mutate({id:a.id,email:n.email,full_name:n.fullName,role:n.role,active:n.active},{onSuccess:()=>{i()}})};return e.jsxs(N,{isOpen:r,onClose:i,size:"medium",children:[e.jsxs(N.Header,{children:[e.jsx("i",{className:"ph ph-pencil-simple",style:{marginRight:"8px"}}),"Edit User: ",a.name]}),e.jsxs("form",{onSubmit:k,children:[e.jsx(N.Body,{children:e.jsxs("div",{style:{display:"flex",flexDirection:"column",gap:"16px"},children:[e.jsxs("div",{children:[e.jsx("label",{style:{display:"block",fontSize:"13px",fontWeight:500,color:"var(--text-primary)",marginBottom:"6px"},children:"Username"}),e.jsx("input",{type:"text",value:a.name,readOnly:!0,disabled:!0,style:{width:"100%",padding:"8px 12px",fontSize:"13px",border:"1px solid var(--border-primary)",borderRadius:"var(--radius)",background:"var(--bg-tertiary)",color:"var(--text-tertiary)",cursor:"not-allowed"}})]}),e.jsxs("div",{children:[e.jsxs("label",{style:{display:"block",fontSize:"13px",fontWeight:500,color:"var(--text-primary)",marginBottom:"6px"},children:["Email ",e.jsx("span",{style:{color:"var(--status-danger)"},children:"*"})]}),e.jsx("input",{type:"email",value:n.email,onChange:d=>m({...n,email:d.target.value}),style:{width:"100%",padding:"8px 12px",fontSize:"13px",border:"1px solid var(--border-primary)",borderRadius:"var(--radius)",background:"var(--bg-primary)",color:"var(--text-primary)"}})]}),e.jsxs("div",{children:[e.jsx("label",{style:{display:"block",fontSize:"13px",fontWeight:500,color:"var(--text-primary)",marginBottom:"6px"},children:"Full Name"}),e.jsx("input",{type:"text",value:n.fullName,onChange:d=>m({...n,fullName:d.target.value}),style:{width:"100%",padding:"8px 12px",fontSize:"13px",border:"1px solid var(--border-primary)",borderRadius:"var(--radius)",background:"var(--bg-primary)",color:"var(--text-primary)"}})]}),e.jsxs("div",{children:[e.jsx("label",{style:{display:"block",fontSize:"13px",fontWeight:500,color:"var(--text-primary)",marginBottom:"6px"},children:"Role"}),e.jsxs("select",{value:n.role,onChange:d=>m({...n,role:d.target.value}),style:{width:"100%",padding:"8px 12px",fontSize:"13px",border:"1px solid var(--border-primary)",borderRadius:"var(--radius)",background:"var(--bg-primary)",color:"var(--text-primary)"},children:[e.jsx("option",{value:"admin",children:"Admin"}),e.jsx("option",{value:"operator",children:"Operator"}),e.jsx("option",{value:"viewer",children:"Viewer"})]})]}),e.jsx("div",{children:e.jsxs("label",{style:{display:"flex",alignItems:"center",fontSize:"13px",fontWeight:500,color:"var(--text-primary)",cursor:"pointer"},children:[e.jsx("input",{type:"checkbox",checked:n.active,onChange:d=>m({...n,active:d.target.checked}),style:{marginRight:"8px"}}),"Active User"]})})]})}),e.jsxs(N.Footer,{children:[e.jsx(N.CloseButton,{onClick:i,disabled:h.isPending,children:"Cancel"}),e.jsx(f,{type:"submit",variant:"primary",icon:"ph ph-check",disabled:h.isPending,children:h.isPending?"Saving...":"Save Changes"})]})]})]})}const ge="_userList_96igz_3",xe="_filtersSection_96igz_9",fe="_filterGroup_96igz_21",ve="_badge_96igz_35",ye="_tableContainer_96igz_40",be="_userInfoCell_96igz_46",je="_userAvatar_96igz_52",Ce="_userDetails_96igz_66",ke="_userName_96igz_72",we="_userEmail_96igz_78",Ne="_actionsCell_96igz_83",l={userList:ge,filtersSection:xe,filterGroup:fe,badge:ve,tableContainer:ye,userInfoCell:be,userAvatar:je,userDetails:Ce,userName:ke,userEmail:we,actionsCell:Ne};function Te(){const[r,i]=g.useState("All"),[a,n]=g.useState("All"),[m,h]=g.useState(!1),[k,d]=g.useState(null),[v,P]=g.useState(!1),E=g.useMemo(()=>{const s={};return r!=="All"&&(s.role=r.toLowerCase()),a!=="All"&&(s.active=a==="Active"),s},[r,a]),{data:p,isLoading:u,error:x}=le(E),z=de(),O=ue(),K=pe(),Q=me(),V=s=>{if(!s)return"??";const t=s.split(" ");return t.length>1?`${t[0][0]}${t[1][0]}`:s.substring(0,2)},T=s=>{if(!s)return"Never";const t=new Date(s),M=new Date-t,$=Math.floor(M/6e4),R=Math.floor(M/36e5),w=Math.floor(M/864e5);return $<60?`${$} min ago`:R<24?`${R} hour${R>1?"s":""} ago`:w<7?`${w} day${w>1?"s":""} ago`:w<30?`${Math.floor(w/7)} week${Math.floor(w/7)>1?"s":""} ago`:t.toLocaleDateString("en-US",{month:"short",year:"numeric"})},y=(Array.isArray(p)?p:p?.data||[]).map(s=>({id:s.id,name:s.username,initials:V(s.username),email:s.email,role:s.role?s.role.charAt(0).toUpperCase()+s.role.slice(1):"Unknown",status:s.active?"Active":"Disabled",lastLogin:T(s.last_login),created:T(s.created_at)})),L=y,G=y.filter(s=>s.role==="Admin").length,W=y.filter(s=>s.role==="Operator").length,H=y.filter(s=>s.role==="Viewer").length,I=y.filter(s=>s.status==="Active").length,J=y.filter(s=>s.status==="Disabled").length,X=()=>{if(L.length===0){c.error("No data to export");return}ie(L,"users-export",{format:"csv",columns:["id","name","email","role","status","lastLogin","created"]}),c.success("Users exported successfully")},Y=s=>{confirm(`Delete user "${s.name}"?`)&&z.mutate(s.id)},Z=s=>{const t=s.target.files[0];t&&(O.mutate(t),s.target.value="")},ee=s=>{d(s),P(!0)},se=s=>{const t=prompt(`Enter new password for ${s.name}:`);t&&t.length>=8?K.mutate({userId:s.id,newPassword:t}):t&&c.error("Password must be at least 8 characters")},ae=s=>{const t=s.status==="Active"?"deactivate":"activate";confirm(`Are you sure you want to ${t} user "${s.name}"?`)&&Q.mutate(s.id)};if(x)return e.jsxs("div",{className:l.userList,children:[e.jsx(q,{icon:"ph ph-users",title:"Users",badge:e.jsx(D,{variant:"danger",children:"Error"})}),e.jsxs("div",{style:{padding:"2rem",textAlign:"center",color:"var(--color-danger)"},children:["Error loading users: ",x.message]})]});const re=[{key:"name",label:"User",render:s=>e.jsxs("div",{className:l.userInfoCell,children:[e.jsx("div",{className:l.userAvatar,children:s.initials}),e.jsxs("div",{className:l.userDetails,children:[e.jsx("div",{className:l.userName,children:s.name}),e.jsx("div",{className:l.userEmail,children:s.email})]})]})},{key:"role",label:"Role",render:s=>{const t=s.role==="Admin"?"error":s.role==="Operator"?"warning":"info";return e.jsx(D,{variant:t,children:s.role})}},{key:"status",label:"Status",render:s=>e.jsx(D,{variant:s.status==="Active"?"success":"error",children:s.status})},{key:"lastLogin",label:"Last Login"},{key:"created",label:"Created"},{key:"actions",label:"Actions",render:s=>e.jsxs("div",{className:l.actionsCell,children:[e.jsx(f,{variant:"default",size:"sm",icon:"ph ph-pencil-simple",onClick:t=>{t.stopPropagation(),ee(s)}}),e.jsx(f,{variant:"default",size:"sm",icon:"ph ph-trash",onClick:t=>{t.stopPropagation(),Y(s)}}),e.jsxs("div",{style:{position:"relative",display:"inline-block"},children:[e.jsx(f,{variant:"default",size:"sm",icon:"ph ph-dots-three-outline-vertical",onClick:t=>{t.stopPropagation();const F=t.currentTarget.nextSibling;F.style.display=F.style.display==="block"?"none":"block"}}),e.jsxs("div",{style:{display:"none",position:"absolute",right:0,top:"100%",marginTop:"4px",background:"var(--bg-secondary)",border:"1px solid var(--border-primary)",borderRadius:"var(--radius)",boxShadow:"0 2px 8px rgba(0,0,0,0.1)",zIndex:1e3,minWidth:"160px"},children:[e.jsxs("button",{onClick:t=>{t.stopPropagation(),se(s),t.currentTarget.parentElement.style.display="none"},style:{width:"100%",padding:"8px 12px",fontSize:"13px",color:"var(--text-primary)",background:"transparent",border:"none",textAlign:"left",cursor:"pointer",display:"flex",alignItems:"center",gap:"8px"},onMouseEnter:t=>t.currentTarget.style.background="var(--bg-hover)",onMouseLeave:t=>t.currentTarget.style.background="transparent",children:[e.jsx("i",{className:"ph ph-key"}),"Reset Password"]}),e.jsxs("button",{onClick:t=>{t.stopPropagation(),ae(s),t.currentTarget.parentElement.style.display="none"},style:{width:"100%",padding:"8px 12px",fontSize:"13px",color:"var(--text-primary)",background:"transparent",border:"none",textAlign:"left",cursor:"pointer",display:"flex",alignItems:"center",gap:"8px"},onMouseEnter:t=>t.currentTarget.style.background="var(--bg-hover)",onMouseLeave:t=>t.currentTarget.style.background="transparent",children:[e.jsx("i",{className:s.status==="Active"?"ph ph-prohibit":"ph ph-check-circle"}),s.status==="Active"?"Deactivate":"Activate"]})]})]})]})}];return e.jsxs("div",{className:l.userList,children:[e.jsx(q,{icon:"ph ph-users",title:"Users",badge:e.jsxs(D,{variant:"info",children:[I," Active"]}),actions:e.jsxs(e.Fragment,{children:[e.jsx("input",{type:"file",id:"import-users",accept:".csv",style:{display:"none"},onChange:Z}),e.jsx(f,{variant:"default",icon:"ph ph-upload-simple",onClick:()=>document.getElementById("import-users").click(),children:"Import"}),e.jsx(f,{variant:"default",icon:"ph ph-download-simple",onClick:X,children:"Export"}),e.jsx(f,{variant:"primary",icon:"ph ph-plus",onClick:()=>h(!0),children:"Create User"})]})}),e.jsxs("div",{className:l.filtersSection,children:[e.jsxs("div",{className:l.filterGroup,children:[e.jsx("label",{children:"Role"}),e.jsxs(B,{children:[e.jsxs(C,{active:r==="All",onClick:()=>i("All"),children:["All ",e.jsxs("span",{className:l.badge,children:["(",y.length,")"]})]}),e.jsxs(C,{active:r==="Admin",onClick:()=>i("Admin"),children:["Admin ",e.jsxs("span",{className:l.badge,children:["(",G,")"]})]}),e.jsxs(C,{active:r==="Operator",onClick:()=>i("Operator"),children:["Operator ",e.jsxs("span",{className:l.badge,children:["(",W,")"]})]}),e.jsxs(C,{active:r==="Viewer",onClick:()=>i("Viewer"),children:["Viewer ",e.jsxs("span",{className:l.badge,children:["(",H,")"]})]})]})]}),e.jsxs("div",{className:l.filterGroup,children:[e.jsx("label",{children:"Status"}),e.jsxs(B,{children:[e.jsxs(C,{active:a==="All",onClick:()=>n("All"),children:["All ",e.jsxs("span",{className:l.badge,children:["(",y.length,")"]})]}),e.jsxs(C,{active:a==="Active",onClick:()=>n("Active"),children:["Active ",e.jsxs("span",{className:l.badge,children:["(",I,")"]})]}),e.jsxs(C,{active:a==="Disabled",onClick:()=>n("Disabled"),children:["Disabled ",e.jsxs("span",{className:l.badge,children:["(",J,")"]})]})]})]})]}),e.jsx("div",{className:l.tableContainer,children:e.jsx(te,{columns:re,data:L,loading:u,onRowClick:s=>console.log("User clicked:",s),pageSize:10})}),e.jsx(oe,{isOpen:m,onClose:()=>h(!1)}),e.jsx(he,{isOpen:v,onClose:()=>P(!1),user:k})]})}export{Te as UserList,Te as default};

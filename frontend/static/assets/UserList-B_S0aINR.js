import{r as v,j as e,B as g,z as d,a as $}from"./index-BLoiUdtC.js";import{D as J}from"./DataTable-B9vCmons.js";import{B as U}from"./Badge-CXgMz5pb.js";import{P as E}from"./PageTopBar-Do-bffGE.js";import{P as I,a as x}from"./PillFilter-CSva6Xyn.js";import{e as H}from"./export-BEFxFx9V.js";import{M as W}from"./Modal-CS3t4LuW.js";import{I as k}from"./Input-DtRrv5XN.js";import{s as t}from"./CreateCAModal.module-DdQgTClK.js";import{u as X}from"./useQuery-XSjwF2au.js";import{u as T}from"./useMutation-BodkhEBn.js";import{a as y}from"./api-ClVrI7m4.js";function Y({isOpen:r,onClose:i}){const[a,m]=v.useState({username:"",password:"",confirmPassword:"",email:"",fullName:"",role:"operator",permissions:{manageCAs:!1,issueCertificates:!0,revokeCertificates:!1,manageUsers:!1,viewLogs:!0,manageSettings:!1}}),[C,b]=v.useState(!1),N=async c=>{if(c.preventDefault(),!a.username||!a.password){d.error("Username and password are required");return}if(a.password!==a.confirmPassword){d.error("Passwords do not match");return}if(a.password.length<8){d.error("Password must be at least 8 characters");return}b(!0);try{const l=await fetch("/api/v2/users",{method:"POST",headers:{"Content-Type":"application/json"},body:JSON.stringify({username:a.username,password:a.password,email:a.email,full_name:a.fullName,role:a.role,permissions:a.permissions})});if(!l.ok){const p=await l.json();throw new Error(p.message||"Failed to create user")}d.success("User created successfully"),i(),m({username:"",password:"",confirmPassword:"",email:"",fullName:"",role:"operator",permissions:{manageCAs:!1,issueCertificates:!0,revokeCertificates:!1,manageUsers:!1,viewLogs:!0,manageSettings:!1}}),window.location.reload()}catch(l){d.error(l.message||"Failed to create user")}finally{b(!1)}},u=c=>{m(l=>({...l,[c.target.name]:c.target.value}))},h=c=>{m(l=>({...l,permissions:{...l.permissions,[c]:!l.permissions[c]}}))},A=c=>{const l=c.target.value;let p={...a.permissions};l==="admin"?p={manageCAs:!0,issueCertificates:!0,revokeCertificates:!0,manageUsers:!0,viewLogs:!0,manageSettings:!0}:l==="operator"?p={manageCAs:!1,issueCertificates:!0,revokeCertificates:!1,manageUsers:!1,viewLogs:!0,manageSettings:!1}:l==="viewer"&&(p={manageCAs:!1,issueCertificates:!1,revokeCertificates:!1,manageUsers:!1,viewLogs:!0,manageSettings:!1}),m(F=>({...F,role:l,permissions:p}))},_=e.jsxs(e.Fragment,{children:[e.jsx(g,{variant:"secondary",onClick:i,disabled:C,children:"Cancel"}),e.jsx(g,{variant:"primary",onClick:N,disabled:C,children:C?"Creating...":"Create User"})]});return e.jsx(W,{isOpen:r,onClose:i,title:"Create User",size:"md",footer:_,children:e.jsxs("form",{onSubmit:N,className:t.form,children:[e.jsxs("div",{className:t.section,children:[e.jsx("h3",{className:t.sectionTitle,children:"Account Information"}),e.jsx(k,{label:"Username",name:"username",value:a.username,onChange:u,placeholder:"john.doe",required:!0}),e.jsx(k,{label:"Full Name",name:"fullName",value:a.fullName,onChange:u,placeholder:"John Doe"}),e.jsx(k,{label:"Email Address",name:"email",type:"email",value:a.email,onChange:u,placeholder:"john.doe@example.com"})]}),e.jsxs("div",{className:t.section,children:[e.jsx("h3",{className:t.sectionTitle,children:"Security"}),e.jsx(k,{label:"Password",name:"password",type:"password",value:a.password,onChange:u,placeholder:"••••••••",required:!0,helpText:"Minimum 8 characters"}),e.jsx(k,{label:"Confirm Password",name:"confirmPassword",type:"password",value:a.confirmPassword,onChange:u,placeholder:"••••••••",required:!0})]}),e.jsxs("div",{className:t.section,children:[e.jsx("h3",{className:t.sectionTitle,children:"Role & Permissions"}),e.jsxs("div",{className:t.field,children:[e.jsx("label",{className:t.label,children:"Role"}),e.jsxs("select",{name:"role",value:a.role,onChange:A,className:t.select,children:[e.jsx("option",{value:"admin",children:"Administrator"}),e.jsx("option",{value:"operator",children:"Operator"}),e.jsx("option",{value:"viewer",children:"Viewer"})]}),e.jsxs("p",{className:t.helpText,children:[a.role==="admin"&&"Full access to all features",a.role==="operator"&&"Can issue and manage certificates",a.role==="viewer"&&"Read-only access"]})]}),e.jsxs("div",{className:t.permissionsGrid,children:[e.jsxs("label",{className:t.checkboxLabel,children:[e.jsx("input",{type:"checkbox",checked:a.permissions.manageCAs,onChange:()=>h("manageCAs"),className:t.checkbox}),e.jsx("span",{children:"Manage CAs"})]}),e.jsxs("label",{className:t.checkboxLabel,children:[e.jsx("input",{type:"checkbox",checked:a.permissions.issueCertificates,onChange:()=>h("issueCertificates"),className:t.checkbox}),e.jsx("span",{children:"Issue Certificates"})]}),e.jsxs("label",{className:t.checkboxLabel,children:[e.jsx("input",{type:"checkbox",checked:a.permissions.revokeCertificates,onChange:()=>h("revokeCertificates"),className:t.checkbox}),e.jsx("span",{children:"Revoke Certificates"})]}),e.jsxs("label",{className:t.checkboxLabel,children:[e.jsx("input",{type:"checkbox",checked:a.permissions.manageUsers,onChange:()=>h("manageUsers"),className:t.checkbox}),e.jsx("span",{children:"Manage Users"})]}),e.jsxs("label",{className:t.checkboxLabel,children:[e.jsx("input",{type:"checkbox",checked:a.permissions.viewLogs,onChange:()=>h("viewLogs"),className:t.checkbox}),e.jsx("span",{children:"View Logs"})]}),e.jsxs("label",{className:t.checkboxLabel,children:[e.jsx("input",{type:"checkbox",checked:a.permissions.manageSettings,onChange:()=>h("manageSettings"),className:t.checkbox}),e.jsx("span",{children:"Manage Settings"})]})]})]})]})})}const P={getUsers:async(r={})=>(await y.get("/api/v2/users",{params:r})).data,createUser:async r=>(await y.post("/api/v2/users",r)).data,updateUser:async({id:r,...i})=>(await y.put(`/api/v2/users/${r}`,i)).data,deleteUser:async r=>(await y.delete(`/api/v2/users/${r}`)).data,importUsers:async r=>{const i=new FormData;return i.append("file",r),(await y.post("/api/v2/users/import",i,{headers:{"Content-Type":"multipart/form-data"}})).data}},w={all:["users"],lists:()=>[...w.all,"list"],list:r=>[...w.lists(),r]},Z=(r={})=>X({queryKey:w.list(r),queryFn:()=>P.getUsers(r)}),ee=()=>{const r=$();return T({mutationFn:P.deleteUser,onSuccess:()=>{r.invalidateQueries({queryKey:w.all}),d.success("User deleted successfully")},onError:i=>{d.error(i.response?.data?.message||"Failed to delete user")}})},se=()=>{const r=$();return T({mutationFn:P.importUsers,onSuccess:i=>{r.invalidateQueries({queryKey:w.all});const{imported:a=0,skipped:m=0}=i;d.success(`Imported ${a} users, skipped ${m}`)},onError:i=>{d.error(i.response?.data?.message||"Failed to import users")}})},ae="_userList_96igz_3",re="_filtersSection_96igz_9",te="_filterGroup_96igz_21",ie="_badge_96igz_35",ne="_tableContainer_96igz_40",le="_userInfoCell_96igz_46",oe="_userAvatar_96igz_52",ce="_userDetails_96igz_66",de="_userName_96igz_72",me="_userEmail_96igz_78",ue="_actionsCell_96igz_83",n={userList:ae,filtersSection:re,filterGroup:te,badge:ie,tableContainer:ne,userInfoCell:le,userAvatar:oe,userDetails:ce,userName:de,userEmail:me,actionsCell:ue};function Ae(){const[r,i]=v.useState("All"),[a,m]=v.useState("All"),[C,b]=v.useState(!1),N=v.useMemo(()=>{const s={};return r!=="All"&&(s.role=r.toLowerCase()),a!=="All"&&(s.active=a==="Active"),s},[r,a]),{data:u,isLoading:h,error:A}=Z(N),_=ee(),c=se(),l=s=>{if(!s)return"??";const o=s.split(" ");return o.length>1?`${o[0][0]}${o[1][0]}`:s.substring(0,2)},p=s=>{if(!s)return"Never";const o=new Date(s),L=new Date-o,z=Math.floor(L/6e4),D=Math.floor(L/36e5),j=Math.floor(L/864e5);return z<60?`${z} min ago`:D<24?`${D} hour${D>1?"s":""} ago`:j<7?`${j} day${j>1?"s":""} ago`:j<30?`${Math.floor(j/7)} week${Math.floor(j/7)>1?"s":""} ago`:o.toLocaleDateString("en-US",{month:"short",year:"numeric"})},f=(Array.isArray(u)?u:u?.data||[]).map(s=>({id:s.id,name:s.username,initials:l(s.username),email:s.email,role:s.role?s.role.charAt(0).toUpperCase()+s.role.slice(1):"Unknown",status:s.active?"Active":"Disabled",lastLogin:p(s.last_login),created:p(s.created_at)})),S=f,q=f.filter(s=>s.role==="Admin").length,R=f.filter(s=>s.role==="Operator").length,O=f.filter(s=>s.role==="Viewer").length,M=f.filter(s=>s.status==="Active").length,B=f.filter(s=>s.status==="Disabled").length,G=()=>{if(S.length===0){d.error("No data to export");return}H(S,"users-export",{format:"csv",columns:["id","name","email","role","status","lastLogin","created"]}),d.success("Users exported successfully")},V=s=>{confirm(`Delete user "${s.name}"?`)&&_.mutate(s.id)},K=s=>{const o=s.target.files[0];o&&(c.mutate(o),s.target.value="")};if(A)return e.jsxs("div",{className:n.userList,children:[e.jsx(E,{icon:"ph ph-users",title:"Users",badge:e.jsx(U,{variant:"danger",children:"Error"})}),e.jsxs("div",{style:{padding:"2rem",textAlign:"center",color:"var(--color-danger)"},children:["Error loading users: ",A.message]})]});const Q=[{key:"name",label:"User",render:s=>e.jsxs("div",{className:n.userInfoCell,children:[e.jsx("div",{className:n.userAvatar,children:s.initials}),e.jsxs("div",{className:n.userDetails,children:[e.jsx("div",{className:n.userName,children:s.name}),e.jsx("div",{className:n.userEmail,children:s.email})]})]})},{key:"role",label:"Role",render:s=>{const o=s.role==="Admin"?"error":s.role==="Operator"?"warning":"info";return e.jsx(U,{variant:o,children:s.role})}},{key:"status",label:"Status",render:s=>e.jsx(U,{variant:s.status==="Active"?"success":"error",children:s.status})},{key:"lastLogin",label:"Last Login"},{key:"created",label:"Created"},{key:"actions",label:"Actions",render:s=>e.jsxs("div",{className:n.actionsCell,children:[e.jsx(g,{variant:"default",size:"sm",icon:"ph ph-pencil-simple",onClick:o=>{o.stopPropagation(),console.log("Edit:",s)}}),e.jsx(g,{variant:"default",size:"sm",icon:"ph ph-trash",onClick:o=>{o.stopPropagation(),V(s)}}),e.jsx(g,{variant:"default",size:"sm",icon:"ph ph-dots-three-outline-vertical",onClick:o=>{o.stopPropagation(),console.log("More:",s)}})]})}];return e.jsxs("div",{className:n.userList,children:[e.jsx(E,{icon:"ph ph-users",title:"Users",badge:e.jsxs(U,{variant:"info",children:[M," Active"]}),actions:e.jsxs(e.Fragment,{children:[e.jsx("input",{type:"file",id:"import-users",accept:".csv",style:{display:"none"},onChange:K}),e.jsx(g,{variant:"default",icon:"ph ph-upload-simple",onClick:()=>document.getElementById("import-users").click(),children:"Import"}),e.jsx(g,{variant:"default",icon:"ph ph-download-simple",onClick:G,children:"Export"}),e.jsx(g,{variant:"primary",icon:"ph ph-plus",onClick:()=>b(!0),children:"Create User"})]})}),e.jsxs("div",{className:n.filtersSection,children:[e.jsxs("div",{className:n.filterGroup,children:[e.jsx("label",{children:"Role"}),e.jsxs(I,{children:[e.jsxs(x,{active:r==="All",onClick:()=>i("All"),children:["All ",e.jsxs("span",{className:n.badge,children:["(",f.length,")"]})]}),e.jsxs(x,{active:r==="Admin",onClick:()=>i("Admin"),children:["Admin ",e.jsxs("span",{className:n.badge,children:["(",q,")"]})]}),e.jsxs(x,{active:r==="Operator",onClick:()=>i("Operator"),children:["Operator ",e.jsxs("span",{className:n.badge,children:["(",R,")"]})]}),e.jsxs(x,{active:r==="Viewer",onClick:()=>i("Viewer"),children:["Viewer ",e.jsxs("span",{className:n.badge,children:["(",O,")"]})]})]})]}),e.jsxs("div",{className:n.filterGroup,children:[e.jsx("label",{children:"Status"}),e.jsxs(I,{children:[e.jsxs(x,{active:a==="All",onClick:()=>m("All"),children:["All ",e.jsxs("span",{className:n.badge,children:["(",f.length,")"]})]}),e.jsxs(x,{active:a==="Active",onClick:()=>m("Active"),children:["Active ",e.jsxs("span",{className:n.badge,children:["(",M,")"]})]}),e.jsxs(x,{active:a==="Disabled",onClick:()=>m("Disabled"),children:["Disabled ",e.jsxs("span",{className:n.badge,children:["(",B,")"]})]})]})]})]}),e.jsx("div",{className:n.tableContainer,children:e.jsx(J,{columns:Q,data:S,loading:h,onRowClick:s=>console.log("User clicked:",s),pageSize:10})}),e.jsx(Y,{isOpen:C,onClose:()=>b(!1)})]})}export{Ae as UserList,Ae as default};

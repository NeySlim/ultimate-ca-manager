import{r as g,j as e,B as x,z as d,b as k,d as P}from"./index-CEf6qbCC.js";import{D as te}from"./DataTable-D7xuQku9.js";import{B as _}from"./Badge-B_yaxula.js";import{a as ie,E as ne}from"./ErrorState-71npePws.js";import{E as oe}from"./EmptyState-CFQDvnlz.js";import{P as $}from"./PageTopBar-Cmf-0I_g.js";import{P as G,a as w}from"./PillFilter-Ct3t1pOQ.js";import{e as le}from"./export-BEFxFx9V.js";import{M as N}from"./Modal-CTbcj_GI.js";import{I as E}from"./Input-C_8fFhJF.js";import{S as ce}from"./SuccessAnimation-DP1dTNmR.js";import{s as o}from"./SharedModalForm.module-1nz5DqPv.js";import{u as de}from"./useQuery-DZzbpa9P.js";import{u as L}from"./useMutation-D9Urx3xE.js";import"./index-DPQxmKJq.js";function ue({isOpen:a,onClose:t}){const[n,l]=g.useState(!1),[i,m]=g.useState({username:"",password:"",confirmPassword:"",email:"",fullName:"",role:"operator",permissions:{manageCAs:!1,issueCertificates:!0,revokeCertificates:!1,manageUsers:!1,viewLogs:!0,manageSettings:!1}}),[C,p]=g.useState(!1),D=async h=>{if(h.preventDefault(),!i.username||!i.password){d.error("Username and password are required");return}if(i.password!==i.confirmPassword){d.error("Passwords do not match");return}if(i.password.length<8){d.error("Password must be at least 8 characters");return}p(!0);try{const u=await fetch("/api/v2/users",{method:"POST",headers:{"Content-Type":"application/json"},body:JSON.stringify({username:i.username,password:i.password,email:i.email,full_name:i.fullName,role:i.role,permissions:i.permissions})});if(!u.ok){const y=await u.json();throw new Error(y.message||"Failed to create user")}l(!0),d.success("User created successfully"),setTimeout(()=>{t(),l(!1),m({username:"",password:"",confirmPassword:"",email:"",fullName:"",role:"operator",permissions:{manageCAs:!1,issueCertificates:!0,revokeCertificates:!1,manageUsers:!1,viewLogs:!0,manageSettings:!1}}),window.location.reload()},2e3)}catch(u){d.error(u.message||"Failed to create user")}finally{p(!1)}},f=h=>{m(u=>({...u,[h.target.name]:h.target.value}))},v=h=>{m(u=>({...u,permissions:{...u.permissions,[h]:!u.permissions[h]}}))},U=h=>{const u=h.target.value;let y={...i.permissions};u==="admin"?y={manageCAs:!0,issueCertificates:!0,revokeCertificates:!0,manageUsers:!0,viewLogs:!0,manageSettings:!0}:u==="operator"?y={manageCAs:!1,issueCertificates:!0,revokeCertificates:!1,manageUsers:!1,viewLogs:!0,manageSettings:!1}:u==="viewer"&&(y={manageCAs:!1,issueCertificates:!1,revokeCertificates:!1,manageUsers:!1,viewLogs:!0,manageSettings:!1}),m(M=>({...M,role:u,permissions:y}))},z=e.jsxs(e.Fragment,{children:[e.jsx(x,{variant:"secondary",onClick:t,disabled:C,children:"Cancel"}),e.jsx(x,{variant:"primary",onClick:D,disabled:C,children:C?"Creating...":"Create User"})]});return e.jsxs(N,{isOpen:a,onClose:t,title:"Create User",size:"md",footer:z,children:[e.jsxs("form",{onSubmit:D,className:o.form,children:[e.jsxs("div",{className:o.section,children:[e.jsx("h3",{className:o.sectionTitle,children:"Account Information"}),e.jsx(E,{label:"Username",name:"username",value:i.username,onChange:f,placeholder:"john.doe",required:!0}),e.jsx(E,{label:"Full Name",name:"fullName",value:i.fullName,onChange:f,placeholder:"John Doe"}),e.jsx(E,{label:"Email Address",name:"email",type:"email",value:i.email,onChange:f,placeholder:"john.doe@example.com"})]}),e.jsxs("div",{className:o.section,children:[e.jsx("h3",{className:o.sectionTitle,children:"Security"}),e.jsx(E,{label:"Password",name:"password",type:"password",value:i.password,onChange:f,placeholder:"••••••••",required:!0,helpText:"Minimum 8 characters"}),e.jsx(E,{label:"Confirm Password",name:"confirmPassword",type:"password",value:i.confirmPassword,onChange:f,placeholder:"••••••••",required:!0})]}),e.jsxs("div",{className:o.section,children:[e.jsx("h3",{className:o.sectionTitle,children:"Role & Permissions"}),e.jsxs("div",{className:o.field,children:[e.jsx("label",{className:o.label,children:"Role"}),e.jsxs("select",{name:"role",value:i.role,onChange:U,className:o.select,children:[e.jsx("option",{value:"admin",children:"Administrator"}),e.jsx("option",{value:"operator",children:"Operator"}),e.jsx("option",{value:"viewer",children:"Viewer"})]}),e.jsxs("p",{className:o.helpText,children:[i.role==="admin"&&"Full access to all features",i.role==="operator"&&"Can issue and manage certificates",i.role==="viewer"&&"Read-only access"]})]}),e.jsxs("div",{className:o.permissionsGrid,children:[e.jsxs("label",{className:o.checkboxLabel,children:[e.jsx("input",{type:"checkbox",checked:i.permissions.manageCAs,onChange:()=>v("manageCAs"),className:o.checkbox}),e.jsx("span",{children:"Manage CAs"})]}),e.jsxs("label",{className:o.checkboxLabel,children:[e.jsx("input",{type:"checkbox",checked:i.permissions.issueCertificates,onChange:()=>v("issueCertificates"),className:o.checkbox}),e.jsx("span",{children:"Issue Certificates"})]}),e.jsxs("label",{className:o.checkboxLabel,children:[e.jsx("input",{type:"checkbox",checked:i.permissions.revokeCertificates,onChange:()=>v("revokeCertificates"),className:o.checkbox}),e.jsx("span",{children:"Revoke Certificates"})]}),e.jsxs("label",{className:o.checkboxLabel,children:[e.jsx("input",{type:"checkbox",checked:i.permissions.manageUsers,onChange:()=>v("manageUsers"),className:o.checkbox}),e.jsx("span",{children:"Manage Users"})]}),e.jsxs("label",{className:o.checkboxLabel,children:[e.jsx("input",{type:"checkbox",checked:i.permissions.viewLogs,onChange:()=>v("viewLogs"),className:o.checkbox}),e.jsx("span",{children:"View Logs"})]}),e.jsxs("label",{className:o.checkboxLabel,children:[e.jsx("input",{type:"checkbox",checked:i.permissions.manageSettings,onChange:()=>v("manageSettings"),className:o.checkbox}),e.jsx("span",{children:"Manage Settings"})]})]})]})]}),n&&e.jsx(ce,{message:"User Created!",onComplete:()=>l(!1)})]})}const A={getUsers:async(a={})=>(await k.get("/api/v2/users",{params:a})).data,createUser:async a=>(await k.post("/api/v2/users",a)).data,updateUser:async({id:a,...t})=>(await k.put(`/api/v2/users/${a}`,t)).data,resetPassword:async(a,t)=>(await k.post(`/api/v2/users/${a}/reset-password`,{new_password:t})).data,toggleStatus:async a=>(await k.patch(`/api/v2/users/${a}/toggle`)).data,deleteUser:async a=>(await k.delete(`/api/v2/users/${a}`)).data,importUsers:async a=>{const t=new FormData;return t.append("file",a),(await k.post("/api/v2/users/import",t,{headers:{"Content-Type":"multipart/form-data"}})).data}},j={all:["users"],lists:()=>[...j.all,"list"],list:a=>[...j.lists(),a]},pe=(a={})=>de({queryKey:j.list(a),queryFn:()=>A.getUsers(a)}),me=()=>{const a=P();return L({mutationFn:A.updateUser,onSuccess:()=>{a.invalidateQueries({queryKey:j.all}),d.success("User updated successfully")},onError:t=>{d.error(t.response?.data?.message||"Failed to update user")}})},he=()=>{const a=P();return L({mutationFn:A.deleteUser,onSuccess:()=>{a.invalidateQueries({queryKey:j.all}),d.success("User deleted successfully")},onError:t=>{d.error(t.response?.data?.message||"Failed to delete user")}})},ge=()=>{const a=P();return L({mutationFn:A.importUsers,onSuccess:t=>{a.invalidateQueries({queryKey:j.all});const{imported:n=0,skipped:l=0}=t;d.success(`Imported ${n} users, skipped ${l}`)},onError:t=>{d.error(t.response?.data?.message||"Failed to import users")}})},xe=()=>{const a=P();return L({mutationFn:({userId:t,newPassword:n})=>A.resetPassword(t,n),onSuccess:()=>{a.invalidateQueries({queryKey:j.all}),d.success("Password reset successfully")},onError:t=>{d.error(t.response?.data?.message||"Failed to reset password")}})},fe=()=>{const a=P();return L({mutationFn:A.toggleStatus,onSuccess:()=>{a.invalidateQueries({queryKey:j.all}),d.success("User status updated successfully")},onError:t=>{d.error(t.response?.data?.message||"Failed to toggle user status")}})};function ve({isOpen:a,onClose:t,user:n}){const[l,i]=g.useState({email:"",fullName:"",role:"operator",active:!0}),m=me();if(g.useEffect(()=>{n&&i({email:n.email||"",fullName:n.name||"",role:n.role?.toLowerCase()||"operator",active:n.status==="Active"})},[n]),!n)return null;const C=async p=>{if(p.preventDefault(),!l.email){d.error("Email is required");return}m.mutate({id:n.id,email:l.email,full_name:l.fullName,role:l.role,active:l.active},{onSuccess:()=>{t()}})};return e.jsxs(N,{isOpen:a,onClose:t,size:"medium",children:[e.jsxs(N.Header,{children:[e.jsx("i",{className:"ph ph-pencil-simple",style:{marginRight:"8px"}}),"Edit User: ",n.name]}),e.jsxs("form",{onSubmit:C,children:[e.jsx(N.Body,{children:e.jsxs("div",{style:{display:"flex",flexDirection:"column",gap:"16px"},children:[e.jsxs("div",{children:[e.jsx("label",{style:{display:"block",fontSize:"13px",fontWeight:500,color:"var(--text-primary)",marginBottom:"6px"},children:"Username"}),e.jsx("input",{type:"text",value:n.name,readOnly:!0,disabled:!0,style:{width:"100%",padding:"8px 12px",fontSize:"13px",border:"1px solid var(--border-primary)",borderRadius:"var(--radius)",background:"var(--bg-tertiary)",color:"var(--text-tertiary)",cursor:"not-allowed"}})]}),e.jsxs("div",{children:[e.jsxs("label",{style:{display:"block",fontSize:"13px",fontWeight:500,color:"var(--text-primary)",marginBottom:"6px"},children:["Email ",e.jsx("span",{style:{color:"var(--status-danger)"},children:"*"})]}),e.jsx("input",{type:"email",value:l.email,onChange:p=>i({...l,email:p.target.value}),style:{width:"100%",padding:"8px 12px",fontSize:"13px",border:"1px solid var(--border-primary)",borderRadius:"var(--radius)",background:"var(--bg-primary)",color:"var(--text-primary)"}})]}),e.jsxs("div",{children:[e.jsx("label",{style:{display:"block",fontSize:"13px",fontWeight:500,color:"var(--text-primary)",marginBottom:"6px"},children:"Full Name"}),e.jsx("input",{type:"text",value:l.fullName,onChange:p=>i({...l,fullName:p.target.value}),style:{width:"100%",padding:"8px 12px",fontSize:"13px",border:"1px solid var(--border-primary)",borderRadius:"var(--radius)",background:"var(--bg-primary)",color:"var(--text-primary)"}})]}),e.jsxs("div",{children:[e.jsx("label",{style:{display:"block",fontSize:"13px",fontWeight:500,color:"var(--text-primary)",marginBottom:"6px"},children:"Role"}),e.jsxs("select",{value:l.role,onChange:p=>i({...l,role:p.target.value}),style:{width:"100%",padding:"8px 12px",fontSize:"13px",border:"1px solid var(--border-primary)",borderRadius:"var(--radius)",background:"var(--bg-primary)",color:"var(--text-primary)"},children:[e.jsx("option",{value:"admin",children:"Admin"}),e.jsx("option",{value:"operator",children:"Operator"}),e.jsx("option",{value:"viewer",children:"Viewer"})]})]}),e.jsx("div",{children:e.jsxs("label",{style:{display:"flex",alignItems:"center",fontSize:"13px",fontWeight:500,color:"var(--text-primary)",cursor:"pointer"},children:[e.jsx("input",{type:"checkbox",checked:l.active,onChange:p=>i({...l,active:p.target.checked}),style:{marginRight:"8px"}}),"Active User"]})})]})}),e.jsxs(N.Footer,{children:[e.jsx(N.CloseButton,{onClick:t,disabled:m.isPending,children:"Cancel"}),e.jsx(x,{type:"submit",variant:"primary",icon:"ph ph-check",disabled:m.isPending,children:m.isPending?"Saving...":"Save Changes"})]})]})]})}const ye="_userList_96igz_3",be="_filtersSection_96igz_9",je="_filterGroup_96igz_21",Ce="_badge_96igz_35",ke="_tableContainer_96igz_40",we="_userInfoCell_96igz_46",Se="_userAvatar_96igz_52",Ne="_userDetails_96igz_66",Ae="_userName_96igz_72",Ue="_userEmail_96igz_78",_e="_actionsCell_96igz_83",c={userList:ye,filtersSection:be,filterGroup:je,badge:Ce,tableContainer:ke,userInfoCell:we,userAvatar:Se,userDetails:Ne,userName:Ae,userEmail:Ue,actionsCell:_e};function Qe(){const[a,t]=g.useState("All"),[n,l]=g.useState("All"),[i,m]=g.useState(!1),[C,p]=g.useState(null),[D,f]=g.useState(!1),v=g.useMemo(()=>{const s={};return a!=="All"&&(s.role=a.toLowerCase()),n!=="All"&&(s.active=n==="Active"),s},[a,n]),{data:U,isLoading:z,error:h}=pe(v),u=he(),y=ge(),M=xe(),K=fe(),Q=s=>{if(!s)return"??";const r=s.split(" ");return r.length>1?`${r[0][0]}${r[1][0]}`:s.substring(0,2)},q=s=>{if(!s)return"Never";const r=new Date(s),R=new Date-r,O=Math.floor(R/6e4),I=Math.floor(R/36e5),S=Math.floor(R/864e5);return O<60?`${O} min ago`:I<24?`${I} hour${I>1?"s":""} ago`:S<7?`${S} day${S>1?"s":""} ago`:S<30?`${Math.floor(S/7)} week${Math.floor(S/7)>1?"s":""} ago`:r.toLocaleDateString("en-US",{month:"short",year:"numeric"})},b=(Array.isArray(U)?U:U?.data||[]).map(s=>({id:s.id,name:s.username,initials:Q(s.username),email:s.email,role:s.role?s.role.charAt(0).toUpperCase()+s.role.slice(1):"Unknown",status:s.active?"Active":"Disabled",lastLogin:q(s.last_login),created:q(s.created_at)})),F=b,V=b.filter(s=>s.role==="Admin").length,W=b.filter(s=>s.role==="Operator").length,H=b.filter(s=>s.role==="Viewer").length,B=b.filter(s=>s.status==="Active").length,J=b.filter(s=>s.status==="Disabled").length,X=()=>{if(F.length===0){d.error("No data to export");return}le(F,"users-export",{format:"csv",columns:["id","name","email","role","status","lastLogin","created"]}),d.success("Users exported successfully")},Y=s=>{confirm(`Delete user "${s.name}"?`)&&u.mutate(s.id)},Z=s=>{const r=s.target.files[0];r&&(y.mutate(r),s.target.value="")},ee=s=>{p(s),f(!0)},se=s=>{const r=prompt(`Enter new password for ${s.name}:`);r&&r.length>=8?M.mutate({userId:s.id,newPassword:r}):r&&d.error("Password must be at least 8 characters")},ae=s=>{const r=s.status==="Active"?"deactivate":"activate";confirm(`Are you sure you want to ${r} user "${s.name}"?`)&&K.mutate(s.id)};if(z)return e.jsxs("div",{className:c.userList,children:[e.jsx($,{icon:"ph ph-users",title:"Users",badge:e.jsx(_,{variant:"neutral",children:"Loading..."})}),Array.from({length:6}).map((s,r)=>e.jsx(ie,{width:"100%",height:60,style:{marginBottom:"8px"}},r))]});if(h)return e.jsxs("div",{className:c.userList,children:[e.jsx($,{icon:"ph ph-users",title:"Users",badge:e.jsx(_,{variant:"danger",children:"Error"})}),e.jsx(ne,{error:h,shake:!0}),e.jsxs("div",{style:{padding:"2rem",textAlign:"center",color:"var(--color-danger)"},children:["Error loading users: ",h.message]})]});const re=[{key:"name",label:"User",render:s=>e.jsxs("div",{className:c.userInfoCell,children:[e.jsx("div",{className:c.userAvatar,children:s.initials}),e.jsxs("div",{className:c.userDetails,children:[e.jsx("div",{className:c.userName,children:s.name}),e.jsx("div",{className:c.userEmail,children:s.email})]})]})},{key:"role",label:"Role",render:s=>{const r=s.role==="Admin"?"error":s.role==="Operator"?"warning":"info";return e.jsx(_,{variant:r,children:s.role})}},{key:"status",label:"Status",render:s=>e.jsx(_,{variant:s.status==="Active"?"success":"error",children:s.status})},{key:"lastLogin",label:"Last Login"},{key:"created",label:"Created"},{key:"actions",label:"Actions",render:s=>e.jsxs("div",{className:c.actionsCell,children:[e.jsx(x,{variant:"default",size:"sm",icon:"ph ph-pencil-simple",onClick:r=>{r.stopPropagation(),ee(s)}}),e.jsx(x,{variant:"default",size:"sm",icon:"ph ph-trash",onClick:r=>{r.stopPropagation(),Y(s)}}),e.jsxs("div",{style:{position:"relative",display:"inline-block"},children:[e.jsx(x,{variant:"default",size:"sm",icon:"ph ph-dots-three-outline-vertical",onClick:r=>{r.stopPropagation();const T=r.currentTarget.nextSibling;T.style.display=T.style.display==="block"?"none":"block"}}),e.jsxs("div",{style:{display:"none",position:"absolute",right:0,top:"100%",marginTop:"4px",background:"var(--bg-secondary)",border:"1px solid var(--border-primary)",borderRadius:"var(--radius)",boxShadow:"0 2px 8px rgba(0,0,0,0.1)",zIndex:1e3,minWidth:"160px"},children:[e.jsxs("button",{onClick:r=>{r.stopPropagation(),se(s),r.currentTarget.parentElement.style.display="none"},style:{width:"100%",padding:"8px 12px",fontSize:"13px",color:"var(--text-primary)",background:"transparent",border:"none",textAlign:"left",cursor:"pointer",display:"flex",alignItems:"center",gap:"8px"},onMouseEnter:r=>r.currentTarget.style.background="var(--bg-hover)",onMouseLeave:r=>r.currentTarget.style.background="transparent",children:[e.jsx("i",{className:"ph ph-key"}),"Reset Password"]}),e.jsxs("button",{onClick:r=>{r.stopPropagation(),ae(s),r.currentTarget.parentElement.style.display="none"},style:{width:"100%",padding:"8px 12px",fontSize:"13px",color:"var(--text-primary)",background:"transparent",border:"none",textAlign:"left",cursor:"pointer",display:"flex",alignItems:"center",gap:"8px"},onMouseEnter:r=>r.currentTarget.style.background="var(--bg-hover)",onMouseLeave:r=>r.currentTarget.style.background="transparent",children:[e.jsx("i",{className:s.status==="Active"?"ph ph-prohibit":"ph ph-check-circle"}),s.status==="Active"?"Deactivate":"Activate"]})]})]})]})}];return e.jsxs("div",{className:c.userList,children:[e.jsx($,{icon:"ph ph-users",title:"Users",badge:e.jsxs(_,{variant:"info",children:[B," Active"]}),actions:e.jsxs(e.Fragment,{children:[e.jsx("input",{type:"file",id:"import-users",accept:".csv",style:{display:"none"},onChange:Z}),e.jsx(x,{variant:"default",icon:"ph ph-upload-simple",onClick:()=>document.getElementById("import-users").click(),children:"Import"}),e.jsx(x,{variant:"default",icon:"ph ph-download-simple",onClick:X,children:"Export"}),e.jsx(x,{variant:"primary",icon:"ph ph-plus",onClick:()=>m(!0),children:"Create User"})]})}),e.jsxs("div",{className:c.filtersSection,children:[e.jsxs("div",{className:c.filterGroup,children:[e.jsx("label",{children:"Role"}),e.jsxs(G,{children:[e.jsxs(w,{active:a==="All",onClick:()=>t("All"),children:["All ",e.jsxs("span",{className:c.badge,children:["(",b.length,")"]})]}),e.jsxs(w,{active:a==="Admin",onClick:()=>t("Admin"),children:["Admin ",e.jsxs("span",{className:c.badge,children:["(",V,")"]})]}),e.jsxs(w,{active:a==="Operator",onClick:()=>t("Operator"),children:["Operator ",e.jsxs("span",{className:c.badge,children:["(",W,")"]})]}),e.jsxs(w,{active:a==="Viewer",onClick:()=>t("Viewer"),children:["Viewer ",e.jsxs("span",{className:c.badge,children:["(",H,")"]})]})]})]}),e.jsxs("div",{className:c.filterGroup,children:[e.jsx("label",{children:"Status"}),e.jsxs(G,{children:[e.jsxs(w,{active:n==="All",onClick:()=>l("All"),children:["All ",e.jsxs("span",{className:c.badge,children:["(",b.length,")"]})]}),e.jsxs(w,{active:n==="Active",onClick:()=>l("Active"),children:["Active ",e.jsxs("span",{className:c.badge,children:["(",B,")"]})]}),e.jsxs(w,{active:n==="Disabled",onClick:()=>l("Disabled"),children:["Disabled ",e.jsxs("span",{className:c.badge,children:["(",J,")"]})]})]})]})]}),e.jsx("div",{className:c.tableContainer,children:F.length===0?e.jsx(oe,{icon:"ph ph-users",title:"No users found",message:a!=="All"||n!=="All"?"Try adjusting your filters to see more results":"Get started by creating your first user account",action:a==="All"&&n==="All"?{label:"Create User",onClick:()=>m(!0)}:void 0}):e.jsx(te,{columns:re,data:F,loading:z,onRowClick:s=>console.log("User clicked:",s),pageSize:10})}),e.jsx(ue,{isOpen:i,onClose:()=>m(!1)}),e.jsx(ve,{isOpen:D,onClose:()=>f(!1),user:C})]})}export{Qe as UserList,Qe as default};

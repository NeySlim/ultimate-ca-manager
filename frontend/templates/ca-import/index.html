{% extends "base.html" %}

{% block title %}Import Certificate Authority - UCM{% endblock %}

{% block content %}
<div class="space-y-6">
    <!-- Page Header -->
    <div class="page-header" style="margin-bottom: 20px; padding-bottom: 12px; border-bottom: 1px solid var(--border); display: flex; justify-content: space-between; align-items: center;">
        <div>
            <h1 style="font-size: 20px; font-weight: 600; color: var(--text-primary); margin: 0;">
                <i class="fas fa-file-import" style="margin-right: 8px;"></i>Import Certificate Authority
            </h1>
            <p style="font-size: 13px; color: var(--text-secondary); margin: 4px 0 0 0;">Import CA certificates from various sources</p>
        </div>
    </div>
    
    <!-- Manual CA Import Section -->
    <div class="card">
        <div class="card-header">
            <h2 style="font-size: 14px; font-weight: 600; color: var(--text-primary); margin: 0;">
                <i class="fas fa-upload" style="margin-right: 8px;"></i>Manual CA Import
            </h2>
        </div>
        <div class="card-body">
            <p style="font-size: 13px; color: var(--text-secondary); margin-bottom: 16px;">
                Import a CA certificate and optionally its private key.
            </p>
            
            <form id="manual-import-form" style="display: grid; gap: 20px;">
                <!-- Import Method Tabs -->
                <div style="display: flex; gap: 8px; border-bottom: 2px solid var(--border-color);">
                    <button type="button" class="tab-button active" onclick="switchImportMethod('paste')" style="padding: 8px 16px; border: none; background: none; color: var(--text-secondary); cursor: pointer; border-bottom: 2px solid transparent; margin-bottom: -2px;">
                        <i class="fas fa-paste"></i> Paste Content
                    </button>
                    <button type="button" class="tab-button" onclick="switchImportMethod('upload')" style="padding: 8px 16px; border: none; background: none; color: var(--text-secondary); cursor: pointer; border-bottom: 2px solid transparent; margin-bottom: -2px;">
                        <i class="fas fa-upload"></i> Upload Files
                    </button>
                    <button type="button" class="tab-button" onclick="switchImportMethod('container')" style="padding: 8px 16px; border: none; background: none; color: var(--text-secondary); cursor: pointer; border-bottom: 2px solid transparent; margin-bottom: -2px;">
                        <i class="fas fa-box"></i> Container File
                    </button>
                </div>
                
                <!-- Paste Method -->
                <div id="paste-method" style="display: grid; gap: 16px;">
                    <div>
                        <label class="modal-form-label">CA Certificate (PEM format) <span style="color: var(--status-danger);">*</span></label>
                        <textarea id="cert-paste" rows="10" placeholder="-----BEGIN CERTIFICATE-----&#10;...&#10;-----END CERTIFICATE-----" 
                                  class="modal-form-input" style="font-family: monospace; font-size: 12px;"></textarea>
                    </div>
                    <div>
                        <label class="modal-form-label">Private Key (PEM format - Optional for Root CAs)</label>
                        <textarea id="key-paste" rows="8" placeholder="-----BEGIN PRIVATE KEY-----&#10;...&#10;-----END PRIVATE KEY-----" 
                                  class="modal-form-input" style="font-family: monospace; font-size: 12px;"></textarea>
                        <p style="font-size: 12px; color: var(--text-secondary); margin-top: 4px;">Only required if this CA will sign certificates</p>
                    </div>
                </div>
                
                <!-- Upload Method -->
                <div id="upload-method" style="display: none; grid-template-columns: 1fr 1fr; gap: 16px;">
                    <div>
                        <label class="modal-form-label">CA Certificate File (.crt, .pem, .cer) <span style="color: var(--status-danger);">*</span></label>
                        <input type="file" id="cert-file" accept=".crt,.pem,.cer,.der" class="modal-form-input" style="padding: 8px;">
                    </div>
                    <div>
                        <label class="modal-form-label">Private Key File (.key, .pem - Optional)</label>
                        <input type="file" id="key-file" accept=".key,.pem" class="modal-form-input" style="padding: 8px;">
                        <p style="font-size: 12px; color: var(--text-secondary); margin-top: 4px;">Only for signing CAs</p>
                    </div>
                </div>
                
                <!-- Container Method -->
                <div id="container-method" style="display: none; gap: 16px;">
                    <div>
                        <label class="modal-form-label">Container Format</label>
                        <select id="container-format" class="modal-form-input">
                            <option value="auto">Auto-detect</option>
                            <option value="pkcs12">PKCS#12 (.p12, .pfx)</option>
                            <option value="pkcs7">PKCS#7 (.p7b, .p7c)</option>
                            <option value="der">DER Binary (.der)</option>
                        </select>
                    </div>
                    <div>
                        <label class="modal-form-label">Container File <span style="color: var(--status-danger);">*</span></label>
                        <input type="file" id="container-file" accept=".p12,.pfx,.p7b,.p7c,.der" class="modal-form-input" style="padding: 8px;">
                        <p style="font-size: 12px; color: var(--text-secondary); margin-top: 4px;">
                            Supported: PKCS#12 (P12/PFX), PKCS#7 (P7B), DER binary
                        </p>
                    </div>
                    <div>
                        <label class="modal-form-label">Container Password</label>
                        <input type="password" id="container-password" placeholder="Password (if encrypted)" class="modal-form-input">
                    </div>
                </div>
                
                <!-- Common Fields -->
                <div style="display: grid; grid-template-columns: 1fr 1fr; gap: 16px;">
                    <div>
                        <label class="modal-form-label">Description <span style="color: var(--status-danger);">*</span></label>
                        <input type="text" id="ca-description" placeholder="My Root CA" class="modal-form-input" required>
                    </div>
                    <div>
                        <label class="modal-form-label">Private Key Password (if encrypted)</label>
                        <input type="password" id="key-password" placeholder="Optional" class="modal-form-input">
                    </div>
                </div>
                
                <div style="display: flex; gap: 12px;">
                    <button type="button" onclick="importManualCA()" class="btn btn-primary">
                        <i class="fas fa-check"></i> Import CA
                    </button>
                    <button type="button" onclick="clearManualForm()" class="btn btn-secondary">
                        <i class="fas fa-times"></i> Clear
                    </button>
                </div>
                
                <div id="manual-import-status" style="display: none;"></div>
            </form>
        </div>
    </div>
    
    <!-- Quick Link to OPNsense Import -->
    <div class="card" style="background: linear-gradient(135deg, rgba(59, 130, 246, 0.05) 0%, rgba(59, 130, 246, 0.02) 100%);">
        <div class="card-body" style="display: flex; align-items: center; justify-content: space-between;">
            <div>
                <h3 style="font-size: 14px; font-weight: 600; color: var(--text-primary); margin: 0 0 4px 0;">
                    <i class="fas fa-server" style="margin-right: 8px; color: var(--primary-color);"></i>Bulk Import from OPNsense
                </h3>
                <p style="font-size: 13px; color: var(--text-secondary); margin: 0;">
                    Import multiple CAs and certificates automatically from your OPNsense firewall
                </p>
            </div>
            <a href="/import" class="btn btn-primary" hx-get="/import" hx-target="#main-content" hx-select="#main-content" hx-swap="outerHTML" hx-push-url="true">
                <i class="fas fa-arrow-right"></i> Go to OPNsense Import
            </a>
        </div>
    </div>
</div>

<script>
function switchImportMethod(method) {
    document.querySelectorAll('.tab-button').forEach(btn => {
        btn.classList.remove('active');
        btn.style.borderBottomColor = 'transparent';
        btn.style.color = 'var(--text-secondary)';
    });
    event.target.closest('.tab-button').classList.add('active');
    event.target.closest('.tab-button').style.borderBottomColor = 'var(--primary-color)';
    event.target.closest('.tab-button').style.color = 'var(--primary-color)';
    
    document.getElementById('paste-method').style.display = 'none';
    document.getElementById('upload-method').style.display = 'none';
    document.getElementById('container-method').style.display = 'none';
    
    if (method === 'paste') {
        document.getElementById('paste-method').style.display = 'grid';
    } else if (method === 'upload') {
        document.getElementById('upload-method').style.display = 'grid';
    } else if (method === 'container') {
        document.getElementById('container-method').style.display = 'grid';
    }
}

async function importManualCA() {
    const statusDiv = document.getElementById('manual-import-status');
    let method = 'paste';
    
    if (document.getElementById('upload-method').style.display !== 'none') {
        method = 'upload';
    } else if (document.getElementById('container-method').style.display !== 'none') {
        method = 'container';
    }
    
    const description = document.getElementById('ca-description').value.trim();
    if (!description) {
        showStatus(statusDiv, 'Please provide a description', 'error');
        return;
    }
    
    let certContent, keyContent, containerData;
    
    try {
        if (method === 'paste') {
            certContent = document.getElementById('cert-paste').value.trim();
            keyContent = document.getElementById('key-paste').value.trim();
            
            if (!certContent) {
                showStatus(statusDiv, 'Please provide the CA certificate', 'error');
                return;
            }
        } else if (method === 'upload') {
            const certFile = document.getElementById('cert-file').files[0];
            const keyFile = document.getElementById('key-file').files[0];
            
            if (!certFile) {
                showStatus(statusDiv, 'Please select the CA certificate file', 'error');
                return;
            }
            
            certContent = await certFile.text();
            if (keyFile) {
                keyContent = await keyFile.text();
            }
        } else if (method === 'container') {
            const containerFile = document.getElementById('container-file').files[0];
            
            if (!containerFile) {
                showStatus(statusDiv, 'Please select a container file', 'error');
                return;
            }
            
            const reader = new FileReader();
            containerData = await new Promise((resolve, reject) => {
                reader.onload = (e) => resolve(e.target.result.split(',')[1]);
                reader.onerror = reject;
                reader.readAsDataURL(containerFile);
            });
        }
        
        const formData = {
            import_method: method,
            description: description,
            key_password: document.getElementById('key-password').value
        };
        
        if (method === 'container') {
            formData.container_data = containerData;
            formData.container_format = document.getElementById('container-format').value;
            formData.container_password = document.getElementById('container-password').value;
        } else {
            formData.certificate = certContent;
            if (keyContent) {
                formData.private_key = keyContent;
            }
        }
        
        showStatus(statusDiv, 'Importing CA...', 'info');
        
        const response = await fetch('/api/ui/ca/import', {
            method: 'POST',
            headers: {
                'Content-Type': 'application/json'
            },
            body: JSON.stringify(formData)
        });
        
        const result = await response.json();
        
        if (response.ok) {
            showStatus(statusDiv, '✓ CA imported successfully!', 'success');
            setTimeout(() => {
                window.location.href = '/ca';
            }, 1500);
        } else {
            showStatus(statusDiv, '✗ Import failed: ' + (result.error || result.message || 'Unknown error'), 'error');
        }
    } catch (error) {
        showStatus(statusDiv, '✗ Import failed: ' + error.message, 'error');
    }
}

function clearManualForm() {
    document.getElementById('cert-paste').value = '';
    document.getElementById('key-paste').value = '';
    document.getElementById('cert-file').value = '';
    document.getElementById('key-file').value = '';
    document.getElementById('container-file').value = '';
    document.getElementById('container-format').value = 'auto';
    document.getElementById('container-password').value = '';
    document.getElementById('ca-description').value = '';
    document.getElementById('key-password').value = '';
    document.getElementById('manual-import-status').style.display = 'none';
}

function showStatus(element, message, type) {
    element.className = 'p-4 rounded-lg ' + (
        type === 'success' ? 'bg-green-50 text-green-800 border border-green-200' :
        type === 'error' ? 'bg-red-50 text-red-800 border border-red-200' :
        'bg-blue-50 text-blue-800 border border-blue-200'
    );
    element.textContent = message;
    element.style.display = 'block';
}

document.addEventListener('DOMContentLoaded', function() {
    const firstTab = document.querySelector('.tab-button.active');
    if (firstTab) {
        firstTab.style.borderBottomColor = 'var(--primary-color)';
        firstTab.style.color = 'var(--primary-color)';
    }
});
</script>

<style>
.tab-button.active {
    font-weight: 600;
}
</style>
{% endblock %}

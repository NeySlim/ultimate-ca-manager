{% extends "base.html" %}

{% block title %}My mTLS Certificates - UCM{% endblock %}

{% block content %}
<div style="display: flex; flex-direction: column; gap: 1.5rem;">
    <div style="display: flex; justify-content: space-between; align-items: center;">
        <h1 style="font-size: 1.875rem; font-weight: 600; color: var(--text-primary); margin: 0; display: flex; align-items: center; gap: 0.5rem;">
            <svg class="ucm-icon" width="24" height="24"><use href="#icon-key"/></svg>
            <span>My Client Certificates</span>
        </h1>
        <a href="/my-account" class="btn-secondary">
            <svg class="ucm-icon" width="16" height="16"><use href="#icon-arrow-left"/></svg>
            Back to My Account
        </a>
    </div>
    
    <!-- mTLS Status Info -->
    <div id="mtls-info" class="card" style="display: none;">
        <div style="padding: 1.5rem;">
            <div style="display: flex; align-items: start; gap: 1rem;">
                <svg class="ucm-icon" width="24" height="24" style="color: var(--info-color); margin-top: 0.125rem;"><use href="#icon-info"/></svg>
                <div style="flex: 1;">
                    <p style="font-weight: 600; color: var(--text-primary); margin-bottom: 0.5rem;">About Client Certificates</p>
                    <p style="font-size: 0.875rem; color: var(--text-secondary);" id="mtls-info-text"></p>
                </div>
            </div>
        </div>
    </div>
    
    <!-- Certificate Management -->
    <div id="mtls-certificates-section" class="card" style="display: none;">
        <div class="card-header">
            <h2 style="font-size: 1.25rem; font-weight: 600; color: var(--text-primary); display: flex; align-items: center; gap: 0.5rem; margin: 0;">
                <svg class="ucm-icon" width="20" height="20" style="color: var(--primary-color);"><use href="#icon-key"/></svg>
                Client Certificates
            </h2>
        </div>

        <!-- Tabs -->
        <div class="tabs-container" style="display: flex; gap: 0; margin-bottom: 2rem; border-bottom: 2px solid var(--border-color);">
            <button class="tab-button active" onclick="ucm_switchTab('create')" id="btn-tab-create" style="padding: 1rem 2rem; font-size: 0.95rem; font-weight: 600; color: var(--primary-color); border-bottom: 3px solid var(--primary-color); background: none; border-top: none; border-left: none; border-right: none; cursor: pointer; min-height: 3.5rem; display: flex; align-items: center;">
                <svg class="ucm-icon" width="20" height="20" style="margin-right: 8px;"><use href="#icon-plus"/></svg>
                Create
            </button>
            <button class="tab-button" onclick="ucm_switchTab('import')" id="btn-tab-import" style="padding: 1rem 2rem; font-size: 0.95rem; font-weight: 500; color: var(--text-secondary); border-bottom: 3px solid transparent; background: none; border-top: none; border-left: none; border-right: none; cursor: pointer; min-height: 3.5rem; display: flex; align-items: center;">
                <svg class="ucm-icon" width="20" height="20" style="margin-right: 8px;"><use href="#icon-upload"/></svg>
                Import
            </button>
            <button class="tab-button" onclick="ucm_switchTab('manage'); loadCertificates();" id="btn-tab-manage" style="padding: 1rem 2rem; font-size: 0.95rem; font-weight: 500; color: var(--text-secondary); border-bottom: 3px solid transparent; background: none; border-top: none; border-left: none; border-right: none; cursor: pointer; min-height: 3.5rem; display: flex; align-items: center;">
                <svg class="ucm-icon" width="20" height="20" style="margin-right: 8px;"><use href="#icon-inbox"/></svg>
                Manage
            </button>
        </div>

        <!-- Tab Content -->
        <div style="padding: 1.5rem;">
            <!-- TAB 1: Create Certificate -->
            <div id="tab-create" class="tab-content">
                <div id="create-with-ca" style="display: none;">
                    <div style="background: var(--success-bg); padding: 1rem; border-radius: 0.5rem; margin-bottom: 1.5rem; border-left: 4px solid var(--success-color);">
                        <strong style="color: var(--text-primary);">✓ Managed Certificate</strong>
                        <p style="color: var(--text-secondary); margin: 0.5rem 0 0 0; font-size: 0.875rem;">
                            Your certificate will be signed by: <strong id="ca-name-display"></strong>
                        </p>
                    </div>

                    <form id="create-managed-cert-form">
                        <div style="display: flex; flex-direction: column; gap: 1rem;">
                            <div>
                                <label class="form-label">Common Name (CN) *</label>
                                <input type="text" id="create_cn" class="form-input" placeholder="john.doe" required>
                                <small style="color: var(--text-secondary); font-size: 0.75rem;">Your username or identifier</small>
                            </div>

                            <div>
                                <label class="form-label">Email Address</label>
                                <input type="email" id="create_email" class="form-input" placeholder="john.doe@company.com">
                            </div>

                            <div>
                                <label class="form-label">Validity (days)</label>
                                <input type="number" id="create_validity" class="form-input" value="365" min="1" max="3650">
                            </div>

                            <div style="padding-top: 1rem; border-top: 1px solid var(--border-color);">
                                <button type="submit" class="btn-primary">
                                    <svg class="ucm-icon" width="16" height="16"><use href="#icon-key"/></svg>
                                    Generate Certificate
                                </button>
                            </div>
                        </div>
                    </form>
                </div>

                <div id="create-self-signed" style="display: none;">
                    <div style="background: var(--warning-bg); padding: 1rem; border-radius: 0.5rem; margin-bottom: 1.5rem; border-left: 4px solid var(--warning-color);">
                        <strong style="color: var(--text-primary);">⚠️ Self-Signed Certificate</strong>
                        <p style="color: var(--text-secondary); margin: 0.5rem 0 0 0; font-size: 0.875rem;">
                            Your certificate will be self-signed and not managed by UCM
                        </p>
                    </div>

                    <form id="create-selfsigned-cert-form">
                        <div style="display: flex; flex-direction: column; gap: 1rem;">
                            <div>
                                <label class="form-label">Common Name (CN) *</label>
                                <input type="text" id="selfsigned_cn" class="form-input" placeholder="john.doe" required>
                            </div>

                            <div>
                                <label class="form-label">Email Address</label>
                                <input type="email" id="selfsigned_email" class="form-input" placeholder="john.doe@company.com">
                            </div>

                            <div style="display: grid; grid-template-columns: 1fr 1fr; gap: 1rem;">
                                <div>
                                    <label class="form-label">Validity (days)</label>
                                    <input type="number" id="selfsigned_validity" class="form-input" value="365" min="1" max="3650">
                                </div>
                                <div>
                                    <label class="form-label">Key Size</label>
                                    <select id="selfsigned_keysize" class="form-input">
                                        <option value="2048">2048 bits</option>
                                        <option value="3072">3072 bits</option>
                                        <option value="4096" selected>4096 bits</option>
                                    </select>
                                </div>
                            </div>

                            <div style="padding-top: 1rem; border-top: 1px solid var(--border-color);">
                                <button type="submit" class="btn-primary">
                                    <svg class="ucm-icon" width="16" height="16"><use href="#icon-key"/></svg>
                                    Generate Self-Signed Certificate
                                </button>
                            </div>
                        </div>
                    </form>
                </div>
            </div>

            <!-- TAB 2: Import Certificate -->
            <div id="tab-import" class="tab-content" style="display: none;">
                <div id="import-info-ca" style="display: none; background: rgba(59, 130, 246, 0.1); padding: 1rem; border-radius: 0.5rem; margin-bottom: 1.5rem; border-left: 4px solid var(--info-color);">
                    <strong style="color: var(--text-primary);">ℹ️ Validation Required</strong>
                    <p style="color: var(--text-secondary); margin: 0.5rem 0 0 0; font-size: 0.875rem;">
                        Imported certificates must be signed by: <strong id="import-ca-name-display"></strong>
                    </p>
                </div>

                <div id="import-info-any" style="display: none; background: var(--warning-bg); padding: 1rem; border-radius: 0.5rem; margin-bottom: 1.5rem; border-left: 4px solid var(--warning-color);">
                    <strong style="color: var(--text-primary);">⚠️ Any Valid Certificate</strong>
                    <p style="color: var(--text-secondary); margin: 0.5rem 0 0 0; font-size: 0.875rem;">
                        You can import any valid X.509 certificate
                    </p>
                </div>

                <form id="import-cert-form">
                    <div style="display: flex; flex-direction: column; gap: 1rem;">
                        <div>
                            <label class="form-label">Certificate Name (Optional)</label>
                            <input type="text" id="import_name" class="form-input" placeholder="My YubiKey Certificate">
                            <small style="color: var(--text-secondary); font-size: 0.75rem;">Friendly name to identify this certificate</small>
                        </div>

                        <div>
                            <label class="form-label">Certificate (PEM format) *</label>
                            <textarea id="import_cert_pem" class="form-input" rows="12" 
                                      placeholder="-----BEGIN CERTIFICATE-----
...
-----END CERTIFICATE-----" required></textarea>
                        </div>

                        <div style="display: flex; gap: 1rem;">
                            <button type="button" onclick="validateImportedCert()" class="btn-outline-secondary">
                                <svg class="ucm-icon" width="16" height="16"><use href="#icon-check-circle"/></svg>
                                Validate Certificate
                            </button>
                            <button type="submit" class="btn-primary">
                                <svg class="ucm-icon" width="16" height="16"><use href="#icon-upload"/></svg>
                                Import Certificate
                            </button>
                        </div>
                    </div>
                </form>

                <div id="import-validation-result" style="margin-top: 1rem; display: none;"></div>
            </div>

            <!-- TAB 3: Manage Certificates -->
            <div id="tab-manage" class="tab-content" style="display: none;">
                <div class="table-responsive">
                    <table class="table">
                        <thead>
                            <tr>
                                <th>Name</th>
                                <th>Subject</th>
                                <th>Serial</th>
                                <th>Valid Until</th>
                                <th>Status</th>
                                <th>Actions</th>
                            </tr>
                        </thead>
                        <tbody id="certificates-tbody">
                            <tr>
                                <td colspan="6" style="text-align: center; padding: 2rem; color: var(--text-secondary);">
                                    <svg class="ucm-icon" width="32" height="32" style="opacity: 0.5;"><use href="#icon-key"/></svg>
                                    <p style="margin-top: 0.5rem;">Loading certificates...</p>
                                </td>
                            </tr>
                        </tbody>
                    </table>
                </div>
            </div>
        </div>
    </div>

    <!-- mTLS Disabled Message -->
    <div id="mtls-disabled-message" style="display: none;">
        <div class="card" style="padding: 0;">
            <div style="padding: 3rem; text-align: center;">
                <svg class="ucm-icon" width="64" height="64" style="opacity: 0.3; margin-bottom: 1rem;"><use href="#icon-shield-check"/></svg>
                <h3 style="color: var(--text-primary); margin-bottom: 0.5rem;">mTLS Authentication is Disabled</h3>
                <p style="color: var(--text-secondary);">
                    Contact your administrator to enable mTLS authentication.
                </p>
            </div>
        </div>
    </div>
</div>

<script>
(function() {
// Get token from meta tag
const getToken = () => document.querySelector('meta[name="access-token"]')?.content || '';
let currentSettings = {};

// Toast helper
function showToast(message, type = 'info') {
    const toast = document.createElement('div');
    toast.style.cssText = `
        position: fixed; top: 20px; right: 20px; z-index: 10000;
        padding: 1rem 1.5rem; border-radius: 0.5rem; box-shadow: 0 4px 12px rgba(0,0,0,0.15);
        background: ${type === 'success' ? 'var(--success-color)' : type === 'error' ? 'var(--danger-color)' : 'var(--info-color)'};
        color: white; font-weight: 500; max-width: 400px;
    `;
    toast.textContent = message;
    document.body.appendChild(toast);
    setTimeout(() => toast.remove(), 4000);
}



// Load mTLS settings and show section if enabled
async function loadMTLSSettings() {
    try {
        const response = await fetch('/api/v1/mtls/settings', {
            headers: {'Authorization': `Bearer ${getToken()}`}
        });
        
        if (response.ok) {
            currentSettings = await response.json();
            
            const infoDiv = document.getElementById('mtls-info');
            const infoText = document.getElementById('mtls-info-text');
            const certSection = document.getElementById('mtls-certificates-section');
            const disabledMessage = document.getElementById('mtls-disabled-message');
            
            if (currentSettings.enabled) {
                infoDiv.style.display = 'block';
                certSection.style.display = 'block';
                disabledMessage.style.display = 'none';
                
                // Update info text
                if (currentSettings.required) {
                    infoText.textContent = 'Client certificate authentication is REQUIRED. You must have a valid certificate to access UCM.';
                } else {
                    infoText.textContent = 'Client certificate authentication is optional. You can use either a certificate or password to login.';
                }
                
                updateUserSection();
            } else {
                infoDiv.style.display = 'none';
                certSection.style.display = 'none';
                disabledMessage.style.display = 'block';
            }
        }
    } catch (error) {
        console.error('Error loading mTLS settings:', error);
    }
}

// Update user section content based on CA configuration
async function updateUserSection() {
    const trustedCAId = currentSettings.trusted_ca_id;
    const createWithCA = document.getElementById('create-with-ca');
    const createSelfSigned = document.getElementById('create-self-signed');
    
    if (trustedCAId) {
        // Fetch CA details
        try {
            const response = await fetch(`/api/v1/ca/${trustedCAId}`, {
                headers: {'Authorization': `Bearer ${getToken()}`}
            });
            if (response.ok) {
                const ca = await response.json();
                document.getElementById('ca-name-display').textContent = ca.descr;
                document.getElementById('import-ca-name-display').textContent = ca.descr;
            }
        } catch (e) {
            console.error('Error fetching CA:', e);
        }
        
        createWithCA.style.display = 'block';
        createSelfSigned.style.display = 'none';
        document.getElementById('import-info-ca').style.display = 'block';
        document.getElementById('import-info-any').style.display = 'none';
    } else {
        createWithCA.style.display = 'none';
        createSelfSigned.style.display = 'block';
        document.getElementById('import-info-ca').style.display = 'none';
        document.getElementById('import-info-any').style.display = 'block';
    }
}

// Create managed certificate
document.getElementById('create-managed-cert-form')?.addEventListener('submit', async (e) => {
    e.preventDefault();
    
    const data = {
        cn: document.getElementById('create_cn').value,
        email: document.getElementById('create_email').value,
        validity_days: parseInt(document.getElementById('create_validity').value)
    };
    
    try {
        const response = await fetch('/api/v1/mtls/certificates/create', {
            method: 'POST',
            headers: {
                'Content-Type': 'application/json',
                'Authorization': `Bearer ${getToken()}`
            },
            body: JSON.stringify(data)
        });
        
        const result = await response.json();
        
        if (response.ok) {
            showToast('✓ Certificate created successfully', 'success');
            document.getElementById('create-managed-cert-form').reset();
            ucm_switchTab('manage'); loadCertificates();
        } else {
            showToast('✗ ' + (result.error || 'Failed to create certificate'), 'error');
        }
    } catch (error) {
        showToast('✗ Error: ' + error.message, 'error');
    }
});

// Create self-signed certificate
document.getElementById('create-selfsigned-cert-form')?.addEventListener('submit', async (e) => {
    e.preventDefault();
    
    const data = {
        cn: document.getElementById('selfsigned_cn').value,
        email: document.getElementById('selfsigned_email').value,
        validity_days: parseInt(document.getElementById('selfsigned_validity').value),
        key_size: parseInt(document.getElementById('selfsigned_keysize').value),
        self_signed: true
    };
    
    try {
        const response = await fetch('/api/v1/mtls/certificates/create', {
            method: 'POST',
            headers: {
                'Content-Type': 'application/json',
                'Authorization': `Bearer ${getToken()}`
            },
            body: JSON.stringify(data)
        });
        
        const result = await response.json();
        
        if (response.ok) {
            showToast('✓ Self-signed certificate created', 'success');
            document.getElementById('create-selfsigned-cert-form').reset();
            ucm_switchTab('manage'); loadCertificates();
        } else {
            showToast('✗ ' + (result.error || 'Failed to create certificate'), 'error');
        }
    } catch (error) {
        showToast('✗ Error: ' + error.message, 'error');
    }
});

// Validate imported certificate
window.validateImportedCert = async function() {
    const certPem = document.getElementById('import_cert_pem').value;
    
    if (!certPem) {
        showToast('Please paste a certificate first', 'error');
        return;
    }
    
    try {
        const response = await fetch('/api/v1/mtls/validate-certificate', {
            method: 'POST',
            headers: {
                'Content-Type': 'application/json',
                'Authorization': `Bearer ${getToken()}`
            },
            body: JSON.stringify({certificate: certPem})
        });
        
        const result = await response.json();
        const resultDiv = document.getElementById('import-validation-result');
        
        if (response.ok && result.success) {
            const info = result.info;
            resultDiv.style.display = 'block';
            resultDiv.innerHTML = `
                <div style="background: ${result.valid ? 'var(--success-bg)' : 'var(--danger-bg)'}; padding: 1rem; border-radius: 0.5rem; border-left: 4px solid ${result.valid ? 'var(--success-color)' : 'var(--danger-color)'};">
                    <strong>${result.valid ? '✓ Valid Certificate' : '✗ Invalid Certificate'}</strong>
                    ${result.already_enrolled ? '<p style="color: var(--warning-color); margin-top: 0.5rem;"><strong>⚠️ Certificate already enrolled</strong></p>' : ''}
                    <div style="margin-top: 1rem; font-size: 0.875rem;">
                        <p><strong>Subject:</strong> ${info.subject}</p>
                        <p><strong>Issuer:</strong> ${info.issuer}</p>
                        <p><strong>Serial:</strong> <code>${info.serial}</code></p>
                        <p><strong>Valid Until:</strong> ${info.valid_until ? new Date(info.valid_until).toLocaleString() : 'N/A'}</p>
                    </div>
                </div>
            `;
        } else {
            resultDiv.style.display = 'block';
            resultDiv.innerHTML = `
                <div style="background: var(--danger-bg); padding: 1rem; border-radius: 0.5rem; border-left: 4px solid var(--danger-color);">
                    <strong>✗ Validation Failed</strong>
                    <p style="margin-top: 0.5rem;">${result.error || 'Unknown error'}</p>
                </div>
            `;
        }
    } catch (error) {
        showToast('✗ Validation error: ' + error.message, 'error');
    }
};

// Import certificate
document.getElementById('import-cert-form')?.addEventListener('submit', async (e) => {
    e.preventDefault();
    
    const data = {
        certificate: document.getElementById('import_cert_pem').value,
        name: document.getElementById('import_name').value
    };
    
    try {
        const response = await fetch('/api/v1/mtls/certificates/enroll', {
            method: 'POST',
            headers: {
                'Content-Type': 'application/json',
                'Authorization': `Bearer ${getToken()}`
            },
            body: JSON.stringify(data)
        });
        
        const result = await response.json();
        
        if (response.ok) {
            showToast('✓ Certificate imported successfully', 'success');
            document.getElementById('import-cert-form').reset();
            document.getElementById('import-validation-result').style.display = 'none';
            ucm_switchTab('manage'); loadCertificates();
        } else {
            showToast('✗ ' + (result.error || 'Failed to import certificate'), 'error');
        }
    } catch (error) {
        showToast('✗ Error: ' + error.message, 'error');
    }
});

// Load certificates
async function loadCertificates() {
    try {
        const response = await fetch('/api/v1/mtls/certificates', {
            headers: {'Authorization': `Bearer ${getToken()}`}
        });
        
        if (response.ok) {
            const data = await response.json();
            const tbody = document.getElementById('certificates-tbody');
            
            if (data.certificates.length === 0) {
                tbody.innerHTML = `
                    <tr>
                        <td colspan="6" style="text-align: center; padding: 2rem; color: var(--text-secondary);">
                            <svg class="ucm-icon" width="32" height="32" style="opacity: 0.5;"><use href="#icon-key"/></svg>
                            <p style="margin-top: 0.5rem;">No certificates enrolled</p>
                            <button onclick="ucm_switchTab('create')" class="btn-primary" style="margin-top: 1rem;">
                                <svg class="ucm-icon" width="16" height="16"><use href="#icon-plus"/></svg> Create Your First Certificate
                            </button>
                        </td>
                    </tr>
                `;
                return;
            }
            
            tbody.innerHTML = data.certificates.map(cert => {
                const validUntil = cert.valid_until ? new Date(cert.valid_until) : null;
                const isExpired = validUntil && validUntil < new Date();
                const daysLeft = validUntil ? Math.ceil((validUntil - new Date()) / (1000 * 60 * 60 * 24)) : null;
                
                // Escape user-controlled data to prevent XSS
                const safeName = escapeHtml(cert.name || 'Unnamed');
                const safeSubject = escapeHtml(cert.cert_subject);
                const safeSerial = escapeHtml(cert.cert_serial.substring(0, 16));
                
                return `
                    <tr>
                        <td><strong>${safeName}</strong></td>
                        <td style="max-width: 300px; overflow: hidden; text-overflow: ellipsis;">${safeSubject}</td>
                        <td><code style="font-size: 0.875rem;">${safeSerial}...</code></td>
                        <td>
                            ${validUntil ? validUntil.toLocaleDateString() : 'N/A'}
                            ${daysLeft !== null && daysLeft < 30 ? `<br><small style="color: var(--warning-color);">${daysLeft} days left</small>` : ''}
                        </td>
                        <td>
                            ${cert.enabled 
                                ? (isExpired 
                                    ? '<span class="badge-outline badge-danger"><svg class="ucm-icon" width="10" height="10"><use href="#icon-times"/></svg> Expired</span>'
                                    : '<span class="badge-outline badge-success"><svg class="ucm-icon" width="10" height="10"><use href="#icon-check"/></svg> Active</span>')
                                : '<span class="badge-outline badge-secondary"><svg class="ucm-icon" width="10" height="10"><use href="#icon-times"/></svg> Disabled</span>'
                            }
                        </td>
                        <td>
                            <div style="display: flex; gap: 0.5rem;">
                                <button onclick="downloadCertificate(${cert.id})" class="btn-outline-secondary" style="padding: 0.5rem;" title="Download">
                                    <svg class="ucm-icon" width="16" height="16"><use href="#icon-download"/></svg>
                                </button>
                                ${cert.enabled 
                                    ? `<button onclick="revokeCertificate(${cert.id})" class="btn-outline-warning" style="padding: 0.5rem;" title="Revoke">
                                        <svg class="ucm-icon" width="16" height="16"><use href="#icon-times"/></svg>
                                    </button>`
                                    : `<button onclick="enableCertificate(${cert.id})" class="btn-outline-success" style="padding: 0.5rem;" title="Enable">
                                        <svg class="ucm-icon" width="16" height="16"><use href="#icon-check"/></svg>
                                    </button>`
                                }
                                <button onclick="deleteCertificate(${cert.id})" class="btn-outline-danger" style="padding: 0.5rem;" title="Delete">
                                    <svg class="ucm-icon" width="16" height="16"><use href="#icon-trash"/></svg>
                                </button>
                            </div>
                        </td>
                    </tr>
                `;
            }).join('');
        }
    } catch (error) {
        console.error('Error loading certificates:', error);
    }
}

// Certificate actions
window.downloadCertificate = async function(certId) {
    try {
        const response = await fetch(`/api/v1/mtls/certificates/${certId}/download`, {
            headers: {'Authorization': `Bearer ${getToken()}`}
        });
        
        if (response.ok) {
            const blob = await response.blob();
            const url = window.URL.createObjectURL(blob);
            const a = document.createElement('a');
            a.href = url;
            a.download = `client-cert-${certId}.pem`;
            a.click();
            window.URL.revokeObjectURL(url);
        } else {
            showToast('✗ Failed to download certificate', 'error');
        }
    } catch (error) {
        showToast('✗ Error: ' + error.message, 'error');
    }
};

window.revokeCertificate = async function(certId) {
    const confirmed = await ucmConfirm(
        'Are you sure you want to revoke this certificate? You can re-enable it later.',
        'Revoke Certificate',
        { danger: true, confirmText: 'Revoke', icon: 'warning-triangle' }
    );
    
    if (!confirmed) return;
    
    try {
        const response = await fetch(`/api/v1/mtls/certificates/${certId}/revoke`, {
            method: 'POST',
            headers: {'Authorization': `Bearer ${getToken()}`}
        });
        
        if (response.ok) {
            showToast('✓ Certificate revoked', 'success');
            loadCertificates();
        } else {
            showToast('✗ Failed to revoke', 'error');
        }
    } catch (error) {
        showToast('✗ Error: ' + error.message, 'error');
    }
};

window.enableCertificate = async function(certId) {
    try {
        const response = await fetch(`/api/v1/mtls/certificates/${certId}/enable`, {
            method: 'POST',
            headers: {'Authorization': `Bearer ${getToken()}`}
        });
        
        if (response.ok) {
            showToast('✓ Certificate enabled', 'success');
            loadCertificates();
        } else {
            showToast('✗ Failed to enable', 'error');
        }
    } catch (error) {
        showToast('✗ Error: ' + error.message, 'error');
    }
};

window.deleteCertificate = async function(certId) {
    const confirmed = await ucmConfirm(
        'Are you sure you want to permanently delete this certificate? This action cannot be undone.',
        'Delete Certificate',
        { danger: true, confirmText: 'Delete', icon: 'trash' }
    );
    
    if (!confirmed) return;
    
    try {
        const response = await fetch(`/api/v1/mtls/certificates/${certId}`, {
            method: 'DELETE',
            headers: {'Authorization': `Bearer ${getToken()}`}
        });
        
        if (response.ok) {
            showToast('✓ Certificate deleted', 'success');
            loadCertificates();
        } else {
            showToast('✗ Failed to delete', 'error');
        }
    } catch (error) {
        showToast('✗ Error: ' + error.message, 'error');
    }
};

// Initialize mTLS section
loadMTLSSettings();
})();
</script>
{% endblock %}

{% extends "base.html" %}

{% block title %}My Account - UCM{% endblock %}

{% block content %}
<div style="display: flex; flex-direction: column; gap: 1.5rem;">
    <div style="display: flex; justify-content: space-between; align-items: center;">
        <h1 style="font-size: 1.875rem; font-weight: bold; color: var(--text-primary);">
            <svg class="ucm-icon" width="24" height="24" style="margin-right: 0.5rem;"><use href="#icon-user"/></svg> My Account
        </h1>
    </div>
    
    <!-- User Profile -->
    <div class="card">
        <div style="padding: 1.5rem; border-bottom: 1px solid var(--border-color);">
            <h2 style="font-size: 1.25rem; font-weight: 600; color: var(--text-primary); display: flex; align-items: center; gap: 0.5rem;">
                <svg class="ucm-icon" width="20" height="20" style="color: var(--primary-color);"><use href="#icon-user"/></svg>
                Profile Information
            </h2>
        </div>
        <div style="padding: 1.5rem;">
            <div style="display: grid; grid-template-columns: repeat(auto-fit, minmax(300px, 1fr)); gap: 1.5rem;">
                <div>
                    <label style="display: block; font-size: 0.875rem; font-weight: 500; color: var(--text-primary); margin-bottom: 0.5rem;">Username</label>
                    <div style="display: flex; align-items: center; gap: 0.75rem;">
                        <svg class="ucm-icon" width="24" height="24" style="color: var(--primary-color);"><use href="#icon-user"/></svg>
                        <span style="font-size: 1.125rem; font-weight: 600; color: var(--text-primary);">{{ session.get('username', 'N/A') }}</span>
                    </div>
                </div>
                <div>
                    <label style="display: block; font-size: 0.875rem; font-weight: 500; color: var(--text-primary); margin-bottom: 0.5rem;">Role</label>
                    <div style="display: flex; align-items: center; gap: 0.75rem;">
                        {% if session.get('role') == 'admin' %}
                        <span class="badge-outline badge-primary">
                            <svg class="ucm-icon" width="12" height="12"><use href="#icon-shield-check"/></svg>
                            Administrator
                        </span>
                        {% else %}
                        <span class="badge-outline badge-info">
                            <svg class="ucm-icon" width="12" height="12"><use href="#icon-eye"/></svg>
                            {{ session.get('role', 'viewer').title() }}
                        </span>
                        {% endif %}
                    </div>
                </div>
            </div>
        </div>
    </div>
    
    <!-- Password Change -->
    <div class="card">
        <div style="padding: 1.5rem; border-bottom: 1px solid var(--border-color);">
            <h2 style="font-size: 1.25rem; font-weight: 600; color: var(--text-primary); display: flex; align-items: center; gap: 0.5rem;">
                <svg class="ucm-icon" width="20" height="20" style="color: var(--primary-color);"><use href="#icon-key"/></svg>
                Change Password
            </h2>
        </div>
        <div style="padding: 1.5rem;">
            <form id="change-password-form" style="display: flex; flex-direction: column; gap: 1rem;">
                <div>
                    <label class="form-label">Current Password</label>
                    <input type="password" id="current-password" class="form-input" placeholder="Enter current password" required>
                </div>
                <div>
                    <label class="form-label">New Password</label>
                    <input type="password" id="new-password" class="form-input" placeholder="Enter new password" required minlength="8">
                </div>
                <div>
                    <label class="form-label">Confirm New Password</label>
                    <input type="password" id="confirm-password" class="form-input" placeholder="Confirm new password" required>
                </div>
                <div style="padding-top: 0.5rem;">
                    <button type="submit" class="btn-primary">
                        <svg class="ucm-icon" width="16" height="16" style="margin-right: 0.5rem;"><use href="#icon-check"/></svg>
                        Update Password
                    </button>
                </div>
            </form>
        </div>
    </div>
    
    <!-- Theme Preferences -->
    <div class="card">
        <div style="padding: 1.5rem; border-bottom: 1px solid var(--border-color);">
            <h2 style="font-size: 1.25rem; font-weight: 600; color: var(--text-primary); display: flex; align-items: center; gap: 0.5rem;">
                <svg class="ucm-icon" width="20" height="20" style="color: var(--primary-color);"><use href="#icon-palette"/></svg>
                Theme Preferences
            </h2>
        </div>
        <div style="padding: 1.5rem;">
            <p style="font-size: 0.875rem; color: var(--text-secondary); margin-bottom: 1.5rem;">
                Current theme: <span id="current-theme-name" style="font-weight: 600; color: var(--text-primary);"></span>
            </p>
            <div style="display: grid; grid-template-columns: repeat(auto-fit, minmax(280px, 1fr)); gap: 1.5rem;">
                <!-- Sentinel Light -->
                <button data-action="set-theme" data-theme="sentinel-light" style="all: unset; cursor: pointer; position: relative; border-radius: 0.75rem; overflow: hidden; border: 2px solid var(--border-color); transition: all 0.2s;" onmouseover="this.style.borderColor='#3b82f6'; this.style.transform='translateY(-2px)'; this.style.boxShadow='0 8px 16px rgba(59,130,246,0.2)'" onmouseout="this.style.borderColor='var(--border-color)'; this.style.transform='translateY(0)'; this.style.boxShadow='none'">
                    <div style="padding: 1rem; background: #f8fafc;">
                        <div style="display: flex; align-items: center; justify-content: space-between; margin-bottom: 0.75rem;">
                            <div style="display: flex; align-items: center; gap: 0.5rem;">
                                <svg width="16" height="16" style="color: #3b82f6;"><use href="#icon-sun"/></svg>
                                <span style="font-weight: 600; color: #1e293b; font-size: 0.875rem;">Sentinel Light</span>
                            </div>
                            <div style="width: 20px; height: 20px; border-radius: 50%; background: linear-gradient(135deg, #3b82f6, #2563eb);"></div>
                        </div>
                        <div style="background: #ffffff; border-radius: 0.5rem; padding: 0.75rem; border: 1px solid #e2e8f0; box-shadow: 0 1px 3px rgba(0,0,0,0.05);">
                            <div style="display: flex; gap: 0.5rem; margin-bottom: 0.5rem;">
                                <div style="flex: 1; height: 1.5rem; background: #3b82f6; border-radius: 0.25rem;"></div>
                                <div style="flex: 1; height: 1.5rem; background: #e2e8f0; border-radius: 0.25rem;"></div>
                            </div>
                            <div style="height: 0.75rem; background: #cbd5e1; border-radius: 0.25rem; margin-bottom: 0.375rem;"></div>
                            <div style="height: 0.75rem; background: #e2e8f0; border-radius: 0.25rem; width: 70%;"></div>
                        </div>
                    </div>
                </button>

                <!-- Sentinel Dark -->
                <button data-action="set-theme" data-theme="sentinel-dark" style="all: unset; cursor: pointer; position: relative; border-radius: 0.75rem; overflow: hidden; border: 2px solid var(--border-color); transition: all 0.2s;" onmouseover="this.style.borderColor='#3b82f6'; this.style.transform='translateY(-2px)'; this.style.boxShadow='0 8px 16px rgba(59,130,246,0.2)'" onmouseout="this.style.borderColor='var(--border-color)'; this.style.transform='translateY(0)'; this.style.boxShadow='none'">
                    <div style="padding: 1rem; background: #0f172a;">
                        <div style="display: flex; align-items: center; justify-content: space-between; margin-bottom: 0.75rem;">
                            <div style="display: flex; align-items: center; gap: 0.5rem;">
                                <svg width="16" height="16" style="color: #60a5fa;"><use href="#icon-moon"/></svg>
                                <span style="font-weight: 600; color: #f1f5f9; font-size: 0.875rem;">Sentinel Dark</span>
                            </div>
                            <div style="width: 20px; height: 20px; border-radius: 50%; background: linear-gradient(135deg, #3b82f6, #2563eb);"></div>
                        </div>
                        <div style="background: #1e293b; border-radius: 0.5rem; padding: 0.75rem; border: 1px solid #334155;">
                            <div style="display: flex; gap: 0.5rem; margin-bottom: 0.5rem;">
                                <div style="flex: 1; height: 1.5rem; background: #3b82f6; border-radius: 0.25rem;"></div>
                                <div style="flex: 1; height: 1.5rem; background: #334155; border-radius: 0.25rem;"></div>
                            </div>
                            <div style="height: 0.75rem; background: #475569; border-radius: 0.25rem; margin-bottom: 0.375rem;"></div>
                            <div style="height: 0.75rem; background: #334155; border-radius: 0.25rem; width: 70%;"></div>
                        </div>
                    </div>
                </button>

                <!-- Amber Light -->
                <button data-action="set-theme" data-theme="amber-light" style="all: unset; cursor: pointer; position: relative; border-radius: 0.75rem; overflow: hidden; border: 2px solid var(--border-color); transition: all 0.2s;" onmouseover="this.style.borderColor='#f97316'; this.style.transform='translateY(-2px)'; this.style.boxShadow='0 8px 16px rgba(249,115,22,0.2)'" onmouseout="this.style.borderColor='var(--border-color)'; this.style.transform='translateY(0)'; this.style.boxShadow='none'">
                    <div style="padding: 1rem; background: #fffbeb;">
                        <div style="display: flex; align-items: center; justify-content: space-between; margin-bottom: 0.75rem;">
                            <div style="display: flex; align-items: center; gap: 0.5rem;">
                                <svg width="16" height="16" style="color: #f97316;"><use href="#icon-sun"/></svg>
                                <span style="font-weight: 600; color: #78350f; font-size: 0.875rem;">Amber Light</span>
                            </div>
                            <div style="width: 20px; height: 20px; border-radius: 50%; background: linear-gradient(135deg, #f97316, #ea580c);"></div>
                        </div>
                        <div style="background: #ffffff; border-radius: 0.5rem; padding: 0.75rem; border: 1px solid #fed7aa; box-shadow: 0 1px 3px rgba(0,0,0,0.05);">
                            <div style="display: flex; gap: 0.5rem; margin-bottom: 0.5rem;">
                                <div style="flex: 1; height: 1.5rem; background: #f97316; border-radius: 0.25rem;"></div>
                                <div style="flex: 1; height: 1.5rem; background: #fed7aa; border-radius: 0.25rem;"></div>
                            </div>
                            <div style="height: 0.75rem; background: #fde68a; border-radius: 0.25rem; margin-bottom: 0.375rem;"></div>
                            <div style="height: 0.75rem; background: #fed7aa; border-radius: 0.25rem; width: 70%;"></div>
                        </div>
                    </div>
                </button>

                <!-- Amber Dark -->
                <button data-action="set-theme" data-theme="amber-dark" style="all: unset; cursor: pointer; position: relative; border-radius: 0.75rem; overflow: hidden; border: 2px solid var(--border-color); transition: all 0.2s;" onmouseover="this.style.borderColor='#f97316'; this.style.transform='translateY(-2px)'; this.style.boxShadow='0 8px 16px rgba(249,115,22,0.2)'" onmouseout="this.style.borderColor='var(--border-color)'; this.style.transform='translateY(0)'; this.style.boxShadow='none'">
                    <div style="padding: 1rem; background: #1c1917;">
                        <div style="display: flex; align-items: center; justify-content: space-between; margin-bottom: 0.75rem;">
                            <div style="display: flex; align-items: center; gap: 0.5rem;">
                                <svg width="16" height="16" style="color: #fb923c;"><use href="#icon-moon"/></svg>
                                <span style="font-weight: 600; color: #fef3c7; font-size: 0.875rem;">Amber Dark</span>
                            </div>
                            <div style="width: 20px; height: 20px; border-radius: 50%; background: linear-gradient(135deg, #f97316, #ea580c);"></div>
                        </div>
                        <div style="background: #292524; border-radius: 0.5rem; padding: 0.75rem; border: 1px solid #44403c;">
                            <div style="display: flex; gap: 0.5rem; margin-bottom: 0.5rem;">
                                <div style="flex: 1; height: 1.5rem; background: #f97316; border-radius: 0.25rem;"></div>
                                <div style="flex: 1; height: 1.5rem; background: #44403c; border-radius: 0.25rem;"></div>
                            </div>
                            <div style="height: 0.75rem; background: #57534e; border-radius: 0.25rem; margin-bottom: 0.375rem;"></div>
                            <div style="height: 0.75rem; background: #44403c; border-radius: 0.25rem; width: 70%;"></div>
                        </div>
                    </div>
                </button>

                <!-- Blossom Light -->
                <button data-action="set-theme" data-theme="blossom-light" style="all: unset; cursor: pointer; position: relative; border-radius: 0.75rem; overflow: hidden; border: 2px solid var(--border-color); transition: all 0.2s;" onmouseover="this.style.borderColor='#ec4899'; this.style.transform='translateY(-2px)'; this.style.boxShadow='0 8px 16px rgba(236,72,153,0.2)'" onmouseout="this.style.borderColor='var(--border-color)'; this.style.transform='translateY(0)'; this.style.boxShadow='none'">
                    <div style="padding: 1rem; background: #fdf2f8;">
                        <div style="display: flex; align-items: center; justify-content: space-between; margin-bottom: 0.75rem;">
                            <div style="display: flex; align-items: center; gap: 0.5rem;">
                                <svg width="16" height="16" style="color: #ec4899;"><use href="#icon-sun"/></svg>
                                <span style="font-weight: 600; color: #831843; font-size: 0.875rem;">Blossom Light</span>
                            </div>
                            <div style="width: 20px; height: 20px; border-radius: 50%; background: linear-gradient(135deg, #ec4899, #db2777);"></div>
                        </div>
                        <div style="background: #ffffff; border-radius: 0.5rem; padding: 0.75rem; border: 1px solid #fbcfe8; box-shadow: 0 1px 3px rgba(0,0,0,0.05);">
                            <div style="display: flex; gap: 0.5rem; margin-bottom: 0.5rem;">
                                <div style="flex: 1; height: 1.5rem; background: #ec4899; border-radius: 0.25rem;"></div>
                                <div style="flex: 1; height: 1.5rem; background: #fbcfe8; border-radius: 0.25rem;"></div>
                            </div>
                            <div style="height: 0.75rem; background: #f9a8d4; border-radius: 0.25rem; margin-bottom: 0.375rem;"></div>
                            <div style="height: 0.75rem; background: #fbcfe8; border-radius: 0.25rem; width: 70%;"></div>
                        </div>
                    </div>
                </button>

                <!-- Blossom Dark -->
                <button data-action="set-theme" data-theme="blossom-dark" style="all: unset; cursor: pointer; position: relative; border-radius: 0.75rem; overflow: hidden; border: 2px solid var(--border-color); transition: all 0.2s;" onmouseover="this.style.borderColor='#ec4899'; this.style.transform='translateY(-2px)'; this.style.boxShadow='0 8px 16px rgba(236,72,153,0.2)'" onmouseout="this.style.borderColor='var(--border-color)'; this.style.transform='translateY(0)'; this.style.boxShadow='none'">
                    <div style="padding: 1rem; background: #1e1b20;">
                        <div style="display: flex; align-items: center; justify-content: space-between; margin-bottom: 0.75rem;">
                            <div style="display: flex; align-items: center; gap: 0.5rem;">
                                <svg width="16" height="16" style="color: #f472b6;"><use href="#icon-moon"/></svg>
                                <span style="font-weight: 600; color: #fce7f3; font-size: 0.875rem;">Blossom Dark</span>
                            </div>
                            <div style="width: 20px; height: 20px; border-radius: 50%; background: linear-gradient(135deg, #ec4899, #db2777);"></div>
                        </div>
                        <div style="background: #2d1b28; border-radius: 0.5rem; padding: 0.75rem; border: 1px solid #4a2640;">
                            <div style="display: flex; gap: 0.5rem; margin-bottom: 0.5rem;">
                                <div style="flex: 1; height: 1.5rem; background: #ec4899; border-radius: 0.25rem;"></div>
                                <div style="flex: 1; height: 1.5rem; background: #4a2640; border-radius: 0.25rem;"></div>
                            </div>
                            <div style="height: 0.75rem; background: #5e3450; border-radius: 0.25rem; margin-bottom: 0.375rem;"></div>
                            <div style="height: 0.75rem; background: #4a2640; border-radius: 0.25rem; width: 70%;"></div>
                        </div>
                    </div>
                </button>

                <!-- Nebula Light -->
                <button data-action="set-theme" data-theme="nebula-light" style="all: unset; cursor: pointer; position: relative; border-radius: 0.75rem; overflow: hidden; border: 2px solid var(--border-color); transition: all 0.2s;" onmouseover="this.style.borderColor='#8b5cf6'; this.style.transform='translateY(-2px)'; this.style.boxShadow='0 8px 16px rgba(139,92,246,0.2)'" onmouseout="this.style.borderColor='var(--border-color)'; this.style.transform='translateY(0)'; this.style.boxShadow='none'">
                    <div style="padding: 1rem; background: #faf5ff;">
                        <div style="display: flex; align-items: center; justify-content: space-between; margin-bottom: 0.75rem;">
                            <div style="display: flex; align-items: center; gap: 0.5rem;">
                                <svg width="16" height="16" style="color: #8b5cf6;"><use href="#icon-sun"/></svg>
                                <span style="font-weight: 600; color: #581c87; font-size: 0.875rem;">Nebula Light</span>
                            </div>
                            <div style="width: 20px; height: 20px; border-radius: 50%; background: linear-gradient(135deg, #8b5cf6, #7c3aed);"></div>
                        </div>
                        <div style="background: #ffffff; border-radius: 0.5rem; padding: 0.75rem; border: 1px solid #e9d5ff; box-shadow: 0 1px 3px rgba(0,0,0,0.05);">
                            <div style="display: flex; gap: 0.5rem; margin-bottom: 0.5rem;">
                                <div style="flex: 1; height: 1.5rem; background: #8b5cf6; border-radius: 0.25rem;"></div>
                                <div style="flex: 1; height: 1.5rem; background: #e9d5ff; border-radius: 0.25rem;"></div>
                            </div>
                            <div style="height: 0.75rem; background: #d8b4fe; border-radius: 0.25rem; margin-bottom: 0.375rem;"></div>
                            <div style="height: 0.75rem; background: #e9d5ff; border-radius: 0.25rem; width: 70%;"></div>
                        </div>
                    </div>
                </button>

                <!-- Nebula Dark -->
                <button data-action="set-theme" data-theme="nebula-dark" style="all: unset; cursor: pointer; position: relative; border-radius: 0.75rem; overflow: hidden; border: 2px solid var(--border-color); transition: all 0.2s;" onmouseover="this.style.borderColor='#8b5cf6'; this.style.transform='translateY(-2px)'; this.style.boxShadow='0 8px 16px rgba(139,92,246,0.2)'" onmouseout="this.style.borderColor='var(--border-color)'; this.style.transform='translateY(0)'; this.style.boxShadow='none'">
                    <div style="padding: 1rem; background: #1e1b2e;">
                        <div style="display: flex; align-items: center; justify-content: space-between; margin-bottom: 0.75rem;">
                            <div style="display: flex; align-items: center; gap: 0.5rem;">
                                <svg width="16" height="16" style="color: #a78bfa;"><use href="#icon-moon"/></svg>
                                <span style="font-weight: 600; color: #e9d5ff; font-size: 0.875rem;">Nebula Dark</span>
                            </div>
                            <div style="width: 20px; height: 20px; border-radius: 50%; background: linear-gradient(135deg, #8b5cf6, #7c3aed);"></div>
                        </div>
                        <div style="background: #2e1f47; border-radius: 0.5rem; padding: 0.75rem; border: 1px solid #4c3565;">
                            <div style="display: flex; gap: 0.5rem; margin-bottom: 0.5rem;">
                                <div style="flex: 1; height: 1.5rem; background: #8b5cf6; border-radius: 0.25rem;"></div>
                                <div style="flex: 1; height: 1.5rem; background: #4c3565; border-radius: 0.25rem;"></div>
                            </div>
                            <div style="height: 0.75rem; background: #5e4578; border-radius: 0.25rem; margin-bottom: 0.375rem;"></div>
                            <div style="height: 0.75rem; background: #4c3565; border-radius: 0.25rem; width: 70%;"></div>
                        </div>
                    </div>
                </button>
            </div>
        </div>
    </div>
    
    <!-- mTLS Certificates -->
    <div id="mtls-section" class="card" style="display: none;">
        <div style="padding: 1.5rem; border-bottom: 1px solid var(--border-color);">
            <h2 style="font-size: 1.25rem; font-weight: 600; color: var(--text-primary); display: flex; align-items: center; gap: 0.5rem; margin: 0;">
                <svg class="ucm-icon" width="20" height="20" style="color: var(--primary-color);"><use href="#icon-key"/></svg>
                mTLS Client Certificates
            </h2>
        </div>

        <!-- Tabs -->
        <div style="border-bottom: 1px solid var(--border-color); padding: 0 1.5rem; display: flex; gap: 0.5rem;">
            <button class="mtls-tab-button active" data-tab="create" style="padding: 1rem 1.5rem; border: none; background: none; color: var(--text-secondary); cursor: pointer; border-bottom: 2px solid transparent; font-weight: 500;">
                <svg class="ucm-icon" width="16" height="16" style="margin-right: 0.5rem;"><use href="#icon-plus"/></svg>
                Create
            </button>
            <button class="mtls-tab-button" data-tab="import" style="padding: 1rem 1.5rem; border: none; background: none; color: var(--text-secondary); cursor: pointer; border-bottom: 2px solid transparent; font-weight: 500;">
                <svg class="ucm-icon" width="16" height="16" style="margin-right: 0.5rem;"><use href="#icon-upload"/></svg>
                Import
            </button>
            <button class="mtls-tab-button" data-tab="manage" style="padding: 1rem 1.5rem; border: none; background: none; color: var(--text-secondary); cursor: pointer; border-bottom: 2px solid transparent; font-weight: 500;">
                <svg class="ucm-icon" width="16" height="16" style="margin-right: 0.5rem;"><use href="#icon-list"/></svg>
                Manage
            </button>
        </div>

        <!-- Tab Content -->
        <div style="padding: 1.5rem;">
            <!-- TAB 1: Create Certificate -->
            <div id="mtls-tab-create" class="mtls-tab-content">
                <div id="create-with-ca" style="display: none;">
                    <div style="background: var(--success-bg); padding: 1rem; border-radius: 0.5rem; margin-bottom: 1.5rem; border-left: 4px solid var(--success-color);">
                        <strong style="color: var(--text-primary);">✓ Managed Certificate</strong>
                        <p style="color: var(--text-secondary); margin: 0.5rem 0 0 0; font-size: 0.875rem;">
                            Your certificate will be signed by: <strong id="ca-name-display"></strong>
                        </p>
                    </div>

                    <form id="create-managed-cert-form">
                        <div style="display: flex; flex-direction: column; gap: 1rem;">
                            <div>
                                <label class="form-label">Common Name (CN) *</label>
                                <input type="text" id="create_cn" class="form-input" placeholder="john.doe" required>
                                <small style="color: var(--text-secondary); font-size: 0.75rem;">Your username or identifier</small>
                            </div>

                            <div>
                                <label class="form-label">Email Address</label>
                                <input type="email" id="create_email" class="form-input" placeholder="john.doe@company.com">
                            </div>

                            <div>
                                <label class="form-label">Validity (days)</label>
                                <input type="number" id="create_validity" class="form-input" value="365" min="1" max="3650">
                            </div>

                            <div style="padding-top: 1rem; border-top: 1px solid var(--border-color);">
                                <button type="submit" class="btn-primary">
                                    <svg class="ucm-icon" width="16" height="16" style="margin-right: 0.5rem;"><use href="#icon-key"/></svg>
                                    Generate Certificate
                                </button>
                            </div>
                        </div>
                    </form>
                </div>

                <div id="create-self-signed" style="display: none;">
                    <div style="background: var(--warning-bg); padding: 1rem; border-radius: 0.5rem; margin-bottom: 1.5rem; border-left: 4px solid var(--warning-color);">
                        <strong style="color: var(--text-primary);">⚠️ Self-Signed Certificate</strong>
                        <p style="color: var(--text-secondary); margin: 0.5rem 0 0 0; font-size: 0.875rem;">
                            Your certificate will be self-signed and not managed by UCM
                        </p>
                    </div>

                    <form id="create-selfsigned-cert-form">
                        <div style="display: flex; flex-direction: column; gap: 1rem;">
                            <div>
                                <label class="form-label">Common Name (CN) *</label>
                                <input type="text" id="selfsigned_cn" class="form-input" placeholder="john.doe" required>
                            </div>

                            <div>
                                <label class="form-label">Email Address</label>
                                <input type="email" id="selfsigned_email" class="form-input" placeholder="john.doe@company.com">
                            </div>

                            <div style="display: grid; grid-template-columns: 1fr 1fr; gap: 1rem;">
                                <div>
                                    <label class="form-label">Validity (days)</label>
                                    <input type="number" id="selfsigned_validity" class="form-input" value="365" min="1" max="3650">
                                </div>
                                <div>
                                    <label class="form-label">Key Size</label>
                                    <select id="selfsigned_keysize" class="form-input">
                                        <option value="2048">2048 bits</option>
                                        <option value="3072">3072 bits</option>
                                        <option value="4096" selected>4096 bits</option>
                                    </select>
                                </div>
                            </div>

                            <div style="padding-top: 1rem; border-top: 1px solid var(--border-color);">
                                <button type="submit" class="btn-primary">
                                    <svg class="ucm-icon" width="16" height="16" style="margin-right: 0.5rem;"><use href="#icon-key"/></svg>
                                    Generate Self-Signed Certificate
                                </button>
                            </div>
                        </div>
                    </form>
                </div>
            </div>

            <!-- TAB 2: Import Certificate -->
            <div id="mtls-tab-import" class="mtls-tab-content" style="display: none;">
                <div id="import-info-ca" style="display: none; background: var(--info-bg); padding: 1rem; border-radius: 0.5rem; margin-bottom: 1.5rem; border-left: 4px solid var(--info-color);">
                    <strong style="color: var(--text-primary);">ℹ️ Validation Required</strong>
                    <p style="color: var(--text-secondary); margin: 0.5rem 0 0 0; font-size: 0.875rem;">
                        Imported certificates must be signed by: <strong id="import-ca-name-display"></strong>
                    </p>
                </div>

                <div id="import-info-any" style="display: none; background: var(--warning-bg); padding: 1rem; border-radius: 0.5rem; margin-bottom: 1.5rem; border-left: 4px solid var(--warning-color);">
                    <strong style="color: var(--text-primary);">⚠️ Any Valid Certificate</strong>
                    <p style="color: var(--text-secondary); margin: 0.5rem 0 0 0; font-size: 0.875rem;">
                        You can import any valid X.509 certificate
                    </p>
                </div>

                <form id="import-cert-form">
                    <div style="display: flex; flex-direction: column; gap: 1rem;">
                        <div>
                            <label class="form-label">Certificate Name (Optional)</label>
                            <input type="text" id="import_name" class="form-input" placeholder="My YubiKey Certificate">
                            <small style="color: var(--text-secondary); font-size: 0.75rem;">Friendly name to identify this certificate</small>
                        </div>

                        <div>
                            <label class="form-label">Certificate (PEM format) *</label>
                            <textarea id="import_cert_pem" class="form-input" rows="12" 
                                      placeholder="-----BEGIN CERTIFICATE-----
...
-----END CERTIFICATE-----" required></textarea>
                        </div>

                        <div style="display: flex; gap: 1rem;">
                            <button type="button" onclick="validateImportedCert()" class="btn-outline-secondary">
                                <svg class="ucm-icon" width="16" height="16" style="margin-right: 0.5rem;"><use href="#icon-check-circle"/></svg>
                                Validate Certificate
                            </button>
                            <button type="submit" class="btn-primary">
                                <svg class="ucm-icon" width="16" height="16" style="margin-right: 0.5rem;"><use href="#icon-upload"/></svg>
                                Import Certificate
                            </button>
                        </div>
                    </div>
                </form>

                <div id="import-validation-result" style="margin-top: 1rem; display: none;"></div>
            </div>

            <!-- TAB 3: Manage Certificates -->
            <div id="mtls-tab-manage" class="mtls-tab-content" style="display: none;">
                <div class="table-responsive">
                    <table class="table">
                        <thead>
                            <tr>
                                <th>Name</th>
                                <th>Subject</th>
                                <th>Serial</th>
                                <th>Valid Until</th>
                                <th>Status</th>
                                <th>Actions</th>
                            </tr>
                        </thead>
                        <tbody id="certificates-tbody">
                            <tr>
                                <td colspan="6" style="text-align: center; padding: 2rem; color: var(--text-secondary);">
                                    <svg class="ucm-icon" width="32" height="32" style="opacity: 0.5;"><use href="#icon-key"/></svg>
                                    <p style="margin-top: 0.5rem;">Loading certificates...</p>
                                </td>
                            </tr>
                        </tbody>
                    </table>
                </div>
            </div>
        </div>
    </div>

    <!-- Session Information -->
    <div class="card">
        <div style="padding: 1.5rem; border-bottom: 1px solid var(--border-color);">
            <h2 style="font-size: 1.25rem; font-weight: 600; color: var(--text-primary); display: flex; align-items: center; gap: 0.5rem;">
                <svg class="ucm-icon" width="20" height="20" style="color: var(--primary-color);"><use href="#icon-clock"/></svg>
                Session Information
            </h2>
        </div>
        <div style="padding: 1.5rem;">
            <div style="display: flex; flex-direction: column; gap: 1rem;">
                <div style="display: flex; justify-content: space-between; align-items: center;">
                    <span style="font-weight: 500; color: var(--text-secondary);">Session Status</span>
                    <span class="badge-outline badge-success">
                        <svg class="ucm-icon" width="12" height="12"><use href="#icon-check"/></svg>
                        Active
                    </span>
                </div>
                <div style="display: flex; justify-content: space-between; align-items: center;">
                    <span style="font-weight: 500; color: var(--text-secondary);">Login Method</span>
                    <span style="font-weight: 600; color: var(--text-primary);">Password</span>
                </div>
                <div style="padding-top: 0.5rem; border-top: 1px solid var(--border-color);">
                    <a href="/logout" class="btn-danger">
                        <svg class="ucm-icon" width="16" height="16" style="margin-right: 0.5rem;"><use href="#icon-logout"/></svg>
                        Logout
                    </a>
                </div>
            </div>
        </div>
    </div>
</div>

<script>
// Display current theme
document.addEventListener('DOMContentLoaded', function() {
    const theme = localStorage.getItem('ucm-theme') || 'sentinel-light';
    const [base, variant] = theme.split('-');
    const themeName = base.charAt(0).toUpperCase() + base.slice(1) + ' ' + 
                     variant.charAt(0).toUpperCase() + variant.slice(1);
    document.getElementById('current-theme-name').textContent = themeName;
});

// Handle password change form
document.getElementById('change-password-form').addEventListener('submit', function(e) {
    e.preventDefault();
    
    const currentPassword = document.getElementById('current-password').value;
    const newPassword = document.getElementById('new-password').value;
    const confirmPassword = document.getElementById('confirm-password').value;
    
    if (newPassword !== confirmPassword) {
        ucmAlert('New passwords do not match!', 'Error');
        return;
    }
    
    if (newPassword.length < 8) {
        ucmAlert('Password must be at least 8 characters long!', 'Error');
        return;
    }
    
    // TODO: Implement password change API call
    fetch('/api/auth/change-password', {
        method: 'POST',
        headers: {
            'Content-Type': 'application/json',
        },
        body: JSON.stringify({
            current_password: currentPassword,
            new_password: newPassword
        })
    })
    .then(response => response.json())
    .then(data => {
        if (data.success) {
            ucmAlert('Password changed successfully!', 'Success').then(() => {
                document.getElementById('change-password-form').reset();
            });
        } else {
            ucmAlert('Error: ' + (data.message || 'Failed to change password'), 'Error');
        }
    })
    .catch(error => {
        console.error('Error:', error);
        ucmAlert('An error occurred while changing password', 'Error');
    });
});

// ========================================
// mTLS Certificate Management
// ========================================
(function() {
// Get token from meta tag
const getToken = () => document.querySelector('meta[name="access-token"]')?.content || '';
let currentSettings = {};

// Toast helper
function showToast(message, type = 'info') {
    const toast = document.createElement('div');
    toast.style.cssText = `
        position: fixed; top: 20px; right: 20px; z-index: 10000;
        padding: 1rem 1.5rem; border-radius: 0.5rem; box-shadow: 0 4px 12px rgba(0,0,0,0.15);
        background: ${type === 'success' ? 'var(--success-color)' : type === 'error' ? 'var(--danger-color)' : 'var(--info-color)'};
        color: white; font-weight: 500; max-width: 400px;
    `;
    toast.textContent = message;
    document.body.appendChild(toast);
    setTimeout(() => toast.remove(), 4000);
}

// Tab switching
document.querySelectorAll('.mtls-tab-button').forEach(btn => {
    btn.addEventListener('click', () => {
        const tabName = btn.dataset.tab;
        
        // Mark that tab was manually set
        window.mtlsTabManuallySet = true;
        
        // Update buttons
        document.querySelectorAll('.mtls-tab-button').forEach(b => {
            b.classList.remove('active');
            b.style.color = 'var(--text-secondary)';
            b.style.borderBottomColor = 'transparent';
        });
        btn.classList.add('active');
        btn.style.color = 'var(--text-primary)';
        btn.style.borderBottomColor = 'var(--primary-color)';
        
        // Update content
        document.querySelectorAll('.mtls-tab-content').forEach(content => {
            content.style.display = 'none';
        });
        document.getElementById(`mtls-tab-${tabName}`).style.display = 'block';
        
        // Load certificates when switching to manage tab
        if (tabName === 'manage') {
            loadCertificates();
        }
    });
});

// Load mTLS settings and show section if enabled
async function loadMTLSSettings() {
    try {
        const response = await fetch('/api/v1/mtls/settings', {
            headers: {'Authorization': `Bearer ${getToken()}`}
        });
        
        if (response.ok) {
            currentSettings = await response.json();
            
            const mtlsSection = document.getElementById('mtls-section');
            if (currentSettings.enabled) {
                mtlsSection.style.display = 'block';
                updateUserSection();
            } else {
                mtlsSection.style.display = 'none';
            }
        }
    } catch (error) {
        console.error('Error loading mTLS settings:', error);
    }
}

// Update user section content based on CA configuration
async function updateUserSection() {
    const trustedCAId = currentSettings.trusted_ca_id;
    const createWithCA = document.getElementById('create-with-ca');
    const createSelfSigned = document.getElementById('create-self-signed');
    
    if (trustedCAId) {
        // Fetch CA details
        try {
            const response = await fetch(`/api/v1/ca/${trustedCAId}`, {
                headers: {'Authorization': `Bearer ${getToken()}`}
            });
            if (response.ok) {
                const ca = await response.json();
                document.getElementById('ca-name-display').textContent = ca.descr;
                document.getElementById('import-ca-name-display').textContent = ca.descr;
            }
        } catch (e) {
            console.error('Error fetching CA:', e);
        }
        
        createWithCA.style.display = 'block';
        createSelfSigned.style.display = 'none';
        document.getElementById('import-info-ca').style.display = 'block';
        document.getElementById('import-info-any').style.display = 'none';
    } else {
        createWithCA.style.display = 'none';
        createSelfSigned.style.display = 'block';
        document.getElementById('import-info-ca').style.display = 'none';
        document.getElementById('import-info-any').style.display = 'block';
    }
}

// Create managed certificate
document.getElementById('create-managed-cert-form')?.addEventListener('submit', async (e) => {
    e.preventDefault();
    
    const data = {
        cn: document.getElementById('create_cn').value,
        email: document.getElementById('create_email').value,
        validity_days: parseInt(document.getElementById('create_validity').value)
    };
    
    try {
        const response = await fetch('/api/v1/mtls/certificates/create', {
            method: 'POST',
            headers: {
                'Content-Type': 'application/json',
                'Authorization': `Bearer ${getToken()}`
            },
            body: JSON.stringify(data)
        });
        
        const result = await response.json();
        
        if (response.ok) {
            showToast('✓ Certificate created successfully', 'success');
            document.getElementById('create-managed-cert-form').reset();
            document.querySelector('.mtls-tab-button[data-tab="manage"]').click();
        } else {
            showToast('✗ ' + (result.error || 'Failed to create certificate'), 'error');
        }
    } catch (error) {
        showToast('✗ Error: ' + error.message, 'error');
    }
});

// Create self-signed certificate
document.getElementById('create-selfsigned-cert-form')?.addEventListener('submit', async (e) => {
    e.preventDefault();
    
    const data = {
        cn: document.getElementById('selfsigned_cn').value,
        email: document.getElementById('selfsigned_email').value,
        validity_days: parseInt(document.getElementById('selfsigned_validity').value),
        key_size: parseInt(document.getElementById('selfsigned_keysize').value),
        self_signed: true
    };
    
    try {
        const response = await fetch('/api/v1/mtls/certificates/create', {
            method: 'POST',
            headers: {
                'Content-Type': 'application/json',
                'Authorization': `Bearer ${getToken()}`
            },
            body: JSON.stringify(data)
        });
        
        const result = await response.json();
        
        if (response.ok) {
            showToast('✓ Self-signed certificate created', 'success');
            document.getElementById('create-selfsigned-cert-form').reset();
            document.querySelector('.mtls-tab-button[data-tab="manage"]').click();
        } else {
            showToast('✗ ' + (result.error || 'Failed to create certificate'), 'error');
        }
    } catch (error) {
        showToast('✗ Error: ' + error.message, 'error');
    }
});

// Validate imported certificate
window.validateImportedCert = async function() {
    const certPem = document.getElementById('import_cert_pem').value;
    
    if (!certPem) {
        showToast('Please paste a certificate first', 'error');
        return;
    }
    
    try {
        const response = await fetch('/api/v1/mtls/validate-certificate', {
            method: 'POST',
            headers: {
                'Content-Type': 'application/json',
                'Authorization': `Bearer ${getToken()}`
            },
            body: JSON.stringify({certificate: certPem})
        });
        
        const result = await response.json();
        const resultDiv = document.getElementById('import-validation-result');
        
        if (response.ok && result.success) {
            const info = result.info;
            resultDiv.style.display = 'block';
            resultDiv.innerHTML = `
                <div style="background: ${result.valid ? 'var(--success-bg)' : 'var(--danger-bg)'}; padding: 1rem; border-radius: 0.5rem; border-left: 4px solid ${result.valid ? 'var(--success-color)' : 'var(--danger-color)'};">
                    <strong>${result.valid ? '✓ Valid Certificate' : '✗ Invalid Certificate'}</strong>
                    ${result.already_enrolled ? '<p style="color: var(--warning-color); margin-top: 0.5rem;"><strong>⚠️ Certificate already enrolled</strong></p>' : ''}
                    <div style="margin-top: 1rem; font-size: 0.875rem;">
                        <p><strong>Subject:</strong> ${info.subject}</p>
                        <p><strong>Issuer:</strong> ${info.issuer}</p>
                        <p><strong>Serial:</strong> <code>${info.serial}</code></p>
                        <p><strong>Valid Until:</strong> ${info.valid_until ? new Date(info.valid_until).toLocaleString() : 'N/A'}</p>
                    </div>
                </div>
            `;
        } else {
            resultDiv.style.display = 'block';
            resultDiv.innerHTML = `
                <div style="background: var(--danger-bg); padding: 1rem; border-radius: 0.5rem; border-left: 4px solid var(--danger-color);">
                    <strong>✗ Validation Failed</strong>
                    <p style="margin-top: 0.5rem;">${result.error || 'Unknown error'}</p>
                </div>
            `;
        }
    } catch (error) {
        showToast('✗ Validation error: ' + error.message, 'error');
    }
};

// Import certificate
document.getElementById('import-cert-form')?.addEventListener('submit', async (e) => {
    e.preventDefault();
    
    const data = {
        certificate: document.getElementById('import_cert_pem').value,
        name: document.getElementById('import_name').value
    };
    
    try {
        const response = await fetch('/api/v1/mtls/certificates/enroll', {
            method: 'POST',
            headers: {
                'Content-Type': 'application/json',
                'Authorization': `Bearer ${getToken()}`
            },
            body: JSON.stringify(data)
        });
        
        const result = await response.json();
        
        if (response.ok) {
            showToast('✓ Certificate imported successfully', 'success');
            document.getElementById('import-cert-form').reset();
            document.getElementById('import-validation-result').style.display = 'none';
            document.querySelector('.mtls-tab-button[data-tab="manage"]').click();
        } else {
            showToast('✗ ' + (result.error || 'Failed to import certificate'), 'error');
        }
    } catch (error) {
        showToast('✗ Error: ' + error.message, 'error');
    }
});

// Load certificates
async function loadCertificates() {
    try {
        const response = await fetch('/api/v1/mtls/certificates', {
            headers: {'Authorization': `Bearer ${getToken()}`}
        });
        
        if (response.ok) {
            const data = await response.json();
            const tbody = document.getElementById('certificates-tbody');
            
            if (data.certificates.length === 0) {
                tbody.innerHTML = `
                    <tr>
                        <td colspan="6" style="text-align: center; padding: 2rem; color: var(--text-secondary);">
                            <svg class="ucm-icon" width="32" height="32" style="opacity: 0.5;"><use href="#icon-key"/></svg>
                            <p style="margin-top: 0.5rem;">No certificates enrolled</p>
                            <button onclick="document.querySelector('.mtls-tab-button[data-tab=\\'create\\']').click()" class="btn-primary" style="margin-top: 1rem;">
                                <svg class="ucm-icon" width="16" height="16" style="margin-right: 0.5rem;"><use href="#icon-plus"/></svg> Create Your First Certificate
                            </button>
                        </td>
                    </tr>
                `;
                return;
            }
            
            tbody.innerHTML = data.certificates.map(cert => {
                const validUntil = cert.valid_until ? new Date(cert.valid_until) : null;
                const isExpired = validUntil && validUntil < new Date();
                const daysLeft = validUntil ? Math.ceil((validUntil - new Date()) / (1000 * 60 * 60 * 24)) : null;
                
                // Escape user-controlled data to prevent XSS
                const safeName = escapeHtml(cert.name || 'Unnamed');
                const safeSubject = escapeHtml(cert.cert_subject);
                const safeSerial = escapeHtml(cert.cert_serial.substring(0, 16));
                
                return `
                    <tr>
                        <td><strong>${safeName}</strong></td>
                        <td style="max-width: 300px; overflow: hidden; text-overflow: ellipsis;">${safeSubject}</td>
                        <td><code style="font-size: 0.875rem;">${safeSerial}...</code></td>
                        <td>
                            ${validUntil ? validUntil.toLocaleDateString() : 'N/A'}
                            ${daysLeft !== null && daysLeft < 30 ? `<br><small style="color: var(--warning-color);">${daysLeft} days left</small>` : ''}
                        </td>
                        <td>
                            ${cert.enabled 
                                ? (isExpired 
                                    ? '<span class="badge-outline badge-danger"><svg class="ucm-icon" width="10" height="10"><use href="#icon-times"/></svg> Expired</span>'
                                    : '<span class="badge-outline badge-success"><svg class="ucm-icon" width="10" height="10"><use href="#icon-check"/></svg> Active</span>')
                                : '<span class="badge-outline badge-secondary"><svg class="ucm-icon" width="10" height="10"><use href="#icon-times"/></svg> Disabled</span>'
                            }
                        </td>
                        <td>
                            <div style="display: flex; gap: 0.5rem;">
                                <button onclick="downloadCertificate(${cert.id})" class="btn-outline-secondary" style="padding: 0.5rem;" title="Download">
                                    <svg class="ucm-icon" width="16" height="16"><use href="#icon-download"/></svg>
                                </button>
                                ${cert.enabled 
                                    ? `<button onclick="revokeCertificate(${cert.id})" class="btn-outline-warning" style="padding: 0.5rem;" title="Revoke">
                                        <svg class="ucm-icon" width="16" height="16"><use href="#icon-times"/></svg>
                                    </button>`
                                    : `<button onclick="enableCertificate(${cert.id})" class="btn-outline-success" style="padding: 0.5rem;" title="Enable">
                                        <svg class="ucm-icon" width="16" height="16"><use href="#icon-check"/></svg>
                                    </button>`
                                }
                                <button onclick="deleteCertificate(${cert.id})" class="btn-outline-danger" style="padding: 0.5rem;" title="Delete">
                                    <svg class="ucm-icon" width="16" height="16"><use href="#icon-trash"/></svg>
                                </button>
                            </div>
                        </td>
                    </tr>
                `;
            }).join('');
        }
    } catch (error) {
        console.error('Error loading certificates:', error);
    }
}

// Certificate actions
window.downloadCertificate = async function(certId) {
    try {
        const response = await fetch(`/api/v1/mtls/certificates/${certId}/download`, {
            headers: {'Authorization': `Bearer ${getToken()}`}
        });
        
        if (response.ok) {
            const blob = await response.blob();
            const url = window.URL.createObjectURL(blob);
            const a = document.createElement('a');
            a.href = url;
            
            // Extract filename from Content-Disposition header
            const disposition = response.headers.get('Content-Disposition');
            let filename = `client-cert-${certId}.pem`; // fallback
            if (disposition) {
                const filenameMatch = disposition.match(/filename[^;=\n]*=((['"]).*?\2|[^;\n]*)/);
                if (filenameMatch && filenameMatch[1]) {
                    filename = filenameMatch[1].replace(/['"]/g, '');
                }
            }
            
            a.download = filename;
            a.click();
            window.URL.revokeObjectURL(url);
        } else {
            showToast('✗ Failed to download certificate', 'error');
        }
    } catch (error) {
        showToast('✗ Error: ' + error.message, 'error');
    }
};

window.revokeCertificate = async function(certId) {
    const confirmed = await ucmConfirm(
        'Are you sure you want to revoke this certificate? You can re-enable it later.',
        'Revoke Certificate',
        { danger: true, confirmText: 'Revoke', icon: 'warning-triangle' }
    );
    
    if (!confirmed) return;
    
    try {
        const response = await fetch(`/api/v1/mtls/certificates/${certId}/revoke`, {
            method: 'POST',
            headers: {'Authorization': `Bearer ${getToken()}`}
        });
        
        if (response.ok) {
            showToast('✓ Certificate revoked', 'success');
            loadCertificates();
        } else {
            showToast('✗ Failed to revoke', 'error');
        }
    } catch (error) {
        showToast('✗ Error: ' + error.message, 'error');
    }
};

window.enableCertificate = async function(certId) {
    try {
        const response = await fetch(`/api/v1/mtls/certificates/${certId}/enable`, {
            method: 'POST',
            headers: {'Authorization': `Bearer ${getToken()}`}
        });
        
        if (response.ok) {
            showToast('✓ Certificate enabled', 'success');
            loadCertificates();
        } else {
            showToast('✗ Failed to enable', 'error');
        }
    } catch (error) {
        showToast('✗ Error: ' + error.message, 'error');
    }
};

window.deleteCertificate = async function(certId) {
    const confirmed = await ucmConfirm(
        'Are you sure you want to permanently delete this certificate? This action cannot be undone.',
        'Delete Certificate',
        { danger: true, confirmText: 'Delete', icon: 'trash' }
    );
    
    if (!confirmed) return;
    
    try {
        const response = await fetch(`/api/v1/mtls/certificates/${certId}`, {
            method: 'DELETE',
            headers: {'Authorization': `Bearer ${getToken()}`}
        });
        
        if (response.ok) {
            showToast('✓ Certificate deleted', 'success');
            loadCertificates();
        } else {
            showToast('✗ Failed to delete', 'error');
        }
    } catch (error) {
        showToast('✗ Error: ' + error.message, 'error');
    }
};

// Initialize mTLS section
async function initMTLS() {
    await loadMTLSSettings();
    // Check if user has certificates to determine default tab
    try {
        const response = await fetch('/api/v1/mtls/certificates', {
            headers: {'Authorization': `Bearer ${getToken()}`}
        });
        if (response.ok) {
            const data = await response.json();
            if (data.certificates.length > 0) {
                // User has certificates, show manage tab by default
                document.querySelector('.mtls-tab-button[data-tab="manage"]').click();
            }
        }
    } catch (error) {
        console.error('Error checking certificates:', error);
    }
}
initMTLS();
})();
</script>
{% endblock %}

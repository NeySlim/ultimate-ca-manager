{% extends "base.html" %}

{% block title %}My Account - UCM{% endblock %}

{% block content %}
<div style="display: flex; flex-direction: column; gap: 1.5rem;">
    <div style="display: flex; justify-content: space-between; align-items: center;">
        <h1 style="font-size: 1.875rem; font-weight: 600; color: var(--text-primary); margin: 0; display: flex; align-items: center; gap: 0.5rem;">
            <svg class="ucm-icon" width="24" height="24"><use href="#icon-user"/></svg>
            <span>My Account</span>
        </h1>
    </div>
    
    <!-- Account Tabs (4 tabs) -->
    <div class="tabs-container">
        <button class="tab-button active" onclick="ucm_switchTab('profile')" id="btn-tab-profile">
            <svg class="ucm-icon" width="18" height="18"><use href="#icon-user"/></svg> Profile
        </button>
        <button class="tab-button" onclick="ucm_switchTab('preferences')" id="btn-tab-preferences">
            <svg class="ucm-icon" width="18" height="18"><use href="#icon-palette"/></svg> Preferences
        </button>
        <button class="tab-button" onclick="ucm_switchTab('security')" id="btn-tab-security">
            <svg class="ucm-icon" width="18" height="18"><use href="#icon-shield-check"/></svg> Security
        </button>
        <button class="tab-button" onclick="ucm_switchTab('notifications')" id="btn-tab-notifications">
            <svg class="ucm-icon" width="18" height="18"><use href="#icon-bell"/></svg> Notifications
        </button>
    </div>
    
    <!-- ========================================== -->
    <!-- TAB 1: PROFILE -->
    <!-- ========================================== -->
    <div id="tab-profile" class="tab-content active">
    
    <!-- User Profile -->
    <div class="card">
        <div class="card-header">
            <h2 style="display: flex; align-items: center; gap: 0.5rem; margin: 0;">
                <svg class="ucm-icon" width="20" height="20" style="color: var(--primary-color);"><use href="#icon-user"/></svg>
                Profile Information
            </h2>
        </div>
        <div style="padding: 1.5rem;">
            <div style="display: grid; grid-template-columns: repeat(auto-fit, minmax(300px, 1fr)); gap: 1.5rem;">
                <div>
                    <label style="display: block; font-size: 0.875rem; font-weight: 500; color: var(--text-primary); margin-bottom: 0.5rem;">Username</label>
                    <div style="display: flex; align-items: center; gap: 0.75rem;">
                        <svg class="ucm-icon" width="24" height="24" style="color: var(--primary-color);"><use href="#icon-user"/></svg>
                        <span style="font-size: 1.125rem; font-weight: 600; color: var(--text-primary);">{{ session.get('username', 'N/A') }}</span>
                    </div>
                </div>
                <div>
                    <label style="display: block; font-size: 0.875rem; font-weight: 500; color: var(--text-primary); margin-bottom: 0.5rem;">Role</label>
                    <div style="display: flex; align-items: center; gap: 0.75rem;">
                        {% if session.get('role') == 'admin' %}
                        <span class="badge-outline badge-primary">
                            <svg class="ucm-icon" width="12" height="12"><use href="#icon-shield-check"/></svg>
                            Administrator
                        </span>
                        {% else %}
                        <span class="badge-outline badge-info">
                            <svg class="ucm-icon" width="12" height="12"><use href="#icon-eye"/></svg>
                            {{ session.get('role', 'viewer').title() }}
                        </span>
                        {% endif %}
                    </div>
                </div>
            </div>
        </div>
    </div>
    
    <!-- Password Change -->
    <div class="card">
        <div class="card-header">
            <h2 style="display: flex; align-items: center; gap: 0.5rem; margin: 0;">
                <svg class="ucm-icon" width="20" height="20" style="color: var(--primary-color);"><use href="#icon-key"/></svg>
                Change Password
            </h2>
        </div>
        <div style="padding: 1.5rem;">
            <form id="change-password-form" style="display: flex; flex-direction: column; gap: 1rem;">
                <div>
                    <label class="form-label">Current Password</label>
                    <input type="password" id="current-password" class="form-input" placeholder="Enter current password" required>
                </div>
                <div>
                    <label class="form-label">New Password</label>
                    <input type="password" id="new-password" class="form-input" placeholder="Enter new password" required minlength="8">
                </div>
                <div>
                    <label class="form-label">Confirm New Password</label>
                    <input type="password" id="confirm-password" class="form-input" placeholder="Confirm new password" required>
                </div>
                <div style="padding-top: 0.5rem;">
                    <button type="submit" class="btn-primary">
                        <svg class="ucm-icon" width="16" height="16" style="margin-right: 0.5rem;"><use href="#icon-check"/></svg>
                        Update Password
                    </button>
                </div>
            </form>
        </div>
    </div>
    
    </div><!-- End Tab: Profile -->

    
    <!-- ========================================== -->
    <!-- TAB 3: SECURITY -->
    <!-- ========================================== -->
    <div id="tab-security" class="tab-content">
    
    <!-- Active Sessions -->
    <div class="card">
        <div class="card-header">
            <h2 style="display: flex; align-items: center; gap: 0.5rem; margin: 0;">
                <svg class="ucm-icon" width="20" height="20" style="color: var(--primary-color);"><use href="#icon-activity"/></svg>
                Active Sessions
            </h2>
        </div>
        <div style="padding: 1.5rem;">
            <div hx-get="/api/ui/my-account/sessions" hx-trigger="load" hx-target="#sessions-list">
                <div id="sessions-list">
                    <div style="text-align: center; padding: 2rem 0;">
                        <svg class="ucm-icon icon-spin" width="24" height="24"><use href="#icon-spinner"/></svg>
                        <p style="margin-top: 0.5rem; font-size: 0.875rem; color: var(--text-secondary);">Loading sessions...</p>
                    </div>
                </div>
            </div>
        </div>
    </div>
    
    <!-- API Keys -->
    <div class="card">
        <div class="card-header">
            <div style="display: flex; justify-content: space-between; align-items: center;">
                <h2 style="display: flex; align-items: center; gap: 0.5rem; margin: 0;">
                    <svg class="ucm-icon" width="20" height="20" style="color: var(--primary-color);"><use href="#icon-key"/></svg>
                    API Keys
                </h2>
                <button onclick="openModal('createApiKeyModal')" class="btn-primary">
                    <svg class="ucm-icon" width="16" height="16"><use href="#icon-plus"/></svg> Create API Key
                </button>
            </div>
        </div>
        <div style="padding: 1.5rem;">
            <div hx-get="/api/ui/my-account/api-keys" hx-trigger="load" hx-target="#api-keys-list">
                <div id="api-keys-list">
                    <div style="text-align: center; padding: 2rem 0;">
                        <svg class="ucm-icon icon-spin" width="24" height="24"><use href="#icon-spinner"/></svg>
                        <p style="margin-top: 0.5rem; font-size: 0.875rem; color: var(--text-secondary);">Loading API keys...</p>
                    </div>
                </div>
            </div>
        </div>
    </div>
    
    <!-- mTLS Certificates -->
    <div class="card">
        <div class="card-header">
            <h2 style="display: flex; align-items: center; gap: 0.5rem; margin: 0;">
                <svg class="ucm-icon" width="20" height="20" style="color: var(--primary-color);"><use href="#icon-shield-check"/></svg>
                mTLS Client Certificates
            </h2>
        </div>
        <div style="padding: 1.5rem;">
            <p style="color: var(--text-secondary); margin-bottom: 1rem;">
                Manage your mTLS client certificates for browser-based authentication.
            </p>
            <a href="/my-account/mtls" class="btn-secondary">
                <svg class="ucm-icon" width="16" height="16"><use href="#icon-shield-check"/></svg> Manage mTLS Certificates
            </a>
        </div>
    </div>
    
    </div><!-- End Tab: Security -->

    
    <!-- ========================================== -->
    <!-- TAB 4: NOTIFICATIONS -->
    <!-- ========================================== -->
    <div id="tab-notifications" class="tab-content">
    
    <!-- Email Notifications -->
    <div class="card">
        <div class="card-header">
            <h2 style="display: flex; align-items: center; gap: 0.5rem; margin: 0;">
                <svg class="ucm-icon" width="20" height="20" style="color: var(--primary-color);"><use href="#icon-bell"/></svg>
                Email Notification Preferences
            </h2>
        </div>
        <div style="padding: 1.5rem;">
            <form hx-post="/api/ui/my-account/notification-settings" hx-swap="none">
                <div style="display: flex; flex-direction: column; gap: 1.5rem;">
                    <div>
                        <label class="form-label">Notification Email</label>
                        <input type="email" name="notification_email" class="form-input" value="{{ session.get('email', '') }}" placeholder="your.email@example.com">
                        <small style="display: block; margin-top: 0.5rem; color: var(--text-secondary); font-size: 0.75rem;">
                            Email address where you want to receive notifications
                        </small>
                    </div>
                    
                    <div>
                        <h3 style="font-size: 1rem; font-weight: 600; color: var(--text-primary); margin-bottom: 1rem;">Notify me about:</h3>
                        
                        <div style="display: flex; flex-direction: column; gap: 1rem;">
                            <label style="display: flex; align-items: start; cursor: pointer;">
                                <input type="checkbox" name="notify_cert_expiry" checked style="margin-top: 4px;">
                                <div style="margin-left: 0.75rem;">
                                    <div style="font-weight: 500; color: var(--text-primary);">Certificate Expiration</div>
                                    <div style="font-size: 0.875rem; color: var(--text-secondary);">Get notified when certificates are about to expire</div>
                                </div>
                            </label>
                            
                            <label style="display: flex; align-items: start; cursor: pointer;">
                                <input type="checkbox" name="notify_cert_issued" checked style="margin-top: 4px;">
                                <div style="margin-left: 0.75rem;">
                                    <div style="font-weight: 500; color: var(--text-primary);">Certificate Issued</div>
                                    <div style="font-size: 0.875rem; color: var(--text-secondary);">Get notified when new certificates are issued</div>
                                </div>
                            </label>
                            
                            <label style="display: flex; align-items: start; cursor: pointer;">
                                <input type="checkbox" name="notify_cert_revoked" checked style="margin-top: 4px;">
                                <div style="margin-left: 0.75rem;">
                                    <div style="font-weight: 500; color: var(--text-primary);">Certificate Revoked</div>
                                    <div style="font-size: 0.875rem; color: var(--text-secondary);">Get notified when certificates are revoked</div>
                                </div>
                            </label>
                            
                            <label style="display: flex; align-items: start; cursor: pointer;">
                                <input type="checkbox" name="notify_system_alerts" style="margin-top: 4px;">
                                <div style="margin-left: 0.75rem;">
                                    <div style="font-weight: 500; color: var(--text-primary);">System Alerts</div>
                                    <div style="font-size: 0.875rem; color: var(--text-secondary);">Get notified about system events and maintenance</div>
                                </div>
                            </label>
                        </div>
                    </div>
                    
                    <div style="padding-top: 0.5rem; border-top: 1px solid var(--border-color);">
                        <button type="submit" class="btn-primary">
                            <svg class="ucm-icon" width="16" height="16"><use href="#icon-check"/></svg> Save Notification Preferences
                        </button>
                    </div>
                </div>
            </form>
        </div>
    </div>
    
    </div><!-- End Tab: Notifications -->

<script>
// Display current theme
document.addEventListener('DOMContentLoaded', function() {
    const theme = localStorage.getItem('ucm-theme') || 'sentinel-light';
    const [base, variant] = theme.split('-');
    const themeName = base.charAt(0).toUpperCase() + base.slice(1) + ' ' + 
                     variant.charAt(0).toUpperCase() + variant.slice(1);
    document.getElementById('current-theme-name').textContent = themeName;
});

// Handle password change form
document.getElementById('change-password-form').addEventListener('submit', function(e) {
    e.preventDefault();
    
    const currentPassword = document.getElementById('current-password').value;
    const newPassword = document.getElementById('new-password').value;
    const confirmPassword = document.getElementById('confirm-password').value;
    
    if (newPassword !== confirmPassword) {
        ucmAlert('New passwords do not match!', 'Error');
        return;
    }
    
    if (newPassword.length < 8) {
        ucmAlert('Password must be at least 8 characters long!', 'Error');
        return;
    }
    
    // TODO: Implement password change API call
    fetch('/api/auth/change-password', {
        method: 'POST',
        headers: {
            'Content-Type': 'application/json',
        },
        body: JSON.stringify({
            current_password: currentPassword,
            new_password: newPassword
        })
    })
    .then(response => response.json())
    .then(data => {
        if (data.success) {
            ucmAlert('Password changed successfully!', 'Success').then(() => {
                document.getElementById('change-password-form').reset();
            });
        } else {
            ucmAlert('Error: ' + (data.message || 'Failed to change password'), 'Error');
        }
    })
    .catch(error => {
        console.error('Error:', error);
        ucmAlert('An error occurred while changing password', 'Error');
    });
});

</script>
{% endblock %}

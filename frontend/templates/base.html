<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <meta name="access-token" content="{{ session.get('access_token', '') }}">
    <title>{% block title %}Ultimate CA Manager{% endblock %}</title>
    
    <!-- Favicon -->
    <link rel="icon" type="image/svg+xml" href="{{ url_for('static', filename='favicon.svg') }}">
    
    <!-- CRITICAL: Set theme attribute IMMEDIATELY before any CSS loads -->
    <script>
        (function() {
            var theme = localStorage.getItem('ucm-theme') || 'sentinel-light';
            document.documentElement.setAttribute('data-theme', theme);
            document.write('<link id="theme-css" rel="stylesheet" href="/static/css/themes/' + theme + '.css">');
        })();
    </script>
    
    <!-- Embedded Resources - NO CDN -->
    <link rel="stylesheet" href="{{ url_for('static', filename='vendor/css/fontawesome.css') }}">
    <link rel="stylesheet" href="{{ url_for('static', filename='css/components.css') }}">
    
    {% block extra_head %}{% endblock %}
</head>
<body>
    
    <!-- Global Loading Indicator -->
    <div id="global-loader" style="display: none; position: fixed; top: 0; left: 0; right: 0; bottom: 0; background: transparent; z-index: 9999; align-items: center; justify-content: center; pointer-events: none;">
        <div style="background: var(--card-bg); border-radius: 12px; padding: 2rem; box-shadow: 0 25px 50px -12px rgba(0,0,0,0.5); text-align: center; min-width: 200px;">
            <div class="spinner" style="margin: 0 auto 1rem auto; width: 48px; height: 48px; border-width: 4px;"></div>
            <div style="color: var(--text-primary); font-weight: 500; font-size: 1rem;">Loading...</div>
        </div>
    </div>
    
    {% if request.endpoint and request.endpoint != 'ui.login' %}
    
    <!-- Navbar -->
    <nav>
        <div style="display: flex; align-items: center; gap: 10px;">
            <svg width="36" height="36" viewBox="0 0 192 150" xmlns="http://www.w3.org/2000/svg">
              <defs>
                <linearGradient id="ucm-logo-gradient" x1="0%" y1="0%" x2="100%" y2="100%">
                  <stop offset="0%" style="stop-color:var(--primary-color);stop-opacity:1" />
                  <stop offset="100%" style="stop-color:var(--primary-hover);stop-opacity:1" />
                </linearGradient>
              </defs>
              
              <!-- Certificate Document -->
              <rect class="logo-border" x="8" y="0" width="176" height="116" rx="4" fill="url(#ucm-logo-gradient)"/>
              <rect class="logo-bg" x="12" y="4" width="168" height="108" rx="3" fill="transparent"/>
              
              <!-- Text lines -->
              <line class="logo-line" x1="42" y1="22" x2="150" y2="22" stroke="url(#ucm-logo-gradient)" stroke-width="4" opacity="0.3"/>
              <line class="logo-line" x1="42" y1="34" x2="138" y2="34" stroke="url(#ucm-logo-gradient)" stroke-width="4" opacity="0.3"/>
              <line class="logo-line" x1="42" y1="46" x2="126" y2="46" stroke="url(#ucm-logo-gradient)" stroke-width="4" opacity="0.3"/>
              
              <!-- Center badge circle -->
              <circle class="logo-badge" cx="96" cy="70" r="24" fill="url(#ucm-logo-gradient)"/>
              <circle class="logo-badge-ring" cx="96" cy="70" r="20" fill="none" stroke="#fff" stroke-width="3"/>
              <circle class="logo-badge-ring" cx="96" cy="70" r="16" fill="none" stroke="#fff" stroke-width="2" opacity="0.5"/>
              
              <!-- Checkmark in badge -->
              <path class="logo-check" d="M88 70l5 5 11-11" fill="none" stroke="#fff" stroke-width="4" stroke-linecap="round" stroke-linejoin="round"/>
              
              <!-- Left ribbon -->
              <path class="logo-ribbon" d="M70 116 L70 142 L80 133 L80 116 Z" fill="url(#ucm-logo-gradient)"/>
              <path class="logo-ribbon-outline" d="M70 116 L70 142 L80 133 L80 116" fill="none" stroke="#fff" stroke-width="2" opacity="0.6"/>
              
              <!-- Right ribbon -->
              <path class="logo-ribbon" d="M112 116 L112 142 L102 133 L102 116 Z" fill="url(#ucm-logo-gradient)"/>
              <path class="logo-ribbon-outline" d="M112 116 L112 142 L102 133 L102 116" fill="none" stroke="#fff" stroke-width="2" opacity="0.6"/>
            </svg>
            <span class="navbar-brand-text">Ultimate CA Manager</span>
        </div>
        
        <div class="navbar-actions">
            <!-- Theme Selector Dropdown -->
            <div class="dropdown" x-data="{ open: false }">
                <button @click="open = !open" class="btn-secondary">
                    <i class="fas fa-palette"></i>
                    <span>Theme</span>
                    <i class="fas fa-chevron-down" style="font-size: 10px;"></i>
                </button>
                
                <div x-show="open" @click.away="open = false" x-cloak class="dropdown-menu">
                    <div class="dropdown-header">Sentinel</div>
                    <a href="#" data-action="set-theme" data-theme="sentinel-light" class="dropdown-item">
                        <i class="fas fa-sun"></i> Light
                    </a>
                    <a href="#" data-action="set-theme" data-theme="sentinel-dark" class="dropdown-item">
                        <i class="fas fa-moon"></i> Dark
                    </a>
                    
                    <div class="dropdown-divider"></div>
                    
                    <div class="dropdown-header">Amber</div>
                    <a href="#" data-action="set-theme" data-theme="amber-light" class="dropdown-item">
                        <i class="fas fa-sun"></i> Light
                    </a>
                    <a href="#" data-action="set-theme" data-theme="amber-dark" class="dropdown-item">
                        <i class="fas fa-moon"></i> Dark
                    </a>
                    
                    <div class="dropdown-divider"></div>
                    
                    <div class="dropdown-header">Blossom</div>
                    <a href="#" data-action="set-theme" data-theme="blossom-light" class="dropdown-item">
                        <i class="fas fa-sun"></i> Light
                    </a>
                    <a href="#" data-action="set-theme" data-theme="blossom-dark" class="dropdown-item">
                        <i class="fas fa-moon"></i> Dark
                    </a>
                    
                    <div class="dropdown-divider"></div>
                    
                    <div class="dropdown-header">Nebula</div>
                    <a href="#" data-action="set-theme" data-theme="nebula-light" class="dropdown-item">
                        <i class="fas fa-sun"></i> Light
                    </a>
                    <a href="#" data-action="set-theme" data-theme="nebula-dark" class="dropdown-item">
                        <i class="fas fa-moon"></i> Dark
                    </a>
                </div>
            </div>
            
            <!-- Quick Dark/Light Toggle -->
            <button data-action="toggle-theme-variant" class="btn-secondary" title="Toggle Dark/Light">
                <svg id="theme-icon" class="ucm-icon" width="20" height="20">
                    <use href="#icon-moon"/>
                </svg>
            </button>
            
            <!-- User Menu with Dropdown -->
            <div class="dropdown" x-data="{ open: false }">
                <button @click="open = !open" class="btn-secondary">
                    <i class="fas fa-user"></i>
                    <span>{{ session.get('username', 'User') }}</span>
                    <i class="fas fa-chevron-down" style="font-size: 10px;"></i>
                </button>
                
                <div x-show="open" @click.away="open = false" x-cloak class="dropdown-menu" style="right: 0; left: auto;">
                    <div class="dropdown-header">{{ session.get('username', 'User') }}</div>
                    <a href="/my-account" class="dropdown-item"
                       hx-get="/my-account" hx-target="#main-content" hx-select="#main-content" hx-swap="outerHTML" hx-push-url="true"
                       @click="open = false">
                        <svg class="ucm-icon" width="16" height="16"><use href="#icon-user"/></svg> My Account
                    </a>
                    <a href="/my-account/mtls" class="dropdown-item"
                       hx-get="/my-account/mtls" hx-target="#main-content" hx-select="#main-content" hx-swap="outerHTML" hx-push-url="true"
                       @click="open = false">
                        <svg class="ucm-icon" width="16" height="16"><use href="#icon-certificate"/></svg> My Certificates
                    </a>
                    
                    <div class="dropdown-divider"></div>
                    <div class="dropdown-header">Quick Access</div>
                    
                    <a href="/config/notifications" class="dropdown-item"
                       hx-get="/config/notifications" hx-target="#main-content" hx-select="#main-content" hx-swap="outerHTML" hx-push-url="true"
                       @click="open = false">
                        <svg class="ucm-icon" width="16" height="16"><use href="#icon-bell"/></svg> Notifications
                    </a>
                    <a href="/config/webauthn" class="dropdown-item"
                       hx-get="/config/webauthn" hx-target="#main-content" hx-select="#main-content" hx-swap="outerHTML" hx-push-url="true"
                       @click="open = false">
                        <svg class="ucm-icon" width="16" height="16"><use href="#icon-key"/></svg> Security Keys
                    </a>
                    
                    <a href="/config/acme" class="dropdown-item"
                       hx-get="/config/acme" hx-target="#main-content" hx-select="#main-content" hx-swap="outerHTML" hx-push-url="true"
                       @click="open = false">
                        <svg class="ucm-icon" width="16" height="16"><use href="#icon-acme"/></svg> ACME Protocol
                    </a>
                    
                    <div class="dropdown-divider"></div>
                    
                    <a href="/logout" class="dropdown-item">
                        <svg class="ucm-icon" width="16" height="16"><use href="#icon-logout"/></svg> Logout
                    </a>
                </div>
            </div>
            
            <!-- Logout -->
            <a href="/logout" class="btn-secondary" title="Logout">
                <i class="fas fa-right-from-bracket"></i>
            </a>
        </div>
    </nav>
    
    <!-- Sidebar -->
    <aside>
        <div class="sidebar-nav">
            <a href="/dashboard" class="sidebar-link {% if request.path == '/dashboard' or request.path == '/sentinel-demo' %}active{% endif %}"
               hx-get="/dashboard" hx-target="#main-content" hx-select="#main-content" hx-swap="outerHTML" hx-push-url="true">
                <i class="fas fa-gauge-high"></i>
                <span>Dashboard</span>
            </a>
            
            <a href="/ca" class="sidebar-link {% if request.path.startswith('/ca') or request.path.startswith('/import-ca') %}active{% endif %}"
               hx-get="/ca" hx-target="#main-content" hx-select="#main-content" hx-swap="outerHTML" hx-push-url="true">
                <i class="fas fa-lock"></i>
                <span>Certificate Authorities</span>
            </a>
            <div class="sidebar-submenu">
                <a href="/ca" class="sidebar-link" hx-get="/ca" hx-target="#main-content" hx-select="#main-content" hx-swap="outerHTML" hx-push-url="true">
                    <svg class="ucm-icon" width="14" height="14"><use href="#icon-list"/></svg>
                    <span>All CAs</span>
                </a>
                <a href="/ca/new" class="sidebar-link" hx-get="/ca/new" hx-target="#main-content" hx-select="#main-content" hx-swap="outerHTML" hx-push-url="true">
                    <svg class="ucm-icon" width="14" height="14"><use href="#icon-plus"/></svg>
                    <span>Create CA</span>
                </a>
                <a href="/import-ca" class="sidebar-link" hx-get="/import-ca" hx-target="#main-content" hx-select="#main-content" hx-swap="outerHTML" hx-push-url="true">
                    <svg class="ucm-icon" width="14" height="14"><use href="#icon-upload"/></svg>
                    <span>Import CA</span>
                </a>
            </div>
            
            <a href="/certificates" class="sidebar-link {% if request.path.startswith('/certificates') or request.path.startswith('/import') %}active{% endif %}"
               hx-get="/certificates" hx-target="#main-content" hx-select="#main-content" hx-swap="outerHTML" hx-push-url="true">
                <i class="fas fa-certificate"></i>
                <span>Certificates</span>
            </a>
            <div class="sidebar-submenu">
                <a href="/certificates" class="sidebar-link" hx-get="/certificates" hx-target="#main-content" hx-select="#main-content" hx-swap="outerHTML" hx-push-url="true">
                    <svg class="ucm-icon" width="14" height="14"><use href="#icon-list"/></svg>
                    <span>All Certificates</span>
                </a>
                <a href="/certificates/new" class="sidebar-link" hx-get="/certificates/new" hx-target="#main-content" hx-select="#main-content" hx-swap="outerHTML" hx-push-url="true">
                    <svg class="ucm-icon" width="14" height="14"><use href="#icon-plus"/></svg>
                    <span>Create Certificate</span>
                </a>
                <a href="/import" class="sidebar-link" hx-get="/import" hx-target="#main-content" hx-select="#main-content" hx-swap="outerHTML" hx-push-url="true">
                    <svg class="ucm-icon" width="14" height="14"><use href="#icon-upload"/></svg>
                    <span>Import Certificate</span>
                </a>
            </div>
            
            <a href="/scep" class="sidebar-link {% if request.path.startswith('/scep') %}active{% endif %}"
               hx-get="/scep" hx-target="#main-content" hx-select="#main-content" hx-swap="outerHTML" hx-push-url="true">
                <i class="fas fa-server"></i>
                <span>SCEP</span>
            </a>
            <div class="sidebar-submenu">
                <a href="/scep" class="sidebar-link" hx-get="/scep" hx-target="#main-content" hx-select="#main-content" hx-swap="outerHTML" hx-push-url="true">
                    <svg class="ucm-icon" width="14" height="14"><use href="#icon-settings"/></svg>
                    <span>Configuration</span>
                </a>
            </div>
            
            <a href="/config/acme" class="sidebar-link {% if request.path.startswith('/config/acme') %}active{% endif %}"
               hx-get="/config/acme" hx-target="#main-content" hx-select="#main-content" hx-swap="outerHTML" hx-push-url="true">
                <svg class="ucm-icon" width="20" height="20"><use href="#icon-acme"/></svg>
                <span>ACME</span>
            </a>
            
            <a href="/crl" class="sidebar-link {% if request.path.startswith('/crl') %}active{% endif %}"
               hx-get="/crl" hx-target="#main-content" hx-select="#main-content" hx-swap="outerHTML" hx-push-url="true">
                <i class="fas fa-file-contract"></i>
                <span>CRL Management</span>
            </a>
            
            <a href="/ocsp" class="sidebar-link {% if request.path.startswith('/ocsp') %}active{% endif %}"
               hx-get="/ocsp" hx-target="#main-content" hx-select="#main-content" hx-swap="outerHTML" hx-push-url="true">
                <i class="fas fa-circle-check"></i>
                <span>OCSP Status</span>
            </a>
            
            <a href="/users" class="sidebar-link {% if request.path.startswith('/users') %}active{% endif %}"
               hx-get="/users" hx-target="#main-content" hx-select="#main-content" hx-swap="outerHTML" hx-push-url="true">
                <i class="fas fa-user-group"></i>
                <span>Users</span>
            </a>
            
            {% if session.get('role') == 'admin' %}
            <a href="/settings" class="sidebar-link {% if request.path.startswith('/settings') %}active{% endif %}"
               hx-get="/settings" hx-target="#main-content" hx-select="#main-content" hx-swap="outerHTML" hx-push-url="true">
                <svg class="ucm-icon" width="20" height="20"><use href="#icon-settings"/></svg>
                <span>Settings</span>
            </a>
            {% endif %}
            
            <!-- User Settings Section -->
            <div class="sidebar-section-title" style="padding: 0.75rem 1rem; font-size: 0.75rem; font-weight: 600; text-transform: uppercase; color: var(--text-secondary); margin-top: 1rem;">
                My Account
            </div>
            
            <a href="/my-account" class="sidebar-link {% if request.path.startswith('/my-account') %}active{% endif %}"
               hx-get="/my-account" hx-target="#main-content" hx-select="#main-content" hx-swap="outerHTML" hx-push-url="true">
                <svg class="ucm-icon" width="20" height="20"><use href="#icon-user"/></svg>
                <span>Profile & Settings</span>
            </a>
            
            <a href="/my-account#mtls" class="sidebar-link {% if request.path == '/my-account#mtls' %}active{% endif %}"
               hx-get="/my-account" hx-target="#main-content" hx-select="#main-content" hx-swap="outerHTML" hx-push-url="true">
                <svg class="ucm-icon" width="20" height="20"><use href="#icon-certificate"/></svg>
                <span>My Certificates</span>
            </a>
            
            <a href="/config/notifications" class="sidebar-link {% if request.path.startswith('/config/notifications') %}active{% endif %}"
               hx-get="/config/notifications" hx-target="#main-content" hx-select="#main-content" hx-swap="outerHTML" hx-push-url="true">
                <svg class="ucm-icon" width="20" height="20"><use href="#icon-bell"/></svg>
                <span>Notifications</span>
            </a>
            
            <a href="/config/webauthn" class="sidebar-link {% if request.path.startswith('/config/webauthn') %}active{% endif %}"
               hx-get="/config/webauthn" hx-target="#main-content" hx-select="#main-content" hx-swap="outerHTML" hx-push-url="true">
                <svg class="ucm-icon" width="20" height="20"><use href="#icon-key"/></svg>
                <span>Security Keys</span>
            </a>
        </div>
    </aside>
    
    <!-- Main Content -->
    <main id="main-content">
        {% block content %}{% endblock %}
    </main>
    
    {% else %}
    
    <!-- Login Page -->
    {% block login_content %}{% endblock %}
    
    {% endif %}
    
    <!-- Scripts at end -->
    <script src="{{ url_for('static', filename='vendor/js/htmx.min.js') }}"></script>
    <script src="{{ url_for('static', filename='vendor/js/alpine.min.js') }}" defer></script>
    <script src="{{ url_for('static', filename='js/modal-utils.js') }}"></script>
    <script src="{{ url_for('static', filename='js/icon-system.js') }}"></script>
    <script src="{{ url_for('static', filename='js/modal-system.js') }}"></script>
    <script src="{{ url_for('static', filename='js/ucm-global.js') }}"></script>
    <script src="{{ url_for('static', filename='js/theme-switcher.js') }}"></script>
    <script src="{{ url_for('static', filename='js/spa-navigation.js') }}"></script>
    {% if request.endpoint and request.endpoint != 'ui.login' %}
    <script src="{{ url_for('static', filename='js/session-manager.js') }}"></script>
    {% endif %}
    
    <!-- Global HTMX event handlers -->
    <script>
    // Handle HTMX swap errors gracefully (e.g., when navigating away during a request)
    document.body.addEventListener('htmx:swapError', function(evt) {
        // Silently ignore swap errors when target element no longer exists
        // This happens when user navigates away while HTMX request is in flight
        console.warn('HTMX swap error (likely due to navigation):', evt.detail);
        evt.preventDefault(); // Prevent error from propagating
        evt.stopPropagation();
    });
    
    // Prevent swap if target element doesn't exist (catches error before it happens)
    document.body.addEventListener('htmx:beforeSwap', function(evt) {
        // Check if target element exists
        const target = evt.detail.target;
        if (!target || !document.body.contains(target)) {
            console.warn('HTMX swap target no longer exists, canceling swap');
            evt.preventDefault(); // Cancel the swap
            return false;
        }
    });
    
    // Catch any window-level errors from HTMX
    window.addEventListener('error', function(evt) {
        // Suppress HTMX querySelector errors (navigation-related)
        if (evt.message && evt.message.includes('querySelector') && evt.filename && evt.filename.includes('htmx')) {
            console.warn('HTMX DOM error suppressed (navigation-related)');
            evt.preventDefault();
            return true; // Prevent default error handling
        }
    }, true);
    
    // Listen for specific modal triggers from server
    document.body.addEventListener('openCreateCAModal', function() {
        console.log('openCreateCAModal event received');
        // Wait a bit for DOM to be ready
        setTimeout(function() {
            if (typeof openCreateCAModal !== 'undefined') {
                openCreateCAModal();
            }
        }, 50);
    });
    
    document.body.addEventListener('openCreateCertModal', function() {
        console.log('openCreateCertModal event received');
        // Wait a bit for DOM to be ready
        setTimeout(function() {
            if (typeof openCreateCertModal !== 'undefined') {
                openCreateCertModal();
            }
        }, 50);
    });
    
    // Global toast notification function
    window.showToast = function(message, type = 'info') {
        // Create toast container if it doesn't exist
        let toastContainer = document.getElementById('toast-container');
        if (!toastContainer) {
            toastContainer = document.createElement('div');
            toastContainer.id = 'toast-container';
            toastContainer.style.cssText = 'position: fixed; top: 20px; right: 20px; z-index: 10000; display: flex; flex-direction: column; gap: 10px;';
            document.body.appendChild(toastContainer);
        }
        
        // Create toast element
        const toast = document.createElement('div');
        toast.style.cssText = 'padding: 12px 20px; border-radius: 6px; box-shadow: 0 4px 12px rgba(0,0,0,0.15); min-width: 250px; max-width: 400px; display: flex; align-items: center; gap: 10px; animation: slideIn 0.3s ease;';
        
        // Set color based on type
        const colors = {
            'success': 'background: #10b981; color: white;',
            'error': 'background: #ef4444; color: white;',
            'warning': 'background: #f59e0b; color: white;',
            'info': 'background: #3b82f6; color: white;'
        };
        toast.style.cssText += colors[type] || colors['info'];
        
        // Add icon
        const icons = {
            'success': '✓',
            'error': '✗',
            'warning': '⚠',
            'info': 'ℹ'
        };
        const icon = document.createElement('span');
        icon.textContent = icons[type] || icons['info'];
        icon.style.cssText = 'font-size: 18px; font-weight: bold;';
        
        // Add message
        const messageEl = document.createElement('span');
        messageEl.textContent = message;
        messageEl.style.flex = '1';
        
        toast.appendChild(icon);
        toast.appendChild(messageEl);
        toastContainer.appendChild(toast);
        
        // Auto remove after 4 seconds
        setTimeout(() => {
            toast.style.animation = 'slideOut 0.3s ease';
            setTimeout(() => {
                toast.remove();
            }, 300);
        }, 4000);
    }
    
    // Add CSS animation
    if (!document.getElementById('toast-animations')) {
        const toastStyle = document.createElement('style');
        toastStyle.id = 'toast-animations';
        toastStyle.textContent = `
            @keyframes slideIn {
                from { transform: translateX(400px); opacity: 0; }
                to { transform: translateX(0); opacity: 1; }
            }
            @keyframes slideOut {
                from { transform: translateX(0); opacity: 1; }
                to { transform: translateX(400px); opacity: 0; }
            }
        `;
        document.head.appendChild(toastStyle);
    }
    
    // Global session expiration handler for fetch requests
    const originalFetch = window.fetch;
    window.fetch = async function(...args) {
        const response = await originalFetch(...args);
        
        // Check for 401 Unauthorized (session expired)
        if (response.status === 401) {
            // Show modal and redirect to login
            if (typeof ucmAlert !== 'undefined') {
                ucmAlert('Your session has expired due to inactivity. Please log in again.', 'Session Expired').then(() => {
                    window.location.href = '/login?expired=1';
                });
            } else {
                // Fallback if modal system not loaded
                alert('Your session has expired. Please log in again.');
                window.location.href = '/login?expired=1';
            }
            // Return the response anyway for proper error handling
        }
        
        return response;
    };
    </script>
    
    
    <!-- Global Loading Indicator Control -->
    <script>
    (function() {
        const loader = document.getElementById('global-loader');
        
        // Show loader function
        window.showGlobalLoader = function() {
            if (loader) {
                loader.style.display = 'flex';
            }
        };
        
        // Hide loader function
        window.hideGlobalLoader = function() {
            if (loader) {
                loader.style.display = 'none';
            }
        };
        
        // Show loader on page navigation (HTMX requests)
        document.body.addEventListener('htmx:beforeRequest', function(evt) {
            // Only show for navigation requests (not for small HTMX updates)
            const target = evt.detail.target;
            if (target && target.id === 'main-content') {
                showGlobalLoader();
            }
        });
        
        // Hide loader when navigation completes
        document.body.addEventListener('htmx:afterSettle', function(evt) {
            const target = evt.detail.target;
            if (target && target.id === 'main-content') {
                hideGlobalLoader();
            }
        });
        
        // Hide loader on errors
        document.body.addEventListener('htmx:responseError', function(evt) {
            hideGlobalLoader();
        });
        
        document.body.addEventListener('htmx:sendError', function(evt) {
            hideGlobalLoader();
        });
        
        // Also hide loader when page is fully loaded
        window.addEventListener('load', function() {
            hideGlobalLoader();
        });
    })();
    </script>
    
    {% block extra_body %}{% endblock %}
</body>
</html>

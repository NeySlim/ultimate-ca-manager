{% extends "base.html" %}

{% block title %}Dashboard - UCM{% endblock %}

{% block content %}
<div style="display: flex; flex-direction: column; gap: 1.5rem;">
    <!-- Page Header -->
    <div style="display: flex; justify-content: space-between; align-items: center;">
        <div>
            <h1 style="font-size: 1.875rem; font-weight: 600; color: var(--text-primary); margin: 0; display: flex; align-items: center; gap: 0.5rem;">
                <svg class="ucm-icon" width="24" height="24"><use href="#icon-dashboard"/></svg>
                <span>Dashboard</span>
            </h1>
            <p style="font-size: 0.875rem; color: var(--text-secondary); margin: 4px 0 0 0;">Overview of your certificate infrastructure</p>
        </div>
        <button onclick="location.reload()" class="btn-secondary">
            <svg class="ucm-icon" width="16" height="16"><use href="#icon-refresh"/></svg>
            <span>Refresh</span>
        </button>
    </div>

    <!-- Stats Grid -->
    <div style="display: grid; grid-template-columns: repeat(auto-fit, minmax(240px, 1fr)); gap: 1rem;">
        <!-- CA Count -->
        <div class="card">
            <div class="card-body" style="display: flex; align-items: center; gap: 1rem;">
                <div style="width: 56px; height: 56px; border-radius: 0.5rem; background: linear-gradient(135deg, rgba(var(--primary-rgb, 59, 130, 246), 0.1) 0%, rgba(var(--primary-rgb, 59, 130, 246), 0.05) 100%); display: flex; align-items: center; justify-content: center; flex-shrink: 0;">
                    <svg class="ucm-icon" width="28" height="28"><use href="#icon-certificate-authority"/></svg>
                </div>
                <div style="flex: 1; min-width: 0;">
                    <div style="font-size: 1.875rem; font-weight: 700; color: var(--text-primary); line-height: 1;">
                        {{ stats.total_cas or 0 }}
                    </div>
                    <div style="font-size: 0.875rem; color: var(--text-secondary); font-weight: 500; margin-top: 0.25rem;">
                        Certificate Authorities
                    </div>
                </div>
            </div>
        </div>
        
        <!-- Total Certificates -->
        <div class="card">
            <div class="card-body" style="display: flex; align-items: center; gap: 1rem;">
                <div style="width: 56px; height: 56px; border-radius: 0.5rem; background: linear-gradient(135deg, rgba(var(--primary-rgb, 59, 130, 246), 0.1) 0%, rgba(var(--primary-rgb, 59, 130, 246), 0.05) 100%); display: flex; align-items: center; justify-content: center; flex-shrink: 0;">
                    <svg class="ucm-icon" width="28" height="28"><use href="#icon-certificate"/></svg>
                </div>
                <div style="flex: 1; min-width: 0;">
                    <div style="font-size: 1.875rem; font-weight: 700; color: var(--text-primary); line-height: 1;">
                        {{ stats.total_certificates or 0 }}
                    </div>
                    <div style="font-size: 0.875rem; color: var(--text-secondary); font-weight: 500; margin-top: 0.25rem;">
                        Total Certificates
                    </div>
                </div>
            </div>
        </div>
        
        <!-- Valid Certificates -->
        <div class="card">
            <div class="card-body" style="display: flex; align-items: center; gap: 1rem;">
                <div style="width: 56px; height: 56px; border-radius: 0.5rem; background: linear-gradient(135deg, rgba(16, 185, 129, 0.1) 0%, rgba(16, 185, 129, 0.05) 100%); display: flex; align-items: center; justify-content: center; flex-shrink: 0;">
                    <svg class="ucm-icon" width="28" height="28"><use href="#icon-check-circle"/></svg>
                </div>
                <div style="flex: 1; min-width: 0;">
                    <div style="font-size: 1.875rem; font-weight: 700; color: var(--text-primary); line-height: 1;">
                        {{ stats.valid_certificates or 0 }}
                    </div>
                    <div style="font-size: 0.875rem; color: var(--text-secondary); font-weight: 500; margin-top: 0.25rem;">
                        Valid Certificates
                    </div>
                </div>
            </div>
        </div>
        
        <!-- Expiring Soon -->
        <div class="card">
            <div class="card-body" style="display: flex; align-items: center; gap: 1rem;">
                <div style="width: 56px; height: 56px; border-radius: 0.5rem; background: linear-gradient(135deg, rgba(245, 158, 11, 0.1) 0%, rgba(245, 158, 11, 0.05) 100%); display: flex; align-items: center; justify-content: center; flex-shrink: 0;">
                    <svg class="ucm-icon" width="28" height="28"><use href="#icon-warning-triangle"/></svg>
                </div>
                <div style="flex: 1; min-width: 0;">
                    <div style="font-size: 1.875rem; font-weight: 700; color: var(--text-primary); line-height: 1;">
                        {{ stats.expiring_soon or 0 }}
                    </div>
                    <div style="font-size: 0.875rem; color: var(--text-secondary); font-weight: 500; margin-top: 0.25rem;">
                        Expiring Soon (30d)
                    </div>
                </div>
            </div>
        </div>
    </div>

    <!-- Quick Actions -->
    <div class="card">
        <div class="card-header">
            <h2 style="font-size: 1rem; font-weight: 600; color: var(--text-primary); margin: 0; display: flex; align-items: center; gap: 0.5rem;">
                <svg class="ucm-icon" width="18" height="18"><use href="#icon-play"/></svg>
                <span>Quick Actions</span>
            </h2>
        </div>
        <div class="card-body">
            <div style="display: grid; grid-template-columns: repeat(auto-fit, minmax(200px, 1fr)); gap: 0.75rem;">
                <button onclick="window.location.href='/ca'" class="btn-secondary" style="justify-content: flex-start;">
                    <svg class="ucm-icon" width="16" height="16"><use href="#icon-plus"/></svg>
                    <span>Create CA</span>
                </button>
                <button onclick="window.location.href='/certs'" class="btn-secondary" style="justify-content: flex-start;">
                    <svg class="ucm-icon" width="16" height="16"><use href="#icon-certificate"/></svg>
                    <span>Issue Certificate</span>
                </button>
                <button onclick="window.location.href='/import'" class="btn-secondary" style="justify-content: flex-start;">
                    <svg class="ucm-icon" width="16" height="16"><use href="#icon-upload"/></svg>
                    <span>Import Certificate</span>
                </button>
                <button onclick="window.location.href='/crl'" class="btn-secondary" style="justify-content: flex-start;">
                    <svg class="ucm-icon" width="16" height="16"><use href="#icon-refresh"/></svg>
                    <span>Generate CRL</span>
                </button>
            </div>
        </div>
    </div>

    <!-- Recent Certificates -->
    <div class="card">
        <div class="card-header">
            <h2 style="font-size: 1rem; font-weight: 600; color: var(--text-primary); margin: 0; display: flex; align-items: center; gap: 0.5rem;">
                <svg class="ucm-icon" width="18" height="18"><use href="#icon-certificate"/></svg>
                <span>Recent Certificates</span>
            </h2>
        </div>
        <div class="card-body" style="padding: 0;">
            <div hx-get="/api/ui/config/managed-certs"
                 hx-trigger="load"
                 hx-swap="innerHTML">
                <div style="text-align: center; padding: 3rem;">
                    <svg class="ucm-icon spinner" width="32" height="32"><use href="#icon-spinner"/></svg>
                    <p style="margin-top: 1rem; color: var(--text-secondary);">Loading certificates...</p>
                </div>
            </div>
        </div>
    </div>

    <!-- SCEP Requests -->
    <div class="card">
        <div class="card-header">
            <h2 style="font-size: 1rem; font-weight: 600; color: var(--text-primary); margin: 0; display: flex; align-items: center; gap: 0.5rem;">
                <svg class="ucm-icon" width="18" height="18"><use href="#icon-scep"/></svg>
                <span>Recent SCEP Requests</span>
            </h2>
        </div>
        <div class="card-body" style="padding: 0;">
            <div class="table-responsive">
                <table class="table">
                    <thead>
                        <tr>
                            <th style="width: 35%;">Device</th>
                            <th style="width: 20%;">Status</th>
                            <th style="width: 30%;">CA</th>
                            <th style="width: 15%;">Date</th>
                        </tr>
                    </thead>
                    <tbody>
                        {% if scep_requests %}
                            {% for req in scep_requests[:5] %}
                            <tr>
                                <td style="font-weight: 500;">{{ req.common_name }}</td>
                                <td>
                                    {% if req.status == 'approved' %}
                                        <span class="badge-outline badge-success">
                                            <svg class="ucm-icon" width="12" height="12"><use href="#icon-check"/></svg>
                                            Approved
                                        </span>
                                    {% elif req.status == 'pending' %}
                                        <span class="badge-outline badge-warning">
                                            <svg class="ucm-icon" width="12" height="12"><use href="#icon-clock"/></svg>
                                            Pending
                                        </span>
                                    {% else %}
                                        <span class="badge-outline badge-secondary">{{ req.status }}</span>
                                    {% endif %}
                                </td>
                                <td style="color: var(--text-secondary);">{{ req.ca_name }}</td>
                                <td style="font-size: 0.875rem; color: var(--text-secondary);">
                                    {{ req.created_at.strftime('%Y-%m-%d %H:%M') if req.created_at else 'N/A' }}
                                </td>
                            </tr>
                            {% endfor %}
                        {% else %}
                        <tr>
                            <td colspan="4" style="text-align: center; padding: 3rem;">
                                <svg class="ucm-icon" width="48" height="48" style="opacity: 0.3; margin-bottom: 1rem;"><use href="#icon-scep"/></svg>
                                <div style="font-weight: 500; color: var(--text-primary); margin-bottom: 0.25rem;">No SCEP requests</div>
                                <div style="font-size: 0.875rem; color: var(--text-secondary);">Enrollment requests will appear here</div>
                            </td>
                        </tr>
                        {% endif %}
                    </tbody>
                </table>
            </div>
        </div>
    </div>
</div>

<!-- PKCS12 Password Modal -->
<div id="pkcs12PasswordModal" class="hidden" style="position: fixed; top: 64px; right: 0; bottom: 0; left: 240px; background: var(--modal-backdrop, rgba(0,0,0,0.5)); z-index: 1000; padding: 1rem;">
    <div style="display: flex; align-items: center; justify-content: center; height: 100%;">
    <div style="background: var(--card-bg); border-radius: 0.5rem; max-width: 600px; width: 100%; margin: 0 auto; box-shadow: 0 25px 50px -12px rgba(0,0,0,0.25);">
        <div style="padding: 1.5rem; border-bottom: 1px solid var(--border-color);">
            <h3 style="font-size: 1.25rem; font-weight: bold; color: var(--text-primary); display: flex; align-items: center; gap: 0.5rem;">
                <svg class="ucm-icon" width="20" height="20"><use href="#icon-key"/></svg>
                <span>PKCS#12 Password</span>
            </h3>
        </div>
        <div style="padding: 1.5rem;">
            <p style="font-size: 0.875rem; color: var(--text-muted); margin-bottom: 1rem;">
                Enter a password to protect the PKCS#12 file (minimum 4 characters):
            </p>
            <form autocomplete="off">
            <input type="password" id="pkcs12Password" 
                   class="modal-form-input"
                   placeholder="Enter password" minlength="4"
                   autocomplete="new-password">
            <input type="password" id="pkcs12PasswordConfirm" 
                   style="width: 100%; padding: 0.5rem 0.75rem; border: 1px solid var(--border-color); border-radius: 0.5rem; background: var(--bg-primary); color: var(--text-primary); margin-top: 0.75rem;"
                   placeholder="Confirm password" minlength="4"
                   autocomplete="new-password">
            </form>
        </div>
        <div class="modal-form-footer">
            <button onclick="closePKCS12Modal()" 
                    class="btn-secondary">
                Cancel
            </button>
            <button onclick="downloadPKCS12WithPassword()" 
                    class="btn-primary">
                Download
            </button>
        </div>
    </div>
    </div>
</div>

<script>
// Certificate and CA export functions with JWT authentication
(function() {
    var token = '{{ token }}';
    
    if (typeof window.exportWithToken === 'undefined') {
        window.exportWithToken = function(url) {
            showToast('Preparing download...', 'info');
            
            fetch(url, {
                headers: { 'Authorization': 'Bearer ' + token }
            })
            .then(response => {
                if (!response.ok) throw new Error('Export failed');
                
                var filename = '';
                var disposition = response.headers.get('Content-Disposition');
                if (disposition && disposition.includes('filename=')) {
                    var matches = disposition.match(/filename[^;=\\n]*=(([\'"]).*?\\2|[^;\\n]*)/);
                    if (matches && matches[1]) {
                        filename = matches[1].replace(/[\'\"]/g, '');
                    }
                }
                
                if (!filename) {
                    var urlParts = url.split('/');
                    filename = urlParts[urlParts.length - 1].split('?')[0] || 'download';
                }
                
                return response.blob().then(blob => ({blob: blob, filename: filename}));
            })
            .then(function(result) {
                var downloadUrl = window.URL.createObjectURL(result.blob);
                var a = document.createElement('a');
                a.href = downloadUrl;
                a.download = result.filename;
                document.body.appendChild(a);
                a.click();
                document.body.removeChild(a);
                window.URL.revokeObjectURL(downloadUrl);
                showToast('Download started: ' + result.filename, 'success');
            })
            .catch(error => {
                showToast('Export failed: ' + error.message, 'error');
            });
        };
    }
    
    // Certificate export functions
    window.exportCertSimple = function(id) {
        exportWithToken('/api/v1/certificates/' + id + '/export/advanced?format=pem');
        var menu = document.getElementById('export-cert-menu-' + id);
        if (menu) menu.remove();
    };
    
    window.exportCertWithKey = function(id) {
        exportWithToken('/api/v1/certificates/' + id + '/export/advanced?format=pem&key=true');
        var menu = document.getElementById('export-cert-menu-' + id);
        if (menu) menu.remove();
    };
    
    window.exportCertWithChain = function(id) {
        exportWithToken('/api/v1/certificates/' + id + '/export/advanced?format=pem&chain=true');
        var menu = document.getElementById('export-cert-menu-' + id);
        if (menu) menu.remove();
    };
    
    window.exportCertFull = function(id) {
        exportWithToken('/api/v1/certificates/' + id + '/export/advanced?format=pem&key=true&chain=true');
        var menu = document.getElementById('export-cert-menu-' + id);
        if (menu) menu.remove();
    };
    
    window.exportCertDER = function(id) {
        exportWithToken('/api/v1/certificates/' + id + '/export/advanced?format=pem&format=der');
        var menu = document.getElementById('export-cert-menu-' + id);
        if (menu) menu.remove();
    };
    
    // CA export functions
    window.exportCASimple = function(id) {
        exportWithToken('/api/v1/ca/' + id + '/export/advanced?format=pem');
        var menu = document.getElementById('export-menu-' + id);
        if (menu) menu.remove();
    };
    
    window.exportCAWithKey = function(id) {
        exportWithToken('/api/v1/ca/' + id + '/export/advanced?format=pem&key=true');
        var menu = document.getElementById('export-menu-' + id);
        if (menu) menu.remove();
    };
    
    window.exportCAWithChain = function(id) {
        exportWithToken('/api/v1/ca/' + id + '/export/advanced?format=pem&chain=true');
        var menu = document.getElementById('export-menu-' + id);
        if (menu) menu.remove();
    };
    
    window.exportCAFull = function(id) {
        exportWithToken('/api/v1/ca/' + id + '/export/advanced?format=pem&key=true&chain=true');
        var menu = document.getElementById('export-menu-' + id);
        if (menu) menu.remove();
    };
    
    window.exportCADER = function(id) {
        exportWithToken('/api/v1/ca/' + id + '/export/advanced?format=der');
        var menu = document.getElementById('export-menu-' + id);
        if (menu) menu.remove();
    };
    
    // PKCS12 export functions and modal management
    window.pkcs12Params = {};
    
    window.closePKCS12Modal = function() {
        var modal = document.getElementById('pkcs12PasswordModal');
        if (modal) modal.classList.add('hidden');
        window.pkcs12Params = {};
    };
    
    window.downloadPKCS12WithPassword = function() {
        var password = document.getElementById('pkcs12Password').value;
        var confirm = document.getElementById('pkcs12PasswordConfirm').value;
        
        if (!password || password.length < 4) {
            showToast('Password must be at least 4 characters', 'error');
            return;
        }
        
        if (password !== confirm) {
            showToast('Passwords do not match', 'error');
            return;
        }
        
        var id = window.pkcs12Params.id;
        var type = window.pkcs12Params.type;
        
        if (!id || !type) {
            showToast('Export parameters missing', 'error');
            return;
        }
        
        var url = type === 'ca' 
            ? '/api/v1/ca/' + id + '/export/advanced?format=pkcs12&password=' + encodeURIComponent(password)
            : '/api/v1/certificates/' + id + '/export/advanced?format=pkcs12&password=' + encodeURIComponent(password);
        
        exportWithToken(url);
        closePKCS12Modal();
        
        var menu = type === 'ca' 
            ? document.getElementById('export-menu-' + id)
            : document.getElementById('export-cert-menu-' + id);
        if (menu) menu.remove();
    };
})();
</script>
{% endblock %}

{% extends "base.html" %}

{% block title %}Certificate Templates - UCM{% endblock %}

{% block content %}
<div style="max-width: 80rem; margin: 0 auto;">
    <div style="margin-bottom: 1.5rem;">
        <h1 style="font-size: 1.875rem; font-weight: 600; color: var(--text-primary); margin: 0; display: flex; align-items: center; gap: 0.5rem;">
            <svg class="ucm-icon" width="24" height="24"><use href="#icon-file"/></svg>
            <span>Certificate Templates</span>
        </h1>
        <p style="margin-top: 0.5rem; font-size: 0.875rem; color: var(--text-secondary);">Pre-configured certificate profiles for common use cases</p>
    </div>

    <!-- Stats Cards -->
    <div style="display: grid; grid-template-columns: repeat(auto-fit, minmax(200px, 1fr)); gap: 1rem; margin-bottom: 1.5rem;">
        <div class="card" style="text-align: center; padding: 1.5rem;">
            <div style="font-size: 2rem; font-weight: bold; color: var(--primary-color);" id="total-templates">-</div>
            <div style="font-size: 0.875rem; color: var(--text-secondary); margin-top: 0.25rem;">Total Templates</div>
        </div>
        <div class="card" style="text-align: center; padding: 1.5rem;">
            <div style="font-size: 2rem; font-weight: bold; color: var(--info-color);" id="system-templates">-</div>
            <div style="font-size: 0.875rem; color: var(--text-secondary); margin-top: 0.25rem;">System Templates</div>
        </div>
        <div class="card" style="text-align: center; padding: 1.5rem;">
            <div style="font-size: 2rem; font-weight: bold; color: var(--success-color);" id="custom-templates">-</div>
            <div style="font-size: 0.875rem; color: var(--text-secondary); margin-top: 0.25rem;">Custom Templates</div>
        </div>
    </div>

    <!-- Templates List -->
    <div class="card">
        <div style="display: flex; justify-content: space-between; align-items: center; margin-bottom: 1.5rem;">
            <h2 style="font-size: 1.25rem; font-weight: 600; color: var(--text-primary); margin: 0;">Templates</h2>
            <button onclick="openCreateTemplateModal()" class="btn-primary">
                <svg class="ucm-icon" width="16" height="16"><use href="#icon-plus"/></svg> Create Custom Template
            </button>
        </div>

        <div id="templates-list">
            <div style="text-align: center; padding: 2rem 0;">
                <div class="spinner" style="margin: 0 auto;"></div>
                <p style="margin-top: 0.5rem; font-size: 0.875rem; color: var(--text-secondary);">Loading templates...</p>
            </div>
        </div>
    </div>
</div>

<!-- Create/Edit Template Modal -->
<div id="templateModal" style="display: none; position: fixed; inset: 0; background: rgba(0, 0, 0, 0.5); z-index: 50; align-items: center; justify-content: center;">
    <div class="modal-content" style="width: 90%; max-width: 750px; max-height: 90vh; overflow-y: auto; background: var(--bg-card); border-radius: 8px; box-shadow: 0 10px 40px rgba(0, 0, 0, 0.3);">
        <div style="padding: 1.5rem; border-bottom: 1px solid var(--border-color); display: flex; justify-content: space-between; align-items: center;">
            <h3 style="font-size: 1.25rem; font-weight: 600; color: var(--text-primary); margin: 0;" id="modal-title">Create Template</h3>
            <button onclick="closeTemplateModal()" style="background: none; border: none; color: var(--text-secondary); cursor: pointer; font-size: 1.5rem; line-height: 1; padding: 0; width: 32px; height: 32px;">&times;</button>
        </div>

        <form id="templateForm" style="padding: 1.5rem;">
            <input type="hidden" id="template-id" name="id" value="">

            <!-- Basic Info -->
            <div style="margin-bottom: 1rem;">
                <label class="form-label">Template Name *</label>
                <input type="text" id="template-name" name="name" required class="form-input" placeholder="e.g., My Custom Template">
            </div>

            <div style="margin-bottom: 1rem;">
                <label class="form-label">Description</label>
                <textarea id="template-description" name="description" rows="2" class="form-input" placeholder="Brief description of this template"></textarea>
            </div>

            <!-- Type & Key -->
            <div style="display: grid; grid-template-columns: 1fr 1fr; gap: 1rem; margin-bottom: 1rem;">
                <div>
                    <label class="form-label">Template Type</label>
                    <select id="template-type" name="template_type" class="form-input">
                        <option value="custom">Custom</option>
                        <option value="web_server">Web Server</option>
                        <option value="email">Email (S/MIME)</option>
                        <option value="vpn_server">VPN Server</option>
                        <option value="vpn_client">VPN Client</option>
                        <option value="code_signing">Code Signing</option>
                        <option value="client_auth">Client Auth</option>
                    </select>
                </div>
                <div>
                    <label class="form-label">Key Type</label>
                    <select id="template-key-type" name="key_type" class="form-input">
                        <option value="RSA-2048">RSA 2048</option>
                        <option value="RSA-4096">RSA 4096</option>
                        <option value="EC-P256">EC P-256</option>
                        <option value="EC-P384">EC P-384</option>
                    </select>
                </div>
            </div>

            <!-- Validity & Digest -->
            <div style="display: grid; grid-template-columns: 1fr 1fr; gap: 1rem; margin-bottom: 1rem;">
                <div>
                    <label class="form-label">Validity (days)</label>
                    <input type="number" id="template-validity" name="validity_days" value="397" min="1" max="7300" class="form-input">
                </div>
                <div>
                    <label class="form-label">Digest Algorithm</label>
                    <select id="template-digest" name="digest" class="form-input">
                        <option value="sha256">SHA-256</option>
                        <option value="sha384">SHA-384</option>
                        <option value="sha512">SHA-512</option>
                    </select>
                </div>
            </div>

            <!-- DN Template -->
            <div style="margin-bottom: 1rem;">
                <label class="form-label">Distinguished Name Template</label>
                <p style="font-size: 0.75rem; color: var(--text-secondary); margin-bottom: 0.5rem;">
                    Use variables: {hostname}, {email}, {username}
                </p>
                <div style="display: grid; grid-template-columns: 1fr 1fr; gap: 0.75rem;">
                    <input type="text" id="dn-cn" placeholder="CN (e.g., {hostname})" class="form-input" style="font-size: 0.875rem;">
                    <input type="text" id="dn-o" placeholder="O (Organization)" class="form-input" style="font-size: 0.875rem;">
                    <input type="text" id="dn-ou" placeholder="OU (Org Unit)" class="form-input" style="font-size: 0.875rem;">
                    <input type="text" id="dn-c" placeholder="C (Country)" class="form-input" style="font-size: 0.875rem;">
                    <input type="text" id="dn-st" placeholder="ST (State)" class="form-input" style="font-size: 0.875rem;">
                    <input type="text" id="dn-l" placeholder="L (Locality)" class="form-input" style="font-size: 0.875rem;">
                </div>
            </div>

            <!-- Key Usage -->
            <div style="margin-bottom: 1rem;">
                <label class="form-label">Key Usage</label>
                <div style="display: grid; grid-template-columns: repeat(2, 1fr); gap: 0.5rem;">
                    <label style="display: flex; align-items: center; gap: 0.5rem; font-size: 0.875rem;">
                        <input type="checkbox" id="ku-digital-signature" value="digitalSignature" style="width: 16px; height: 16px;">
                        <span>Digital Signature</span>
                    </label>
                    <label style="display: flex; align-items: center; gap: 0.5rem; font-size: 0.875rem;">
                        <input type="checkbox" id="ku-key-encipherment" value="keyEncipherment" style="width: 16px; height: 16px;">
                        <span>Key Encipherment</span>
                    </label>
                    <label style="display: flex; align-items: center; gap: 0.5rem; font-size: 0.875rem;">
                        <input type="checkbox" id="ku-data-encipherment" value="dataEncipherment" style="width: 16px; height: 16px;">
                        <span>Data Encipherment</span>
                    </label>
                    <label style="display: flex; align-items: center; gap: 0.5rem; font-size: 0.875rem;">
                        <input type="checkbox" id="ku-key-agreement" value="keyAgreement" style="width: 16px; height: 16px;">
                        <span>Key Agreement</span>
                    </label>
                </div>
            </div>

            <!-- Extended Key Usage -->
            <div style="margin-bottom: 1rem;">
                <label class="form-label">Extended Key Usage</label>
                <div style="display: grid; grid-template-columns: repeat(2, 1fr); gap: 0.5rem;">
                    <label style="display: flex; align-items: center; gap: 0.5rem; font-size: 0.875rem;">
                        <input type="checkbox" id="eku-server-auth" value="serverAuth" style="width: 16px; height: 16px;">
                        <span>Server Authentication</span>
                    </label>
                    <label style="display: flex; align-items: center; gap: 0.5rem; font-size: 0.875rem;">
                        <input type="checkbox" id="eku-client-auth" value="clientAuth" style="width: 16px; height: 16px;">
                        <span>Client Authentication</span>
                    </label>
                    <label style="display: flex; align-items: center; gap: 0.5rem; font-size: 0.875rem;">
                        <input type="checkbox" id="eku-code-signing" value="codeSigning" style="width: 16px; height: 16px;">
                        <span>Code Signing</span>
                    </label>
                    <label style="display: flex; align-items: center; gap: 0.5rem; font-size: 0.875rem;">
                        <input type="checkbox" id="eku-email-protection" value="emailProtection" style="width: 16px; height: 16px;">
                        <span>Email Protection (S/MIME)</span>
                    </label>
                </div>
            </div>

            <!-- SAN Types -->
            <div style="margin-bottom: 1.5rem;">
                <label class="form-label">Allowed SAN Types</label>
                <div style="display: flex; gap: 1rem; flex-wrap: wrap;">
                    <label style="display: flex; align-items: center; gap: 0.5rem; font-size: 0.875rem;">
                        <input type="checkbox" id="san-dns" value="dns" style="width: 16px; height: 16px;">
                        <span>DNS Names</span>
                    </label>
                    <label style="display: flex; align-items: center; gap: 0.5rem; font-size: 0.875rem;">
                        <input type="checkbox" id="san-ip" value="ip" style="width: 16px; height: 16px;">
                        <span>IP Addresses</span>
                    </label>
                    <label style="display: flex; align-items: center; gap: 0.5rem; font-size: 0.875rem;">
                        <input type="checkbox" id="san-email" value="email" style="width: 16px; height: 16px;">
                        <span>Email Addresses</span>
                    </label>
                    <label style="display: flex; align-items: center; gap: 0.5rem; font-size: 0.875rem;">
                        <input type="checkbox" id="san-uri" value="uri" style="width: 16px; height: 16px;">
                        <span>URIs</span>
                    </label>
                </div>
            </div>

            <!-- Actions -->
            <div style="display: flex; gap: 0.75rem; justify-content: flex-end; padding-top: 1rem; border-top: 1px solid var(--border-color);">
                <button type="button" onclick="closeTemplateModal()" class="btn-secondary">Cancel</button>
                <button type="submit" class="btn-primary" id="submit-btn">
                    <svg class="ucm-icon" width="16" height="16"><use href="#icon-check"/></svg> Save Template
                </button>
            </div>
        </form>
    </div>
</div>

<script>
// Load templates on page load
// Get JWT token from cookie
function getJWTToken() {
    const cookies = document.cookie.split(';');
    for (let cookie of cookies) {
        const [name, value] = cookie.trim().split('=');
        if (name === 'jwt_token') {
            return value;
        }
    }
    return null;
}

document.addEventListener('DOMContentLoaded', function() {
    loadTemplates();
});

function loadTemplates() {
    const token = getJWTToken();
    if (!token) {
        window.location.href = '/login';
        return;
    }

    fetch('/api/v1/templates', {
        headers: {'Authorization': `Bearer ${token}`}
    })
        .then(response => response.json())
        .then(data => {
            displayTemplates(data.templates);
            updateStats(data.templates);
        })
        .catch(error => {
            console.error('Error loading templates:', error);
            document.getElementById('templates-list').innerHTML = `
                <div style="text-align: center; padding: 2rem; color: var(--danger-color);">
                    <p>Error loading templates. Please try again.</p>
                </div>
            `;
        });
}

function updateStats(templates) {
    const systemTemplates = templates.filter(t => t.is_system).length;
    const customTemplates = templates.filter(t => !t.is_system).length;
    
    document.getElementById('total-templates').textContent = templates.length;
    document.getElementById('system-templates').textContent = systemTemplates;
    document.getElementById('custom-templates').textContent = customTemplates;
}

function displayTemplates(templates) {
    const container = document.getElementById('templates-list');
    
    if (templates.length === 0) {
        container.innerHTML = `
            <div style="text-align: center; padding: 3rem; color: var(--text-secondary);">
                <svg class="ucm-icon" width="48" height="48" style="opacity: 0.3; margin-bottom: 1rem;"><use href="#icon-file"/></svg>
                <p>No templates found</p>
            </div>
        `;
        return;
    }

    // Sort: system first, then by name
    templates.sort((a, b) => {
        if (a.is_system && !b.is_system) return -1;
        if (!a.is_system && b.is_system) return 1;
        return a.name.localeCompare(b.name);
    });

    let html = '<div style="display: grid; gap: 1rem;">';
    
    templates.forEach(template => {
        const badgeColor = template.is_system ? 'var(--info-color)' : 'var(--success-color)';
        const badgeText = template.is_system ? 'System' : 'Custom';
        const extensions = template.extensions_template;
        const eku = extensions.extended_key_usage ? extensions.extended_key_usage.join(', ') : 'None';
        
        html += `
            <div style="border: 1px solid var(--border-color); border-radius: 6px; padding: 1rem; background: var(--bg-secondary); transition: all 0.2s;" onmouseover="this.style.borderColor='var(--primary-color)'; this.style.boxShadow='0 2px 8px rgba(0,0,0,0.1)';" onmouseout="this.style.borderColor='var(--border-color)'; this.style.boxShadow='none';">
                <div style="display: flex; justify-content: space-between; align-items: start; margin-bottom: 0.75rem;">
                    <div style="flex: 1;">
                        <div style="display: flex; align-items: center; gap: 0.75rem; margin-bottom: 0.25rem;">
                            <h3 style="font-size: 1rem; font-weight: 600; color: var(--text-primary); margin: 0;">${template.name}</h3>
                            <span style="font-size: 0.75rem; padding: 0.125rem 0.5rem; border-radius: 3px; background: ${badgeColor}; color: white; font-weight: 500;">${badgeText}</span>
                        </div>
                        <p style="font-size: 0.875rem; color: var(--text-secondary); margin: 0;">${template.description || 'No description'}</p>
                    </div>
                    <div style="display: flex; gap: 0.5rem;">
                        <button onclick="viewTemplate(${template.id})" class="btn-secondary" style="padding: 0.375rem 0.75rem; font-size: 0.875rem;" title="View Details">
                            <svg class="ucm-icon" width="14" height="14"><use href="#icon-eye"/></svg>
                        </button>
                        ${!template.is_system ? `
                            <button onclick="editTemplate(${template.id})" class="btn-secondary" style="padding: 0.375rem 0.75rem; font-size: 0.875rem;" title="Edit">
                                <svg class="ucm-icon" width="14" height="14"><use href="#icon-edit"/></svg>
                            </button>
                            <button onclick="deleteTemplate(${template.id}, '${template.name}')" class="btn-danger" style="padding: 0.375rem 0.75rem; font-size: 0.875rem;" title="Delete">
                                <svg class="ucm-icon" width="14" height="14"><use href="#icon-trash"/></svg>
                            </button>
                        ` : ''}
                    </div>
                </div>
                <div style="display: grid; grid-template-columns: repeat(auto-fit, minmax(150px, 1fr)); gap: 0.75rem; font-size: 0.75rem; color: var(--text-secondary);">
                    <div>
                        <strong>Type:</strong> ${template.template_type}
                    </div>
                    <div>
                        <strong>Key:</strong> ${template.key_type}
                    </div>
                    <div>
                        <strong>Validity:</strong> ${template.validity_days} days
                    </div>
                    <div>
                        <strong>EKU:</strong> ${eku}
                    </div>
                </div>
            </div>
        `;
    });
    
    html += '</div>';
    container.innerHTML = html;
}

function openCreateTemplateModal() {
    document.getElementById('modal-title').textContent = 'Create Custom Template';
    document.getElementById('template-id').value = '';
    document.getElementById('templateForm').reset();
    document.getElementById('templateModal').style.display = 'flex';
}

function closeTemplateModal() {
    document.getElementById('templateModal').style.display = 'none';
}

function viewTemplate(id) {
    const token = getJWTToken();
    fetch(`/api/v1/templates/${id}`, {
        headers: {'Authorization': `Bearer ${token}`}
    })
        .then(response => response.json())
        .then(template => {
            alert(`Template: ${template.name}\n\nType: ${template.template_type}\nKey: ${template.key_type}\nValidity: ${template.validity_days} days\nDigest: ${template.digest}\n\nDN Template:\n${JSON.stringify(template.dn_template, null, 2)}\n\nExtensions:\n${JSON.stringify(template.extensions_template, null, 2)}`);
        })
        .catch(error => {
            console.error('Error:', error);
            showToast('Error loading template details', 'danger');
        });
}

function editTemplate(id) {
    const token = getJWTToken();
    fetch(`/api/v1/templates/${id}`, {
        headers: {'Authorization': `Bearer ${token}`}
    })
        .then(response => response.json())
        .then(template => {
            document.getElementById('modal-title').textContent = 'Edit Template';
            document.getElementById('template-id').value = template.id;
            document.getElementById('template-name').value = template.name;
            document.getElementById('template-description').value = template.description || '';
            document.getElementById('template-type').value = template.template_type;
            document.getElementById('template-key-type').value = template.key_type;
            document.getElementById('template-validity').value = template.validity_days;
            document.getElementById('template-digest').value = template.digest;
            
            // DN fields
            const dn = template.dn_template;
            document.getElementById('dn-cn').value = dn.CN || '';
            document.getElementById('dn-o').value = dn.O || '';
            document.getElementById('dn-ou').value = dn.OU || '';
            document.getElementById('dn-c').value = dn.C || '';
            document.getElementById('dn-st').value = dn.ST || '';
            document.getElementById('dn-l').value = dn.L || '';
            
            // Key Usage
            const ku = template.extensions_template.key_usage || [];
            document.getElementById('ku-digital-signature').checked = ku.includes('digitalSignature');
            document.getElementById('ku-key-encipherment').checked = ku.includes('keyEncipherment');
            document.getElementById('ku-data-encipherment').checked = ku.includes('dataEncipherment');
            document.getElementById('ku-key-agreement').checked = ku.includes('keyAgreement');
            
            // Extended Key Usage
            const eku = template.extensions_template.extended_key_usage || [];
            document.getElementById('eku-server-auth').checked = eku.includes('serverAuth');
            document.getElementById('eku-client-auth').checked = eku.includes('clientAuth');
            document.getElementById('eku-code-signing').checked = eku.includes('codeSigning');
            document.getElementById('eku-email-protection').checked = eku.includes('emailProtection');
            
            // SAN types
            const san = template.extensions_template.san_types || [];
            document.getElementById('san-dns').checked = san.includes('dns');
            document.getElementById('san-ip').checked = san.includes('ip');
            document.getElementById('san-email').checked = san.includes('email');
            document.getElementById('san-uri').checked = san.includes('uri');
            
            document.getElementById('templateModal').style.display = 'flex';
        })
        .catch(error => {
            console.error('Error:', error);
            showToast('Error loading template', 'danger');
        });
}

function deleteTemplate(id, name) {
    if (!confirm(`Are you sure you want to delete template "${name}"?\n\nThis action cannot be undone.`)) {
        return;
    }
    
    const token = getJWTToken();
    fetch(`/api/v1/templates/${id}`, {
        method: 'DELETE',
        headers: {'Authorization': `Bearer ${token}`}
    })
    .then(response => response.json())
    .then(data => {
        if (data.error) {
            showToast(data.error, 'danger');
        } else {
            showToast('Template deleted successfully', 'success');
            loadTemplates();
        }
    })
    .catch(error => {
        console.error('Error:', error);
        showToast('Error deleting template', 'danger');
    });
}

// Form submission
document.getElementById('templateForm').addEventListener('submit', function(e) {
    e.preventDefault();
    
    const templateId = document.getElementById('template-id').value;
    const isEdit = templateId !== '';
    
    // Collect Key Usage
    const keyUsage = [];
    if (document.getElementById('ku-digital-signature').checked) keyUsage.push('digitalSignature');
    if (document.getElementById('ku-key-encipherment').checked) keyUsage.push('keyEncipherment');
    if (document.getElementById('ku-data-encipherment').checked) keyUsage.push('dataEncipherment');
    if (document.getElementById('ku-key-agreement').checked) keyUsage.push('keyAgreement');
    
    // Collect Extended Key Usage
    const extKeyUsage = [];
    if (document.getElementById('eku-server-auth').checked) extKeyUsage.push('serverAuth');
    if (document.getElementById('eku-client-auth').checked) extKeyUsage.push('clientAuth');
    if (document.getElementById('eku-code-signing').checked) extKeyUsage.push('codeSigning');
    if (document.getElementById('eku-email-protection').checked) extKeyUsage.push('emailProtection');
    
    // Collect SAN types
    const sanTypes = [];
    if (document.getElementById('san-dns').checked) sanTypes.push('dns');
    if (document.getElementById('san-ip').checked) sanTypes.push('ip');
    if (document.getElementById('san-email').checked) sanTypes.push('email');
    if (document.getElementById('san-uri').checked) sanTypes.push('uri');
    
    const data = {
        name: document.getElementById('template-name').value,
        description: document.getElementById('template-description').value,
        template_type: document.getElementById('template-type').value,
        key_type: document.getElementById('template-key-type').value,
        validity_days: parseInt(document.getElementById('template-validity').value),
        digest: document.getElementById('template-digest').value,
        dn_template: {
            CN: document.getElementById('dn-cn').value,
            O: document.getElementById('dn-o').value,
            OU: document.getElementById('dn-ou').value,
            C: document.getElementById('dn-c').value,
            ST: document.getElementById('dn-st').value,
            L: document.getElementById('dn-l').value
        },
        extensions_template: {
            key_usage: keyUsage,
            extended_key_usage: extKeyUsage,
            basic_constraints: { ca: false },
            san_types: sanTypes
        }
    };
    
    const url = isEdit ? `/api/v1/templates/${templateId}` : '/api/v1/templates';
    const method = isEdit ? 'PUT' : 'POST';
    
    const token = getJWTToken();
    fetch(url, {
        method: method,
        headers: {
            'Content-Type': 'application/json',
            'Authorization': `Bearer ${token}`
        },
        body: JSON.stringify(data)
    })
    .then(response => response.json())
    .then(result => {
        if (result.error) {
            showToast(result.error, 'danger');
        } else {
            showToast(isEdit ? 'Template updated successfully' : 'Template created successfully', 'success');
            closeTemplateModal();
            loadTemplates();
        }
    })
    .catch(error => {
        console.error('Error:', error);
        showToast('Error saving template', 'danger');
    });
});

// Close modal on Escape key
document.addEventListener('keydown', function(e) {
    if (e.key === 'Escape' && document.getElementById('templateModal').style.display === 'flex') {
        closeTemplateModal();
    }
});
</script>

{% endblock %}

{% extends "base.html" %}

{% block title %}Settings - UCM{% endblock %}

{% block content %}
<div style="display: flex; flex-direction: column; gap: 1.5rem;">
    <div style="display: flex; justify-content: space-between; align-items: center;">
        <h1 style="font-size: 1.875rem; font-weight: bold; color: var(--text-primary);">
            <svg class="ucm-icon" width="24" height="24" style="margin-right: 0.5rem;"><use href="#icon-settings"/></svg> System Settings
        </h1>
    </div>
    
    {% if session.get('role') != 'admin' %}
    <!-- Non-admin message -->
    <div class="card" style="padding: 3rem; text-align: center;">
        <svg class="ucm-icon" width="64" height="64" style="margin: 0 auto 1rem auto; opacity: 0.5;"><use href="#icon-shield"/></svg>
        <h2 style="font-size: 1.5rem; font-weight: 600; color: var(--text-primary); margin-bottom: 0.5rem;">Administrator Access Required</h2>
        <p style="color: var(--text-secondary); font-size: 1rem;">
            This page is only accessible to administrators. 
            <br>
            For your account settings, please visit <a href="/my-account" style="color: var(--primary-color); text-decoration: underline;">My Account</a>.
        </p>
    </div>
    {% else %}
    
    <!-- System Information -->
    <div class="card">
        <div style="padding: 1.5rem; border-bottom: 1px solid var(--border-color);">
            <h2 style="font-size: 1.25rem; font-weight: 600; color: var(--text-primary); display: flex; align-items: center; gap: 0.5rem;">
                <svg class="ucm-icon" width="20" height="20" style="color: var(--primary-color);"><use href="#icon-server"/></svg>
                System Information
            </h2>
        </div>
        <div style="padding: 1.5rem;">
            <div style="display: flex; flex-direction: column; gap: 0.75rem;">
                <div style="display: flex; justify-content: space-between; align-items: center; padding: 0.75rem; background: var(--bg-secondary); border-radius: 0.5rem;">
                    <span style="font-weight: 500; color: var(--text-secondary);">Version</span>
                    <span style="font-weight: 600; color: var(--text-primary);">1.5.0</span>
                </div>
                <div style="display: flex; justify-content: space-between; align-items: center; padding: 0.75rem; background: var(--bg-secondary); border-radius: 0.5rem;">
                    <span style="font-weight: 500; color: var(--text-secondary);">HTTPS Port</span>
                    <span style="font-weight: 600; color: var(--text-primary);">8443</span>
                </div>
                <div style="display: flex; justify-content: space-between; align-items: center; padding: 0.75rem; background: var(--bg-secondary); border-radius: 0.5rem;">
                    <span style="font-weight: 500; color: var(--text-secondary);">Database</span>
                    <span style="font-weight: 600; color: var(--text-primary);">SQLite</span>
                </div>
                <div style="display: flex; justify-content: space-between; align-items: center; padding: 0.75rem; background: var(--bg-secondary); border-radius: 0.5rem;">
                    <span style="font-weight: 500; color: var(--text-secondary);">Features</span>
                    <div style="display: flex; gap: 0.5rem; flex-wrap: wrap;">
                        <span class="badge-outline badge-success">
                            <svg class="ucm-icon" width="10" height="10"><use href="#icon-file"/></svg>
                            CRL
                        </span>
                        <span class="badge-outline badge-success">
                            <svg class="ucm-icon" width="10" height="10"><use href="#icon-check"/></svg>
                            OCSP
                        </span>
                        <span class="badge-outline badge-info">
                            <svg class="ucm-icon" width="10" height="10"><use href="#icon-shield"/></svg>
                            SCEP
                        </span>
                    </div>
                </div>
            </div>
        </div>
    </div>
    
    <!-- HTTPS Certificate -->
    <div class="card">
        <div style="padding: 1.5rem; border-bottom: 1px solid var(--border-color);">
            <h2 style="font-size: 1.25rem; font-weight: 600; color: var(--text-primary); display: flex; align-items: center; gap: 0.5rem;">
                <svg class="ucm-icon" width="20" height="20" style="color: var(--primary-color);"><use href="#icon-shield"/></svg>
                HTTPS Certificate
            </h2>
        </div>
        <div style="padding: 1.5rem;">
            <p style="font-size: 0.875rem; color: var(--text-secondary); margin-bottom: 1.5rem;">
                Configure the certificate used for the UCM web interface (HTTPS on port 8443).
            </p>
            
            <div style="background: var(--bg-secondary); border: 1px solid var(--border-color); border-radius: 0.5rem; padding: 1rem; margin-bottom: 1.5rem;">
                <h3 style="font-weight: 600; color: var(--text-primary); margin-bottom: 0.75rem; font-size: 0.875rem;">Current Certificate</h3>
                <div id="https-cert-info" style="display: flex; flex-direction: column; gap: 0.5rem; font-size: 0.875rem;">
                    <div style="display: flex; gap: 0.5rem;">
                        <span style="color: var(--text-secondary);">Type:</span>
                        <span style="color: var(--text-primary); font-weight: 600;" id="cert-type">Self-Signed</span>
                    </div>
                    <div style="display: flex; gap: 0.5rem;">
                        <span style="color: var(--text-secondary);">Subject:</span>
                        <span style="color: var(--text-primary);" id="cert-subject">-</span>
                    </div>
                    <div style="display: flex; gap: 0.5rem;">
                        <span style="color: var(--text-secondary);">Valid Until:</span>
                        <span style="color: var(--text-primary);" id="cert-expiry">-</span>
                    </div>
                </div>
            </div>
            
            <div style="margin-bottom: 1rem;">
                <p style="font-weight: 600; color: var(--text-primary); margin-bottom: 0.75rem; font-size: 0.875rem;">Certificate Source</p>
                <div style="display: flex; flex-direction: column; gap: 0.75rem;">
                    <label style="display: flex; align-items: start; gap: 0.75rem; padding: 0.75rem; border: 1px solid var(--border-color); border-radius: 0.5rem; cursor: pointer;">
                        <input type="radio" name="cert-source" value="auto" checked style="margin-top: 0.25rem;" onchange="toggleCertSelector()">
                        <div>
                            <div style="font-weight: 600; color: var(--text-primary);">Auto-generated (Self-signed)</div>
                            <div style="font-size: 0.75rem; color: var(--text-secondary);">Use the automatically generated self-signed certificate (default)</div>
                        </div>
                    </label>
                    <label style="display: flex; align-items: start; gap: 0.75rem; padding: 0.75rem; border: 1px solid var(--border-color); border-radius: 0.5rem; cursor: pointer;">
                        <input type="radio" name="cert-source" value="managed" style="margin-top: 0.25rem;" onchange="toggleCertSelector()">
                        <div style="flex: 1;">
                            <div style="font-weight: 600; color: var(--text-primary);">UCM Managed Certificate</div>
                            <div style="font-size: 0.75rem; color: var(--text-secondary); margin-bottom: 0.75rem;">Use a certificate from UCM's certificate store</div>
                            <div id="cert-selector-container" style="display: none; margin-top: 0.75rem;">
                                <label style="display: block; font-size: 0.75rem; color: var(--text-secondary); margin-bottom: 0.25rem;">Select Server Certificate:</label>
                                <select id="managed-cert-id" class="form-input" style="width: 100%; padding: 0.5rem; border: 1px solid var(--border-color); border-radius: 0.375rem; background: var(--card-bg); color: var(--text-primary);">
                                    <option value="">Loading certificates...</option>
                                </select>
                                <div id="cert-details" style="margin-top: 0.5rem; padding: 0.5rem; background: var(--bg-secondary); border-radius: 0.375rem; font-size: 0.75rem; display: none;">
                                    <div style="color: var(--text-secondary);">
                                        <div><strong>Subject:</strong> <span id="selected-cert-subject">-</span></div>
                                        <div><strong>Expires:</strong> <span id="selected-cert-expiry">-</span></div>
                                    </div>
                                </div>
                            </div>
                        </div>
                    </label>
                </div>
            </div>
            
            <div style="display: flex; gap: 1rem; padding-top: 0.5rem;">
                <button onclick="applyHTTPSCertificate()" class="btn btn-primary">
                    <svg class="ucm-icon" width="16" height="16" style="margin-right: 0.5rem;"><use href="#icon-check"/></svg>
                    Apply Certificate
                </button>
                <button onclick="regenerateSelfSigned()" class="btn btn-secondary">
                    <svg class="ucm-icon" width="16" height="16" style="margin-right: 0.5rem;"><use href="#icon-refresh"/></svg>
                    Regenerate Self-Signed
                </button>
            </div>
            
            <div style="margin-top: 1rem; padding: 0.75rem; background: var(--bg-secondary); border-radius: 0.5rem; font-size: 0.75rem; color: var(--text-secondary);">
                <p style="margin-bottom: 0.25rem;"><strong>Important Notes:</strong></p>
                <ul style="list-style: disc; margin-left: 1.25rem;">
                    <li>Changing the certificate will restart the UCM service</li>
                    <li>You will be disconnected and need to reload the page</li>
                    <li>The certificate must be valid and match the server's hostname/IP</li>
                    <li>The private key must be available in UCM's keystore</li>
                </ul>
            </div>
        </div>
    </div>
    
    <!-- PKI Database Management -->
    <div class="card">
        <div style="padding: 1.5rem; border-bottom: 1px solid var(--border-color);">
            <h2 style="font-size: 1.25rem; font-weight: 600; color: var(--text-primary); display: flex; align-items: center; gap: 0.5rem;">
                <svg class="ucm-icon" width="20" height="20" style="color: var(--primary-color);"><use href="#icon-database"/></svg>
                PKI Database Management
            </h2>
        </div>
        <div style="padding: 1.5rem;">
            <p style="font-size: 0.875rem; color: var(--text-secondary); margin-bottom: 1.5rem;">
                Reset the PKI database to start fresh. This will delete all CAs, certificates, CRLs, and OCSP records, but <strong>will preserve users and authentication settings</strong>.
            </p>
            
            <div style="background: var(--card-bg); border: 1px solid var(--border-color); border-radius: 0.5rem; padding: 1rem; margin-bottom: 1.5rem;">
                <h3 style="font-size: 0.875rem; font-weight: 600; color: var(--text-primary); margin-bottom: 0.75rem;">Current PKI Data</h3>
                <div style="display: grid; grid-template-columns: repeat(auto-fit, minmax(120px, 1fr)); gap: 1rem;">
                    <div>
                        <div style="font-size: 0.75rem; color: var(--text-secondary);">CAs</div>
                        <div style="font-size: 1.5rem; font-weight: 700; color: var(--text-primary);" id="pki-stat-cas">0</div>
                    </div>
                    <div>
                        <div style="font-size: 0.75rem; color: var(--text-secondary);">Certificates</div>
                        <div style="font-size: 1.5rem; font-weight: 700; color: var(--text-primary);" id="pki-stat-certs">0</div>
                    </div>
                    <div>
                        <div style="font-size: 0.75rem; color: var(--text-secondary);">CRLs</div>
                        <div style="font-size: 1.5rem; font-weight: 700; color: var(--text-primary);" id="pki-stat-crls">0</div>
                    </div>
                    <div>
                        <div style="font-size: 0.75rem; color: var(--text-secondary);">OCSP Records</div>
                        <div style="font-size: 1.5rem; font-weight: 700; color: var(--text-primary);" id="pki-stat-ocsp">0</div>
                    </div>
                </div>
            </div>
            
            <div style="background: #fef3c7; border: 1px solid #fbbf24; border-radius: 0.5rem; padding: 1rem; margin-bottom: 1.5rem;">
                <div style="display: flex; align-items: start; gap: 0.75rem;">
                    <svg class="ucm-icon" width="20" height="20" style="color: #d97706; margin-top: 0.125rem;"><use href="#icon-warning-triangle"/></svg>
                    <div style="font-size: 0.875rem; color: #92400e;">
                        <p style="font-weight: 600; margin-bottom: 0.5rem;">⚠️ Danger Zone</p>
                        <ul style="list-style: disc; margin-left: 1.25rem; display: flex; flex-direction: column; gap: 0.25rem;">
                            <li>This action <strong>cannot be undone</strong></li>
                            <li>All Certificate Authorities will be deleted</li>
                            <li>All certificates will be deleted</li>
                            <li>All CRLs and OCSP records will be deleted</li>
                            <li>A backup will be created automatically</li>
                            <li><strong>Users and sessions will NOT be affected</strong></li>
                        </ul>
                    </div>
                </div>
            </div>
            
            <button onclick="confirmPKIReset()" class="btn btn-danger">
                <svg class="ucm-icon" width="16" height="16" style="margin-right: 0.5rem;"><use href="#icon-trash"/></svg>
                Reset PKI Database
            </button>
        </div>
    </div>
    
    {% endif %}
</div>

<script>
// Load HTTPS cert info on page load
document.addEventListener('DOMContentLoaded', function() {
    loadHTTPSCertInfo();
    loadPKIStats();
    loadCertificateCandidates();
});

function loadHTTPSCertInfo() {
    fetch('/api/ui/system/https-cert-info')
        .then(response => response.json())
        .then(data => {
            if (data.subject) document.getElementById('cert-subject').textContent = data.subject;
            if (data.expires) document.getElementById('cert-expiry').textContent = data.expires;
            if (data.type) document.getElementById('cert-type').textContent = data.type;
        })
        .catch(error => console.error('Error loading HTTPS cert info:', error));
}

function loadCertificateCandidates() {
    fetch('/api/ui/system/https-cert-candidates')
        .then(response => response.json())
        .then(data => {
            const select = document.getElementById('managed-cert-id');
            select.innerHTML = '';
            
            if (!data.certificates || data.certificates.length === 0) {
                select.innerHTML = '<option value="">No suitable server certificates found</option>';
                return;
            }
            
            select.innerHTML = '<option value="">-- Select a certificate --</option>';
            data.certificates.forEach(cert => {
                const option = document.createElement('option');
                option.value = cert.id;
                option.textContent = `${cert.common_name} (expires: ${cert.expires})`;
                option.dataset.subject = cert.subject;
                option.dataset.expires = cert.expires;
                select.appendChild(option);
            });
        })
        .catch(error => {
            console.error('Error loading certificate candidates:', error);
            document.getElementById('managed-cert-id').innerHTML = '<option value="">Error loading certificates</option>';
        });
}

function toggleCertSelector() {
    const source = document.querySelector('input[name="cert-source"]:checked').value;
    const container = document.getElementById('cert-selector-container');
    if (source === 'managed') {
        container.style.display = 'block';
    } else {
        container.style.display = 'none';
    }
}

// Show cert details when a certificate is selected
document.addEventListener('DOMContentLoaded', function() {
    const select = document.getElementById('managed-cert-id');
    select.addEventListener('change', function() {
        const details = document.getElementById('cert-details');
        if (this.value && this.selectedOptions[0].dataset.subject) {
            document.getElementById('selected-cert-subject').textContent = this.selectedOptions[0].dataset.subject;
            document.getElementById('selected-cert-expiry').textContent = this.selectedOptions[0].dataset.expires;
            details.style.display = 'block';
        } else {
            details.style.display = 'none';
        }
    });
});

function loadPKIStats() {
    fetch('/api/ui/system/pki-stats')
        .then(response => response.json())
        .then(data => {
            if (data.cas !== undefined) document.getElementById('pki-stat-cas').textContent = data.cas;
            if (data.certificates !== undefined) document.getElementById('pki-stat-certs').textContent = data.certificates;
            if (data.crls !== undefined) document.getElementById('pki-stat-crls').textContent = data.crls;
            if (data.ocsp_responses !== undefined) document.getElementById('pki-stat-ocsp').textContent = data.ocsp_responses;
        })
        .catch(error => console.error('Error loading PKI stats:', error));
}

function applyHTTPSCertificate() {
    const source = document.querySelector('input[name="cert-source"]:checked').value;
    
    // Validate managed cert selection
    if (source === 'managed') {
        const certId = document.getElementById('managed-cert-id').value;
        if (!certId) {
            ucmAlert('Please select a certificate from the list', 'Error');
            return;
        }
    }
    
    ucmConfirm(
        'Applying a new certificate will restart UCM and disconnect your session. Continue?',
        'Apply Certificate',
        { danger: true, confirmText: 'Apply', icon: 'warning-triangle' }
    ).then(confirmed => {
        if (!confirmed) return;
        
        const requestBody = { source: source };
        if (source === 'managed') {
            requestBody.cert_id = parseInt(document.getElementById('managed-cert-id').value);
        }
        
        fetch('/api/ui/system/https-cert-apply', {
            method: 'POST',
            headers: { 'Content-Type': 'application/json' },
            body: JSON.stringify(requestBody)
        })
        .then(response => response.json())
        .then(data => {
            if (data.success) {
                ucmAlert('Certificate applied. UCM is restarting...', 'Success');
                setTimeout(() => window.location.reload(), 3000);
            } else {
                ucmAlert('Error: ' + (data.error || data.message || 'Unknown error'), 'Error');
            }
        })
        .catch(error => {
            console.error('Error:', error);
            ucmAlert('Failed to apply certificate', 'Error');
        });
    });
}

function regenerateSelfSigned() {
    ucmConfirm(
        'This will generate a new self-signed certificate and restart UCM. Continue?',
        'Regenerate Certificate',
        { danger: true, confirmText: 'Regenerate', icon: 'warning-triangle' }
    ).then(confirmed => {
        if (!confirmed) return;
        
        fetch('/api/ui/system/https-cert-regenerate', {
            method: 'POST'
        })
        .then(response => response.json())
        .then(data => {
            if (data.success) {
                ucmAlert('Certificate regenerated. UCM is restarting...', 'Success');
                setTimeout(() => window.location.reload(), 3000);
            } else {
                ucmAlert('Error: ' + data.message, 'Error');
            }
        })
        .catch(error => {
            console.error('Error:', error);
            ucmAlert('Failed to regenerate certificate', 'Error');
        });
    });
}

function confirmPKIReset() {
    ucmConfirm(
        '⚠️ DANGER: This will DELETE:\n\n' +
        '• All Certificate Authorities\n' +
        '• All Certificates\n' +
        '• All CRLs and OCSP records\n\n' +
        'A backup will be created automatically.\n' +
        'Users and sessions will NOT be affected.\n\n' +
        'Type "RESET PKI DATA" in the next prompt to confirm.',
        'Reset PKI Database?',
        { danger: true, confirmText: 'Continue', icon: 'warning-triangle' }
    ).then(confirmed => {
        if (!confirmed) return;
        
        // Create custom prompt modal for text confirmation
        const promptHTML = `
            <div class="ucm-modal-overlay" onclick="event.stopPropagation()">
                <div class="ucm-modal" onclick="event.stopPropagation()">
                    <div class="ucm-modal-header">
                        <div style="display: flex; align-items: center; gap: 0.75rem;">
                            <svg class="ucm-icon" width="24" height="24" style="color: var(--status-danger);"><use href="#icon-warning-triangle"/></svg>
                            <h2 class="ucm-modal-title">⚠️ Final Confirmation Required</h2>
                        </div>
                    </div>
                    <div class="ucm-modal-body">
                        <p style="margin-bottom: 1rem;">Type exactly: <strong>RESET PKI DATA</strong></p>
                        <input type="text" id="pki-reset-confirmation" class="form-input" placeholder="RESET PKI DATA" style="width: 100%;">
                    </div>
                    <div class="ucm-modal-footer">
                        <button class="btn btn-secondary" onclick="document.getElementById('ucm-modal-container').innerHTML = ''">
                            Cancel
                        </button>
                        <button class="btn btn-danger" onclick="executePKIReset()">
                            Reset Database
                        </button>
                    </div>
                </div>
            </div>
        `;
        
        document.getElementById('ucm-modal-container').innerHTML = promptHTML;
        document.getElementById('pki-reset-confirmation').focus();
    });
}

function executePKIReset() {
    const confirmation = document.getElementById('pki-reset-confirmation').value;
    
    if (confirmation !== 'RESET PKI DATA') {
        ucmAlert('❌ Confirmation failed. Text did not match.\n\nPKI reset cancelled.', 'Confirmation Failed');
        document.getElementById('ucm-modal-container').innerHTML = '';
        return;
    }
    
    document.getElementById('ucm-modal-container').innerHTML = '';
    
    fetch('/api/ui/system/pki-reset', {
        method: 'POST',
        headers: { 'Content-Type': 'application/json' },
        body: JSON.stringify({ confirmation: 'RESET PKI DATA' })
    })
    .then(response => response.json())
    .then(data => {
        if (data.success) {
            ucmAlert('✅ PKI Database has been reset successfully!\n\nBackup created: ' + data.backup_file, 'Success');
            loadPKIStats();
        } else {
            ucmAlert('Error: ' + data.message, 'Error');
        }
    })
    .catch(error => {
        console.error('Error:', error);
        ucmAlert('Failed to reset PKI database', 'Error');
    });
}
</script>
{% endblock %}

{% extends "base.html" %}

{% block title %}Settings - UCM{% endblock %}

{% block content %}
<div style="display: flex; flex-direction: column; gap: 1.5rem;">
    <div style="display: flex; justify-content: space-between; align-items: center;">
        <h1 style="font-size: 1.875rem; font-weight: 600; color: var(--text-primary); margin: 0; display: flex; align-items: center; gap: 0.5rem;">
            <svg class="ucm-icon" width="24" height="24"><use href="#icon-settings"/></svg>
            <span>System Settings</span>
        </h1>
    </div>
    
    {% if session.get('role') != 'admin' %}
    <!-- Non-admin message -->
    <div class="card" style="padding: 3rem; text-align: center;">
        <svg class="ucm-icon" width="64" height="64" style="margin: 0 auto 1rem auto; opacity: 0.5;"><use href="#icon-shield"/></svg>
        <h2 style="font-size: 1.5rem; font-weight: 600; color: var(--text-primary); margin-bottom: 0.5rem;">Administrator Access Required</h2>
        <p style="color: var(--text-secondary); font-size: 1rem;">
            This page is only accessible to administrators. 
            <br>
            For your account settings, please visit <a href="/my-account" style="color: var(--primary-color); text-decoration: underline;">My Account</a>.
        </p>
    </div>
    {% else %}
    
    <!-- Settings Tabs -->
    <div class="tabs-container" style="display: flex; gap: 0; margin-bottom: 2rem; border-bottom: 2px solid var(--border-color); overflow-x: auto;">
        <button class="tab-button active" onclick="ucm_switchTab('general')" id="btn-tab-general" style="padding: 1rem 2rem; font-size: 0.95rem; font-weight: 600; color: var(--primary-color); border-bottom: 3px solid var(--primary-color); background: none; border-top: none; border-left: none; border-right: none; cursor: pointer; min-height: 3.5rem; white-space: nowrap;">
            <svg class="ucm-icon" width="18" height="18" style="margin-right: 8px;"><use href="#icon-info-circle"/></svg> General
        </button>
        <button class="tab-button" onclick="ucm_switchTab('https')" id="btn-tab-https" style="padding: 1rem 2rem; font-size: 0.95rem; font-weight: 500; color: var(--text-secondary); border-bottom: 3px solid transparent; background: none; border-top: none; border-left: none; border-right: none; cursor: pointer; min-height: 3.5rem; white-space: nowrap;">
            <svg class="ucm-icon" width="18" height="18"><use href="#icon-lock"/></svg> HTTPS
        </button>
        <button class="tab-button" onclick="ucm_switchTab('authentication')" id="btn-tab-authentication" style="padding: 1rem 2rem; font-size: 0.95rem; font-weight: 500; color: var(--text-secondary); border-bottom: 3px solid transparent; background: none; border-top: none; border-left: none; border-right: none; cursor: pointer; min-height: 3.5rem; white-space: nowrap;">
            <svg class="ucm-icon" width="18" height="18" style="margin-right: 8px;"><use href="#icon-key"/></svg> Authentication
        </button>
        <button class="tab-button" onclick="ucm_switchTab('email')" id="btn-tab-email" style="padding: 1rem 2rem; font-size: 0.95rem; font-weight: 500; color: var(--text-secondary); border-bottom: 3px solid transparent; background: none; border-top: none; border-left: none; border-right: none; cursor: pointer; min-height: 3.5rem; white-space: nowrap;">
            <svg class="ucm-icon" width="18" height="18"><use href="#icon-mail"/></svg> Email
        </button>
        <button class="tab-button" onclick="ucm_switchTab('users')" id="btn-tab-users" style="padding: 1rem 2rem; font-size: 0.95rem; font-weight: 500; color: var(--text-secondary); border-bottom: 3px solid transparent; background: none; border-top: none; border-left: none; border-right: none; cursor: pointer; min-height: 3.5rem; white-space: nowrap;">
            <svg class="ucm-icon" width="18" height="18"><use href="#icon-users"/></svg> Users
        </button>
        <button class="tab-button" onclick="ucm_switchTab('database')" id="btn-tab-database" style="padding: 1rem 2rem; font-size: 0.95rem; font-weight: 500; color: var(--text-secondary); border-bottom: 3px solid transparent; background: none; border-top: none; border-left: none; border-right: none; cursor: pointer; min-height: 3.5rem; white-space: nowrap;">
            <svg class="ucm-icon" width="18" height="18" style="margin-right: 8px;"><use href="#icon-database"/></svg> Database
        </button>
        
    </div>
    
    <!-- Tab: General -->
    <div id="tab-general" class="tab-content active">
        
        <!-- System Information -->
        <div class="card">
            <div class="card-header">
                <h2 style="display: flex; align-items: center; gap: 0.5rem;">
                    <svg class="ucm-icon" width="20" height="20" style="color: var(--primary-color);"><use href="#icon-server"/></svg>
                    System Information
                </h2>
            </div>
            <div hx-get="/api/ui/settings/system-info" hx-trigger="intersect once" hx-swap="innerHTML" style="padding: 1.5rem;">
                <div style="text-align: center; padding: 2rem;">
                    <svg class="ucm-icon spinner" width="32" height="32"><use href="#icon-spinner"/></svg>
                    <p style="margin-top: 1rem; color: var(--text-secondary);">Loading system info...</p>
                </div>
            </div>
        </div>
        
        <!-- Session Configuration -->
        <div class="card">
            <div class="card-header">
                <h2 style="display: flex; align-items: center; gap: 0.5rem;">
                    <svg class="ucm-icon" width="20" height="20" style="color: var(--primary-color);"><use href="#icon-clock"/></svg>
                    Session Configuration
                </h2>
            </div>
            <div hx-get="/api/ui/settings/session-config" hx-trigger="intersect once" hx-swap="innerHTML" style="padding: 1.5rem;">
                <div style="text-align: center; padding: 2rem;">
                    <svg class="ucm-icon spinner" width="32" height="32"><use href="#icon-spinner"/></svg>
                    <p style="margin-top: 1rem; color: var(--text-secondary);">Loading session config...</p>
                </div>
            </div>
        </div>
        
        <!-- UI Preferences -->
        <div class="card">
            <div class="card-header">
                <h2 style="display: flex; align-items: center; gap: 0.5rem;">
                    <svg class="ucm-icon" width="20" height="20" style="color: var(--primary-color);"><use href="#icon-palette"/></svg>
                    UI Preferences
                </h2>
            </div>
            <div hx-get="/api/ui/settings/ui-prefs" hx-trigger="intersect once" hx-swap="innerHTML" style="padding: 1.5rem;">
                <div style="text-align: center; padding: 2rem;">
                    <svg class="ucm-icon spinner" width="32" height="32"><use href="#icon-spinner"/></svg>
                    <p style="margin-top: 1rem; color: var(--text-secondary);">Loading UI preferences...</p>
                </div>
            </div>
        </div>
        
        <!-- Default Certificate Settings -->
        <div class="card">
            <div class="card-header">
                <h2 style="display: flex; align-items: center; gap: 0.5rem;">
                    <svg class="ucm-icon" width="20" height="20" style="color: var(--primary-color);"><use href="#icon-award"/></svg>
                    Default Certificate Settings
                </h2>
            </div>
            <div hx-get="/api/ui/settings/cert-defaults" hx-trigger="intersect once" hx-swap="innerHTML" style="padding: 1.5rem;">
                <div style="text-align: center; padding: 2rem;">
                    <svg class="ucm-icon spinner" width="32" height="32"><use href="#icon-spinner"/></svg>
                    <p style="margin-top: 1rem; color: var(--text-secondary);">Loading certificate defaults...</p>
                </div>
            </div>
        </div>
        
    </div><!-- End Tab: General -->
    
    <!-- Tab: HTTPS Certificate -->
    <div id="tab-https" class="tab-content" style="display: none;">
        
        <!-- Password Policy -->
        <div class="card">
            <div class="card-header">
                <h2 style="display: flex; align-items: center; gap: 0.5rem;">
                    <svg class="ucm-icon" width="20" height="20" style="color: var(--primary-color);"><use href="#icon-lock"/></svg>
                    Password Policy
                </h2>
            </div>
            <div hx-get="/api/ui/settings/password-policy" hx-trigger="revealed" hx-swap="innerHTML" style="padding: 1.5rem;">
                <div style="text-align: center; padding: 2rem;">
                    <svg class="ucm-icon spinner" width="32" height="32"><use href="#icon-spinner"/></svg>
                    <p style="margin-top: 1rem; color: var(--text-secondary);">Loading password policy...</p>
                </div>
            </div>
        </div>
        
        <!-- Session Security -->
        <div class="card">
            <div class="card-header">
                <h2 style="display: flex; align-items: center; gap: 0.5rem;">
                    <svg class="ucm-icon" width="20" height="20" style="color: var(--primary-color);"><use href="#icon-shield"/></svg>
                    Session Security
                </h2>
            </div>
            <div hx-get="/api/ui/settings/session-security" hx-trigger="revealed" hx-swap="innerHTML" style="padding: 1.5rem;">
                <div style="text-align: center; padding: 2rem;">
                    <svg class="ucm-icon spinner" width="32" height="32"><use href="#icon-spinner"/></svg>
                    <p style="margin-top: 1rem; color: var(--text-secondary);">Loading session security...</p>
                </div>
            </div>
        </div>
        
        <!-- HTTPS Certificate -->
        <div class="card">
            <div class="card-header">
                <h2 style="display: flex; align-items: center; gap: 0.5rem;">
                    <svg class="ucm-icon" width="20" height="20" style="color: var(--primary-color);"><use href="#icon-file-text"/></svg>
                    HTTPS Certificate
                </h2>
            </div>
            <div hx-get="/api/ui/settings/https-cert" hx-trigger="revealed" hx-swap="innerHTML" style="padding: 1.5rem;">
                <div style="text-align: center; padding: 2rem;">
                    <svg class="ucm-icon spinner" width="32" height="32"><use href="#icon-spinner"/></svg>
                    <p style="margin-top: 1rem; color: var(--text-secondary);">Loading certificate info...</p>
                </div>
            </div>
        </div>
        
    </div><!-- End Tab: HTTPS -->
    
    <!-- Tab: Authentication -->
    <div id="tab-authentication" class="tab-content" style="display: none;">
        
        <!-- mTLS Authentication -->
        <div class="card">
            <div class="card-header">
                <h2 style="display: flex; align-items: center; gap: 0.5rem;">
                    <svg class="ucm-icon" width="20" height="20" style="color: var(--primary-color);"><use href="#icon-shield-check"/></svg>
                    mTLS Authentication
                </h2>
            </div>
            <div hx-get="/api/ui/settings/mtls" hx-trigger="revealed" hx-swap="innerHTML" style="padding: 1.5rem;">
                <div style="text-align: center; padding: 2rem;">
                    <svg class="ucm-icon spinner" width="32" height="32"><use href="#icon-spinner"/></svg>
                    <p style="margin-top: 1rem; color: var(--text-secondary);">Loading mTLS settings...</p>
                </div>
            </div>
        </div>
        
        </div><!-- End Tab: Authentication -->
    
    <!-- Tab: Email -->
    <div id="tab-email" class="tab-content" style="display: none;">
        
        <!-- SMTP Configuration -->
        <div class="card">
            <div class="card-header">
                <h2 style="display: flex; align-items: center; gap: 0.5rem;">
                    <svg class="ucm-icon" width="20" height="20" style="color: var(--primary-color);"><use href="#icon-mail"/></svg>
                    SMTP Configuration
                </h2>
            </div>
            <div hx-get="/api/ui/settings/email" hx-trigger="revealed" hx-swap="innerHTML" style="padding: 1.5rem;">
                <div style="text-align: center; padding: 2rem;">
                    <svg class="ucm-icon spinner" width="32" height="32"><use href="#icon-spinner"/></svg>
                    <p style="margin-top: 1rem; color: var(--text-secondary);">Loading email settings...</p>
                </div>
            </div>
        </div>
        
    </div><!-- End Tab: Email -->
    
    <!-- Tab: Users -->
    <div id="tab-users" class="tab-content" style="display: none;">
        
        <!-- User Management -->
        <div class="card">
            <div class="card-header">
                <h2 style="display: flex; align-items: center; gap: 0.5rem;">
                    <svg class="ucm-icon" width="20" height="20" style="color: var(--primary-color);"><use href="#icon-users"/></svg>
                    User Management
                </h2>
            </div>
            <div hx-get="/api/ui/settings/users" hx-trigger="revealed, refreshUsers from:body" hx-swap="innerHTML">
                <div style="text-align: center; padding: 2rem;">
                    <svg class="ucm-icon spinner" width="32" height="32"><use href="#icon-spinner"/></svg>
                    <p style="margin-top: 1rem; color: var(--text-secondary);">Loading users...</p>
                </div>
            </div>
        </div>
        
    </div><!-- End Tab: Users -->
    
    <!-- Tab: Database -->
    <div id="tab-database" class="tab-content" style="display: none;">
        
        <!-- Database Statistics -->
        <div class="card">
            <div class="card-header">
                <h2 style="display: flex; align-items: center; gap: 0.5rem;">
                    <svg class="ucm-icon" width="20" height="20" style="color: var(--primary-color);"><use href="#icon-database"/></svg>
                    Database Statistics
                </h2>
            </div>
            <div hx-get="/api/ui/settings/database-stats" hx-trigger="revealed" hx-swap="innerHTML" style="padding: 1.5rem;">
                <div style="text-align: center; padding: 2rem;">
                    <svg class="ucm-icon spinner" width="32" height="32"><use href="#icon-spinner"/></svg>
                    <p style="margin-top: 1rem; color: var(--text-secondary);">Loading database stats...</p>
                </div>
            </div>
        </div>
        
        <!-- Backup & Restore -->
        <div class="card">
            <div class="card-header">
                <h2 style="display: flex; align-items: center; gap: 0.5rem;">
                    <svg class="ucm-icon" width="20" height="20" style="color: var(--primary-color);"><use href="#icon-download"/></svg>
                    Backup & Restore
                </h2>
            </div>
            <div hx-get="/api/ui/settings/backup" hx-trigger="revealed" hx-swap="innerHTML" style="padding: 1.5rem;">
                <div style="text-align: center; padding: 2rem;">
                    <svg class="ucm-icon spinner" width="32" height="32"><use href="#icon-spinner"/></svg>
                    <p style="margin-top: 1rem; color: var(--text-secondary);">Loading backup options...</p>
                </div>
            </div>
        </div>
        
    </div><!-- End Tab: Database -->
    
    {% endif %}
</div>

<script>
// ============================================
// UCM TAB MANAGEMENT
// ============================================
function ucm_switchTab(tabName) {
    // Hide all tabs
    document.querySelectorAll('.tab-content').forEach(tab => {
        tab.style.display = 'none';
        tab.classList.remove('active');
    });
    
    // Show selected tab
    const selectedTab = document.getElementById('tab-' + tabName);
    if (selectedTab) {
        selectedTab.style.display = 'block';
        selectedTab.classList.add('active');
        
        // Force HTMX to process all hx-trigger elements in the newly visible tab
        setTimeout(() => {
            htmx.process(selectedTab);
        }, 10);
    }
    
    // Update tab buttons
    document.querySelectorAll('.tab-button').forEach(btn => {
        btn.classList.remove('active');
        btn.style.fontWeight = '500';
        btn.style.color = 'var(--text-secondary)';
        btn.style.borderBottom = '3px solid transparent';
    });
    
    const selectedBtn = document.getElementById('btn-tab-' + tabName);
    if (selectedBtn) {
        selectedBtn.classList.add('active');
        selectedBtn.style.fontWeight = '600';
        selectedBtn.style.color = 'var(--primary-color)';
        selectedBtn.style.borderBottom = '3px solid var(--primary-color)';
    }
    
    // Trigger HTMX event for lazy loading
    htmx.trigger(document.body, 'tab-' + tabName);
    
    // Save last tab
    localStorage.setItem('ucm-settings-tab', tabName);
    
    // Trigger HTMX load event for lazy-loaded tabs
    htmx.trigger(document.body, 'tab-' + tabName);
}

// Restore last tab on page load
document.addEventListener('DOMContentLoaded', function() {
    const lastTab = localStorage.getItem('ucm-settings-tab');
    if (lastTab && document.getElementById('tab-' + lastTab)) {
        ucm_switchTab(lastTab);
    }
});

// ============================================
// FORM HANDLING
// ============================================
function handleSaveResponse(event) {
    if (event.detail.successful) {
        showToast('Settings saved successfully', 'success');
    } else {
        showToast('Failed to save settings', 'error');
    }
}

// ============================================
// UTILITY FUNCTIONS
// ============================================
function showToast(message, type = 'info') {
    const toast = document.createElement('div');
    const bgColors = {
        success: '#10b981',
        error: '#ef4444',
        warning: '#f59e0b',
        info: '#3b82f6'
    };
    
    toast.style.cssText = `
        position: fixed; top: 20px; right: 20px; z-index: 10000;
        padding: 1rem 1.5rem; border-radius: 0.5rem; 
        box-shadow: 0 4px 12px rgba(0,0,0,0.15);
        background: ${bgColors[type] || bgColors.info};
        color: white; font-weight: 500; max-width: 400px;
    `;
    toast.textContent = message;
    document.body.appendChild(toast);
    setTimeout(() => toast.remove(), 4000);
}

function copyToClipboard(text) {
    navigator.clipboard.writeText(text).then(() => {
        showToast('Copied to clipboard', 'success');
    }).catch(() => {
        showToast('Failed to copy', 'error');
    });
}

// ============================================
// SYSTEM LOGS
// ============================================
function viewLogs(logType) {
    const display = document.getElementById('logs-display');
    const pre = display.querySelector('pre');
    
    display.style.display = 'block';
    pre.textContent = 'Loading logs...';
    
    const handler = function(evt) {
        if (evt.detail.pathInfo.requestPath === `/api/ui/system/logs/${logType}`) {
            try {
                const data = JSON.parse(evt.detail.xhr.responseText);
                if (data.success && data.logs) {
                    pre.textContent = data.logs;
                } else {
                    pre.textContent = 'No logs available';
                }
            } catch (error) {
                pre.textContent = 'Error loading logs: ' + error.message;
            }
            document.body.removeEventListener('htmx:afterRequest', handler);
        }
    };
    document.body.addEventListener('htmx:afterRequest', handler);
    htmx.ajax('GET', `/api/ui/system/logs/${logType}`, {swap: 'none'});
}

// ============================================
// SYSTEM COMMANDS
// ============================================
function restartService() {
    if (!confirm('Are you sure you want to restart the UCM service?\n\nThis will temporarily interrupt service.')) {
        return;
    }
    
    showToast('Restarting service...', 'info');
    
    const handler = function(evt) {
        if (evt.detail.pathInfo.requestPath === '/api/ui/system/restart') {
            if (evt.detail.successful) {
                showToast('Service restarted successfully', 'success');
                setTimeout(() => location.reload(), 2000);
            } else {
                showToast('Failed to restart service', 'error');
            }
            document.body.removeEventListener('htmx:afterRequest', handler);
        }
    };
    document.body.addEventListener('htmx:afterRequest', handler);
    htmx.ajax('POST', '/api/ui/system/restart', {swap: 'none'});
}

function reloadService() {
    showToast('Reloading service...', 'info');
    
    const handler = function(evt) {
        if (evt.detail.pathInfo.requestPath === '/api/ui/system/reload') {
            if (evt.detail.successful) {
                showToast('Service reloaded successfully', 'success');
            } else {
                showToast('Failed to reload service', 'error');
            }
            document.body.removeEventListener('htmx:afterRequest', handler);
        }
    };
    document.body.addEventListener('htmx:afterRequest', handler);
    htmx.ajax('POST', '/api/ui/system/reload', {swap: 'none'});
}

function clearCache() {
    if (!confirm('Clear all cached data?')) {
        return;
    }
    
    showToast('Clearing cache...', 'info');
    
    const handler = function(evt) {
        if (evt.detail.pathInfo.requestPath === '/api/ui/system/clear-cache') {
            if (evt.detail.successful) {
                showToast('Cache cleared successfully', 'success');
            } else {
                showToast('Failed to clear cache', 'error');
            }
            document.body.removeEventListener('htmx:afterRequest', handler);
        }
    };
    document.body.addEventListener('htmx:afterRequest', handler);
    htmx.ajax('POST', '/api/ui/system/clear-cache', {swap: 'none'});
}

// ============================================
// MODAL MANAGEMENT - Using global modal-utils.js functions
// ============================================
// window.openModal() and window.closeModal() are defined in modal-utils.js


// Close modal on overlay click
document.addEventListener('click', function(event) {
    if (event.target.classList.contains('modal-overlay')) {
        event.target.style.display = 'none';
        document.body.style.overflow = 'auto';
    }
});

// Close modal on Escape key
document.addEventListener('keydown', function(event) {
    if (event.key === 'Escape') {
        document.querySelectorAll('.modal-overlay').forEach(modal => {
            modal.style.display = 'none';
        });
        document.body.style.overflow = 'auto';
    }
});

</script>

<!-- Change Password Modal (for Users tab) -->
<div id="changePasswordModal" class="hidden" style="position: fixed; top: 64px; right: 0; bottom: 0; left: 240px; background: var(--modal-backdrop, rgba(0,0,0,0.5)); z-index: 1000; padding: 1rem;">
    <div style="display: flex; align-items: center; justify-content: center; height: 100%;">
        <div style="background: var(--card-bg); border-radius: 0.5rem; max-width: 500px; width: 100%; box-shadow: 0 25px 50px -12px rgba(0,0,0,0.25);">
            <div class="card-header">
                <div style="display: flex; justify-content: space-between; align-items: center;">
                    <h2 style="font-size: 1.5rem; font-weight: bold; color: var(--text-primary); display: flex; align-items: center; gap: 0.5rem;">
                        <svg class="ucm-icon" width="24" height="24"><use href="#icon-key"/></svg>
                        <span>Change Password</span>
                    </h2>
                </div>
                <p id="change-password-username" style="margin-top: 0.5rem; color: var(--text-secondary); font-size: 0.875rem;"></p>
            </div>
            
            <form hx-post="/api/ui/config/change-password"
                  hx-trigger="submit"
                  hx-swap="none"
                  hx-disabled-elt="find button[type='submit']"
                  hx-on::after-request="if(event.detail.successful){window.closeModal('changePasswordModal');if(typeof showToast==='function')showToast('Password changed successfully','success');}">
                <input type="hidden" id="change-password-user-id" name="user_id">
                
                <div style="padding: 1.5rem;">
                    <div style="margin-bottom: 1rem;">
                        <label class="modal-form-label">
                            New Password <span style="color: var(--danger-color);">*</span>
                        </label>
                        <input type="password" name="new_password" id="new-password-input" required 
                               minlength="8"
                               placeholder="Min. 8 characters"
                               class="modal-form-input">
                        <div id="password-strength" style="margin-top: 0.5rem; font-size: 0.75rem; display: none;">
                            <div style="display: flex; gap: 0.25rem; margin-bottom: 0.25rem;">
                                <div class="strength-bar"></div>
                                <div class="strength-bar"></div>
                                <div class="strength-bar"></div>
                                <div class="strength-bar"></div>
                            </div>
                            <div id="password-requirements" style="color: var(--text-secondary); line-height: 1.5;">
                                <div id="req-length">✗ At least 8 characters</div>
                                <div id="req-uppercase">✗ At least 1 uppercase letter</div>
                                <div id="req-lowercase">✗ At least 1 lowercase letter</div>
                                <div id="req-number">✗ At least 1 number</div>
                                <div id="req-special">✗ At least 1 special character</div>
                            </div>
                        </div>
                    </div>
                    
                    <div style="margin-bottom: 1rem;">
                        <label class="modal-form-label">
                            Confirm Password <span style="color: var(--danger-color);">*</span>
                        </label>
                        <input type="password" name="confirm_password" id="confirm-password-input" required 
                               minlength="8"
                               placeholder="Confirm new password"
                               class="modal-form-input">
                        <div id="password-match" style="margin-top: 0.5rem; font-size: 0.75rem; display: none;"></div>
                    </div>
                </div>
                
                <div class="modal-form-footer">
                    <button type="button" onclick="window.closeModal('changePasswordModal')"
                            class="btn-secondary">
                        Cancel
                    </button>
                    <button type="submit"
                            class="btn-primary">
                        <svg class="ucm-icon" width="16" height="16"><use href="#icon-key"/></svg> Change Password
                    </button>
                </div>
            </form>
        </div>
    </div>
</div>

<style>
.strength-bar {
    flex: 1;
    height: 4px;
    background: var(--border-color);
    border-radius: 2px;
    transition: background 0.3s;
}
.strength-bar.active-weak { background: var(--danger-color); }
.strength-bar.active-medium { background: var(--warning-color); }
.strength-bar.active-strong { background: var(--success-color); }
#password-requirements div { transition: color 0.2s; }
#password-requirements div.valid { color: var(--success-color); }
#password-requirements div.valid::before { content: '✓ '; }
</style>

<script>
(function() {
    const passwordInput = document.getElementById('new-password-input');
    const confirmInput = document.getElementById('confirm-password-input');
    const strengthDiv = document.getElementById('password-strength');
    const matchDiv = document.getElementById('password-match');
    
    if (!passwordInput || !confirmInput) return;
    
    function checkPassword(password) {
        const checks = {
            length: password.length >= 8,
            uppercase: /[A-Z]/.test(password),
            lowercase: /[a-z]/.test(password),
            number: /[0-9]/.test(password),
            special: /[!@#$%^&*(),.?":{}|<>]/.test(password)
        };
        
        // Update requirements
        document.getElementById('req-length').className = checks.length ? 'valid' : '';
        document.getElementById('req-uppercase').className = checks.uppercase ? 'valid' : '';
        document.getElementById('req-lowercase').className = checks.lowercase ? 'valid' : '';
        document.getElementById('req-number').className = checks.number ? 'valid' : '';
        document.getElementById('req-special').className = checks.special ? 'valid' : '';
        
        // Calculate strength
        const score = Object.values(checks).filter(Boolean).length;
        const bars = document.querySelectorAll('.strength-bar');
        bars.forEach((bar, i) => {
            bar.className = 'strength-bar';
            if (i < score) {
                if (score <= 2) bar.classList.add('active-weak');
                else if (score <= 4) bar.classList.add('active-medium');
                else bar.classList.add('active-strong');
            }
        });
        
        return checks;
    }
    
    passwordInput.addEventListener('input', function() {
        if (this.value) {
            strengthDiv.style.display = 'block';
            checkPassword(this.value);
        } else {
            strengthDiv.style.display = 'none';
        }
        
        // Check match if confirm has value
        if (confirmInput.value) {
            checkMatch();
        }
    });
    
    function checkMatch() {
        if (confirmInput.value) {
            matchDiv.style.display = 'block';
            if (confirmInput.value === passwordInput.value) {
                matchDiv.style.color = 'var(--success-color)';
                matchDiv.textContent = '✓ Passwords match';
            } else {
                matchDiv.style.color = 'var(--danger-color)';
                matchDiv.textContent = '✗ Passwords do not match';
            }
        } else {
            matchDiv.style.display = 'none';
        }
    }
    
    confirmInput.addEventListener('input', checkMatch);
})();
</script>


<!-- Change Role Modal (for Users tab) -->
<div id="changeRoleModal" class="hidden" style="position: fixed; top: 64px; right: 0; bottom: 0; left: 240px; background: var(--modal-backdrop, rgba(0,0,0,0.5)); z-index: 1000; padding: 1rem;">
    <div style="display: flex; align-items: center; justify-content: center; height: 100%;">
        <div style="background: var(--card-bg); border-radius: 0.5rem; max-width: 450px; width: 100%; box-shadow: 0 25px 50px -12px rgba(0,0,0,0.25);">
            <div class="card-header">
                <div style="display: flex; justify-content: space-between; align-items: center;">
                    <h2 style="font-size: 1.5rem; font-weight: bold; color: var(--text-primary); display: flex; align-items: center; gap: 0.5rem;">
                        <svg class="ucm-icon" width="24" height="24"><use href="#icon-shield-check"/></svg>
                        <span>Change Role</span>
                    </h2>
                    <button data-action="close-change-role-modal" style="color: var(--text-secondary); cursor: pointer; background: none; border: none;">
                        <svg class="ucm-icon" width="20" height="20"><use href="#icon-times"/></svg>
                    </button>
                </div>
                <p id="change-role-username" style="margin-top: 0.5rem; color: var(--text-secondary); font-size: 0.875rem;"></p>
            </div>
            
            <form hx-post="/api/ui/config/change-role"
                  hx-trigger="submit"
                  hx-swap="none"
                  hx-disabled-elt="find button[type='submit']"
                  hx-on::after-request="if(event.detail.successful){window.closeModal('changeRoleModal');htmx.trigger('body','refreshUsers');if(typeof showToast==='function')showToast('Role changed successfully','success');}">
                <input type="hidden" id="change-role-user-id" name="user_id">
                
                <div style="padding: 1.5rem;">
                    <label class="modal-form-label">
                        Select New Role <span style="color: var(--danger-color);">*</span>
                    </label>
                    
                    <div id="role-options" style="display: flex; flex-direction: column; gap: 0.75rem; margin-top: 0.5rem;">
                        <!-- Role options will be populated by JavaScript -->
                    </div>
                </div>
                
                <div class="modal-form-footer">
                    <button type="button" data-action="close-change-role-modal"
                            class="btn-secondary">
                        Cancel
                    </button>
                    <button type="submit"
                            class="btn-primary">
                        <svg class="ucm-icon" width="16" height="16"><use href="#icon-check-circle"/></svg> Change Role
                    </button>
                </div>
            </form>
        </div>
    </div>
</div>

<style>
.role-option {
    display: flex;
    align-items: center;
    padding: 0.75rem;
    border: 2px solid var(--border-color);
    border-radius: 0.5rem;
    cursor: pointer;
    transition: all 0.2s;
}
.role-option:hover {
    border-color: var(--primary-color);
    background: var(--bg-secondary);
}
.role-option input[type="radio"] {
    margin-right: 0.75rem;
    width: 1.25rem;
    height: 1.25rem;
    cursor: pointer;
}
</style>


<!-- Backup Modal -->
<div id="backupModal" class="hidden" style="position: fixed; top: 64px; right: 0; bottom: 0; left: 240px; background: var(--modal-backdrop, rgba(0,0,0,0.5)); z-index: 1000; padding: 1rem;">
    <div style="display: flex; align-items: center; justify-content: center; height: 100%;">
        <div style="background: var(--card-bg); border-radius: 0.5rem; max-width: 500px; width: 100%; box-shadow: 0 25px 50px -12px rgba(0,0,0,0.25);">
            <div class="card-header">
                <div style="display: flex; justify-content: space-between; align-items: center;">
                    <h2 style="font-size: 1.5rem; font-weight: bold; color: var(--text-primary); display: flex; align-items: center; gap: 0.5rem;">
                        <svg class="ucm-icon" width="24" height="24"><use href="#icon-download"/></svg>
                        <span>Create Backup</span>
                    </h2>
                    <button onclick="closeBackupModal()" style="color: var(--text-secondary); cursor: pointer; background: none; border: none;">
                        <svg class="ucm-icon" width="20" height="20"><use href="#icon-times"/></svg>
                    </button>
                </div>
            </div>
            
            <form hx-post="/api/ui/backup/create"
                  hx-encoding="multipart/form-data"
                  hx-trigger="submit"
                  hx-disabled-elt="find button[type='submit']"
                  hx-on::after-request="if(event.detail.successful){closeBackupModal();if(typeof showToast==='function')showToast('Backup created successfully','success');}">
                
                <div style="padding: 1.5rem;">
                    <div style="margin-bottom: 1.5rem;">
                        <label class="modal-form-label">
                            Backup Password <span style="color: var(--danger-color);">*</span>
                        </label>
                        <input type="password" name="password" required 
                               minlength="8"
                               placeholder="Strong password for encryption"
                               class="modal-form-input">
                        <small style="display: block; margin-top: 0.5rem; color: var(--text-secondary); font-size: 0.75rem;">
                            Keep this password safe - you'll need it to restore!
                        </small>
                    </div>
                    
                    <div style="margin-bottom: 1.5rem;">
                        <label class="modal-form-label">
                            Confirm Password <span style="color: var(--danger-color);">*</span>
                        </label>
                        <input type="password" name="password_confirm" required 
                               minlength="8"
                               placeholder="Confirm password"
                               class="modal-form-input">
                    </div>
                    
                    <div class="info-box">
                        <div class="info-box-content">
                            <p style="margin: 0; font-size: 0.875rem;">
                                <svg class="ucm-icon" width="14" height="14" style="vertical-align: text-bottom;"><use href="#icon-info-circle"/></svg>
                                Backup will include: All CAs, certificates, keys, users, and configuration
                            </p>
                        </div>
                    </div>
                </div>
                
                <div class="modal-form-footer">
                    <button type="button" onclick="closeBackupModal()" class="btn-secondary">
                        Cancel
                    </button>
                    <button type="submit" class="btn-primary">
                        <svg class="ucm-icon" width="16" height="16"><use href="#icon-download"/></svg> Create Backup
                    </button>
                </div>
            </form>
        </div>
    </div>
</div>

<!-- Restore Modal -->
<div id="restoreModal" class="hidden" style="position: fixed; top: 64px; right: 0; bottom: 0; left: 240px; background: var(--modal-backdrop, rgba(0,0,0,0.5)); z-index: 1000; padding: 1rem;">
    <div style="display: flex; align-items: center; justify-content: center; height: 100%;">
        <div style="background: var(--card-bg); border-radius: 0.5rem; max-width: 500px; width: 100%; box-shadow: 0 25px 50px -12px rgba(0,0,0,0.25);">
            <div class="card-header">
                <div style="display: flex; justify-content: space-between; align-items: center;">
                    <h2 style="font-size: 1.5rem; font-weight: bold; color: var(--text-primary); display: flex; align-items: center; gap: 0.5rem;">
                        <svg class="ucm-icon" width="24" height="24"><use href="#icon-upload"/></svg>
                        <span>Restore Backup</span>
                    </h2>
                    <button onclick="closeRestoreModal()" style="color: var(--text-secondary); cursor: pointer; background: none; border: none;">
                        <svg class="ucm-icon" width="20" height="20"><use href="#icon-times"/></svg>
                    </button>
                </div>
            </div>
            
            <form hx-post="/api/ui/backup/restore"
                  hx-encoding="multipart/form-data"
                  hx-trigger="submit"
                  hx-disabled-elt="find button[type='submit']"
                  hx-on::after-request="if(event.detail.successful){closeRestoreModal();if(typeof showToast==='function')showToast('Restore in progress - service will restart','warning');}">
                
                <div style="padding: 1.5rem;">
                    <div style="margin-bottom: 1.5rem;">
                        <label class="modal-form-label">
                            Backup File <span style="color: var(--danger-color);">*</span>
                        </label>
                        <input type="file" name="backup_file" required 
                               accept=".tar.gz"
                               class="modal-form-input">
                    </div>
                    
                    <div style="margin-bottom: 1.5rem;">
                        <label class="modal-form-label">
                            Backup Password <span style="color: var(--danger-color);">*</span>
                        </label>
                        <input type="password" name="password" required 
                               placeholder="Password used during backup"
                               class="modal-form-input">
                    </div>
                    
                    <div class="alert-warning-border">
                        <div style="display: flex; align-items: start; gap: 0.5rem;">
                            <svg class="ucm-icon" width="16" height="16" style="color: var(--warning-color); flex-shrink: 0; margin-top: 2px;"><use href="#icon-warning-triangle"/></svg>
                            <p style="margin: 0; font-size: 0.8125rem;">
                                <strong>Warning:</strong> This will merge/replace existing data and restart the service.
                            </p>
                        </div>
                    </div>
                </div>
                
                <div class="modal-form-footer">
                    <button type="button" onclick="closeRestoreModal()" class="btn-secondary">
                        Cancel
                    </button>
                    <button type="submit" class="btn-danger">
                        <svg class="ucm-icon" width="16" height="16"><use href="#icon-upload"/></svg> Restore Backup
                    </button>
                </div>
            </form>
        </div>
    </div>
</div>

<script>
// Backup/Restore modal functions use global window.openModal/closeModal
function openBackupModal() {
    window.openModal('backupModal');
}

function closeBackupModal() {
    window.closeModal('backupModal');
}

function openRestoreModal() {
    window.openModal('restoreModal');
}

function closeRestoreModal() {
    window.closeModal('restoreModal');
}
</script>

{% endblock %}

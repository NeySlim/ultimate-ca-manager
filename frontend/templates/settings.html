{% extends "base.html" %}

{% block title %}Settings - UCM{% endblock %}

{% block content %}
<div style="display: flex; flex-direction: column; gap: 1.5rem;">
    <div style="display: flex; justify-content: space-between; align-items: center;">
        <h1 style="font-size: 1.875rem; font-weight: 600; color: var(--text-primary); margin: 0; display: flex; align-items: center; gap: 0.5rem;">
            <svg class="ucm-icon" width="24" height="24"><use href="#icon-settings"/></svg>
            <span>System Settings</span>
        </h1>
    </div>
    
    {% if session.get('role') != 'admin' %}
    <!-- Non-admin message -->
    <div class="card" style="padding: 3rem; text-align: center;">
        <svg class="ucm-icon" width="64" height="64" style="margin: 0 auto 1rem auto; opacity: 0.5;"><use href="#icon-shield"/></svg>
        <h2 style="font-size: 1.5rem; font-weight: 600; color: var(--text-primary); margin-bottom: 0.5rem;">Administrator Access Required</h2>
        <p style="color: var(--text-secondary); font-size: 1rem;">
            This page is only accessible to administrators. 
            <br>
            For your account settings, please visit <a href="/my-account" style="color: var(--primary-color); text-decoration: underline;">My Account</a>.
        </p>
    </div>
    {% else %}
    
    <!-- Settings Tabs (6 tabs) -->
    <div class="tabs-container" style="display: flex; gap: 0; margin-bottom: 2rem; border-bottom: 2px solid var(--border-color);">
        <button class="tab-button active" onclick="ucm_switchTab('general')" id="btn-tab-general" style="padding: 1rem 2rem; font-size: 0.95rem; font-weight: 600; color: var(--primary-color); border-bottom: 3px solid var(--primary-color); background: none; border-top: none; border-left: none; border-right: none; cursor: pointer; min-height: 3.5rem;">
            <svg class="ucm-icon" width="18" height="18" style="margin-right: 8px;"><use href="#icon-info-circle"/></svg> General
        </button>
        <button class="tab-button" onclick="ucm_switchTab('https')" id="btn-tab-https" style="padding: 1rem 2rem; font-size: 0.95rem; font-weight: 500; color: var(--text-secondary); border-bottom: 3px solid transparent; background: none; border-top: none; border-left: none; border-right: none; cursor: pointer; min-height: 3.5rem;">
            <svg class="ucm-icon" width="18" height="18"><use href="#icon-lock"/></svg> HTTPS
        </button>
        <button class="tab-button" onclick="ucm_switchTab('authentication')" id="btn-tab-authentication" style="padding: 1rem 2rem; font-size: 0.95rem; font-weight: 500; color: var(--text-secondary); border-bottom: 3px solid transparent; background: none; border-top: none; border-left: none; border-right: none; cursor: pointer; min-height: 3.5rem;">
            <svg class="ucm-icon" width="18" height="18" style="margin-right: 8px;"><use href="#icon-key"/></svg> Authentication
        </button>
        <button class="tab-button" onclick="ucm_switchTab('email')" id="btn-tab-email" style="padding: 1rem 2rem; font-size: 0.95rem; font-weight: 500; color: var(--text-secondary); border-bottom: 3px solid transparent; background: none; border-top: none; border-left: none; border-right: none; cursor: pointer; min-height: 3.5rem;">
            <svg class="ucm-icon" width="18" height="18"><use href="#icon-mail"/></svg> Email & Notifications
        </button>
        <button class="tab-button" onclick="ucm_switchTab('users')" id="btn-tab-users">
            <svg class="ucm-icon" width="18" height="18"><use href="#icon-users"/></svg> Users
        </button>
        <button class="tab-button" onclick="ucm_switchTab('database')" id="btn-tab-database" style="padding: 1rem 2rem; font-size: 0.95rem; font-weight: 500; color: var(--text-secondary); border-bottom: 3px solid transparent; background: none; border-top: none; border-left: none; border-right: none; cursor: pointer; min-height: 3.5rem;">
            <svg class="ucm-icon" width="18" height="18" style="margin-right: 8px;"><use href="#icon-database"/></svg> Database
        </button>
        <button class="tab-button" onclick="ucm_switchTab('advanced')" id="btn-tab-advanced" style="padding: 1rem 2rem; font-size: 0.95rem; font-weight: 500; color: var(--text-secondary); border-bottom: 3px solid transparent; background: none; border-top: none; border-left: none; border-right: none; cursor: pointer; min-height: 3.5rem;">
            <svg class="ucm-icon" width="18" height="18" style="margin-right: 8px;"><use href="#icon-settings"/></svg> Advanced
        </button>
    </div>
    
    <!-- Tab: General -->
    <div id="tab-general" class="tab-content active">
    
    <!-- System Information -->
    <div class="card">
        <div class="card-header">
            <h2 style="display: flex; align-items: center; gap: 0.5rem;">
                <svg class="ucm-icon" width="20" height="20" style="color: var(--primary-color);"><use href="#icon-server"/></svg>
                System Information
            </h2>
        </div>
        <div style="padding: 1.5rem;">
            <div style="display: flex; flex-direction: column; gap: 0.75rem;">
                <div style="display: flex; justify-content: space-between; align-items: center; padding: 0.75rem; background: var(--bg-secondary); border-radius: 0.5rem;">
                    <span style="font-weight: 500; color: var(--text-secondary);">Version</span>
                    <span style="font-weight: 600; color: var(--text-primary);">1.8.6</span>
                </div>
                <div style="display: flex; justify-content: space-between; align-items: center; padding: 0.75rem; background: var(--bg-secondary); border-radius: 0.5rem;">
                    <span style="font-weight: 500; color: var(--text-secondary);">HTTPS Port</span>
                    <span style="font-weight: 600; color: var(--text-primary);">8443</span>
                </div>
                <div style="display: flex; justify-content: space-between; align-items: center; padding: 0.75rem; background: var(--bg-secondary); border-radius: 0.5rem;">
                    <span style="font-weight: 500; color: var(--text-secondary);">Database</span>
                    <span style="font-weight: 600; color: var(--text-primary);">SQLite</span>
                </div>
                <div style="display: flex; justify-content: space-between; align-items: center; padding: 0.75rem; background: var(--bg-secondary); border-radius: 0.5rem;">
                    <span style="font-weight: 500; color: var(--text-secondary);">Features</span>
                    <div style="display: flex; gap: 0.5rem; flex-wrap: wrap;">
                        <span class="badge-outline badge-success">
                            <svg class="ucm-icon" width="10" height="10"><use href="#icon-file-text"/></svg>
                            CRL
                        </span>
                        <span class="badge-outline badge-success">
                            <svg class="ucm-icon" width="10" height="10"><use href="#icon-check"/></svg>
                            OCSP
                        </span>
                        <span class="badge-outline badge-info">
                            <svg class="ucm-icon" width="10" height="10"><use href="#icon-shield"/></svg>
                            SCEP
                        </span>
                        <span class="badge-outline badge-info">
                            <svg class="ucm-icon" width="10" height="10"><use href="#icon-globe"/></svg>
                            ACME
                        </span>
                    </div>
                </div>
            </div>
        </div>
    </div>
    
    <!-- Session Configuration -->
    <div class="card">
        <div class="card-header">
            <h2 style="display: flex; align-items: center; gap: 0.5rem;">
                <svg class="ucm-icon" width="20" height="20" style="color: var(--primary-color);"><use href="#icon-clock"/></svg>
                Session Configuration
            </h2>
        </div>
        <div style="padding: 1.5rem;">
            <form id="session-config-form" style="display: flex; flex-direction: column; gap: 1.5rem;">
                <div>
                    <label class="form-label">Session Timeout (minutes)</label>
                    <input type="number" id="session-timeout" class="form-input" value="30" min="5" max="1440" style="max-width: 200px;">
                    <small style="display: block; margin-top: 0.5rem; color: var(--text-secondary); font-size: 0.75rem;">
                        Idle sessions will expire after this duration (5-1440 minutes)
                    </small>
                </div>
                
                <div>
                    <label class="form-label">Remember Me Duration (days)</label>
                    <input type="number" id="remember-duration" class="form-input" value="30" min="1" max="365" style="max-width: 200px;">
                    <small style="display: block; margin-top: 0.5rem; color: var(--text-secondary); font-size: 0.75rem;">
                        Users can stay logged in for this duration if "Remember Me" is checked
                    </small>
                </div>
                
                <div style="padding-top: 0.5rem; border-top: 1px solid var(--border-color);">
                    <button type="submit" class="btn-primary">
                        <svg class="ucm-icon" width="16" height="16" style="margin-right: 0.5rem;"><use href="#icon-check"/></svg>
                        Save Session Settings
                    </button>
                </div>
            </form>
        </div>
    </div>
    
    <!-- UI Preferences -->
    <div class="card">
        <div class="card-header">
            <h2 style="display: flex; align-items: center; gap: 0.5rem;">
                <svg class="ucm-icon" width="20" height="20" style="color: var(--primary-color);"><use href="#icon-palette"/></svg>
                UI Preferences
            </h2>
        </div>
        <div style="padding: 1.5rem;">
            <form id="ui-preferences-form" style="display: flex; flex-direction: column; gap: 1.5rem;">
                <div>
                    <label class="form-label">Default Theme</label>
                    <select id="default-theme" class="form-input" style="max-width: 300px;">
                        <option value="sentinel-light">Sentinel Light</option>
                        <option value="sentinel-dark" selected>Sentinel Dark</option>
                        <option value="amber-light">Amber Light</option>
                        <option value="amber-dark">Amber Dark</option>
                        <option value="blossom-light">Blossom Light</option>
                        <option value="blossom-dark">Blossom Dark</option>
                        <option value="nebula-light">Nebula Light</option>
                        <option value="nebula-dark">Nebula Dark</option>
                    </select>
                    <small style="display: block; margin-top: 0.5rem; color: var(--text-secondary); font-size: 0.75rem;">
                        Default theme for new users and before login
                    </small>
                </div>
                
                <div>
                    <label class="form-label">Date Format</label>
                    <select id="date-format" class="form-input" style="max-width: 300px;">
                        <option value="YYYY-MM-DD" selected>YYYY-MM-DD (2026-01-17)</option>
                        <option value="DD/MM/YYYY">DD/MM/YYYY (17/01/2026)</option>
                        <option value="MM/DD/YYYY">MM/DD/YYYY (01/17/2026)</option>
                        <option value="DD.MM.YYYY">DD.MM.YYYY (17.01.2026)</option>
                    </select>
                    <small style="display: block; margin-top: 0.5rem; color: var(--text-secondary); font-size: 0.75rem;">
                        Display format for dates throughout the application
                    </small>
                </div>
                
                <div style="padding-top: 0.5rem; border-top: 1px solid var(--border-color);">
                    <button type="submit" class="btn-primary">
                        <svg class="ucm-icon" width="16" height="16" style="margin-right: 0.5rem;"><use href="#icon-check"/></svg>
                        Save UI Preferences
                    </button>
                </div>
            </form>
        </div>
    </div>
    
    <!-- Default Certificate Settings -->
    <div class="card">
        <div class="card-header">
            <h2 style="display: flex; align-items: center; gap: 0.5rem;">
                <svg class="ucm-icon" width="20" height="20" style="color: var(--primary-color);"><use href="#icon-award"/></svg>
                Default Certificate Settings
            </h2>
        </div>
        <div style="padding: 1.5rem;">
            <form hx-post="/api/ui/config/system-save" hx-swap="none" style="display: flex; flex-direction: column; gap: 1.5rem;">
                <div>
                    <label class="form-label">Default Certificate Validity (days)</label>
                    <input type="number" name="default_cert_validity" value="365" min="1" max="7300" class="form-input" style="max-width: 200px;">
                    <small style="display: block; margin-top: 0.5rem; color: var(--text-secondary); font-size: 0.75rem;">
                        Default validity period for new certificates (1-7300 days)
                    </small>
                </div>
                
                <div style="padding-top: 0.5rem; border-top: 1px solid var(--border-color);">
                    <button type="submit" class="btn-primary">
                        <svg class="ucm-icon" width="16" height="16" style="margin-right: 0.5rem;"><use href="#icon-check"/></svg>
                        Save Certificate Settings
                    </button>
                </div>
            </form>
        </div>
    </div>

    
    </div><!-- End Tab: General -->
    
    <!-- Tab: HTTPS Certificate -->
    <div id="tab-https" class="tab-content">
    
    <!-- Password Policy -->
    <div class="card">
        <div class="card-header">
            <h2 style="display: flex; align-items: center; gap: 0.5rem;">
                <svg class="ucm-icon" width="20" height="20" style="color: var(--primary-color);"><use href="#icon-lock"/></svg>
                Password Policy
            </h2>
        </div>
        <div style="padding: 1.5rem;">
            <form id="password-policy-form" style="display: flex; flex-direction: column; gap: 1.5rem;">
                <div>
                    <label class="form-label">Minimum Password Length</label>
                    <input type="number" id="min-password-length" class="form-input" value="8" min="4" max="64" style="max-width: 200px;">
                    <small style="display: block; margin-top: 0.5rem; color: var(--text-secondary); font-size: 0.75rem;">
                        Minimum number of characters required for passwords (4-64)
                    </small>
                </div>
                
                <div>
                    <label style="display: flex; align-items: center; gap: 0.75rem; cursor: pointer; padding: 0.75rem; background: var(--bg-secondary); border-radius: 0.5rem;">
                        <input type="checkbox" id="require-uppercase" checked style="width: 18px; height: 18px; cursor: pointer;">
                        <span style="font-weight: 500; color: var(--text-primary);">Require uppercase letters (A-Z)</span>
                    </label>
                </div>
                
                <div>
                    <label style="display: flex; align-items: center; gap: 0.75rem; cursor: pointer; padding: 0.75rem; background: var(--bg-secondary); border-radius: 0.5rem;">
                        <input type="checkbox" id="require-lowercase" checked style="width: 18px; height: 18px; cursor: pointer;">
                        <span style="font-weight: 500; color: var(--text-primary);">Require lowercase letters (a-z)</span>
                    </label>
                </div>
                
                <div>
                    <label style="display: flex; align-items: center; gap: 0.75rem; cursor: pointer; padding: 0.75rem; background: var(--bg-secondary); border-radius: 0.5rem;">
                        <input type="checkbox" id="require-numbers" checked style="width: 18px; height: 18px; cursor: pointer;">
                        <span style="font-weight: 500; color: var(--text-primary);">Require numbers (0-9)</span>
                    </label>
                </div>
                
                <div>
                    <label style="display: flex; align-items: center; gap: 0.75rem; cursor: pointer; padding: 0.75rem; background: var(--bg-secondary); border-radius: 0.5rem;">
                        <input type="checkbox" id="require-special" style="width: 18px; height: 18px; cursor: pointer;">
                        <span style="font-weight: 500; color: var(--text-primary);">Require special characters (!@#$%^&*)</span>
                    </label>
                </div>
                
                <div>
                    <label class="form-label">Password Expiration (days)</label>
                    <input type="number" id="password-expiry" class="form-input" value="0" min="0" max="365" style="max-width: 200px;">
                    <small style="display: block; margin-top: 0.5rem; color: var(--text-secondary); font-size: 0.75rem;">
                        Force password change after N days (0 = never expire)
                    </small>
                </div>
                
                <div style="padding-top: 0.5rem; border-top: 1px solid var(--border-color);">
                    <button type="submit" class="btn-primary">
                        <svg class="ucm-icon" width="16" height="16" style="margin-right: 0.5rem;"><use href="#icon-check"/></svg>
                        Save Password Policy
                    </button>
                </div>
            </form>
        </div>
    </div>
    
    <!-- Session Security -->
    <div class="card">
        <div class="card-header">
            <h2 style="display: flex; align-items: center; gap: 0.5rem;">
                <svg class="ucm-icon" width="20" height="20" style="color: var(--primary-color);"><use href="#icon-shield"/></svg>
                Session Security
            </h2>
        </div>
        <div style="padding: 1.5rem;">
            <form id="session-security-form" style="display: flex; flex-direction: column; gap: 1.5rem;">
                <div>
                    <label style="display: flex; align-items: center; gap: 0.75rem; cursor: pointer; padding: 0.75rem; background: var(--bg-secondary); border-radius: 0.5rem;">
                        <input type="checkbox" id="force-https" checked disabled style="width: 18px; height: 18px; cursor: not-allowed; opacity: 0.6;">
                        <span style="font-weight: 500; color: var(--text-primary);">Force HTTPS (always enabled)</span>
                    </label>
                </div>
                
                <div>
                    <label style="display: flex; align-items: center; gap: 0.75rem; cursor: pointer; padding: 0.75rem; background: var(--bg-secondary); border-radius: 0.5rem;">
                        <input type="checkbox" id="httponly-cookies" checked style="width: 18px; height: 18px; cursor: pointer;">
                        <span style="font-weight: 500; color: var(--text-primary);">HttpOnly cookies (prevent JavaScript access)</span>
                    </label>
                </div>
                
                <div>
                    <label style="display: flex; align-items: center; gap: 0.75rem; cursor: pointer; padding: 0.75rem; background: var(--bg-secondary); border-radius: 0.5rem;">
                        <input type="checkbox" id="secure-cookies" checked style="width: 18px; height: 18px; cursor: pointer;">
                        <span style="font-weight: 500; color: var(--text-primary);">Secure cookies (HTTPS only)</span>
                    </label>
                </div>
                
                <div>
                    <label style="display: flex; align-items: center; gap: 0.75rem; cursor: pointer; padding: 0.75rem; background: var(--bg-secondary); border-radius: 0.5rem;">
                        <input type="checkbox" id="samesite-strict" checked style="width: 18px; height: 18px; cursor: pointer;">
                        <span style="font-weight: 500; color: var(--text-primary);">SameSite=Strict (prevent CSRF attacks)</span>
                    </label>
                </div>
                
                <div style="padding-top: 0.5rem; border-top: 1px solid var(--border-color);">
                    <button type="submit" class="btn-primary">
                        <svg class="ucm-icon" width="16" height="16" style="margin-right: 0.5rem;"><use href="#icon-check"/></svg>
                        Save Session Security
                    </button>
                </div>
            </form>
        </div>
    </div>
    
    <!-- HTTPS Certificate -->
    <div class="card">
        <div class="card-header">
            <h2 style="display: flex; align-items: center; gap: 0.5rem;">
                <svg class="ucm-icon" width="20" height="20" style="color: var(--primary-color);"><use href="#icon-file-text"/></svg>
                HTTPS Certificate
            </h2>
        </div>
        <div style="padding: 1.5rem;">
            <p style="font-size: 0.875rem; color: var(--text-secondary); margin-bottom: 1.5rem;">
                Configure the certificate used for the UCM web interface (HTTPS on port 8443).
            </p>
            
            <div style="background: var(--bg-secondary); border: 1px solid var(--border-color); border-radius: 0.5rem; padding: 1rem; margin-bottom: 1.5rem;">
                <h3 style="font-weight: 600; color: var(--text-primary); margin-bottom: 0.75rem; font-size: 0.875rem;">Current Certificate</h3>
                <div id="https-cert-info" style="display: flex; flex-direction: column; gap: 0.5rem; font-size: 0.875rem;">
                    <div style="display: flex; gap: 0.5rem;">
                        <span style="color: var(--text-secondary);">Type:</span>
                        <span style="color: var(--text-primary); font-weight: 600;" id="cert-type">Self-Signed</span>
                    </div>
                    <div style="display: flex; gap: 0.5rem;">
                        <span style="color: var(--text-secondary);">Subject:</span>
                        <span style="color: var(--text-primary);" id="cert-subject">-</span>
                    </div>
                    <div style="display: flex; gap: 0.5rem;">
                        <span style="color: var(--text-secondary);">Valid Until:</span>
                        <span style="color: var(--text-primary);" id="cert-expiry">-</span>
                    </div>
                </div>
            </div>
            
            <div style="margin-bottom: 1rem;">
                <p style="font-weight: 600; color: var(--text-primary); margin-bottom: 0.75rem; font-size: 0.875rem;">Certificate Source</p>
                <div style="display: flex; flex-direction: column; gap: 0.75rem;">
                    <label style="display: flex; align-items: start; gap: 0.75rem; padding: 0.75rem; border: 1px solid var(--border-color); border-radius: 0.5rem; cursor: pointer;">
                        <input type="radio" name="cert-source" value="auto" checked style="margin-top: 0.25rem;" onchange="toggleCertSelector()">
                        <div>
                            <div style="font-weight: 600; color: var(--text-primary);">Auto-generated (Self-signed)</div>
                            <div style="font-size: 0.75rem; color: var(--text-secondary);">Use the automatically generated self-signed certificate (default)</div>
                        </div>
                    </label>
                    <label style="display: flex; align-items: start; gap: 0.75rem; padding: 0.75rem; border: 1px solid var(--border-color); border-radius: 0.5rem; cursor: pointer;">
                        <input type="radio" name="cert-source" value="managed" style="margin-top: 0.25rem;" onchange="toggleCertSelector()">
                        <div style="flex: 1;">
                            <div style="font-weight: 600; color: var(--text-primary);">UCM Managed Certificate</div>
                            <div style="font-size: 0.75rem; color: var(--text-secondary); margin-bottom: 0.75rem;">Use a certificate from UCM's certificate store</div>
                            <div id="cert-selector-container" style="display: none; margin-top: 0.75rem;">
                                <label style="display: block; font-size: 0.75rem; color: var(--text-secondary); margin-bottom: 0.25rem;">Select Server Certificate:</label>
                                <select id="managed-cert-id" class="form-input" style="width: 100%; padding: 0.5rem; border: 1px solid var(--border-color); border-radius: 0.375rem; background: var(--card-bg); color: var(--text-primary);">
                                    <option value="">Loading certificates...</option>
                                </select>
                                <div id="cert-details" style="margin-top: 0.5rem; padding: 0.5rem; background: var(--bg-secondary); border-radius: 0.375rem; font-size: 0.75rem; display: none;">
                                    <div style="color: var(--text-secondary);">
                                        <div><strong>Subject:</strong> <span id="selected-cert-subject">-</span></div>
                                        <div><strong>Expires:</strong> <span id="selected-cert-expiry">-</span></div>
                                    </div>
                                </div>
                            </div>
                        </div>
                    </label>
                </div>
            </div>
            
            <div style="display: flex; gap: 1rem; padding-top: 0.5rem;">
                <button onclick="applyHTTPSCertificate()" class="btn-primary">
                    <svg class="ucm-icon" width="16" height="16"><use href="#icon-check"/></svg>
                    Apply Certificate
                </button>
                <button onclick="regenerateSelfSigned()" class="btn-primary">
                    <svg class="ucm-icon ucm-icon-refresh" width="16" height="16"><use href="#icon-refresh"/></svg>
                    Regenerate Self-Signed
                </button>
            </div>
            
            <div style="margin-top: 1rem; padding: 0.75rem; background: var(--bg-secondary); border-radius: 0.5rem; font-size: 0.75rem; color: var(--text-secondary);">
                <p style="margin-bottom: 0.25rem;"><strong>Important Notes:</strong></p>
                <ul style="list-style: disc; margin-left: 1.25rem;">
                    <li>Changing the certificate will restart the UCM service</li>
                    <li>You will be disconnected and need to reload the page</li>
                    <li>The certificate must be valid and match the server's hostname/IP</li>
                    <li>The private key must be available in UCM's keystore</li>
                </ul>
            </div>
        </div>
    </div>
    
    <!-- mTLS Authentication -->
    <div class="card">
        <div class="card-header">
            <div style="display: flex; justify-content: space-between; align-items: center;">
                <h2 style="font-size: 1.25rem; font-weight: 600; color: var(--text-primary); display: flex; align-items: center; gap: 0.5rem; margin: 0;">
                    <svg class="ucm-icon" width="20" height="20"><use href="#icon-shield-check"/></svg>
                    mTLS Authentication
                </h2>
                <span id="mtls-status-badge" class="badge-outline badge-secondary">
                    <svg class="ucm-icon" width="10" height="10"><use href="#icon-circle"/></svg> Checking...
                </span>
            </div>
        </div>
        <div style="padding: 1.5rem;">
            <p style="font-size: 0.875rem; color: var(--text-secondary); margin-bottom: 1.5rem;">
                Configure mutual TLS (mTLS) authentication to allow users to authenticate using client certificates.
            </p>
            
            <!-- Warning about reverse proxy requirement -->
            <div class="info-box">
                <div class="info-box-title">
                    <svg class="ucm-icon" width="20" height="20" ><use href="#icon-info"/></svg>
                    <span>Reverse Proxy Required for Browser Support</span>
                </div>
                <div class="info-box-content">
                    <p>
                        mTLS requires a reverse proxy (Nginx/Apache) for browsers to prompt for client certificates.
                        Without a proxy, certificates work for API authentication only.
                    </p>
                </div>
            </div>
            
            <!-- Link to detailed configuration page -->
            <a href="/config/mtls" class="btn-primary" style="display: inline-flex; align-items: center; gap: 0.5rem; text-decoration: none;">
                <svg class="ucm-icon" width="16" height="16"><use href="#icon-settings"/></svg>
                Configure mTLS Authentication
                <svg class="ucm-icon" width="14" height="14" style="margin-left: auto;"><use href="#icon-arrow-right"/></svg>
            </a>
            
            <p style="margin-top: 1rem; font-size: 0.8125rem; color: var(--text-secondary);">
                The configuration page includes:
            </p>
            <ul style="margin: 0.5rem 0 0 1.25rem; font-size: 0.8125rem; color: var(--text-secondary); line-height: 1.6;">
                <li>Enable/disable mTLS authentication</li>
                <li>Trusted CA configuration</li>
                <li>Auto-generated Nginx/Apache configuration</li>
                <li>CA certificate download</li>
                <li>Complete setup instructions</li>
            </ul>
        </div>
    </div>
    
    </div><!-- End Tab: HTTPS -->
    
    <!-- Tab: Authentication -->
    <div id="tab-authentication" class="tab-content">

    <!-- ============================================ -->
    <!-- mTLS CLIENT CERTIFICATE AUTHENTICATION     -->
    <!-- ============================================ -->

    <div class="card" style="padding: 0;">
        <div class="card-header">
            <h2 style="font-size: 1.25rem; font-weight: 600; color: var(--text-primary); display: flex; align-items: center; gap: 0.5rem; margin: 0;">
                <svg class="ucm-icon" width="16" height="16" style="color: var(--primary-color);"><use href="#icon-settings"/></svg>
                Administrator Settings
            </h2>
        </div>
        <div style="padding: 1.5rem;">
            <!-- Warning box - shown when mTLS is disabled -->
            <div id="mtls-disabled-warning" style="background: var(--warning-bg); border-left: 4px solid var(--warning-color); padding: 1.25rem; margin-bottom: 1.5rem; border-radius: 0.25rem; display: none;">
                <div style="display: flex; align-items: start; gap: 0.75rem;">
                    <svg class="ucm-icon" width="20" height="20" style="color: var(--warning-color); flex-shrink: 0; margin-top: 2px;"><use href="#icon-alert-triangle"/></svg>
                    <div style="flex: 1;">
                        <strong style="color: var(--text-primary); display: block; margin-bottom: 0.5rem;">⚠️ Important: Reverse Proxy Required</strong>
                        <p style="color: var(--text-secondary); margin: 0; font-size: 0.875rem; line-height: 1.6;">
                            mTLS client certificate authentication <strong>requires a reverse proxy</strong> (Nginx or Apache) to function properly.
                            The UCM application server cannot request client certificates from browsers directly.
                        </p>
                        <div style="margin-top: 0.75rem; padding: 0.75rem; background: var(--card-bg); border-radius: 0.25rem;">
                            <p style="color: var(--text-primary); margin: 0 0 0.5rem 0; font-size: 0.875rem; font-weight: 500;">Without reverse proxy:</p>
                            <ul style="margin: 0; padding-left: 1.25rem; color: var(--text-secondary); font-size: 0.875rem; line-height: 1.6;">
                                <li>✅ Users can still <strong>create</strong> and <strong>manage</strong> client certificates</li>
                                <li>✅ Certificates work for <strong>API authentication</strong> (curl, scripts)</li>
                                <li>❌ Browsers will <strong>not be prompted</strong> for certificates</li>
                                <li>❌ Auto-login via certificate will <strong>not work</strong> in browsers</li>
                                <li>✅ Password authentication remains <strong>fully functional</strong></li>
                            </ul>
                        </div>
                        <p style="color: var(--text-secondary); margin: 0.75rem 0 0 0; font-size: 0.875rem;">
                            <strong>After enabling:</strong> See the configuration guide below for complete Nginx/Apache setup instructions.
                        </p>
                    </div>
                </div>
            </div>
            
            <!-- Success box - shown when mTLS is enabled with CA configured -->
            <div id="mtls-enabled-info" style="background: var(--success-bg); border-left: 4px solid var(--success-color); padding: 1.25rem; margin-bottom: 1.5rem; border-radius: 0.25rem; display: none;">
                <div style="display: flex; align-items: start; gap: 0.75rem;">
                    <svg class="ucm-icon" width="20" height="20" style="color: var(--success-color); flex-shrink: 0; margin-top: 2px;"><use href="#icon-check-circle"/></svg>
                    <div style="flex: 1;">
                        <strong style="color: var(--text-primary); display: block; margin-bottom: 0.5rem;">✓ mTLS Enabled</strong>
                        <p style="color: var(--text-secondary); margin: 0; font-size: 0.875rem; line-height: 1.6;">
                            Client certificate authentication is enabled. See the <strong>Reverse Proxy Configuration</strong> section below for setup instructions.
                        </p>
                        <div id="ca-download-section" style="margin-top: 0.75rem; padding: 0.75rem; background: var(--card-bg); border-radius: 0.25rem; display: none;">
                            <p style="color: var(--text-primary); margin: 0 0 0.5rem 0; font-size: 0.875rem; font-weight: 500;">Trusted CA:</p>
                            <div style="display: flex; align-items: center; gap: 0.75rem; flex-wrap: wrap;">
                                <span id="ca-name" style="color: var(--text-primary); font-weight: 500;"></span>
                                <button type="button" id="download-ca-btn" class="btn-outline-secondary btn-sm">
                                    <svg class="ucm-icon" width="14" height="14"><use href="#icon-download"/></svg>
                                    Download CA Certificate
                                </button>
                            </div>
                        </div>
                    </div>
                </div>
            </div>

            <form id="mtls-settings-form">
                <div style="display: flex; flex-direction: column; gap: 1.5rem;">
                    <!-- Enable mTLS -->
                    <div>
                        <label style="display: flex; align-items: center; gap: 0.75rem; cursor: pointer; font-weight: 500;">
                            <input type="checkbox" id="mtls_enabled">
                            <div>
                                <div style="color: var(--text-primary);">Enable mTLS Authentication</div>
                                <div style="color: var(--text-secondary); font-size: 0.875rem; font-weight: normal;">
                                    Allow users to authenticate using client certificates
                                </div>
                            </div>
                        </label>
                    </div>

                    <!-- Require Certificate -->
                    <div id="mtls-require-wrapper" style="display: none;">
                        <label style="display: flex; align-items: center; gap: 0.75rem; cursor: pointer; font-weight: 500;">
                            <input type="checkbox" id="mtls_required">
                            <div>
                                <div style="color: var(--text-primary);">Require Client Certificate</div>
                                <div style="color: var(--text-secondary); font-size: 0.875rem; font-weight: normal;">
                                    Disable password authentication (certificate only)
                                </div>
                            </div>
                        </label>
                    </div>

                    <!-- Trusted CA Selection -->
                    <div id="mtls-ca-wrapper" style="display: none;">
                        <label class="form-label">Trusted CA for Client Certificates</label>
                        <select id="mtls_trusted_ca_id" class="form-control">
                            <option value="">None - Users can use self-signed or any valid certificate</option>
                        </select>
                        <small style="color: var(--text-secondary); font-size: 0.75rem; display: block; margin-top: 0.5rem;">
                            <strong>If CA selected:</strong> Users must create/import certificates signed by this CA<br>
                            <strong>If None:</strong> Users can create self-signed certificates or import any valid certificate
                        </small>
                    </div>

                    <div style="padding-top: 1rem; border-top: 1px solid var(--border-color);">
                        <button type="submit" class="btn-primary">
                            <svg class="ucm-icon" width="16" height="16"><use href="#icon-save"/></svg> 
                            Save Settings
                        </button>
                    </div>
                </div>
            </form>
        </div>
    </div>

    <!-- Reverse Proxy Configuration Guide -->
    <div class="card" style="padding: 0;">
        <div class="card-header">
            <h2 style="font-size: 1.25rem; font-weight: 600; color: var(--text-primary); display: flex; align-items: center; gap: 0.5rem; margin: 0;">
                <svg class="ucm-icon" width="16" height="16" style="color: var(--primary-color);"><use href="#icon-book-open"/></svg>
                Reverse Proxy Configuration Guide
            </h2>
        </div>
        <div style="padding: 1.5rem;">
            <div style="display: grid; gap: 1.5rem;">
                <!-- Nginx -->
                <div>
                    <div style="display: flex; justify-content: space-between; align-items: center; margin-bottom: 0.75rem;">
                        <h3 style="font-weight: 600; color: var(--text-primary); margin: 0; display: flex; align-items: center; gap: 0.5rem;">
                            <svg class="ucm-icon" width="16" height="16" style="color: var(--success-color);"><use href="#icon-server"/></svg>
                            Nginx Configuration
                        </h3>
                        <button type="button" onclick="copyToClipboard('nginx-config-code', 'Nginx config')" class="btn-outline-secondary btn-sm">
                            <svg class="ucm-icon" width="14" height="14"><use href="#icon-copy"/></svg>
                            Copy
                        </button>
                    </div>
                    <pre style="background: var(--card-bg-secondary); padding: 1rem; border-radius: 0.5rem; overflow-x: auto; font-size: 0.875rem; color: var(--text-primary);"><code id="nginx-config-code">Loading...</code></pre>
                    <div style="margin-top: 0.75rem; padding: 0.75rem; background: rgba(59, 130, 246, 0.1); border-radius: 0.25rem;">
                        <p style="color: var(--text-secondary); margin: 0; font-size: 0.8125rem; line-height: 1.5;">
                            <strong>Steps:</strong><br>
                            1. Download the CA certificate above<br>
                            2. Save as <code>/etc/ssl/certs/ucm-client-ca.pem</code><br>
                            3. Add this configuration to Nginx<br>
                            4. Reload Nginx: <code>sudo nginx -s reload</code>
                        </p>
                    </div>
                </div>

                <!-- Apache -->
                <div>
                    <div style="display: flex; justify-content: space-between; align-items: center; margin-bottom: 0.75rem;">
                        <h3 style="font-weight: 600; color: var(--text-primary); margin: 0; display: flex; align-items: center; gap: 0.5rem;">
                            <svg class="ucm-icon" width="16" height="16" style="color: var(--danger-color);"><use href="#icon-server"/></svg>
                            Apache Configuration
                        </h3>
                        <button type="button" onclick="copyToClipboard('apache-config-code', 'Apache config')" class="btn-outline-secondary btn-sm">
                            <svg class="ucm-icon" width="14" height="14"><use href="#icon-copy"/></svg>
                            Copy
                        </button>
                    </div>
                    <pre style="background: var(--card-bg-secondary); padding: 1rem; border-radius: 0.5rem; overflow-x: auto; font-size: 0.875rem; color: var(--text-primary);"><code id="apache-config-code">Loading...</code></pre>
                    <div style="margin-top: 0.75rem; padding: 0.75rem; background: rgba(59, 130, 246, 0.1); border-radius: 0.25rem;">
                        <p style="color: var(--text-secondary); margin: 0; font-size: 0.8125rem; line-height: 1.5;">
                            <strong>Steps:</strong><br>
                            1. Download the CA certificate above<br>
                            2. Save as <code>/etc/ssl/certs/ucm-client-ca.pem</code><br>
                            3. Add this configuration to Apache<br>
                            4. Reload Apache: <code>sudo systemctl reload apache2</code>
                        </p>
                    </div>
                </div>
    # Server certificate
    SSLCertificateFile /path/to/server.crt
    SSLCertificateKeyFile /path/to/server.key
    
    # Client certificate validation
    # Export your trusted CA from UCM and reference it here
    SSLCACertificateFile /path/to/trusted-ca.pem
    SSLVerifyClient optional  # or 'require'
    SSLVerifyDepth 2
    
    # Forward client certificate info
    RequestHeader set X-SSL-Client-Cert "%{SSL_CLIENT_CERT}s"
    RequestHeader set X-SSL-Client-Verify "%{SSL_CLIENT_VERIFY}s"
    RequestHeader set X-SSL-Client-S-DN "%{SSL_CLIENT_S_DN}s"
    RequestHeader set X-SSL-Client-M-Serial "%{SSL_CLIENT_M_SERIAL}s"
    
    ProxyPass / https://127.0.0.1:5000/
    ProxyPassReverse / https://127.0.0.1:5000/
&lt;/VirtualHost&gt;</code></pre>
                </div>
            </div>
        </div>
    </div>
    {% endif %}

    <!-- ========================================= -->
    <!-- SECTION 2: USER CERTIFICATES -->
    <!-- ========================================= -->
    <div id="user-section" style="display: none;">
        <div class="card" style="padding: 0;">
            <div class="card-header">
                <h2 style="font-size: 1.25rem; font-weight: 600; color: var(--text-primary); display: flex; align-items: center; gap: 0.5rem; margin: 0;">
                    <svg class="ucm-icon" width="16" height="16" style="color: var(--primary-color);"><use href="#icon-key"/></svg>
                    My Client Certificates
                </h2>
            </div>

            <!-- Tabs -->
            <div class="tabs-container" style="display: flex; gap: 0; margin-bottom: 2rem; border-bottom: 2px solid var(--border-color);">
                <button class="tab-button active" onclick="ucm_switchTab('create')" id="btn-tab-create" style="padding: 1rem 2rem; font-size: 0.95rem; font-weight: 600; color: var(--primary-color); border-bottom: 3px solid var(--primary-color); background: none; border-top: none; border-left: none; border-right: none; cursor: pointer; min-height: 3.5rem;">
                    <svg class="ucm-icon" width="20" height="20" style="margin-right: 8px;"><use href="#icon-plus"/></svg>
                    Create
                </button>
                <button class="tab-button" onclick="ucm_switchTab('import')" id="btn-tab-import" style="padding: 1rem 2rem; font-size: 0.95rem; font-weight: 500; color: var(--text-secondary); border-bottom: 3px solid transparent; background: none; border-top: none; border-left: none; border-right: none; cursor: pointer; min-height: 3.5rem;">
                    <svg class="ucm-icon" width="20" height="20" style="margin-right: 8px;"><use href="#icon-upload"/></svg>
                    Import
                </button>
                <button class="tab-button" onclick="ucm_switchTab('manage'); loadCertificates()" id="btn-tab-manage" style="padding: 1rem 2rem; font-size: 0.95rem; font-weight: 500; color: var(--text-secondary); border-bottom: 3px solid transparent; background: none; border-top: none; border-left: none; border-right: none; cursor: pointer; min-height: 3.5rem;">
                    <svg class="ucm-icon" width="20" height="20" style="margin-right: 8px;"><use href="#icon-inbox"/></svg>
                    Manage
                </button>
            </div>

            <!-- Tab Content -->
            <div style="padding: 1.5rem;">
                <!-- TAB 1: Create Certificate -->
                <div id="tab-create" class="tab-content">
                    <div id="create-with-ca" style="display: none;">
                        <div style="background: var(--success-bg); padding: 1rem; border-radius: 0.5rem; margin-bottom: 1.5rem; border-left: 4px solid var(--success-color);">
                            <strong style="color: var(--text-primary);">✓ Managed Certificate</strong>
                            <p style="color: var(--text-secondary); margin: 0.5rem 0 0 0; font-size: 0.875rem;">
                                Your certificate will be signed by: <strong id="ca-name-display"></strong>
                            </p>
                        </div>

                        <form id="create-managed-cert-form">
                            <div style="display: flex; flex-direction: column; gap: 1rem;">
                                <div>
                                    <label class="form-label">Common Name (CN) *</label>
                                    <input type="text" id="create_cn" class="form-control" placeholder="john.doe" required>
                                    <small style="color: var(--text-secondary); font-size: 0.75rem;">Your username or identifier</small>
                                </div>

                                <div>
                                    <label class="form-label">Email Address</label>
                                    <input type="email" id="create_email" class="form-control" placeholder="john.doe@company.com">
                                </div>

                                <div>
                                    <label class="form-label">Validity (days)</label>
                                    <input type="number" id="create_validity" class="form-control" value="365" min="1" max="3650">
                                </div>

                                <div style="padding-top: 1rem; border-top: 1px solid var(--border-color);">
                                    <button type="submit" class="btn-primary">
                                        <svg class="ucm-icon" width="16" height="16"><use href="#icon-key"/></svg>
                                        Generate Certificate
                                    </button>
                                </div>
                            </div>
                        </form>
                    </div>

                    <div id="create-self-signed" style="display: none;">
                        <div style="background: var(--warning-bg); padding: 1rem; border-radius: 0.5rem; margin-bottom: 1.5rem; border-left: 4px solid var(--warning-color);">
                            <strong style="color: var(--text-primary);">⚠️ Self-Signed Certificate</strong>
                            <p style="color: var(--text-secondary); margin: 0.5rem 0 0 0; font-size: 0.875rem;">
                                Your certificate will be self-signed and not managed by UCM
                            </p>
                        </div>

                        <form id="create-selfsigned-cert-form">
                            <div style="display: flex; flex-direction: column; gap: 1rem;">
                                <div>
                                    <label class="form-label">Common Name (CN) *</label>
                                    <input type="text" id="selfsigned_cn" class="form-control" placeholder="john.doe" required>
                                </div>

                                <div>
                                    <label class="form-label">Email Address</label>
                                    <input type="email" id="selfsigned_email" class="form-control" placeholder="john.doe@company.com">
                                </div>

                                <div style="display: grid; grid-template-columns: 1fr 1fr; gap: 1rem;">
                                    <div>
                                        <label class="form-label">Validity (days)</label>
                                        <input type="number" id="selfsigned_validity" class="form-control" value="365" min="1" max="3650">
                                    </div>
                                    <div>
                                        <label class="form-label">Key Size</label>
                                        <select id="selfsigned_keysize" class="form-control">
                                            <option value="2048">2048 bits</option>
                                            <option value="3072">3072 bits</option>
                                            <option value="4096" selected>4096 bits</option>
                                        </select>
                                    </div>
                                </div>

                                <div style="padding-top: 1rem; border-top: 1px solid var(--border-color);">
                                    <button type="submit" class="btn-primary">
                                        <svg class="ucm-icon" width="16" height="16"><use href="#icon-key"/></svg>
                                        Generate Self-Signed Certificate
                                    </button>
                                </div>
                            </div>
                        </form>
                    </div>
                </div>

                <!-- TAB 2: Import Certificate -->
                <div id="tab-import" class="tab-content" style="display: none;">
                    <div id="import-info-ca" style="display: none; background: rgba(59, 130, 246, 0.1); padding: 1rem; border-radius: 0.5rem; margin-bottom: 1.5rem; border-left: 4px solid var(--info-color);">
                        <strong style="color: var(--text-primary);">ℹ️ Validation Required</strong>
                        <p style="color: var(--text-secondary); margin: 0.5rem 0 0 0; font-size: 0.875rem;">
                            Imported certificates must be signed by: <strong id="import-ca-name-display"></strong>
                        </p>
                    </div>

                    <div id="import-info-any" style="display: none; background: var(--warning-bg); padding: 1rem; border-radius: 0.5rem; margin-bottom: 1.5rem; border-left: 4px solid var(--warning-color);">
                        <strong style="color: var(--text-primary);">⚠️ Any Valid Certificate</strong>
                        <p style="color: var(--text-secondary); margin: 0.5rem 0 0 0; font-size: 0.875rem;">
                            You can import any valid X.509 certificate
                        </p>
                    </div>

                    <form id="import-cert-form">
                        <div style="display: flex; flex-direction: column; gap: 1rem;">
                            <div>
                                <label class="form-label">Certificate Name (Optional)</label>
                                <input type="text" id="import_name" class="form-control" placeholder="My YubiKey Certificate">
                                <small style="color: var(--text-secondary); font-size: 0.75rem;">Friendly name to identify this certificate</small>
                            </div>

                            <div>
                                <label class="form-label">Certificate (PEM format) *</label>
                                <textarea id="import_cert_pem" class="form-control" rows="12" 
                                          placeholder="-----BEGIN CERTIFICATE-----
...
-----END CERTIFICATE-----" required></textarea>
                            </div>

                            <div style="display: flex; gap: 1rem;">
                                <button type="button" onclick="validateImportedCert()" class="btn btn-outline-secondary">
                                    <svg class="ucm-icon" width="16" height="16"><use href="#icon-check-circle"/></svg>
                                    Validate Certificate
                                </button>
                                <button type="submit" class="btn-secondary">
                                    <svg class="ucm-icon" width="16" height="16"><use href="#icon-upload"/></svg>
                                    Import Certificate
                                </button>
                            </div>
                        </div>
                    </form>

                    <div id="import-validation-result" style="margin-top: 1rem; display: none;"></div>
                </div>

                <!-- TAB 3: Manage Certificates -->
                <div id="tab-manage" class="tab-content" style="display: none;">
                    <div class="table-responsive">
                        <table class="table">
                            <thead>
                                <tr>
                                    <th>Name</th>
                                    <th>Subject</th>
                                    <th>Serial</th>
                                    <th>Valid Until</th>
                                    <th>Status</th>
                                    <th>Actions</th>
                                </tr>
                            </thead>
                            <tbody id="certificates-tbody">
                                <tr>
                                    <td colspan="6" style="text-align: center; padding: 2rem; color: var(--text-secondary);">
                                        <svg class="ucm-icon" width="32" height="32" style="opacity: 0.5;"><use href="#icon-key"/></svg>
                                        <p style="margin-top: 0.5rem;">Loading certificates...</p>
                                    </td>
                                </tr>
                            </tbody>
                        </table>
                    </div>
                </div>
            </div>
        </div>
    </div>

    <!-- mTLS Disabled Message -->
    <div id="mtls-disabled-message" style="display: none;">
        <div class="card" style="padding: 0;">
            <div style="padding: 3rem; text-align: center;">
                <svg class="ucm-icon" width="64" height="64" style="opacity: 0.3; margin-bottom: 1rem;"><use href="#icon-shield-check"/></svg>
                <h3 style="color: var(--text-primary); margin-bottom: 0.5rem;">mTLS Authentication is Disabled</h3>
                <p style="color: var(--text-secondary);">
                    {% if session.get('role') == 'admin' %}
                    Enable mTLS in the settings above to allow certificate-based authentication.
                    {% else %}
                    Contact your administrator to enable mTLS authentication.
                    {% endif %}
                </p>
            </div>
        </div>
    </div>

    <!-- ============================================ -->
    <!-- WEBAUTHN / FIDO2 PASSWORDLESS AUTH         -->
    <!-- ============================================ -->

        <div style="display: flex; align-items: start; gap: 1rem;">
            <svg class="ucm-icon" width="16" height="16" style="color: var(--warning-color); flex-shrink: 0; margin-top: 0.25rem;"><use href="#icon-warning-triangle"/></svg>
            <div style="flex: 1;">
                <strong style="color: var(--warning-text); display: block; margin-bottom: 0.5rem;">⚠️ Incompatible Hostname Detected</strong>
                <p style="color: var(--warning-text); opacity: 0.9; margin: 0 0 0.75rem 0; font-size: 0.875rem;">
                    WebAuthn requires a valid domain name or IP address. You are currently accessing UCM via "<span id="current-hostname" style="font-family: monospace; font-weight: 600;"></span>" which is not compatible.
                </p>
                <p style="color: var(--warning-text); opacity: 0.9; margin: 0 0 0.75rem 0; font-size: 0.875rem;">
                    <strong>To use WebAuthn, please access UCM using one of these URLs:</strong>
                </p>
                <div id="valid-urls" style="font-size: 0.875rem; margin-left: 1rem;"></div>
            </div>
        </div>
    </div>

    <!-- Info Alert -->
    <div class="info-box">
        <div class="info-box-title">
            <svg class="ucm-icon" width="20" height="20" ><use href="#icon-key"/></svg>
            <span>Passwordless Authentication</span>
        </div>
        <div class="info-box-content">
            <p>
                Register your security keys (YubiKey, Nitrokey) or platform authenticators (TouchID, Windows Hello, Face ID) for passwordless login.
                Your credentials are encrypted and stored securely, never leaving your device.
            </p>
        </div>
    </div>

    <!-- My Registered Keys -->
    <div class="card" style="padding: 0;">
        <div class="card-header">
            <h2 style="font-size: 1.25rem; font-weight: 600; color: var(--text-primary); display: flex; align-items: center; gap: 0.5rem; margin: 0;">
                <svg class="ucm-icon" width="16" height="16" style="color: var(--primary-color);"><use href="#icon-key"/></svg>
                My Registered Keys
            </h2>
        </div>
        <div id="credentials-list" style="padding: 1.5rem;">
            <div style="text-align: center; padding: 3rem; color: var(--text-secondary);">
                <svg class="ucm-icon" width="32" height="32" style="  margin-bottom: 0.5rem;"><use href="#icon-spinner"/></svg>
                <p>Loading credentials...</p>
            </div>
        </div>
    </div>

    <!-- Statistics Card -->
    <div class="card" style="padding: 0;">
        <div class="card-header">
            <h2 style="font-size: 1.25rem; font-weight: 600; color: var(--text-primary); display: flex; align-items: center; gap: 0.5rem; margin: 0;">
                <svg class="ucm-icon" width="16" height="16" style="color: var(--primary-color);"><use href="#icon-chart-bar"/></svg>
                Usage Statistics
            </h2>
        </div>
        <div style="padding: 1.5rem; display: grid; grid-template-columns: repeat(auto-fit, minmax(200px, 1fr)); gap: 1.5rem;">
            <div style="text-align: center;">
                <div style="font-size: 2rem; font-weight: bold; color: var(--primary-color);" id="total-credentials">-</div>
                <div style="color: var(--text-secondary); font-size: 0.875rem;">Total Keys</div>
            </div>
            <div style="text-align: center;">
                <div style="font-size: 2rem; font-weight: bold; color: var(--success-color);" id="active-credentials">-</div>
                <div style="color: var(--text-secondary); font-size: 0.875rem;">Active Keys</div>
            </div>
            <div style="text-align: center;">
                <div style="font-size: 2rem; font-weight: bold; color: var(--text-secondary);" id="last-used">-</div>
                <div style="color: var(--text-secondary); font-size: 0.875rem;">Last Used</div>
            </div>
        </div>
    </div>
</div>

<!-- Registration Modal -->
<div id="registration-modal" style="display: none; position: fixed; inset: 0; z-index: 50; background: rgba(0,0,0,0.5); align-items: center; justify-content: center;">
    <div style="background: var(--card-bg); border-radius: 0.5rem; max-width: 500px; width: 90%; max-height: 90vh; overflow-y: auto; box-shadow: 0 20px 25px -5px rgba(0,0,0,0.1);">
        <div style="padding: 1.5rem; border-bottom: 1px solid var(--border-color); display: flex; justify-content: space-between; align-items: center;">
            <h3 style="font-size: 1.25rem; font-weight: 600; color: var(--text-primary); margin: 0;">
                Register Security Key
            </h3>
            <button onclick="hideRegistrationModal()" style="background: none; border: none; cursor: pointer; color: var(--text-secondary); padding: 0.25rem;">
                <svg class="ucm-icon" width="24" height="24" style=" "><use href="#icon-times"/></svg>
            </button>
        </div>
        <div style="padding: 1.5rem;">
            <div id="registration-step-1">
                <div style="margin-bottom: 1.5rem;">
                    <label style="display: block; margin-bottom: 0.5rem; font-weight: 500; color: var(--text-primary);">
                        Key Name <span style="color: var(--error-color);">*</span>
                    </label>
                    <input type="text" id="credential-name" placeholder="e.g., YubiKey 5C, TouchID Macbook" 
                           style="width: 100%; padding: 0.5rem; border: 1px solid var(--border-color); border-radius: 0.25rem; background: var(--input-bg); color: var(--text-primary);">
                    <small style="color: var(--text-secondary); font-size: 0.875rem;">Give your security key a descriptive name</small>
                </div>

                <div style="background: var(--warning-bg); border-left: 4px solid var(--warning-color); padding: 1rem; margin-bottom: 1.5rem; border-radius: 0.25rem;">
                    <p style="color: var(--warning-text); margin: 0; font-size: 0.875rem;">
                        <strong>📱 Before proceeding:</strong><br>
                        • Have your security key ready<br>
                        • Make sure it's plugged in (for USB keys)<br>
                        • Your browser may prompt for biometric or PIN verification
                    </p>
                </div>

                <div style="display: flex; gap: 0.75rem; justify-content: flex-end;">
                    <button onclick="hideRegistrationModal()" class="btn-secondary">Cancel</button>
                    <button onclick="startRegistration()" class="btn-primary">
                        <svg class="ucm-icon" width="16" height="16"><use href="#icon-shield-check"/></svg> Start Registration
                    </button>
                </div>
            </div>

            <div id="registration-step-2" style="display: none; text-align: center;">
                <div style="padding: 2rem;">
                    <svg class="ucm-icon" width="48" height="48" style="  color: var(--primary-color); margin-bottom: 1rem;"><use href="#icon-spinner"/></svg>
                    <h4 style="font-size: 1.125rem; font-weight: 600; color: var(--text-primary); margin-bottom: 0.5rem;">
                        Touch Your Security Key
                    </h4>
                    <p style="color: var(--text-secondary); font-size: 0.875rem;">
                        Follow your browser's prompts to complete registration
                    </p>
                </div>
                <button onclick="cancelRegistration()" class="btn-secondary">Cancel</button>
            </div>

            <div id="registration-step-3" style="display: none; text-align: center;">
                <div style="padding: 2rem;">
                    <div style="width: 4rem; height: 4rem; background: var(--success-color); border-radius: 50%; display: flex; align-items: center; justify-content: center; margin: 0 auto 1rem;">
                        <svg class="ucm-icon" width="32" height="32" style="  color: white;"><use href="#icon-check-circle"/></svg>
                    </div>
                    <h4 style="font-size: 1.125rem; font-weight: 600; color: var(--text-primary); margin-bottom: 0.5rem;">
                        Registration Successful!
                    </h4>
                    <p style="color: var(--text-secondary); font-size: 0.875rem;">
                        Your security key has been registered and is ready to use
                    </p>
                </div>
                <button onclick="hideRegistrationModal(); loadCredentials();" class="btn-primary">Done</button>
            </div>

            <div id="registration-step-error" style="display: none; text-align: center;">
                <div style="padding: 2rem;">
                    <div style="width: 4rem; height: 4rem; background: var(--error-color); border-radius: 50%; display: flex; align-items: center; justify-content: center; margin: 0 auto 1rem;">
                        <svg class="ucm-icon" width="32" height="32" style="  color: white;"><use href="#icon-times"/></svg>
                    </div>
                    <h4 style="font-size: 1.125rem; font-weight: 600; color: var(--text-primary); margin-bottom: 0.5rem;">
                        Registration Failed
                    </h4>
                    <p id="registration-error-message" style="color: var(--text-secondary); font-size: 0.875rem;"></p>
                </div>
                <div style="display: flex; gap: 0.75rem; justify-content: center;">
                    <button onclick="hideRegistrationModal()" class="btn-secondary">Close</button>
                    <button onclick="resetRegistrationModal()" class="btn-primary">Try Again</button>
                </div>
            </div>
        </div>
    </div>
</div>


    </div><!-- End Tab: Authentication -->
    
    <!-- Tab: Email & Notifications -->
    <div id="tab-email" class="tab-content" style="display: none;">

    <!-- ============================================ -->
    <!-- EMAIL & SMTP CONFIGURATION                  -->
    <!-- ============================================ -->

    <div class="card" style="padding: 0;">
        <div style="padding: 1.5rem; border-bottom: 1px solid var(--border-color); display: flex; justify-content: space-between; align-items: center;">
            <h2 style="font-size: 1.25rem; font-weight: 600; color: var(--text-primary); display: flex; align-items: center; gap: 0.5rem; margin: 0;">
                <svg class="ucm-icon" width="16" height="16" style="color: var(--primary-color);"><use href="#icon-server"/></svg>
                SMTP Server Configuration
                <span class="badge-outline badge-warning" style="margin-left: 0.5rem; font-size: 0.75rem;">Admin Only</span>
            </h2>
            <span id="smtp-status-badge" class="badge-outline badge-secondary">
                <svg class="ucm-icon" width="10" height="10" style=" "><use href="#icon-circle"/></svg>
                Not Configured
            </span>
        </div>
        <div style="padding: 1.5rem;">
            <form id="smtp-form">
                <div style="display: grid; grid-template-columns: repeat(auto-fit, minmax(300px, 1fr)); gap: 1.5rem;">
                    <!-- SMTP Host -->
                    <div>
                        <label class="form-label">SMTP Host *</label>
                        <input type="text" id="smtp_host" class="form-input" placeholder="smtp.gmail.com" required>
                    </div>
                    
                    <!-- SMTP Port -->
                    <div>
                        <label class="form-label">SMTP Port *</label>
                        <input type="number" id="smtp_port" class="form-input" placeholder="587" value="587" required>
                    </div>
                    
                    <!-- SMTP User -->
                    <div>
                        <label class="form-label">Username</label>
                        <input type="text" id="smtp_user" class="form-input" placeholder="user@gmail.com">
                    </div>
                    
                    <!-- SMTP Password -->
                    <div>
                        <label class="form-label">Password</label>
                        <input type="password" id="smtp_password" class="form-input" placeholder="••••••••">
                        <small style="color: var(--text-secondary); font-size: 0.75rem;">Leave blank to keep current password</small>
                    </div>
                    
                    <!-- From Email -->
                    <div>
                        <label class="form-label">From Email *</label>
                        <input type="email" id="smtp_from" class="form-input" placeholder="noreply@ucm.local" required>
                    </div>
                    
                    <!-- From Name -->
                    <div>
                        <label class="form-label">From Name</label>
                        <input type="text" id="smtp_from_name" class="form-input" placeholder="UCM Notifications" value="UCM Notifications">
                    </div>
                    
                    <!-- Security Options -->
                    <div style="grid-column: 1 / -1;">
                        <label class="form-label">Security</label>
                        <div style="display: flex; gap: 2rem; margin-top: 0.5rem;">
                            <label style="display: flex; align-items: center; gap: 0.5rem; cursor: pointer;">
                                <input type="checkbox" id="smtp_use_tls" checked>
                                Use TLS (STARTTLS)
                            </label>
                            <label style="display: flex; align-items: center; gap: 0.5rem; cursor: pointer;">
                                <input type="checkbox" id="smtp_use_ssl">
                                Use SSL
                            </label>
                            <label style="display: flex; align-items: center; gap: 0.5rem; cursor: pointer;">
                                <input type="checkbox" id="smtp_enabled">
                                <strong>Enable SMTP</strong>
                            </label>
                        </div>
                    </div>
                </div>
                
                <div style="display: flex; gap: 1rem; margin-top: 1.5rem; padding-top: 1.5rem; border-top: 1px solid var(--border-color);">
                    <button type="submit" class="btn-primary">
                        <svg class="ucm-icon" width="16" height="16"><use href="#icon-save"/></svg> Save SMTP Configuration
                    </button>
                    <button type="button" onclick="testSMTP()" class="btn btn-outline-secondary">
                        <svg class="ucm-icon" width="16" height="16"><use href="#icon-envelope"/></svg>
                        Send Test Email
                    </button>
                </div>
            </form>
        </div>
    </div>
    {% endif %}

    <!-- My Notification Settings -->
    <div class="card" style="padding: 0;">
        <div class="card-header">
            <h2 style="font-size: 1.25rem; font-weight: 600; color: var(--text-primary); display: flex; align-items: center; gap: 0.5rem; margin: 0;">
                <svg class="ucm-icon" width="16" height="16" style="color: var(--primary-color);"><use href="#icon-user"/></svg>
                My Notification Settings
            </h2>
        </div>
        <div style="padding: 1.5rem;">
            <form id="user-notification-form">
                <div style="display: grid; grid-template-columns: 1fr; gap: 1.5rem; max-width: 600px;">
                    <div>
                        <label class="form-label">
                            <svg class="ucm-icon" width="14" height="14" style="margin-right: 0.25rem;"><use href="#icon-envelope"/></svg>
                            Email Address for Notifications
                        </label>
                        <input type="email" id="user_notification_email" class="form-input" 
                               placeholder="your.email@example.com" 
                               value="{{ session.get('email', '') }}">
                        <small style="color: var(--text-secondary); font-size: 0.875rem; display: block; margin-top: 0.5rem;">
                            All certificate expiration and system notifications will be sent to this email address.
                        </small>
                    </div>
                    
                    <div>
                        <label style="display: flex; align-items: center; gap: 0.5rem; cursor: pointer;">
                            <input type="checkbox" id="user_notifications_enabled" checked>
                            <strong>Enable email notifications for my account</strong>
                        </label>
                    </div>
                </div>
                
                <div style="display: flex; gap: 1rem; margin-top: 1.5rem; padding-top: 1.5rem; border-top: 1px solid var(--border-color);">
                    <button type="submit" class="btn-primary">
                        <svg class="ucm-icon" width="16" height="16"><use href="#icon-save"/></svg> Save My Settings
                    </button>
                </div>
            </form>
        </div>
    </div>

    <!-- Notification Rules -->
    <div class="card" style="padding: 0;">
        <div class="card-header">
            <h2 style="display: flex; align-items: center; gap: 0.5rem;">
                <svg class="ucm-icon" width="16" height="16" style="color: var(--primary-color);"><use href="#icon-bell"/></svg>
                Notification Rules
            </h2>
        </div>
        <div style="padding: 1.5rem;">
            <div id="notification-rules" style="display: flex; flex-direction: column; gap: 1.5rem;">
                <!-- Rules will be loaded here -->
            </div>
        </div>
    </div>

    <!-- Notification History -->
    <div class="card" style="padding: 0;">
        <div style="padding: 1.5rem; border-bottom: 1px solid var(--border-color); display: flex; justify-content: space-between; align-items: center;">
            <h2 style="font-size: 1.25rem; font-weight: 600; color: var(--text-primary); display: flex; align-items: center; gap: 0.5rem; margin: 0;">
                <svg class="ucm-icon" width="16" height="16" style="color: var(--primary-color);"><use href="#icon-clock"/></svg>
                Notification History
            </h2>
            <div id="notification-stats" style="display: flex; gap: 1rem;">
                <!-- Stats will be loaded here -->
            </div>
        </div>
        <div style="padding: 1.5rem;">
            <div class="table-responsive">
                <table class="table">
                    <thead>
                        <tr>
                            <th>Date</th>
                            <th>Type</th>
                            <th>Recipient</th>
                            <th>Subject</th>
                            <th>Status</th>
                        </tr>
                    </thead>
                    <tbody id="notification-history-tbody">
                        <tr>
                            <td colspan="5" style="text-align: center; padding: 2rem; color: var(--text-secondary);">
                                <svg class="ucm-icon" width="32" height="32" style=" opacity: 0.5;"><use href="#icon-inbox"/></svg>
                                <p style="margin-top: 0.5rem;">Loading history...</p>
                            </td>
                        </tr>
                    </tbody>
                </table>
            </div>
        </div>
    </div>
</div>


    </div><!-- End Tab: Email & Notifications -->
    
    
    
    <!-- ========================================== -->
    <!-- TAB 5: USERS -->
    <!-- ========================================== -->
    <div id="tab-users" class="tab-content">
    
    <!-- User Management -->
    <div class="card">
        <div class="card-header">
            <div style="display: flex; justify-content: space-between; align-items: center;">
                <h2 style="display: flex; align-items: center; gap: 0.5rem; margin: 0;">
                    <svg class="ucm-icon" width="20" height="20" style="color: var(--primary-color);"><use href="#icon-users"/></svg>
                    User Management
                </h2>
                <button onclick="openModal('addUserModal')" class="btn-primary">
                    <svg class="ucm-icon" width="16" height="16"><use href="#icon-user-plus"/></svg> Add User
                </button>
            </div>
        </div>
        <div style="padding: 1.5rem;">
            <div hx-get="/api/ui/config/users" hx-trigger="load, refreshUsers from:body" hx-target="#users-list">
                <div id="users-list">
                    <div style="text-align: center; padding: 2rem 0;">
                        <svg class="ucm-icon icon-spin" width="24" height="24"><use href="#icon-spinner"/></svg>
                        <p style="margin-top: 0.5rem; font-size: 0.875rem; color: var(--text-secondary);">Loading users...</p>
                    </div>
                </div>
            </div>
        </div>
    </div>
    
    </div><!-- End Tab: Users -->

    <!-- Tab: Database -->
    <div id="tab-database" class="tab-content">
    
    <!-- PKI Database Management -->
    <div class="card">
        <div class="card-header">
            <div style="display: flex; justify-content: space-between; align-items: center;">
                <h2 style="font-size: 1.25rem; font-weight: 600; color: var(--text-primary); display: flex; align-items: center; gap: 0.5rem; margin: 0;">
                    <svg class="ucm-icon" width="20" height="20"><use href="#icon-database"/></svg>
                    Database Management
                </h2>
                <span id="db-health-badge" class="badge-outline badge-secondary">
                    <svg class="ucm-icon" width="10" height="10"><use href="#icon-circle"/></svg> Loading...
                </span>
            </div>
        </div>
        <div style="padding: 1.5rem;">
            
            <!-- Database Statistics -->
            <div style="background: var(--bg-secondary); border: 1px solid var(--border-color); border-radius: 0.5rem; padding: 1.25rem; margin-bottom: 1.5rem;">
                <h3 style="font-size: 0.875rem; font-weight: 600; color: var(--text-primary); margin-bottom: 1rem; display: flex; align-items: center; gap: 0.5rem;">
                    <svg class="ucm-icon" width="16" height="16" style="color: var(--primary-color);"><use href="#icon-chart-bar"/></svg>
                    Database Statistics
                </h3>
                <div style="display: grid; grid-template-columns: repeat(auto-fit, minmax(140px, 1fr)); gap: 1rem;">
                    <div>
                        <div style="font-size: 0.75rem; color: var(--text-secondary);">Database Size</div>
                        <div style="font-size: 1.5rem; font-weight: 700; color: var(--text-primary);" id="db-stat-size">0 MB</div>
                    </div>
                    <div>
                        <div style="font-size: 0.75rem; color: var(--text-secondary);">Fragmentation</div>
                        <div style="font-size: 1.5rem; font-weight: 700; color: var(--text-primary);" id="db-stat-frag">0%</div>
                    </div>
                    <div>
                        <div style="font-size: 0.75rem; color: var(--text-secondary);">CAs</div>
                        <div style="font-size: 1.5rem; font-weight: 700; color: var(--text-primary);" id="pki-stat-cas">0</div>
                    </div>
                    <div>
                        <div style="font-size: 0.75rem; color: var(--text-secondary);">Certificates</div>
                        <div style="font-size: 1.5rem; font-weight: 700; color: var(--text-primary);" id="pki-stat-certs">0</div>
                    </div>
                    <div>
                        <div style="font-size: 0.75rem; color: var(--text-secondary);">CRLs</div>
                        <div style="font-size: 1.5rem; font-weight: 700; color: var(--text-primary);" id="pki-stat-crls">0</div>
                    </div>
                    <div>
                        <div style="font-size: 0.75rem; color: var(--text-secondary);">OCSP Records</div>
                        <div style="font-size: 1.5rem; font-weight: 700; color: var(--text-primary);" id="pki-stat-ocsp">0</div>
                    </div>
                </div>
                
                <!-- Last Maintenance Info -->
                <div style="margin-top: 1rem; padding-top: 1rem; border-top: 1px solid var(--border-color); font-size: 0.75rem; color: var(--text-secondary); display: grid; grid-template-columns: repeat(auto-fit, minmax(150px, 1fr)); gap: 0.5rem;">
                    <div>
                        Last VACUUM: <span id="db-last-vacuum">Never</span>
                    </div>
                    <div>
                        Last Integrity Check: <span id="db-last-check">Never</span>
                    </div>
                </div>
            </div>
            
            <!-- Maintenance Actions -->
            <div style="background: var(--card-bg); border: 1px solid var(--border-color); border-radius: 0.5rem; padding: 1.25rem; margin-bottom: 1.5rem;">
                <h3 style="font-size: 0.875rem; font-weight: 600; color: var(--text-primary); margin-bottom: 1rem; display: flex; align-items: center; gap: 0.5rem;">
                    <svg class="ucm-icon" width="16" height="16" style="color: var(--success-color);"><use href="#icon-settings"/></svg>
                    Maintenance Operations
                </h3>
                
                <div style="display: grid; gap: 1rem;">
                    <!-- Optimize Database -->
                    <div style="display: flex; align-items: start; gap: 1rem;">
                        <div style="flex: 1;">
                            <div style="font-weight: 600; color: var(--text-primary); margin-bottom: 0.25rem;">Optimize Database</div>
                            <div style="font-size: 0.8125rem; color: var(--text-secondary);">
                                Run VACUUM and ANALYZE to reclaim space and improve performance
                            </div>
                        </div>
                        <button onclick="optimizeDatabase()" class="btn-primary" style="white-space: nowrap;">
                            <svg class="ucm-icon ucm-icon-refresh" width="16" height="16"><use href="#icon-refresh"/></svg>
                            Optimize
                        </button>
                    </div>
                    
                    <!-- Integrity Check -->
                    <div style="display: flex; align-items: start; gap: 1rem; padding-top: 1rem; border-top: 1px solid var(--border-color);">
                        <div style="flex: 1;">
                            <div style="font-weight: 600; color: var(--text-primary); margin-bottom: 0.25rem;">Integrity Check</div>
                            <div style="font-size: 0.8125rem; color: var(--text-secondary);">
                                Verify database integrity and detect corruption
                            </div>
                        </div>
                        <button onclick="checkIntegrity()" class="btn-secondary" style="white-space: nowrap;">
                            <svg class="ucm-icon" width="16" height="16"><use href="#icon-check-circle"/></svg>
                            Check
                        </button>
                    </div>
                    
                    <!-- Clean Expired Certs -->
                    <div style="display: flex; align-items: start; gap: 1rem; padding-top: 1rem; border-top: 1px solid var(--border-color);">
                        <div style="flex: 1;">
                            <div style="font-weight: 600; color: var(--text-primary); margin-bottom: 0.25rem;">Clean Expired Certificates</div>
                            <div style="font-size: 0.8125rem; color: var(--text-secondary);">
                                Delete certificates expired more than 30 days ago (revoked certs preserved)
                            </div>
                        </div>
                        <button onclick="cleanExpiredCerts()" class="btn-secondary" style="white-space: nowrap;">
                            <svg class="ucm-icon" width="16" height="16"><use href="#icon-trash"/></svg>
                            Clean
                        </button>
                    </div>
                    
                    <!-- Export SQL Dump -->
                    <div style="display: flex; align-items: start; gap: 1rem; padding-top: 1rem; border-top: 1px solid var(--border-color);">
                        <div style="flex: 1;">
                            <div style="font-weight: 600; color: var(--text-primary); margin-bottom: 0.25rem;">Export SQL Dump</div>
                            <div style="font-size: 0.8125rem; color: var(--text-secondary);">
                                Download complete database as compressed SQL file
                            </div>
                        </div>
                        <button onclick="exportDatabase()" class="btn-secondary" style="white-space: nowrap;">
                            <svg class="ucm-icon" width="16" height="16"><use href="#icon-download"/></svg>
                            Export
                        </button>
                    </div>
                </div>
            </div>
            
            <!-- PKI Reset Danger Zone -->
            <div class="alert-warning-border">
                <div style="display: flex; align-items: start; gap: 0.75rem;">
                    <svg class="ucm-icon" width="20" height="20" style="color: var(--warning-color); margin-top: 0.125rem;"><use href="#icon-warning-triangle"/></svg>
                    <div style="font-size: 0.875rem;">
                        <p style="font-weight: 600; margin-bottom: 0.5rem;">⚠️ Danger Zone - Reset PKI Database</p>
                        <ul style="list-style: disc; margin-left: 1.25rem; display: flex; flex-direction: column; gap: 0.25rem;">
                            <li>This action <strong>cannot be undone</strong></li>
                            <li>All Certificate Authorities will be deleted</li>
                            <li>All certificates will be deleted</li>
                            <li>All CRLs and OCSP records will be deleted</li>
                            <li>A backup will be created automatically</li>
                            <li><strong>Users and sessions will NOT be affected</strong></li>
                        </ul>
                    </div>
                </div>
            </div>
            
            <button onclick="confirmPKIReset()" class="btn-danger" style="margin-top: 1rem;">
                <svg class="ucm-icon" width="16" height="16"><use href="#icon-trash"/></svg>
                Reset PKI Database
            </button>
        </div>
    </div>
    
    <!-- Backup & Restore -->
    <div class="card">
        <div class="card-header">
            <h2 style="display: flex; align-items: center; gap: 0.5rem;">
                <svg class="ucm-icon" width="20" height="20" style="color: var(--primary-color);"><use href="#icon-download"/></svg>
                Backup & Restore
            </h2>
        </div>
        <div style="padding: 1.5rem;">
            <p style="font-size: 0.875rem; color: var(--text-secondary); margin-bottom: 1.5rem;">
                Create encrypted backups of your entire PKI system or restore from a previous backup.
            </p>
            
            <!-- Backup Section -->
            <div style="background: var(--card-bg); border: 1px solid var(--border-color); border-radius: 0.5rem; padding: 1.5rem; margin-bottom: 1.5rem;">
                <h3 style="font-size: 1rem; font-weight: 600; color: var(--text-primary); margin-bottom: 1rem; display: flex; align-items: center; gap: 0.5rem;">
                    <svg class="ucm-icon" width="18" height="18" style="color: var(--success-color);"><use href="#icon-save"/></svg>
                    Create Backup
                </h3>
                <p style="font-size: 0.875rem; color: var(--text-secondary); margin-bottom: 1rem;">
                    Create an encrypted backup containing all CAs, certificates, users, and system configuration.
                </p>
                <div class="info-box" style="margin-bottom: 1rem;">
                    <div class="info-box-content" style="margin: 0;">
                        <p style="margin: 0;">
                            <svg class="ucm-icon" width="16" height="16" style="vertical-align: text-bottom; margin-right: 0.375rem; color: var(--info-color);"><use href="#icon-lock"/></svg>
                            <strong>Encryption:</strong> Backup is encrypted with AES-256-GCM. Keep your password safe - it's required for restore!
                        </p>
                    </div>
                </div>
                <button onclick="openBackupModal()" class="btn-primary">
                    <svg class="ucm-icon" width="16" height="16"><use href="#icon-download"/></svg>
                    Create Encrypted Backup
                </button>
            </div>
            
            <!-- Restore Section -->
            <div style="background: var(--card-bg); border: 1px solid var(--border-color); border-radius: 0.5rem; padding: 1.5rem;">
                <h3 style="font-size: 1rem; font-weight: 600; color: var(--text-primary); margin-bottom: 1rem; display: flex; align-items: center; gap: 0.5rem;">
                    <svg class="ucm-icon" width="18" height="18" style="color: var(--warning-color);"><use href="#icon-upload"/></svg>
                    Restore from Backup
                </h3>
                <p style="font-size: 0.875rem; color: var(--text-secondary); margin-bottom: 1rem;">
                    Restore your PKI system from a previously created backup file.
                </p>
                <div class="alert-warning-border">
                    <div style="display: flex; align-items: start; gap: 0.5rem;">
                        <svg class="ucm-icon" width="16" height="16" style="color: var(--warning-color); flex-shrink: 0; margin-top: 2px;"><use href="#icon-warning-triangle"/></svg>
                        <p style="margin: 0; font-size: 0.8125rem;">
                            <strong>Warning:</strong> Restoring will merge or replace existing data. Service will restart automatically.
                        </p>
                    </div>
                </div>
                <button onclick="openRestoreModal()" class="btn-secondary">
                    <svg class="ucm-icon" width="16" height="16"><use href="#icon-upload"/></svg>
                    Restore from Backup
                </button>
            </div>
        </div>
    </div>
    
    <!-- OPNsense Import -->
    <div class="card">
        <div class="card-header">
            <h2 style="font-size: 1rem; font-weight: 600; color: var(--text-primary); margin: 0; display: flex; align-items: center; gap: 0.5rem;">
                <svg class="ucm-icon" width="18" height="18"><use href="#icon-database"/></svg>
                <span>OPNsense Import</span>
            </h2>
        </div>
        <div class="card-body"
             hx-get="/api/ui/import/config-form"
             hx-trigger="load"
             hx-swap="innerHTML">
            <div style="height: 10rem; background: var(--bg-secondary); border-radius: 0.375rem; animation: pulse 2s infinite;"></div>
        </div>
    </div>
    
    <!-- Last OPNsense Import History -->
    <div class="card">
        <div class="card-header">
            <h2 style="font-size: 1rem; font-weight: 600; color: var(--text-primary); margin: 0; display: flex; align-items: center; gap: 0.5rem;">
                <svg class="ucm-icon" width="18" height="18"><use href="#icon-clock"/></svg>
                <span>Last OPNsense Import History</span>
            </h2>
        </div>
        <div hx-get="/api/ui/import/history"
             hx-trigger="load"
             hx-swap="innerHTML">
            <div style="padding: 2rem;"><div style="height: 5rem; background: var(--bg-secondary); border-radius: 0.375rem; animation: pulse 2s infinite;"></div></div>
        </div>
    </div>
    
    </div><!-- End Tab: Database -->
    
    <!-- Tab: Advanced -->
    <div id="tab-advanced" class="tab-content" style="display: none;">

    <!-- ============================================ -->
    <!-- ACME SERVER & PROXY CONFIGURATION           -->
    <!-- ============================================ -->

<div class="tabs-container" style="display: flex; gap: 0; margin-bottom: 2rem; border-bottom: 2px solid var(--border-color);">
    <button class="tab-button active" onclick="ucm_switchTab('server')" id="btn-tab-server" style="padding: 1rem 2rem; font-size: 0.95rem; font-weight: 600; color: var(--primary-color); border-bottom: 3px solid var(--primary-color); background: none; border-top: none; border-left: none; border-right: none; cursor: pointer; min-height: 3.5rem;">
        <svg class="ucm-icon" width="18" height="18" style="margin-right: 8px;"><use href="#icon-certificate-authority"/></svg> Local Server
    </button>
    <button class="tab-button" onclick="ucm_switchTab('proxy')" id="btn-tab-proxy" style="padding: 1rem 2rem; font-size: 0.95rem; font-weight: 500; color: var(--text-secondary); border-bottom: 3px solid transparent; background: none; border-top: none; border-left: none; border-right: none; cursor: pointer; min-height: 3.5rem;">
        <svg class="ucm-icon" width="18" height="18" style="margin-right: 8px;"><use href="#icon-shield-check"/></svg> Proxy Client
    </button>
</div>

<!-- Tab: Local Server -->
<div id="tab-server" class="tab-content" style="display: block;">
    <!-- ACME Status Card -->
    <div class="card" style="margin-bottom: 20px;">
        <div style="display: grid; grid-template-columns: auto 1fr 1fr; gap: 24px; align-items: start;">
            <!-- Status Badge -->
            <div>
                <span class="badge badge-success" id="acme-status-badge" style="font-size: 14px; padding: 6px 12px;">
                    <i class="bi bi-check-circle-fill"></i> Active
                </span>
            </div>
            
            <!-- CA Info -->
            <div>
                <div style="font-size: 11px; color: var(--text-secondary); text-transform: uppercase; letter-spacing: 0.5px; margin-bottom: 4px;">ACME Server</div>
                <div style="font-weight: 600; color: var(--text-primary); margin-bottom: 8px;" id="acme-ca-display">Loading CA...</div>
                
                <div style="font-size: 11px; color: var(--text-secondary); text-transform: uppercase; letter-spacing: 0.5px; margin-bottom: 4px;">Supported Features</div>
                <div style="display: flex; flex-wrap: wrap; gap: 4px;">
                    <span class="badge bg-secondary" style="font-size: 11px;" title="Account registration">new-account</span>
                    <span class="badge bg-secondary" style="font-size: 11px;" title="Order creation">new-order</span>
                    <span class="badge bg-secondary" style="font-size: 11px;" title="HTTP-01 validation">HTTP-01</span>
                    <span class="badge bg-secondary" style="font-size: 11px;" title="DNS-01 validation">DNS-01</span>
                </div>
            </div>
            
            <!-- Directory URL -->
            <div>
                <label style="font-size: 11px; color: var(--text-secondary); text-transform: uppercase; letter-spacing: 0.5px; display: block; margin-bottom: 4px;">
                    Directory URL
                </label>
                <div style="display: flex; gap: 8px;">
                    <input type="text" class="form-control" readonly 
                           value="https://{{ request.host }}/acme/directory" 
                           style="font-family: monospace; font-size: 13px; flex: 1;">
                    <button class="btn btn-secondary" type="button" 
                            onclick="copyToClipboard('https://{{ request.host }}/acme/directory')"
                            title="Copy to clipboard">
                        <svg class="ucm-icon" width="16" height="16"><use href="#icon-copy"/></svg>
                    </button>
                </div>
            </div>
        </div>
    </div>

    <!-- Statistics Cards -->
    <div style="display: grid; grid-template-columns: repeat(auto-fit, minmax(200px, 1fr)); gap: 16px; margin-bottom: 20px;">
        <div class="card" style="text-align: center; padding: 20px;">
            <svg class="ucm-icon" width="32" height="32" style="color: var(--primary-color);"><use href="#icon-user-check"/></svg>
            <div style="font-size: 2rem; font-weight: bold; margin: 8px 0; color: var(--text-primary);" id="total-accounts">-</div>
            <div style="font-size: 13px; color: var(--text-secondary);">ACME Accounts</div>
        </div>
        <div class="card" style="text-align: center; padding: 20px;">
            <svg class="ucm-icon" width="32" height="32" style="color: var(--warning-color);"><use href="#icon-clock"/></svg>
            <div style="font-size: 2rem; font-weight: bold; margin: 8px 0; color: var(--text-primary);" id="active-orders">-</div>
            <div style="font-size: 13px; color: var(--text-secondary);">Active Orders</div>
        </div>
        <div class="card" style="text-align: center; padding: 20px;">
            <svg class="ucm-icon" width="32" height="32" style="color: var(--success-color);"><use href="#icon-check-circle"/></svg>
            <div style="font-size: 2rem; font-weight: bold; margin: 8px 0; color: var(--text-primary);" id="completed-orders">-</div>
            <div style="font-size: 13px; color: var(--text-secondary);">Completed Orders</div>
        </div>
        <div class="card" style="text-align: center; padding: 20px;">
            <svg class="ucm-icon" width="32" height="32" style="color: var(--info-color);"><use href="#icon-certificate"/></svg>
            <div style="font-size: 2rem; font-weight: bold; margin: 8px 0; color: var(--text-primary);" id="issued-certs">-</div>
            <div style="font-size: 13px; color: var(--text-secondary);">Certificates Issued</div>
        </div>
    </div>

    <!-- ACME Accounts -->
    <div class="card" style="margin-bottom: 20px; padding: 0;">
        <div style="padding: 1.5rem 1.5rem 0.75rem 1.5rem; border-bottom: 1px solid var(--border-color);">
            <h2 style="font-size: 16px; font-weight: 600; color: var(--text-primary); margin: 0; display: flex; align-items: center; gap: 0.5rem;">
                <svg class="ucm-icon" width="18" height="18"><use href="#icon-user-check"/></svg>
                ACME Accounts
            </h2>
        </div>
        <div id="accounts-table" 
             hx-get="/api/ui/acme/accounts" 
             hx-trigger="load"
             hx-indicator="#accounts-loading">
            <div id="accounts-loading" style="text-align: center; padding: 40px;">
                <svg class="ucm-icon icon-spin" width="24" height="24"><use href="#icon-spinner"/></svg>
                <p style="margin-top: 8px; font-size: 13px; color: var(--text-secondary);">Loading accounts...</p>
            </div>
        </div>
    </div>

    <!-- ACME Orders -->
    <div class="card" style="margin-bottom: 20px; padding: 0;">
        <div style="padding: 1.5rem 1.5rem 0.75rem 1.5rem; border-bottom: 1px solid var(--border-color);">
            <h2 style="font-size: 16px; font-weight: 600; color: var(--text-primary); margin: 0; display: flex; align-items: center; gap: 0.5rem;">
                <svg class="ucm-icon" width="18" height="18"><use href="#icon-inbox"/></svg>
                ACME Orders
            </h2>
        </div>
        <div id="orders-table" 
             hx-get="/api/ui/acme/orders" 
             hx-trigger="load"
             hx-indicator="#orders-loading">
            <div id="orders-loading" style="text-align: center; padding: 40px;">
                <svg class="ucm-icon icon-spin" width="24" height="24"><use href="#icon-spinner"/></svg>
                <p style="margin-top: 8px; font-size: 13px; color: var(--text-secondary);">Loading orders...</p>
            </div>
        </div>
    </div>

    <!-- ACME Configuration -->
    <div class="card" style="padding: 0;">
        <div style="padding-bottom: 12px; border-bottom: 1px solid var(--border); margin-bottom: 16px;">
            <h2 style="font-size: 16px; font-weight: 600; color: var(--text-primary); margin: 0; display: flex; align-items: center; gap: 0.5rem;">
                <svg class="ucm-icon" width="18" height="18"><use href="#icon-settings"/></svg>
                ACME Configuration
            </h2>
        </div>
        <form id="acme-settings-form" 
              hx-post="/api/ui/acme/settings" 
              hx-swap="none">
            <div style="display: grid; grid-template-columns: repeat(auto-fit, minmax(300px, 1fr)); gap: 20px; margin-bottom: 20px;">
                <div>
                    <label class="form-label">Default CA for ACME</label>
                    <select name="default_ca" class="form-control" id="acme-default-ca"
                            hx-get="/api/ui/ca/options" 
                            hx-trigger="load"
                            hx-swap="innerHTML">
                        <option>Loading CAs...</option>
                    </select>
                    <small style="display: block; margin-top: 4px; font-size: 12px; color: var(--text-secondary);">
                        CA used to sign ACME certificates
                    </small>
                </div>

                <div>
                    <label class="form-label">Certificate Validity (days)</label>
                    <input type="number" name="cert_validity" class="form-control" 
                           value="90" min="1" max="397">
                    <small style="display: block; margin-top: 4px; font-size: 12px; color: var(--text-secondary);">
                        Default: 90 days, Max: 397 days
                    </small>
                </div>
            </div>

            <button type="submit" class="btn-primary">
                <i class="bi bi-check-circle"></i> Save Settings
            </button>
        </form>
    </div>
</div>

<!-- Tab: Proxy Client -->
<div id="tab-proxy" class="tab-content" style="display: none;">
    
    <!-- Info Card -->
    <div class="card" style="margin-bottom: 20px;">
        <div class="card-header">
             <h2 style="font-size: 16px; font-weight: 600; color: var(--text-primary); margin: 0;">
                <svg class="ucm-icon" width="18" height="18" style="margin-right: 8px; vertical-align: text-bottom; color: var(--info-color);"><use href="#icon-info-circle"/></svg>
                About ACME Proxy
            </h2>
        </div>
        <div style="padding: 1.5rem;">
            {% if is_self_signed %}
            <div class="alert alert-warning" style="margin-bottom: 16px; font-size: 13px;">
                <svg class="ucm-icon" width="16" height="16" style="margin-right: 6px;"><use href="#icon-warning-triangle"/></svg>
                <strong>Self-Signed Certificate Detected</strong><br>
                This server is using a self-signed certificate. ACME clients (like Certbot) will fail to connect unless you:
                <ul style="margin-bottom: 0; padding-left: 20px; margin-top: 4px;">
                    <li>Install the root CA on the client machine</li>
                    <li>Or configure the client to skip SSL verification (e.g. <code>--no-verify-ssl</code>)</li>
                </ul>
            </div>
            {% endif %}
            <p style="color: var(--text-secondary); font-size: 14px; margin-bottom: 0;">
                The ACME Proxy acts as a secure gateway between your internal clients (Certbot, Traefik, etc.) and Let's Encrypt. 
                Instead of each client managing its own account, the Proxy uses a <strong>shared upstream account</strong> to communicate with the provider.
                This allows for centralized rate limiting, logging, and policy enforcement.
            </p>
        </div>
    </div>

    <!-- Proxy Status & Actions Card -->
    <div class="card" style="margin-bottom: 20px;">
        <div style="display: grid; grid-template-columns: auto 1fr 1fr; gap: 24px; align-items: start;">
            <!-- Service Status -->
            <div>
                <span class="badge badge-info" id="proxy-status-badge" style="font-size: 14px; padding: 6px 12px;">
                    <svg class="ucm-icon" width="16" height="16"><use href="#icon-server"/></svg> Service Running
                </span>
            </div>
            
            <!-- Upstream Connection -->
            <div>
                <div style="font-size: 11px; color: var(--text-secondary); text-transform: uppercase; letter-spacing: 0.5px; margin-bottom: 4px;">Upstream Provider</div>
                <div style="font-weight: 600; color: var(--text-primary); margin-bottom: 16px;" id="proxy-upstream-display">Let's Encrypt Staging</div>
                
                <div style="font-size: 11px; color: var(--text-secondary); text-transform: uppercase; letter-spacing: 0.5px; margin-bottom: 4px;">Connection Status</div>
                <div id="proxy-account-container">
                    <!-- Loaded dynamically -->
                    <span class="spinner-border spinner-border-sm" role="status" aria-hidden="true"></span> Checking...
                </div>
            </div>
            
            <!-- Directory URL -->
            <div>
                <label style="font-size: 11px; color: var(--text-secondary); text-transform: uppercase; letter-spacing: 0.5px; display: block; margin-bottom: 4px;">
                    Proxy Endpoint (Directory URL)
                </label>
                <div style="display: flex; gap: 8px; margin-bottom: 8px;">
                    <input type="text" class="form-control" readonly 
                           id="proxy-directory-url"
                           value="https://{{ request.host }}/acme/proxy/directory" 
                           style="font-family: monospace; font-size: 13px; flex: 1;">
                    <button class="btn btn-secondary" type="button" 
                            onclick="copyToClipboard(document.getElementById('proxy-directory-url').value)"
                            title="Copy to clipboard">
                        <svg class="ucm-icon" width="16" height="16"><use href="#icon-copy"/></svg>
                    </button>
                </div>
                <p style="font-size: 12px; color: var(--text-secondary); margin: 0;">
                    Configure your ACME clients to use this URL.
                </p>
            </div>
        </div>
    </div>
</div>


    <!-- ============================================ -->
    <!-- CERTIFICATE TEMPLATES MANAGEMENT            -->
    <!-- ============================================ -->

    </div>

    <!-- Stats Cards -->
    <div id="templates-stats" 
         style="display: grid; grid-template-columns: repeat(auto-fit, minmax(200px, 1fr)); gap: 1rem;"
         hx-get="/api/ui/templates/stats" 
         hx-trigger="load, refreshTemplates from:body"
         hx-swap="innerHTML">
        <div class="stats-card skeleton"></div>
    </div>

    <!-- Templates List -->
    <div class="card" style="padding: 1.5rem;">
        <div id="templates-list"
             hx-get="/api/ui/templates/list"
             hx-trigger="load, refreshTemplates from:body"
             hx-swap="innerHTML">
            <div style="text-align: center; padding: 3rem;">
                <p style="color: var(--text-secondary);">Loading...</p>
            </div>
        </div>
    </div>
</div>

<!-- View Template Modal (Custom HTML) - View only, overlay can close -->
<div id="viewTemplateModal" class="hidden" style="position: fixed; inset: 0; background: rgba(0,0,0,0.5); display: flex; align-items: center; justify-content: center; z-index: 1000;">
    <div onclick="event.stopPropagation()" style="background: var(--card-bg); border-radius: 8px; max-width: 700px; width: 90%; max-height: 90vh; overflow: hidden; box-shadow: 0 25px 50px -12px rgba(0,0,0,0.25);">
        <div style="padding: 1.5rem; border-bottom: 1px solid var(--border-color); display: flex; justify-content: space-between; align-items: center;">
            <h2 style="font-size: 1.5rem; font-weight: 600; color: var(--text-primary); margin: 0;">Template Details</h2>
            <button onclick="closeModal('viewTemplateModal')" style="background: none; border: none; cursor: pointer; color: var(--text-secondary); padding: 0.25rem;">
                <svg class="ucm-icon" width="20" height="20"><use href="#icon-times"/></svg>
            </button>
        </div>
        <div id="viewTemplateContent" style="padding: 1.5rem; overflow-y: auto; max-height: calc(90vh - 100px);">
            <svg class="ucm-icon icon-spin" width="24" height="24"><use href="#icon-spinner"/></svg>
        </div>
    </div>
</div>

<!-- Create/Edit Template Modal - Has form, no overlay close -->
<div id="createTemplateModal" class="hidden" style="position: fixed; inset: 0; background: rgba(0,0,0,0.5); display: flex; align-items: center; justify-content: center; z-index: 1000;">
    <div onclick="event.stopPropagation()" style="background: var(--card-bg); border-radius: 8px; max-width: 800px; width: 90%; max-height: 90vh; overflow: hidden; box-shadow: 0 25px 50px -12px rgba(0,0,0,0.25);">
        <div style="padding: 1.5rem; border-bottom: 1px solid var(--border-color); display: flex; justify-content: space-between; align-items: center;">
            <h2 id="createModalTitle" style="font-size: 1.5rem; font-weight: 600; color: var(--text-primary); margin: 0;">Create Template</h2>
            <button onclick="closeModal('createTemplateModal', true)" style="background: none; border: none; cursor: pointer; color: var(--text-secondary); padding: 0.25rem;">
                <svg class="ucm-icon" width="20" height="20"><use href="#icon-times"/></svg>
            </button>
        </div>
        <div style="padding: 1.5rem; overflow-y: auto; max-height: calc(90vh - 180px);">
            <p style="color: var(--text-secondary); font-size: 0.875rem; margin-bottom: 1.5rem;">
                <svg class="ucm-icon" width="16" height="16" style="vertical-align: middle; margin-right: 0.25rem;"><use href="#icon-info-circle"/></svg>
                Create/edit modal will be implemented in the next phase when templates are integrated with certificate creation.
            </p>
            <div style="padding: 2rem; background: var(--bg-secondary); border-radius: 6px; text-align: center;">
                <svg class="ucm-icon" width="48" height="48" style="opacity: 0.3; margin-bottom: 1rem;"><use href="#icon-plus"/></svg>
                <p style="color: var(--text-secondary);">Coming soon in Phase 2</p>
            </div>
        </div>
        <div style="padding: 1.5rem; border-top: 1px solid var(--border-color); display: flex; justify-content: flex-end; gap: 0.75rem;">
            <button onclick="closeModal('createTemplateModal', true)" class="btn-secondary">Close</button>
        </div>
    </div>
</div>


    <!-- ============================================ -->
    <!-- EXISTING ADVANCED SETTINGS                  -->
    <!-- ============================================ -->

    
    <!-- Logging Configuration -->
    <div class="card">
        <div class="card-header">
            <h2 style="display: flex; align-items: center; gap: 0.5rem;">
                <svg class="ucm-icon" width="20" height="20" style="color: var(--primary-color);"><use href="#icon-file-text"/></svg>
                Logging Configuration
            </h2>
        </div>
        <div style="padding: 1.5rem;">
            <form id="logging-form" style="display: flex; flex-direction: column; gap: 1.5rem;">
                <div>
                    <label class="form-label">Log Level</label>
                    <select id="log-level" class="form-input" style="max-width: 300px;">
                        <option value="DEBUG">DEBUG (Most Verbose)</option>
                        <option value="INFO" selected>INFO (Recommended)</option>
                        <option value="WARNING">WARNING</option>
                        <option value="ERROR">ERROR</option>
                        <option value="CRITICAL">CRITICAL (Minimal)</option>
                    </select>
                    <small style="display: block; margin-top: 0.5rem; color: var(--text-secondary); font-size: 0.75rem;">
                        Controls verbosity of application logs. DEBUG is useful for troubleshooting.
                    </small>
                </div>
                
                <div>
                    <label class="form-label">Log Retention (days)</label>
                    <input type="number" id="log-retention" class="form-input" value="30" min="1" max="365" style="max-width: 200px;">
                    <small style="display: block; margin-top: 0.5rem; color: var(--text-secondary); font-size: 0.75rem;">
                        Automatically delete logs older than N days
                    </small>
                </div>
                
                <div>
                    <label style="display: flex; align-items: center; gap: 0.75rem; cursor: pointer; padding: 0.75rem; background: var(--bg-secondary); border-radius: 0.5rem;">
                        <input type="checkbox" id="enable-access-logs" checked style="width: 18px; height: 18px; cursor: pointer;">
                        <span style="font-weight: 500; color: var(--text-primary);">Enable access logs (HTTP requests)</span>
                    </label>
                </div>
                
                <div>
                    <label style="display: flex; align-items: center; gap: 0.75rem; cursor: pointer; padding: 0.75rem; background: var(--bg-secondary); border-radius: 0.5rem;">
                        <input type="checkbox" id="enable-audit-logs" checked style="width: 18px; height: 18px; cursor: pointer;">
                        <span style="font-weight: 500; color: var(--text-primary);">Enable audit logs (security events)</span>
                    </label>
                </div>
                
                <div style="padding-top: 0.5rem; border-top: 1px solid var(--border-color); display: flex; gap: 1rem; align-items: center;">
                    <button type="submit" class="btn-primary">
                        <svg class="ucm-icon" width="16" height="16" style="margin-right: 0.5rem;"><use href="#icon-check"/></svg>
                        Save Logging Settings
                    </button>
                    <a href="/logs" class="btn-secondary">
                        <svg class="ucm-icon" width="16" height="16" style="margin-right: 0.5rem;"><use href="#icon-file-text"/></svg>
                        View Logs
                    </a>
                </div>
            </form>
        </div>
    </div>
    
    <!-- Maintenance Mode -->
    <div class="card">
        <div class="card-header">
            <h2 style="display: flex; align-items: center; gap: 0.5rem;">
                <svg class="ucm-icon" width="20" height="20" style="color: var(--primary-color);"><use href="#icon-warning-triangle"/></svg>
                Maintenance Mode
            </h2>
        </div>
        <div style="padding: 1.5rem;">
            <p style="font-size: 0.875rem; color: var(--text-secondary); margin-bottom: 1.5rem;">
                Temporarily restrict access to UCM for system maintenance. Only administrators can access the system in maintenance mode.
            </p>
            
            <div style="background: var(--bg-secondary); border-radius: 0.5rem; padding: 1.5rem; margin-bottom: 1.5rem;">
                <div style="display: flex; justify-content: space-between; align-items: center; margin-bottom: 1rem;">
                    <div>
                        <div style="font-weight: 600; color: var(--text-primary); margin-bottom: 0.25rem;">Current Status</div>
                        <div style="font-size: 0.875rem; color: var(--text-secondary);">System is currently operational</div>
                    </div>
                    <span id="maintenance-status-badge" class="badge-outline badge-success">
                        <svg class="ucm-icon" width="10" height="10"><use href="#icon-check"/></svg> Active
                    </span>
                </div>
                
                <div id="maintenance-message-container" style="display: none; margin-top: 1rem; padding-top: 1rem; border-top: 1px solid var(--border-color);">
                    <div style="font-size: 0.875rem; color: var(--text-secondary); margin-bottom: 0.5rem;">Message displayed to users:</div>
                    <div style="padding: 0.75rem; background: var(--card-bg); border: 1px solid var(--border-color); border-radius: 0.375rem; font-size: 0.875rem; color: var(--text-primary);" id="maintenance-message-display">
                        -
                    </div>
                </div>
            </div>
            
            <form id="maintenance-mode-form" style="display: flex; flex-direction: column; gap: 1.5rem;">
                <div>
                    <label class="form-label">Maintenance Message</label>
                    <textarea id="maintenance-message" class="form-input" rows="3" placeholder="e.g., System maintenance in progress. We'll be back shortly.">System maintenance in progress. We'll be back shortly.</textarea>
                    <small style="display: block; margin-top: 0.5rem; color: var(--text-secondary); font-size: 0.75rem;">
                        This message will be shown to non-admin users trying to access UCM
                    </small>
                </div>
                
                <div style="padding-top: 0.5rem; border-top: 1px solid var(--border-color); display: flex; gap: 1rem;">
                    <button type="button" onclick="enableMaintenanceMode()" class="btn-warning" id="btn-enable-maintenance">
                        <svg class="ucm-icon" width="16" height="16" style="margin-right: 0.5rem;"><use href="#icon-warning-triangle"/></svg>
                        Enable Maintenance Mode
                    </button>
                    <button type="button" onclick="disableMaintenanceMode()" class="btn-success" id="btn-disable-maintenance" style="display: none;">
                        <svg class="ucm-icon" width="16" height="16" style="margin-right: 0.5rem;"><use href="#icon-check"/></svg>
                        Disable Maintenance Mode
                    </button>
                </div>
            </form>
        </div>
    </div>
    
    <!-- API Rate Limiting -->
    <div class="card">
        <div class="card-header">
            <h2 style="display: flex; align-items: center; gap: 0.5rem;">
                <svg class="ucm-icon" width="20" height="20" style="color: var(--primary-color);"><use href="#icon-shield"/></svg>
                API Rate Limiting
            </h2>
        </div>
        <div style="padding: 1.5rem;">
            <form id="rate-limiting-form" style="display: flex; flex-direction: column; gap: 1.5rem;">
                <div>
                    <label class="form-label">Requests per Minute (per IP)</label>
                    <input type="number" id="rate-limit-requests" class="form-input" value="60" min="10" max="1000" style="max-width: 200px;">
                    <small style="display: block; margin-top: 0.5rem; color: var(--text-secondary); font-size: 0.75rem;">
                        Maximum API requests from a single IP per minute (10-1000)
                    </small>
                </div>
                
                <div>
                    <label style="display: flex; align-items: center; gap: 0.75rem; cursor: pointer; padding: 0.75rem; background: var(--bg-secondary); border-radius: 0.5rem;">
                        <input type="checkbox" id="enable-rate-limiting" checked style="width: 18px; height: 18px; cursor: pointer;">
                        <span style="font-weight: 500; color: var(--text-primary);">Enable rate limiting (recommended)</span>
                    </label>
                </div>
                
                <div style="padding-top: 0.5rem; border-top: 1px solid var(--border-color);">
                    <button type="submit" class="btn-primary">
                        <svg class="ucm-icon" width="16" height="16" style="margin-right: 0.5rem;"><use href="#icon-check"/></svg>
                        Save Rate Limiting
                    </button>
                </div>
            </form>
        </div>
    </div>
    
    </div><!-- End Tab: Advanced -->
    
    {% endif %}
</div>


<script>
// ============================================
// UCM SETTINGS PAGE - CONSOLIDATED JAVASCRIPT
// ============================================

// ============================================
// mTLS AUTHENTICATION
// ============================================
(function() {
const token = '{{ session.get("access_token") }}';
let currentSettings = {};

// Toast helper
function showToast(message, type = 'info') {
    const toast = document.createElement('div');
    toast.style.cssText = `
        position: fixed; top: 20px; right: 20px; z-index: 10000;
        padding: 1rem 1.5rem; border-radius: 0.5rem; box-shadow: 0 4px 12px rgba(0,0,0,0.15);
        background: ${type === 'success' ? 'var(--success-color)' : type === 'error' ? 'var(--danger-color)' : 'var(--info-color)'};
        color: white; font-weight: 500; max-width: 400px;
    `;
    toast.textContent = message;
    document.body.appendChild(toast);
    setTimeout(() => toast.remove(), 4000);
}

// Copy to clipboard
function copyToClipboard(elementId, name) {
    const element = document.getElementById(elementId);
    if (!element) return;
    
    navigator.clipboard.writeText(element.textContent).then(() => {
        showToast(`✓ ${name} copied to clipboard`, 'success');
    }).catch(err => {
        showToast(`✗ Failed to copy: ${err.message}`, 'error');
    });
}

// Tab switching - Handled by ucm_switchTab global function
// document.querySelectorAll('.tab-button').forEach(btn => ... removed ...);

// Load mTLS settings
async function loadMTLSSettings() {
    try {
        {% if session.get('role') == 'admin' %}
        // Load CA list
        const casResponse = await fetch('/api/v1/ca', {
            headers: {'Authorization': `Bearer ${token}`}
        });
        
        if (casResponse.ok) {
            const casData = await casResponse.json();
            const select = document.getElementById('mtls_trusted_ca_id');
            
            casData.forEach(ca => {
                const option = document.createElement('option');
                option.value = ca.refid;
                option.textContent = `${ca.descr}`;
                select.appendChild(option);
            });
        }
        {% endif %}
        
        // Load current settings
        const response = await fetch('/api/v1/mtls/settings', {
            headers: {'Authorization': `Bearer ${token}`}
        });
        
        if (response.ok) {
            currentSettings = await response.json();
            
            {% if session.get('role') == 'admin' %}
            document.getElementById('mtls_enabled').checked = currentSettings.enabled;
            document.getElementById('mtls_required').checked = currentSettings.required;
            document.getElementById('mtls_trusted_ca_id').value = currentSettings.trusted_ca_id || '';
            
            // Show/hide dependent fields
            toggleMTLSFields();
            
            // Update status badge
            const badge = document.getElementById('mtls-status-badge');
            if (currentSettings.enabled) {
                badge.className = 'badge-outline badge-success';
                badge.innerHTML = '<svg class="ucm-icon" width="10" height="10"><use href="#icon-check-circle"/></svg> Enabled';
            } else {
                badge.className = 'badge-outline badge-secondary';
                badge.innerHTML = '<svg class="ucm-icon" width="10" height="10"><use href="#icon-circle"/></svg> Disabled';
            }
            {% endif %}
            
            // Show/hide user section
            updateUserSection();
        }
    } catch (error) {
        console.error('Error loading mTLS settings:', error);
    }
}

// Toggle admin fields based on enabled state
function toggleMTLSFields() {
    const enabled = document.getElementById('mtls_enabled').checked;
    const trustedCaId = document.getElementById('mtls_trusted_ca_id').value;
    
    // Show/hide dependent fields
    document.getElementById('mtls-require-wrapper').style.display = enabled ? 'block' : 'none';
    document.getElementById('mtls-ca-wrapper').style.display = enabled ? 'block' : 'none';
    
    // Show/hide warning boxes
    const disabledWarning = document.getElementById('mtls-disabled-warning');
    const enabledInfo = document.getElementById('mtls-enabled-info');
    const caDownloadSection = document.getElementById('ca-download-section');
    
    if (enabled) {
        disabledWarning.style.display = 'none';
        enabledInfo.style.display = 'block';
        
        // Show CA download if CA is selected
        if (trustedCaId) {
            caDownloadSection.style.display = 'block';
            // Update CA name
            const selectedOption = document.getElementById('mtls_trusted_ca_id').selectedOptions[0];
            if (selectedOption) {
                document.getElementById('ca-name').textContent = selectedOption.textContent;
            }
        } else {
            caDownloadSection.style.display = 'none';
        }
    } else {
        disabledWarning.style.display = 'block';
        enabledInfo.style.display = 'none';
    }
    
    // Update configuration examples
    updateConfigExamples();
}

// Update configuration examples with real values
function updateConfigExamples() {
    const enabled = document.getElementById('mtls_enabled').checked;
    const required = document.getElementById('mtls_required').checked;
    const trustedCaId = document.getElementById('mtls_trusted_ca_id').value;
    
    // Get current hostname and port
    const hostname = window.location.hostname;
    const port = window.location.port || '8443';
    
    // Determine verify mode
    const nginxVerifyMode = required ? 'on' : 'optional';
    const apacheVerifyMode = required ? 'require' : 'optional';
    
    // Update Nginx example
    const nginxCode = document.getElementById('nginx-config-code');
    if (nginxCode) {
        nginxCode.textContent = `server {
    listen ${port} ssl;
    server_name ${hostname};
    
    # Server SSL certificate
    ssl_certificate /etc/ssl/certs/ucm-server.crt;
    ssl_certificate_key /etc/ssl/private/ucm-server.key;
    
    # Client certificate verification${trustedCaId ? '' : ' (DISABLED - No CA selected)'}
    ${trustedCaId ? `ssl_client_certificate /etc/ssl/certs/ucm-client-ca.pem;
    ssl_verify_client ${nginxVerifyMode};` : '# ssl_client_certificate /path/to/client-ca.pem;\n    # ssl_verify_client optional;'}
    ssl_verify_depth 2;
    
    location / {
        # Proxy to UCM backend
        proxy_pass https://127.0.0.1:8443;
        proxy_ssl_verify off;  # Backend uses self-signed cert
        
        # Forward client certificate information
        proxy_set_header X-SSL-Client-Verify $ssl_client_verify;
        proxy_set_header X-SSL-Client-S-DN $ssl_client_s_dn;
        proxy_set_header X-SSL-Client-I-DN $ssl_client_i_dn;
        proxy_set_header X-SSL-Client-Serial $ssl_client_serial;
        proxy_set_header X-SSL-Client-Cert $ssl_client_escaped_cert;
        
        # Standard proxy headers
        proxy_set_header Host $host;
        proxy_set_header X-Real-IP $remote_addr;
        proxy_set_header X-Forwarded-For $proxy_add_x_forwarded_for;
        proxy_set_header X-Forwarded-Proto $scheme;
    }
}`;
    }
    
    // Update Apache example
    const apacheCode = document.getElementById('apache-config-code');
    if (apacheCode) {
        apacheCode.textContent = `<VirtualHost *:${port}>
    ServerName ${hostname}
    
    # Server SSL certificate
    SSLEngine on
    SSLCertificateFile /etc/ssl/certs/ucm-server.crt
    SSLCertificateKeyFile /etc/ssl/private/ucm-server.key
    
    # Client certificate verification${trustedCaId ? '' : ' (DISABLED - No CA selected)'}
    ${trustedCaId ? `SSLCACertificateFile /etc/ssl/certs/ucm-client-ca.pem
    SSLVerifyClient ${apacheVerifyMode}` : '# SSLCACertificateFile /path/to/client-ca.pem\n    # SSLVerifyClient optional'}
    SSLVerifyDepth 2
    
    # Proxy to UCM backend
    ProxyPass / https://127.0.0.1:8443/
    ProxyPassReverse / https://127.0.0.1:8443/
    SSLProxyEngine on
    SSLProxyVerify none
    
    # Forward client certificate information
    RequestHeader set X-SSL-Client-Verify "%{SSL_CLIENT_VERIFY}s"
    RequestHeader set X-SSL-Client-S-DN "%{SSL_CLIENT_S_DN}s"
    RequestHeader set X-SSL-Client-I-DN "%{SSL_CLIENT_I_DN}s"
    RequestHeader set X-SSL-Client-Serial "%{SSL_CLIENT_M_SERIAL}s"
    RequestHeader set X-SSL-Client-Cert "%{SSL_CLIENT_CERT}s"
</VirtualHost>`;
    }
}

document.getElementById('mtls_enabled')?.addEventListener('change', toggleMTLSFields);
document.getElementById('mtls_trusted_ca_id')?.addEventListener('change', toggleMTLSFields);

// Download CA certificate
document.getElementById('download-ca-btn')?.addEventListener('click', async () => {
    const caId = document.getElementById('mtls_trusted_ca_id').value;
    if (!caId) {
        showToast('✗ No CA selected', 'error');
        return;
    }
    
    try {
        const response = await fetch(`/api/v1/ca/${caId}/export?format=pem`, {
            headers: {'Authorization': `Bearer ${token}`}
        });
        
        if (response.ok) {
            const blob = await response.blob();
            const url = window.URL.createObjectURL(blob);
            const a = document.createElement('a');
            a.href = url;
            a.download = 'ucm-client-ca.pem';
            document.body.appendChild(a);
            a.click();
            window.URL.revokeObjectURL(url);
            document.body.removeChild(a);
            showToast('✓ CA certificate downloaded', 'success');
        } else {
            showToast('✗ Failed to download CA', 'error');
        }
    } catch (error) {
        showToast('✗ Error: ' + error.message, 'error');
    }
});

// Update user section visibility and content
async function updateUserSection() {
    const userSection = document.getElementById('user-section');
    const disabledMessage = document.getElementById('mtls-disabled-message');
    
    if (currentSettings.enabled) {
        userSection.style.display = 'block';
        disabledMessage.style.display = 'none';
        
        // Show appropriate create form
        const trustedCAId = currentSettings.trusted_ca_id;
        const createWithCA = document.getElementById('create-with-ca');
        const createSelfSigned = document.getElementById('create-self-signed');
        
        if (trustedCAId) {
            // Fetch CA details
            try {
                const response = await fetch(`/api/v1/ca/${trustedCAId}`, {
                    headers: {'Authorization': `Bearer ${token}`}
                });
                if (response.ok) {
                    const ca = await response.json();
                    document.getElementById('ca-name-display').textContent = ca.descr;
                    document.getElementById('import-ca-name-display').textContent = ca.descr;
                }
            } catch (e) {}
            
            createWithCA.style.display = 'block';
            createSelfSigned.style.display = 'none';
            document.getElementById('import-info-ca').style.display = 'block';
            document.getElementById('import-info-any').style.display = 'none';
        } else {
            createWithCA.style.display = 'none';
            createSelfSigned.style.display = 'block';
            document.getElementById('import-info-ca').style.display = 'none';
            document.getElementById('import-info-any').style.display = 'block';
        }
    } else {
        userSection.style.display = 'none';
        disabledMessage.style.display = 'block';
    }
}

// Save mTLS settings (admin)
{% if session.get('role') == 'admin' %}
document.getElementById('mtls-settings-form')?.addEventListener('submit', async (e) => {
    e.preventDefault();
    
    const data = {
        enabled: document.getElementById('mtls_enabled').checked,
        required: document.getElementById('mtls_required').checked,
        trusted_ca_id: document.getElementById('mtls_trusted_ca_id').value
    };
    
    try {
        const response = await fetch('/api/v1/mtls/settings', {
            method: 'POST',
            headers: {
                'Content-Type': 'application/json',
                'Authorization': `Bearer ${token}`
            },
            body: JSON.stringify(data)
        });
        
        const result = await response.json();
        
        if (response.ok) {
            showToast('✓ Settings saved successfully', 'success');
            loadMTLSSettings();
        } else {
            showToast('✗ ' + (result.error || 'Failed to save'), 'error');
        }
    } catch (error) {
        showToast('✗ Error: ' + error.message, 'error');
    }
});
{% endif %}

// Create managed certificate
document.getElementById('create-managed-cert-form')?.addEventListener('submit', async (e) => {
    e.preventDefault();
    
    const data = {
        cn: document.getElementById('create_cn').value,
        email: document.getElementById('create_email').value,
        validity_days: parseInt(document.getElementById('create_validity').value)
    };
    
    try {
        const response = await fetch('/api/v1/mtls/certificates/create', {
            method: 'POST',
            headers: {
                'Content-Type': 'application/json',
                'Authorization': `Bearer ${token}`
            },
            body: JSON.stringify(data)
        });
        
        const result = await response.json();
        
        if (response.ok) {
            showToast('✓ Certificate created successfully', 'success');
            // Switch to manage tab
            ucm_switchTab('manage');
            loadCertificates();
        } else {
            showToast('✗ ' + (result.error || 'Failed to create certificate'), 'error');
        }
    } catch (error) {
        showToast('✗ Error: ' + error.message, 'error');
    }
});

// Create self-signed certificate
document.getElementById('create-selfsigned-cert-form')?.addEventListener('submit', async (e) => {
    e.preventDefault();
    
    const data = {
        cn: document.getElementById('selfsigned_cn').value,
        email: document.getElementById('selfsigned_email').value,
        validity_days: parseInt(document.getElementById('selfsigned_validity').value),
        key_size: parseInt(document.getElementById('selfsigned_keysize').value),
        self_signed: true
    };
    
    try {
        const response = await fetch('/api/v1/mtls/certificates/create', {
            method: 'POST',
            headers: {
                'Content-Type': 'application/json',
                'Authorization': `Bearer ${token}`
            },
            body: JSON.stringify(data)
        });
        
        const result = await response.json();
        
        if (response.ok) {
            showToast('✓ Self-signed certificate created', 'success');
            ucm_switchTab('manage');
            loadCertificates();
        } else {
            showToast('✗ ' + (result.error || 'Failed to create certificate'), 'error');
        }
    } catch (error) {
        showToast('✗ Error: ' + error.message, 'error');
    }
});

// Validate imported certificate
async function validateImportedCert() {
    const certPem = document.getElementById('import_cert_pem').value;
    
    if (!certPem) {
        showToast('Please paste a certificate first', 'error');
        return;
    }
    
    try {
        const response = await fetch('/api/v1/mtls/validate-certificate', {
            method: 'POST',
            headers: {
                'Content-Type': 'application/json',
                'Authorization': `Bearer ${token}`
            },
            body: JSON.stringify({certificate: certPem})
        });
        
        const result = await response.json();
        const resultDiv = document.getElementById('import-validation-result');
        
        if (response.ok && result.success) {
            const info = result.info;
            resultDiv.style.display = 'block';
            resultDiv.innerHTML = `
                <div style="background: ${result.valid ? 'var(--success-bg)' : 'var(--danger-bg)'}; padding: 1rem; border-radius: 0.5rem; border-left: 4px solid ${result.valid ? 'var(--success-color)' : 'var(--danger-color)'};">
                    <strong>${result.valid ? '✓ Valid Certificate' : '✗ Invalid Certificate'}</strong>
                    ${result.already_enrolled ? '<p style="color: var(--warning-color); margin-top: 0.5rem;"><strong>⚠️ Certificate already enrolled</strong></p>' : ''}
                    <div style="margin-top: 1rem; font-size: 0.875rem;">
                        <p><strong>Subject:</strong> ${info.subject}</p>
                        <p><strong>Issuer:</strong> ${info.issuer}</p>
                        <p><strong>Serial:</strong> <code>${info.serial}</code></p>
                        <p><strong>Valid Until:</strong> ${info.valid_until ? new Date(info.valid_until).toLocaleString() : 'N/A'}</p>
                    </div>
                </div>
            `;
        } else {
            resultDiv.style.display = 'block';
            resultDiv.innerHTML = `
                <div style="background: var(--danger-bg); padding: 1rem; border-radius: 0.5rem; border-left: 4px solid var(--danger-color);">
                    <strong>✗ Validation Failed</strong>
                    <p style="margin-top: 0.5rem;">${result.error || 'Unknown error'}</p>
                </div>
            `;
        }
    } catch (error) {
        showToast('✗ Validation error: ' + error.message, 'error');
    }
}
window.validateImportedCert = validateImportedCert;

// Import certificate
document.getElementById('import-cert-form')?.addEventListener('submit', async (e) => {
    e.preventDefault();
    
    const data = {
        certificate: document.getElementById('import_cert_pem').value,
        name: document.getElementById('import_name').value
    };
    
    try {
        const response = await fetch('/api/v1/mtls/certificates/enroll', {
            method: 'POST',
            headers: {
                'Content-Type': 'application/json',
                'Authorization': `Bearer ${token}`
            },
            body: JSON.stringify(data)
        });
        
        const result = await response.json();
        
        if (response.ok) {
            showToast('✓ Certificate imported successfully', 'success');
            document.getElementById('import-cert-form').reset();
            document.getElementById('import-validation-result').style.display = 'none';
            ucm_switchTab('manage');
            loadCertificates();
        } else {
            showToast('✗ ' + (result.error || 'Failed to import certificate'), 'error');
        }
    } catch (error) {
        showToast('✗ Error: ' + error.message, 'error');
    }
});

// Load certificates
async function loadCertificates() {
    try {
        const response = await fetch('/api/v1/mtls/certificates', {
            headers: {'Authorization': `Bearer ${token}`}
        });
        
        if (response.ok) {
            const data = await response.json();
            const tbody = document.getElementById('certificates-tbody');
            
            if (data.certificates.length === 0) {
                tbody.innerHTML = `
                    <tr>
                        <td colspan="6" style="text-align: center; padding: 2rem; color: var(--text-secondary);">
                            <svg class="ucm-icon" width="32" height="32" style="opacity: 0.5;"><use href="#icon-key"/></svg>
                            <p style="margin-top: 0.5rem;">No certificates enrolled</p>
                            <button onclick="ucm_switchTab('create')" class="btn btn-primary btn-primary" style="margin-top: 1rem;">
                                <svg class="ucm-icon" width="16" height="16"><use href="#icon-plus"/></svg> Create Your First Certificate
                            </button>
                        </td>
                    </tr>
                `;
                return;
            }
            
            tbody.innerHTML = data.certificates.map(cert => {
                const validUntil = cert.valid_until ? new Date(cert.valid_until) : null;
                const isExpired = validUntil && validUntil < new Date();
                const daysLeft = validUntil ? Math.ceil((validUntil - new Date()) / (1000 * 60 * 60 * 24)) : null;
                
                // Escape user-controlled data to prevent XSS
                const safeName = escapeHtml(cert.name || 'Unnamed');
                const safeSubject = escapeHtml(cert.cert_subject);
                const safeSerial = escapeHtml(cert.cert_serial.substring(0, 16));
                
                return `
                    <tr>
                        <td><strong>${safeName}</strong></td>
                        <td style="max-width: 300px; overflow: hidden; text-overflow: ellipsis;">${safeSubject}</td>
                        <td><code style="font-size: 0.875rem;">${safeSerial}...</code></td>
                        <td>
                            ${validUntil ? validUntil.toLocaleDateString() : 'N/A'}
                            ${daysLeft !== null && daysLeft < 30 ? `<br><small style="color: var(--warning-color);">${daysLeft} days left</small>` : ''}
                        </td>
                        <td>
                            ${cert.enabled 
                                ? (isExpired 
                                    ? '<span class="badge-outline badge-danger"><svg class="ucm-icon" width="10" height="10"><use href="#icon-times"/></svg> Expired</span>'
                                    : '<span class="badge-outline badge-success"><svg class="ucm-icon" width="10" height="10"><use href="#icon-check"/></svg> Active</span>')
                                : '<span class="badge-outline badge-secondary"><svg class="ucm-icon" width="10" height="10"><use href="#icon-times"/></svg> Disabled</span>'
                            }
                        </td>
                        <td>
                            <div style="display: flex; gap: 0.5rem;">
                                <button onclick="downloadCertificate(${cert.id})" class="btn btn-sm btn-outline-secondary" title="Download">
                                    <svg class="ucm-icon" width="16" height="16"><use href="#icon-download"/></svg>
                                </button>
                                ${cert.enabled 
                                    ? `<button onclick="revokeCertificate(${cert.id})" class="btn btn-sm btn-outline-warning" title="Revoke">
                                        <svg class="ucm-icon" width="16" height="16"><use href="#icon-times"/></svg>
                                    </button>`
                                    : `<button onclick="enableCertificate(${cert.id})" class="btn btn-sm btn-outline-success" title="Enable">
                                        <svg class="ucm-icon" width="16" height="16"><use href="#icon-check"/></svg>
                                    </button>`
                                }
                                <button onclick="deleteCertificate(${cert.id})" class="btn btn-sm btn-outline-danger" title="Delete">
                                    <svg class="ucm-icon" width="16" height="16"><use href="#icon-trash"/></svg>
                                </button>
                            </div>
                        </td>
                    </tr>
                `;
            }).join('');
        }
    } catch (error) {
        console.error('Error loading certificates:', error);
    }
}

// Certificate actions
async function downloadCertificate(certId) {
    try {
        const response = await fetch(`/api/v1/mtls/certificates/${certId}/download`, {
            headers: {'Authorization': `Bearer ${token}`}
        });
        
        if (response.ok) {
            const blob = await response.blob();
            const url = window.URL.createObjectURL(blob);
            const a = document.createElement('a');
            a.href = url;
            a.download = `client-cert-${certId}.pem`;
            a.click();
            window.URL.revokeObjectURL(url);
        } else {
            showToast('✗ Failed to download certificate', 'error');
        }
    } catch (error) {
        showToast('✗ Error: ' + error.message, 'error');
    }
}
window.downloadCertificate = downloadCertificate;

async function revokeCertificate(certId) {
    const confirmed = await ucmConfirm(
        'Are you sure you want to revoke this certificate? You can re-enable it later.',
        'Revoke Certificate',
        { danger: true, confirmText: 'Revoke', icon: 'warning-triangle' }
    );
    
    if (!confirmed) return;
    
    try {
        const response = await fetch(`/api/v1/mtls/certificates/${certId}/revoke`, {
            method: 'POST',
            headers: {'Authorization': `Bearer ${token}`}
        });
        
        if (response.ok) {
            showToast('✓ Certificate revoked', 'success');
            loadCertificates();
        } else {
            showToast('✗ Failed to revoke', 'error');
        }
    } catch (error) {
        showToast('✗ Error: ' + error.message, 'error');
    }
}
window.revokeCertificate = revokeCertificate;

async function enableCertificate(certId) {
    try {
        const response = await fetch(`/api/v1/mtls/certificates/${certId}/enable`, {
            method: 'POST',
            headers: {'Authorization': `Bearer ${token}`}
        });
        
        if (response.ok) {
            showToast('✓ Certificate enabled', 'success');
            loadCertificates();
        } else {
            showToast('✗ Failed to enable', 'error');
        }
    } catch (error) {
        showToast('✗ Error: ' + error.message, 'error');
    }
}
window.enableCertificate = enableCertificate;

async function deleteCertificate(certId) {
    const confirmed = await ucmConfirm(
        'Are you sure you want to permanently delete this certificate? This action cannot be undone.',
        'Delete Certificate',
        { danger: true, confirmText: 'Delete', icon: 'trash' }
    );
    
    if (!confirmed) return;
    
    try {
        const response = await fetch(`/api/v1/mtls/certificates/${certId}`, {
            method: 'DELETE',
            headers: {'Authorization': `Bearer ${token}`}
        });
        
        if (response.ok) {
            showToast('✓ Certificate deleted', 'success');
            loadCertificates();
        } else {
            showToast('✗ Failed to delete', 'error');
        }
    } catch (error) {
        showToast('✗ Error: ' + error.message, 'error');
    }
}
window.deleteCertificate = deleteCertificate;

// Initialize
document.addEventListener('DOMContentLoaded', () => {
    loadMTLSSettings();
});
})();

// ============================================
// WEBAUTHN / FIDO2
// ============================================
(function() {
const token = '{{ session.get("access_token") }}';

// Toast helper
function showToast(message, type = 'info') {
    const toast = document.createElement('div');
    toast.style.cssText = `
        position: fixed; top: 20px; right: 20px; z-index: 10000;
        padding: 1rem 1.5rem; border-radius: 0.5rem; box-shadow: 0 4px 12px rgba(0,0,0,0.15);
        background: ${type === 'success' ? '#10b981' : type === 'error' ? '#ef4444' : '#3b82f6'};
        color: white; font-weight: 500; max-width: 400px;
    `;
    toast.textContent = message;
    document.body.appendChild(toast);
    setTimeout(() => toast.remove(), 4000);
}

// Check if hostname is WebAuthn-compatible
function isWebAuthnCompatibleHostname(hostname) {
    // WebAuthn requires:
    // 1. localhost or 127.0.0.1
    // 2. A valid IP address (IPv4 or IPv6)
    // 3. A domain with a TLD (e.g., .com, .local, .lan, .pet)
    
    if (hostname === 'localhost' || hostname === '127.0.0.1' || hostname === '::1') {
        return true;
    }
    
    // Check if it's an IP address
    const ipv4Regex = /^(\d{1,3}\.){3}\d{1,3}$/;
    if (ipv4Regex.test(hostname)) {
        return true;
    }
    
    // Check if it has a TLD (contains at least one dot)
    if (hostname.includes('.')) {
        return true;
    }
    
    return false;
}

// Get the proper FQDN for this server
async function getServerFQDN() {
    try {
        // Try to get server info from API
        const response = await fetch('/api/v1/system/info', {
            headers: { 'Authorization': `Bearer ${token}` }
        });
        
        if (response.ok) {
            const data = await response.json();
            if (data.fqdn) {
                return data.fqdn;
            }
        }
    } catch (e) {
        // Fallback: construct from current hostname
    }
    
    // Fallback: if hostname is just "netsuit", append common TLD
    const hostname = window.location.hostname;
    if (!hostname.includes('.')) {
        // Common patterns: hostname.local or hostname.lan.domain
        return `${hostname}.lan.pew.pet`;
    }
    
    return hostname;
}

// Show hostname warning and suggest valid URLs or auto-redirect
async function checkHostnameCompatibility() {
    const hostname = window.location.hostname;
    
    if (!isWebAuthnCompatibleHostname(hostname)) {
        const warning = document.getElementById('hostname-warning');
        document.getElementById('current-hostname').textContent = hostname;
        
        // Get the proper FQDN
        const fqdn = await getServerFQDN();
        const port = window.location.port;
        const protocol = window.location.protocol;
        const currentPath = window.location.pathname;
        
        // Build the redirect URL
        const redirectUrl = `${protocol}//${fqdn}:${port}${currentPath}`;
        
        // Build valid URL suggestions
        const validUrls = document.getElementById('valid-urls');
        validUrls.innerHTML = `
            <div style="margin-bottom: 1rem;">
                <strong style="color: var(--text-primary);">Recommended URL:</strong>
            </div>
            <div style="margin-bottom: 1rem;">
                <a href="${redirectUrl}" 
                   style="color: var(--primary-color); text-decoration: none; font-weight: 600; font-size: 1rem;">
                    ${protocol}//${fqdn}:${port}
                </a>
                <button onclick="window.location.href='${redirectUrl}'" 
                        class="btn-primary" 
                        style="margin-left: 1rem; padding: 0.5rem 1rem; font-size: 0.875rem;">
                    <svg class="ucm-icon" width="16" height="16"><use href="#icon-arrow-right"/></svg> Switch to this URL
                </button>
            </div>
            <div style="color: var(--text-secondary); margin-top: 0.75rem; font-size: 0.8125rem;">
                <strong>Alternative options:</strong><br>
                • Access via server IP address<br>
                • Use localhost if on the server itself
            </div>
        `;
        
        warning.style.display = 'block';
        
        // Disable register button
        const registerBtn = document.querySelector('button[onclick="showRegistrationModal()"]');
        if (registerBtn) {
            registerBtn.disabled = true;
            registerBtn.title = 'WebAuthn not available with current hostname';
            registerBtn.style.opacity = '0.5';
            registerBtn.style.cursor = 'not-allowed';
        }
        
        return false;
    }
    
    return true;
}

// Convert base64url to ArrayBuffer
function base64urlToBuffer(base64url) {
    // Convert base64url to base64
    let base64 = base64url.replace(/-/g, '+').replace(/_/g, '/');
    
    // Add padding if needed
    const padLength = (4 - (base64.length % 4)) % 4;
    base64 += '='.repeat(padLength);
    
    const binary = atob(base64);
    const bytes = new Uint8Array(binary.length);
    for (let i = 0; i < binary.length; i++) {
        bytes[i] = binary.charCodeAt(i);
    }
    return bytes.buffer;
}

// Convert ArrayBuffer to base64url
function bufferToBase64url(buffer) {
    const bytes = new Uint8Array(buffer);
    let binary = '';
    for (let i = 0; i < bytes.length; i++) {
        binary += String.fromCharCode(bytes[i]);
    }
    return btoa(binary).replace(/\+/g, '-').replace(/\//g, '_').replace(/=/g, '');
}

// Load credentials list
window.loadCredentials = async function() {
    try {
        const response = await fetch('/api/v1/webauthn/credentials', {
            headers: { 'Authorization': `Bearer ${token}` }
        });
        const result = await response.json();
        
        if (response.ok && result.credentials) {
            renderCredentials(result.credentials);
            updateStats(result.credentials);
        } else {
            document.getElementById('credentials-list').innerHTML = `
                <div style="text-align: center; padding: 3rem; color: var(--text-secondary);">
                    <svg class="ucm-icon" width="48" height="48" style="  margin-bottom: 0.5rem; color: var(--error-color);"><use href="#icon-exclamation-circle"/></svg>
                    <p>${result.error || 'Failed to load credentials'}</p>
                </div>
            `;
        }
    } catch (error) {
        document.getElementById('credentials-list').innerHTML = `
            <div style="text-align: center; padding: 3rem; color: var(--text-secondary);">
                <svg class="ucm-icon" width="48" height="48" style="  margin-bottom: 0.5rem; color: var(--error-color);"><use href="#icon-exclamation-circle"/></svg>
                <p>Error: ${error.message}</p>
            </div>
        `;
    }
}

function renderCredentials(credentials) {
    const container = document.getElementById('credentials-list');
    
    if (credentials.length === 0) {
        container.innerHTML = `
            <div style="text-align: center; padding: 3rem; color: var(--text-secondary);">
                <svg class="ucm-icon" width="48" height="48" style="  margin-bottom: 0.5rem;"><use href="#icon-key"/></svg>
                <p>No security keys registered yet</p>
                <button onclick="showRegistrationModal()" class="btn-primary" style="margin-top: 1rem;">
                    <svg class="ucm-icon" width="16" height="16"><use href="#icon-plus"/></svg> Register Your First Key
                </button>
            </div>
        `;
        return;
    }
    
    container.innerHTML = credentials.map(cred => `
        <div style="border: 1px solid var(--border-color); border-radius: 0.5rem; padding: 1rem; margin-bottom: 1rem;">
            <div style="display: flex; justify-content: space-between; align-items: start;">
                <div style="flex: 1;">
                    <div style="display: flex; align-items: center; gap: 0.75rem; margin-bottom: 0.5rem;">
                        <svg class="ucm-icon" width="16" height="16" style="color: var(--primary-color);"><use href="#icon-key"/></svg>
                        <h4 style="font-weight: 600; color: var(--text-primary); margin: 0;">${cred.name}</h4>
                        ${cred.enabled ? 
                            '<span class="badge-outline badge-success">Active</span>' : 
                            '<span class="badge-outline badge-secondary">Disabled</span>'
                        }
                    </div>
                    <div style="color: var(--text-secondary); font-size: 0.875rem; margin-left: 2rem;">
                        <div><strong>Registered:</strong> ${new Date(cred.created_at).toLocaleString()}</div>
                        ${cred.last_used_at ? 
                            `<div><strong>Last used:</strong> ${new Date(cred.last_used_at).toLocaleString()}</div>` : 
                            '<div><strong>Last used:</strong> Never</div>'
                        }
                        <div><strong>Sign count:</strong> ${cred.sign_count}</div>
                        ${cred.backup_eligible ? '<div style="color: var(--success-color);">✓ Backup eligible</div>' : ''}
                    </div>
                </div>
                <div style="display: flex; gap: 0.5rem;">
                    <button onclick="toggleCredential('${cred.id}', ${!cred.enabled})"
                            class="btn-danger btn-sm">
                        <svg class="ucm-icon" width="16" height="16">
                            <use href="#icon-eye${cred.enabled ? '-slash' : ''}"/>
                        </svg>
                        ${cred.enabled ? 'Disable' : 'Enable'}
                    </button>
                    <button onclick="deleteCredential('${cred.id}')" 
                            class="btn btn-sm btn-danger" title="Delete">
                        <svg class="ucm-icon" width="16" height="16">
                            <use href="#icon-trash"/>
                        </svg>
                    </button>
                </div>
            </div>
        </div>
    `).join('');
}

function updateStats(credentials) {
    document.getElementById('total-credentials').textContent = credentials.length;
    document.getElementById('active-credentials').textContent = credentials.filter(c => c.enabled).length;
    
    const lastUsed = credentials
        .filter(c => c.last_used_at)
        .map(c => new Date(c.last_used_at))
        .sort((a, b) => b - a)[0];
    
    if (lastUsed) {
        const now = new Date();
        const diff = now - lastUsed;
        const days = Math.floor(diff / (1000 * 60 * 60 * 24));
        const hours = Math.floor(diff / (1000 * 60 * 60));
        
        if (days > 0) {
            document.getElementById('last-used').textContent = `${days}d ago`;
        } else if (hours > 0) {
            document.getElementById('last-used').textContent = `${hours}h ago`;
        } else {
            document.getElementById('last-used').textContent = 'Today';
        }
    } else {
        document.getElementById('last-used').textContent = 'Never';
    }
}

// Registration modal functions
window.showRegistrationModal = function() {
    document.getElementById('registration-modal').style.display = 'flex';
    resetRegistrationModal();
}

window.hideRegistrationModal = function() {
    document.getElementById('registration-modal').style.display = 'none';
}

window.resetRegistrationModal = function() {
    document.getElementById('registration-step-1').style.display = 'block';
    document.getElementById('registration-step-2').style.display = 'none';
    document.getElementById('registration-step-3').style.display = 'none';
    document.getElementById('registration-step-error').style.display = 'none';
    document.getElementById('credential-name').value = '';
}

window.cancelRegistration = function() {
    resetRegistrationModal();
}

// Start WebAuthn registration
window.startRegistration = async function() {
    const name = document.getElementById('credential-name').value.trim();
    
    if (!name) {
        showToast('Please enter a name for your security key', 'error');
        return;
    }
    
    // Show loading state
    document.getElementById('registration-step-1').style.display = 'none';
    document.getElementById('registration-step-2').style.display = 'block';
    
    try {
        // Step 1: Get registration options from server
        const optionsResponse = await fetch('/api/v1/webauthn/register/options', {
            method: 'POST',
            headers: {
                'Authorization': `Bearer ${token}`,
                'Content-Type': 'application/json'
            }
        });
        
        if (!optionsResponse.ok) {
            const error = await optionsResponse.json();
            throw new Error(error.error || 'Failed to get registration options');
        }
        
        const options = await optionsResponse.json();
        console.log('WebAuthn registration options received:', options);
        console.log('Current window.location:', {
            hostname: window.location.hostname,
            host: window.location.host,
            origin: window.location.origin
        });
        
        // Convert base64url strings to ArrayBuffers
        // Use server's RP ID (should match current hostname)
        const publicKeyOptions = {
            publicKey: {
                ...options,
                challenge: base64urlToBuffer(options.challenge),
                user: {
                    ...options.user,
                    id: base64urlToBuffer(options.user.id)
                },
                excludeCredentials: options.excludeCredentials ? 
                    options.excludeCredentials.map(cred => ({
                        ...cred,
                        id: base64urlToBuffer(cred.id)
                    })) : []
            }
        };
        console.log('Converted publicKeyOptions:', publicKeyOptions);
        console.log('RP ID from server:', options.rp.id);
        
        // Step 2: Call WebAuthn API
        const credential = await navigator.credentials.create(publicKeyOptions);
        
        if (!credential) {
            throw new Error('Registration was cancelled');
        }
        
        // Step 3: Send credential to server
        const verifyResponse = await fetch('/api/v1/webauthn/register/verify', {
            method: 'POST',
            headers: {
                'Authorization': `Bearer ${token}`,
                'Content-Type': 'application/json'
            },
            body: JSON.stringify({
                name: name,
                credential: {
                    id: credential.id,
                    rawId: bufferToBase64url(credential.rawId),
                    type: credential.type,
                    response: {
                        clientDataJSON: bufferToBase64url(credential.response.clientDataJSON),
                        attestationObject: bufferToBase64url(credential.response.attestationObject)
                    }
                }
            })
        });
        
        if (!verifyResponse.ok) {
            const error = await verifyResponse.json();
            throw new Error(error.error || 'Failed to verify registration');
        }
        
        // Success!
        document.getElementById('registration-step-2').style.display = 'none';
        document.getElementById('registration-step-3').style.display = 'block';
        
    } catch (error) {
        console.error('Registration error:', error);
        document.getElementById('registration-step-2').style.display = 'none';
        document.getElementById('registration-step-error').style.display = 'block';
        document.getElementById('registration-error-message').textContent = error.message;
    }
}

// Toggle credential active state
window.toggleCredential = async function(credentialId, newState) {
    try {
        const response = await fetch(`/api/v1/webauthn/credentials/${credentialId}/toggle`, {
            method: 'POST',
            headers: {
                'Authorization': `Bearer ${token}`,
                'Content-Type': 'application/json'
            },
            body: JSON.stringify({ enabled: newState })
        });
        
        const result = await response.json();
        
        if (response.ok) {
            showToast(newState ? '✓ Key enabled' : '✓ Key disabled', 'success');
            loadCredentials();
        } else {
            showToast('✗ ' + (result.error || 'Failed to update'), 'error');
        }
    } catch (error) {
        showToast('✗ Error: ' + error.message, 'error');
    }
}

// Delete credential
window.deleteCredential = async function(credentialId) {
    const confirmed = await ucmConfirm(
        'Are you sure you want to delete this security key? This cannot be undone.',
        'Delete Security Key',
        { danger: true, confirmText: 'Delete', icon: 'trash' }
    );
    
    if (!confirmed) return;
    
    try {
        const response = await fetch(`/api/v1/webauthn/credentials/${credentialId}`, {
            method: 'DELETE',
            headers: { 'Authorization': `Bearer ${token}` }
        });
        
        const result = await response.json();
        
        if (response.ok) {
            showToast('✓ Key deleted', 'success');
            loadCredentials();
        } else {
            showToast('✗ ' + (result.error || 'Failed to delete'), 'error');
        }
    } catch (error) {
        showToast('✗ Error: ' + error.message, 'error');
    }
}

// Initialize - call immediately if DOM already loaded (HTMX swap), otherwise wait for DOMContentLoaded
function init() {
    checkHostnameCompatibility();
    loadCredentials();
}

if (document.readyState === 'loading') {
    document.addEventListener('DOMContentLoaded', init);
} else {
    init();
}
})();

// ============================================
// EMAIL & NOTIFICATIONS
// ============================================
// Get JWT token from session (global scope for all functions)
const token = '{{ session.get("access_token") }}';

(function() {
// Toast notification helper
function showToast(message, type = 'info') {
    const toast = document.createElement('div');
    toast.style.cssText = `
        position: fixed; top: 20px; right: 20px; z-index: 10000;
        padding: 1rem 1.5rem; border-radius: 0.5rem; box-shadow: 0 4px 12px rgba(0,0,0,0.15);
        background: ${type === 'success' ? '#10b981' : type === 'error' ? '#ef4444' : '#3b82f6'};
        color: white; font-weight: 500; max-width: 400px;
    `;
    toast.textContent = message;
    document.body.appendChild(toast);
    setTimeout(() => toast.remove(), 4000);
}

// Load SMTP configuration
async function loadSMTPConfig() {
    try {
        const response = await fetch('/api/v1/notifications/smtp/config', {
            headers: {'Authorization': `Bearer ${token}`}
        });
        
        if (response.ok) {
            const config = await response.json();
            document.getElementById('smtp_host').value = config.smtp_host || '';
            document.getElementById('smtp_port').value = config.smtp_port || 587;
            document.getElementById('smtp_user').value = config.smtp_user || '';
            document.getElementById('smtp_from').value = config.smtp_from || '';
            document.getElementById('smtp_from_name').value = config.smtp_from_name || 'UCM Notifications';
            document.getElementById('smtp_use_tls').checked = config.smtp_use_tls !== false;
            document.getElementById('smtp_use_ssl').checked = config.smtp_use_ssl === true;
            document.getElementById('smtp_enabled').checked = config.enabled === true;
            
            // Update status badge
            const badge = document.getElementById('smtp-status-badge');
            if (config.enabled) {
                badge.className = 'badge-outline badge-success';
                badge.innerHTML = '<svg class="ucm-icon" width="10" height="10" style=" "><use href="#icon-check-circle"/></svg> Enabled';
            } else {
                badge.className = 'badge-outline badge-secondary';
                badge.innerHTML = '<svg class="ucm-icon" width="10" height="10" style=" "><use href="#icon-circle"/></svg> Disabled';
            }
        }
    } catch (error) {
        console.error('Error loading SMTP config:', error);
    }
}

// Save SMTP configuration
document.getElementById('smtp-form').addEventListener('submit', async (e) => {
    e.preventDefault();
    
    const data = {
        smtp_host: document.getElementById('smtp_host').value,
        smtp_port: parseInt(document.getElementById('smtp_port').value),
        smtp_user: document.getElementById('smtp_user').value,
        smtp_from: document.getElementById('smtp_from').value,
        smtp_from_name: document.getElementById('smtp_from_name').value,
        smtp_use_tls: document.getElementById('smtp_use_tls').checked,
        smtp_use_ssl: document.getElementById('smtp_use_ssl').checked,
        enabled: document.getElementById('smtp_enabled').checked
    };
    
    // Only include password if it's been changed
    const password = document.getElementById('smtp_password').value;
    if (password) {
        data.smtp_password = password;
    }
    
    try {
        const response = await fetch('/api/v1/notifications/smtp/config', {
            method: 'POST',
            headers: {
                'Content-Type': 'application/json',
                'Authorization': `Bearer ${token}`
            },
            body: JSON.stringify(data)
        });
        
        const result = await response.json();
        
        if (response.ok) {
            showToast('SMTP configuration saved successfully', 'success');
            document.getElementById('smtp_password').value = ''; // Clear password field
            loadSMTPConfig(); // Reload to update status
        } else {
            showToast(result.error || 'Failed to save configuration', 'error');
        }
    } catch (error) {
        showToast('Error saving configuration: ' + error.message, 'error');
    }
});

// Save user notification settings
document.getElementById('user-notification-form')?.addEventListener('submit', async (e) => {
    e.preventDefault();
    
    const data = {
        email: document.getElementById('user_notification_email').value,
        enabled: document.getElementById('user_notifications_enabled').checked
    };
    
    try {
        const response = await fetch('/api/v1/notifications/user/settings', {
            method: 'POST',
            headers: {
                'Content-Type': 'application/json',
                'Authorization': `Bearer ${token}`
            },
            body: JSON.stringify(data)
        });
        
        const result = await response.json();
        
        if (response.ok) {
            showToast('✓ Notification settings saved', 'success');
        } else {
            showToast('✗ ' + (result.error || 'Failed to save settings'), 'error');
        }
    } catch (error) {
        showToast('✗ Error: ' + error.message, 'error');
    }
});

// Load user notification settings
async function loadUserNotificationSettings() {
    try {
        const response = await fetch('/api/v1/notifications/user/settings', {
            headers: {'Authorization': `Bearer ${token}`}
        });
        
        if (response.ok) {
            const settings = await response.json();
            document.getElementById('user_notification_email').value = settings.email || '';
            document.getElementById('user_notifications_enabled').checked = settings.enabled !== false;
        }
    } catch (error) {
        console.error('Error loading user notification settings:', error);
    }
}


// Test SMTP
window.testSMTP = async function() {
    // First check if SMTP is configured
    const smtpEnabled = document.getElementById('smtp_enabled').checked;
    const smtpHost = document.getElementById('smtp_host').value;
    
    if (!smtpHost) {
        showToast('Please configure SMTP host first', 'error');
        return;
    }
    
    if (!smtpEnabled) {
        showToast('Please enable SMTP first by checking "Enable SMTP" and saving', 'error');
        return;
    }
    
    const email = prompt('Enter email address to send test email:');
    if (!email) return;
    
    // Validate email format
    const emailRegex = /^[^\s@]+@[^\s@]+\.[^\s@]+$/;
    if (!emailRegex.test(email)) {
        showToast('Invalid email address format', 'error');
        return;
    }
    
    showToast('Sending test email...', 'info');
    
    try {
        const response = await fetch('/api/v1/notifications/smtp/test', {
            method: 'POST',
            headers: {
                'Content-Type': 'application/json',
                'Authorization': `Bearer ${token}`
            },
            body: JSON.stringify({email})
        });
        
        const result = await response.json();
        
        if (response.ok) {
            showToast('✓ Test email sent successfully to ' + email, 'success');
        } else {
            showToast('✗ ' + (result.error || 'Failed to send test email'), 'error');
        }
    } catch (error) {
        showToast('✗ Network error: ' + error.message, 'error');
    }
}

// Load notification rules
async function loadNotificationRules() {
    try {
        const response = await fetch('/api/v1/notifications/config', {
            headers: {'Authorization': `Bearer ${token}`}
        });
        
        if (response.ok) {
            const configs = await response.json();
            const container = document.getElementById('notification-rules');
            
            container.innerHTML = configs.map((config, index) => `
                <div class="card" style="background: var(--card-bg-secondary);">
                    <div style="padding: 1.25rem;">
                        <div style="display: flex; justify-content: space-between; align-items: start; margin-bottom: 1rem;">
                            <div>
                                <h3 style="font-size: 1.1rem; font-weight: 600; color: var(--text-primary); margin-bottom: 0.25rem;">
                                    ${config.type === 'cert_expiring' ? 'Certificate Expiration' : 'CRL Expiration'}
                                </h3>
                                <p style="color: var(--text-secondary); font-size: 0.875rem;">${config.description || ''}</p>
                            </div>
                            <label style="display: flex; align-items: center; gap: 0.5rem; cursor: pointer;">
                                <input type="checkbox" id="rule-enabled-${index}" ${config.enabled ? 'checked' : ''} 
                                       onchange="toggleRule('${config.type}', this.checked)">
                                <strong>Enabled</strong>
                            </label>
                        </div>
                        
                        <div style="display: grid; grid-template-columns: repeat(auto-fit, minmax(250px, 1fr)); gap: 1rem;">
                            <div>
                                <label class="form-label">Alert Days Before</label>
                                <input type="number" id="rule-days-${index}" class="form-input" 
                                       value="${config.days_before || 30}" min="1" max="365"
                                       onchange="updateRule('${config.type}')">
                            </div>
                            <div style="grid-column: 1 / -1;">
                                <label class="form-label">Recipients (comma-separated emails)</label>
                                <input type="text" id="rule-recipients-${index}" class="form-input" 
                                       value="${(config.recipients || []).join(', ')}" 
                                       placeholder="admin@example.com, ops@example.com"
                                       onchange="updateRule('${config.type}')">
                            </div>
                        </div>
                        
                        <div style="margin-top: 1rem; padding-top: 1rem; border-top: 1px solid var(--border-color);">
                            <button onclick="updateRule('${config.type}')" class="btn btn-primary btn-primary">
                                <svg class="ucm-icon" width="16" height="16"><use href="#icon-save"/></svg> Save Rule
                            </button>
                        </div>
                    </div>
                </div>
            `).join('');
        }
    } catch (error) {
        console.error('Error loading notification rules:', error);
    }
}

// Toggle rule enabled/disabled
async function toggleRule(type, enabled) {
    await updateRule(type);
}

// Update notification rule
async function updateRule(type) {
    const index = type === 'cert_expiring' ? 0 : 1;
    const enabled = document.getElementById(`rule-enabled-${index}`).checked;
    const days = parseInt(document.getElementById(`rule-days-${index}`).value);
    const recipientsStr = document.getElementById(`rule-recipients-${index}`).value;
    const recipients = recipientsStr.split(',').map(e => e.trim()).filter(e => e);
    
    try {
        const response = await fetch(`/api/v1/notifications/config/${type}`, {
            method: 'POST',
            headers: {
                'Content-Type': 'application/json',
                'Authorization': `Bearer ${token}`
            },
            body: JSON.stringify({enabled, days_before: days, recipients})
        });
        
        const result = await response.json();
        
        if (response.ok) {
            showToast('Notification rule updated', 'success');
        } else {
            showToast(result.error || 'Failed to update rule', 'error');
        }
    } catch (error) {
        showToast('Error: ' + error.message, 'error');
    }
}

// Load notification history
async function loadNotificationHistory() {
    try {
        const response = await fetch('/api/v1/notifications/history?limit=20', {
            headers: {'Authorization': `Bearer ${token}`}
        });
        
        if (response.ok) {
            const data = await response.json();
            const tbody = document.getElementById('notification-history-tbody');
            
            if (data.logs.length === 0) {
                tbody.innerHTML = `
                    <tr>
                        <td colspan="5" style="text-align: center; padding: 2rem; color: var(--text-secondary);">
                            <svg class="ucm-icon" width="32" height="32" style=" opacity: 0.5;"><use href="#icon-inbox"/></svg>
                            <p style="margin-top: 0.5rem;">No notifications sent yet</p>
                        </td>
                    </tr>
                `;
                return;
            }
            
            tbody.innerHTML = data.logs.map(log => {
                // Escape user-controlled data to prevent XSS
                const safeType = escapeHtml(log.type);
                const safeRecipient = escapeHtml(log.recipient);
                const safeSubject = escapeHtml(log.subject || 'N/A');
                
                return `
                <tr>
                    <td>${new Date(log.sent_at).toLocaleString()}</td>
                    <td><span class="badge-outline badge-info">${safeType}</span></td>
                    <td>${safeRecipient}</td>
                    <td>${safeSubject}</td>
                    <td>
                        ${log.status === 'sent' 
                            ? '<span class="badge-outline badge-success"><svg class="ucm-icon" width="10" height="10" style=""><use href="#icon-check"/></svg> Sent</span>'
                            : '<span class="badge-outline badge-danger"><svg class="ucm-icon" width="10" height="10" style=""><use href="#icon-times"/></svg> Failed</span>'
                        }
                    </td>
                </tr>
            `}).join('');
        }
    } catch (error) {
        console.error('Error loading notification history:', error);
    }
}

// Load notification stats
async function loadNotificationStats() {
    try {
        const response = await fetch('/api/v1/notifications/stats', {
            headers: {'Authorization': `Bearer ${token}`}
        });
        
        if (response.ok) {
            const stats = await response.json();
            const container = document.getElementById('notification-stats');
            
            container.innerHTML = `
                <span class="badge-outline badge-success">
                    <svg class="ucm-icon" width="10" height="10" style=""><use href="#icon-check"/></svg> ${stats.recent_sent_30d} sent (30d)
                </span>
                ${stats.recent_failed_30d > 0 ? `
                    <span class="badge-outline badge-danger">
                        <svg class="ucm-icon" width="10" height="10" style=""><use href="#icon-times"/></svg> ${stats.recent_failed_30d} failed (30d)
                    </span>
                ` : ''}
            `;
        }
    } catch (error) {
        console.error('Error loading stats:', error);
    }
}

// Manual notification check
async function testNotifications() {
    const confirmed = await ucmConfirm(
        'This will check for expiring certificates and CRLs and send notifications if configured. Continue?',
        'Test Notifications',
        { confirmText: 'Continue', icon: 'check' }
    );
    
    if (!confirmed) return;
    
    try {
        const response = await fetch('/api/v1/notifications/check', {
            method: 'POST',
            headers: {'Authorization': `Bearer ${token}`}
        });
        
        const result = await response.json();
        
        if (response.ok) {
            showToast('Notification check completed', 'success');
            loadNotificationHistory();
            loadNotificationStats();
        } else {
            showToast(result.error || 'Check failed', 'error');
        }
    } catch (error) {
        showToast('Error: ' + error.message, 'error');
    }
}

// Initialize
document.addEventListener('DOMContentLoaded', () => {
    loadUserNotificationSettings();
    loadSMTPConfig();
    loadNotificationRules();
    loadNotificationHistory();
    loadNotificationStats();
});
})();

// ============================================
// ACME CONFIGURATION
// ============================================
function copyToClipboard(text) {
    navigator.clipboard.writeText(text).then(() => {
        showToast('Copied to clipboard!', 'success');
    });
}

// Load statistics and settings on page load
document.addEventListener('DOMContentLoaded', function() {
    initAcmePage();
    // Auto-load proxy status if tab is active (from previous session)
    if (localStorage.getItem('ucm-tab-config') === 'proxy') {
       ucm_switchTab('proxy');
       loadProxyStatus();
    }
});

// Also trigger on HTMX content swap
document.addEventListener('htmx:afterSwap', function(event) {
    if (event.detail.target.id === 'main-content' || document.getElementById('acme-status-badge')) {
        initAcmePage();
    }
});

function initAcmePage() {
    loadStatistics();
    loadAcmeCA();
    loadSettings();
    loadProxyStatus();
    
    // Handle form submission success
    const form = document.getElementById('acme-settings-form');
    if (form && !form.hasAttribute('data-listener-added')) {
        form.setAttribute('data-listener-added', 'true');
        form.addEventListener('htmx:afterRequest', function(event) {
            if (event.detail.successful && event.detail.requestConfig.verb === 'post') {
                window.showToast('ACME settings saved successfully', 'success');
                setTimeout(() => loadAcmeCA(), 200);
            }
        });
    }
}

function loadStatistics() {
    fetch('/api/ui/acme/statistics')
        .then(response => response.json())
        .then(data => {
            const totalAccounts = document.getElementById('total-accounts');
            const activeOrders = document.getElementById('active-orders');
            const completedOrders = document.getElementById('completed-orders');
            const issuedCerts = document.getElementById('issued-certs');
            
            if (totalAccounts) totalAccounts.textContent = data.total_accounts || 0;
            if (activeOrders) activeOrders.textContent = data.active_orders || 0;
            if (completedOrders) completedOrders.textContent = data.completed_orders || 0;
            if (issuedCerts) issuedCerts.textContent = data.issued_certs || 0;
        })
        .catch(error => console.error('Error loading stats:', error));
}

function loadAcmeCA() {
    const badge = document.getElementById('acme-status-badge');
    const caDisplay = document.getElementById('acme-ca-display');
    if (!badge) return;
    
    fetch('/api/ui/acme/settings/load')
        .then(response => response.json())
        .then(data => {
            if (data.default_ca) {
                badge.className = 'badge badge-success';
                badge.style.fontSize = '14px';
                badge.style.padding = '6px 12px';
                badge.innerHTML = '<svg class="ucm-icon" width="14" height="14" style="vertical-align: text-bottom; margin-right: 4px;"><use href="#icon-check-circle"/></svg> Active';
                
                const caSelect = document.getElementById('acme-default-ca');
                if (caSelect && caSelect.options.length > 1) {
                    const selectedOption = Array.from(caSelect.options).find(opt => opt.value === data.default_ca);
                    caDisplay.textContent = selectedOption ? selectedOption.text : data.default_ca;
                } else {
                    caDisplay.textContent = 'CA: ' + data.default_ca;
                }
            } else {
                badge.className = 'badge badge-danger';
                badge.style.fontSize = '14px';
                badge.style.padding = '6px 12px';
                badge.innerHTML = '<svg class="ucm-icon" width="14" height="14" style="vertical-align: text-bottom; margin-right: 4px;"><use href="#icon-ban"/></svg> Not Configured';
                caDisplay.textContent = 'No CA configured';
            }
        })
        .catch(error => console.error('Error loading CA:', error));
}

function loadSettings() {
    fetch('/api/ui/acme/settings/load')
        .then(response => response.json())
        .then(data => {
            if (data.default_ca) {
                const select = document.getElementById('acme-default-ca');
                if (select) setTimeout(() => select.value = data.default_ca, 500);
            }
            if (data.cert_validity) {
                const validityInput = document.querySelector('input[name="cert_validity"]');
                if (validityInput) validityInput.value = data.cert_validity;
            }
        });
}

function loadProxyStatus() {
    fetch('/api/ui/acme/proxy/status')
        .then(response => response.json())
        .then(data => {
            // Check if elements exist (user might not be on proxy tab)
            const upstreamDisplay = document.getElementById('proxy-upstream-display');
            const directoryUrl = document.getElementById('proxy-directory-url');
            const container = document.getElementById('proxy-account-container');
            
            if (!upstreamDisplay || !directoryUrl || !container) {
                // Elements not in DOM, silently return
                return;
            }
            
            upstreamDisplay.textContent = data.upstream_url;
            directoryUrl.value = data.directory_url;
            
            if (data.is_registered) {
                container.innerHTML = `
                    <div style="color: var(--success-color); font-weight: 500; font-size: 14px;">
                        <svg class="ucm-icon" width="16" height="16" style="vertical-align: text-bottom; margin-right: 4px;"><use href="#icon-check-circle"/></svg> Registered & Active
                    </div>`;
            } else {
                container.innerHTML = `
                    <div style="display: flex; align-items: center; gap: 10px;">
                        <span class="badge badge-warning">Not Registered</span>
                        <button id="btn-register-proxy" class="btn btn-primary btn-primary" onclick="registerProxyAccount()">
                            Register Account
                        </button>
                    </div>`;
            }
        })
        .catch(err => console.error("Proxy status error", err));
}

function registerProxyAccount() {
    const btn = document.getElementById('btn-register-proxy');
    if (!btn) return;
    
    const originalContent = btn.innerHTML;
    btn.disabled = true;
    btn.innerHTML = '<span class="spinner-border spinner-border-sm" role="status" aria-hidden="true"></span>';
    
    fetch('/api/ui/acme/proxy/register', { method: 'POST' })
        .then(response => response.json())
        .then(data => {
            if (data.status === 'success') {
                window.showToast('Upstream account registered successfully', 'success');
                loadProxyStatus();
            } else {
                window.showToast('Error: ' + (data.message || 'Registration failed'), 'error');
                btn.innerHTML = originalContent;
                btn.disabled = false;
            }
        })
        .catch(err => {
            console.error(err);
            window.showToast('Network error during registration', 'error');
            btn.innerHTML = originalContent;
            btn.disabled = false;
        });
}

// ============================================
// CERTIFICATE TEMPLATES
// ============================================
function viewTemplateDetail(id) {
    openModal('viewTemplateModal'); // View-only, overlay closes automatically
    document.getElementById('viewTemplateContent').innerHTML = '<svg class="ucm-icon icon-spin" width="24" height="24"><use href="#icon-spinner"/></svg>';
    
    fetch('/api/v1/templates/' + id)
        .then(r => r.json())
        .then(t => {
            // Format DN template nicely
            const dnEntries = Object.entries(t.dn_template)
                .filter(([k, v]) => v && v.trim())
                .map(([k, v]) => `<div><strong>${k}:</strong> ${escapeHtml(v)}</div>`)
                .join('');
            
            // Format extensions nicely
            const ku = t.extensions_template.key_usage || [];
            const eku = t.extensions_template.extended_key_usage || [];
            const san = t.extensions_template.san_types || [];
            
            const html = `
                <div style="display: flex; flex-direction: column; gap: 1.5rem;">
                    <!-- Header -->
                    <div>
                        <div style="display: flex; align-items: center; gap: 0.5rem; margin-bottom: 0.5rem;">
                            <h3 style="font-size: 1.25rem; font-weight: 600; color: var(--text-primary); margin: 0;">${escapeHtml(t.name)}</h3>
                            <span style="padding: 0.125rem 0.5rem; background: ${t.is_system ? 'var(--info-color)' : 'var(--success-color)'}20; color: ${t.is_system ? 'var(--info-color)' : 'var(--success-color)'}; border-radius: 4px; font-size: 0.75rem; font-weight: 500;">
                                ${t.is_system ? 'System' : 'Custom'}
                            </span>
                        </div>
                        ${t.description ? `<p style="color: var(--text-secondary); font-size: 0.875rem; margin: 0;">${escapeHtml(t.description)}</p>` : ''}
                    </div>

                    <!-- Configuration -->
                    <div style="display: grid; grid-template-columns: repeat(2, 1fr); gap: 1rem; padding: 1rem; background: var(--bg-secondary); border-radius: 6px;">
                        <div>
                            <div style="font-size: 0.75rem; color: var(--text-secondary); margin-bottom: 0.25rem;">Type</div>
                            <div style="font-weight: 500; color: var(--text-primary);">${escapeHtml(t.template_type)}</div>
                        </div>
                        <div>
                            <div style="font-size: 0.75rem; color: var(--text-secondary); margin-bottom: 0.25rem;">Key Type</div>
                            <div style="font-weight: 500; color: var(--text-primary);">${escapeHtml(t.key_type)}</div>
                        </div>
                        <div>
                            <div style="font-size: 0.75rem; color: var(--text-secondary); margin-bottom: 0.25rem;">Validity</div>
                            <div style="font-weight: 500; color: var(--text-primary);">${t.validity_days} days</div>
                        </div>
                        <div>
                            <div style="font-size: 0.75rem; color: var(--text-secondary); margin-bottom: 0.25rem;">Digest Algorithm</div>
                            <div style="font-weight: 500; color: var(--text-primary);">${escapeHtml(t.digest)}</div>
                        </div>
                    </div>

                    <!-- DN Template -->
                    <div>
                        <h4 style="font-weight: 600; margin-bottom: 0.75rem; color: var(--text-primary);">
                            <svg class="ucm-icon" width="16" height="16" style="vertical-align: middle; margin-right: 0.375rem;"><use href="#icon-file-text"/></svg>
                            Distinguished Name Template
                        </h4>
                        <div style="padding: 1rem; background: var(--bg-primary); border-radius: 4px; font-family: monospace; font-size: 0.875rem;">
                            ${dnEntries || '<div style="color: var(--text-secondary);">No DN template</div>'}
                        </div>
                        <p style="font-size: 0.75rem; color: var(--text-secondary); margin-top: 0.5rem;">
                            Variables: {hostname}, {email}, {username}
                        </p>
                    </div>

                    <!-- Extensions -->
                    <div>
                        <h4 style="font-weight: 600; margin-bottom: 0.75rem; color: var(--text-primary);">
                            <svg class="ucm-icon" width="16" height="16" style="vertical-align: middle; margin-right: 0.375rem;"><use href="#icon-shield"/></svg>
                            Certificate Extensions
                        </h4>
                        
                        <div style="display: grid; gap: 1rem;">
                            ${ku.length ? `
                            <div style="padding: 0.75rem; background: var(--bg-secondary); border-radius: 4px;">
                                <div style="font-size: 0.75rem; color: var(--text-secondary); margin-bottom: 0.5rem;">Key Usage</div>
                                <div style="display: flex; flex-wrap: wrap; gap: 0.375rem;">
                                    ${ku.map(k => `<span style="padding: 0.25rem 0.5rem; background: var(--primary-color)20; color: var(--primary-color); border-radius: 4px; font-size: 0.75rem;">${escapeHtml(k)}</span>`).join('')}
                                </div>
                            </div>
                            ` : ''}
                            
                            ${eku.length ? `
                            <div style="padding: 0.75rem; background: var(--bg-secondary); border-radius: 4px;">
                                <div style="font-size: 0.75rem; color: var(--text-secondary); margin-bottom: 0.5rem;">Extended Key Usage</div>
                                <div style="display: flex; flex-wrap: wrap; gap: 0.375rem;">
                                    ${eku.map(k => `<span style="padding: 0.25rem 0.5rem; background: var(--success-color)20; color: var(--success-color); border-radius: 4px; font-size: 0.75rem;">${escapeHtml(k)}</span>`).join('')}
                                </div>
                            </div>
                            ` : ''}
                            
                            ${san.length ? `
                            <div style="padding: 0.75rem; background: var(--bg-secondary); border-radius: 4px;">
                                <div style="font-size: 0.75rem; color: var(--text-secondary); margin-bottom: 0.5rem;">SAN Types Supported</div>
                                <div style="display: flex; flex-wrap: wrap; gap: 0.375rem;">
                                    ${san.map(k => `<span style="padding: 0.25rem 0.5rem; background: var(--info-color)20; color: var(--info-color); border-radius: 4px; font-size: 0.75rem;">${escapeHtml(k)}</span>`).join('')}
                                </div>
                            </div>
                            ` : ''}
                        </div>
                    </div>
                </div>
            `;
            document.getElementById('viewTemplateContent').innerHTML = html;
        })
        .catch(e => {
            document.getElementById('viewTemplateContent').innerHTML = `<div style="color: var(--danger-color); text-align: center; padding: 2rem;">Error: ${escapeHtml(e.message)}</div>`;
        });
}



function openEditModal(id) {
    showToast('Edit modal - Coming soon', 'info');
}

window.showToast = window.showToast || function(msg, type) { console.log('[' + type + '] ' + msg); };

// ============================================
// EXISTING SETTINGS JAVASCRIPT
// ============================================
// Restore last active tab on page load
document.addEventListener('DOMContentLoaded', function() {
    const lastTab = localStorage.getItem('ucm-tab-settings');
    if (lastTab && document.getElementById('tab-' + lastTab)) {
        ucm_switchTab(lastTab);
    }
});

// Get JWT token from meta tag (defined in base.html)
const getToken = () => document.querySelector('meta[name="access-token"]')?.content || '';

// Load data immediately when script runs (for HTMX navigation)
(function() {
    loadHTTPSCertInfo();
    loadPKIStats();
    setupCertSelectorListener();
    updateMTLSBadge();
})();

// Also load on DOMContentLoaded (for direct page access)
document.addEventListener('DOMContentLoaded', function() {
    loadHTTPSCertInfo();
    loadPKIStats();
    setupCertSelectorListener();
    updateMTLSBadge();
});

function loadHTTPSCertInfo() {
    // First load certificate candidates, then load current cert info
    loadCertificateCandidates().then(() => {
        fetch('/api/ui/system/https-cert-info')
            .then(response => response.json())
            .then(data => {
                // Check if elements exist before modifying
                const certSubject = document.getElementById('cert-subject');
                const certExpiry = document.getElementById('cert-expiry');
                const certType = document.getElementById('cert-type');
                
                if (certSubject && data.subject) certSubject.textContent = data.subject;
                if (certExpiry && data.expires) certExpiry.textContent = data.expires;
                if (certType && data.type) certType.textContent = data.type;
                
                // Set radio button based on source
                if (data.source === 'managed' && data.cert_id) {
                    const managedRadio = document.querySelector('input[name="cert-source"][value="managed"]');
                    if (managedRadio) {
                        managedRadio.checked = true;
                    }
                    
                    // Pre-select certificate in dropdown (no timeout needed now)
                    const select = document.getElementById('managed-cert-id');
                    if (select) {
                        select.value = String(data.cert_id);
                        select.dispatchEvent(new Event('change'));
                    }
                    toggleCertSelector();
                } else {
                    const autoRadio = document.querySelector('input[name="cert-source"][value="auto"]');
                    if (autoRadio) {
                        autoRadio.checked = true;
                        toggleCertSelector();
                    }
                }
            })
            .catch(error => console.error('Error loading HTTPS cert info:', error));
    });
}

function loadCertificateCandidates() {
    const select = document.getElementById('managed-cert-id');
    if (!select) return Promise.resolve(); // Element not found yet
    
    return fetch('/api/ui/system/https-cert-candidates')
        .then(response => response.json())
        .then(data => {
            select.innerHTML = '';
            
            if (!data.certificates || data.certificates.length === 0) {
                select.innerHTML = '<option value="">No suitable server certificates found</option>';
                return;
            }
            
            select.innerHTML = '<option value="">-- Select a certificate --</option>';
            data.certificates.forEach(cert => {
                const option = document.createElement('option');
                option.value = cert.id;
                option.textContent = `${cert.common_name} (expires: ${cert.expires})`;
                option.dataset.subject = cert.subject;
                option.dataset.expires = cert.expires;
                select.appendChild(option);
            });
        })
        .catch(error => {
            console.error('Error loading certificate candidates:', error);
            select.innerHTML = '<option value="">Error loading certificates</option>';
        });
}

function toggleCertSelector() {
    const source = document.querySelector('input[name="cert-source"]:checked');
    const container = document.getElementById('cert-selector-container');
    
    if (!source || !container) return; // Elements don't exist
    
    if (source.value === 'managed') {
        container.style.display = 'block';
    } else {
        container.style.display = 'none';
    }
}

// Setup cert selector change listener (call only once)
function setupCertSelectorListener() {
    const select = document.getElementById('managed-cert-id');
    if (!select || select.dataset.listenerAdded) return;
    
    select.dataset.listenerAdded = 'true';
    select.addEventListener('change', function() {
        const details = document.getElementById('cert-details');
        const selectedCertSubject = document.getElementById('selected-cert-subject');
        const selectedCertExpiry = document.getElementById('selected-cert-expiry');
        
        // Check all elements exist
        if (!details || !selectedCertSubject || !selectedCertExpiry) return;
        
        if (this.value && this.selectedOptions[0].dataset.subject) {
            selectedCertSubject.textContent = this.selectedOptions[0].dataset.subject;
            selectedCertExpiry.textContent = this.selectedOptions[0].dataset.expires;
            details.style.display = 'block';
        } else {
            details.style.display = 'none';
        }
    });
}

function loadPKIStats() {
    fetch('/api/ui/system/pki-stats')
        .then(response => response.json())
        .then(data => {
            if (data.cas !== undefined) document.getElementById('pki-stat-cas').textContent = data.cas;
            if (data.certificates !== undefined) document.getElementById('pki-stat-certs').textContent = data.certificates;
            if (data.crls !== undefined) document.getElementById('pki-stat-crls').textContent = data.crls;
            if (data.ocsp_responses !== undefined) document.getElementById('pki-stat-ocsp').textContent = data.ocsp_responses;
        })
        .catch(error => console.error('Error loading PKI stats:', error));
}

function applyHTTPSCertificate() {
    const source = document.querySelector('input[name="cert-source"]:checked');
    if (!source) return;
    
    // Validate managed cert selection
    if (source.value === 'managed') {
        const certIdSelect = document.getElementById('managed-cert-id');
        if (!certIdSelect || !certIdSelect.value) {
            ucmAlert('Please select a certificate from the list', 'Error');
            return;
        }
    }
    
    ucmConfirm(
        'Applying a new certificate will restart UCM and disconnect your session. Continue?',
        'Apply Certificate',
        { danger: true, confirmText: 'Apply', icon: 'warning-triangle' }
    ).then(confirmed => {
        if (!confirmed) return;
        
        const requestBody = { source: source.value };
        if (source.value === 'managed') {
            requestBody.cert_id = parseInt(document.getElementById('managed-cert-id').value);
        }
        
        fetch('/api/ui/system/https-cert-apply', {
            method: 'POST',
            headers: { 'Content-Type': 'application/json' },
            body: JSON.stringify(requestBody)
        })
        .then(response => response.json())
        .then(data => {
            if (data.success) {
                showRestartCountdown(5, window.location.href);
            } else {
                ucmAlert('Error: ' + (data.error || data.message || 'Unknown error'), 'Error');
            }
        })
        .catch(error => {
            console.error('Error:', error);
            ucmAlert('Failed to apply certificate', 'Error');
        });
    });
}

function regenerateSelfSigned() {
    ucmConfirm(
        'This will generate a new self-signed certificate and restart UCM. Continue?',
        'Regenerate Certificate',
        { danger: true, confirmText: 'Regenerate', icon: 'warning-triangle' }
    ).then(confirmed => {
        if (!confirmed) return;
        
        fetch('/api/ui/system/https-cert-regenerate', {
            method: 'POST'
        })
        .then(response => response.json())
        .then(data => {
            if (data.success) {
                showRestartCountdown(5, window.location.href);
            } else {
                ucmAlert('Error: ' + data.message, 'Error');
            }
        })
        .catch(error => {
            console.error('Error:', error);
            ucmAlert('Failed to regenerate certificate', 'Error');
        });
    });
}

function confirmPKIReset() {
    ucmConfirm(
        '⚠️ DANGER: This will DELETE:\n\n' +
        '• All Certificate Authorities\n' +
        '• All Certificates\n' +
        '• All CRLs and OCSP records\n\n' +
        'A backup will be created automatically.\n' +
        'Users and sessions will NOT be affected.\n\n' +
        'Type "RESET PKI DATA" in the next prompt to confirm.',
        'Reset PKI Database?',
        { danger: true, confirmText: 'Continue', icon: 'warning-triangle' }
    ).then(confirmed => {
        if (!confirmed) return;
        
        // Create custom prompt modal for text confirmation
        const promptHTML = `
            <div class="ucm-modal-overlay" onclick="event.stopPropagation()">
                <div class="ucm-modal" onclick="event.stopPropagation()">
                    <div class="ucm-modal-header">
                        <div style="display: flex; align-items: center; gap: 0.75rem;">
                            <svg class="ucm-icon" width="24" height="24" style="color: var(--status-danger);"><use href="#icon-warning-triangle"/></svg>
                            <h2 class="ucm-modal-title">⚠️ Final Confirmation Required</h2>
                        </div>
                    </div>
                    <div class="ucm-modal-body">
                        <p style="margin-bottom: 1rem;">Type exactly: <strong>RESET PKI DATA</strong></p>
                        <input type="text" id="pki-reset-confirmation" class="form-input" placeholder="RESET PKI DATA" style="width: 100%;">
                    </div>
                    <div class="ucm-modal-footer">
                        <button class="btn-secondary" onclick="document.getElementById('ucm-modal-container').innerHTML = ''">
                            Cancel
                        </button>
                        <button class="btn-danger" onclick="executePKIReset()">
                            Reset Database
                        </button>
                    </div>
                </div>
            </div>
        `;
        
        document.getElementById('ucm-modal-container').innerHTML = promptHTML;
        document.getElementById('pki-reset-confirmation').focus();
    });
}

function executePKIReset() {
    const confirmation = document.getElementById('pki-reset-confirmation').value;
    
    if (confirmation !== 'RESET PKI DATA') {
        ucmAlert('❌ Confirmation failed. Text did not match.\n\nPKI reset cancelled.', 'Confirmation Failed');
        document.getElementById('ucm-modal-container').innerHTML = '';
        return;
    }
    
    document.getElementById('ucm-modal-container').innerHTML = '';
    
    fetch('/api/ui/system/pki-reset', {
        method: 'POST',
        headers: { 'Content-Type': 'application/json' },
        body: JSON.stringify({ confirmation: 'RESET PKI DATA' })
    })
    .then(response => response.json())
    .then(data => {
        if (data.success) {
            ucmAlert('✅ PKI Database has been reset successfully!\n\nBackup created: ' + data.backup_file, 'Success');
            loadPKIStats();
        } else {
            ucmAlert('Error: ' + data.message, 'Error');
        }
    })
    .catch(error => {
        console.error('Error:', error);
        ucmAlert('Failed to reset PKI database', 'Error');
    });
}

// ========================================
// mTLS Status Badge
// ========================================
function updateMTLSBadge() {
    const token = getToken();
    
    fetch('/api/v1/mtls/settings', {
        headers: { 'Authorization': `Bearer ${token}` }
    })
    .then(response => response.json())
    .then(data => {
        const badge = document.getElementById('mtls-status-badge');
        if (badge) {
            if (data.enabled) {
                badge.className = 'badge-outline badge-success';
                badge.innerHTML = '<svg class="ucm-icon" width="10" height="10"><use href="#icon-check-circle"/></svg> Enabled';
            } else {
                badge.className = 'badge-outline badge-secondary';
                badge.innerHTML = '<svg class="ucm-icon" width="10" height="10"><use href="#icon-circle"/></svg> Disabled';
            }
        }
    })
    .catch(error => console.error('Error loading mTLS status:', error));
}

// ========================================
// Backup & Restore Functions
// ========================================

function openBackupModal() {
    const modalHTML = `
        <div class="ucm-modal-overlay" onclick="closeBackupModal()">
            <div class="ucm-modal" onclick="event.stopPropagation()" style="max-width: 600px;">
                <div class="ucm-modal-header">
                    <div style="display: flex; align-items: center; gap: 0.75rem;">
                        <svg class="ucm-icon" width="24" height="24" style="color: var(--primary-color);"><use href="#icon-download"/></svg>
                        <h2 class="ucm-modal-title">Create Encrypted Backup</h2>
                    </div>
                    <button onclick="closeBackupModal()" class="ucm-modal-close">
                        <svg class="ucm-icon" width="20" height="20"><use href="#icon-times"/></svg>
                    </button>
                </div>
                <div class="ucm-modal-body">
                    <p style="margin-bottom: 1.5rem; color: var(--text-secondary);">
                        Create a complete encrypted backup of your PKI system.
                    </p>
                    
                    <div style="margin-bottom: 1.5rem;">
                        <label class="form-label">Backup Password</label>
                        <input type="password" id="backup-password" class="form-input" 
                               placeholder="Enter password (min 12 characters)" 
                               minlength="12" required>
                        <p style="font-size: 0.75rem; color: var(--text-secondary); margin-top: 0.25rem;">
                            Required for restoring. Keep it safe!
                        </p>
                    </div>
                    
                    <div style="margin-bottom: 1.5rem;">
                        <label class="form-label">Confirm Password</label>
                        <input type="password" id="backup-password-confirm" class="form-input" 
                               placeholder="Confirm password" required>
                    </div>
                    
                    <div style="margin-bottom: 1.5rem;">
                        <label class="form-label">Include in Backup</label>
                        <div style="display: flex; flex-direction: column; gap: 0.5rem;">
                            <label style="display: flex; align-items: center; gap: 0.5rem;">
                                <input type="checkbox" id="include-cas" checked>
                                <span>Certificate Authorities</span>
                            </label>
                            <label style="display: flex; align-items: center; gap: 0.5rem;">
                                <input type="checkbox" id="include-certs" checked>
                                <span>Certificates</span>
                            </label>
                            <label style="display: flex; align-items: center; gap: 0.5rem;">
                                <input type="checkbox" id="include-users" checked>
                                <span>Users & Roles</span>
                            </label>
                            <label style="display: flex; align-items: center; gap: 0.5rem;">
                                <input type="checkbox" id="include-config" checked>
                                <span>System Configuration</span>
                            </label>
                            <label style="display: flex; align-items: center; gap: 0.5rem;">
                                <input type="checkbox" id="include-acme" checked>
                                <span>ACME Accounts</span>
                            </label>
                        </div>
                    </div>
                    
                    <div id="backup-progress" style="display: none; margin-bottom: 1rem;">
                        <div class="progress-bar">
                            <div class="progress-bar-fill" style="width: 100%;"></div>
                        </div>
                        <p style="text-align: center; margin-top: 0.5rem; color: var(--text-secondary);">
                            Creating backup...
                        </p>
                    </div>
                </div>
                <div class="ucm-modal-footer">
                    <button class="btn-secondary" onclick="closeBackupModal()">Cancel</button>
                    <button class="btn-primary" onclick="createBackup()">
                        <svg class="ucm-icon" width="16" height="16"><use href="#icon-download"/></svg>
                        Create Backup
                    </button>
                </div>
            </div>
        </div>
    `;
    
    document.getElementById('ucm-modal-container').innerHTML = modalHTML;
    document.getElementById('backup-password').focus();
}

function closeBackupModal() {
    document.getElementById('ucm-modal-container').innerHTML = '';
}

async function createBackup() {
    const password = document.getElementById('backup-password').value;
    const passwordConfirm = document.getElementById('backup-password-confirm').value;
    
    // Validate
    if (!password || password.length < 12) {
        showToast('Password must be at least 12 characters long', 'warning');
        return;
    }
    
    if (password !== passwordConfirm) {
        showToast('Passwords do not match', 'error');
        return;
    }
    
    const createBtn = document.querySelector('[onclick="createBackup()"]');
    showButtonSpinner(createBtn, 'Creating...');
    
    // Show progress
    document.getElementById('backup-progress').style.display = 'block';
    
    // Prepare backup request
    const include = {
        cas: document.getElementById('include-cas').checked,
        certificates: document.getElementById('include-certs').checked,
        users: document.getElementById('include-users').checked,
        configuration: document.getElementById('include-config').checked,
        acme_accounts: document.getElementById('include-acme').checked
    };
    
    try {
        const response = await fetch('/api/v1/backup/create', {
            method: 'POST',
            headers: {
                'Content-Type': 'application/json',
                'Authorization': 'Bearer ' + getToken()
            },
            body: JSON.stringify({
                password: password,
                type: 'full',
                include: include
            })
        });
        
        if (!response.ok) {
            const error = await response.json();
            throw new Error(error.error || 'Backup creation failed');
        }
        
        // Download the file
        const blob = await response.blob();
        const url = window.URL.createObjectURL(blob);
        const a = document.createElement('a');
        a.href = url;
        a.download = `ucm-backup-${new Date().toISOString().replace(/[:.]/g, '-')}.ucm-backup`;
        document.body.appendChild(a);
        a.click();
        document.body.removeChild(a);
        window.URL.revokeObjectURL(url);
        
        closeBackupModal();
        showToast('Backup created and downloaded successfully', 'success');
        
    } catch (error) {
        console.error('Backup error:', error);
        showToast('Backup creation failed: ' + error.message, 'error');
    } finally {
        hideButtonSpinner(createBtn);
        document.getElementById('backup-progress').style.display = 'none';
    }
}

function openRestoreModal() {
    const modalHTML = `
        <div class="ucm-modal-overlay" onclick="closeRestoreModal()">
            <div class="ucm-modal" onclick="event.stopPropagation()" style="max-width: 600px;">
                <div class="ucm-modal-header">
                    <div style="display: flex; align-items: center; gap: 0.75rem;">
                        <svg class="ucm-icon" width="24" height="24" style="color: var(--warning-color);"><use href="#icon-upload"/></svg>
                        <h2 class="ucm-modal-title">Restore from Backup</h2>
                    </div>
                    <button onclick="closeRestoreModal()" class="ucm-modal-close">
                        <svg class="ucm-icon" width="20" height="20"><use href="#icon-times"/></svg>
                    </button>
                </div>
                <div class="ucm-modal-body">
                    <div class="alert-warning-border">
                        <div style="display: flex; align-items: start; gap: 0.5rem;">
                            <svg class="ucm-icon" width="16" height="16" style="color: var(--warning-color); flex-shrink: 0; margin-top: 2px;"><use href="#icon-warning-triangle"/></svg>
                            <p style="margin: 0; font-size: 0.8125rem;">
                                <strong>Warning:</strong> UCM will automatically restart after restore.
                            </p>
                        </div>
                    </div>
                    
                    <div style="margin-bottom: 0.75rem;">
                        <label class="form-label">Backup File</label>
                        <input type="file" id="restore-file" class="form-input" 
                               accept=".ucm-backup" required>
                        <p style="font-size: 0.75rem; color: var(--text-secondary); margin-top: 0.25rem;">
                            Select a .ucm-backup file
                        </p>
                    </div>
                    
                    <div style="margin-bottom: 1rem;">
                        <label class="form-label">Backup Password</label>
                        <input type="password" id="restore-password" class="form-input" 
                               placeholder="Enter backup password" required>
                    </div>
                    
                    <!-- Validation Results (hidden initially, shown after validation) -->
                    <div id="backup-info" style="display: none; opacity: 0; transition: opacity 0.3s ease, max-height 0.3s ease; max-height: 0; overflow: hidden; margin-bottom: 1rem;">
                        <!-- Card wrapper around everything -->
                        <div class="card" style="box-shadow: 0 1px 3px rgba(0,0,0,0.1); border: 1px solid var(--border-color);">
                            <div class="card-body" style="padding: 0.5rem;">
                                <!-- Title -->
                                <div style="margin-bottom: 0.5rem; padding-bottom: 0.375rem; border-bottom: 1px solid var(--border-color);">
                                    <h4 style="margin: 0; font-weight: 600; font-size: 0.875rem; color: var(--text-primary); display: flex; align-items: center; gap: 0.375rem;">
                                        <svg class="ucm-icon" width="14" height="14" style="color: var(--success-color);"><use href="#icon-check-circle"/></svg>
                                        Backup Validated
                                    </h4>
                                </div>
                                
                                <!-- Stats Grid (dashboard style) -->
                                <div id="backup-stats" style="display: grid; grid-template-columns: repeat(2, 1fr); gap: 0.375rem; margin-bottom: 0.5rem;"></div>
                                
                                <!-- Metadata Details -->
                                <div style="background: var(--bg-secondary); padding: 0.5rem; border-radius: 0.3rem; border: 1px solid var(--border-color);">
                                    <div id="backup-metadata-details"></div>
                                </div>
                            </div>
                        </div>
                    </div>
                    
                    <div style="margin-bottom: 1rem;">
                        <label class="form-label">Restore Options</label>
                        <div style="display: grid; grid-template-columns: 1fr 1fr; gap: 0.5rem 1rem;">
                            <label style="display: flex; align-items: center; gap: 0.5rem;">
                                <input type="checkbox" id="restore-cas" checked>
                                <span>Certificate Authorities</span>
                            </label>
                            <label style="display: flex; align-items: center; gap: 0.5rem;">
                                <input type="checkbox" id="restore-certs" checked>
                                <span>Certificates</span>
                            </label>
                            <label style="display: flex; align-items: center; gap: 0.5rem;">
                                <input type="checkbox" id="restore-users">
                                <span>Users (merge)</span>
                            </label>
                            <label style="display: flex; align-items: center; gap: 0.5rem;">
                                <input type="checkbox" id="restore-config">
                                <span>System Configuration</span>
                            </label>
                        </div>
                    </div>
                    
                    <div id="restore-progress" style="display: none; margin-bottom: 1rem;">
                        <div class="progress-bar">
                            <div class="progress-bar-fill" style="width: 100%;"></div>
                        </div>
                        <p style="text-align: center; margin-top: 0.5rem; color: var(--text-secondary);">
                            Restoring backup...
                        </p>
                    </div>
                </div>
                <div class="ucm-modal-footer">
                    <button class="btn-secondary" onclick="closeRestoreModal()">Cancel</button>
                    <button id="validate-btn" class="btn-secondary" onclick="validateBackup()">
                        <svg class="ucm-icon" width="16" height="16"><use href="#icon-check"/></svg>
                        Validate Backup
                    </button>
                    <button id="restore-btn" class="btn-secondary" onclick="restoreBackup()" style="display: none;">
                        <svg class="ucm-icon" width="16" height="16"><use href="#icon-upload"/></svg>
                        Restore Backup
                    </button>
                </div>
            </div>
        </div>
    `;
    
    document.getElementById('ucm-modal-container').innerHTML = modalHTML;
}

function closeRestoreModal() {
    document.getElementById('ucm-modal-container').innerHTML = '';
}

async function validateBackup() {
    const fileInput = document.getElementById('restore-file');
    const password = document.getElementById('restore-password').value;
    
    if (!fileInput.files[0]) {
        showToast('Please select a backup file', 'warning');
        return;
    }
    
    if (!password) {
        showToast('Please enter the backup password', 'warning');
        return;
    }
    
    const validateBtn = document.getElementById('validate-btn');
    showButtonSpinner(validateBtn, 'Validating...');
    
    const formData = new FormData();
    formData.append('file', fileInput.files[0]);
    formData.append('password', password);
    
    try {
        const response = await fetch('/api/v1/backup/validate', {
            method: 'POST',
            headers: {
                'Authorization': 'Bearer ' + getToken()
            },
            body: formData
        });
        
        const data = await response.json();
        
        if (!data.valid) {
            hideButtonSpinner(validateBtn);
            showToast('Invalid backup: ' + (data.error || 'Unknown error'), 'error');
            return;
        }
        
        // Create dashboard-style stat widgets
        const statsDiv = document.getElementById('backup-stats');
        
        const stats = [
            { 
                icon: 'shield-check', 
                colorVar: 'info-color', 
                value: data.contents.cas, 
                label: 'Certificate Authorities'
            },
            { 
                icon: 'certificate', 
                colorVar: 'success-color', 
                value: data.contents.certificates, 
                label: 'Certificates'
            },
            { 
                icon: 'users', 
                colorVar: 'primary-color', 
                value: data.contents.users, 
                label: 'Users'
            },
            { 
                icon: 'key', 
                colorVar: 'warning-color', 
                value: data.contents.acme_accounts, 
                label: 'ACME Accounts'
            }
        ];
        
        statsDiv.innerHTML = stats.map(stat => `
            <div style="background: var(--card-bg); border: 1px solid var(--border-color); border-radius: 0.375rem; padding: 0.5rem; display: flex; gap: 0.5rem; align-items: center; box-shadow: 0 1px 2px rgba(0,0,0,0.05);">
                <div style="width: 32px; height: 32px; border-radius: 5px; background: var(--surface-elevated); display: flex; align-items: center; justify-content: center; flex-shrink: 0;">
                    <svg class="ucm-icon" width="16" height="16" style="color: var(--${stat.colorVar});"><use href="#icon-${stat.icon}"/></svg>
                </div>
                <div style="flex: 1; min-width: 0;">
                    <div style="font-size: 18px; font-weight: 600; color: var(--text-primary); line-height: 1;">
                        ${stat.value}
                    </div>
                    <div style="font-size: 0.6875rem; color: var(--text-secondary); font-weight: 500; margin-top: 1px; white-space: nowrap; overflow: hidden; text-overflow: ellipsis;">
                        ${stat.label}
                    </div>
                </div>
            </div>
        `).join('');
        
        // Metadata details
        const metadataDetailsDiv = document.getElementById('backup-metadata-details');
        metadataDetailsDiv.innerHTML = `
            <div style="display: grid; grid-template-columns: auto 1fr; gap: 0.375rem 1rem; color: var(--text-secondary); font-size: 0.8125rem;">
                <strong style="color: var(--text-primary);">Version:</strong>
                <span>${data.metadata.ucm_version}</span>
                
                <strong style="color: var(--text-primary);">Created:</strong>
                <span>${new Date(data.metadata.created_at).toLocaleString()}</span>
                
                <strong style="color: var(--text-primary);">Hostname:</strong>
                <span>${data.metadata.hostname}</span>
                
                <strong style="color: var(--text-primary);">Type:</strong>
                <span style="text-transform: capitalize;">${data.metadata.backup_type}</span>
            </div>
        `;
        
        // Smooth reveal animation
        const infoDiv = document.getElementById('backup-info');
        infoDiv.style.display = 'block';
        infoDiv.style.maxHeight = '0';
        infoDiv.style.opacity = '0';
        
        // Trigger animation on next frame
        requestAnimationFrame(() => {
            requestAnimationFrame(() => {
                infoDiv.style.maxHeight = '600px';
                infoDiv.style.opacity = '1';
            });
        });
        
        // Update validate button to green with checkmark (hide spinner first)
        hideButtonSpinner(validateBtn);
        validateBtn.className = 'btn-success';
        validateBtn.style.background = 'var(--success-color)';
        validateBtn.style.borderColor = 'var(--success-color)';
        validateBtn.innerHTML = '<svg class="ucm-icon" width="16" height="16"><use href="#icon-check-circle"/></svg> Validated ✓';
        validateBtn.disabled = true;
        
        // Show restore button
        document.getElementById('restore-btn').style.display = 'inline-flex';
        
        // Show success toast (non-intrusive)
        showToast('Backup validated successfully', 'success');
        
    } catch (error) {
        console.error('Validation error:', error);
        showToast('Validation failed: ' + error.message, 'error');
        hideButtonSpinner(validateBtn);
    }
}

async function restoreBackup() {
    const fileInput = document.getElementById('restore-file');
    const password = document.getElementById('restore-password').value;
    
    if (!fileInput.files[0] || !password) {
        showToast('Please select a file and enter password', 'warning');
        return;
    }
    
    // Confirm
    const confirmed = await ucmConfirm(
        'This will restore data from the backup file.\n\n' +
        '⚠️ UCM will restart automatically after restore.\n' +
        'You will need to log in again.\n\n' +
        'Continue?',
        'Confirm Restore',
        { danger: true, confirmText: 'Restore Now', icon: 'warning-triangle' }
    );
    
    if (!confirmed) return;
    
    const restoreBtn = document.getElementById('restore-btn');
    showButtonSpinner(restoreBtn, 'Restoring...');
    
    // Show progress
    document.getElementById('restore-progress').style.display = 'block';
    
    const options = {
        restore_cas: document.getElementById('restore-cas').checked,
        restore_certificates: document.getElementById('restore-certs').checked,
        restore_users: document.getElementById('restore-users').checked,
        merge_users: document.getElementById('restore-users').checked,
        restore_configuration: document.getElementById('restore-config').checked
    };
    
    const formData = new FormData();
    formData.append('file', fileInput.files[0]);
    formData.append('password', password);
    formData.append('options', JSON.stringify(options));
    
    try {
        const response = await fetch('/api/v1/backup/restore', {
            method: 'POST',
            headers: {
                'Authorization': 'Bearer ' + getToken()
            },
            body: formData
        });
        
        console.log('Restore response status:', response.status);
        const data = await response.json();
        console.log('Restore response data:', data);
        
        if (!response.ok || !data.success) {
            throw new Error(data.error || 'Restore failed');
        }
        
        console.log('Closing modal and showing countdown...');
        closeRestoreModal();
        
        // Show restart countdown with spinner
        showRestartCountdown(5, '/login');
        
    } catch (error) {
        console.error('Restore error:', error);
        showToast('Restore failed: ' + error.message, 'error');
        hideButtonSpinner(restoreBtn);
        document.getElementById('restore-progress').style.display = 'none';
    }
}

// ============================================================================
// Database Management Functions
// ============================================================================

// Load database stats on page load
async function loadDatabaseStats() {
    try {
        const response = await fetch('/api/v1/system/database/stats', {
            headers: { 'Authorization': 'Bearer ' + getToken() }
        });
        const data = await response.json();
        
        if (data.success && data.stats) {
            const stats = data.stats;
            
            // Update stats
            document.getElementById('db-stat-size').textContent = stats.size_formatted || '0 MB';
            document.getElementById('db-stat-frag').textContent = stats.fragmentation_pct + '%';
            
            // Update last maintenance
            if (stats.last_vacuum) {
                const vacuumDate = new Date(stats.last_vacuum);
                document.getElementById('db-last-vacuum').textContent = vacuumDate.toLocaleDateString();
            }
            if (stats.last_integrity_check) {
                const checkDate = new Date(stats.last_integrity_check);
                document.getElementById('db-last-check').textContent = checkDate.toLocaleDateString();
            }
            
            // Update table counts
            if (stats.tables) {
                if (stats.tables.certificate_authority !== undefined) 
                    document.getElementById('pki-stat-cas').textContent = stats.tables.certificate_authority || 0;
                if (stats.tables.certificate !== undefined) 
                    document.getElementById('pki-stat-certs').textContent = stats.tables.certificate || 0;
                if (stats.tables.crl !== undefined) 
                    document.getElementById('pki-stat-crls').textContent = stats.tables.crl || 0;
                if (stats.tables.ocsp_response !== undefined) 
                    document.getElementById('pki-stat-ocsp').textContent = stats.tables.ocsp_response || 0;
            }
        }
        
        // Load health status
        loadDatabaseHealth();
        
    } catch (error) {
        console.error('Error loading database stats:', error);
    }
}

async function loadDatabaseHealth() {
    try {
        const response = await fetch('/api/v1/system/database/health', {
            headers: { 'Authorization': 'Bearer ' + getToken() }
        });
        const data = await response.json();
        
        if (data.success && data.health) {
            const health = data.health;
            const badge = document.getElementById('db-health-badge');
            
            // Update health badge
            if (health.status === 'healthy') {
                badge.className = 'badge-outline badge-success';
                badge.innerHTML = '<svg class="ucm-icon" width="10" height="10"><use href="#icon-check-circle"/></svg> Healthy';
            } else if (health.status === 'warning') {
                badge.className = 'badge-outline badge-warning';
                badge.innerHTML = '<svg class="ucm-icon" width="10" height="10"><use href="#icon-warning-triangle"/></svg> Warnings';
            } else {
                badge.className = 'badge-outline badge-danger';
                badge.innerHTML = '<svg class="ucm-icon" width="10" height="10"><use href="#icon-exclamation-circle"/></svg> Issues';
            }
        }
        
    } catch (error) {
        console.error('Error loading database health:', error);
    }
}

async function optimizeDatabase() {
    const confirmed = confirm('Optimize database?\n\nThis will run VACUUM and ANALYZE to:\n• Reclaim unused disk space\n• Defragment the database\n• Update query statistics\n\nThis may take a few moments.');
    
    if (!confirmed) return;
    
    showToast('Optimizing database...', 'info');
    
    try {
        const response = await fetch('/api/v1/system/database/optimize', {
            method: 'POST',
            headers: { 
                'Authorization': 'Bearer ' + getToken(),
                'Content-Type': 'application/json'
            }
        });
        
        const data = await response.json();
        
        if (data.success) {
            const saved = data.vacuum.space_saved_formatted || '0 B';
            showToast(`Database optimized successfully! Space saved: ${saved}`, 'success');
            loadDatabaseStats(); // Refresh stats
        } else {
            throw new Error(data.error || 'Optimization failed');
        }
        
    } catch (error) {
        showToast('Error: ' + error.message, 'error');
    }
}

async function checkIntegrity() {
    showToast('Running integrity check...', 'info');
    
    try {
        const response = await fetch('/api/v1/system/database/integrity-check', {
            method: 'POST',
            headers: { 
                'Authorization': 'Bearer ' + getToken(),
                'Content-Type': 'application/json'
            }
        });
        
        const data = await response.json();
        
        if (data.healthy) {
            showToast('Database integrity check passed - no errors found', 'success');
        } else if (data.errors && data.errors.length > 0) {
            showToast('Database integrity issues found: ' + data.errors.join(', '), 'error');
        } else {
            showToast('Integrity check completed', 'success');
        }
        
        loadDatabaseStats(); // Refresh last check date
        
    } catch (error) {
        showToast('Error: ' + error.message, 'error');
    }
}

async function cleanExpiredCerts() {
    const confirmed = confirm('Clean expired certificates?\n\nThis will permanently delete certificates that expired more than 30 days ago.\n\nRevoked certificates will be preserved for CRL generation.');
    
    if (!confirmed) return;
    
    showToast('Cleaning expired certificates...', 'info');
    
    try {
        const response = await fetch('/api/v1/system/database/clean-expired', {
            method: 'POST',
            headers: { 
                'Authorization': 'Bearer ' + getToken(),
                'Content-Type': 'application/json'
            },
            body: JSON.stringify({ days_after_expiry: 30 })
        });
        
        const data = await response.json();
        
        if (data.success) {
            showToast(`Deleted ${data.deleted_count} expired certificates`, 'success');
            loadDatabaseStats(); // Refresh stats
        } else {
            throw new Error(data.error || 'Cleanup failed');
        }
        
    } catch (error) {
        showToast('Error: ' + error.message, 'error');
    }
}

async function exportDatabase() {
    const confirmed = confirm('Export database?\n\nThis will download a compressed SQL dump of the entire database.');
    
    if (!confirmed) return;
    
    showToast('Exporting database...', 'info');
    
    try {
        const response = await fetch('/api/v1/system/database/export', {
            method: 'POST',
            headers: { 
                'Authorization': 'Bearer ' + getToken(),
                'Content-Type': 'application/json'
            },
            body: JSON.stringify({ compress: true })
        });
        
        if (response.ok) {
            // Download file
            const blob = await response.blob();
            const url = window.URL.createObjectURL(blob);
            const a = document.createElement('a');
            a.href = url;
            a.download = 'ucm-database-dump.sql.gz';
            document.body.appendChild(a);
            a.click();
            window.URL.revokeObjectURL(url);
            document.body.removeChild(a);
            
            showToast('Database exported successfully', 'success');
        } else {
            const data = await response.json();
            throw new Error(data.error || 'Export failed');
        }
        
    } catch (error) {
        showToast('Error: ' + error.message, 'error');
    }
}

// Load database stats on Database tab activation
document.addEventListener('DOMContentLoaded', () => {
    // Load stats when Database tab is clicked
    const dbTab = document.querySelector('.tab-button[onclick*="database"]');
    if (dbTab) {
        dbTab.addEventListener('click', () => {
            setTimeout(loadDatabaseStats, 100);
        });
    }
    
    // Load stats if Database tab is active on page load
    const activeTab = localStorage.getItem('ucm-settings-tab');
    if (activeTab === 'database') {
        setTimeout(loadDatabaseStats, 500);
    }
});

</script>
{% endblock %}

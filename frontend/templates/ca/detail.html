{% extends "base.html" %}

{% block title %}CA Details - {{ ca.common_name }} - UCM{% endblock %}

{% block content %}
<script>
// Auto-detect server URL for CDP and OCSP defaults
const DEFAULT_SERVER_URL = window.location.protocol + '//' + window.location.host;
</script>

<div style="max-width: 1400px; margin: 0 auto;">
    <!-- Header -->
    <div style="margin-bottom: 1.5rem; display: flex; justify-content: space-between; align-items: center;">
        <div>
            <h1 style="font-size: 1.875rem; font-weight: 600; color: var(--text-primary); margin: 0; display: flex; align-items: center; gap: 0.5rem;">
                <svg class="ucm-icon" width="24" height="24"><use href="#icon-lock"/></svg>
                <span>{{ ca.common_name }}</span>
            </h1>
            <p style="margin-top: 0.5rem; font-size: 0.875rem; color: var(--text-secondary);">Certificate Authority Details</p>
        </div>
        <div style="display: flex; gap: 0.75rem;">
            <a href="/ca" class="btn-secondary">
                <svg class="ucm-icon" width="16" height="16"><use href="#icon-arrow-left"/></svg> Back to List
            </a>
            <button data-action="download-crl-pem" data-id="{{ ca.id }}" class="btn-primary">
                <svg class="ucm-icon" width="16" height="16"><use href="#icon-ban"/></svg> Download CRL
            </button>
            <div style="position: relative; display: inline-block;">
                <button data-action="toggle-export-menu" class="btn-primary">
                    <svg class="ucm-icon" width="16" height="16"><use href="#icon-download"/></svg> Export
                    <svg class="ucm-icon" width="16" height="16"><use href="#icon-chevron-down"/></svg>
                </button>
                <div id="export-menu" class="hidden" style="position: absolute; right: 0; margin-top: 0.5rem; width: 14rem; border-radius: 0.375rem; box-shadow: var(--shadow-lg); background: var(--card-bg); border: 1px solid var(--border-color); z-index: 10;">
                    <div style="padding: 0.25rem 0;">
                        <button data-action="export-ca-simple" data-id="{{ ca.id }}" style="display: block; width: 100%; text-align: left; padding: 0.5rem 1rem; font-size: 0.875rem; color: var(--text-primary); background: none; border: none; cursor: pointer;" onmouseover="this.style.background='var(--bg-hover)'" onmouseout="this.style.background='transparent'">
                            <svg class="ucm-icon" width="16" height="16"><use href="#icon-file-text"/></svg> Certificate only (PEM)
                        </button>
                        <button data-action="export-ca-key" data-id="{{ ca.id }}" style="display: block; width: 100%; text-align: left; padding: 0.5rem 1rem; font-size: 0.875rem; color: var(--text-primary); background: none; border: none; cursor: pointer;" onmouseover="this.style.background='var(--bg-hover)'" onmouseout="this.style.background='transparent'">
                            <svg class="ucm-icon" width="16" height="16"><use href="#icon-key"/></svg> Certificate + Key (PEM)
                        </button>
                        <button data-action="export-ca-chain" data-id="{{ ca.id }}" style="display: block; width: 100%; text-align: left; padding: 0.5rem 1rem; font-size: 0.875rem; color: var(--text-primary); background: none; border: none; cursor: pointer;" onmouseover="this.style.background='var(--bg-hover)'" onmouseout="this.style.background='transparent'">
                            <svg class="ucm-icon" width="16" height="16"><use href="#icon-link"/></svg> Certificate + Chain (PEM)
                        </button>
                        <button data-action="export-ca-full" data-id="{{ ca.id }}" style="display: block; width: 100%; text-align: left; padding: 0.5rem 1rem; font-size: 0.875rem; color: var(--text-primary); background: none; border: none; cursor: pointer;" onmouseover="this.style.background='var(--bg-hover)'" onmouseout="this.style.background='transparent'">
                            <svg class="ucm-icon" width="16" height="16"><use href="#icon-archive"/></svg> Full Chain + Key (PEM)
                        </button>
                        <button data-action="export-ca-der" data-id="{{ ca.id }}" style="display: block; width: 100%; text-align: left; padding: 0.5rem 1rem; font-size: 0.875rem; color: var(--text-primary); background: none; border: none; cursor: pointer;" onmouseover="this.style.background='var(--bg-hover)'" onmouseout="this.style.background='transparent'">
                            <svg class="ucm-icon" width="16" height="16"><use href="#icon-file-text"/></svg> Certificate (DER)
                        </button>
                        <button data-action="show-pkcs12-modal" data-id="{{ ca.id }}" data-type="ca" style="display: block; width: 100%; text-align: left; padding: 0.5rem 1rem; font-size: 0.875rem; color: var(--text-primary); background: none; border: none; cursor: pointer;" onmouseover="this.style.background='var(--bg-hover)'" onmouseout="this.style.background='transparent'">
                            <svg class="ucm-icon" width="16" height="16"><use href="#icon-lock"/></svg> PKCS#12 (.p12/.pfx)
                        </button>
                    </div>
                </div>
            </div>
        </div>
    </div>

    <!-- CA Information -->
    <div style="display: grid; grid-template-columns: repeat(auto-fit, minmax(500px, 1fr)); gap: 1.5rem;">
        <!-- Basic Information -->
        <div class="card" style="padding: 0;">
            <h2 style="font-size: 1.25rem; font-weight: 600; margin-bottom: 1rem; color: var(--text-primary);">Basic Information</h2>
            <dl style="display: flex; flex-direction: column; gap: 0.75rem;">
                <div>
                    <dt style="font-size: 0.875rem; font-weight: 500; color: var(--text-secondary);">Common Name</dt>
                    <dd style="margin-top: 0.25rem; font-size: 0.875rem; color: var(--text-primary); font-family: monospace;">{{ ca.common_name }}</dd>
                </div>
                <div>
                    <dt style="font-size: 0.875rem; font-weight: 500; color: var(--text-secondary);">Organization</dt>
                    <dd style="margin-top: 0.25rem; font-size: 0.875rem; color: var(--text-primary);">{{ ca.organization or 'N/A' }}</dd>
                </div>
                <div>
                    <dt style="font-size: 0.875rem; font-weight: 500; color: var(--text-secondary);">Organizational Unit</dt>
                    <dd style="margin-top: 0.25rem; font-size: 0.875rem; color: var(--text-primary);">{{ ca.organizational_unit or 'N/A' }}</dd>
                </div>
                <div>
                    <dt style="font-size: 0.875rem; font-weight: 500; color: var(--text-secondary);">Country</dt>
                    <dd style="margin-top: 0.25rem; font-size: 0.875rem; color: var(--text-primary);">{{ ca.country or 'N/A' }}</dd>
                </div>
                <div>
                    <dt style="font-size: 0.875rem; font-weight: 500; color: var(--text-secondary);">State/Province</dt>
                    <dd style="margin-top: 0.25rem; font-size: 0.875rem; color: var(--text-primary);">{{ ca.state or 'N/A' }}</dd>
                </div>
                <div>
                    <dt style="font-size: 0.875rem; font-weight: 500; color: var(--text-secondary);">Locality</dt>
                    <dd style="margin-top: 0.25rem; font-size: 0.875rem; color: var(--text-primary);">{{ ca.locality or 'N/A' }}</dd>
                </div>
            </dl>
        </div>

        <!-- Technical Details -->
        <div class="card" style="padding: 0;">
            <h2 style="font-size: 1.25rem; font-weight: 600; margin-bottom: 1rem; color: var(--text-primary);">Technical Details</h2>
            <dl style="display: flex; flex-direction: column; gap: 0.75rem;">
                <div>
                    <dt style="font-size: 0.875rem; font-weight: 500; color: var(--text-secondary);">Type</dt>
                    <dd style="margin-top: 0.25rem; font-size: 0.875rem; color: var(--text-primary);">
                        {% if ca.is_root %}
                        <span class="badge" style="background: rgba(59, 130, 246, 0.1); color: var(--info-color);">Root CA</span>
                        {% else %}
                        <span class="badge badge-success">Intermediate CA</span>
                        {% endif %}
                    </dd>
                </div>
                <div>
                    <dt style="font-size: 0.875rem; font-weight: 500; color: var(--text-secondary);">Key Type</dt>
                    <dd style="margin-top: 0.25rem; font-size: 0.875rem; color: var(--text-primary); font-family: monospace;">{{ ca.key_type }}</dd>
                </div>
                <div>
                    <dt style="font-size: 0.875rem; font-weight: 500; color: var(--text-secondary);">Hash Algorithm</dt>
                    <dd style="margin-top: 0.25rem; font-size: 0.875rem; color: var(--text-primary); font-family: monospace;">{{ ca.hash_algorithm }}</dd>
                </div>
                <div>
                    <dt style="font-size: 0.875rem; font-weight: 500; color: var(--text-secondary);">Serial Number</dt>
                    <dd style="margin-top: 0.25rem; font-size: 0.875rem; color: var(--text-primary); font-family: monospace; word-break: break-all;">{{ ca.serial_number }}</dd>
                </div>
                <div>
                    <dt style="font-size: 0.875rem; font-weight: 500; color: var(--text-secondary);">Valid From</dt>
                    <dd style="margin-top: 0.25rem; font-size: 0.875rem; color: var(--text-primary);">{{ ca.not_valid_before }}</dd>
                </div>
                <div>
                    <dt style="font-size: 0.875rem; font-weight: 500; color: var(--text-secondary);">Valid Until</dt>
                    <dd style="margin-top: 0.25rem; font-size: 0.875rem; color: var(--text-primary);">{{ ca.not_valid_after }}</dd>
                </div>
            </dl>
        </div>
    </div>

    <!-- Fingerprints -->
    <div class="card" style="margin-top: 1.5rem;">
        <h2 style="font-size: 1rem; font-weight: 600; color: var(--text-primary); margin: 0; display: flex; align-items: center; gap: 0.5rem;">
            <svg class="ucm-icon" width="18" height="18"><use href="#icon-fingerprint"/></svg>
            <span>Certificate Fingerprints</span>
        </h2>
        <div hx-get="/api/ui/ca/{{ ca.id }}/fingerprints" hx-trigger="load" hx-swap="innerHTML">
            <div style="text-align: center; padding: 1rem 0;">
                <div style="display: inline-block; width: 1.5rem; height: 1.5rem; border: 2px solid var(--primary-color); border-top-color: transparent; border-radius: 50%; animation: spin 1s linear infinite;"></div>
                <p style="margin-top: 0.5rem; font-size: 0.875rem; color: var(--text-secondary);">Loading fingerprints...</p>
            </div>
        </div>
    </div>

    <!-- X.509 Extensions and Details -->
    <div class="card" style="margin-top: 1.5rem;">
        <h2 style="font-size: 1rem; font-weight: 600; color: var(--text-primary); margin: 0; display: flex; align-items: center; gap: 0.5rem;">
            <svg class="ucm-icon" width="18" height="18"><use href="#icon-award"/></svg>
            <span>X.509 Certificate Details</span>
        </h2>
        <div hx-get="/api/ui/ca/{{ ca.id }}/x509details" hx-trigger="load" hx-swap="innerHTML">
            <div style="text-align: center; padding: 1rem 0;">
                <div style="display: inline-block; width: 1.5rem; height: 1.5rem; border: 2px solid var(--primary-color); border-top-color: transparent; border-radius: 50%; animation: spin 1s linear infinite;"></div>
                <p style="margin-top: 0.5rem; font-size: 0.875rem; color: var(--text-secondary);">Loading certificate details...</p>
            </div>
        </div>
    </div>

    <!-- CRL Distribution Points Configuration -->
    <div class="card" style="margin-top: 1.5rem;">
        <div style="display: flex; justify-content: space-between; align-items: center; margin-bottom: 1rem;">
            <h2 style="font-size: 1rem; font-weight: 600; color: var(--text-primary); margin: 0; display: flex; align-items: center; gap: 0.5rem;">
                <svg class="ucm-icon" width="18" height="18"><use href="#icon-file-text"/></svg>
                <span>CRL Distribution Points (CDP)</span>
            </h2>
            <button data-action="toggle-cdp-edit" id="cdp-edit-btn" class="btn-secondary" style="padding: 0.375rem 0.75rem; font-size: 0.875rem;">
                <svg class="ucm-icon" width="16" height="16"><use href="#icon-edit"/></svg> Configure
            </button>
        </div>
        
        <div id="cdp-view-mode">
            <dl style="display: flex; flex-direction: column; gap: 0.75rem;">
                <div>
                    <dt style="font-size: 0.875rem; font-weight: 500; color: var(--text-secondary);">CDP Status</dt>
                    <dd style="margin-top: 0.25rem;">
                        {% if ca.cdp_enabled %}
                            <span class="badge badge-success">
                                <svg class="ucm-icon" width="16" height="16"><use href="#icon-check"/></svg> Enabled
                            </span>
                        {% else %}
                            <span class="badge" style="background: var(--bg-secondary); color: var(--text-secondary);">
                                <svg class="ucm-icon" width="16" height="16"><use href="#icon-times"/></svg> Disabled
                            </span>
                        {% endif %}
                    </dd>
                </div>
                {% if ca.cdp_enabled and ca.cdp_url %}
                <div>
                    <dt style="font-size: 0.875rem; font-weight: 500; color: var(--text-secondary);">CDP URL</dt>
                    <dd style="margin-top: 0.25rem; font-size: 0.875rem; color: var(--primary-color); font-family: monospace; background: rgba(59, 130, 246, 0.1); padding: 0.5rem; border-radius: 0.25rem;">
                        {{ ca.cdp_url.replace('{ca_refid}', ca.refid) }}
                    </dd>
                </div>
                <div>
                    <dt style="font-size: 0.875rem; font-weight: 500; color: var(--text-secondary);">Public Access</dt>
                    <dd style="margin-top: 0.25rem;">
                        <a href="/crl/info/{{ ca.refid }}" style="color: var(--primary-color); font-size: 0.875rem;">
                            <svg class="ucm-icon" width="16" height="16"><use href="#icon-info"/></svg> View CRL Info
                        </a>
                        <span style="margin: 0 0.5rem;">|</span>
                        <a href="/cdp/{{ ca.refid }}/crl.pem" target="_blank" style="color: var(--primary-color); font-size: 0.875rem;">
                            <svg class="ucm-icon" width="16" height="16"><use href="#icon-download"/></svg> Download CRL (PEM)
                        </a>
                        <span style="margin: 0 0.5rem;">|</span>
                        <a href="/cdp/{{ ca.refid }}/info" target="_blank" style="color: var(--primary-color); font-size: 0.875rem;">
                            <svg class="ucm-icon" width="16" height="16"><use href="#icon-external-link"/></svg> Public Link
                        </a>
                    </dd>
                </div>
                {% endif %}
            </dl>
        </div>
        
        <div id="cdp-edit-mode" class="hidden">
            <form id="cdp-form">
                <div style="display: flex; flex-direction: column; gap: 1rem;">
                    <div style="display: flex; align-items: center;">
                        <input type="checkbox" id="cdp_enabled" name="cdp_enabled" 
                               {% if ca.cdp_enabled %}checked{% endif %}
                               style="width: 1rem; height: 1rem; color: var(--primary-color); border: 1px solid var(--border-color); border-radius: 0.25rem;"
                               onchange="toggleCDPURLField()">
                        <label for="cdp_enabled" style="margin-left: 0.5rem; font-size: 0.875rem; font-weight: 500; color: var(--text-primary);">
                            Enable CRL Distribution Points
                        </label>
                    </div>
                    
                    <div id="cdp-url-field" {% if not ca.cdp_enabled %}class="hidden"{% endif %}>
                        <label for="cdp_hostname" style="display: block; font-size: 0.875rem; font-weight: 500; color: var(--text-primary);">
                            CDP Hostname
                        </label>
                        <div style="margin-top: 0.25rem; display: flex; align-items: stretch; gap: 0; max-width: 100%;">
                            <input type="text" id="cdp_hostname" name="cdp_hostname" 
                                   value="{{ request.host }}"
                                   placeholder="{{ request.host }}"
                                   style="flex: 1 1 60%; min-width: 0; border-radius: 0.375rem 0 0 0.375rem; border: 1px solid var(--border-color); border-right: none; background: var(--input-bg); color: var(--text-primary); padding: 0.5rem; font-size: 0.875rem; font-family: monospace;">
                            <span style="flex: 0 0 auto; display: flex; align-items: center; border-radius: 0 0.375rem 0.375rem 0; border: 1px solid var(--border-color); background: var(--bg-secondary); color: var(--text-secondary); padding: 0.5rem; font-size: 0.875rem; font-family: monospace; white-space: nowrap;">
                                /cdp/{{ ca.refid }}/crl.pem
                            </span>
                        </div>
                        <input type="hidden" id="cdp_url" name="cdp_url" value="">
                        <p style="margin-top: 0.25rem; font-size: 0.75rem; color: var(--text-secondary);">
                            <svg class="ucm-icon" width="16" height="16"><use href="#icon-info"/></svg>
                            Only the hostname is editable. The path <code style="background: var(--bg-secondary); padding: 0 0.25rem; border-radius: 0.125rem;">/cdp/{{ ca.refid }}/crl.pem</code> is fixed and unique to this CA.
                        </p>
                    </div>
                    
                    <div style="display: flex; gap: 0.75rem; padding-top: 0.75rem;">
                        <button type="button" data-action="save-cdp-config" class="btn-primary">
                            <svg class="ucm-icon" width="16" height="16"><use href="#icon-save"/></svg> Save Configuration
                        </button>
                        <button type="button" data-action="cancel-cdp-edit" class="btn-secondary">
                            <svg class="ucm-icon" width="16" height="16"><use href="#icon-times"/></svg> Cancel
                        </button>
                    </div>
                </div>
            </form>
        </div>
    </div>
    
    <!-- OCSP Configuration -->
    <div class="card" style="margin-top: 1.5rem;">
        <div style="display: flex; justify-content: space-between; align-items: center; margin-bottom: 1rem;">
            <h2 style="font-size: 1rem; font-weight: 600; color: var(--text-primary); margin: 0; display: flex; align-items: center; gap: 0.5rem;">
                <svg class="ucm-icon" width="18" height="18"><use href="#icon-check-circle"/></svg>
                <span>OCSP (Online Certificate Status Protocol)</span>
            </h2>
            <button data-action="toggle-ocsp-edit" id="ocsp-edit-btn" class="btn-secondary" style="padding: 0.375rem 0.75rem; font-size: 0.875rem;">
                <svg class="ucm-icon" width="16" height="16"><use href="#icon-edit"/></svg> Configure
            </button>
        </div>
        
        <div id="ocsp-view-mode">
            <dl style="display: flex; flex-direction: column; gap: 0.75rem;">
                <div>
                    <dt style="font-size: 0.875rem; font-weight: 500; color: var(--text-secondary);">OCSP Status</dt>
                    <dd style="margin-top: 0.25rem;">
                        {% if ca.ocsp_enabled %}
                            <span class="badge badge-success">
                                <svg class="ucm-icon" width="16" height="16"><use href="#icon-check"/></svg> Enabled
                            </span>
                        {% else %}
                            <span class="badge" style="background: var(--bg-secondary); color: var(--text-secondary);">
                                <svg class="ucm-icon" width="16" height="16"><use href="#icon-times"/></svg> Disabled
                            </span>
                        {% endif %}
                    </dd>
                </div>
                {% if ca.ocsp_enabled and ca.ocsp_url %}
                <div>
                    <dt style="font-size: 0.875rem; font-weight: 500; color: var(--text-secondary);">OCSP Responder URL</dt>
                    <dd style="margin-top: 0.25rem; font-size: 0.875rem; color: var(--text-primary); font-family: monospace; background: var(--bg-secondary); padding: 0.5rem; border-radius: 0.25rem;">
                        {{ ca.ocsp_url }}
                    </dd>
                </div>
                <div>
                    <dt style="font-size: 0.875rem; font-weight: 500; color: var(--text-secondary);">Test OCSP</dt>
                    <dd style="margin-top: 0.25rem;">
                        <code style="font-size: 0.75rem; background: var(--bg-secondary); padding: 0.5rem; border-radius: 0.25rem; display: block; overflow-x: auto;">
                            openssl ocsp -issuer ca.crt -cert cert.crt -url {{ ca.ocsp_url }} -text
                        </code>
                    </dd>
                </div>
                {% endif %}
            </dl>
        </div>
        
        <div id="ocsp-edit-mode" class="hidden">
            <form id="ocsp-form">
                <div style="display: flex; flex-direction: column; gap: 1rem;">
                    <div style="display: flex; align-items: center;">
                        <input type="checkbox" id="ocsp_enabled" name="ocsp_enabled" 
                               {% if ca.ocsp_enabled %}checked{% endif %}
                               style="width: 1rem; height: 1rem; color: var(--primary-color); border: 1px solid var(--border-color); border-radius: 0.25rem;"
                               onchange="toggleOCSPURLField()">
                        <label for="ocsp_enabled" style="margin-left: 0.5rem; font-size: 0.875rem; font-weight: 500; color: var(--text-primary);">
                            Enable OCSP Responder
                        </label>
                    </div>
                    
                    <div id="ocsp-url-field" {% if not ca.ocsp_enabled %}class="hidden"{% endif %}>
                        <label for="ocsp_hostname" style="display: block; font-size: 0.875rem; font-weight: 500; color: var(--text-primary);">
                            OCSP Hostname
                        </label>
                        <div style="margin-top: 0.25rem; display: flex; align-items: stretch; gap: 0; max-width: 100%;">
                            <input type="text" id="ocsp_hostname" name="ocsp_hostname" 
                                   value="{{ request.host }}"
                                   placeholder="{{ request.host }}"
                                   style="flex: 1 1 75%; min-width: 0; border-radius: 0.375rem 0 0 0.375rem; border: 1px solid var(--border-color); border-right: none; background: var(--input-bg); color: var(--text-primary); padding: 0.5rem; font-size: 0.875rem; font-family: monospace;">
                            <span style="flex: 0 0 auto; display: flex; align-items: center; border-radius: 0 0.375rem 0.375rem 0; border: 1px solid var(--border-color); background: var(--bg-secondary); color: var(--text-secondary); padding: 0.5rem; font-size: 0.875rem; font-family: monospace; white-space: nowrap;">
                                /ocsp
                            </span>
                        </div>
                        <input type="hidden" id="ocsp_url" name="ocsp_url" value="">
                        <p style="margin-top: 0.25rem; font-size: 0.75rem; color: var(--text-secondary);">
                            <svg class="ucm-icon" width="16" height="16"><use href="#icon-info"/></svg>
                            Only the hostname is editable. The path <code style="background: var(--bg-secondary); padding: 0 0.25rem; border-radius: 0.125rem;">/ocsp</code> is fixed.
                        </p>
                        <div style="margin-top: 0.5rem; background: var(--warning-bg); border: 1px solid var(--warning-border, var(--border-color)); border-radius: 0.25rem; padding: 0.75rem;">
                            <p style="font-size: 0.75rem; color: var(--warning-color, var(--text-primary));">
                                <strong><svg class="ucm-icon" width="16" height="16"><use href="#icon-alert-triangle"/></svg> Privacy Note:</strong> 
                                OCSP requests reveal which certificates are being verified. Consider using CRL for better privacy.
                            </p>
                        </div>
                    </div>
                    
                    <div style="display: flex; gap: 0.75rem; padding-top: 0.75rem;">
                        <button type="button" data-action="save-ocsp-config" class="btn-primary">
                            <svg class="ucm-icon" width="16" height="16"><use href="#icon-save"/></svg> Save Configuration
                        </button>
                        <button type="button" data-action="cancel-ocsp-edit" class="btn-secondary">
                            <svg class="ucm-icon" width="16" height="16"><use href="#icon-times"/></svg> Cancel
                        </button>
                    </div>
                </div>
            </form>
        </div>
    </div>

    <!-- Certificates issued by this CA -->
    <div class="card" style="margin-top: 1.5rem;">
        <h2 style="font-size: 1.25rem; font-weight: 600; margin-bottom: 1rem; color: var(--text-primary);">Issued Certificates</h2>
        <div hx-get="/api/ui/ca/{{ ca.id }}/certificates" hx-trigger="load" hx-target="#cert-list">
            <div id="cert-list">
                <div style="text-align: center; padding: 2rem 0;">
                    <div style="display: inline-block; width: 2rem; height: 2rem; border: 2px solid var(--primary-color); border-top-color: transparent; border-radius: 50%; animation: spin 1s linear infinite;"></div>
                    <p style="margin-top: 0.5rem; font-size: 0.875rem; color: var(--text-secondary);">Loading certificates...</p>
                </div>
            </div>
        </div>
    </div>
</div>

<!-- PKCS#12 Export Modal -->
<div id="pkcs12-modal" class="hidden" style="position: fixed; top: 64px; right: 0; bottom: 0; left: 240px; background: var(--modal-backdrop, rgba(0,0,0,0.5)); z-index: 1000;">
    <div style="display: flex; align-items: center; justify-content: center; height: 100%;">
    <div style="background: var(--card-bg); border-radius: 0.5rem; max-width: 600px; width: 100%; margin: 0 1rem; box-shadow: var(--shadow-xl);">
        <div style="padding: 1.5rem;">
            <h3 style="font-size: 1.25rem; font-weight: 600; margin-bottom: 1rem; color: var(--text-primary);">
                <svg class="ucm-icon" width="24" height="24"><use href="#icon-lock"/></svg> Export PKCS#12
            </h3>
            <p style="font-size: 0.875rem; color: var(--text-secondary); margin-bottom: 1rem;">
                PKCS#12 format includes the certificate and private key in a password-protected file (.p12 or .pfx). 
                This format is compatible with Windows, macOS, and most browsers.
            </p>
            <form autocomplete="off">
            <div style="margin-bottom: 1rem;">
                <label style="display: block; font-size: 0.875rem; font-weight: 500; color: var(--text-primary); margin-bottom: 0.5rem;">
                    Password <span style="color: var(--danger-color);">*</span>
                </label>
                <input type="password" id="pkcs12-password" 
                    style="display: block; width: 100%; padding: 0.5rem; border: 1px solid var(--border-color); border-radius: 0.375rem; background: var(--input-bg); color: var(--text-primary);"
                    placeholder="Enter password for PKCS#12 file"
                    autocomplete="new-password" />
            </div>
            <div style="margin-bottom: 1rem;">
                <label style="display: block; font-size: 0.875rem; font-weight: 500; color: var(--text-primary); margin-bottom: 0.5rem;">
                    Confirm Password <span style="color: var(--danger-color);">*</span>
                </label>
                <input type="password" id="pkcs12-password-confirm" 
                    style="display: block; width: 100%; padding: 0.5rem; border: 1px solid var(--border-color); border-radius: 0.375rem; background: var(--input-bg); color: var(--text-primary);"
                    placeholder="Confirm password"
                    autocomplete="new-password" />
            </div>
            </form>
            <div id="pkcs12-error" style="display: none; margin-bottom: 1rem; padding: 0.75rem; background: var(--danger-bg); color: var(--danger-color); border-radius: 0.25rem; font-size: 0.875rem;"></div>
            <div style="display: flex; justify-content: flex-end; gap: 0.75rem;">
                <button data-action="close-pkcs12-modal" class="btn-secondary">
                    Cancel
                </button>
                <button data-action="export-pkcs12" class="btn-primary">
                    <svg class="ucm-icon" width="16" height="16"><use href="#icon-download"/></svg> Export
                </button>
            </div>
        </div>
    </div>
    </div>
</div>

<style>
@keyframes spin {
    to { transform: rotate(360deg); }
}
</style>

<script>
if (typeof window.pkcs12ExportId === 'undefined') {
    window.pkcs12ExportId = null;
    window.pkcs12ExportType = null;
}

document.addEventListener('DOMContentLoaded', function() {
});



function toggleExportMenu() {
    const menu = document.getElementById('export-menu');
    menu.classList.toggle('hidden');
}

document.addEventListener('click', function(event) {
    const menu = document.getElementById('export-menu');
    const button = event.target.closest('button');
    if (!button || button.textContent.indexOf('Export') === -1) {
        if (!menu.classList.contains('hidden')) {
            menu.classList.add('hidden');
        }
    }
});

function exportCASimple(caId) {
    exportWithToken(`/api/v1/ca/${caId}/export/advanced?format=pem`);
}

function exportCAWithKey(caId) {
    exportWithToken(`/api/v1/ca/${caId}/export/advanced?format=pem&key=true`);
}

function exportCAWithChain(caId) {
    exportWithToken(`/api/v1/ca/${caId}/export/advanced?format=pem&chain=true`);
}

function exportCAFull(caId) {
    exportWithToken(`/api/v1/ca/${caId}/export/advanced?format=pem&key=true&chain=true`);
}

function exportCADER(caId) {
    exportWithToken(`/api/v1/ca/${caId}/export/advanced?format=der`);
}

function downloadCRL(caId) {
    exportWithToken(`/api/v1/ca/${caId}/crl`);
}

function showPKCS12Modal(id, type) {
    window.pkcs12ExportId = id;
    window.pkcs12ExportType = type;
    document.getElementById('pkcs12-password').value = '';
    document.getElementById('pkcs12-password-confirm').value = '';
    document.getElementById('pkcs12-error').style.display = 'none';
    openModal('pkcs12-modal');
}

function closePKCS12Modal() {
    closeModal('pkcs12-modal');
}

function exportPKCS12() {
    const password = document.getElementById('pkcs12-password').value;
    const confirm = document.getElementById('pkcs12-password-confirm').value;
    const errorDiv = document.getElementById('pkcs12-error');
    
    if (!password) {
        errorDiv.textContent = 'Password is required';
        errorDiv.style.display = 'block';
        return;
    }
    
    if (password !== confirm) {
        errorDiv.textContent = 'Passwords do not match';
        errorDiv.style.display = 'block';
        return;
    }
    
    if (password.length < 4) {
        errorDiv.textContent = 'Password must be at least 4 characters';
        errorDiv.style.display = 'block';
        return;
    }
    
    const url = window.window.pkcs12ExportType === 'ca' 
        ? `/api/v1/ca/${window.pkcs12ExportId}/export/advanced?format=pkcs12&password=${encodeURIComponent(password)}`
        : `/api/v1/certificates/${window.pkcs12ExportId}/export/advanced?format=pkcs12&password=${encodeURIComponent(password)}`;
    
    exportWithToken(url);
    closePKCS12Modal();
}

function exportWithToken(url) {
    const token = '{{ session.get("access_token") }}';
    fetch(url, {
        credentials: 'same-origin',
        headers: { }
    })
    .then(response => {
        if (!response.ok) throw new Error('Export failed');
        return response.blob();
    })
    .then(blob => {
        const downloadUrl = window.URL.createObjectURL(blob);
        const a = document.createElement('a');
        a.href = downloadUrl;
        a.download = '';
        document.body.appendChild(a);
        a.click();
        document.body.removeChild(a);
        window.URL.revokeObjectURL(downloadUrl);
    })
    .catch(error => {
        ucmAlert('Export failed: ' + error.message, 'Error');
    });
}

function toggleCDPEdit() {
    document.getElementById('cdp-view-mode').classList.toggle('hidden');
    document.getElementById('cdp-edit-mode').classList.toggle('hidden');
    updateCDPPreview();
}

function cancelCDPEdit() {
    toggleCDPEdit();
}

function toggleCDPURLField() {
    const enabled = document.getElementById('cdp_enabled').checked;
    const urlField = document.getElementById('cdp-url-field');
    if (enabled) {
        urlField.classList.remove('hidden');
        updateCDPPreview();
    } else {
        urlField.classList.add('hidden');
    }
}

function updateCDPPreview() {
    const urlInput = document.getElementById('cdp_url');
    const preview = document.getElementById('cdp-preview');
    if (urlInput && preview) {
        const url = urlInput.value || (DEFAULT_SERVER_URL + '/cdp/{ca_refid}/crl.pem');
        const resolved = url.replace('{ca_refid}', '{{ ca.refid }}');
        preview.textContent = resolved;
    }
}

document.addEventListener('DOMContentLoaded', function() {
    const urlInput = document.getElementById('cdp_url');
    if (urlInput) {
        urlInput.addEventListener('input', updateCDPPreview);
        // Pre-fill CDP URL if empty
        if (!urlInput.value) {
            urlInput.value = DEFAULT_SERVER_URL + '/cdp/{ca_refid}/crl.pem';
        }
        updateCDPPreview();
    }
    
    const ocspInput = document.getElementById('ocsp_url');
    if (ocspInput) {
        // Pre-fill OCSP URL if empty
        if (!ocspInput.value) {
            ocspInput.value = DEFAULT_SERVER_URL + '/ocsp';
        }
    }
});

function saveCDPConfig() {
    const enabled = document.getElementById('cdp_enabled').checked;
    const url = document.getElementById('cdp_url').value;
    
    if (enabled && !url) {
        ucmAlert('CDP URL is required when CDP is enabled', 'Error');
        return;
    }
    
    if (enabled && !url.includes('{ca_refid}')) {
        ucmAlert('CDP URL must contain {ca_refid} placeholder', 'Error');
        return;
    }
    
    const token = '{{ session.get("access_token") }}';
    const data = {
        cdp_enabled: enabled,
        cdp_url: url || null
    };
    
    fetch('/api/v1/ca/{{ ca.id }}', {
        method: 'PATCH',
        headers: {
            'Content-Type': 'application/json'
        },
        body: JSON.stringify(data)
    })
    .then(response => {
        if (!response.ok) {
            return response.json().then(err => { throw new Error(err.error || 'Update failed'); });
        }
        return response.json();
    })
    .then(() => {
        ucmAlert('CDP configuration updated successfully', 'Success');
        location.reload();
    })
    .catch(error => {
        ucmAlert('Failed to update CDP configuration: ' + error.message, 'Error');
    });
}

function toggleOCSPEdit() {
    document.getElementById('ocsp-view-mode').classList.toggle('hidden');
    document.getElementById('ocsp-edit-mode').classList.toggle('hidden');
    
    const btn = document.getElementById('ocsp-edit-btn');
    if (document.getElementById('ocsp-edit-mode').classList.contains('hidden')) {
        btn.innerHTML = '<svg class="ucm-icon" width="16" height="16"><use href="#icon-edit"/></svg> Configure';
    } else {
        btn.innerHTML = '<svg class="ucm-icon" width="16" height="16"><use href="#icon-times"/></svg> Close';
    }
}

function toggleOCSPURLField() {
    const enabled = document.getElementById('ocsp_enabled').checked;
    const urlField = document.getElementById('ocsp-url-field');
    
    if (enabled) {
        urlField.classList.remove('hidden');
    } else {
        urlField.classList.add('hidden');
    }
}

function saveOCSPConfig() {
    const enabled = document.getElementById('ocsp_enabled').checked;
    const url = document.getElementById('ocsp_url').value;
    
    if (enabled && !url) {
        ucmAlert('Please provide an OCSP Responder URL', 'Error');
        return;
    }
    
    const data = {
        ocsp_enabled: enabled,
        ocsp_url: enabled ? url : null
    };
    
    fetch(`/api/v1/ca/{{ ca.id }}`, {
        method: 'PATCH',
        headers: {
            'Content-Type': 'application/json',
            },
        body: JSON.stringify(data)
    })
    .then(response => response.json())
    .then(data => {
        if (data.message) {
            location.reload();
        } else {
            ucmAlert('Failed to update OCSP configuration', 'Error');
        }
    })
    .catch(error => {
        console.error('Error:', error);
        ucmAlert('Failed to update OCSP configuration', 'Error');
    });
}

function cancelOCSPEdit() {
    document.getElementById('ocsp_enabled').checked = {{ 'true' if ca.ocsp_enabled else 'false' }};
    document.getElementById('ocsp_url').value = '{{ ca.ocsp_url or "" }}';
    toggleOCSPURLField();
    toggleOCSPEdit();
}

// Initialize CDP hostname field and sync with hidden cdp_url field
document.addEventListener('DOMContentLoaded', function() {
    const cdpHostnameInput = document.getElementById('cdp_hostname');
    const cdpUrlHidden = document.getElementById('cdp_url');
    
    if (cdpHostnameInput && cdpUrlHidden) {
        // Extract hostname from existing cdp_url if available
        const existingUrl = '{{ ca.cdp_url or "" }}';
        if (existingUrl && existingUrl.includes('://')) {
            try {
                const url = new URL(existingUrl.replace('{ca_refid}', '{{ ca.refid }}'));
                cdpHostnameInput.value = url.protocol + '//' + url.host;
            } catch (e) {
                cdpHostnameInput.value = 'https://{{ request.host }}';
            }
        } else {
            cdpHostnameInput.value = 'https://{{ request.host }}';
        }
        
        // Update hidden field with complete URL
        updateCDPUrl();
        
        // Listen for hostname changes
        cdpHostnameInput.addEventListener('input', updateCDPUrl);
    }
    
    // Same for OCSP
    const ocspHostnameInput = document.getElementById('ocsp_hostname');
    const ocspUrlHidden = document.getElementById('ocsp_url');
    
    if (ocspHostnameInput && ocspUrlHidden) {
        // Extract hostname from existing ocsp_url if available
        const existingOcspUrl = '{{ ca.ocsp_url or "" }}';
        if (existingOcspUrl && existingOcspUrl.includes('://')) {
            try {
                const url = new URL(existingOcspUrl);
                ocspHostnameInput.value = url.protocol + '//' + url.host;
            } catch (e) {
                ocspHostnameInput.value = 'https://{{ request.host }}';
            }
        } else {
            ocspHostnameInput.value = 'https://{{ request.host }}';
        }
        
        // Update hidden field with complete URL
        updateOCSPUrl();
        
        // Listen for hostname changes
        ocspHostnameInput.addEventListener('input', updateOCSPUrl);
    }
});

function updateCDPUrl() {
    const cdpHostnameInput = document.getElementById('cdp_hostname');
    const cdpUrlHidden = document.getElementById('cdp_url');
    
    if (cdpHostnameInput && cdpUrlHidden) {
        let hostname = cdpHostnameInput.value.trim();
        
        // Add https:// if missing
        if (hostname && !hostname.match(/^https?:\/\//)) {
            hostname = 'https://' + hostname;
            cdpHostnameInput.value = hostname;
        }
        
        // Build complete URL
        const completePath = '/cdp/{{ ca.refid }}/crl.pem';
        cdpUrlHidden.value = hostname + completePath;
    }
}

function updateOCSPUrl() {
    const ocspHostnameInput = document.getElementById('ocsp_hostname');
    const ocspUrlHidden = document.getElementById('ocsp_url');
    
    if (ocspHostnameInput && ocspUrlHidden) {
        let hostname = ocspHostnameInput.value.trim();
        
        // Add https:// if missing
        if (hostname && !hostname.match(/^https?:\/\//)) {
            hostname = 'https://' + hostname;
            ocspHostnameInput.value = hostname;
        }
        
        // Build complete URL
        ocspUrlHidden.value = hostname + '/ocsp';
    }
}
</script>
{% endblock %}

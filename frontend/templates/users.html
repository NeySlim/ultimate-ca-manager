{% extends "base.html" %}

{% block title %}Users - Ultimate CA Manager{% endblock %}

{% block content %}
<div class="container">
    <div style="display: flex; justify-content: space-between; align-items: center; margin-bottom: 24px;">
        <div>
            <h1 style="font-size: 1.875rem; font-weight: 600; color: var(--text-primary); margin-bottom: 4px; display: flex; align-items: center; gap: 0.5rem;">
                <svg class="ucm-icon" width="24" height="24"><use href="#icon-users"/></svg>
                <span>Users</span>
            </h1>
            <p style="color: var(--text-secondary); font-size: 14px;">Manage user accounts and permissions</p>
        </div>
        <button data-action="open-add-user-modal" class="btn-primary">
            <svg class="ucm-icon" width="16" height="16"><use href="#icon-plus"/></svg>
            <span>Add User</span>
        </button>
    </div>
    
    <!-- Users Table -->
    <div class="card" style="padding: 0;">
        <div>
            <div id="users-container"
                 hx-get="/api/ui/config/users" 
                 hx-trigger="load, refreshUsers from:body"
                 hx-swap="innerHTML">
                <div style="padding: 60px; text-align: center;">
                    <svg class="ucm-icon icon-spin" width="20" height="20"><use href="#icon-spinner"/></svg>
                    <p style="margin-top: 12px; color: var(--text-secondary);">Loading users...</p>
                </div>
            </div>
        </div>
    </div>
</div>

<!-- Add User Modal -->
<div id="addUserModal" class="hidden" style="position: fixed; top: 64px; right: 0; bottom: 0; left: 240px; background: var(--modal-backdrop, rgba(0,0,0,0.5)); z-index: 1000; padding: 1rem;">
    <div style="display: flex; align-items: center; justify-content: center; height: 100%;">
        <div style="background: var(--card-bg); border-radius: 0.5rem; max-width: 600px; width: 100%; box-shadow: 0 25px 50px -12px rgba(0,0,0,0.25);">
            <div class="card-header">
                <div style="display: flex; justify-content: space-between; align-items: center;">
                    <h2 style="font-size: 1.5rem; font-weight: bold; color: var(--text-primary); display: flex; align-items: center; gap: 0.5rem;">
                        <svg class="ucm-icon" width="24" height="24"><use href="#icon-user-plus"/></svg>
                        <span>Add User</span>
                    </h2>
                    <button data-action="close-add-user-modal" style="color: var(--text-secondary); cursor: pointer; background: none; border: none;">
                        <svg class="ucm-icon" width="20" height="20"><use href="#icon-times"/></svg>
                    </button>
                </div>
            </div>
            
            <form hx-post="/api/ui/config/add-user"
                  hx-trigger="submit"
                  hx-disabled-elt="find button[type='submit']"
                  hx-on::after-request="if(event.detail.successful){closeAddUserModal();htmx.trigger('body','refreshUsers');if(typeof showToast==='function')showToast('User created successfully','success');}">
                <div style="padding: 1.5rem;">
                    
                    <div style="margin-bottom: 1rem;">
                        <label class="modal-form-label">
                            Username <span style="color: var(--danger-color);">*</span>
                        </label>
                        <input type="text" name="username" required 
                               placeholder="john.doe"
                               class="modal-form-input">
                    </div>
                    
                    <div style="margin-bottom: 1rem;">
                        <label class="modal-form-label">
                            Email <span style="color: var(--danger-color);">*</span>
                        </label>
                        <input type="email" name="email" required 
                               placeholder="john.doe@example.com"
                               class="modal-form-input">
                    </div>
                    
                    <div style="margin-bottom: 1rem;">
                        <label class="modal-form-label">
                            Password <span style="color: var(--danger-color);">*</span>
                        </label>
                        <input type="password" name="password" required 
                               minlength="8"
                               placeholder="Min. 8 characters"
                               class="modal-form-input">
                    </div>
                    
                    <div style="margin-bottom: 1rem;">
                        <label class="modal-form-label">
                            Role <span style="color: var(--danger-color);">*</span>
                        </label>
                        <select name="role" required class="modal-form-input">
                            <option value="viewer">Viewer</option>
                            <option value="operator">Operator</option>
                            <option value="admin">Administrator</option>
                        </select>
                    </div>
                    
                </div>
                
                <div class="modal-form-footer">
                    <button type="button" data-action="close-add-user-modal"
                            class="btn-secondary">
                        Cancel
                    </button>
                    <button type="submit"
                            class="btn-primary">
                        <svg class="ucm-icon" width="16" height="16"><use href="#icon-user-plus"/></svg> Create User
                    </button>
                </div>
            </form>
        </div>
    </div>
</div>

<!-- Change Password Modal -->
<div id="changePasswordModal" class="hidden" style="position: fixed; top: 64px; right: 0; bottom: 0; left: 240px; background: var(--modal-backdrop, rgba(0,0,0,0.5)); z-index: 1000; padding: 1rem;">
    <div style="display: flex; align-items: center; justify-content: center; height: 100%;">
        <div style="background: var(--card-bg); border-radius: 0.5rem; max-width: 500px; width: 100%; box-shadow: 0 25px 50px -12px rgba(0,0,0,0.25);">
            <div class="card-header">
                <div style="display: flex; justify-content: space-between; align-items: center;">
                    <h2 style="font-size: 1.5rem; font-weight: bold; color: var(--text-primary); display: flex; align-items: center; gap: 0.5rem;">
                        <svg class="ucm-icon" width="24" height="24"><use href="#icon-key"/></svg>
                        <span>Change Password</span>
                    </h2>
                    <button data-action="close-change-password-modal" style="color: var(--text-secondary); cursor: pointer; background: none; border: none;">
                        <svg class="ucm-icon" width="20" height="20"><use href="#icon-times"/></svg>
                    </button>
                </div>
                <p id="change-password-username" style="margin-top: 0.5rem; color: var(--text-secondary); font-size: 0.875rem;"></p>
            </div>
            
            <form hx-post="/api/ui/config/change-password"
                  hx-trigger="submit"
                  hx-disabled-elt="find button[type='submit']"
                  hx-on::after-request="if(event.detail.successful){{window.closeModal('changePasswordModal');if(typeof showToast==='function')showToast('Password changed successfully','success');}}">>
                <input type="hidden" id="change-password-user-id" name="user_id">
                
                <div style="padding: 1.5rem;">
                    <div style="margin-bottom: 1rem;">
                        <label class="modal-form-label">
                            New Password <span style="color: var(--danger-color);">*</span>
                        </label>
                        <input type="password" name="new_password" id="new-password-input" required 
                               minlength="8"
                               placeholder="Min. 8 characters"
                               class="modal-form-input">
                        <div id="password-strength" style="margin-top: 0.5rem; font-size: 0.75rem; display: none;">
                            <div style="display: flex; gap: 0.25rem; margin-bottom: 0.25rem;">
                                <div class="strength-bar"></div>
                                <div class="strength-bar"></div>
                                <div class="strength-bar"></div>
                                <div class="strength-bar"></div>
                            </div>
                            <div id="password-requirements" style="color: var(--text-secondary); line-height: 1.5;">
                                <div id="req-length">✗ At least 8 characters</div>
                                <div id="req-uppercase">✗ At least 1 uppercase letter</div>
                                <div id="req-lowercase">✗ At least 1 lowercase letter</div>
                                <div id="req-number">✗ At least 1 number</div>
                                <div id="req-special">✗ At least 1 special character</div>
                            </div>
                        </div>
                    </div>
                    
                    <div style="margin-bottom: 1rem;">
                        <label class="modal-form-label">
                            Confirm Password <span style="color: var(--danger-color);">*</span>
                        </label>
                        <input type="password" name="confirm_password" id="confirm-password-input" required 
                               minlength="8"
                               placeholder="Confirm new password"
                               class="modal-form-input">
                        <div id="password-match" style="margin-top: 0.5rem; font-size: 0.75rem; display: none;"></div>
                    </div>
                </div>
                
                <style>
                .strength-bar {
                    flex: 1;
                    height: 4px;
                    background: var(--border-color);
                    border-radius: 2px;
                    transition: background 0.3s;
                }
                .strength-bar.active-weak { background: var(--danger-color); }
                .strength-bar.active-medium { background: var(--warning-color); }
                .strength-bar.active-strong { background: var(--success-color); }
                #password-requirements div { transition: color 0.2s; }
                #password-requirements div.valid { color: var(--success-color); }
                #password-requirements div.valid::before { content: '✓ '; }
                </style>
                
                <script>
                (function() {
                    const passwordInput = document.getElementById('new-password-input');
                    const confirmInput = document.getElementById('confirm-password-input');
                    const strengthDiv = document.getElementById('password-strength');
                    const matchDiv = document.getElementById('password-match');
                    
                    function checkPassword(password) {
                        const checks = {
                            length: password.length >= 8,
                            uppercase: /[A-Z]/.test(password),
                            lowercase: /[a-z]/.test(password),
                            number: /[0-9]/.test(password),
                            special: /[!@#$%^&*(),.?":{{}}|<>]/.test(password)
                        };
                        
                        // Update requirements
                        document.getElementById('req-length').className = checks.length ? 'valid' : '';
                        document.getElementById('req-uppercase').className = checks.uppercase ? 'valid' : '';
                        document.getElementById('req-lowercase').className = checks.lowercase ? 'valid' : '';
                        document.getElementById('req-number').className = checks.number ? 'valid' : '';
                        document.getElementById('req-special').className = checks.special ? 'valid' : '';
                        
                        // Calculate strength
                        const score = Object.values(checks).filter(Boolean).length;
                        const bars = document.querySelectorAll('.strength-bar');
                        bars.forEach((bar, i) => {{
                            bar.className = 'strength-bar';
                            if (i < score) {{
                                if (score <= 2) bar.classList.add('active-weak');
                                else if (score <= 4) bar.classList.add('active-medium');
                                else bar.classList.add('active-strong');
                            }}
                        }});
                        
                        return checks;
                    }
                    
                    passwordInput.addEventListener('input', function() {{
                        if (this.value) {{
                            strengthDiv.style.display = 'block';
                            checkPassword(this.value);
                        }} else {{
                            strengthDiv.style.display = 'none';
                        }}
                        
                        // Check match
                        if (confirmInput.value) {{
                            checkMatch();
                        }}
                    }});
                    
                    function checkMatch() {{
                        if (confirmInput.value) {{
                            matchDiv.style.display = 'block';
                            if (passwordInput.value === confirmInput.value) {{
                                matchDiv.innerHTML = '<span style="color: var(--success-color);">✓ Passwords match</span>';
                            }} else {{
                                matchDiv.innerHTML = '<span style="color: var(--danger-color);">✗ Passwords do not match</span>';
                            }}
                        }} else {{
                            matchDiv.style.display = 'none';
                        }}
                    }}
                    
                    confirmInput.addEventListener('input', checkMatch);
                }})();
                </script>
                
                <div class="modal-form-footer">
                    <button type="button" data-action="close-change-password-modal"
                            class="btn-secondary">
                        Cancel
                    </button>
                    <button type="submit"
                            class="btn-primary">
                        <svg class="ucm-icon" width="16" height="16"><use href="#icon-key"/></svg> Change Password
                    </button>
                </div>
            </form>
        </div>
    </div>
</div>

<!-- Change Role Modal -->
<div id="changeRoleModal" class="hidden" style="position: fixed; top: 64px; right: 0; bottom: 0; left: 240px; background: var(--modal-backdrop, rgba(0,0,0,0.5)); z-index: 1000; padding: 1rem;">
    <div style="display: flex; align-items: center; justify-content: center; height: 100%;">
        <div style="background: var(--card-bg); border-radius: 0.5rem; max-width: 450px; width: 100%; box-shadow: 0 25px 50px -12px rgba(0,0,0,0.25);">
            <div class="card-header">
                <div style="display: flex; justify-content: space-between; align-items: center;">
                    <h2 style="font-size: 1.5rem; font-weight: bold; color: var(--text-primary); display: flex; align-items: center; gap: 0.5rem;">
                        <svg class="ucm-icon" width="24" height="24"><use href="#icon-shield-check"/></svg>
                        <span>Change Role</span>
                    </h2>
                    <button data-action="close-change-role-modal" style="color: var(--text-secondary); cursor: pointer; background: none; border: none;">
                        <svg class="ucm-icon" width="20" height="20"><use href="#icon-times"/></svg>
                    </button>
                </div>
                <p id="change-role-username" style="margin-top: 0.5rem; color: var(--text-secondary); font-size: 0.875rem;"></p>
            </div>
            
            <form hx-post="/api/ui/config/change-role"
                  hx-trigger="submit"
                  hx-disabled-elt="find button[type='submit']"
                  hx-on::after-request="if(event.detail.successful){{window.closeModal('changeRoleModal');htmx.trigger('body','refreshUsers');if(typeof showToast==='function')showToast('Role changed successfully','success');}}">>
                <input type="hidden" id="change-role-user-id" name="user_id">
                
                <div style="padding: 1.5rem;">
                    <label class="modal-form-label">
                        Select New Role <span style="color: var(--danger-color);">*</span>
                    </label>
                    
                    <div id="role-options" style="display: flex; flex-direction: column; gap: 0.75rem; margin-top: 0.5rem;">
                        <!-- Role options will be populated by JavaScript -->
                    </div>
                </div>
                
                <div class="modal-form-footer">
                    <button type="button" data-action="close-change-role-modal"
                            class="btn-secondary">
                        Cancel
                    </button>
                    <button type="submit"
                            class="btn-primary">
                        <svg class="ucm-icon" width="16" height="16"><use href="#icon-check-circle"/></svg> Change Role
                    </button>
                </div>
            </form>
        </div>
    </div>
</div>

<style>
.htmx-indicator {
    display: none;
}
.htmx-request .htmx-indicator {
    display: block;
}
.htmx-request.htmx-indicator {
    display: block;
}
.role-option {
    display: flex;
    align-items: center;
    padding: 0.75rem;
    border: 2px solid var(--border-color);
    border-radius: 0.5rem;
    cursor: pointer;
    transition: all 0.2s;
}
.role-option:hover {
    border-color: var(--primary-color);
    background: var(--bg-secondary);
}
.role-option input[type="radio"] {
    margin-right: 0.75rem;
    width: 1.25rem;
    height: 1.25rem;
    cursor: pointer;
}
</style>
{% endblock %}

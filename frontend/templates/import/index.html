{% extends "base.html" %}

{% block title %}Import Certificates - UCM{% endblock %}

{% block content %}
<div style="display: flex; flex-direction: column; gap: 1.5rem;">
    <!-- Page Header -->
    <div style="display: flex; justify-content: space-between; align-items: center;">
        <div>
            <h1 style="font-size: 1.875rem; font-weight: 600; color: var(--text-primary); margin: 0; display: flex; align-items: center; gap: 0.5rem;">
                <svg class="ucm-icon" width="24" height="24"><use href="#icon-file-import"/></svg>
                <span>Import Certificates</span>
            </h1>
            <p style="font-size: 0.875rem; color: var(--text-secondary); margin: 4px 0 0 0;">Import certificates from various sources</p>
        </div>
    </div>
    
    <!-- Manual Import Section -->
    <div class="card">
        <div class="card-header">
            <h2 style="font-size: 1rem; font-weight: 600; color: var(--text-primary); margin: 0; display: flex; align-items: center; gap: 0.5rem;">
                <svg class="ucm-icon" width="18" height="18"><use href="#icon-upload"/></svg>
                <span>Manual Certificate Import</span>
            </h2>
        </div>
        <div class="card-body">
            <p style="font-size: 0.875rem; color: var(--text-secondary); margin-bottom: 1rem;">
                Import a certificate and its private key by uploading files or pasting PEM content.
            </p>
            
            <form id="manual-import-form" style="display: grid; gap: 20px;">
                <!-- Import Method Tabs -->
                <div class="tabs-container">
                    <button type="button" class="tab-button active" onclick="switchImportMethod('paste')">
                        <svg class="ucm-icon" width="20" height="20"><use href="#icon-file-import"/></svg>
                        <span>Paste Content</span>
                    </button>
                    <button type="button" class="tab-button" onclick="switchImportMethod('upload')">
                        <svg class="ucm-icon" width="20" height="20"><use href="#icon-upload"/></svg>
                        <span>Upload Files</span>
                    </button>
                    <button type="button" class="tab-button" onclick="switchImportMethod('container')">
                        <svg class="ucm-icon" width="20" height="20"><use href="#icon-archive"/></svg>
                        <span>Container File</span>
                    </button>
                </div>
                
                <!-- Paste Method -->
                <div id="paste-method" style="display: grid; gap: 16px;">
                    <div>
                        <label class="modal-form-label">Certificate (PEM format) <span style="color: var(--status-danger);">*</span></label>
                        <textarea id="cert-paste" rows="8" placeholder="-----BEGIN CERTIFICATE-----&#10;...&#10;-----END CERTIFICATE-----" 
                                  class="modal-form-input" style="font-family: monospace; font-size: 12px;"></textarea>
                    </div>
                    <div>
                        <label class="modal-form-label">Private Key (PEM format) <span style="color: var(--status-danger);">*</span></label>
                        <textarea id="key-paste" rows="8" placeholder="-----BEGIN PRIVATE KEY-----&#10;...&#10;-----END PRIVATE KEY-----" 
                                  class="modal-form-input" style="font-family: monospace; font-size: 12px;"></textarea>
                    </div>
                    <div>
                        <label class="modal-form-label">Certificate Chain (Optional)</label>
                        <textarea id="chain-paste" rows="6" placeholder="-----BEGIN CERTIFICATE-----&#10;...intermediate CA...&#10;-----END CERTIFICATE-----" 
                                  class="modal-form-input" style="font-family: monospace; font-size: 12px;"></textarea>
                        <p style="font-size: 12px; color: var(--text-secondary); margin-top: 4px;">Include intermediate and root CA certificates if needed</p>
                    </div>
                </div>
                
                <!-- Upload Method -->
                <div id="upload-method" style="display: none; grid-template-columns: 1fr 1fr; gap: 16px;">
                    <div>
                        <label class="modal-form-label">Certificate File (.crt, .pem, .cer) <span style="color: var(--status-danger);">*</span></label>
                        <input type="file" id="cert-file" accept=".crt,.pem,.cer,.der" class="modal-form-input" style="padding: 8px;">
                    </div>
                    <div>
                        <label class="modal-form-label">Private Key File (.key, .pem) <span style="color: var(--status-danger);">*</span></label>
                        <input type="file" id="key-file" accept=".key,.pem" class="modal-form-input" style="padding: 8px;">
                    </div>
                    <div style="grid-column: 1 / -1;">
                        <label class="modal-form-label">Certificate Chain File (Optional)</label>
                        <input type="file" id="chain-file" accept=".crt,.pem,.cer,.ca-bundle" class="modal-form-input" style="padding: 8px;">
                        <p style="font-size: 12px; color: var(--text-secondary); margin-top: 4px;">CA bundle or intermediate certificates</p>
                    </div>
                </div>
                
                <!-- Container Method -->
                <div id="container-method" style="display: none; gap: 16px;">
                    <div>
                        <label class="modal-form-label">Container Format</label>
                        <select id="container-format" class="modal-form-input">
                            <option value="auto">Auto-detect</option>
                            <option value="pkcs12">PKCS#12 (.p12, .pfx)</option>
                            <option value="pkcs7">PKCS#7 (.p7b, .p7c)</option>
                            <option value="jks">Java KeyStore (.jks)</option>
                            <option value="der">DER Binary (.der)</option>
                        </select>
                    </div>
                    <div>
                        <label class="modal-form-label">Container File <span style="color: var(--status-danger);">*</span></label>
                        <input type="file" id="container-file" accept=".p12,.pfx,.p7b,.p7c,.jks,.der" class="modal-form-input" style="padding: 8px;">
                        <p style="font-size: 12px; color: var(--text-secondary); margin-top: 4px;">
                            Supported: PKCS#12 (P12/PFX), PKCS#7 (P7B), Java KeyStore (JKS), DER binary
                        </p>
                    </div>
                    <div>
                        <label class="modal-form-label">Container Password</label>
                        <input type="password" id="container-password" placeholder="Password (if encrypted)" class="modal-form-input">
                        <p style="font-size: 12px; color: var(--text-secondary); margin-top: 4px;">Required for encrypted PKCS#12/JKS files</p>
                    </div>
                </div>
                
                <!-- Common Fields -->
                <div style="display: grid; grid-template-columns: 1fr 1fr; gap: 16px;">
                    <div>
                        <label class="modal-form-label">Description</label>
                        <input type="text" id="cert-description" placeholder="My imported certificate" class="modal-form-input">
                    </div>
                    <div>
                        <label class="modal-form-label">Private Key Password (if encrypted)</label>
                        <input type="password" id="key-password" placeholder="Optional" class="modal-form-input">
                    </div>
                </div>
                
                <div style="display: flex; gap: 12px;">
                    <button type="button" onclick="importManualCertificate()" class="btn-primary">
                        <svg class="ucm-icon" width="16" height="16"><use href="#icon-check-circle"/></svg> Import Certificate
                    </button>
                    <button type="button" onclick="clearManualForm()" class="btn-secondary">
                        <svg class="ucm-icon" width="16" height="16"><use href="#icon-x-circle"/></svg> Clear
                    </button>
                </div>
                
                <div id="manual-import-status" style="display: none;"></div>
            </form>
        </div>
    </div>
    
    <!-- OPNsense Import Section -->
    <div class="card">
        <div class="card-header">
            <h2 style="font-size: 1rem; font-weight: 600; color: var(--text-primary); margin: 0; display: flex; align-items: center; gap: 0.5rem;">
                <svg class="ucm-icon" width="18" height="18"><use href="#icon-database"/></svg>
                <span>OPNsense Import</span>
            </h2>
        </div>
        <div class="card-body"
             hx-get="/api/ui/import/config-form"
             hx-trigger="load"
             hx-swap="innerHTML">
            <div style="height: 10rem; background: var(--bg-secondary); border-radius: 0.375rem; animation: pulse 2s infinite;"></div>
        </div>
    </div>
    
    <!-- Last OPNsense Import History -->
    <div class="card">
        <div class="card-header">
            <h2 style="font-size: 1rem; font-weight: 600; color: var(--text-primary); margin: 0; display: flex; align-items: center; gap: 0.5rem;">
                <svg class="ucm-icon" width="18" height="18"><use href="#icon-clock"/></svg>
                <span>Last OPNsense Import History</span>
            </h2>
        </div>
        <div hx-get="/api/ui/import/history"
             hx-trigger="load"
             hx-swap="innerHTML">
            <div style="padding: 2rem;"><div style="height: 5rem; background: var(--bg-secondary); border-radius: 0.375rem; animation: pulse 2s infinite;"></div></div>
        </div>
    </div>
</div>

<script>
function switchImportMethod(method) {
    // Update tabs
    document.querySelectorAll('.tab-button').forEach(btn => {
        btn.classList.remove('active');
        btn.style.borderBottomColor = 'transparent';
        btn.style.color = 'var(--text-secondary)';
    });
    event.target.closest('.tab-button').classList.add('active');
    event.target.closest('.tab-button').style.borderBottomColor = 'var(--primary-color)';
    event.target.closest('.tab-button').style.color = 'var(--primary-color)';
    
    // Hide all methods
    document.getElementById('paste-method').style.display = 'none';
    document.getElementById('upload-method').style.display = 'none';
    document.getElementById('container-method').style.display = 'none';
    
    // Show selected method
    if (method === 'paste') {
        document.getElementById('paste-method').style.display = 'grid';
    } else if (method === 'upload') {
        document.getElementById('upload-method').style.display = 'grid';
    } else if (method === 'container') {
        document.getElementById('container-method').style.display = 'grid';
    }
}

async function importManualCertificate() {
    const statusDiv = document.getElementById('manual-import-status');
    let method = 'paste';
    
    if (document.getElementById('upload-method').style.display !== 'none') {
        method = 'upload';
    } else if (document.getElementById('container-method').style.display !== 'none') {
        method = 'container';
    }
    
    let certContent, keyContent, chainContent, containerData;
    
    try {
        if (method === 'paste') {
            certContent = document.getElementById('cert-paste').value.trim();
            keyContent = document.getElementById('key-paste').value.trim();
            chainContent = document.getElementById('chain-paste').value.trim();
            
            if (!certContent || !keyContent) {
                showStatus(statusDiv, 'Please provide both certificate and private key', 'error');
                return;
            }
        } else if (method === 'upload') {
            const certFile = document.getElementById('cert-file').files[0];
            const keyFile = document.getElementById('key-file').files[0];
            const chainFile = document.getElementById('chain-file').files[0];
            
            if (!certFile || !keyFile) {
                showStatus(statusDiv, 'Please select both certificate and key files', 'error');
                return;
            }
            
            certContent = await certFile.text();
            keyContent = await keyFile.text();
            if (chainFile) {
                chainContent = await chainFile.text();
            }
        } else if (method === 'container') {
            const containerFile = document.getElementById('container-file').files[0];
            
            if (!containerFile) {
                showStatus(statusDiv, 'Please select a container file', 'error');
                return;
            }
            
            // Read as base64 for binary formats
            const reader = new FileReader();
            containerData = await new Promise((resolve, reject) => {
                reader.onload = (e) => resolve(e.target.result.split(',')[1]);
                reader.onerror = reject;
                reader.readAsDataURL(containerFile);
            });
        }
        
        const formData = {
            import_method: method,
            description: document.getElementById('cert-description').value,
            key_password: document.getElementById('key-password').value
        };
        
        if (method === 'container') {
            formData.container_data = containerData;
            formData.container_format = document.getElementById('container-format').value;
            formData.container_password = document.getElementById('container-password').value;
        } else {
            formData.certificate = certContent;
            formData.private_key = keyContent;
            if (chainContent) {
                formData.certificate_chain = chainContent;
            }
        }
        
        showStatus(statusDiv, 'Importing certificate...', 'info');
        
        const response = await fetch('/api/ui/certificates/import', {
            method: 'POST',
            headers: {
                'Content-Type': 'application/json'
            },
            body: JSON.stringify(formData)
        });
        
        const result = await response.json();
        
        if (response.ok) {
            showStatus(statusDiv, '✓ Certificate imported successfully!', 'success');
            setTimeout(() => {
                window.location.href = '/certificates';
            }, 1500);
        } else {
            showStatus(statusDiv, '✗ Import failed: ' + (result.error || result.message || 'Unknown error'), 'error');
        }
    } catch (error) {
        showStatus(statusDiv, '✗ Import failed: ' + error.message, 'error');
    }
}

function clearManualForm() {
    document.getElementById('cert-paste').value = '';
    document.getElementById('key-paste').value = '';
    document.getElementById('chain-paste').value = '';
    document.getElementById('cert-file').value = '';
    document.getElementById('key-file').value = '';
    document.getElementById('chain-file').value = '';
    document.getElementById('container-file').value = '';
    document.getElementById('container-format').value = 'auto';
    document.getElementById('container-password').value = '';
    document.getElementById('cert-description').value = '';
    document.getElementById('key-password').value = '';
    document.getElementById('manual-import-status').style.display = 'none';
}

function showStatus(element, message, type) {
    element.className = 'p-4 rounded-lg ' + (
        type === 'success' ? 'bg-green-50 text-green-800 border border-green-200' :
        type === 'error' ? 'bg-red-50 text-red-800 border border-red-200' :
        'bg-blue-50 text-blue-800 border border-blue-200'
    );
    element.textContent = message;
    element.style.display = 'block';
}

// Initialize first tab
document.addEventListener('DOMContentLoaded', function() {
    const firstTab = document.querySelector('.tab-button.active');
    if (firstTab) {
        firstTab.style.borderBottomColor = 'var(--primary-color)';
        firstTab.style.color = 'var(--primary-color)';
    }
});
</script>

<style>
.tab-button.active {
    font-weight: 600;
}
</style>
{% endblock %}

{% extends "base.html" %}

{% block title %}Certificate Templates - UCM{% endblock %}

{% block content %}
<div style="display: flex; flex-direction: column; gap: 1.5rem;">
    <!-- Header -->
    <div style="display: flex; justify-content: space-between; align-items: center;">
        <h1 style="font-size: 1.875rem; font-weight: 600; color: var(--text-primary); margin: 0; display: flex; align-items: center; gap: 0.5rem;">
            <svg class="ucm-icon" width="28" height="28"><use href="#icon-file"/></svg>
            Certificate Templates
        </h1>
        {% if session.get('role') == 'admin' %}
        <button onclick="openModal('createTemplateModal')" class="btn-primary">
            <svg class="ucm-icon" width="16" height="16"><use href="#icon-plus"/></svg>
            Create Template
        </button>
        {% endif %}
    </div>

    <!-- Stats Cards -->
    <div id="templates-stats" 
         style="display: grid; grid-template-columns: repeat(auto-fit, minmax(200px, 1fr)); gap: 1rem;"
         hx-get="/api/ui/templates/stats" 
         hx-trigger="load, refreshTemplates from:body"
         hx-swap="innerHTML">
        <div class="stats-card skeleton"></div>
    </div>

    <!-- Templates List -->
    <div class="card" style="padding: 1.5rem;">
        <div id="templates-list"
             hx-get="/api/ui/templates/list"
             hx-trigger="load, refreshTemplates from:body"
             hx-swap="innerHTML">
            <div style="text-align: center; padding: 3rem;">
                <p style="color: var(--text-secondary);">Loading...</p>
            </div>
        </div>
    </div>
</div>

<!-- View Template Modal (Custom HTML) - View only, overlay can close -->
<div id="viewTemplateModal" class="hidden" style="position: fixed; inset: 0; background: rgba(0,0,0,0.5); display: flex; align-items: center; justify-content: center; z-index: 1000;">
    <div onclick="event.stopPropagation()" style="background: var(--card-bg); border-radius: 8px; max-width: 700px; width: 90%; max-height: 90vh; overflow: hidden; box-shadow: 0 25px 50px -12px rgba(0,0,0,0.25);">
        <div style="padding: 1.5rem; border-bottom: 1px solid var(--border-color); display: flex; justify-content: space-between; align-items: center;">
            <h2 style="font-size: 1.5rem; font-weight: 600; color: var(--text-primary); margin: 0;">Template Details</h2>
            <button onclick="closeModal('viewTemplateModal')" style="background: none; border: none; cursor: pointer; color: var(--text-secondary); padding: 0.25rem;">
                <svg class="ucm-icon" width="20" height="20"><use href="#icon-times"/></svg>
            </button>
        </div>
        <div id="viewTemplateContent" style="padding: 1.5rem; overflow-y: auto; max-height: calc(90vh - 100px);">
            <svg class="ucm-icon icon-spin" width="24" height="24"><use href="#icon-spinner"/></svg>
        </div>
    </div>
</div>

<!-- Create/Edit Template Modal - Has form, no overlay close -->
<div id="createTemplateModal" class="hidden" style="position: fixed; inset: 0; background: rgba(0,0,0,0.5); display: flex; align-items: center; justify-content: center; z-index: 1000;">
    <div onclick="event.stopPropagation()" style="background: var(--card-bg); border-radius: 8px; max-width: 800px; width: 90%; max-height: 90vh; overflow: hidden; box-shadow: 0 25px 50px -12px rgba(0,0,0,0.25);">
        <div style="padding: 1.5rem; border-bottom: 1px solid var(--border-color); display: flex; justify-content: space-between; align-items: center;">
            <h2 id="createModalTitle" style="font-size: 1.5rem; font-weight: 600; color: var(--text-primary); margin: 0;">Create Template</h2>
            <button onclick="closeModal('createTemplateModal', true)" style="background: none; border: none; cursor: pointer; color: var(--text-secondary); padding: 0.25rem;">
                <svg class="ucm-icon" width="20" height="20"><use href="#icon-times"/></svg>
            </button>
        </div>
        <div style="padding: 1.5rem; overflow-y: auto; max-height: calc(90vh - 180px);">
            <p style="color: var(--text-secondary); font-size: 0.875rem; margin-bottom: 1.5rem;">
                <svg class="ucm-icon" width="16" height="16" style="vertical-align: middle; margin-right: 0.25rem;"><use href="#icon-info-circle"/></svg>
                Create/edit modal will be implemented in the next phase when templates are integrated with certificate creation.
            </p>
            <div style="padding: 2rem; background: var(--bg-secondary); border-radius: 6px; text-align: center;">
                <svg class="ucm-icon" width="48" height="48" style="opacity: 0.3; margin-bottom: 1rem;"><use href="#icon-plus"/></svg>
                <p style="color: var(--text-secondary);">Coming soon in Phase 2</p>
            </div>
        </div>
        <div style="padding: 1.5rem; border-top: 1px solid var(--border-color); display: flex; justify-content: flex-end; gap: 0.75rem;">
            <button onclick="closeModal('createTemplateModal', true)" class="btn-secondary">Close</button>
        </div>
    </div>
</div>

<script>
function viewTemplateDetail(id) {
    openModal('viewTemplateModal'); // View-only, overlay closes automatically
    document.getElementById('viewTemplateContent').innerHTML = '<svg class="ucm-icon icon-spin" width="24" height="24"><use href="#icon-spinner"/></svg>';
    
    fetch('/api/v1/templates/' + id)
        .then(r => r.json())
        .then(t => {
            // Format DN template nicely
            const dnEntries = Object.entries(t.dn_template)
                .filter(([k, v]) => v && v.trim())
                .map(([k, v]) => `<div><strong>${k}:</strong> ${escapeHtml(v)}</div>`)
                .join('');
            
            // Format extensions nicely
            const ku = t.extensions_template.key_usage || [];
            const eku = t.extensions_template.extended_key_usage || [];
            const san = t.extensions_template.san_types || [];
            
            const html = `
                <div style="display: flex; flex-direction: column; gap: 1.5rem;">
                    <!-- Header -->
                    <div>
                        <div style="display: flex; align-items: center; gap: 0.5rem; margin-bottom: 0.5rem;">
                            <h3 style="font-size: 1.25rem; font-weight: 600; color: var(--text-primary); margin: 0;">${escapeHtml(t.name)}</h3>
                            <span style="padding: 0.125rem 0.5rem; background: ${t.is_system ? 'var(--info-color)' : 'var(--success-color)'}20; color: ${t.is_system ? 'var(--info-color)' : 'var(--success-color)'}; border-radius: 4px; font-size: 0.75rem; font-weight: 500;">
                                ${t.is_system ? 'System' : 'Custom'}
                            </span>
                        </div>
                        ${t.description ? `<p style="color: var(--text-secondary); font-size: 0.875rem; margin: 0;">${escapeHtml(t.description)}</p>` : ''}
                    </div>

                    <!-- Configuration -->
                    <div style="display: grid; grid-template-columns: repeat(2, 1fr); gap: 1rem; padding: 1rem; background: var(--bg-secondary); border-radius: 6px;">
                        <div>
                            <div style="font-size: 0.75rem; color: var(--text-secondary); margin-bottom: 0.25rem;">Type</div>
                            <div style="font-weight: 500; color: var(--text-primary);">${escapeHtml(t.template_type)}</div>
                        </div>
                        <div>
                            <div style="font-size: 0.75rem; color: var(--text-secondary); margin-bottom: 0.25rem;">Key Type</div>
                            <div style="font-weight: 500; color: var(--text-primary);">${escapeHtml(t.key_type)}</div>
                        </div>
                        <div>
                            <div style="font-size: 0.75rem; color: var(--text-secondary); margin-bottom: 0.25rem;">Validity</div>
                            <div style="font-weight: 500; color: var(--text-primary);">${t.validity_days} days</div>
                        </div>
                        <div>
                            <div style="font-size: 0.75rem; color: var(--text-secondary); margin-bottom: 0.25rem;">Digest Algorithm</div>
                            <div style="font-weight: 500; color: var(--text-primary);">${escapeHtml(t.digest)}</div>
                        </div>
                    </div>

                    <!-- DN Template -->
                    <div>
                        <h4 style="font-weight: 600; margin-bottom: 0.75rem; color: var(--text-primary);">
                            <svg class="ucm-icon" width="16" height="16" style="vertical-align: middle; margin-right: 0.375rem;"><use href="#icon-file-text"/></svg>
                            Distinguished Name Template
                        </h4>
                        <div style="padding: 1rem; background: var(--bg-primary); border-radius: 4px; font-family: monospace; font-size: 0.875rem;">
                            ${dnEntries || '<div style="color: var(--text-secondary);">No DN template</div>'}
                        </div>
                        <p style="font-size: 0.75rem; color: var(--text-secondary); margin-top: 0.5rem;">
                            Variables: {hostname}, {email}, {username}
                        </p>
                    </div>

                    <!-- Extensions -->
                    <div>
                        <h4 style="font-weight: 600; margin-bottom: 0.75rem; color: var(--text-primary);">
                            <svg class="ucm-icon" width="16" height="16" style="vertical-align: middle; margin-right: 0.375rem;"><use href="#icon-shield"/></svg>
                            Certificate Extensions
                        </h4>
                        
                        <div style="display: grid; gap: 1rem;">
                            ${ku.length ? `
                            <div style="padding: 0.75rem; background: var(--bg-secondary); border-radius: 4px;">
                                <div style="font-size: 0.75rem; color: var(--text-secondary); margin-bottom: 0.5rem;">Key Usage</div>
                                <div style="display: flex; flex-wrap: wrap; gap: 0.375rem;">
                                    ${ku.map(k => `<span style="padding: 0.25rem 0.5rem; background: var(--primary-color)20; color: var(--primary-color); border-radius: 4px; font-size: 0.75rem;">${escapeHtml(k)}</span>`).join('')}
                                </div>
                            </div>
                            ` : ''}
                            
                            ${eku.length ? `
                            <div style="padding: 0.75rem; background: var(--bg-secondary); border-radius: 4px;">
                                <div style="font-size: 0.75rem; color: var(--text-secondary); margin-bottom: 0.5rem;">Extended Key Usage</div>
                                <div style="display: flex; flex-wrap: wrap; gap: 0.375rem;">
                                    ${eku.map(k => `<span style="padding: 0.25rem 0.5rem; background: var(--success-color)20; color: var(--success-color); border-radius: 4px; font-size: 0.75rem;">${escapeHtml(k)}</span>`).join('')}
                                </div>
                            </div>
                            ` : ''}
                            
                            ${san.length ? `
                            <div style="padding: 0.75rem; background: var(--bg-secondary); border-radius: 4px;">
                                <div style="font-size: 0.75rem; color: var(--text-secondary); margin-bottom: 0.5rem;">SAN Types Supported</div>
                                <div style="display: flex; flex-wrap: wrap; gap: 0.375rem;">
                                    ${san.map(k => `<span style="padding: 0.25rem 0.5rem; background: var(--info-color)20; color: var(--info-color); border-radius: 4px; font-size: 0.75rem;">${escapeHtml(k)}</span>`).join('')}
                                </div>
                            </div>
                            ` : ''}
                        </div>
                    </div>
                </div>
            `;
            document.getElementById('viewTemplateContent').innerHTML = html;
        })
        .catch(e => {
            document.getElementById('viewTemplateContent').innerHTML = `<div style="color: var(--danger-color); text-align: center; padding: 2rem;">Error: ${escapeHtml(e.message)}</div>`;
        });
}

function escapeHtml(text) {
    const div = document.createElement('div');
    div.textContent = text;
    return div.innerHTML;
}

function openEditModal(id) {
    showToast('Edit modal - Coming soon', 'info');
}

window.showToast = window.showToast || function(msg, type) { console.log('[' + type + '] ' + msg); };
</script>

<style>
.stats-card {
    padding: 1.5rem;
    background: var(--card-bg);
    border: 1px solid var(--border-color);
    border-radius: 8px;
    text-align: center;
}
.skeleton {
    height: 60px;
    background: var(--bg-secondary);
    animation: pulse 2s cubic-bezier(0.4, 0, 0.6, 1) infinite;
}
@keyframes pulse {
    0%, 100% { opacity: 1; }
    50% { opacity: 0.5; }
}
.spinner {
    width: 40px;
    height: 40px;
    border: 3px solid var(--border-color);
    border-top-color: var(--primary-color);
    border-radius: 50%;
    animation: spin 0.8s linear infinite;
}
@keyframes spin {
    to { transform: rotate(360deg); }
}
.hidden {
    display: none !important;
}
</style>
{% endblock %}

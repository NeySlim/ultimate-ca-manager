{% extends "base.html" %}

{% block title %}ACME Configuration{% endblock %}

{% block content %}
<!-- Page Header -->
<div class="page-header" style="margin-bottom: 20px; padding-bottom: 12px; border-bottom: 1px solid var(--border); display: flex; justify-content: space-between; align-items: center;">
    <div>
        <h1 style="font-size: 20px; font-weight: 600; color: var(--text-primary); margin: 0;">
            <svg class="ucm-icon" width="20" height="20" style="margin-right: 8px; vertical-align: text-bottom;">
                <use href="#icon-acme"/>
            </svg>ACME Protocol
        </h1>
        <p style="font-size: 13px; color: var(--text-secondary); margin: 4px 0 0 0;">Automatic Certificate Management Environment (RFC 8555)</p>
    </div>
</div>

<!-- Tabs -->
<div class="tabs-container" style="display: flex; gap: 0; margin-bottom: 2rem; border-bottom: 2px solid var(--border-color);">
    <button class="tab-button active" onclick="ucm_switchTab('server')" id="btn-tab-server" style="padding: 1rem 2rem; font-size: 0.95rem; font-weight: 600; color: var(--primary-color); border-bottom: 3px solid var(--primary-color); background: none; border-top: none; border-left: none; border-right: none; cursor: pointer; min-height: 3.5rem;">
        <svg class="ucm-icon" width="18" height="18" style="margin-right: 8px;"><use href="#icon-certificate-authority"/></svg> Local Server
    </button>
    <button class="tab-button" onclick="ucm_switchTab('proxy')" id="btn-tab-proxy" style="padding: 1rem 2rem; font-size: 0.95rem; font-weight: 500; color: var(--text-secondary); border-bottom: 3px solid transparent; background: none; border-top: none; border-left: none; border-right: none; cursor: pointer; min-height: 3.5rem;">
        <svg class="ucm-icon" width="18" height="18" style="margin-right: 8px;"><use href="#icon-shield-check"/></svg> Proxy Client
    </button>
</div>

<!-- Tab: Local Server -->
<div id="tab-server" class="tab-content" style="display: block;">
    <!-- ACME Status Card -->
    <div class="card" style="margin-bottom: 20px;">
        <div style="display: grid; grid-template-columns: auto 1fr 1fr; gap: 24px; align-items: start;">
            <!-- Status Badge -->
            <div>
                <span class="badge badge-success" id="acme-status-badge" style="font-size: 14px; padding: 6px 12px;">
                    <i class="bi bi-check-circle-fill"></i> Active
                </span>
            </div>
            
            <!-- CA Info -->
            <div>
                <div style="font-size: 11px; color: var(--text-secondary); text-transform: uppercase; letter-spacing: 0.5px; margin-bottom: 4px;">ACME Server</div>
                <div style="font-weight: 600; color: var(--text-primary); margin-bottom: 8px;" id="acme-ca-display">Loading CA...</div>
                
                <div style="font-size: 11px; color: var(--text-secondary); text-transform: uppercase; letter-spacing: 0.5px; margin-bottom: 4px;">Supported Features</div>
                <div style="display: flex; flex-wrap: wrap; gap: 4px;">
                    <span class="badge bg-secondary" style="font-size: 11px;" title="Account registration">new-account</span>
                    <span class="badge bg-secondary" style="font-size: 11px;" title="Order creation">new-order</span>
                    <span class="badge bg-secondary" style="font-size: 11px;" title="HTTP-01 validation">HTTP-01</span>
                    <span class="badge bg-secondary" style="font-size: 11px;" title="DNS-01 validation">DNS-01</span>
                </div>
            </div>
            
            <!-- Directory URL -->
            <div>
                <label style="font-size: 11px; color: var(--text-secondary); text-transform: uppercase; letter-spacing: 0.5px; display: block; margin-bottom: 4px;">
                    Directory URL
                </label>
                <div style="display: flex; gap: 8px;">
                    <input type="text" class="form-control" readonly 
                           value="https://{{ request.host }}/acme/directory" 
                           style="font-family: monospace; font-size: 13px; flex: 1;">
                    <button class="btn btn-secondary" type="button" 
                            onclick="copyToClipboard('https://{{ request.host }}/acme/directory')"
                            title="Copy to clipboard">
                        <svg class="ucm-icon" width="16" height="16"><use href="#icon-copy"/></svg>
                    </button>
                </div>
            </div>
        </div>
    </div>

    <!-- Statistics Cards -->
    <div style="display: grid; grid-template-columns: repeat(auto-fit, minmax(200px, 1fr)); gap: 16px; margin-bottom: 20px;">
        <div class="card" style="text-align: center; padding: 20px;">
            <svg class="ucm-icon" width="32" height="32" style="color: var(--primary-color);"><use href="#icon-user-check"/></svg>
            <div style="font-size: 2rem; font-weight: bold; margin: 8px 0; color: var(--text-primary);" id="total-accounts">-</div>
            <div style="font-size: 13px; color: var(--text-secondary);">ACME Accounts</div>
        </div>
        <div class="card" style="text-align: center; padding: 20px;">
            <svg class="ucm-icon" width="32" height="32" style="color: var(--warning-color);"><use href="#icon-clock"/></svg>
            <div style="font-size: 2rem; font-weight: bold; margin: 8px 0; color: var(--text-primary);" id="active-orders">-</div>
            <div style="font-size: 13px; color: var(--text-secondary);">Active Orders</div>
        </div>
        <div class="card" style="text-align: center; padding: 20px;">
            <svg class="ucm-icon" width="32" height="32" style="color: var(--success-color);"><use href="#icon-check-circle"/></svg>
            <div style="font-size: 2rem; font-weight: bold; margin: 8px 0; color: var(--text-primary);" id="completed-orders">-</div>
            <div style="font-size: 13px; color: var(--text-secondary);">Completed Orders</div>
        </div>
        <div class="card" style="text-align: center; padding: 20px;">
            <svg class="ucm-icon" width="32" height="32" style="color: var(--info-color);"><use href="#icon-certificate"/></svg>
            <div style="font-size: 2rem; font-weight: bold; margin: 8px 0; color: var(--text-primary);" id="issued-certs">-</div>
            <div style="font-size: 13px; color: var(--text-secondary);">Certificates Issued</div>
        </div>
    </div>

    <!-- ACME Accounts -->
    <div class="card" style="margin-bottom: 20px; padding: 0;">
        <div style="padding: 1.5rem 1.5rem 0.75rem 1.5rem; border-bottom: 1px solid var(--border-color);">
            <h2 style="font-size: 16px; font-weight: 600; color: var(--text-primary); margin: 0; display: flex; align-items: center; gap: 0.5rem;">
                <svg class="ucm-icon" width="18" height="18"><use href="#icon-user-check"/></svg>
                ACME Accounts
            </h2>
        </div>
        <div id="accounts-table" 
             hx-get="/api/ui/acme/accounts" 
             hx-trigger="load"
             hx-indicator="#accounts-loading">
            <div id="accounts-loading" style="text-align: center; padding: 40px;">
                <svg class="ucm-icon icon-spin" width="24" height="24"><use href="#icon-spinner"/></svg>
                <p style="margin-top: 8px; font-size: 13px; color: var(--text-secondary);">Loading accounts...</p>
            </div>
        </div>
    </div>

    <!-- ACME Orders -->
    <div class="card" style="margin-bottom: 20px; padding: 0;">
        <div style="padding: 1.5rem 1.5rem 0.75rem 1.5rem; border-bottom: 1px solid var(--border-color);">
            <h2 style="font-size: 16px; font-weight: 600; color: var(--text-primary); margin: 0; display: flex; align-items: center; gap: 0.5rem;">
                <svg class="ucm-icon" width="18" height="18"><use href="#icon-inbox"/></svg>
                ACME Orders
            </h2>
        </div>
        <div id="orders-table" 
             hx-get="/api/ui/acme/orders" 
             hx-trigger="load"
             hx-indicator="#orders-loading">
            <div id="orders-loading" style="text-align: center; padding: 40px;">
                <svg class="ucm-icon icon-spin" width="24" height="24"><use href="#icon-spinner"/></svg>
                <p style="margin-top: 8px; font-size: 13px; color: var(--text-secondary);">Loading orders...</p>
            </div>
        </div>
    </div>

    <!-- ACME Configuration -->
    <div class="card" style="padding: 0;">
        <div style="padding-bottom: 12px; border-bottom: 1px solid var(--border); margin-bottom: 16px;">
            <h2 style="font-size: 16px; font-weight: 600; color: var(--text-primary); margin: 0; display: flex; align-items: center; gap: 0.5rem;">
                <svg class="ucm-icon" width="18" height="18"><use href="#icon-settings"/></svg>
                ACME Configuration
            </h2>
        </div>
        <form id="acme-settings-form" 
              hx-post="/api/ui/acme/settings" 
              hx-swap="none">
            <div style="display: grid; grid-template-columns: repeat(auto-fit, minmax(300px, 1fr)); gap: 20px; margin-bottom: 20px;">
                <div>
                    <label class="form-label">Default CA for ACME</label>
                    <select name="default_ca" class="form-control" id="acme-default-ca"
                            hx-get="/api/ui/ca/options" 
                            hx-trigger="load"
                            hx-swap="innerHTML">
                        <option>Loading CAs...</option>
                    </select>
                    <small style="display: block; margin-top: 4px; font-size: 12px; color: var(--text-secondary);">
                        CA used to sign ACME certificates
                    </small>
                </div>

                <div>
                    <label class="form-label">Certificate Validity (days)</label>
                    <input type="number" name="cert_validity" class="form-control" 
                           value="90" min="1" max="397">
                    <small style="display: block; margin-top: 4px; font-size: 12px; color: var(--text-secondary);">
                        Default: 90 days, Max: 397 days
                    </small>
                </div>
            </div>

            <button type="submit" class="btn-primary">
                <i class="bi bi-check-circle"></i> Save Settings
            </button>
        </form>
    </div>
</div>

<!-- Tab: Proxy Client -->
<div id="tab-proxy" class="tab-content" style="display: none;">
    
    <!-- Info Card -->
    <div class="card" style="margin-bottom: 20px;">
        <div class="card-header">
             <h2 style="font-size: 16px; font-weight: 600; color: var(--text-primary); margin: 0;">
                <svg class="ucm-icon" width="18" height="18" style="margin-right: 8px; vertical-align: text-bottom; color: var(--info-color);"><use href="#icon-info-circle"/></svg>
                About ACME Proxy
            </h2>
        </div>
        <div style="padding: 1.5rem;">
            {% if is_self_signed %}
            <div class="alert alert-warning" style="margin-bottom: 16px; font-size: 13px;">
                <svg class="ucm-icon" width="16" height="16" style="margin-right: 6px;"><use href="#icon-warning-triangle"/></svg>
                <strong>Self-Signed Certificate Detected</strong><br>
                This server is using a self-signed certificate. ACME clients (like Certbot) will fail to connect unless you:
                <ul style="margin-bottom: 0; padding-left: 20px; margin-top: 4px;">
                    <li>Install the root CA on the client machine</li>
                    <li>Or configure the client to skip SSL verification (e.g. <code>--no-verify-ssl</code>)</li>
                </ul>
            </div>
            {% endif %}
            <p style="color: var(--text-secondary); font-size: 14px; margin-bottom: 0;">
                The ACME Proxy acts as a secure gateway between your internal clients (Certbot, Traefik, etc.) and Let's Encrypt. 
                Instead of each client managing its own account, the Proxy uses a <strong>shared upstream account</strong> to communicate with the provider.
                This allows for centralized rate limiting, logging, and policy enforcement.
            </p>
        </div>
    </div>

    <!-- Proxy Status & Actions Card -->
    <div class="card" style="margin-bottom: 20px;">
        <div style="display: grid; grid-template-columns: auto 1fr 1fr; gap: 24px; align-items: start;">
            <!-- Service Status -->
            <div>
                <span class="badge badge-info" id="proxy-status-badge" style="font-size: 14px; padding: 6px 12px;">
                    <svg class="ucm-icon" width="16" height="16"><use href="#icon-server"/></svg> Service Running
                </span>
            </div>
            
            <!-- Upstream Connection -->
            <div>
                <div style="font-size: 11px; color: var(--text-secondary); text-transform: uppercase; letter-spacing: 0.5px; margin-bottom: 4px;">Upstream Provider</div>
                <div style="font-weight: 600; color: var(--text-primary); margin-bottom: 16px;" id="proxy-upstream-display">Let's Encrypt Staging</div>
                
                <div style="font-size: 11px; color: var(--text-secondary); text-transform: uppercase; letter-spacing: 0.5px; margin-bottom: 4px;">Connection Status</div>
                <div id="proxy-account-container">
                    <!-- Loaded dynamically -->
                    <span class="spinner-border spinner-border-sm" role="status" aria-hidden="true"></span> Checking...
                </div>
            </div>
            
            <!-- Directory URL -->
            <div>
                <label style="font-size: 11px; color: var(--text-secondary); text-transform: uppercase; letter-spacing: 0.5px; display: block; margin-bottom: 4px;">
                    Proxy Endpoint (Directory URL)
                </label>
                <div style="display: flex; gap: 8px; margin-bottom: 8px;">
                    <input type="text" class="form-control" readonly 
                           id="proxy-directory-url"
                           value="https://{{ request.host }}/acme/proxy/directory" 
                           style="font-family: monospace; font-size: 13px; flex: 1;">
                    <button class="btn btn-secondary" type="button" 
                            onclick="copyToClipboard(document.getElementById('proxy-directory-url').value)"
                            title="Copy to clipboard">
                        <svg class="ucm-icon" width="16" height="16"><use href="#icon-copy"/></svg>
                    </button>
                </div>
                <p style="font-size: 12px; color: var(--text-secondary); margin: 0;">
                    Configure your ACME clients to use this URL.
                </p>
            </div>
        </div>
    </div>
</div>

<script>
function copyToClipboard(text) {
    navigator.clipboard.writeText(text).then(() => {
        showToast('Copied to clipboard!', 'success');
    });
}

// Global flag to prevent multiple page initializations (use window to avoid redeclaration error)
if (typeof window.acmePageInitialized === 'undefined') {
    window.acmePageInitialized = false;
}

// Load statistics and settings on page load
document.addEventListener('DOMContentLoaded', function() {
    if (document.getElementById('acme-status-badge') && !window.acmePageInitialized) {
        window.acmePageInitialized = true;
        initAcmePage();
        // Auto-load proxy status if tab is active (from previous session)
        if (localStorage.getItem('ucm-tab-config') === 'proxy') {
           ucm_switchTab('proxy');
        }
    }
});

// Also trigger on HTMX content swap (but only once)
document.addEventListener('htmx:afterSwap', function(event) {
    if ((event.detail.target.id === 'main-content' || document.getElementById('acme-status-badge')) && !window.acmePageInitialized) {
        window.acmePageInitialized = true;
        initAcmePage();
    }
});

function initAcmePage() {
    loadStatistics();
    loadAcmeCA();
    loadSettings();
    loadProxyStatus();
    
    // Handle form submission success
    const form = document.getElementById('acme-settings-form');
    if (form && !form.hasAttribute('data-listener-added')) {
        form.setAttribute('data-listener-added', 'true');
        form.addEventListener('htmx:afterRequest', function(event) {
            if (event.detail.successful && event.detail.requestConfig.verb === 'post') {
                window.showToast('ACME settings saved successfully', 'success');
                setTimeout(() => loadAcmeCA(), 200);
            }
        });
    }
}

function loadStatistics() {
    const handler = function(evt) {
        if (evt.detail.pathInfo.requestPath === '/api/ui/acme/statistics') {
            try {
                const data = JSON.parse(evt.detail.xhr.responseText);
                const totalAccounts = document.getElementById('total-accounts');
                const activeOrders = document.getElementById('active-orders');
                const completedOrders = document.getElementById('completed-orders');
                const issuedCerts = document.getElementById('issued-certs');
                
                if (totalAccounts) totalAccounts.textContent = data.total_accounts || 0;
                if (activeOrders) activeOrders.textContent = data.active_orders || 0;
                if (completedOrders) completedOrders.textContent = data.completed_orders || 0;
                if (issuedCerts) issuedCerts.textContent = data.issued_certs || 0;
            } catch (error) {
                console.error('Error loading stats:', error);
            }
            document.body.removeEventListener('htmx:afterRequest', handler);
        }
    };
    document.body.addEventListener('htmx:afterRequest', handler);
    htmx.ajax('GET', '/api/ui/acme/statistics', {swap: 'none'});
}

function loadAcmeCA() {
    const badge = document.getElementById('acme-status-badge');
    const caDisplay = document.getElementById('acme-ca-display');
    if (!badge) return;
    
    const handler = function(evt) {
        if (evt.detail.pathInfo.requestPath === '/api/ui/acme/settings/load') {
            try {
                const data = JSON.parse(evt.detail.xhr.responseText);
                if (data.default_ca) {
                    badge.className = 'badge badge-success';
                    badge.style.fontSize = '14px';
                    badge.style.padding = '6px 12px';
                    badge.innerHTML = '<svg class="ucm-icon" width="14" height="14" style="vertical-align: text-bottom; margin-right: 4px;"><use href="#icon-check-circle"/></svg> Active';
                    
                    const caSelect = document.getElementById('acme-default-ca');
                    if (caSelect && caSelect.options.length > 1) {
                        const selectedOption = Array.from(caSelect.options).find(opt => opt.value === data.default_ca);
                        caDisplay.textContent = selectedOption ? selectedOption.text : data.default_ca;
                    } else {
                        caDisplay.textContent = 'CA: ' + data.default_ca;
                    }
                } else {
                    badge.className = 'badge badge-danger';
                    badge.style.fontSize = '14px';
                    badge.style.padding = '6px 12px';
                    badge.innerHTML = '<svg class="ucm-icon" width="14" height="14" style="vertical-align: text-bottom; margin-right: 4px;"><use href="#icon-ban"/></svg> Not Configured';
                    caDisplay.textContent = 'No CA configured';
                }
            } catch (error) {
                console.error('Error loading CA:', error);
            }
            document.body.removeEventListener('htmx:afterRequest', handler);
        }
    };
    document.body.addEventListener('htmx:afterRequest', handler);
    htmx.ajax('GET', '/api/ui/acme/settings/load', {swap: 'none'});
}

function loadSettings() {
    const handler = function(evt) {
        if (evt.detail.pathInfo.requestPath === '/api/ui/acme/settings/load') {
            try {
                const data = JSON.parse(evt.detail.xhr.responseText);
                if (data.default_ca) {
                    const select = document.getElementById('acme-default-ca');
                    if (select) setTimeout(() => select.value = data.default_ca, 500);
                }
                if (data.cert_validity) {
                    const validityInput = document.querySelector('input[name="cert_validity"]');
                    if (validityInput) validityInput.value = data.cert_validity;
                }
            } catch (error) {
                console.error('Error loading settings:', error);
            }
            document.body.removeEventListener('htmx:afterRequest', handler);
        }
    };
    document.body.addEventListener('htmx:afterRequest', handler);
    htmx.ajax('GET', '/api/ui/acme/settings/load', {swap: 'none'});
}

function loadProxyStatus() {
    // Prevent concurrent calls (use window to avoid redeclaration error)
    if (window.loadProxyStatusInProgress) {
        console.log('loadProxyStatus already in progress, skipping');
        return;
    }
    window.loadProxyStatusInProgress = true;
    
    const handler = function(evt) {
        if (evt.detail.pathInfo.requestPath === '/api/ui/acme/proxy/status') {
            window.loadProxyStatusInProgress = false;
            try {
                const data = JSON.parse(evt.detail.xhr.responseText);
                // Check if elements exist (user might not be on proxy tab)
                const upstreamDisplay = document.getElementById('proxy-upstream-display');
                const directoryUrl = document.getElementById('proxy-directory-url');
                const container = document.getElementById('proxy-account-container');
                
                if (!upstreamDisplay || !directoryUrl || !container) {
                    // Elements not in DOM, silently return
                    document.body.removeEventListener('htmx:afterRequest', handler);
                    return;
                }
                
                upstreamDisplay.textContent = data.upstream_url;
                directoryUrl.value = data.directory_url;
                
                if (data.is_registered) {
                    container.innerHTML = `
                        <div style="color: var(--success-color); font-weight: 500; font-size: 14px;">
                            <svg class="ucm-icon" width="16" height="16" style="vertical-align: text-bottom; margin-right: 4px;"><use href="#icon-check-circle"/></svg> Registered & Active
                        </div>`;
                } else {
                    container.innerHTML = `
                        <div style="display: flex; align-items: center; gap: 10px;">
                            <span class="badge badge-warning">Not Registered</span>
                            <button id="btn-register-proxy" class="btn btn-primary btn-primary" onclick="registerProxyAccount()">
                                Register Account
                            </button>
                        </div>`;
                }
            } catch (err) {
                console.error("Proxy status error", err);
                window.loadProxyStatusInProgress = false;
            }
            document.body.removeEventListener('htmx:afterRequest', handler);
        }
    };
    document.body.addEventListener('htmx:afterRequest', handler);
    htmx.ajax('GET', '/api/ui/acme/proxy/status', {swap: 'none'});
}

function registerProxyAccount() {
    const btn = document.getElementById('btn-register-proxy');
    if (!btn) return;
    
    const originalContent = btn.innerHTML;
    btn.disabled = true;
    btn.innerHTML = '<span class="spinner-border spinner-border-sm" role="status" aria-hidden="true"></span>';
    
    const handler = function(evt) {
        if (evt.detail.pathInfo.requestPath === '/api/ui/acme/proxy/register') {
            try {
                const data = JSON.parse(evt.detail.xhr.responseText);
                if (data.status === 'success') {
                    window.showToast('Upstream account registered successfully', 'success');
                    loadProxyStatus();
                } else {
                    window.showToast('Error: ' + (data.message || 'Registration failed'), 'error');
                    btn.innerHTML = originalContent;
                    btn.disabled = false;
                }
            } catch (err) {
                console.error(err);
                window.showToast('Network error during registration', 'error');
                btn.innerHTML = originalContent;
                btn.disabled = false;
            }
            document.body.removeEventListener('htmx:afterRequest', handler);
        }
    };
    document.body.addEventListener('htmx:afterRequest', handler);
    htmx.ajax('POST', '/api/ui/acme/proxy/register', {swap: 'none'});
}
</script>
{% endblock %}

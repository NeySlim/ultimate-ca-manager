{% extends "base.html" %}

{% block title %}ACME Configuration{% endblock %}

{% block content %}
<!-- Page Header -->
<div class="page-header" style="margin-bottom: 20px; padding-bottom: 12px; border-bottom: 1px solid var(--border); display: flex; justify-content: space-between; align-items: center;">
    <div>
        <h1 style="font-size: 20px; font-weight: 600; color: var(--text-primary); margin: 0;">
            <i class="bi bi-shield-lock" style="margin-right: 8px;"></i>ACME Protocol
        </h1>
        <p style="font-size: 13px; color: var(--text-secondary); margin: 4px 0 0 0;">Automatic Certificate Management Environment (RFC 8555)</p>
    </div>
</div>

<!-- ACME Status Card -->
<div class="card" style="margin-bottom: 20px;">
    <div style="display: grid; grid-template-columns: auto 1fr auto; gap: 24px; align-items: center;">
        <!-- Status Badge -->
        <div>
            <span class="badge badge-success" id="acme-status-badge" style="font-size: 14px; padding: 6px 12px;">
                <i class="bi bi-check-circle-fill"></i> Active
            </span>
        </div>
        
        <!-- CA Info -->
        <div>
            <div style="font-size: 11px; color: var(--text-secondary); text-transform: uppercase; letter-spacing: 0.5px;">ACME Server</div>
            <div style="font-weight: 600; color: var(--text-primary); margin-top: 4px;" id="acme-ca-display">Loading CA...</div>
        </div>
        
        <!-- Directory URL -->
        <div style="min-width: 400px;">
            <label style="font-size: 11px; color: var(--text-secondary); text-transform: uppercase; letter-spacing: 0.5px; display: block; margin-bottom: 4px;">
                Directory URL
            </label>
            <div style="display: flex; gap: 8px;">
                <input type="text" class="form-control" readonly 
                       value="https://{{ request.host }}/acme/directory" 
                       style="font-family: monospace; font-size: 13px; flex: 1;">
                <button class="btn btn-outline-secondary" type="button" 
                        onclick="copyToClipboard('https://{{ request.host }}/acme/directory')"
                        title="Copy to clipboard">
                    <i class="bi bi-clipboard"></i>
                </button>
            </div>
        </div>
    </div>
</div>

<!-- Statistics Cards -->
<div style="display: grid; grid-template-columns: repeat(auto-fit, minmax(200px, 1fr)); gap: 16px; margin-bottom: 20px;">
    <div class="card" style="text-align: center; padding: 20px;">
        <i class="bi bi-person-badge" style="font-size: 2rem; color: var(--primary-color);"></i>
        <div style="font-size: 2rem; font-weight: bold; margin: 8px 0; color: var(--text-primary);" id="total-accounts">-</div>
        <div style="font-size: 13px; color: var(--text-secondary);">ACME Accounts</div>
    </div>
    <div class="card" style="text-align: center; padding: 20px;">
        <i class="bi bi-hourglass-split" style="font-size: 2rem; color: #f59e0b;"></i>
        <div style="font-size: 2rem; font-weight: bold; margin: 8px 0; color: var(--text-primary);" id="active-orders">-</div>
        <div style="font-size: 13px; color: var(--text-secondary);">Active Orders</div>
    </div>
    <div class="card" style="text-align: center; padding: 20px;">
        <i class="bi bi-check-circle" style="font-size: 2rem; color: #10b981;"></i>
        <div style="font-size: 2rem; font-weight: bold; margin: 8px 0; color: var(--text-primary);" id="completed-orders">-</div>
        <div style="font-size: 13px; color: var(--text-secondary);">Completed Orders</div>
    </div>
    <div class="card" style="text-align: center; padding: 20px;">
        <i class="bi bi-award" style="font-size: 2rem; color: #06b6d4;"></i>
        <div style="font-size: 2rem; font-weight: bold; margin: 8px 0; color: var(--text-primary);" id="issued-certs">-</div>
        <div style="font-size: 13px; color: var(--text-secondary);">Certificates Issued</div>
    </div>
</div>

<!-- ACME Accounts -->
<div class="card" style="margin-bottom: 20px;">
    <div style="padding-bottom: 12px; border-bottom: 1px solid var(--border); margin-bottom: 16px;">
        <h2 style="font-size: 16px; font-weight: 600; color: var(--text-primary); margin: 0;">ACME Accounts</h2>
    </div>
    <div id="accounts-table" 
         hx-get="/api/ui/acme/accounts" 
         hx-trigger="load"
         hx-indicator="#accounts-loading">
        <div id="accounts-loading" style="text-align: center; padding: 40px;">
            <div class="spinner" style="margin: 0 auto;"></div>
            <p style="margin-top: 8px; font-size: 13px; color: var(--text-secondary);">Loading accounts...</p>
        </div>
    </div>
</div>

<!-- ACME Orders -->
<div class="card" style="margin-bottom: 20px;">
    <div style="padding-bottom: 12px; border-bottom: 1px solid var(--border); margin-bottom: 16px;">
        <h2 style="font-size: 16px; font-weight: 600; color: var(--text-primary); margin: 0;">ACME Orders</h2>
    </div>
    <div id="orders-table" 
         hx-get="/api/ui/acme/orders" 
         hx-trigger="load"
         hx-indicator="#orders-loading">
        <div id="orders-loading" style="text-align: center; padding: 40px;">
            <div class="spinner" style="margin: 0 auto;"></div>
            <p style="margin-top: 8px; font-size: 13px; color: var(--text-secondary);">Loading orders...</p>
        </div>
    </div>
</div>

<!-- ACME Configuration -->
<div class="card">
    <div style="padding-bottom: 12px; border-bottom: 1px solid var(--border); margin-bottom: 16px;">
        <h2 style="font-size: 16px; font-weight: 600; color: var(--text-primary); margin: 0;">ACME Configuration</h2>
    </div>
    <form id="acme-settings-form" 
          hx-post="/api/ui/acme/settings" 
          hx-swap="none">
        <div style="display: grid; grid-template-columns: repeat(auto-fit, minmax(300px, 1fr)); gap: 20px; margin-bottom: 20px;">
            <div>
                <label class="form-label">Default CA for ACME</label>
                <select name="default_ca" class="form-control" id="acme-default-ca"
                        hx-get="/api/ui/ca/options" 
                        hx-trigger="load"
                        hx-swap="innerHTML">
                    <option>Loading CAs...</option>
                </select>
                <small style="display: block; margin-top: 4px; font-size: 12px; color: var(--text-secondary);">
                    CA used to sign ACME certificates
                </small>
            </div>

            <div>
                <label class="form-label">Certificate Validity (days)</label>
                <input type="number" name="cert_validity" class="form-control" 
                       value="90" min="1" max="397">
                <small style="display: block; margin-top: 4px; font-size: 12px; color: var(--text-secondary);">
                    Default: 90 days, Max: 397 days
                </small>
            </div>
        </div>

        <button type="submit" class="btn btn-primary">
            <i class="bi bi-check-circle"></i> Save Settings
        </button>
    </form>
</div>

<script>
function copyToClipboard(text) {
    navigator.clipboard.writeText(text).then(() => {
        showToast('Copied to clipboard!', 'success');
    });
}

function showToast(message, type = 'success') {
    const toast = document.createElement('div');
    toast.className = `alert alert-${type} position-fixed top-0 end-0 m-3`;
    toast.style.zIndex = '9999';
    toast.innerHTML = `
        <i class="bi bi-${type === 'success' ? 'check-circle' : 'exclamation-circle'}"></i>
        ${message}
    `;
    document.body.appendChild(toast);
    setTimeout(() => toast.remove(), 3000);
}

// Load statistics and settings on page load
document.addEventListener('DOMContentLoaded', function() {
    loadStatistics();
    loadAcmeCA();
    loadSettings();
    
    // Handle form submission success - ONLY when form is submitted
    const form = document.getElementById('acme-settings-form');
    if (form) {
        form.addEventListener('htmx:afterRequest', function(event) {
            // Check if this is a POST request (form submission)
            if (event.detail.successful && event.detail.requestConfig.verb === 'post') {
                showToast('ACME settings saved successfully', 'success');
                setTimeout(() => loadAcmeCA(), 200);
            }
        });
    }
});

function loadStatistics() {
    fetch('/api/ui/acme/statistics')
        .then(response => response.json())
        .then(data => {
            document.getElementById('total-accounts').textContent = data.total_accounts || 0;
            document.getElementById('active-orders').textContent = data.active_orders || 0;
            document.getElementById('completed-orders').textContent = data.completed_orders || 0;
            document.getElementById('issued-certs').textContent = data.issued_certs || 0;
        })
        .catch(error => {
            console.error('Error loading statistics:', error);
        });
}

function loadAcmeCA() {
    const badge = document.getElementById('acme-status-badge');
    const caDisplay = document.getElementById('acme-ca-display');
    
    fetch('/api/ui/acme/settings/load')
        .then(response => response.json())
        .then(data => {
            if (data.default_ca) {
                // CA configured - show Active (green)
                badge.className = 'badge badge-success';
                badge.style.fontSize = '14px';
                badge.style.padding = '6px 12px';
                badge.innerHTML = '<i class="bi bi-check-circle-fill"></i> Active';
                
                // Get CA name from the select dropdown - wait for HTMX to load options
                const caSelect = document.getElementById('acme-default-ca');
                if (caSelect) {
                    // Try multiple times to find the option (HTMX might still be loading)
                    let attempts = 0;
                    const checkInterval = setInterval(() => {
                        const selectedOption = Array.from(caSelect.options).find(opt => opt.value === data.default_ca);
                        if (selectedOption) {
                            caDisplay.textContent = selectedOption.text;
                            clearInterval(checkInterval);
                        } else if (++attempts > 10) {
                            // After 10 attempts (1 second), just show the refid
                            caDisplay.textContent = 'CA: ' + data.default_ca;
                            clearInterval(checkInterval);
                        }
                    }, 100);
                } else {
                    caDisplay.textContent = 'CA: ' + data.default_ca;
                }
            } else {
                // No CA configured - show Not Configured (red)
                badge.className = 'badge badge-danger';
                badge.style.fontSize = '14px';
                badge.style.padding = '6px 12px';
                badge.innerHTML = '<i class="bi bi-x-circle-fill"></i> Not Configured';
                caDisplay.textContent = 'No CA configured';
            }
        })
        .catch(error => {
            // Error - show as disabled (red)
            badge.className = 'badge badge-danger';
            badge.style.fontSize = '14px';
            badge.style.padding = '6px 12px';
            badge.innerHTML = '<i class="bi bi-exclamation-circle-fill"></i> Error';
            caDisplay.textContent = 'Error loading CA';
            console.error('Error:', error);
        });
}

function loadSettings() {
    fetch('/api/ui/acme/settings/load')
        .then(response => response.json())
        .then(data => {
            if (data.default_ca) {
                const select = document.getElementById('acme-default-ca');
                setTimeout(() => {
                    select.value = data.default_ca;
                }, 500);
            }
            if (data.cert_validity) {
                document.querySelector('input[name="cert_validity"]').value = data.cert_validity;
            }
        });
}
</script>
{% endblock %}

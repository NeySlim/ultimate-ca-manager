{% extends "base.html" %}

{% block title %}ACME Configuration{% endblock %}

{% block content %}
<div style="max-width: 80rem; margin: 0 auto;">
    <!-- Page Header -->
    <div style="margin-bottom: 1.5rem;">
        <h1 style="font-size: 1.875rem; font-weight: bold; color: var(--text-primary);">
            <i class="bi bi-shield-lock" style="margin-right: 0.5rem;"></i>ACME Protocol
        </h1>
        <p style="margin-top: 0.5rem; font-size: 0.875rem; color: var(--text-secondary);">
            Automatic Certificate Management Environment (RFC 8555)
        </p>
    </div>

    <!-- ACME Status Overview -->
    <div class="card" style="margin-bottom: 1.5rem;">
        <div style="display: grid; grid-template-columns: repeat(auto-fit, minmax(300px, 1fr)); gap: 1.5rem;">
            <!-- Status -->
            <div>
                <div style="display: flex; align-items: center; gap: 0.75rem; margin-bottom: 0.5rem;">
                    <span class="badge badge-success" id="acme-status-badge" style="font-size: 0.875rem; padding: 0.375rem 0.75rem;">
                        <i class="bi bi-check-circle-fill"></i> Active
                    </span>
                    <div>
                        <div style="font-size: 0.75rem; color: var(--text-secondary); text-transform: uppercase; letter-spacing: 0.05em;">ACME Server</div>
                        <div style="font-weight: 600; color: var(--text-primary);" id="acme-ca-display">Loading CA...</div>
                    </div>
                </div>
            </div>
            
            <!-- Directory URL -->
            <div>
                <label style="font-size: 0.75rem; color: var(--text-secondary); text-transform: uppercase; letter-spacing: 0.05em; display: block; margin-bottom: 0.5rem;">
                    Directory URL
                </label>
                <div style="display: flex; gap: 0.5rem;">
                    <input type="text" class="form-control" readonly 
                           value="https://{{ request.host }}/acme/directory" 
                           id="acme-url"
                           style="font-family: monospace; font-size: 0.875rem;">
                    <button class="btn btn-outline-secondary" type="button" 
                            onclick="copyToClipboard('https://{{ request.host }}/acme/directory')"
                            title="Copy to clipboard">
                        <i class="bi bi-clipboard"></i>
                    </button>
                </div>
            </div>
            
            <!-- Features -->
            <div>
                <label style="font-size: 0.75rem; color: var(--text-secondary); text-transform: uppercase; letter-spacing: 0.05em; display: block; margin-bottom: 0.5rem;">
                    Supported Features
                </label>
                <div style="display: flex; flex-wrap: wrap; gap: 0.375rem;">
                    <span class="badge bg-secondary" title="Account registration">new-account</span>
                    <span class="badge bg-secondary" title="Order creation">new-order</span>
                    <span class="badge bg-secondary" title="HTTP-01 validation">HTTP-01</span>
                    <span class="badge bg-secondary" title="DNS-01 validation">DNS-01</span>
                    <span class="badge bg-secondary" title="JWS signatures">JWS</span>
                </div>
            </div>
        </div>
    </div>

    <!-- Statistics Cards -->
    <div style="display: grid; grid-template-columns: repeat(auto-fit, minmax(200px, 1fr)); gap: 1rem; margin-bottom: 1.5rem;">
        <div class="card" style="text-align: center;">
            <i class="bi bi-person-badge" style="font-size: 2rem; color: var(--primary-color);"></i>
            <div style="font-size: 2rem; font-weight: bold; margin: 0.5rem 0; color: var(--text-primary);" id="total-accounts">-</div>
            <div style="font-size: 0.875rem; color: var(--text-secondary);">Accounts</div>
        </div>
        <div class="card" style="text-align: center;">
            <i class="bi bi-hourglass-split" style="font-size: 2rem; color: #f59e0b;"></i>
            <div style="font-size: 2rem; font-weight: bold; margin: 0.5rem 0; color: var(--text-primary);" id="active-orders">-</div>
            <div style="font-size: 0.875rem; color: var(--text-secondary);">Active Orders</div>
        </div>
        <div class="card" style="text-align: center;">
            <i class="bi bi-check-circle" style="font-size: 2rem; color: #10b981;"></i>
            <div style="font-size: 2rem; font-weight: bold; margin: 0.5rem 0; color: var(--text-primary);" id="completed-orders">-</div>
            <div style="font-size: 0.875rem; color: var(--text-secondary);">Completed</div>
        </div>
        <div class="card" style="text-align: center;">
            <i class="bi bi-award" style="font-size: 2rem; color: #06b6d4;"></i>
            <div style="font-size: 2rem; font-weight: bold; margin: 0.5rem 0; color: var(--text-primary);" id="issued-certs">-</div>
            <div style="font-size: 0.875rem; color: var(--text-secondary);">Certificates</div>
        </div>
    </div>

    <!-- Tabs -->
    <div style="border-bottom: 1px solid var(--border-color); margin-bottom: 1.5rem;" x-data="{ activeTab: 'accounts' }">
        <nav style="margin-bottom: -1px; display: flex; gap: 2rem;">
            <button @click="activeTab = 'accounts'" :style="activeTab === 'accounts' ? 'border-bottom-color: var(--primary-color); color: var(--primary-color);' : 'border-bottom-color: transparent; color: var(--text-secondary);'" style="white-space: nowrap; padding: 1rem 0.25rem; border-bottom: 2px solid; font-weight: 500; font-size: 0.875rem; background: none; cursor: pointer;">
                <i class="bi bi-person-badge"></i> Accounts
            </button>
            <button @click="activeTab = 'orders'" :style="activeTab === 'orders' ? 'border-bottom-color: var(--primary-color); color: var(--primary-color);' : 'border-bottom-color: transparent; color: var(--text-secondary);'" style="white-space: nowrap; padding: 1rem 0.25rem; border-bottom: 2px solid; font-weight: 500; font-size: 0.875rem; background: none; cursor: pointer;">
                <i class="bi bi-file-earmark-text"></i> Orders
            </button>
            <button @click="activeTab = 'settings'" :style="activeTab === 'settings' ? 'border-bottom-color: var(--primary-color); color: var(--primary-color);' : 'border-bottom-color: transparent; color: var(--text-secondary);'" style="white-space: nowrap; padding: 1rem 0.25rem; border-bottom: 2px solid; font-weight: 500; font-size: 0.875rem; background: none; cursor: pointer;">
                <i class="bi bi-gear"></i> Settings
            </button>
        </nav>

        <!-- Accounts Tab -->
        <div x-show="activeTab === 'accounts'" style="padding: 1.5rem 0;">
            <div class="card">
                <h2 style="font-size: 1.25rem; font-weight: 600; margin-bottom: 1rem; color: var(--text-primary);">ACME Accounts</h2>
                <div id="accounts-table" 
                     hx-get="/api/ui/acme/accounts" 
                     hx-trigger="load"
                     hx-indicator="#accounts-loading">
                    <div id="accounts-loading" style="text-align: center; padding: 2rem 0;">
                        <div class="spinner" style="margin: 0 auto;"></div>
                        <p style="margin-top: 0.5rem; font-size: 0.875rem; color: var(--text-secondary);">Loading accounts...</p>
                    </div>
                </div>
            </div>
        </div>

        <!-- Orders Tab -->
        <div x-show="activeTab === 'orders'" style="padding: 1.5rem 0;">
            <div class="card">
                <h2 style="font-size: 1.25rem; font-weight: 600; margin-bottom: 1rem; color: var(--text-primary);">ACME Orders</h2>
                <div id="orders-table" 
                     hx-get="/api/ui/acme/orders" 
                     hx-trigger="revealed"
                     hx-indicator="#orders-loading">
                    <div id="orders-loading" style="text-align: center; padding: 2rem 0;">
                        <div class="spinner" style="margin: 0 auto;"></div>
                        <p style="margin-top: 0.5rem; font-size: 0.875rem; color: var(--text-secondary);">Loading orders...</p>
                    </div>
                </div>
            </div>
        </div>

        <!-- Settings Tab -->
        <div x-show="activeTab === 'settings'" style="padding: 1.5rem 0;">
            <div class="card">
                <h2 style="font-size: 1.25rem; font-weight: 600; margin-bottom: 1rem; color: var(--text-primary);">ACME Configuration</h2>
                <form id="acme-settings-form" 
                      hx-post="/api/ui/acme/settings" 
                      hx-swap="none">
                    <div style="display: grid; grid-template-columns: repeat(auto-fit, minmax(300px, 1fr)); gap: 1.5rem; margin-bottom: 1.5rem;">
                        <div>
                            <label style="display: block; font-weight: 600; margin-bottom: 0.5rem; color: var(--text-primary);">
                                Default CA for ACME
                            </label>
                            <select name="default_ca" class="form-control" id="acme-default-ca"
                                    hx-get="/api/ui/ca/options" 
                                    hx-trigger="load"
                                    hx-swap="innerHTML">
                                <option>Loading CAs...</option>
                            </select>
                            <small style="display: block; margin-top: 0.25rem; font-size: 0.875rem; color: var(--text-secondary);">
                                CA used to sign ACME certificates
                            </small>
                        </div>

                        <div>
                            <label style="display: block; font-weight: 600; margin-bottom: 0.5rem; color: var(--text-primary);">
                                Certificate Validity (days)
                            </label>
                            <input type="number" name="cert_validity" class="form-control" 
                                   value="90" min="1" max="397">
                            <small style="display: block; margin-top: 0.25rem; font-size: 0.875rem; color: var(--text-secondary);">
                                Default: 90 days, Max: 397 days
                            </small>
                        </div>
                    </div>

                    <button type="submit" class="btn-primary">
                        <i class="bi bi-check-circle"></i> Save Settings
                    </button>
                </form>
            </div>
        </div>
    </div>
</div>

<script>
function copyToClipboard(text) {
    navigator.clipboard.writeText(text).then(() => {
        showToast('Copied to clipboard!', 'success');
    });
}

function showToast(message, type = 'success') {
    const toast = document.createElement('div');
    toast.className = `alert alert-${type} position-fixed top-0 end-0 m-3`;
    toast.style.zIndex = '9999';
    toast.innerHTML = `
        <i class="bi bi-${type === 'success' ? 'check-circle' : 'exclamation-circle'}"></i>
        ${message}
    `;
    document.body.appendChild(toast);
    setTimeout(() => toast.remove(), 3000);
}

// Load statistics on page load
document.addEventListener('DOMContentLoaded', function() {
    loadStatistics();
    loadAcmeCA();
    loadSettings();
    
    // Handle form submission success
    const form = document.getElementById('acme-settings-form');
    if (form) {
        form.addEventListener('htmx:afterRequest', function(event) {
            if (event.detail.successful) {
                showToast('ACME settings saved successfully', 'success');
                loadAcmeCA();
            }
        });
    }
});

function loadStatistics() {
    fetch('/api/ui/acme/statistics')
        .then(response => response.json())
        .then(data => {
            document.getElementById('total-accounts').textContent = data.total_accounts || 0;
            document.getElementById('active-orders').textContent = data.active_orders || 0;
            document.getElementById('completed-orders').textContent = data.completed_orders || 0;
            document.getElementById('issued-certs').textContent = data.issued_certs || 0;
        })
        .catch(error => {
            console.error('Error loading statistics:', error);
        });
}

function loadAcmeCA() {
    const badge = document.getElementById('acme-status-badge');
    
    fetch('/api/ui/acme/settings/load')
        .then(response => response.json())
        .then(data => {
            if (data.default_ca) {
                // CA configured - show Active (green)
                badge.className = 'badge badge-success';
                badge.style.fontSize = '0.875rem';
                badge.style.padding = '0.375rem 0.75rem';
                badge.innerHTML = '<i class="bi bi-check-circle-fill"></i> Active';
                
                // Get CA name from the select dropdown which has already loaded CAs
                const caSelect = document.getElementById('acme-default-ca');
                if (caSelect) {
                    // Wait a bit for the CA options to load via HTMX
                    setTimeout(() => {
                        const selectedOption = Array.from(caSelect.options).find(opt => opt.value === data.default_ca);
                        if (selectedOption) {
                            document.getElementById('acme-ca-display').textContent = selectedOption.text;
                        } else {
                            document.getElementById('acme-ca-display').textContent = data.default_ca;
                        }
                    }, 500);
                } else {
                    document.getElementById('acme-ca-display').textContent = data.default_ca;
                }
            } else {
                // No CA configured - show Not Configured (red)
                badge.className = 'badge badge-danger';
                badge.style.fontSize = '0.875rem';
                badge.style.padding = '0.375rem 0.75rem';
                badge.innerHTML = '<i class="bi bi-x-circle-fill"></i> Not Configured';
                document.getElementById('acme-ca-display').textContent = 'No CA configured';
            }
        })
        .catch(error => {
            // Error - show as disabled (red)
            badge.className = 'badge badge-danger';
            badge.style.fontSize = '0.875rem';
            badge.style.padding = '0.375rem 0.75rem';
            badge.innerHTML = '<i class="bi bi-exclamation-circle-fill"></i> Error';
            document.getElementById('acme-ca-display').textContent = 'Error loading CA';
            console.error('Error:', error);
        });
}

function loadSettings() {
    fetch('/api/ui/acme/settings/load')
        .then(response => response.json())
        .then(data => {
            if (data.default_ca) {
                const select = document.getElementById('acme-default-ca');
                // Wait for options to load, then select
                setTimeout(() => {
                    select.value = data.default_ca;
                }, 500);
            }
            if (data.cert_validity) {
                document.querySelector('input[name="cert_validity"]').value = data.cert_validity;
            }
        });
}
</script>
{% endblock %}

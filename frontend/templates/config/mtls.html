{% extends "base.html" %}

{% block title %}mTLS Authentication - UCM{% endblock %}

{% block content %}
<div style="display: flex; flex-direction: column; gap: 1.5rem;">
    <div style="display: flex; justify-content: space-between; align-items: center;">
        <h1 style="font-size: 1.875rem; font-weight: bold; color: var(--text-primary);">
            <svg class="ucm-icon" width="16" height="16" style="margin-right: 0.5rem;"><use href="#icon-shield-check"/></svg> mTLS Authentication
        </h1>
        {% if session.get('role') == 'admin' %}
        <span id="mtls-status-badge" class="badge-outline badge-secondary">
            <svg class="ucm-icon" width="10" height="10" style=" "><use href="#icon-circle"/></svg>
            Checking...
        </span>
        {% endif %}
    </div>

    {% if session.get('role') == 'admin' %}
    <!-- mTLS Configuration (Admin Only) -->
    <div class="card">
        <div style="padding: 1.5rem; border-bottom: 1px solid var(--border-color);">
            <h2 style="font-size: 1.25rem; font-weight: 600; color: var(--text-primary); display: flex; align-items: center; gap: 0.5rem; margin: 0;">
                <svg class="ucm-icon" width="16" height="16" style="color: var(--primary-color);"><use href="#icon-settings"/></svg>
                Global mTLS Settings
            </h2>
        </div>
        <div style="padding: 1.5rem;">
            <div style="background: var(--bg-info); border-left: 4px solid var(--primary-color); padding: 1rem; margin-bottom: 1.5rem; border-radius: 0.25rem;">
                <strong style="color: var(--text-primary);">⚠️ Important:</strong>
                <p style="color: var(--text-secondary); margin: 0.5rem 0 0 0; font-size: 0.875rem;">
                    mTLS requires a reverse proxy (Nginx/Apache) configured to validate client certificates.
                    Without proper reverse proxy configuration, enabling mTLS will have no effect.
                </p>
            </div>

            <form id="mtls-settings-form">
                <div style="display: flex; flex-direction: column; gap: 1.5rem;">
                    <div>
                        <label style="display: flex; align-items: center; gap: 0.75rem; cursor: pointer; font-weight: 500;">
                            <input type="checkbox" id="mtls_enabled">
                            <div>
                                <div style="color: var(--text-primary);">Enable mTLS Authentication</div>
                                <div style="color: var(--text-secondary); font-size: 0.875rem; font-weight: normal;">
                                    Allow users to authenticate with client certificates
                                </div>
                            </div>
                        </label>
                    </div>

                    <div>
                        <label style="display: flex; align-items: center; gap: 0.75rem; cursor: pointer; font-weight: 500;">
                            <input type="checkbox" id="mtls_required">
                            <div>
                                <div style="color: var(--text-primary);">Require Client Certificate</div>
                                <div style="color: var(--text-secondary); font-size: 0.875rem; font-weight: normal;">
                                    Disable password authentication (certificate only)
                                </div>
                            </div>
                        </label>
                    </div>

                    <div>
                        <label class="form-label">Trusted CA Bundle Path (Optional)</label>
                        <input type="text" id="mtls_trusted_ca_path" class="form-input" 
                               placeholder="/etc/ssl/certs/ca-bundle.pem">
                        <small style="color: var(--text-secondary); font-size: 0.75rem;">
                            Path on reverse proxy server to trusted CA certificate bundle
                        </small>
                    </div>

                    <div style="padding-top: 1rem; border-top: 1px solid var(--border-color);">
                        <button type="submit" class="btn btn-primary">
                            <svg class="ucm-icon" width="16" height="16" style="margin-right: 0.5rem;"><use href="#icon-save"/></svg> Save mTLS Settings
                        </button>
                    </div>
                </div>
            </form>
        </div>
    </div>

    <!-- Reverse Proxy Configuration Guide -->
    <div class="card">
        <div style="padding: 1.5rem; border-bottom: 1px solid var(--border-color);">
            <h2 style="font-size: 1.25rem; font-weight: 600; color: var(--text-primary); display: flex; align-items: center; gap: 0.5rem; margin: 0;">
                <svg class="ucm-icon" width="16" height="16" style="color: var(--primary-color);"><use href="#icon-book-open"/></svg>
                Reverse Proxy Configuration
            </h2>
        </div>
        <div style="padding: 1.5rem;">
            <div style="display: grid; gap: 1.5rem;">
                <!-- Nginx Config -->
                <div>
                    <h3 style="font-weight: 600; color: var(--text-primary); margin-bottom: 0.75rem; display: flex; align-items: center; gap: 0.5rem;">
                        <svg class="ucm-icon" width="16" height="16" style="color: var(--success-color);"><use href="#icon-server"/></svg>
                        Nginx Configuration
                    </h3>
                    <pre style="background: var(--card-bg-secondary); padding: 1rem; border-radius: 0.5rem; overflow-x: auto; font-size: 0.875rem; color: var(--text-primary);"><code>server {
    listen 8443 ssl;
    
    # Server certificate
    ssl_certificate /path/to/server.crt;
    ssl_certificate_key /path/to/server.key;
    
    # Client certificate validation
    ssl_client_certificate /path/to/ca-bundle.pem;
    ssl_verify_client optional;  # or 'on' to require
    ssl_verify_depth 2;
    
    location / {
        proxy_pass https://127.0.0.1:5000;
        
        # Forward client certificate info
        proxy_set_header X-SSL-Client-Cert $ssl_client_cert;
        proxy_set_header X-SSL-Client-Verify $ssl_client_verify;
        proxy_set_header X-SSL-Client-S-DN $ssl_client_s_dn;
        proxy_set_header X-SSL-Client-Serial $ssl_client_serial;
    }
}</code></pre>
                </div>

                <!-- Apache Config -->
                <div>
                    <h3 style="font-weight: 600; color: var(--text-primary); margin-bottom: 0.75rem; display: flex; align-items: center; gap: 0.5rem;">
                        <svg class="ucm-icon" width="16" height="16" style="color: var(--danger-color);"><use href="#icon-server"/></svg>
                        Apache Configuration
                    </h3>
                    <pre style="background: var(--card-bg-secondary); padding: 1rem; border-radius: 0.5rem; overflow-x: auto; font-size: 0.875rem; color: var(--text-primary);"><code>&lt;VirtualHost *:8443&gt;
    SSLEngine on
    
    # Server certificate
    SSLCertificateFile /path/to/server.crt
    SSLCertificateKeyFile /path/to/server.key
    
    # Client certificate validation
    SSLCACertificateFile /path/to/ca-bundle.pem
    SSLVerifyClient optional  # or 'require'
    SSLVerifyDepth 2
    
    # Forward client certificate info
    RequestHeader set X-SSL-Client-Cert "%{SSL_CLIENT_CERT}s"
    RequestHeader set X-SSL-Client-Verify "%{SSL_CLIENT_VERIFY}s"
    RequestHeader set X-SSL-Client-S-DN "%{SSL_CLIENT_S_DN}s"
    RequestHeader set X-SSL-Client-M-Serial "%{SSL_CLIENT_M_SERIAL}s"
    
    ProxyPass / https://127.0.0.1:5000/
    ProxyPassReverse / https://127.0.0.1:5000/
&lt;/VirtualHost&gt;</code></pre>
                </div>
            </div>
        </div>
    </div>
    {% endif %}

    <!-- User Certificate Management -->
    <div class="card">
        <div style="padding: 1.5rem; border-bottom: 1px solid var(--border-color); display: flex; justify-content: space-between; align-items: center;">
            <h2 style="font-size: 1.25rem; font-weight: 600; color: var(--text-primary); display: flex; align-items: center; gap: 0.5rem; margin: 0;">
                <svg class="ucm-icon" width="16" height="16" style="color: var(--primary-color);"><use href="#icon-key"/></svg>
                My Certificates
            </h2>
            <button onclick="showEnrollModal()" class="btn btn-primary">
                <svg class="ucm-icon" width="16" height="16" style="margin-right: 0.5rem;"><use href="#icon-plus"/></svg> Enroll Certificate
            </button>
        </div>
        <div style="padding: 1.5rem;">
            <div class="table-responsive">
                <table class="table">
                    <thead>
                        <tr>
                            <th>Name</th>
                            <th>Subject</th>
                            <th>Serial</th>
                            <th>Valid Until</th>
                            <th>Status</th>
                            <th>Actions</th>
                        </tr>
                    </thead>
                    <tbody id="certificates-tbody">
                        <tr>
                            <td colspan="6" style="text-align: center; padding: 2rem; color: var(--text-secondary);">
                                <svg class="ucm-icon" width="32" height="32" style=" opacity: 0.5;"><use href="#icon-key"/></svg>
                                <p style="margin-top: 0.5rem;">Loading certificates...</p>
                            </td>
                        </tr>
                    </tbody>
                </table>
            </div>
        </div>
    </div>
</div>

<!-- Enroll Certificate Modal -->
<div id="enroll-modal" style="display: none; position: fixed; top: 0; left: 0; right: 0; bottom: 0; background: rgba(0,0,0,0.5); z-index: 1000; align-items: center; justify-content: center;">
    <div class="card" style="width: 90%; max-width: 600px; max-height: 90vh; overflow-y: auto; margin: 2rem;">
        <div style="padding: 1.5rem; border-bottom: 1px solid var(--border-color); display: flex; justify-content: space-between; align-items: center;">
            <h3 style="font-size: 1.25rem; font-weight: 600; color: var(--text-primary); margin: 0;">
                Enroll Client Certificate
            </h3>
            <button onclick="hideEnrollModal()" style="background: none; border: none; font-size: 1.5rem; cursor: pointer; color: var(--text-secondary);">×</button>
        </div>
        <div style="padding: 1.5rem;">
            <form id="enroll-form">
                <div style="display: flex; flex-direction: column; gap: 1rem;">
                    <div>
                        <label class="form-label">Certificate Name</label>
                        <input type="text" id="cert_name" class="form-input" placeholder="My YubiKey Certificate">
                        <small style="color: var(--text-secondary); font-size: 0.75rem;">
                            Friendly name to identify this certificate
                        </small>
                    </div>

                    <div>
                        <label class="form-label">Certificate (PEM format) *</label>
                        <textarea id="cert_pem" class="form-input" rows="10" 
                                  placeholder="-----BEGIN CERTIFICATE-----
...
-----END CERTIFICATE-----" required></textarea>
                        <small style="color: var(--text-secondary); font-size: 0.75rem;">
                            Paste your PEM-encoded X.509 certificate here
                        </small>
                    </div>

                    <div style="display: flex; gap: 1rem; padding-top: 1rem;">
                        <button type="button" onclick="validateCertificate()" class="btn btn-outline-secondary">
                            <svg class="ucm-icon" width="16" height="16" style="margin-right: 0.5rem;"><use href="#icon-check-circle"/></svg> Validate
                        </button>
                        <button type="submit" class="btn btn-primary">
                            <svg class="ucm-icon" width="16" height="16" style="margin-right: 0.5rem;"><use href="#icon-save"/></svg> Enroll Certificate
                        </button>
                        <button type="button" onclick="hideEnrollModal()" class="btn btn-outline-secondary">
                            Cancel
                        </button>
                    </div>
                </div>
            </form>

            <div id="cert-validation-result" style="margin-top: 1rem; display: none;"></div>
        </div>
    </div>
</div>

<script>
(function() {
const token = '{{ session.get("access_token") }}';

// Toast helper
function showToast(message, type = 'info') {
    const toast = document.createElement('div');
    toast.style.cssText = `
        position: fixed; top: 20px; right: 20px; z-index: 10000;
        padding: 1rem 1.5rem; border-radius: 0.5rem; box-shadow: 0 4px 12px rgba(0,0,0,0.15);
        background: ${type === 'success' ? '#10b981' : type === 'error' ? '#ef4444' : '#3b82f6'};
        color: white; font-weight: 500; max-width: 400px;
    `;
    toast.textContent = message;
    document.body.appendChild(toast);
    setTimeout(() => toast.remove(), 4000);
}

// Load mTLS settings (admin only)
async function loadMTLSSettings() {
    {% if session.get('role') == 'admin' %}
    try {
        const response = await fetch('/api/v1/mtls/settings', {
            headers: {'Authorization': `Bearer ${token}`}
        });
        
        if (response.ok) {
            const settings = await response.json();
            document.getElementById('mtls_enabled').checked = settings.enabled;
            document.getElementById('mtls_required').checked = settings.required;
            document.getElementById('mtls_trusted_ca_path').value = settings.trusted_ca_path || '';
            
            // Update status badge
            const badge = document.getElementById('mtls-status-badge');
            if (settings.enabled) {
                badge.className = 'badge-outline badge-success';
                badge.innerHTML = '<svg class="ucm-icon" width="10" height="10" style=""><use href="#icon-check-circle"/></svg> Enabled';
            } else {
                badge.className = 'badge-outline badge-secondary';
                badge.innerHTML = '<svg class="ucm-icon" width="10" height="10" style=""><use href="#icon-circle"/></svg> Disabled';
            }
        }
    } catch (error) {
        console.error('Error loading mTLS settings:', error);
    }
    {% endif %}
}

// Save mTLS settings
{% if session.get('role') == 'admin' %}
document.getElementById('mtls-settings-form')?.addEventListener('submit', async (e) => {
    e.preventDefault();
    
    const data = {
        enabled: document.getElementById('mtls_enabled').checked,
        required: document.getElementById('mtls_required').checked,
        trusted_ca_path: document.getElementById('mtls_trusted_ca_path').value
    };
    
    try {
        const response = await fetch('/api/v1/mtls/settings', {
            method: 'POST',
            headers: {
                'Content-Type': 'application/json',
                'Authorization': `Bearer ${token}`
            },
            body: JSON.stringify(data)
        });
        
        const result = await response.json();
        
        if (response.ok) {
            showToast('✓ mTLS settings saved successfully', 'success');
            loadMTLSSettings();
        } else {
            showToast('✗ ' + (result.error || 'Failed to save settings'), 'error');
        }
    } catch (error) {
        showToast('✗ Error: ' + error.message, 'error');
    }
});
{% endif %}

// Load user certificates
async function loadCertificates() {
    try {
        const response = await fetch('/api/v1/mtls/certificates', {
            headers: {'Authorization': `Bearer ${token}`}
        });
        
        if (response.ok) {
            const data = await response.json();
            const tbody = document.getElementById('certificates-tbody');
            
            if (data.certificates.length === 0) {
                tbody.innerHTML = `
                    <tr>
                        <td colspan="6" style="text-align: center; padding: 2rem; color: var(--text-secondary);">
                            <svg class="ucm-icon" width="32" height="32" style=" opacity: 0.5;"><use href="#icon-key"/></svg>
                            <p style="margin-top: 0.5rem;">No certificates enrolled</p>
                            <button onclick="showEnrollModal()" class="btn btn-sm btn-primary" style="margin-top: 1rem;">
                                <svg class="ucm-icon" width="16" height="16" style="margin-right: 0.5rem;"><use href="#icon-plus"/></svg> Enroll Your First Certificate
                            </button>
                        </td>
                    </tr>
                `;
                return;
            }
            
            tbody.innerHTML = data.certificates.map(cert => {
                const validUntil = cert.valid_until ? new Date(cert.valid_until) : null;
                const isExpired = validUntil && validUntil < new Date();
                const daysLeft = validUntil ? Math.ceil((validUntil - new Date()) / (1000 * 60 * 60 * 24)) : null;
                
                return `
                    <tr>
                        <td><strong>${cert.name || 'Unnamed'}</strong></td>
                        <td style="max-width: 300px; overflow: hidden; text-overflow: ellipsis;">${cert.cert_subject}</td>
                        <td><code style="font-size: 0.875rem;">${cert.cert_serial.substring(0, 16)}...</code></td>
                        <td>
                            ${validUntil ? validUntil.toLocaleDateString() : 'N/A'}
                            ${daysLeft !== null && daysLeft < 30 ? `<br><small style="color: var(--warning-color);">${daysLeft} days left</small>` : ''}
                        </td>
                        <td>
                            ${cert.enabled 
                                ? (isExpired 
                                    ? '<span class="badge-outline badge-danger"><svg class="ucm-icon" width="10" height="10" style=""><use href="#icon-times"/></svg> Expired</span>'
                                    : '<span class="badge-outline badge-success"><svg class="ucm-icon" width="10" height="10" style=""><use href="#icon-check"/></svg> Active</span>')
                                : '<span class="badge-outline badge-secondary"><svg class="ucm-icon" width="10" height="10" style=""><use href="#icon-times"/></svg> Disabled</span>'
                            }
                        </td>
                        <td>
                            <div style="display: flex; gap: 0.5rem;">
                                ${cert.enabled 
                                    ? `<button onclick="revokeCertificate(${cert.id})" class="btn btn-sm btn-outline-warning">Revoke</button>`
                                    : `<button onclick="enableCertificate(${cert.id})" class="btn btn-sm btn-outline-success">Enable</button>`
                                }
                                <button onclick="deleteCertificate(${cert.id})" class="btn btn-sm btn-outline-danger">Delete</button>
                            </div>
                        </td>
                    </tr>
                `;
            }).join('');
        }
    } catch (error) {
        console.error('Error loading certificates:', error);
    }
}

// Modal functions
function showEnrollModal() {
    document.getElementById('enroll-modal').style.display = 'flex';
    document.getElementById('cert-validation-result').style.display = 'none';
}

function hideEnrollModal() {
    document.getElementById('enroll-modal').style.display = 'none';
    document.getElementById('enroll-form').reset();
    document.getElementById('cert-validation-result').style.display = 'none';
}

// Validate certificate
async function validateCertificate() {
    const certPem = document.getElementById('cert_pem').value;
    
    if (!certPem) {
        showToast('Please paste a certificate first', 'error');
        return;
    }
    
    try {
        const response = await fetch('/api/v1/mtls/validate-certificate', {
            method: 'POST',
            headers: {
                'Content-Type': 'application/json',
                'Authorization': `Bearer ${token}`
            },
            body: JSON.stringify({certificate: certPem})
        });
        
        const result = await response.json();
        const resultDiv = document.getElementById('cert-validation-result');
        
        if (response.ok && result.success) {
            const info = result.info;
            resultDiv.style.display = 'block';
            resultDiv.innerHTML = `
                <div style="background: ${result.valid ? 'var(--bg-success)' : 'var(--bg-danger)'}; padding: 1rem; border-radius: 0.5rem; border-left: 4px solid ${result.valid ? 'var(--success-color)' : 'var(--danger-color)'};">
                    <strong>${result.valid ? '✓ Valid Certificate' : '✗ Invalid Certificate'}</strong>
                    ${result.already_enrolled ? '<p style="color: var(--warning-color); margin-top: 0.5rem;"><strong>⚠️ Certificate already enrolled</strong></p>' : ''}
                    <div style="margin-top: 1rem; font-size: 0.875rem;">
                        <p><strong>Subject:</strong> ${info.subject}</p>
                        <p><strong>Issuer:</strong> ${info.issuer}</p>
                        <p><strong>Serial:</strong> <code>${info.serial}</code></p>
                        <p><strong>Valid From:</strong> ${info.valid_from ? new Date(info.valid_from).toLocaleString() : 'N/A'}</p>
                        <p><strong>Valid Until:</strong> ${info.valid_until ? new Date(info.valid_until).toLocaleString() : 'N/A'}</p>
                    </div>
                </div>
            `;
        } else {
            resultDiv.style.display = 'block';
            resultDiv.innerHTML = `
                <div style="background: var(--bg-danger); padding: 1rem; border-radius: 0.5rem; border-left: 4px solid var(--danger-color);">
                    <strong>✗ Validation Failed</strong>
                    <p style="margin-top: 0.5rem;">${result.error || 'Unknown error'}</p>
                </div>
            `;
        }
    } catch (error) {
        showToast('✗ Validation error: ' + error.message, 'error');
    }
}

// Enroll certificate
document.getElementById('enroll-form').addEventListener('submit', async (e) => {
    e.preventDefault();
    
    const certPem = document.getElementById('cert_pem').value;
    const name = document.getElementById('cert_name').value;
    
    try {
        const response = await fetch('/api/v1/mtls/certificates/enroll', {
            method: 'POST',
            headers: {
                'Content-Type': 'application/json',
                'Authorization': `Bearer ${token}`
            },
            body: JSON.stringify({
                certificate: certPem,
                name: name
            })
        });
        
        const result = await response.json();
        
        if (response.ok) {
            showToast('✓ Certificate enrolled successfully', 'success');
            hideEnrollModal();
            loadCertificates();
        } else {
            showToast('✗ ' + (result.error || 'Failed to enroll certificate'), 'error');
        }
    } catch (error) {
        showToast('✗ Error: ' + error.message, 'error');
    }
});

// Revoke certificate
async function revokeCertificate(certId) {
    const confirmed = await ucmConfirm(
        'Are you sure you want to revoke this certificate? You can re-enable it later.',
        'Revoke Certificate',
        { danger: true, confirmText: 'Revoke', icon: 'warning-triangle' }
    );
    
    if (!confirmed) return;
    
    try {
        const response = await fetch(`/api/v1/mtls/certificates/${certId}/revoke`, {
            method: 'POST',
            headers: {'Authorization': `Bearer ${token}`}
        });
        
        const result = await response.json();
        
        if (response.ok) {
            showToast('✓ Certificate revoked', 'success');
            loadCertificates();
        } else {
            showToast('✗ ' + (result.error || 'Failed to revoke'), 'error');
        }
    } catch (error) {
        showToast('✗ Error: ' + error.message, 'error');
    }
}

// Enable certificate
async function enableCertificate(certId) {
    try {
        const response = await fetch(`/api/v1/mtls/certificates/${certId}/enable`, {
            method: 'POST',
            headers: {'Authorization': `Bearer ${token}`}
        });
        
        const result = await response.json();
        
        if (response.ok) {
            showToast('✓ Certificate enabled', 'success');
            loadCertificates();
        } else {
            showToast('✗ ' + (result.error || 'Failed to enable'), 'error');
        }
    } catch (error) {
        showToast('✗ Error: ' + error.message, 'error');
    }
}

// Delete certificate
async function deleteCertificate(certId) {
    const confirmed = await ucmConfirm(
        'Are you sure you want to permanently delete this certificate? This action cannot be undone.',
        'Delete Certificate',
        { danger: true, confirmText: 'Delete', icon: 'trash' }
    );
    
    if (!confirmed) return;
    
    try {
        const response = await fetch(`/api/v1/mtls/certificates/${certId}`, {
            method: 'DELETE',
            headers: {'Authorization': `Bearer ${token}`}
        });
        
        const result = await response.json();
        
        if (response.ok) {
            showToast('✓ Certificate deleted', 'success');
            loadCertificates();
        } else {
            showToast('✗ ' + (result.error || 'Failed to delete'), 'error');
        }
    } catch (error) {
        showToast('✗ Error: ' + error.message, 'error');
    }
}

// Initialize
document.addEventListener('DOMContentLoaded', () => {
    loadMTLSSettings();
    loadCertificates();
});
})();
</script>
{% endblock %}

{% extends "base.html" %}

{% block title %}mTLS Authentication - UCM{% endblock %}

{% block content %}
<div style="display: flex; flex-direction: column; gap: 1.5rem;">
    <!-- Page Header -->
    <div style="display: flex; justify-content: space-between; align-items: center;">
        <h1 style="font-size: 1.875rem; font-weight: 600; color: var(--text-primary); margin: 0; display: flex; align-items: center; gap: 0.5rem;">
            <svg class="ucm-icon" width="24" height="24"><use href="#icon-shield-check"/></svg>
            <span>mTLS Authentication</span>
        </h1>
        <span id="mtls-status-badge" class="badge-outline badge-secondary">
            <svg class="ucm-icon" width="10" height="10"><use href="#icon-circle"/></svg>
            Checking...
        </span>
    </div>

    {% if session.get('role') == 'admin' %}
    <!-- ========================================= -->
    <!-- SECTION 1: ADMIN CONFIGURATION -->
    <!-- ========================================= -->
    <div class="card" style="padding: 0;">
        <div class="card-header">
            <h2 style="font-size: 1.25rem; font-weight: 600; color: var(--text-primary); display: flex; align-items: center; gap: 0.5rem; margin: 0;">
                <svg class="ucm-icon" width="16" height="16" style="color: var(--primary-color);"><use href="#icon-settings"/></svg>
                Administrator Settings
            </h2>
        </div>
        <div style="padding: 1.5rem;">
            <!-- Warning box - shown when mTLS is disabled -->
            <div id="mtls-disabled-warning" style="background: var(--warning-bg); border-left: 4px solid var(--warning-color); padding: 1.25rem; margin-bottom: 1.5rem; border-radius: 0.25rem; display: none;">
                <div style="display: flex; align-items: start; gap: 0.75rem;">
                    <svg class="ucm-icon" width="20" height="20" style="color: var(--warning-color); flex-shrink: 0; margin-top: 2px;"><use href="#icon-alert-triangle"/></svg>
                    <div style="flex: 1;">
                        <strong style="color: var(--text-primary); display: block; margin-bottom: 0.5rem;">⚠️ Important: Reverse Proxy Required</strong>
                        <p style="color: var(--text-secondary); margin: 0; font-size: 0.875rem; line-height: 1.6;">
                            mTLS client certificate authentication <strong>requires a reverse proxy</strong> (Nginx or Apache) to function properly.
                            The UCM application server cannot request client certificates from browsers directly.
                        </p>
                        <div style="margin-top: 0.75rem; padding: 0.75rem; background: var(--card-bg); border-radius: 0.25rem;">
                            <p style="color: var(--text-primary); margin: 0 0 0.5rem 0; font-size: 0.875rem; font-weight: 500;">Without reverse proxy:</p>
                            <ul style="margin: 0; padding-left: 1.25rem; color: var(--text-secondary); font-size: 0.875rem; line-height: 1.6;">
                                <li>✅ Users can still <strong>create</strong> and <strong>manage</strong> client certificates</li>
                                <li>✅ Certificates work for <strong>API authentication</strong> (curl, scripts)</li>
                                <li>❌ Browsers will <strong>not be prompted</strong> for certificates</li>
                                <li>❌ Auto-login via certificate will <strong>not work</strong> in browsers</li>
                                <li>✅ Password authentication remains <strong>fully functional</strong></li>
                            </ul>
                        </div>
                        <p style="color: var(--text-secondary); margin: 0.75rem 0 0 0; font-size: 0.875rem;">
                            <strong>After enabling:</strong> See the configuration guide below for complete Nginx/Apache setup instructions.
                        </p>
                    </div>
                </div>
            </div>
            
            <!-- Success box - shown when mTLS is enabled with CA configured -->
            <div id="mtls-enabled-info" style="background: var(--success-bg); border-left: 4px solid var(--success-color); padding: 1.25rem; margin-bottom: 1.5rem; border-radius: 0.25rem; display: none;">
                <div style="display: flex; align-items: start; gap: 0.75rem;">
                    <svg class="ucm-icon" width="20" height="20" style="color: var(--success-color); flex-shrink: 0; margin-top: 2px;"><use href="#icon-check-circle"/></svg>
                    <div style="flex: 1;">
                        <strong style="color: var(--text-primary); display: block; margin-bottom: 0.5rem;">✓ mTLS Enabled</strong>
                        <p style="color: var(--text-secondary); margin: 0; font-size: 0.875rem; line-height: 1.6;">
                            Client certificate authentication is enabled. See the <strong>Reverse Proxy Configuration</strong> section below for setup instructions.
                        </p>
                        <div id="ca-download-section" style="margin-top: 0.75rem; padding: 0.75rem; background: var(--card-bg); border-radius: 0.25rem; display: none;">
                            <p style="color: var(--text-primary); margin: 0 0 0.5rem 0; font-size: 0.875rem; font-weight: 500;">Trusted CA:</p>
                            <div style="display: flex; align-items: center; gap: 0.75rem; flex-wrap: wrap;">
                                <span id="ca-name" style="color: var(--text-primary); font-weight: 500;"></span>
                                <button type="button" id="download-ca-btn" class="btn-outline btn-sm">
                                    <svg class="ucm-icon" width="14" height="14"><use href="#icon-download"/></svg>
                                    Download CA Certificate
                                </button>
                            </div>
                        </div>
                    </div>
                </div>
            </div>

            <form id="mtls-settings-form">
                <div style="display: flex; flex-direction: column; gap: 1.5rem;">
                    <!-- Enable mTLS -->
                    <div>
                        <label style="display: flex; align-items: center; gap: 0.75rem; cursor: pointer; font-weight: 500;">
                            <input type="checkbox" id="mtls_enabled">
                            <div>
                                <div style="color: var(--text-primary);">Enable mTLS Authentication</div>
                                <div style="color: var(--text-secondary); font-size: 0.875rem; font-weight: normal;">
                                    Allow users to authenticate using client certificates
                                </div>
                            </div>
                        </label>
                    </div>

                    <!-- Require Certificate -->
                    <div id="mtls-require-wrapper" style="display: none;">
                        <label style="display: flex; align-items: center; gap: 0.75rem; cursor: pointer; font-weight: 500;">
                            <input type="checkbox" id="mtls_required">
                            <div>
                                <div style="color: var(--text-primary);">Require Client Certificate</div>
                                <div style="color: var(--text-secondary); font-size: 0.875rem; font-weight: normal;">
                                    Disable password authentication (certificate only)
                                </div>
                            </div>
                        </label>
                    </div>

                    <!-- Trusted CA Selection -->
                    <div id="mtls-ca-wrapper" style="display: none;">
                        <label class="form-label">Trusted CA for Client Certificates</label>
                        <select id="mtls_trusted_ca_id" class="form-control">
                            <option value="">None - Users can use self-signed or any valid certificate</option>
                        </select>
                        <small style="color: var(--text-secondary); font-size: 0.75rem; display: block; margin-top: 0.5rem;">
                            <strong>If CA selected:</strong> Users must create/import certificates signed by this CA<br>
                            <strong>If None:</strong> Users can create self-signed certificates or import any valid certificate
                        </small>
                    </div>

                    <div style="padding-top: 1rem; border-top: 1px solid var(--border-color);">
                        <button type="submit" class="btn-primary">
                            <svg class="ucm-icon" width="16" height="16"><use href="#icon-save"/></svg> 
                            Save Settings
                        </button>
                    </div>
                </div>
            </form>
        </div>
    </div>

    <!-- Reverse Proxy Configuration Guide -->
    <div class="card" style="padding: 0;">
        <div class="card-header">
            <h2 style="font-size: 1.25rem; font-weight: 600; color: var(--text-primary); display: flex; align-items: center; gap: 0.5rem; margin: 0;">
                <svg class="ucm-icon" width="16" height="16" style="color: var(--primary-color);"><use href="#icon-book-open"/></svg>
                Reverse Proxy Configuration Guide
            </h2>
        </div>
        <div style="padding: 1.5rem;">
            <div style="display: grid; gap: 1.5rem;">
                <!-- Nginx -->
                <div>
                    <div style="display: flex; justify-content: space-between; align-items: center; margin-bottom: 0.75rem;">
                        <h3 style="font-weight: 600; color: var(--text-primary); margin: 0; display: flex; align-items: center; gap: 0.5rem;">
                            <svg class="ucm-icon" width="16" height="16" style="color: var(--success-color);"><use href="#icon-server"/></svg>
                            Nginx Configuration
                        </h3>
                        <button type="button" onclick="copyToClipboard('nginx-config-code', 'Nginx config')" class="btn-outline btn-sm">
                            <svg class="ucm-icon" width="14" height="14"><use href="#icon-copy"/></svg>
                            Copy
                        </button>
                    </div>
                    <pre style="background: var(--card-bg-secondary); padding: 1rem; border-radius: 0.5rem; overflow-x: auto; font-size: 0.875rem; color: var(--text-primary);"><code id="nginx-config-code">Loading...</code></pre>
                    <div style="margin-top: 0.75rem; padding: 0.75rem; background: rgba(59, 130, 246, 0.1); border-radius: 0.25rem;">
                        <p style="color: var(--text-secondary); margin: 0; font-size: 0.8125rem; line-height: 1.5;">
                            <strong>Steps:</strong><br>
                            1. Download the CA certificate above<br>
                            2. Save as <code>/etc/ssl/certs/ucm-client-ca.pem</code><br>
                            3. Add this configuration to Nginx<br>
                            4. Reload Nginx: <code>sudo nginx -s reload</code>
                        </p>
                    </div>
                </div>

                <!-- Apache -->
                <div>
                    <div style="display: flex; justify-content: space-between; align-items: center; margin-bottom: 0.75rem;">
                        <h3 style="font-weight: 600; color: var(--text-primary); margin: 0; display: flex; align-items: center; gap: 0.5rem;">
                            <svg class="ucm-icon" width="16" height="16" style="color: var(--danger-color);"><use href="#icon-server"/></svg>
                            Apache Configuration
                        </h3>
                        <button type="button" onclick="copyToClipboard('apache-config-code', 'Apache config')" class="btn-outline btn-sm">
                            <svg class="ucm-icon" width="14" height="14"><use href="#icon-copy"/></svg>
                            Copy
                        </button>
                    </div>
                    <pre style="background: var(--card-bg-secondary); padding: 1rem; border-radius: 0.5rem; overflow-x: auto; font-size: 0.875rem; color: var(--text-primary);"><code id="apache-config-code">Loading...</code></pre>
                    <div style="margin-top: 0.75rem; padding: 0.75rem; background: rgba(59, 130, 246, 0.1); border-radius: 0.25rem;">
                        <p style="color: var(--text-secondary); margin: 0; font-size: 0.8125rem; line-height: 1.5;">
                            <strong>Steps:</strong><br>
                            1. Download the CA certificate above<br>
                            2. Save as <code>/etc/ssl/certs/ucm-client-ca.pem</code><br>
                            3. Add this configuration to Apache<br>
                            4. Reload Apache: <code>sudo systemctl reload apache2</code>
                        </p>
                    </div>
                </div>
    # Server certificate
    SSLCertificateFile /path/to/server.crt
    SSLCertificateKeyFile /path/to/server.key
    
    # Client certificate validation
    # Export your trusted CA from UCM and reference it here
    SSLCACertificateFile /path/to/trusted-ca.pem
    SSLVerifyClient optional  # or 'require'
    SSLVerifyDepth 2
    
    # Forward client certificate info
    RequestHeader set X-SSL-Client-Cert "%{SSL_CLIENT_CERT}s"
    RequestHeader set X-SSL-Client-Verify "%{SSL_CLIENT_VERIFY}s"
    RequestHeader set X-SSL-Client-S-DN "%{SSL_CLIENT_S_DN}s"
    RequestHeader set X-SSL-Client-M-Serial "%{SSL_CLIENT_M_SERIAL}s"
    
    ProxyPass / https://127.0.0.1:5000/
    ProxyPassReverse / https://127.0.0.1:5000/
&lt;/VirtualHost&gt;</code></pre>
                </div>
            </div>
        </div>
    </div>
    {% endif %}

    <!-- ========================================= -->
    <!-- SECTION 2: USER CERTIFICATES -->
    <!-- ========================================= -->
    <div id="user-section" style="display: none;">
        <div class="card" style="padding: 0;">
            <div class="card-header">
                <h2 style="font-size: 1.25rem; font-weight: 600; color: var(--text-primary); display: flex; align-items: center; gap: 0.5rem; margin: 0;">
                    <svg class="ucm-icon" width="16" height="16" style="color: var(--primary-color);"><use href="#icon-key"/></svg>
                    My Client Certificates
                </h2>
            </div>

            <!-- Tabs -->
            <div class="tabs-container" style="display: flex; gap: 0; margin-bottom: 2rem; border-bottom: 2px solid var(--border-color);">
                <button class="tab-button active" onclick="ucm_switchTab('create')" id="btn-tab-create" style="padding: 1rem 2rem; font-size: 0.95rem; font-weight: 600; color: var(--primary-color); border-bottom: 3px solid var(--primary-color); background: none; border-top: none; border-left: none; border-right: none; cursor: pointer; min-height: 3.5rem;">
                    <svg class="ucm-icon" width="20" height="20" style="margin-right: 8px;"><use href="#icon-plus"/></svg>
                    Create
                </button>
                <button class="tab-button" onclick="ucm_switchTab('import')" id="btn-tab-import" style="padding: 1rem 2rem; font-size: 0.95rem; font-weight: 500; color: var(--text-secondary); border-bottom: 3px solid transparent; background: none; border-top: none; border-left: none; border-right: none; cursor: pointer; min-height: 3.5rem;">
                    <svg class="ucm-icon" width="20" height="20" style="margin-right: 8px;"><use href="#icon-upload"/></svg>
                    Import
                </button>
                <button class="tab-button" onclick="ucm_switchTab('manage'); loadCertificates()" id="btn-tab-manage" style="padding: 1rem 2rem; font-size: 0.95rem; font-weight: 500; color: var(--text-secondary); border-bottom: 3px solid transparent; background: none; border-top: none; border-left: none; border-right: none; cursor: pointer; min-height: 3.5rem;">
                    <svg class="ucm-icon" width="20" height="20" style="margin-right: 8px;"><use href="#icon-inbox"/></svg>
                    Manage
                </button>
            </div>

            <!-- Tab Content -->
            <div style="padding: 1.5rem;">
                <!-- TAB 1: Create Certificate -->
                <div id="tab-create" class="tab-content">
                    <div id="create-with-ca" style="display: none;">
                        <div style="background: var(--success-bg); padding: 1rem; border-radius: 0.5rem; margin-bottom: 1.5rem; border-left: 4px solid var(--success-color);">
                            <strong style="color: var(--text-primary);">✓ Managed Certificate</strong>
                            <p style="color: var(--text-secondary); margin: 0.5rem 0 0 0; font-size: 0.875rem;">
                                Your certificate will be signed by: <strong id="ca-name-display"></strong>
                            </p>
                        </div>

                        <form id="create-managed-cert-form">
                            <div style="display: flex; flex-direction: column; gap: 1rem;">
                                <div>
                                    <label class="form-label">Common Name (CN) *</label>
                                    <input type="text" id="create_cn" class="form-control" placeholder="john.doe" required>
                                    <small style="color: var(--text-secondary); font-size: 0.75rem;">Your username or identifier</small>
                                </div>

                                <div>
                                    <label class="form-label">Email Address</label>
                                    <input type="email" id="create_email" class="form-control" placeholder="john.doe@company.com">
                                </div>

                                <div>
                                    <label class="form-label">Validity (days)</label>
                                    <input type="number" id="create_validity" class="form-control" value="365" min="1" max="3650">
                                </div>

                                <div style="padding-top: 1rem; border-top: 1px solid var(--border-color);">
                                    <button type="submit" class="btn-primary">
                                        <svg class="ucm-icon" width="16" height="16"><use href="#icon-key"/></svg>
                                        Generate Certificate
                                    </button>
                                </div>
                            </div>
                        </form>
                    </div>

                    <div id="create-self-signed" style="display: none;">
                        <div style="background: var(--warning-bg); padding: 1rem; border-radius: 0.5rem; margin-bottom: 1.5rem; border-left: 4px solid var(--warning-color);">
                            <strong style="color: var(--text-primary);">⚠️ Self-Signed Certificate</strong>
                            <p style="color: var(--text-secondary); margin: 0.5rem 0 0 0; font-size: 0.875rem;">
                                Your certificate will be self-signed and not managed by UCM
                            </p>
                        </div>

                        <form id="create-selfsigned-cert-form">
                            <div style="display: flex; flex-direction: column; gap: 1rem;">
                                <div>
                                    <label class="form-label">Common Name (CN) *</label>
                                    <input type="text" id="selfsigned_cn" class="form-control" placeholder="john.doe" required>
                                </div>

                                <div>
                                    <label class="form-label">Email Address</label>
                                    <input type="email" id="selfsigned_email" class="form-control" placeholder="john.doe@company.com">
                                </div>

                                <div style="display: grid; grid-template-columns: 1fr 1fr; gap: 1rem;">
                                    <div>
                                        <label class="form-label">Validity (days)</label>
                                        <input type="number" id="selfsigned_validity" class="form-control" value="365" min="1" max="3650">
                                    </div>
                                    <div>
                                        <label class="form-label">Key Size</label>
                                        <select id="selfsigned_keysize" class="form-control">
                                            <option value="2048">2048 bits</option>
                                            <option value="3072">3072 bits</option>
                                            <option value="4096" selected>4096 bits</option>
                                        </select>
                                    </div>
                                </div>

                                <div style="padding-top: 1rem; border-top: 1px solid var(--border-color);">
                                    <button type="submit" class="btn-primary">
                                        <svg class="ucm-icon" width="16" height="16"><use href="#icon-key"/></svg>
                                        Generate Self-Signed Certificate
                                    </button>
                                </div>
                            </div>
                        </form>
                    </div>
                </div>

                <!-- TAB 2: Import Certificate -->
                <div id="tab-import" class="tab-content" style="display: none;">
                    <div id="import-info-ca" style="display: none; background: rgba(59, 130, 246, 0.1); padding: 1rem; border-radius: 0.5rem; margin-bottom: 1.5rem; border-left: 4px solid var(--info-color);">
                        <strong style="color: var(--text-primary);">ℹ️ Validation Required</strong>
                        <p style="color: var(--text-secondary); margin: 0.5rem 0 0 0; font-size: 0.875rem;">
                            Imported certificates must be signed by: <strong id="import-ca-name-display"></strong>
                        </p>
                    </div>

                    <div id="import-info-any" style="display: none; background: var(--warning-bg); padding: 1rem; border-radius: 0.5rem; margin-bottom: 1.5rem; border-left: 4px solid var(--warning-color);">
                        <strong style="color: var(--text-primary);">⚠️ Any Valid Certificate</strong>
                        <p style="color: var(--text-secondary); margin: 0.5rem 0 0 0; font-size: 0.875rem;">
                            You can import any valid X.509 certificate
                        </p>
                    </div>

                    <form id="import-cert-form">
                        <div style="display: flex; flex-direction: column; gap: 1rem;">
                            <div>
                                <label class="form-label">Certificate Name (Optional)</label>
                                <input type="text" id="import_name" class="form-control" placeholder="My YubiKey Certificate">
                                <small style="color: var(--text-secondary); font-size: 0.75rem;">Friendly name to identify this certificate</small>
                            </div>

                            <div>
                                <label class="form-label">Certificate (PEM format) *</label>
                                <textarea id="import_cert_pem" class="form-control" rows="12" 
                                          placeholder="-----BEGIN CERTIFICATE-----
...
-----END CERTIFICATE-----" required></textarea>
                            </div>

                            <div style="display: flex; gap: 1rem;">
                                <button type="button" onclick="validateImportedCert()" class="btn btn-outline-secondary">
                                    <svg class="ucm-icon" width="16" height="16"><use href="#icon-check-circle"/></svg>
                                    Validate Certificate
                                </button>
                                <button type="submit" class="btn-primary">
                                    <svg class="ucm-icon" width="16" height="16"><use href="#icon-upload"/></svg>
                                    Import Certificate
                                </button>
                            </div>
                        </div>
                    </form>

                    <div id="import-validation-result" style="margin-top: 1rem; display: none;"></div>
                </div>

                <!-- TAB 3: Manage Certificates -->
                <div id="tab-manage" class="tab-content" style="display: none;">
                    <div class="table-responsive">
                        <table class="table">
                            <thead>
                                <tr>
                                    <th>Name</th>
                                    <th>Subject</th>
                                    <th>Serial</th>
                                    <th>Valid Until</th>
                                    <th>Status</th>
                                    <th>Actions</th>
                                </tr>
                            </thead>
                            <tbody id="certificates-tbody">
                                <tr>
                                    <td colspan="6" style="text-align: center; padding: 2rem; color: var(--text-secondary);">
                                        <svg class="ucm-icon" width="32" height="32" style="opacity: 0.5;"><use href="#icon-key"/></svg>
                                        <p style="margin-top: 0.5rem;">Loading certificates...</p>
                                    </td>
                                </tr>
                            </tbody>
                        </table>
                    </div>
                </div>
            </div>
        </div>
    </div>

    <!-- mTLS Disabled Message -->
    <div id="mtls-disabled-message" style="display: none;">
        <div class="card" style="padding: 0;">
            <div style="padding: 3rem; text-align: center;">
                <svg class="ucm-icon" width="64" height="64" style="opacity: 0.3; margin-bottom: 1rem;"><use href="#icon-shield-check"/></svg>
                <h3 style="color: var(--text-primary); margin-bottom: 0.5rem;">mTLS Authentication is Disabled</h3>
                <p style="color: var(--text-secondary);">
                    {% if session.get('role') == 'admin' %}
                    Enable mTLS in the settings above to allow certificate-based authentication.
                    {% else %}
                    Contact your administrator to enable mTLS authentication.
                    {% endif %}
                </p>
            </div>
        </div>
    </div>
</div>

<script>
(function() {
const token = '{{ session.get("access_token") }}';
let currentSettings = {};

// Toast helper
function showToast(message, type = 'info') {
    const toast = document.createElement('div');
    toast.style.cssText = `
        position: fixed; top: 20px; right: 20px; z-index: 10000;
        padding: 1rem 1.5rem; border-radius: 0.5rem; box-shadow: 0 4px 12px rgba(0,0,0,0.15);
        background: ${type === 'success' ? 'var(--success-color)' : type === 'error' ? 'var(--danger-color)' : 'var(--info-color)'};
        color: white; font-weight: 500; max-width: 400px;
    `;
    toast.textContent = message;
    document.body.appendChild(toast);
    setTimeout(() => toast.remove(), 4000);
}

// Copy to clipboard
function copyToClipboard(elementId, name) {
    const element = document.getElementById(elementId);
    if (!element) return;
    
    navigator.clipboard.writeText(element.textContent).then(() => {
        showToast(`✓ ${name} copied to clipboard`, 'success');
    }).catch(err => {
        showToast(`✗ Failed to copy: ${err.message}`, 'error');
    });
}

// Tab switching - Handled by ucm_switchTab global function
// document.querySelectorAll('.tab-button').forEach(btn => ... removed ...);

// Load mTLS settings
async function loadMTLSSettings() {
    try {
        {% if session.get('role') == 'admin' %}
        // Load CA list
        const casResponse = await fetch('/api/v1/ca', {
            headers: {'Authorization': `Bearer ${token}`}
        });
        
        if (casResponse.ok) {
            const casData = await casResponse.json();
            const select = document.getElementById('mtls_trusted_ca_id');
            
            casData.forEach(ca => {
                const option = document.createElement('option');
                option.value = ca.refid;
                option.textContent = `${ca.descr}`;
                select.appendChild(option);
            });
        }
        {% endif %}
        
        // Load current settings
        const response = await fetch('/api/v1/mtls/settings', {
            headers: {'Authorization': `Bearer ${token}`}
        });
        
        if (response.ok) {
            currentSettings = await response.json();
            
            {% if session.get('role') == 'admin' %}
            document.getElementById('mtls_enabled').checked = currentSettings.enabled;
            document.getElementById('mtls_required').checked = currentSettings.required;
            document.getElementById('mtls_trusted_ca_id').value = currentSettings.trusted_ca_id || '';
            
            // Show/hide dependent fields
            toggleMTLSFields();
            
            // Update status badge
            const badge = document.getElementById('mtls-status-badge');
            if (currentSettings.enabled) {
                badge.className = 'badge-outline badge-success';
                badge.innerHTML = '<svg class="ucm-icon" width="10" height="10"><use href="#icon-check-circle"/></svg> Enabled';
            } else {
                badge.className = 'badge-outline badge-secondary';
                badge.innerHTML = '<svg class="ucm-icon" width="10" height="10"><use href="#icon-circle"/></svg> Disabled';
            }
            {% endif %}
            
            // Show/hide user section
            updateUserSection();
        }
    } catch (error) {
        console.error('Error loading mTLS settings:', error);
    }
}

// Toggle admin fields based on enabled state
function toggleMTLSFields() {
    const enabled = document.getElementById('mtls_enabled').checked;
    const trustedCaId = document.getElementById('mtls_trusted_ca_id').value;
    
    // Show/hide dependent fields
    document.getElementById('mtls-require-wrapper').style.display = enabled ? 'block' : 'none';
    document.getElementById('mtls-ca-wrapper').style.display = enabled ? 'block' : 'none';
    
    // Show/hide warning boxes
    const disabledWarning = document.getElementById('mtls-disabled-warning');
    const enabledInfo = document.getElementById('mtls-enabled-info');
    const caDownloadSection = document.getElementById('ca-download-section');
    
    if (enabled) {
        disabledWarning.style.display = 'none';
        enabledInfo.style.display = 'block';
        
        // Show CA download if CA is selected
        if (trustedCaId) {
            caDownloadSection.style.display = 'block';
            // Update CA name
            const selectedOption = document.getElementById('mtls_trusted_ca_id').selectedOptions[0];
            if (selectedOption) {
                document.getElementById('ca-name').textContent = selectedOption.textContent;
            }
        } else {
            caDownloadSection.style.display = 'none';
        }
    } else {
        disabledWarning.style.display = 'block';
        enabledInfo.style.display = 'none';
    }
    
    // Update configuration examples
    updateConfigExamples();
}

// Update configuration examples with real values
function updateConfigExamples() {
    const enabled = document.getElementById('mtls_enabled').checked;
    const required = document.getElementById('mtls_required').checked;
    const trustedCaId = document.getElementById('mtls_trusted_ca_id').value;
    
    // Get current hostname and port
    const hostname = window.location.hostname;
    const port = window.location.port || '8443';
    
    // Determine verify mode
    const nginxVerifyMode = required ? 'on' : 'optional';
    const apacheVerifyMode = required ? 'require' : 'optional';
    
    // Update Nginx example
    const nginxCode = document.getElementById('nginx-config-code');
    if (nginxCode) {
        nginxCode.textContent = `server {
    listen ${port} ssl;
    server_name ${hostname};
    
    # Server SSL certificate
    ssl_certificate /etc/ssl/certs/ucm-server.crt;
    ssl_certificate_key /etc/ssl/private/ucm-server.key;
    
    # Client certificate verification${trustedCaId ? '' : ' (DISABLED - No CA selected)'}
    ${trustedCaId ? `ssl_client_certificate /etc/ssl/certs/ucm-client-ca.pem;
    ssl_verify_client ${nginxVerifyMode};` : '# ssl_client_certificate /path/to/client-ca.pem;\n    # ssl_verify_client optional;'}
    ssl_verify_depth 2;
    
    location / {
        # Proxy to UCM backend
        proxy_pass https://127.0.0.1:8443;
        proxy_ssl_verify off;  # Backend uses self-signed cert
        
        # Forward client certificate information
        proxy_set_header X-SSL-Client-Verify $ssl_client_verify;
        proxy_set_header X-SSL-Client-S-DN $ssl_client_s_dn;
        proxy_set_header X-SSL-Client-I-DN $ssl_client_i_dn;
        proxy_set_header X-SSL-Client-Serial $ssl_client_serial;
        proxy_set_header X-SSL-Client-Cert $ssl_client_escaped_cert;
        
        # Standard proxy headers
        proxy_set_header Host $host;
        proxy_set_header X-Real-IP $remote_addr;
        proxy_set_header X-Forwarded-For $proxy_add_x_forwarded_for;
        proxy_set_header X-Forwarded-Proto $scheme;
    }
}`;
    }
    
    // Update Apache example
    const apacheCode = document.getElementById('apache-config-code');
    if (apacheCode) {
        apacheCode.textContent = `<VirtualHost *:${port}>
    ServerName ${hostname}
    
    # Server SSL certificate
    SSLEngine on
    SSLCertificateFile /etc/ssl/certs/ucm-server.crt
    SSLCertificateKeyFile /etc/ssl/private/ucm-server.key
    
    # Client certificate verification${trustedCaId ? '' : ' (DISABLED - No CA selected)'}
    ${trustedCaId ? `SSLCACertificateFile /etc/ssl/certs/ucm-client-ca.pem
    SSLVerifyClient ${apacheVerifyMode}` : '# SSLCACertificateFile /path/to/client-ca.pem\n    # SSLVerifyClient optional'}
    SSLVerifyDepth 2
    
    # Proxy to UCM backend
    ProxyPass / https://127.0.0.1:8443/
    ProxyPassReverse / https://127.0.0.1:8443/
    SSLProxyEngine on
    SSLProxyVerify none
    
    # Forward client certificate information
    RequestHeader set X-SSL-Client-Verify "%{SSL_CLIENT_VERIFY}s"
    RequestHeader set X-SSL-Client-S-DN "%{SSL_CLIENT_S_DN}s"
    RequestHeader set X-SSL-Client-I-DN "%{SSL_CLIENT_I_DN}s"
    RequestHeader set X-SSL-Client-Serial "%{SSL_CLIENT_M_SERIAL}s"
    RequestHeader set X-SSL-Client-Cert "%{SSL_CLIENT_CERT}s"
</VirtualHost>`;
    }
}

document.getElementById('mtls_enabled')?.addEventListener('change', toggleMTLSFields);
document.getElementById('mtls_trusted_ca_id')?.addEventListener('change', toggleMTLSFields);

// Download CA certificate
document.getElementById('download-ca-btn')?.addEventListener('click', async () => {
    const caId = document.getElementById('mtls_trusted_ca_id').value;
    if (!caId) {
        showToast('✗ No CA selected', 'error');
        return;
    }
    
    try {
        const response = await fetch(`/api/v1/ca/${caId}/export?format=pem`, {
            headers: {'Authorization': `Bearer ${token}`}
        });
        
        if (response.ok) {
            const blob = await response.blob();
            const url = window.URL.createObjectURL(blob);
            const a = document.createElement('a');
            a.href = url;
            a.download = 'ucm-client-ca.pem';
            document.body.appendChild(a);
            a.click();
            window.URL.revokeObjectURL(url);
            document.body.removeChild(a);
            showToast('✓ CA certificate downloaded', 'success');
        } else {
            showToast('✗ Failed to download CA', 'error');
        }
    } catch (error) {
        showToast('✗ Error: ' + error.message, 'error');
    }
});

// Update user section visibility and content
async function updateUserSection() {
    const userSection = document.getElementById('user-section');
    const disabledMessage = document.getElementById('mtls-disabled-message');
    
    if (currentSettings.enabled) {
        userSection.style.display = 'block';
        disabledMessage.style.display = 'none';
        
        // Show appropriate create form
        const trustedCAId = currentSettings.trusted_ca_id;
        const createWithCA = document.getElementById('create-with-ca');
        const createSelfSigned = document.getElementById('create-self-signed');
        
        if (trustedCAId) {
            // Fetch CA details
            try {
                const response = await fetch(`/api/v1/ca/${trustedCAId}`, {
                    headers: {'Authorization': `Bearer ${token}`}
                });
                if (response.ok) {
                    const ca = await response.json();
                    document.getElementById('ca-name-display').textContent = ca.descr;
                    document.getElementById('import-ca-name-display').textContent = ca.descr;
                }
            } catch (e) {}
            
            createWithCA.style.display = 'block';
            createSelfSigned.style.display = 'none';
            document.getElementById('import-info-ca').style.display = 'block';
            document.getElementById('import-info-any').style.display = 'none';
        } else {
            createWithCA.style.display = 'none';
            createSelfSigned.style.display = 'block';
            document.getElementById('import-info-ca').style.display = 'none';
            document.getElementById('import-info-any').style.display = 'block';
        }
    } else {
        userSection.style.display = 'none';
        disabledMessage.style.display = 'block';
    }
}

// Save mTLS settings (admin)
{% if session.get('role') == 'admin' %}
document.getElementById('mtls-settings-form')?.addEventListener('submit', async (e) => {
    e.preventDefault();
    
    const data = {
        enabled: document.getElementById('mtls_enabled').checked,
        required: document.getElementById('mtls_required').checked,
        trusted_ca_id: document.getElementById('mtls_trusted_ca_id').value
    };
    
    try {
        const response = await fetch('/api/v1/mtls/settings', {
            method: 'POST',
            headers: {
                'Content-Type': 'application/json',
                'Authorization': `Bearer ${token}`
            },
            body: JSON.stringify(data)
        });
        
        const result = await response.json();
        
        if (response.ok) {
            showToast('✓ Settings saved successfully', 'success');
            loadMTLSSettings();
        } else {
            showToast('✗ ' + (result.error || 'Failed to save'), 'error');
        }
    } catch (error) {
        showToast('✗ Error: ' + error.message, 'error');
    }
});
{% endif %}

// Create managed certificate
document.getElementById('create-managed-cert-form')?.addEventListener('submit', async (e) => {
    e.preventDefault();
    
    const data = {
        cn: document.getElementById('create_cn').value,
        email: document.getElementById('create_email').value,
        validity_days: parseInt(document.getElementById('create_validity').value)
    };
    
    try {
        const response = await fetch('/api/v1/mtls/certificates/create', {
            method: 'POST',
            headers: {
                'Content-Type': 'application/json',
                'Authorization': `Bearer ${token}`
            },
            body: JSON.stringify(data)
        });
        
        const result = await response.json();
        
        if (response.ok) {
            showToast('✓ Certificate created successfully', 'success');
            // Switch to manage tab
            ucm_switchTab('manage');
            loadCertificates();
        } else {
            showToast('✗ ' + (result.error || 'Failed to create certificate'), 'error');
        }
    } catch (error) {
        showToast('✗ Error: ' + error.message, 'error');
    }
});

// Create self-signed certificate
document.getElementById('create-selfsigned-cert-form')?.addEventListener('submit', async (e) => {
    e.preventDefault();
    
    const data = {
        cn: document.getElementById('selfsigned_cn').value,
        email: document.getElementById('selfsigned_email').value,
        validity_days: parseInt(document.getElementById('selfsigned_validity').value),
        key_size: parseInt(document.getElementById('selfsigned_keysize').value),
        self_signed: true
    };
    
    try {
        const response = await fetch('/api/v1/mtls/certificates/create', {
            method: 'POST',
            headers: {
                'Content-Type': 'application/json',
                'Authorization': `Bearer ${token}`
            },
            body: JSON.stringify(data)
        });
        
        const result = await response.json();
        
        if (response.ok) {
            showToast('✓ Self-signed certificate created', 'success');
            ucm_switchTab('manage');
            loadCertificates();
        } else {
            showToast('✗ ' + (result.error || 'Failed to create certificate'), 'error');
        }
    } catch (error) {
        showToast('✗ Error: ' + error.message, 'error');
    }
});

// Validate imported certificate
async function validateImportedCert() {
    const certPem = document.getElementById('import_cert_pem').value;
    
    if (!certPem) {
        showToast('Please paste a certificate first', 'error');
        return;
    }
    
    try {
        const response = await fetch('/api/v1/mtls/validate-certificate', {
            method: 'POST',
            headers: {
                'Content-Type': 'application/json',
                'Authorization': `Bearer ${token}`
            },
            body: JSON.stringify({certificate: certPem})
        });
        
        const result = await response.json();
        const resultDiv = document.getElementById('import-validation-result');
        
        if (response.ok && result.success) {
            const info = result.info;
            resultDiv.style.display = 'block';
            resultDiv.innerHTML = `
                <div style="background: ${result.valid ? 'var(--success-bg)' : 'var(--danger-bg)'}; padding: 1rem; border-radius: 0.5rem; border-left: 4px solid ${result.valid ? 'var(--success-color)' : 'var(--danger-color)'};">
                    <strong>${result.valid ? '✓ Valid Certificate' : '✗ Invalid Certificate'}</strong>
                    ${result.already_enrolled ? '<p style="color: var(--warning-color); margin-top: 0.5rem;"><strong>⚠️ Certificate already enrolled</strong></p>' : ''}
                    <div style="margin-top: 1rem; font-size: 0.875rem;">
                        <p><strong>Subject:</strong> ${info.subject}</p>
                        <p><strong>Issuer:</strong> ${info.issuer}</p>
                        <p><strong>Serial:</strong> <code>${info.serial}</code></p>
                        <p><strong>Valid Until:</strong> ${info.valid_until ? new Date(info.valid_until).toLocaleString() : 'N/A'}</p>
                    </div>
                </div>
            `;
        } else {
            resultDiv.style.display = 'block';
            resultDiv.innerHTML = `
                <div style="background: var(--danger-bg); padding: 1rem; border-radius: 0.5rem; border-left: 4px solid var(--danger-color);">
                    <strong>✗ Validation Failed</strong>
                    <p style="margin-top: 0.5rem;">${result.error || 'Unknown error'}</p>
                </div>
            `;
        }
    } catch (error) {
        showToast('✗ Validation error: ' + error.message, 'error');
    }
}
window.validateImportedCert = validateImportedCert;

// Import certificate
document.getElementById('import-cert-form')?.addEventListener('submit', async (e) => {
    e.preventDefault();
    
    const data = {
        certificate: document.getElementById('import_cert_pem').value,
        name: document.getElementById('import_name').value
    };
    
    try {
        const response = await fetch('/api/v1/mtls/certificates/enroll', {
            method: 'POST',
            headers: {
                'Content-Type': 'application/json',
                'Authorization': `Bearer ${token}`
            },
            body: JSON.stringify(data)
        });
        
        const result = await response.json();
        
        if (response.ok) {
            showToast('✓ Certificate imported successfully', 'success');
            document.getElementById('import-cert-form').reset();
            document.getElementById('import-validation-result').style.display = 'none';
            ucm_switchTab('manage');
            loadCertificates();
        } else {
            showToast('✗ ' + (result.error || 'Failed to import certificate'), 'error');
        }
    } catch (error) {
        showToast('✗ Error: ' + error.message, 'error');
    }
});

// Load certificates
async function loadCertificates() {
    try {
        const response = await fetch('/api/v1/mtls/certificates', {
            headers: {'Authorization': `Bearer ${token}`}
        });
        
        if (response.ok) {
            const data = await response.json();
            const tbody = document.getElementById('certificates-tbody');
            
            if (data.certificates.length === 0) {
                tbody.innerHTML = `
                    <tr>
                        <td colspan="6" style="text-align: center; padding: 2rem; color: var(--text-secondary);">
                            <svg class="ucm-icon" width="32" height="32" style="opacity: 0.5;"><use href="#icon-key"/></svg>
                            <p style="margin-top: 0.5rem;">No certificates enrolled</p>
                            <button onclick="ucm_switchTab('create')" class="btn btn-sm btn-primary" style="margin-top: 1rem;">
                                <svg class="ucm-icon" width="16" height="16"><use href="#icon-plus"/></svg> Create Your First Certificate
                            </button>
                        </td>
                    </tr>
                `;
                return;
            }
            
            tbody.innerHTML = data.certificates.map(cert => {
                const validUntil = cert.valid_until ? new Date(cert.valid_until) : null;
                const isExpired = validUntil && validUntil < new Date();
                const daysLeft = validUntil ? Math.ceil((validUntil - new Date()) / (1000 * 60 * 60 * 24)) : null;
                
                // Escape user-controlled data to prevent XSS
                const safeName = escapeHtml(cert.name || 'Unnamed');
                const safeSubject = escapeHtml(cert.cert_subject);
                const safeSerial = escapeHtml(cert.cert_serial.substring(0, 16));
                
                return `
                    <tr>
                        <td><strong>${safeName}</strong></td>
                        <td style="max-width: 300px; overflow: hidden; text-overflow: ellipsis;">${safeSubject}</td>
                        <td><code style="font-size: 0.875rem;">${safeSerial}...</code></td>
                        <td>
                            ${validUntil ? validUntil.toLocaleDateString() : 'N/A'}
                            ${daysLeft !== null && daysLeft < 30 ? `<br><small style="color: var(--warning-color);">${daysLeft} days left</small>` : ''}
                        </td>
                        <td>
                            ${cert.enabled 
                                ? (isExpired 
                                    ? '<span class="badge-outline badge-danger"><svg class="ucm-icon" width="10" height="10"><use href="#icon-times"/></svg> Expired</span>'
                                    : '<span class="badge-outline badge-success"><svg class="ucm-icon" width="10" height="10"><use href="#icon-check"/></svg> Active</span>')
                                : '<span class="badge-outline badge-secondary"><svg class="ucm-icon" width="10" height="10"><use href="#icon-times"/></svg> Disabled</span>'
                            }
                        </td>
                        <td>
                            <div style="display: flex; gap: 0.5rem;">
                                <button onclick="downloadCertificate(${cert.id})" class="btn btn-sm btn-outline-secondary" title="Download">
                                    <svg class="ucm-icon" width="16" height="16"><use href="#icon-download"/></svg>
                                </button>
                                ${cert.enabled 
                                    ? `<button onclick="revokeCertificate(${cert.id})" class="btn btn-sm btn-outline-warning" title="Revoke">
                                        <svg class="ucm-icon" width="16" height="16"><use href="#icon-times"/></svg>
                                    </button>`
                                    : `<button onclick="enableCertificate(${cert.id})" class="btn btn-sm btn-outline-success" title="Enable">
                                        <svg class="ucm-icon" width="16" height="16"><use href="#icon-check"/></svg>
                                    </button>`
                                }
                                <button onclick="deleteCertificate(${cert.id})" class="btn btn-sm btn-outline-danger" title="Delete">
                                    <svg class="ucm-icon" width="16" height="16"><use href="#icon-trash"/></svg>
                                </button>
                            </div>
                        </td>
                    </tr>
                `;
            }).join('');
        }
    } catch (error) {
        console.error('Error loading certificates:', error);
    }
}

// Certificate actions
async function downloadCertificate(certId) {
    try {
        const response = await fetch(`/api/v1/mtls/certificates/${certId}/download`, {
            headers: {'Authorization': `Bearer ${token}`}
        });
        
        if (response.ok) {
            const blob = await response.blob();
            const url = window.URL.createObjectURL(blob);
            const a = document.createElement('a');
            a.href = url;
            a.download = `client-cert-${certId}.pem`;
            a.click();
            window.URL.revokeObjectURL(url);
        } else {
            showToast('✗ Failed to download certificate', 'error');
        }
    } catch (error) {
        showToast('✗ Error: ' + error.message, 'error');
    }
}
window.downloadCertificate = downloadCertificate;

async function revokeCertificate(certId) {
    const confirmed = await ucmConfirm(
        'Are you sure you want to revoke this certificate? You can re-enable it later.',
        'Revoke Certificate',
        { danger: true, confirmText: 'Revoke', icon: 'warning-triangle' }
    );
    
    if (!confirmed) return;
    
    try {
        const response = await fetch(`/api/v1/mtls/certificates/${certId}/revoke`, {
            method: 'POST',
            headers: {'Authorization': `Bearer ${token}`}
        });
        
        if (response.ok) {
            showToast('✓ Certificate revoked', 'success');
            loadCertificates();
        } else {
            showToast('✗ Failed to revoke', 'error');
        }
    } catch (error) {
        showToast('✗ Error: ' + error.message, 'error');
    }
}
window.revokeCertificate = revokeCertificate;

async function enableCertificate(certId) {
    try {
        const response = await fetch(`/api/v1/mtls/certificates/${certId}/enable`, {
            method: 'POST',
            headers: {'Authorization': `Bearer ${token}`}
        });
        
        if (response.ok) {
            showToast('✓ Certificate enabled', 'success');
            loadCertificates();
        } else {
            showToast('✗ Failed to enable', 'error');
        }
    } catch (error) {
        showToast('✗ Error: ' + error.message, 'error');
    }
}
window.enableCertificate = enableCertificate;

async function deleteCertificate(certId) {
    const confirmed = await ucmConfirm(
        'Are you sure you want to permanently delete this certificate? This action cannot be undone.',
        'Delete Certificate',
        { danger: true, confirmText: 'Delete', icon: 'trash' }
    );
    
    if (!confirmed) return;
    
    try {
        const response = await fetch(`/api/v1/mtls/certificates/${certId}`, {
            method: 'DELETE',
            headers: {'Authorization': `Bearer ${token}`}
        });
        
        if (response.ok) {
            showToast('✓ Certificate deleted', 'success');
            loadCertificates();
        } else {
            showToast('✗ Failed to delete', 'error');
        }
    } catch (error) {
        showToast('✗ Error: ' + error.message, 'error');
    }
}
window.deleteCertificate = deleteCertificate;

// Initialize
document.addEventListener('DOMContentLoaded', () => {
    loadMTLSSettings();
});
})();
</script>
{% endblock %}

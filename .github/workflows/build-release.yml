name: Build & Release

on:
  push:
    tags:
      - 'v*'
  workflow_dispatch:
    inputs:
      version:
        description: 'Version (e.g., 2.0.0-beta1)'
        required: true
        type: string

permissions:
  contents: write
  packages: write

env:
  REGISTRY: ghcr.io

jobs:
  # ============================================================
  # Build Debian Package
  # ============================================================
  build-deb:
    name: Build DEB Package
    runs-on: ubuntu-latest
    
    outputs:
      version: ${{ steps.version.outputs.version }}
      deb_version: ${{ steps.version.outputs.deb_version }}
    
    steps:
      - uses: actions/checkout@v4
        with:
          fetch-depth: 0
      
      - name: Extract version
        id: version
        run: |
          if [ -n "${{ github.event.inputs.version }}" ]; then
            VERSION="${{ github.event.inputs.version }}"
          else
            VERSION=${GITHUB_REF#refs/tags/v}
          fi
          # Convert to DEB version (2.0.0-beta1 -> 2.0.0~beta1)
          DEB_VERSION=$(echo "$VERSION" | sed 's/-/~/g')
          echo "version=$VERSION" >> $GITHUB_OUTPUT
          echo "deb_version=$DEB_VERSION" >> $GITHUB_OUTPUT
          echo "Building version: $VERSION (DEB: $DEB_VERSION)"
      
      - name: Setup Node.js
        uses: actions/setup-node@v4
        with:
          node-version: '20'
          cache: 'npm'
          cache-dependency-path: frontend/package-lock.json
      
      - name: Build frontend
        run: |
          cd frontend
          npm ci
          npm run build
      
      - name: Install build dependencies
        run: |
          sudo apt-get update
          sudo apt-get install -y build-essential debhelper fakeroot devscripts dh-python python3-all
      
      - name: Update changelog version
        run: |
          VERSION="${{ steps.version.outputs.deb_version }}"
          DATE=$(date -R)
          cat > packaging/debian/changelog << EOF
          ucm ($VERSION) stable; urgency=medium

            * Release $VERSION

           -- UCM Team <support@ucm.local>  $DATE

          EOF
      
      - name: Update VERSION file
        run: |
          echo "${{ steps.version.outputs.version }}" > VERSION
          cd frontend && npm pkg set version="${{ steps.version.outputs.version }}"
      
      - name: Build DEB package
        run: |
          # Create symlink for debian directory (dpkg expects debian/ at root)
          ln -s packaging/debian debian
          dpkg-buildpackage -us -uc -b
          mv ../ucm_*.deb .
          ls -la ucm_*.deb
      
      - name: Generate checksums
        run: |
          for f in ucm_*.deb; do
            sha256sum "$f" > "$f.sha256"
          done
      
      - name: Upload artifact
        uses: actions/upload-artifact@v4
        with:
          name: deb-package
          path: |
            ucm_*.deb
            ucm_*.deb.sha256

  # ============================================================
  # Build RPM Package
  # ============================================================
  build-rpm:
    name: Build RPM Package
    runs-on: ubuntu-latest
    needs: build-deb
    
    steps:
      - uses: actions/checkout@v4
      
      - name: Setup Node.js
        uses: actions/setup-node@v4
        with:
          node-version: '20'
          cache: 'npm'
          cache-dependency-path: frontend/package-lock.json
      
      - name: Build frontend
        run: |
          cd frontend
          npm ci
          npm run build
      
      - name: Build RPM in Fedora container
        run: |
          VERSION="${{ needs.build-deb.outputs.version }}"
          # For RPM Version field (supports ~), and for tarball name (use _)
          RPM_VERSION=$(echo "$VERSION" | sed 's/-/~/g')
          TAR_VERSION=$(echo "$VERSION" | sed 's/-/_/g')
          
          mkdir -p /tmp/rpm-output /tmp/rpm-build/ucm-${TAR_VERSION}
          
          # Copy only what's needed (NO node_modules, only dist/)
          cp -r backend packaging /tmp/rpm-build/ucm-${TAR_VERSION}/
          cp VERSION /tmp/rpm-build/ucm-${TAR_VERSION}/
          mkdir -p /tmp/rpm-build/ucm-${TAR_VERSION}/frontend
          cp -r frontend/dist /tmp/rpm-build/ucm-${TAR_VERSION}/frontend/
          
          # Create tarball
          tar -C /tmp/rpm-build -czf /tmp/rpm-build/ucm-${TAR_VERSION}.tar.gz ucm-${TAR_VERSION}
          
          docker run --rm \
            -v $(pwd):/workspace:ro \
            -v /tmp/rpm-build:/rpm-sources:ro \
            -v /tmp/rpm-output:/output \
            -e RPM_VERSION="$RPM_VERSION" \
            -e TAR_VERSION="$TAR_VERSION" \
            fedora:43 bash -c '
              set -e
              dnf install -y rpm-build rpmdevtools python3 python3-pip systemd-rpm-macros
              
              rpmdev-setuptree
              
              # Copy tarball
              cp /rpm-sources/ucm-${TAR_VERSION}.tar.gz ~/rpmbuild/SOURCES/
              
              # Create spec from template with correct versions
              cp /workspace/packaging/rpm/ucm.spec ~/rpmbuild/SPECS/
              sed -i "s/^Version:.*/Version:        ${RPM_VERSION}/" ~/rpmbuild/SPECS/ucm.spec
              sed -i "s/^Source0:.*/Source0:        ucm-${TAR_VERSION}.tar.gz/" ~/rpmbuild/SPECS/ucm.spec
              sed -i "s/%setup -q/%setup -q -n ucm-${TAR_VERSION}/" ~/rpmbuild/SPECS/ucm.spec
              
              # Fix bogus date warning
              sed -i "s/Mon Feb 03 2026/Thu Feb 06 2026/" ~/rpmbuild/SPECS/ucm.spec
              
              # Build
              rpmbuild -bb ~/rpmbuild/SPECS/ucm.spec
              
              # Copy outputs
              cp ~/rpmbuild/RPMS/noarch/*.rpm /output/
              cd /output && sha256sum *.rpm > checksums.sha256
            '
      
      - name: Upload artifact
        uses: actions/upload-artifact@v4
        with:
          name: rpm-package
          path: /tmp/rpm-output/*.rpm

  # ============================================================
  # Build Docker Image
  # ============================================================
  build-docker:
    name: Build Docker Image
    runs-on: ubuntu-latest
    needs: build-deb
    
    steps:
      - uses: actions/checkout@v4
      
      - name: Setup Node.js
        uses: actions/setup-node@v4
        with:
          node-version: '20'
          cache: 'npm'
          cache-dependency-path: frontend/package-lock.json
      
      - name: Build frontend
        run: |
          cd frontend
          npm ci
          npm run build
      
      - name: Set image name
        id: image
        run: |
          echo "name=$(echo ${{ github.repository }} | tr '[:upper:]' '[:lower:]')" >> $GITHUB_OUTPUT
      
      - name: Set up QEMU
        uses: docker/setup-qemu-action@v3
      
      - name: Set up Docker Buildx
        uses: docker/setup-buildx-action@v3
      
      - name: Log in to GitHub Container Registry
        uses: docker/login-action@v3
        with:
          registry: ${{ env.REGISTRY }}
          username: ${{ github.actor }}
          password: ${{ secrets.GITHUB_TOKEN }}
      
      - name: Log in to Docker Hub
        uses: docker/login-action@v3
        with:
          username: ${{ secrets.DOCKERHUB_USERNAME }}
          password: ${{ secrets.DOCKERHUB_TOKEN }}
      
      - name: Extract metadata
        id: meta
        uses: docker/metadata-action@v5
        with:
          images: |
            ${{ env.REGISTRY }}/${{ steps.image.outputs.name }}
            neyslim/ultimate-ca-manager
          tags: |
            type=semver,pattern={{version}}
            type=semver,pattern={{major}}.{{minor}}
            type=raw,value=latest,enable=${{ !contains(github.ref, 'dev') && !contains(github.ref, 'beta') && !contains(github.ref, 'alpha') && !contains(needs.build-deb.outputs.version, 'dev') }}
            type=raw,value=${{ needs.build-deb.outputs.version }}
      
      - name: Build and push
        uses: docker/build-push-action@v5
        with:
          context: .
          platforms: linux/amd64,linux/arm64
          push: true
          tags: ${{ steps.meta.outputs.tags }}
          labels: ${{ steps.meta.outputs.labels }}
          cache-from: type=gha
          cache-to: type=gha,mode=max
          build-args: |
            VERSION=${{ needs.build-deb.outputs.version }}

  # ============================================================
  # Create GitHub Release
  # ============================================================
  release:
    name: Create Release
    runs-on: ubuntu-latest
    needs: [build-deb, build-rpm, build-docker]
    if: startsWith(github.ref, 'refs/tags/')
    
    steps:
      - uses: actions/checkout@v4
        with:
          fetch-depth: 0
      
      - name: Download DEB artifact
        uses: actions/download-artifact@v4
        with:
          name: deb-package
          path: ./artifacts
      
      - name: Download RPM artifact
        uses: actions/download-artifact@v4
        with:
          name: rpm-package
          path: ./artifacts
      
      - name: Generate release notes
        id: notes
        run: |
          VERSION="${{ needs.build-deb.outputs.version }}"
          IMAGE="ghcr.io/$(echo ${{ github.repository }} | tr '[:upper:]' '[:lower:]')"
          
          cat > notes.md << 'EOF'
          ## ðŸš€ Installation
          
          ### Docker (Recommended)
          ```bash
          # From Docker Hub
          docker pull neyslim/ultimate-ca-manager:VERSION
          
          # Or from GitHub Container Registry
          docker pull IMAGE:VERSION
          
          # Run
          docker run -d -p 8443:8443 \
            -e SECRET_KEY=$(openssl rand -hex 32) \
            --name ucm neyslim/ultimate-ca-manager:VERSION
          ```
          
          ### Debian/Ubuntu
          ```bash
          wget https://github.com/REPO/releases/download/vVERSION/ucm_DEB_VERSION_all.deb
          sudo dpkg -i ucm_*_all.deb
          sudo apt-get install -f
          ```
          
          ### Fedora/RHEL
          ```bash
          wget https://github.com/REPO/releases/download/vVERSION/ucm-RPM_VERSION-1.fc43.noarch.rpm
          sudo dnf install ./ucm-*.rpm
          ```
          
          ### Silent/Automated Install
          ```bash
          # Skip firewall prompts for CI/automation
          sudo UCM_PORT=8443 UCM_FIREWALL=no dpkg -i ucm_*.deb
          ```
          
          ## ðŸ” Default Credentials
          - **Username:** `admin`
          - **Password:** Check `/etc/ucm/ucm.env` after install, or shown during install
          
          âš ï¸ **Change the password immediately after first login!**
          
          ## ðŸ“š Documentation
          - [Installation Guide](docs/INSTALLATION.md)
          - [API Documentation](https://github.com/NeySlim/ultimate-ca-manager/wiki/API)
          
          ## â¬†ï¸ Upgrading from v1.8.x
          Data is automatically migrated when upgrading. A backup is created in `/opt/ucm/data/backups/`.
          EOF
          
          # Replace placeholders
          DEB_VERSION=$(echo "$VERSION" | sed 's/-/~/g')
          RPM_VERSION=$(echo "$VERSION" | sed 's/-/~/g')
          sed -i "s|IMAGE|$IMAGE|g" notes.md
          sed -i "s|VERSION|$VERSION|g" notes.md
          sed -i "s|DEB_VERSION|$DEB_VERSION|g" notes.md
          sed -i "s|RPM_VERSION|$RPM_VERSION|g" notes.md
          sed -i "s|REPO|${{ github.repository }}|g" notes.md
          
          cat notes.md
      
      - name: Delete existing release assets
        run: |
          TAG=${GITHUB_REF#refs/tags/}
          for asset in $(gh release view "$TAG" --json assets -q '.assets[].name' 2>/dev/null || true); do
            echo "Deleting existing asset: $asset"
            gh release delete-asset "$TAG" "$asset" -y || true
          done
        env:
          GH_TOKEN: ${{ secrets.GITHUB_TOKEN }}

      - name: Create release
        uses: softprops/action-gh-release@v2
        with:
          body_path: notes.md
          draft: false
          prerelease: ${{ contains(github.ref, 'beta') || contains(github.ref, 'alpha') || contains(github.ref, 'dev') }}
          files: |
            artifacts/*
        env:
          GITHUB_TOKEN: ${{ secrets.GITHUB_TOKEN }}

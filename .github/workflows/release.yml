name: Create Release

on:
  push:
    tags:
      - 'v*'

permissions:
  contents: write

jobs:
  release:
    runs-on: ubuntu-latest
    
    steps:
      - name: Checkout code
        uses: actions/checkout@v4
        with:
          fetch-depth: 0
      
      - name: Wait for build workflows
        run: |
          echo "Waiting for DEB and RPM builds to complete..."
          sleep 30
      
      - name: Generate Release Notes
        id: notes
        run: |
          VERSION=${GITHUB_REF#refs/tags/}
          
          # Get previous tag
          PREV_TAG=$(git tag --sort=-v:refname | grep -v "^${VERSION}$" | head -1)
          
          # Generate changelog from commits
          echo "## ðŸ“¦ What's New" > notes.md
          echo "" >> notes.md
          
          if [ -z "$PREV_TAG" ]; then
            git log --pretty=format:"- %s" ${VERSION} | head -20 >> notes.md
          else
            echo "Changes since ${PREV_TAG}:" >> notes.md
            echo "" >> notes.md
            git log --pretty=format:"- %s" ${PREV_TAG}..${VERSION} >> notes.md
          fi
          
          # Add installation instructions
          cat >> notes.md << 'NOTES'
          
          ---
          
          ## ðŸš€ Installation
          
          ### Docker (Recommended)
          ```bash
          docker pull ghcr.io/neyslim/ultimate-ca-manager:VERSION_TAG
          docker run -d -p 8443:8443 --name ucm ghcr.io/neyslim/ultimate-ca-manager:VERSION_TAG
          ```
          
          ### RPM (RHEL/Rocky/Alma/Fedora)
          Download the `.rpm` file from assets below, then:
          ```bash
          sudo dnf install ./ucm-*.rpm
          ```
          
          ### DEB (Debian/Ubuntu)
          Download the `.deb` file from assets below, then:
          ```bash
          sudo dpkg -i ucm_*.deb
          sudo apt-get install -f
          ```
          
          ## ðŸ“š Documentation
          - [Installation Guide](https://github.com/NeySlim/ultimate-ca-manager/blob/main/INSTALLATION.md)
          - [Docker Quick Start](https://github.com/NeySlim/ultimate-ca-manager/blob/main/DOCKER_QUICKSTART.md)
          - [Wiki](https://github.com/NeySlim/ultimate-ca-manager/wiki)
          
          ## ðŸ” Default Credentials
          - Username: `admin`
          - Password: `changeme123`
          
          âš ï¸ **CHANGE THE PASSWORD IMMEDIATELY AFTER FIRST LOGIN!**
          NOTES
          
          # Replace VERSION_TAG
          sed -i "s/VERSION_TAG/${VERSION}/g" notes.md
          
          # Output for GitHub
          {
            echo 'notes<<NOTES_EOF'
            cat notes.md
            echo 'NOTES_EOF'
          } >> $GITHUB_OUTPUT
      
      - name: Create GitHub Release
        uses: softprops/action-gh-release@v1
        with:
          body: ${{ steps.notes.outputs.notes }}
          draft: false
          prerelease: ${{ contains(github.ref, 'beta') || contains(github.ref, 'alpha') || contains(github.ref, 'rc') }}
        env:
          GITHUB_TOKEN: ${{ secrets.GITHUB_TOKEN }}

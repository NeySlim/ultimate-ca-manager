name: Build RPM Package

on:
  push:
    tags:
      - 'v*.*.*'
  workflow_dispatch:

permissions:
  contents: write
  discussions: write

jobs:
  build-rpm:
    runs-on: ubuntu-latest
    
    steps:
      - name: Checkout code
        uses: actions/checkout@v4
      
      - name: Set up Python
        uses: actions/setup-python@v5
        with:
          python-version: '3.11'
      
      - name: Get version from tag
        id: get_version
        run: |
          if [[ "${GITHUB_REF}" == refs/tags/* ]]; then
            VERSION=${GITHUB_REF#refs/tags/v}
          else
            VERSION="1.6.0"
          fi
          echo "VERSION=${VERSION}" >> $GITHUB_OUTPUT
          echo "Building version: ${VERSION}"
      
      - name: Install build dependencies
        run: |
          sudo apt-get update
          sudo apt-get install -y rpm
      
      - name: Create RPM structure
        run: |
          VERSION="${{ steps.get_version.outputs.VERSION }}"
          
          # Create RPM build directories
          mkdir -p ~/rpmbuild/{BUILD,RPMS,SOURCES,SPECS,SRPMS}
          
          # Create application directory structure
          mkdir -p rpmbuild/opt/ucm
          mkdir -p rpmbuild/etc/systemd/system
          mkdir -p rpmbuild/usr/share/doc/ucm
          
          # Copy application files
          cp -r backend frontend rpmbuild/opt/ucm/
          cp .env.example rpmbuild/opt/ucm/
          cp README.md INSTALLATION.md rpmbuild/usr/share/doc/ucm/
          
          # Create systemd service file
          cat > rpmbuild/etc/systemd/system/ucm.service << 'EOF'
          [Unit]
          Description=Ultimate CA Manager
          After=network.target
          
          [Service]
          Type=simple
          User=ucm
          Group=ucm
          WorkingDirectory=/opt/ucm
          Environment="PATH=/opt/ucm/venv/bin"
          ExecStart=/opt/ucm/venv/bin/gunicorn -c /opt/ucm/backend/gunicorn_config.py backend.app:app
          Restart=always
          RestartSec=10
          
          [Install]
          WantedBy=multi-user.target
          EOF
          
          # Create tarball for SOURCES
          tar czf ~/rpmbuild/SOURCES/ucm-${VERSION}.tar.gz -C rpmbuild .
      
      - name: Create RPM spec file
        run: |
          VERSION="${{ steps.get_version.outputs.VERSION }}"
          
          cat > ~/rpmbuild/SPECS/ucm.spec << EOF
          Name:           ucm
          Version:        ${VERSION}
          Release:        1%{?dist}
          Summary:        Ultimate CA Manager
          
          License:        MIT
          URL:            https://github.com/${{ github.repository }}
          Source0:        ucm-%{version}.tar.gz
          
          BuildArch:      noarch
          Requires:       python3 >= 3.11, python3-pip, python3-virtualenv, nginx, systemd
          
          %description
          A comprehensive Certificate Authority management system.
          Features include:
          - CA creation and management
          - Certificate issuance and revocation
          - CRL distribution
          - OCSP responder
          - SCEP server
          - Web-based management interface
          
          %prep
          %setup -q -c
          
          %install
          rm -rf %{buildroot}
          mkdir -p %{buildroot}/opt/ucm
          mkdir -p %{buildroot}/etc/systemd/system
          mkdir -p %{buildroot}/usr/share/doc/ucm
          
          cp -r opt/ucm/* %{buildroot}/opt/ucm/
          cp etc/systemd/system/ucm.service %{buildroot}/etc/systemd/system/
          cp usr/share/doc/ucm/* %{buildroot}/usr/share/doc/ucm/
          
          %pre
          # Create ucm user if not exists
          if ! id -u ucm > /dev/null 2>&1; then
              useradd -r -s /bin/bash -d /opt/ucm -m ucm
          fi
          
          %post
          # Set permissions
          chown -R ucm:ucm /opt/ucm
          chmod 755 /opt/ucm
          
          # Create virtual environment
          cd /opt/ucm
          python3 -m venv venv
          source venv/bin/activate
          pip install --upgrade pip
          pip install -r backend/requirements.txt
          
          # Create data directories
          mkdir -p /opt/ucm/data/{ca,certs,crl,ocsp,scep}
          chown -R ucm:ucm /opt/ucm/data
          
          # Initialize database if not exists
          if [ ! -f /opt/ucm/data/ucm.db ]; then
              sudo -u ucm venv/bin/python backend/init_db.py
          fi
          
          # Enable and start service
          systemctl daemon-reload
          systemctl enable ucm.service
          systemctl start ucm.service
          
          echo "UCM installed successfully!"
          echo "Access the web interface at: https://\$(hostname -I | awk '{print \$1}'):8443"
          
          %preun
          # Stop service
          systemctl stop ucm.service || true
          systemctl disable ucm.service || true
          
          %files
          %defattr(-,root,root,-)
          /opt/ucm
          /etc/systemd/system/ucm.service
          %doc /usr/share/doc/ucm/README.md
          %doc /usr/share/doc/ucm/INSTALLATION.md
          
          %changelog
          * $(date "+%a %b %d %Y") UCM Team <support@ucm.local> - ${VERSION}-1
          - Release ${VERSION}
          - Dependency updates (Python 3.13 compatible)
          - Security updates: cryptography 46.0.3, pyOpenSSL 25.3.0
          - WebAuthn 2.7.0 with FIDO2 improvements
          - Certificate management improvements
          - Bug fixes and UI enhancements
          EOF
      
      - name: Build RPM
        run: |
          rpmbuild -bb ~/rpmbuild/SPECS/ucm.spec
          
          # Find and copy the built RPM
          VERSION="${{ steps.get_version.outputs.VERSION }}"
          find ~/rpmbuild/RPMS -name "*.rpm" -exec cp {} ucm-${VERSION}-1.noarch.rpm \;
          
          # Create checksums
          md5sum ucm-${VERSION}-1.noarch.rpm > ucm-${VERSION}-1.noarch.rpm.md5
          sha256sum ucm-${VERSION}-1.noarch.rpm > ucm-${VERSION}-1.noarch.rpm.sha256
      
      - name: Upload artifacts
        uses: actions/upload-artifact@v4
        with:
          name: rpm-package
          path: |
            ucm-*.rpm
            ucm-*.md5
            ucm-*.sha256
      
      - name: Create Release
        if: startsWith(github.ref, 'refs/tags/')
        uses: softprops/action-gh-release@v1
        with:
          files: |
            ucm-*.rpm
            ucm-*.md5
            ucm-*.sha256
          body: |
            ## UCM ${{ steps.get_version.outputs.VERSION }} - RPM Package
            
            ### Installation (RHEL/CentOS/Fedora)
            \`\`\`bash
            wget https://github.com/${{ github.repository }}/releases/download/${{ github.ref_name }}/ucm-${{ steps.get_version.outputs.VERSION }}-1.noarch.rpm
            sudo rpm -ivh ucm-${{ steps.get_version.outputs.VERSION }}-1.noarch.rpm
            \`\`\`
            
            ### What's New in v1.7.5
            - **Dependency Updates**: All Python dependencies updated to latest versions (Python 3.13 compatible)
            - **Security**: cryptography 46.0.3, pyOpenSSL 25.3.0 with important security fixes
            - **WebAuthn**: Updated to 2.7.0 with FIDO2 improvements
            - **Certificate Management**: Fixed HTTPS certificate source selector state management
            - **UI Improvements**: Added certificate source tracking badges (Managed/Imported/Auto-generated)
            - **Bug Fixes**: Fixed Dockerfile bash expansion, certificate selector pre-selection
            
            See [RELEASE_NOTES_v1.7.5.md](https://github.com/${{ github.repository }}/blob/main/RELEASE_NOTES_v1.7.5.md) for full details.
          draft: false
          prerelease: false
        env:
          GITHUB_TOKEN: ${{ secrets.GITHUB_TOKEN }}

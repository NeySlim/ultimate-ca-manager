name: Build Debian Package

on:
  push:
    tags:
      - 'v*'
  workflow_dispatch:

permissions:
  contents: write

jobs:
  build-deb:
    runs-on: ubuntu-latest
    
    steps:
      - uses: actions/checkout@v4
      
      - name: Get version
        id: version
        run: echo "VERSION=${GITHUB_REF#refs/tags/v}" >> $GITHUB_OUTPUT
      
      - name: Install dependencies
        run: |
          sudo apt-get update
          sudo apt-get install -y build-essential debhelper fakeroot
      
      - name: Build package
        run: |
          VERSION="${{ steps.version.outputs.VERSION }}"
          BUILD_DIR="debian/ucm-${VERSION}"
          
          mkdir -p ${BUILD_DIR}/{DEBIAN,opt/ucm,etc/systemd/system}
          
          cp -r backend frontend ${BUILD_DIR}/opt/ucm/
          cp .env.example ${BUILD_DIR}/opt/ucm/
          
          cat > ${BUILD_DIR}/DEBIAN/control << EOF
Package: ucm
Version: ${VERSION}
Architecture: all
Depends: python3 (>= 3.10), python3-pip, systemd, openssl
Maintainer: UCM Team <support@ucm.local>
Description: Certificate Authority Management System
EOF
          
          cp packaging/debian/ucm.service ${BUILD_DIR}/etc/systemd/system/
          cp packaging/debian/start-ucm.sh ${BUILD_DIR}/opt/ucm/
          chmod +x ${BUILD_DIR}/opt/ucm/start-ucm.sh
          
          cp packaging/debian/postinst-simple.sh ${BUILD_DIR}/DEBIAN/postinst
          chmod 755 ${BUILD_DIR}/DEBIAN/postinst
          
          cat > ${BUILD_DIR}/DEBIAN/prerm << 'EOF'
#!/bin/bash
systemctl stop ucm.service || true
systemctl disable ucm.service || true
EOF
          chmod 755 ${BUILD_DIR}/DEBIAN/prerm
          
          dpkg-deb --build ${BUILD_DIR}
          mv ${BUILD_DIR}.deb ucm_${VERSION}_all.deb
      
      - uses: actions/upload-artifact@v4
        with:
          name: debian-package
          path: ucm_*.deb
      
      - name: Release
        if: startsWith(github.ref, 'refs/tags/')
        uses: softprops/action-gh-release@v1
        with:
          files: ucm_*.deb

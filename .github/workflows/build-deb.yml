name: Build Debian Package

on:
  push:
    tags:
      - 'v*'
  workflow_dispatch:

permissions:
  contents: write

jobs:
  build-deb:
    runs-on: ubuntu-latest
    
    steps:
      - uses: actions/checkout@v4
      
      - name: Get version
        id: version
        run: echo "VERSION=${GITHUB_REF#refs/tags/v}" >> $GITHUB_OUTPUT
      
      - name: Install dependencies
        run: |
          sudo apt-get update
          sudo apt-get install -y build-essential debhelper fakeroot
      
      - name: Build package
        run: |
          VERSION="${{ steps.version.outputs.VERSION }}"
          BUILD_DIR="debian/ucm-${VERSION}"
          
          mkdir -p ${BUILD_DIR}/{DEBIAN,opt/ucm,etc/systemd/system}
          
          cp -r backend frontend ${BUILD_DIR}/opt/ucm/
          cp .env.example ${BUILD_DIR}/opt/ucm/
          
          # Create control file using echo - ROBUST, NO HEREDOC
          {
            echo "Package: ucm"
            echo "Version: ${VERSION}"
            echo "Section: admin"
            echo "Priority: optional"
            echo "Architecture: all"
            echo "Depends: python3 (>= 3.10), python3-pip, systemd, openssl"
            echo "Maintainer: UCM Team <support@ucm.local>"
            echo "Description: Certificate Authority Management System"
          } > ${BUILD_DIR}/DEBIAN/control
          
          cp packaging/debian/ucm.service ${BUILD_DIR}/etc/systemd/system/
          cp packaging/debian/start-ucm.sh ${BUILD_DIR}/opt/ucm/
          chmod +x ${BUILD_DIR}/opt/ucm/start-ucm.sh
          
          cp packaging/debian/postinst-simple.sh ${BUILD_DIR}/DEBIAN/postinst
          chmod 755 ${BUILD_DIR}/DEBIAN/postinst
          
          # Create prerm using echo - ROBUST, NO HEREDOC
          {
            echo "#!/bin/bash"
            echo "systemctl stop ucm.service || true"
            echo "systemctl disable ucm.service || true"
          } > ${BUILD_DIR}/DEBIAN/prerm
          chmod 755 ${BUILD_DIR}/DEBIAN/prerm
          
          dpkg-deb --build ${BUILD_DIR}
          mv ${BUILD_DIR}.deb ucm_${VERSION}_all.deb
          
          # Create source tarball
          tar czf ucm-${VERSION}.tar.gz \
            --exclude='.git' \
            --exclude='debian' \
            --exclude='__pycache__' \
            --exclude='*.pyc' \
            --exclude='backend/data/*.db' \
            backend/ frontend/ packaging/ .env.example README.md CHANGELOG.md
          
          # Generate checksums
          sha256sum ucm_${VERSION}_all.deb > ucm_${VERSION}_all.deb.sha256
          md5sum ucm_${VERSION}_all.deb > ucm_${VERSION}_all.deb.md5
          sha256sum ucm-${VERSION}.tar.gz > ucm-${VERSION}.tar.gz.sha256
          md5sum ucm-${VERSION}.tar.gz > ucm-${VERSION}.tar.gz.md5
      
      - uses: actions/upload-artifact@v4
        with:
          name: debian-package
          path: |
            ucm_*.deb
            ucm_*.deb.sha256
            ucm_*.deb.md5
            ucm-*.tar.gz
            ucm-*.tar.gz.sha256
            ucm-*.tar.gz.md5
      
      - name: Release
        if: startsWith(github.ref, 'refs/tags/')
        uses: softprops/action-gh-release@v1
        with:
          files: |
            ucm_*.deb
            ucm_*.deb.sha256
            ucm_*.deb.md5
            ucm-*.tar.gz
            ucm-*.tar.gz.sha256
            ucm-*.tar.gz.md5

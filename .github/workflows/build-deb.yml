name: Build Debian Package

on:
  push:
    tags:
      - 'v*.*.*'
  workflow_dispatch:

permissions:
  contents: write
  discussions: write

jobs:
  build-deb:
    runs-on: ubuntu-latest
    
    steps:
      - name: Checkout code
        uses: actions/checkout@v4
      
      - name: Set up Python
        uses: actions/setup-python@v5
        with:
          python-version: '3.11'
      
      - name: Get version from tag
        id: get_version
        run: |
          if [[ "${GITHUB_REF}" == refs/tags/* ]]; then
            VERSION=${GITHUB_REF#refs/tags/v}
          else
            VERSION="1.6.0"
          fi
          echo "VERSION=${VERSION}" >> $GITHUB_OUTPUT
          echo "Building version: ${VERSION}"
      
      - name: Install build dependencies
        run: |
          sudo apt-get update
          sudo apt-get install -y \
            build-essential \
            debhelper \
            dh-python \
            python3-all \
            python3-setuptools \
            fakeroot \
            lintian
      
      - name: Create package structure
        run: |
          VERSION="${{ steps.get_version.outputs.VERSION }}"
          PKG_NAME="ucm-${VERSION}"
          
          # Create debian directory structure
          mkdir -p debian/${PKG_NAME}/DEBIAN
          mkdir -p debian/${PKG_NAME}/opt/ucm
          mkdir -p debian/${PKG_NAME}/etc/systemd/system
          mkdir -p debian/${PKG_NAME}/usr/share/doc/ucm
          
          # Copy application files
          cp -r backend frontend debian/${PKG_NAME}/opt/ucm/
          cp .env.example debian/${PKG_NAME}/opt/ucm/
          cp README.md INSTALLATION.md debian/${PKG_NAME}/usr/share/doc/ucm/
          
          # Create control file
          cat > debian/${PKG_NAME}/DEBIAN/control << EOF
          Package: ucm
          Version: ${VERSION}
          Section: admin
          Priority: optional
          Architecture: all
          Depends: python3 (>= 3.11), python3-pip, python3-venv, nginx, systemd
          Maintainer: UCM Team <support@ucm.local>
          Description: Ultimate CA Manager
           A comprehensive Certificate Authority management system.
           Features include:
            - CA creation and management
            - Certificate issuance and revocation
            - CRL distribution
            - OCSP responder
            - SCEP server
            - Web-based management interface
          EOF
          
          # Create systemd service
          cat > debian/${PKG_NAME}/etc/systemd/system/ucm.service << EOF
          [Unit]
          Description=Ultimate CA Manager
          After=network.target
          
          [Service]
          Type=simple
          User=ucm
          Group=ucm
          WorkingDirectory=/opt/ucm
          Environment="PATH=/opt/ucm/venv/bin"
          ExecStart=/opt/ucm/venv/bin/gunicorn -c /opt/ucm/backend/gunicorn_config.py backend.app:app
          Restart=always
          RestartSec=10
          
          [Install]
          WantedBy=multi-user.target
          EOF
          
          # Create postinst script
          cat > debian/${PKG_NAME}/DEBIAN/postinst << 'EOF'
          #!/bin/bash
          set -e
          
          # Create ucm user if not exists
          if ! id -u ucm > /dev/null 2>&1; then
              useradd -r -s /bin/bash -d /opt/ucm -m ucm
          fi
          
          # Set permissions
          chown -R ucm:ucm /opt/ucm
          chmod 755 /opt/ucm
          
          # Create virtual environment
          cd /opt/ucm
          python3 -m venv venv
          source venv/bin/activate
          pip install --upgrade pip
          pip install -r backend/requirements.txt
          
          # Create data directories
          mkdir -p /opt/ucm/data/{ca,certs,crl,ocsp,scep}
          chown -R ucm:ucm /opt/ucm/data
          
          # Initialize database if not exists
          if [ ! -f /opt/ucm/data/ucm.db ]; then
              sudo -u ucm venv/bin/python backend/init_db.py
          fi
          
          # Enable and start service
          systemctl daemon-reload
          systemctl enable ucm.service
          systemctl start ucm.service
          
          echo "UCM installed successfully!"
          echo "Access the web interface at: https://$(hostname -I | awk '{print $1}'):8443"
          
          exit 0
          EOF
          
          chmod 755 debian/${PKG_NAME}/DEBIAN/postinst
          
          # Create prerm script
          cat > debian/${PKG_NAME}/DEBIAN/prerm << 'EOF'
          #!/bin/bash
          set -e
          
          # Stop service
          systemctl stop ucm.service || true
          systemctl disable ucm.service || true
          
          exit 0
          EOF
          
          chmod 755 debian/${PKG_NAME}/DEBIAN/prerm
      
      - name: Build package
        run: |
          VERSION="${{ steps.get_version.outputs.VERSION }}"
          PKG_NAME="ucm-${VERSION}"
          
          # Build deb package
          dpkg-deb --build debian/${PKG_NAME}
          mv debian/${PKG_NAME}.deb ucm_${VERSION}_all.deb
          
          # Create checksums
          md5sum ucm_${VERSION}_all.deb > ucm_${VERSION}_all.deb.md5
          sha256sum ucm_${VERSION}_all.deb > ucm_${VERSION}_all.deb.sha256
      
      - name: Upload artifacts
        uses: actions/upload-artifact@v4
        with:
          name: debian-package
          path: |
            ucm_*.deb
            ucm_*.md5
            ucm_*.sha256
      
      - name: Create Release
        if: startsWith(github.ref, 'refs/tags/')
        uses: softprops/action-gh-release@v1
        with:
          files: |
            ucm_*.deb
            ucm_*.md5
            ucm_*.sha256
          body: |
            ## UCM ${{ steps.get_version.outputs.VERSION }}
            
            ### Installation
            ```bash
            wget https://github.com/${{ github.repository }}/releases/download/${{ github.ref_name }}/ucm_${{ steps.get_version.outputs.VERSION }}_all.deb
            sudo dpkg -i ucm_${{ steps.get_version.outputs.VERSION }}_all.deb
            ```
            
            ### What's New
            - Complete Tailwind CSS removal - now using custom CSS with theme variables
            - Custom styled scrollbars for all themes
            - Modal body scroll lock
            - Fixed modal z-index issues
            - Fixed HTMX modal triggers from sidebar
            - Fixed JavaScript variable conflicts
            - CRL info page (public and integrated)
            - Improved theme consistency across all pages
          draft: false
          prerelease: false
        env:
          GITHUB_TOKEN: ${{ secrets.GITHUB_TOKEN }}

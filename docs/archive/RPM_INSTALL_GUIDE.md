# UCM RPM Package Guide

Complete guide for building and installing UCM RPM packages on RedHat/CentOS/Fedora/Rocky Linux systems.

## Quick Start

### For RPM-based Systems (RHEL, CentOS, Fedora, Rocky Linux)

```bash
# Install the RPM
sudo dnf install ./ucm-1.8.0-1.el9.noarch.rpm

# Start the service
sudo systemctl start ucm
sudo systemctl enable ucm

# Access UCM
https://your-server.domain:8443
```

Default credentials are displayed during installation. **Change them immediately!**

---

## Table of Contents

1. [Building RPM Packages](#building-rpm-packages)
2. [Installation](#installation)
3. [Configuration](#configuration)
4. [Service Management](#service-management)
5. [Upgrading](#upgrading)
6. [Troubleshooting](#troubleshooting)

---

## Building RPM Packages

### Prerequisites

```bash
# For RHEL/CentOS/Rocky Linux
sudo dnf install rpm-build python3-devel python3-pip openssl-devel

# For Fedora
sudo dnf install rpm-build python3-devel python3-pip openssl-devel
```

### Build Process

```bash
# Clone repository
git clone https://github.com/NeySlim/ultimate-ca-manager.git
cd ultimate-ca-manager

# Build RPM
cd packaging/scripts
./build-rpm.sh

# RPMs will be in project root
ls -lh ../../ucm-*.rpm
```

### Build Output

```
ucm-1.8.0-1.el9.noarch.rpm       # Main package
ucm-1.8.0-1.el9.noarch.rpm.md5   # MD5 checksum
ucm-1.8.0-1.el9.noarch.rpm.sha256 # SHA256 checksum
```

### Custom Version

```bash
./build-rpm.sh 1.9.0 2  # Version 1.9.0, Release 2
```

---

## Installation

### System Requirements

- **OS**: RHEL 9+, CentOS Stream 9+, Fedora 38+, Rocky Linux 9+
- **Python**: 3.10 or higher
- **Memory**: 2GB minimum, 4GB recommended
- **Disk**: 10GB minimum
- **Architecture**: x86_64, aarch64

### Install from RPM

```bash
# Install
sudo dnf install ./ucm-1.8.0-1.el9.noarch.rpm

# The installer will:
# 1. Install all dependencies via pip
# 2. Create 'ucm' system user
# 3. Generate secure secrets
# 4. Initialize database
# 5. Create systemd service
# 6. Display initial admin credentials
```

### Installation Paths

| Type | Path | Description |
|------|------|-------------|
| Application | `/usr/share/ucm/` | Code, templates, static files |
| Configuration | `/etc/ucm/` | .env file, HTTPS certificates |
| Data | `/var/lib/ucm/` | Database, CAs, certificates |
| Logs | `/var/log/ucm/` | Application logs |
| Service | `/usr/lib/systemd/system/ucm.service` | Systemd unit |

### Post-Installation

```bash
# View initial credentials (shown during install)
sudo journalctl -u ucm -n 50 | grep -A 5 "INSTALLED"

# Review configuration
sudo vi /etc/ucm/.env

# Start service
sudo systemctl start ucm

# Check status
sudo systemctl status ucm
```

---

## Configuration

### Initial Setup

The RPM installer creates `/etc/ucm/.env` with auto-generated secrets:

```bash
# View configuration
sudo cat /etc/ucm/.env

# Edit configuration
sudo vi /etc/ucm/.env

# Restart to apply changes
sudo systemctl restart ucm
```

### Interactive Reconfiguration

```bash
# Run configuration wizard
sudo ucm-configure

# This will prompt for:
# - FQDN
# - Ports (HTTP/HTTPS)
# - Admin credentials
# - Email settings (optional)
# - TLS settings
```

### Key Configuration Options

```bash
# Core Settings
FQDN=ca.example.com              # Your domain
HTTPS_PORT=8443                  # HTTPS port
HTTP_PORT=8080                   # HTTP redirect port

# Security
SECRET_KEY=<auto-generated>      # Flask secret
JWT_SECRET_KEY=<auto-generated>  # JWT signing key

# Admin (first run only)
INITIAL_ADMIN_USERNAME=admin
INITIAL_ADMIN_PASSWORD=<auto-generated>
INITIAL_ADMIN_EMAIL=admin@example.com

# Email (optional)
SMTP_ENABLED=true
SMTP_SERVER=smtp.example.com
SMTP_PORT=587
SMTP_USERNAME=ucm@example.com
SMTP_PASSWORD=yourpassword
SMTP_FROM=ucm@example.com
```

### Firewall Configuration

```bash
# Allow HTTPS port
sudo firewall-cmd --permanent --add-port=8443/tcp
sudo firewall-cmd --reload

# Or allow HTTP (redirect only)
sudo firewall-cmd --permanent --add-port=8080/tcp
sudo firewall-cmd --reload
```

### SELinux Configuration

```bash
# If SELinux is enforcing
sudo semanage port -a -t http_port_t -p tcp 8443
sudo semanage fcontext -a -t httpd_sys_content_t "/usr/share/ucm(/.*)?"
sudo semanage fcontext -a -t httpd_sys_rw_content_t "/var/lib/ucm(/.*)?"
sudo semanage fcontext -a -t httpd_log_t "/var/log/ucm(/.*)?"
sudo restorecon -Rv /usr/share/ucm /var/lib/ucm /var/log/ucm
```

---

## Service Management

### Systemd Commands

```bash
# Start service
sudo systemctl start ucm

# Stop service
sudo systemctl stop ucm

# Restart service
sudo systemctl restart ucm

# Enable on boot
sudo systemctl enable ucm

# Disable on boot
sudo systemctl disable ucm

# Check status
sudo systemctl status ucm

# View logs
sudo journalctl -u ucm -f
```

### Service Health

```bash
# Check if running
curl -k https://localhost:8443/api/health

# Expected response
{"status": "ok", "version": "1.8.0"}

# Check listening ports
sudo ss -tlnp | grep python3
```

### Log Files

```bash
# Application logs
sudo tail -f /var/log/ucm/error.log
sudo tail -f /var/log/ucm/access.log

# Systemd journal
sudo journalctl -u ucm -f

# Last 100 lines
sudo journalctl -u ucm -n 100
```

---

## Upgrading

### Upgrade from RPM

```bash
# Automatic backup is created in /var/backups/ucm/

# Upgrade package
sudo dnf upgrade ./ucm-1.9.0-1.el9.noarch.rpm

# Service is automatically restarted
sudo systemctl status ucm
```

### Manual Backup Before Upgrade

```bash
# Create backup
BACKUP_DIR="/var/backups/ucm/manual-$(date +%Y%m%d-%H%M%S)"
sudo mkdir -p "$BACKUP_DIR"
sudo cp -r /var/lib/ucm "$BACKUP_DIR/"
sudo cp /etc/ucm/.env "$BACKUP_DIR/"

echo "Backup created: $BACKUP_DIR"
```

### Rollback

```bash
# Downgrade to previous version
sudo dnf downgrade ucm

# Or install specific version
sudo dnf install ucm-1.7.0-1.el9.noarch.rpm

# Restore from backup
sudo systemctl stop ucm
sudo cp -r /var/backups/ucm/YYYYMMDD-HHMMSS/ucm/* /var/lib/ucm/
sudo systemctl start ucm
```

---

## Troubleshooting

### Service Won't Start

```bash
# Check systemd status
sudo systemctl status ucm -l

# Check logs
sudo journalctl -u ucm -n 100 --no-pager

# Common issues:
# 1. Port already in use
sudo ss -tlnp | grep 8443

# 2. Permission issues
sudo chown -R ucm:ucm /var/lib/ucm /var/log/ucm /etc/ucm
sudo chmod 700 /var/lib/ucm/{cas,certs,backups}

# 3. Missing dependencies
cd /usr/share/ucm
sudo -u ucm python3 -m pip install -r backend/requirements.txt
```

### Database Issues

```bash
# Reinitialize database (DESTROYS DATA!)
sudo systemctl stop ucm
sudo rm /var/lib/ucm/ucm.db
sudo systemctl start ucm

# Check database
sudo -u ucm python3 << 'EOF'
import sys
sys.path.insert(0, '/usr/share/ucm/backend')
from models import db, User
from app import create_app
app = create_app()
with app.app_context():
    print(f"Users: {User.query.count()}")
EOF
```

### Can't Access Web UI

```bash
# Check service is running
sudo systemctl status ucm

# Check firewall
sudo firewall-cmd --list-ports

# Check SELinux (if enforcing)
sudo ausearch -m AVC -ts recent | grep ucm

# Test locally
curl -k https://localhost:8443/api/health
```

### Reset Admin Password

```bash
sudo -u ucm python3 << 'EOF'
import sys
import os
sys.path.insert(0, '/usr/share/ucm/backend')
os.chdir('/usr/share/ucm')

from dotenv import load_dotenv
load_dotenv('/etc/ucm/.env')

from models import db, User
from app import create_app

app = create_app()
with app.app_context():
    admin = User.query.filter_by(username='admin').first()
    if admin:
        new_password = 'NewSecurePassword123!'
        admin.set_password(new_password)
        db.session.commit()
        print(f"Password changed for: {admin.username}")
        print(f"New password: {new_password}")
    else:
        print("Admin user not found!")
EOF
```

### Performance Issues

```bash
# Check system resources
htop
df -h
free -h

# Check database size
du -sh /var/lib/ucm/ucm.db

# Optimize database
sudo -u ucm sqlite3 /var/lib/ucm/ucm.db "VACUUM;"

# Increase gunicorn workers (edit .env)
sudo vi /etc/ucm/.env
# Add: GUNICORN_WORKERS=8
sudo systemctl restart ucm
```

### Uninstall

```bash
# Remove package (keeps data)
sudo dnf remove ucm

# Remove all data (DESTRUCTIVE!)
sudo rm -rf /var/lib/ucm
sudo rm -rf /etc/ucm
sudo rm -rf /var/log/ucm

# Remove user
sudo userdel ucm
sudo groupdel ucm
```

---

## Advanced Configuration

### Custom HTTPS Certificate

```bash
# Copy your certificate and key
sudo cp your-cert.pem /etc/ucm/https_cert.pem
sudo cp your-key.pem /etc/ucm/https_key.pem
sudo chown ucm:ucm /etc/ucm/https_*.pem
sudo chmod 600 /etc/ucm/https_*.pem

# Update .env
sudo vi /etc/ucm/.env
# Set: HTTPS_AUTO_GENERATE=false

# Restart
sudo systemctl restart ucm
```

### External Database

```bash
# Install PostgreSQL client
sudo dnf install python3-psycopg2

# Update .env
SQLALCHEMY_DATABASE_URI=postgresql://ucm:password@db-server:5432/ucm_db

# Restart
sudo systemctl restart ucm
```

### Behind Reverse Proxy

```bash
# Nginx example
upstream ucm {
    server 127.0.0.1:8443;
}

server {
    listen 443 ssl http2;
    server_name ca.example.com;
    
    ssl_certificate /etc/letsencrypt/live/ca.example.com/fullchain.pem;
    ssl_certificate_key /etc/letsencrypt/live/ca.example.com/privkey.pem;
    
    location / {
        proxy_pass https://ucm;
        proxy_ssl_verify off;
        proxy_set_header Host $host;
        proxy_set_header X-Real-IP $remote_addr;
        proxy_set_header X-Forwarded-For $proxy_add_x_forwarded_for;
        proxy_set_header X-Forwarded-Proto $scheme;
    }
}
```

---

## Support

- **Documentation**: See `/usr/share/doc/ucm/` after installation
- **Logs**: `/var/log/ucm/`
- **Issues**: https://github.com/NeySlim/ultimate-ca-manager/issues

---

**Last Updated**: 2026-01-09  
**UCM Version**: 1.8.0

# UCM Installation Guide

## Quick Install

### Debian/Ubuntu
```bash
wget https://github.com/NeySlim/ultimate-ca-manager/releases/download/v2.1.0/ucm_2.1.0_all.deb
sudo dpkg -i ucm_2.1.0_all.deb
```

### RHEL/Fedora/Rocky
```bash
wget https://github.com/NeySlim/ultimate-ca-manager/releases/download/v2.1.0/ucm-2.1.0-1.noarch.rpm
sudo dnf install ucm-2.1.0-1.noarch.rpm
```

### Docker
```bash
docker run -d -p 8443:8443 -v ucm-data:/opt/ucm/data neyslim/ucm:2.1.0
```

---

## Installation Options

UCM supports both interactive and non-interactive installation modes.

### Interactive Installation (Default)

When installing without environment variables, UCM will prompt for configuration:

```bash
sudo dpkg -i ucm.deb
# → HTTPS port [8443]: 
# → Open firewall for UCM? [Y/n]: 
```

### Non-Interactive Installation (CI/Automation)

Use environment variables to skip prompts:

```bash
# Full automation
sudo UCM_PORT=8443 UCM_FIREWALL=yes dpkg -i ucm.deb

# Skip firewall configuration
sudo UCM_FIREWALL=no dpkg -i ucm.deb

# Custom port with firewall
sudo UCM_PORT=9443 UCM_FIREWALL=yes dnf install ucm.rpm
```

### Environment Variables

| Variable | Default | Description |
|----------|---------|-------------|
| `UCM_PORT` | `8443` | HTTPS port for UCM web interface |
| `UCM_FIREWALL` | `ask` | Firewall configuration: `yes`, `no`, or `ask` |

---

## Firewall Configuration

UCM can automatically configure your firewall during installation.

### Supported Firewalls

| Firewall | Distributions |
|----------|---------------|
| `firewalld` | RHEL, Fedora, Rocky, CentOS, AlmaLinux |
| `ufw` | Ubuntu, Debian |
| `iptables` | All Linux (fallback) |

### Manual Firewall Configuration

If you skip automatic configuration, use these commands:

#### firewalld
```bash
sudo firewall-cmd --permanent --add-port=8443/tcp
sudo firewall-cmd --reload
```

#### ufw
```bash
sudo ufw allow 8443/tcp
```

#### iptables
```bash
sudo iptables -I INPUT -p tcp --dport 8443 -j ACCEPT
```

### Post-Install Configuration

You can reconfigure the firewall after installation:

```bash
sudo /opt/ucm/scripts/configure-firewall.sh
```

---

## First Login

After installation:

1. Access UCM at `https://<hostname>:8443`
2. Default credentials are shown during installation
3. Change the admin password immediately

### Find Initial Password

If you missed the install output:

```bash
# Check install log
grep "Admin password" /var/log/dpkg.log  # Debian
journalctl -u ucm | grep "password"      # systemd

# Or check config file
sudo grep INITIAL_ADMIN_PASSWORD /etc/ucm/ucm.env
```

---

## Configuration

Main configuration file: `/etc/ucm/ucm.env`

```bash
# Edit configuration
sudo nano /etc/ucm/ucm.env

# Restart after changes
sudo systemctl restart ucm
```

### Common Settings

```bash
# Network
HTTPS_PORT=8443

# Security
SESSION_TIMEOUT=3600
JWT_ACCESS_TOKEN_EXPIRES=900

# Logging
LOG_LEVEL=INFO

# HTTPS Certificate (auto-generated by default)
HTTPS_CERT_PATH=/opt/ucm/data/https_cert.pem
HTTPS_KEY_PATH=/opt/ucm/data/https_key.pem
```

---

## Service Management

```bash
# Status
sudo systemctl status ucm

# Restart
sudo systemctl restart ucm

# Logs
sudo journalctl -u ucm -f

# Log files
ls /var/log/ucm/
```

---

## Upgrade

### DEB
```bash
sudo dpkg -i ucm_new_version.deb
```

### RPM
```bash
sudo dnf upgrade ucm-new_version.rpm
```

Data is preserved automatically. The installer migrates the database schema if needed.

---

## Uninstall

### DEB
```bash
sudo apt remove ucm
# Keep data: /opt/ucm/data is NOT removed

# Full removal including data:
sudo apt purge ucm
sudo rm -rf /opt/ucm /etc/ucm /var/log/ucm
```

### RPM
```bash
sudo dnf remove ucm
```

---

## Troubleshooting

### Service won't start
```bash
# Check logs
sudo journalctl -u ucm --no-pager -n 50

# Check permissions
ls -la /opt/ucm/data/
```

### Port already in use
```bash
# Find what's using the port
sudo ss -tlnp | grep 8443

# Change port in config
sudo sed -i 's/HTTPS_PORT=8443/HTTPS_PORT=9443/' /etc/ucm/ucm.env
sudo systemctl restart ucm
```

### Firewall blocking
```bash
# Check firewall status
sudo firewall-cmd --list-all  # RHEL/Fedora
sudo ufw status               # Ubuntu/Debian

# Manually open port
sudo /opt/ucm/scripts/configure-firewall.sh
```

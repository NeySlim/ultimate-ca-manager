# UCM Deployment Guide

## Fresh Installation

### Debian/Ubuntu
```bash
sudo dpkg -i ucm_2.0.0_amd64.deb
sudo apt-get install -f  # Install dependencies if needed
```

### RHEL/Fedora
```bash
sudo dnf install ucm-2.0.0-1.x86_64.rpm
```

### Docker
```bash
docker run -d -p 8443:8443 -v ucm-data:/opt/ucm/data ucm:2.0.0
```

## What Happens on First Start

1. **Database Creation** (`init_db.py`)
   - Creates SQLite database at `/opt/ucm/data/ucm.db`
   - Creates all 34 tables (26 community + 8 Pro if available)
   - Creates default admin user

2. **HTTPS Certificates** (`app.py`)
   - Auto-generates self-signed certificate at startup
   - Location: `/opt/ucm/data/https_cert.pem`, `/opt/ucm/data/https_key.pem`
   - Valid for 10 years, includes localhost and hostname as SANs

3. **Secrets Generation** (`postinst`)
   - `SECRET_KEY` - Flask session encryption
   - `JWT_SECRET_KEY` - JWT token signing
   - `INITIAL_ADMIN_PASSWORD` - First admin password
   - Stored in `/etc/ucm/ucm.env` (chmod 600)

4. **Migrations** (`migration_runner.py`)
   - Runs automatically on each startup
   - Tracks applied migrations in `_migrations` table
   - Idempotent - safe to run multiple times

## Upgrade Process

### Standard Upgrade
```bash
# Debian
sudo dpkg -i ucm_2.0.0_amd64.deb

# RPM
sudo dnf upgrade ucm-2.0.0-1.x86_64.rpm
```

### What Happens
1. New files installed to `/opt/ucm/`
2. Config preserved at `/etc/ucm/ucm.env`
3. Database preserved at `/opt/ucm/data/ucm.db`
4. Service restarts
5. Pending migrations run automatically

### Pre-Upgrade Checklist
- [ ] Backup database: `cp /opt/ucm/data/ucm.db /opt/ucm/data/ucm.db.bak`
- [ ] Backup config: `cp /etc/ucm/ucm.env /etc/ucm/ucm.env.bak`
- [ ] Note current version: `cat /opt/ucm/VERSION`

## Configuration

### Location
- **Debian/RPM**: `/etc/ucm/ucm.env`
- **Docker**: Environment variables or mounted config

### Required Variables
```env
SECRET_KEY=<auto-generated>
JWT_SECRET_KEY=<auto-generated>
DATABASE_PATH=/opt/ucm/data/ucm.db
```

### Optional Variables
```env
# Network
HTTPS_PORT=8443
HTTP_PORT=8080
HTTP_REDIRECT=true
FQDN=ucm.example.com

# Security
SESSION_TIMEOUT=3600
JWT_ACCESS_TOKEN_EXPIRES=900
RATE_LIMIT_ENABLED=true

# HTTPS (custom certs)
HTTPS_CERT_PATH=/opt/ucm/data/https_cert.pem
HTTPS_KEY_PATH=/opt/ucm/data/https_key.pem

# Logging
LOG_LEVEL=INFO
```

See `/etc/ucm/ucm.env` for full list with comments.

## Database Migrations

### Manual Check
```bash
cd /opt/ucm/backend
python3 migration_runner.py status
```

### Manual Run
```bash
cd /opt/ucm/backend
DATABASE_PATH=/opt/ucm/data/ucm.db python3 migration_runner.py run
```

### Creating New Migrations
```python
# backend/migrations/008_example.py
"""
Migration: Description of change
"""

def upgrade(db_path):
    import sqlite3
    conn = sqlite3.connect(db_path)
    cursor = conn.cursor()
    
    try:
        # Check if already applied
        cursor.execute("PRAGMA table_info(table_name)")
        columns = [row[1] for row in cursor.fetchall()]
        
        if 'new_column' not in columns:
            cursor.execute("ALTER TABLE table_name ADD COLUMN new_column TYPE")
            conn.commit()
            print("✓ Added new_column")
        else:
            print("✓ new_column already exists")
    finally:
        conn.close()

def downgrade(db_path):
    print("Note: SQLite doesn't support DROP COLUMN")
```

## Troubleshooting

### Service Won't Start
```bash
journalctl -u ucm -n 100 --no-pager
```

### Database Issues
```bash
# Check database integrity
sqlite3 /opt/ucm/data/ucm.db "PRAGMA integrity_check"

# Check tables
sqlite3 /opt/ucm/data/ucm.db ".tables"

# Reset admin password
cd /opt/ucm/backend
python3 -c "
from app import create_app
from models import User
app = create_app()
with app.app_context():
    admin = User.query.filter_by(username='admin').first()
    admin.set_password('newpassword')
    from models import db
    db.session.commit()
"
```

### HTTPS Certificate Issues
```bash
# Regenerate self-signed cert (delete existing first)
rm /opt/ucm/data/https_*.pem
systemctl restart ucm
```

## File Locations

| Path | Description |
|------|-------------|
| `/opt/ucm/` | Application root |
| `/opt/ucm/backend/` | Python backend |
| `/opt/ucm/frontend/` | React frontend (built) |
| `/opt/ucm/data/` | Database, certs, uploads |
| `/etc/ucm/ucm.env` | Configuration |
| `/var/log/ucm/` | Logs |

## Pro Features

Pro features are only available if the Pro license is installed:
- HSM/PKCS#11 integration
- SSO/SAML authentication
- RBAC with custom roles
- Certificate policies & approval workflows

Pro tables are created automatically when Pro modules are detected.

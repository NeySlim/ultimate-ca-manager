import{r as b,j as e,B as T,z as m,a as L}from"./index-B2vWR8IF.js";import{P as K}from"./PageTopBar-DhVcCdNE.js";import{B as D}from"./Badge-4hLjP3Zu.js";import{M as k}from"./Modal-C3IHZk7x.js";import{I as w}from"./Input-B7NhzasK.js";import{s as t}from"./CreateCAModal.module-BDqPs05w.js";import{u as z}from"./useQuery-0K-KGjTv.js";import{u as F}from"./useMutation-BBkt6Mzd.js";import{a as C}from"./api-ClVrI7m4.js";import{e as R}from"./export-BEFxFx9V.js";function I({isOpen:n,onClose:c}){const[a,r]=b.useState({name:"",description:"",type:"server",validityDays:"365",keySize:"2048",keyUsage:{digitalSignature:!0,keyEncipherment:!0,dataEncipherment:!1,keyAgreement:!1,keyCertSign:!1,crlSign:!1},extendedKeyUsage:{serverAuth:!1,clientAuth:!1,codeSigning:!1,emailProtection:!1,timeStamping:!1}}),[o,u]=b.useState(!1),x=async p=>{if(p.preventDefault(),!a.name){m.error("Template name is required");return}u(!0);try{const l=Object.entries(a.keyUsage).filter(([h,s])=>s).map(([h,s])=>h),j=Object.entries(a.extendedKeyUsage).filter(([h,s])=>s).map(([h,s])=>h),y=await fetch("/api/v2/templates",{method:"POST",headers:{"Content-Type":"application/json"},body:JSON.stringify({name:a.name,description:a.description,type:a.type,validity_days:parseInt(a.validityDays),key_size:parseInt(a.keySize),key_usage:l,extended_key_usage:j})});if(!y.ok){const h=await y.json();throw new Error(h.message||"Failed to create template")}m.success("Template created successfully"),c(),r({name:"",description:"",type:"server",validityDays:"365",keySize:"2048",keyUsage:{digitalSignature:!0,keyEncipherment:!0,dataEncipherment:!1,keyAgreement:!1,keyCertSign:!1,crlSign:!1},extendedKeyUsage:{serverAuth:!1,clientAuth:!1,codeSigning:!1,emailProtection:!1,timeStamping:!1}}),window.location.reload()}catch(l){m.error(l.message||"Failed to create template")}finally{u(!1)}},g=p=>{r(l=>({...l,[p.target.name]:p.target.value}))},i=p=>{r(l=>({...l,keyUsage:{...l.keyUsage,[p]:!l.keyUsage[p]}}))},f=p=>{r(l=>({...l,extendedKeyUsage:{...l.extendedKeyUsage,[p]:!l.extendedKeyUsage[p]}}))},N=p=>{const l=p.target.value;let j={...a.keyUsage},y={...a.extendedKeyUsage};l==="server"?(j={digitalSignature:!0,keyEncipherment:!0,dataEncipherment:!1,keyAgreement:!1,keyCertSign:!1,crlSign:!1},y={serverAuth:!0,clientAuth:!1,codeSigning:!1,emailProtection:!1,timeStamping:!1}):l==="client"?(j={digitalSignature:!0,keyEncipherment:!0,dataEncipherment:!1,keyAgreement:!1,keyCertSign:!1,crlSign:!1},y={serverAuth:!1,clientAuth:!0,codeSigning:!1,emailProtection:!1,timeStamping:!1}):l==="ca"&&(j={digitalSignature:!0,keyEncipherment:!1,dataEncipherment:!1,keyAgreement:!1,keyCertSign:!0,crlSign:!0},y={serverAuth:!1,clientAuth:!1,codeSigning:!1,emailProtection:!1,timeStamping:!1}),r(h=>({...h,type:l,keyUsage:j,extendedKeyUsage:y}))},E=e.jsxs(e.Fragment,{children:[e.jsx(T,{variant:"secondary",onClick:c,disabled:o,children:"Cancel"}),e.jsx(T,{variant:"primary",onClick:x,disabled:o,children:o?"Creating...":"Create Template"})]});return e.jsx(k,{isOpen:n,onClose:c,title:"New Certificate Template",size:"md",footer:E,children:e.jsxs("form",{onSubmit:x,className:t.form,children:[e.jsxs("div",{className:t.section,children:[e.jsx("h3",{className:t.sectionTitle,children:"Template Information"}),e.jsx(w,{label:"Template Name",name:"name",value:a.name,onChange:g,placeholder:"Web Server Template",required:!0}),e.jsx(w,{label:"Description",name:"description",value:a.description,onChange:g,placeholder:"Template for web server certificates"}),e.jsxs("div",{className:t.field,children:[e.jsx("label",{className:t.label,children:"Template Type"}),e.jsxs("select",{name:"type",value:a.type,onChange:N,className:t.select,children:[e.jsx("option",{value:"server",children:"Server Authentication"}),e.jsx("option",{value:"client",children:"Client Authentication"}),e.jsx("option",{value:"ca",children:"Certificate Authority"}),e.jsx("option",{value:"code-signing",children:"Code Signing"}),e.jsx("option",{value:"email",children:"Email Protection"})]})]})]}),e.jsxs("div",{className:t.section,children:[e.jsx("h3",{className:t.sectionTitle,children:"Certificate Settings"}),e.jsxs("div",{className:t.row,children:[e.jsx(w,{label:"Validity Period (Days)",name:"validityDays",type:"number",value:a.validityDays,onChange:g,min:"1",max:"3650"}),e.jsxs("div",{className:t.field,children:[e.jsx("label",{className:t.label,children:"Key Size"}),e.jsxs("select",{name:"keySize",value:a.keySize,onChange:g,className:t.select,children:[e.jsx("option",{value:"2048",children:"2048 bits"}),e.jsx("option",{value:"3072",children:"3072 bits"}),e.jsx("option",{value:"4096",children:"4096 bits"})]})]})]})]}),e.jsxs("div",{className:t.section,children:[e.jsx("h3",{className:t.sectionTitle,children:"Key Usage"}),e.jsxs("div",{className:t.permissionsGrid,children:[e.jsxs("label",{className:t.checkboxLabel,children:[e.jsx("input",{type:"checkbox",checked:a.keyUsage.digitalSignature,onChange:()=>i("digitalSignature"),className:t.checkbox}),e.jsx("span",{children:"Digital Signature"})]}),e.jsxs("label",{className:t.checkboxLabel,children:[e.jsx("input",{type:"checkbox",checked:a.keyUsage.keyEncipherment,onChange:()=>i("keyEncipherment"),className:t.checkbox}),e.jsx("span",{children:"Key Encipherment"})]}),e.jsxs("label",{className:t.checkboxLabel,children:[e.jsx("input",{type:"checkbox",checked:a.keyUsage.dataEncipherment,onChange:()=>i("dataEncipherment"),className:t.checkbox}),e.jsx("span",{children:"Data Encipherment"})]}),e.jsxs("label",{className:t.checkboxLabel,children:[e.jsx("input",{type:"checkbox",checked:a.keyUsage.keyAgreement,onChange:()=>i("keyAgreement"),className:t.checkbox}),e.jsx("span",{children:"Key Agreement"})]}),e.jsxs("label",{className:t.checkboxLabel,children:[e.jsx("input",{type:"checkbox",checked:a.keyUsage.keyCertSign,onChange:()=>i("keyCertSign"),className:t.checkbox}),e.jsx("span",{children:"Certificate Sign"})]}),e.jsxs("label",{className:t.checkboxLabel,children:[e.jsx("input",{type:"checkbox",checked:a.keyUsage.crlSign,onChange:()=>i("crlSign"),className:t.checkbox}),e.jsx("span",{children:"CRL Sign"})]})]})]}),e.jsxs("div",{className:t.section,children:[e.jsx("h3",{className:t.sectionTitle,children:"Extended Key Usage"}),e.jsxs("div",{className:t.permissionsGrid,children:[e.jsxs("label",{className:t.checkboxLabel,children:[e.jsx("input",{type:"checkbox",checked:a.extendedKeyUsage.serverAuth,onChange:()=>f("serverAuth"),className:t.checkbox}),e.jsx("span",{children:"TLS Web Server Authentication"})]}),e.jsxs("label",{className:t.checkboxLabel,children:[e.jsx("input",{type:"checkbox",checked:a.extendedKeyUsage.clientAuth,onChange:()=>f("clientAuth"),className:t.checkbox}),e.jsx("span",{children:"TLS Web Client Authentication"})]}),e.jsxs("label",{className:t.checkboxLabel,children:[e.jsx("input",{type:"checkbox",checked:a.extendedKeyUsage.codeSigning,onChange:()=>f("codeSigning"),className:t.checkbox}),e.jsx("span",{children:"Code Signing"})]}),e.jsxs("label",{className:t.checkboxLabel,children:[e.jsx("input",{type:"checkbox",checked:a.extendedKeyUsage.emailProtection,onChange:()=>f("emailProtection"),className:t.checkbox}),e.jsx("span",{children:"Email Protection"})]}),e.jsxs("label",{className:t.checkboxLabel,children:[e.jsx("input",{type:"checkbox",checked:a.extendedKeyUsage.timeStamping,onChange:()=>f("timeStamping"),className:t.checkbox}),e.jsx("span",{children:"Time Stamping"})]})]})]})]})})}const _={getTemplates:async(n={})=>(await C.get("/api/v2/templates",{params:n})).data,getTemplateDetails:async n=>(await C.get(`/api/v2/templates/${n}`)).data,createTemplate:async n=>(await C.post("/api/v2/templates",n)).data,updateTemplate:async({id:n,...c})=>(await C.put(`/api/v2/templates/${n}`,c)).data,deleteTemplate:async n=>(await C.delete(`/api/v2/templates/${n}`)).data},S={all:["templates"],lists:()=>[...S.all,"list"],list:n=>[...S.lists(),n]},q=(n={})=>z({queryKey:S.list(n),queryFn:()=>_.getTemplates(n)}),M=()=>{const n=L();return F({mutationFn:_.updateTemplate,onSuccess:()=>{n.invalidateQueries({queryKey:S.all}),m.success("Template updated successfully")},onError:c=>{m.error(c.response?.data?.message||"Failed to update template")}})},O=()=>{const n=L();return F({mutationFn:_.deleteTemplate,onSuccess:()=>{n.invalidateQueries({queryKey:S.all}),m.success("Template deleted successfully")},onError:c=>{m.error(c.response?.data?.message||"Failed to delete template")}})},$=n=>z({queryKey:[...S.all,"detail",n],queryFn:()=>_.getTemplateDetails(n),enabled:!!n});function W({isOpen:n,onClose:c,templateId:a}){const[r,o]=b.useState({name:"",description:"",validityDays:397,keyType:"RSA-2048",digest:"sha256",isActive:!0}),{data:u}=$(a),x=M();b.useEffect(()=>{if(u?.data){const i=u.data;o({name:i.name||"",description:i.description||"",validityDays:i.validity_days||397,keyType:i.key_type||"RSA-2048",digest:i.digest||"sha256",isActive:i.is_active!==!1})}},[u]);const g=async i=>{if(i.preventDefault(),!r.name){m.error("Template name is required");return}x.mutate({id:a,name:r.name,description:r.description,validity_days:parseInt(r.validityDays),key_type:r.keyType,digest:r.digest,is_active:r.isActive},{onSuccess:()=>{c()}})};return a?e.jsxs(k,{isOpen:n,onClose:c,size:"medium",children:[e.jsxs(k.Header,{children:[e.jsx("i",{className:"ph ph-pencil-simple",style:{marginRight:"8px"}}),"Edit Template"]}),e.jsxs("form",{onSubmit:g,children:[e.jsx(k.Body,{children:e.jsxs("div",{style:{display:"flex",flexDirection:"column",gap:"16px"},children:[e.jsxs("div",{children:[e.jsxs("label",{style:{display:"block",fontSize:"13px",fontWeight:500,color:"var(--text-primary)",marginBottom:"6px"},children:["Template Name ",e.jsx("span",{style:{color:"var(--status-danger)"},children:"*"})]}),e.jsx("input",{type:"text",value:r.name,onChange:i=>o({...r,name:i.target.value}),style:{width:"100%",padding:"8px 12px",fontSize:"13px",border:"1px solid var(--border-primary)",borderRadius:"var(--radius)",background:"var(--bg-primary)",color:"var(--text-primary)"}})]}),e.jsxs("div",{children:[e.jsx("label",{style:{display:"block",fontSize:"13px",fontWeight:500,color:"var(--text-primary)",marginBottom:"6px"},children:"Description"}),e.jsx("textarea",{value:r.description,onChange:i=>o({...r,description:i.target.value}),rows:3,style:{width:"100%",padding:"8px 12px",fontSize:"13px",border:"1px solid var(--border-primary)",borderRadius:"var(--radius)",background:"var(--bg-primary)",color:"var(--text-primary)",resize:"vertical"}})]}),e.jsxs("div",{children:[e.jsx("label",{style:{display:"block",fontSize:"13px",fontWeight:500,color:"var(--text-primary)",marginBottom:"6px"},children:"Validity (Days)"}),e.jsx("input",{type:"number",value:r.validityDays,onChange:i=>o({...r,validityDays:i.target.value}),min:"1",max:"3650",style:{width:"100%",padding:"8px 12px",fontSize:"13px",border:"1px solid var(--border-primary)",borderRadius:"var(--radius)",background:"var(--bg-primary)",color:"var(--text-primary)"}})]}),e.jsxs("div",{children:[e.jsx("label",{style:{display:"block",fontSize:"13px",fontWeight:500,color:"var(--text-primary)",marginBottom:"6px"},children:"Key Type"}),e.jsxs("select",{value:r.keyType,onChange:i=>o({...r,keyType:i.target.value}),style:{width:"100%",padding:"8px 12px",fontSize:"13px",border:"1px solid var(--border-primary)",borderRadius:"var(--radius)",background:"var(--bg-primary)",color:"var(--text-primary)"},children:[e.jsx("option",{value:"RSA-2048",children:"RSA 2048"}),e.jsx("option",{value:"RSA-4096",children:"RSA 4096"}),e.jsx("option",{value:"ECDSA-P256",children:"ECDSA P-256"}),e.jsx("option",{value:"ECDSA-P384",children:"ECDSA P-384"})]})]}),e.jsxs("div",{children:[e.jsx("label",{style:{display:"block",fontSize:"13px",fontWeight:500,color:"var(--text-primary)",marginBottom:"6px"},children:"Signature Algorithm"}),e.jsxs("select",{value:r.digest,onChange:i=>o({...r,digest:i.target.value}),style:{width:"100%",padding:"8px 12px",fontSize:"13px",border:"1px solid var(--border-primary)",borderRadius:"var(--radius)",background:"var(--bg-primary)",color:"var(--text-primary)"},children:[e.jsx("option",{value:"sha256",children:"SHA-256"}),e.jsx("option",{value:"sha384",children:"SHA-384"}),e.jsx("option",{value:"sha512",children:"SHA-512"})]})]}),e.jsx("div",{children:e.jsxs("label",{style:{display:"flex",alignItems:"center",fontSize:"13px",fontWeight:500,color:"var(--text-primary)",cursor:"pointer"},children:[e.jsx("input",{type:"checkbox",checked:r.isActive,onChange:i=>o({...r,isActive:i.target.checked}),style:{marginRight:"8px"}}),"Active Template"]})})]})}),e.jsxs(k.Footer,{children:[e.jsx(k.CloseButton,{onClick:c,disabled:x.isPending,children:"Cancel"}),e.jsx(T,{type:"submit",variant:"primary",icon:"ph ph-check",disabled:x.isPending,children:x.isPending?"Saving...":"Save Changes"})]})]})]}):null}const H="_sectionHeader_1humx_2",V="_sectionTitle_1humx_10",Q="_filterBtn_1humx_16",G="_tableContainer_1humx_42",Y="_templateName_1humx_85",J="_keyUsage_1humx_91",X="_subjectPattern_1humx_97",Z="_statusBadge_1humx_107",ee="_badgeActive_1humx_118",te="_badgeSystem_1humx_123",se="_actionsCell_1humx_129",ae="_actionBtn_1humx_134",d={sectionHeader:H,sectionTitle:V,filterBtn:Q,tableContainer:G,templateName:Y,keyUsage:J,subjectPattern:X,statusBadge:Z,badgeActive:ee,badgeSystem:te,actionsCell:se,actionBtn:ae};function xe(){const[n,c]=b.useState(!1),[a,r]=b.useState(!1),[o,u]=b.useState(null),[x,g]=b.useState(!1),{data:i,isLoading:f,error:N}=q(),E=O(),l=(Array.isArray(i)?i:i?.data||[]).map(s=>{try{const v=s.dn_template;let U="N/A";if(typeof v=="string")U=v;else if(v&&typeof v=="object"){const B=Object.entries(v).filter(([P,A])=>A&&A.trim()).map(([P,A])=>`${P}=${A}`);U=B.length>0?B.join(", "):"N/A"}return{id:s.id,name:s.name||"Unnamed",keyUsage:s.extensions_template?.key_usage?.join(", ")||"N/A",validity:s.validity_days?`${s.validity_days} days`:"N/A",subjectPattern:U,usedBy:"0 certs",status:"ACTIVE",isSystem:s.is_system||!1}}catch(v){return console.error("Error mapping template:",s,v),null}}).filter(Boolean),j=()=>{if(l.length===0){m.error("No templates to export");return}R(l,"templates-export",{format:"csv",columns:["id","name","keyUsage","validity","subjectPattern","usedBy","status"]}),m.success("Templates exported successfully")},y=s=>{if(s.isSystem){m.error("Cannot delete system template");return}confirm(`Delete template "${s.name}"?`)&&E.mutate(s.id)},h=s=>{if(s.isSystem){m.error("Cannot edit system template");return}u(s.id),r(!0)};return N?e.jsxs("div",{className:d.templateList,children:[e.jsx(K,{icon:"ph ph-file-text",title:"Certificate Templates",badge:e.jsx(D,{variant:"danger",children:"Error"})}),e.jsxs("div",{style:{padding:"2rem",textAlign:"center",color:"var(--color-danger)"},children:["Error loading templates: ",N.message]})]}):e.jsxs("div",{className:d.templateList,children:[e.jsx(K,{icon:"ph ph-file-text",title:"Certificate Templates",badge:e.jsxs(D,{variant:"success",children:[l.length," Templates"]}),actions:e.jsxs(e.Fragment,{children:[e.jsx(T,{icon:"ph ph-download-simple",onClick:j,children:"Export"}),e.jsx(T,{variant:"primary",icon:"ph ph-plus",onClick:()=>c(!0),children:"New Template"})]})}),e.jsxs("div",{className:d.sectionHeader,children:[e.jsx("span",{className:d.sectionTitle,children:"Available Templates"}),e.jsxs("button",{className:d.filterBtn,onClick:()=>g(!x),children:[e.jsx("i",{className:"ph ph-funnel"}),"Filter"]})]}),e.jsx("div",{className:d.tableContainer,children:e.jsxs("table",{children:[e.jsx("thead",{children:e.jsxs("tr",{children:[e.jsx("th",{style:{width:"15%"},children:"TEMPLATE NAME"}),e.jsx("th",{style:{width:"25%"},children:"KEY USAGE"}),e.jsx("th",{style:{width:"10%"},children:"VALIDITY"}),e.jsx("th",{style:{width:"20%"},children:"SUBJECT PATTERN"}),e.jsx("th",{style:{width:"12%"},children:"USED BY"}),e.jsx("th",{style:{width:"10%"},children:"STATUS"}),e.jsx("th",{style:{width:"8%"},children:"ACTIONS"})]})}),e.jsx("tbody",{children:f?e.jsx("tr",{children:e.jsx("td",{colSpan:"7",style:{textAlign:"center",padding:"2rem"},children:"Loading templates..."})}):l.length===0?e.jsx("tr",{children:e.jsx("td",{colSpan:"7",style:{textAlign:"center",padding:"2rem"},children:"No templates found"})}):l.map(s=>e.jsxs("tr",{children:[e.jsxs("td",{children:[e.jsx("span",{className:d.templateName,children:s.name}),s.isSystem&&e.jsx(D,{variant:"info",style:{marginLeft:"0.5rem"},children:"System"})]}),e.jsx("td",{children:e.jsx("span",{className:d.keyUsage,children:s.keyUsage})}),e.jsx("td",{children:s.validity}),e.jsx("td",{children:e.jsx("code",{className:d.subjectPattern,children:s.subjectPattern})}),e.jsx("td",{children:s.usedBy}),e.jsx("td",{children:e.jsx("span",{className:`${d.statusBadge} ${s.status==="ACTIVE"?d.badgeActive:d.badgeSystem}`,children:s.status})}),e.jsx("td",{children:e.jsx("div",{className:d.actionsCell,children:!s.isSystem&&e.jsxs(e.Fragment,{children:[e.jsx("button",{className:d.actionBtn,title:"Edit",onClick:()=>h(s),children:e.jsx("i",{className:"ph ph-pencil"})}),e.jsx("button",{className:d.actionBtn,title:"Delete",onClick:()=>y(s),children:e.jsx("i",{className:"ph ph-trash"})})]})})})]},s.id))})]})}),e.jsx(I,{isOpen:n,onClose:()=>c(!1)}),e.jsx(W,{isOpen:a,onClose:()=>r(!1),templateId:o})]})}export{xe as TemplateList,xe as default};

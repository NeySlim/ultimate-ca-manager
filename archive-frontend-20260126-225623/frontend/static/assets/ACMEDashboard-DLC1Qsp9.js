import{b as f,d as V,r as y,j as e,B as b,z as u}from"./index-BArQLPjh.js";import{P as w}from"./PageTopBar--IXq1A98.js";import{S as G,a as N}from"./StatsGrid-FFJGEAis.js";import{S as J,T as k}from"./SectionTabs-Bja_8eWo.js";import{D as L}from"./DataTable-CA2yhyjs.js";import{S as X}from"./SearchToolbar-Cx1lb1BE.js";import{B as A}from"./Badge-srr-GGeK.js";import{g as O}from"./getBadgeVariant-SNrdtPAh.js";import{u as T}from"./useQuery-sbIOkzkR.js";import{u as Y}from"./useMutation-CXWK1Dp7.js";import{M as D}from"./Modal-Dg1C_Qou.js";import{I as q}from"./Input-7QoEBxGh.js";import{s as c}from"./CreateCAModal.module-BDqPs05w.js";const S={getSettings:async()=>(await f.get("/api/v2/acme/settings")).data,updateSettings:async a=>(await f.patch("/api/v2/acme/settings",a)).data,getStats:async()=>{const r=(await f.get("/api/v2/acme/stats")).data||{};return{accounts:r.active_accounts||0,activeOrders:r.pending_orders||0,completedOrders:r.valid_orders||0,domains:0,_raw:r}},getAccounts:async(a={})=>{const r=await f.get("/api/v2/acme/accounts",{params:a}),s=(r.data||[]).map(t=>({id:t.id,email:t.email||t.contact_email||"N/A",status:(t.status||"ACTIVE").toUpperCase(),createdAt:t.created_at?t.created_at.split("T")[0]:"N/A",orders:t.total_orders||0,_raw:t}));return{data:s,meta:r.meta||{page:1,per_page:20,total:s.length}}},getOrders:async(a={})=>{const r=await f.get("/api/v2/acme/orders",{params:a}),s=(r.data||[]).map(t=>({id:t.id,domain:t.domain||t.identifier||"N/A",account:t.account_email||t.account_id||"N/A",status:(t.status||"PENDING").toUpperCase(),createdAt:t.created_at?t.created_at.split("T")[0]:"N/A",expiresAt:t.expires_at?t.expires_at.split("T")[0]:"N/A",_raw:t}));return{data:s,meta:r.meta||{page:1,per_page:20,total:s.length}}}},h={all:["acme"],settings:()=>[...h.all,"settings"],stats:()=>[...h.all,"stats"],accounts:a=>[...h.all,"accounts",a],orders:a=>[...h.all,"orders",a]},Z=()=>T({queryKey:h.settings(),queryFn:S.getSettings}),$=()=>T({queryKey:h.stats(),queryFn:S.getStats}),W=(a={})=>T({queryKey:h.accounts(a),queryFn:()=>S.getAccounts(a)}),ee=(a={})=>T({queryKey:h.orders(a),queryFn:()=>S.getOrders(a)}),te=()=>{const a=V();return Y({mutationFn:S.updateSettings,onSuccess:()=>{a.invalidateQueries({queryKey:h.settings()})}})};function se({isOpen:a,onClose:r}){const[s,t]=y.useState({email:"",provider:"letsencrypt",termsAccepted:!1}),[p,g]=y.useState(!1),i=async m=>{if(m.preventDefault(),!s.email){u.error("Email is required");return}if(!s.termsAccepted){u.error("You must accept the terms of service");return}g(!0);try{const o=await fetch("/api/v2/acme/accounts",{method:"POST",headers:{"Content-Type":"application/json"},body:JSON.stringify({email:s.email,provider:s.provider,terms_accepted:s.termsAccepted})});if(!o.ok){const d=await o.json();throw new Error(d.message||"Failed to create ACME account")}u.success("ACME account created successfully"),r(),t({email:"",provider:"letsencrypt",termsAccepted:!1}),window.location.reload()}catch(o){u.error(o.message||"Failed to create ACME account")}finally{g(!1)}},x=m=>{const{name:o,value:d,type:C,checked:_}=m.target;t(E=>({...E,[o]:C==="checkbox"?_:d}))},v=e.jsxs(e.Fragment,{children:[e.jsx(b,{variant:"secondary",onClick:r,disabled:p,children:"Cancel"}),e.jsx(b,{variant:"primary",onClick:i,disabled:p,children:p?"Creating...":"Create Account"})]});return e.jsx(D,{isOpen:a,onClose:r,title:"New ACME Account",size:"sm",footer:v,children:e.jsx("form",{onSubmit:i,className:c.form,children:e.jsxs("div",{className:c.section,children:[e.jsxs("div",{className:c.field,children:[e.jsx("label",{className:c.label,children:"Provider"}),e.jsxs("select",{name:"provider",value:s.provider,onChange:x,className:c.select,children:[e.jsx("option",{value:"letsencrypt",children:"Let's Encrypt"}),e.jsx("option",{value:"letsencrypt-staging",children:"Let's Encrypt (Staging)"}),e.jsx("option",{value:"buypass",children:"Buypass"}),e.jsx("option",{value:"zerossl",children:"ZeroSSL"})]}),e.jsx("p",{className:c.helpText,children:"Let's Encrypt is recommended for production use"})]}),e.jsx(q,{label:"Email Address",name:"email",type:"email",value:s.email,onChange:x,placeholder:"admin@example.com",required:!0,helpText:"Used for certificate expiry notifications and account recovery"}),e.jsx("div",{className:c.field,children:e.jsxs("label",{className:c.checkboxLabel,children:[e.jsx("input",{type:"checkbox",name:"termsAccepted",checked:s.termsAccepted,onChange:x,className:c.checkbox}),e.jsxs("span",{children:["I agree to the"," ",e.jsx("a",{href:s.provider==="letsencrypt"?"https://letsencrypt.org/repository/":"#",target:"_blank",rel:"noopener noreferrer",className:c.link,children:s.provider==="letsencrypt"?"Let's Encrypt Subscriber Agreement":"Terms of Service"})]})]})})]})})})}function ae({isOpen:a,onClose:r}){const[s,t]=y.useState({domains:"",challengeType:"http-01"}),[p,g]=y.useState(!1),i=async m=>{if(m.preventDefault(),!s.domains.trim()){u.error("At least one domain is required");return}const o=s.domains.split(",").map(d=>d.trim()).filter(Boolean);if(o.length===0){u.error("Please enter valid domains");return}g(!0);try{const d=await fetch("/api/v2/acme/orders",{method:"POST",headers:{"Content-Type":"application/json"},body:JSON.stringify({domains:o,challenge_type:s.challengeType})});if(!d.ok){const C=await d.json();throw new Error(C.message||"Failed to create ACME order")}u.success("ACME order created successfully"),r(),t({domains:"",challengeType:"http-01"}),window.location.reload()}catch(d){u.error(d.message||"Failed to create ACME order")}finally{g(!1)}},x=m=>{t(o=>({...o,[m.target.name]:m.target.value}))},v=e.jsxs(e.Fragment,{children:[e.jsx(b,{variant:"secondary",onClick:r,disabled:p,children:"Cancel"}),e.jsx(b,{variant:"primary",onClick:i,disabled:p,children:p?"Creating...":"Create Order"})]});return e.jsx(D,{isOpen:a,onClose:r,title:"New ACME Order",size:"md",footer:v,children:e.jsxs("form",{onSubmit:i,className:c.form,children:[e.jsxs("div",{className:c.section,children:[e.jsx(q,{label:"Domains",name:"domains",value:s.domains,onChange:x,placeholder:"example.com, www.example.com, *.example.com",required:!0,helpText:"Comma-separated list of domains to include in the certificate"}),e.jsxs("div",{className:c.field,children:[e.jsx("label",{className:c.label,children:"Challenge Type"}),e.jsxs("select",{name:"challengeType",value:s.challengeType,onChange:x,className:c.select,children:[e.jsx("option",{value:"http-01",children:"HTTP-01 (Port 80)"}),e.jsx("option",{value:"dns-01",children:"DNS-01 (DNS TXT Record)"}),e.jsx("option",{value:"tls-alpn-01",children:"TLS-ALPN-01 (Port 443)"})]}),e.jsxs("p",{className:c.helpText,children:[s.challengeType==="http-01"&&"Requires HTTP server on port 80. Best for single domains.",s.challengeType==="dns-01"&&"Requires DNS access. Required for wildcard certificates.",s.challengeType==="tls-alpn-01"&&"Requires TLS server on port 443. Alternative to HTTP-01."]})]})]}),e.jsxs("div",{className:c.infoBox,children:[e.jsx("i",{className:"ph ph-info"}),e.jsxs("div",{children:[e.jsx("strong",{children:"Next Steps:"}),e.jsxs("ol",{style:{marginTop:"8px",paddingLeft:"20px"},children:[e.jsx("li",{children:"Order will be created and authorizations started"}),e.jsxs("li",{children:["Complete the ",s.challengeType.toUpperCase()," challenge for each domain"]}),e.jsx("li",{children:"Certificate will be issued automatically upon validation"})]})]})]})]})})}const re="_acmeDashboard_gmg05_3",ne="_tabContent_gmg05_8",ce="_directoryUrlsCard_gmg05_14",le="_directoryTitle_gmg05_21",oe="_urlsList_gmg05_30",ie="_urlItem_gmg05_36",de="_urlLabel_gmg05_42",me="_urlCode_gmg05_48",ue="_section_gmg05_61",pe="_sectionTitle_gmg05_67",n={acmeDashboard:re,tabContent:ne,directoryUrlsCard:ce,directoryTitle:le,urlsList:oe,urlItem:ie,urlLabel:de,urlCode:me,section:ue,sectionTitle:pe};function _e(){const[a,r]=y.useState("internal"),[s,t]=y.useState(!1),[p,g]=y.useState(!1),{data:i,isLoading:x,error:v}=Z(),{data:m,isLoading:o,error:d}=$(),{data:C,isLoading:_,error:E}=W(),{data:F,isLoading:P,error:I}=ee(),R=te(),B=x||o||_||P,M=v||d||E||I,U=[{key:"email",label:"Email",sortable:!0},{key:"status",label:"Status",sortable:!0,render:l=>e.jsx(A,{variant:O("acme-status",l.status),children:l.status})},{key:"createdAt",label:"Created At",sortable:!0},{key:"orders",label:"Orders",sortable:!0,render:l=>e.jsx("span",{style:{color:"var(--text-tertiary)"},children:l.orders})}],z=[{key:"domain",label:"Domain",sortable:!0},{key:"account",label:"Account",sortable:!0},{key:"status",label:"Status",sortable:!0,render:l=>e.jsx(A,{variant:O("acme-status",l.status),children:l.status})},{key:"createdAt",label:"Created",sortable:!0},{key:"expiresAt",label:"Expires",sortable:!0}],K=[{label:"Status",options:["All Statuses","Valid","Pending","Invalid"]}];if(B)return e.jsxs("div",{className:n.acmeDashboard,children:[e.jsx(w,{icon:"ph ph-globe",title:"ACME",badge:e.jsx(A,{variant:"neutral",children:"Loading..."})}),e.jsx("div",{style:{padding:"2rem",textAlign:"center"},children:"Loading ACME data..."})]});if(M)return e.jsxs("div",{className:n.acmeDashboard,children:[e.jsx(w,{icon:"ph ph-globe",title:"ACME",badge:e.jsx(A,{variant:"danger",children:"Error"})}),e.jsxs("div",{style:{padding:"2rem",textAlign:"center",color:"var(--color-danger)"},children:["Error loading ACME data: ",M.message]})]});const j={stats:m||{accounts:0,activeOrders:0,completedOrders:0,domains:0},accounts:C?.data||[],orders:F?.data||[]},H=()=>e.jsxs("div",{className:n.tabContent,children:[e.jsxs("div",{className:n.directoryUrlsCard,children:[e.jsxs("h3",{className:n.directoryTitle,children:[e.jsx("i",{className:"ph ph-link",style:{marginRight:"0.5rem"}}),"ACME Directory URLs"]}),e.jsxs("div",{className:n.urlsList,children:[e.jsxs("div",{className:n.urlItem,children:[e.jsx("label",{className:n.urlLabel,children:"Local ACME Server:"}),e.jsxs("code",{className:n.urlCode,children:[window.location.origin,"/acme/directory"]})]}),e.jsxs("div",{className:n.urlItem,children:[e.jsx("label",{className:n.urlLabel,children:"Let's Encrypt Proxy:"}),e.jsxs("code",{className:n.urlCode,children:[window.location.origin,"/acme/proxy/directory"]})]})]})]}),e.jsxs(G,{columns:4,children:[e.jsx(N,{value:j.stats.accounts,label:"Accounts",icon:"ph ph-user"}),e.jsx(N,{value:j.stats.activeOrders,label:"Active Orders",icon:"ph ph-clock"}),e.jsx(N,{value:j.stats.completedOrders,label:"Completed Orders",icon:"ph ph-check-circle"}),e.jsx(N,{value:j.stats.domains,label:"Domains",icon:"ph ph-globe"})]}),e.jsxs("div",{className:n.section,children:[e.jsx("h3",{className:n.sectionTitle,children:"Accounts"}),e.jsx(X,{placeholder:"Search accounts...",filters:K,onSearch:l=>console.log("Search:",l),onFilterChange:(l,Q)=>console.log("Filter:",l,Q)}),e.jsx(L,{columns:U,data:j.accounts,onRowClick:l=>console.log("Account clicked:",l)})]}),e.jsxs("div",{className:n.section,children:[e.jsx("h3",{className:n.sectionTitle,children:"Recent Orders"}),e.jsx(L,{columns:z,data:j.orders,onRowClick:l=>console.log("Order clicked:",l)})]})]});return e.jsxs("div",{className:n.acmeDashboard,children:[e.jsx(w,{icon:"ph ph-globe",title:"ACME",badge:e.jsx(A,{variant:i?.enabled?"success":"secondary",children:i?.enabled?"Enabled":"Disabled"}),actions:e.jsxs(e.Fragment,{children:[e.jsx(b,{onClick:()=>t(!0),icon:"ph ph-plus",children:"New Account"}),e.jsx(b,{onClick:()=>g(!0),icon:"ph ph-certificate",children:"New Order"}),e.jsxs(b,{variant:i?.enabled?"secondary":"primary",onClick:()=>{R.mutate({enabled:!i?.enabled},{onSuccess:()=>u.success(i?.enabled?"ACME disabled":"ACME enabled"),onError:()=>u.error("Failed to update ACME")})},children:[i?.enabled?"Disable":"Enable"," ACME"]})]})}),e.jsxs(J,{children:[e.jsx(k,{active:a==="internal",onClick:()=>r("internal"),children:"Internal ACME"}),e.jsx(k,{active:a==="letsencrypt",onClick:()=>r("letsencrypt"),children:"Let's Encrypt"})]}),e.jsx("div",{className:n.tabContent,children:H()}),e.jsx(se,{isOpen:s,onClose:()=>t(!1)}),e.jsx(ae,{isOpen:p,onClose:()=>g(!1)})]})}export{_e as ACMEDashboard,_e as default};

import{j as e}from"./radix-B6Y-MRu0.js";import{u as ae,a as n}from"./vendor-DEQSVNfj.js";import{u as se,c as ne,v as ie,i as le,q as oe,g as S,f as N,B as d,l as _,I as re,e as ce,k as de}from"./index-vswyqp58.js";import{n as me}from"./Globe.es-CtUoIY1T.js";import{s as L}from"./Download.es-Bp_lE9WD.js";import{c as U}from"./SignIn.es-DK32xfj-.js";import{n as T}from"./Trash.es-DhgoD9TD.js";import{M as I}from"./Modal-7_eTIvz3.js";import{B as k}from"./Badge-CZ5NzBfK.js";import{S as ue}from"./Select-PwXyFoxR.js";import{F as pe}from"./FileUpload-rkQjDMkl.js";import{H as D}from"./HelpCard-BINCqYIf.js";import{C as xe,a as ge,b as w,c as P,d as i}from"./DetailCard-BKBzFg8i.js";import{R as he}from"./ResponsiveDataTable-kYvH3TtM.js";import{R as je}from"./ResponsiveLayout-BgG2EW8C.js";import{c as Se}from"./cas.service-CAbj5j2-.js";import{c as j}from"./csrs.service-B5ZOA1gt.js";import{u as ye}from"./usePermission-B5db8pNS.js";import{u as Ce}from"./useCommon-lRatzZ8x.js";import"./CaretDown.es-DuThAI6u.js";import"./Fingerprint.es-a52JDt2Q.js";import"./CaretUp.es-CYK8cpGg.js";import"./CaretRight.es-B3hFfvz_.js";import"./ArrowLeft.es-CZcTzWfI.js";import"./UnifiedPageHeader-Cbwye_R6.js";const fe={DEFAULT_DAYS:365};function Xe(){const{isMobile:a}=se(),{showSuccess:x,showError:c,showConfirm:z}=ne(),{canWrite:m,canDelete:y}=ye(),[C,A]=ae(),{modals:v,open:g,close:f}=Ce(["upload","sign"]),[o,q]=n.useState([]),[B,F]=n.useState(!0),[V,K]=n.useState([]),[u,p]=n.useState(null),[b,H]=n.useState(""),[M,Y]=n.useState(fe.DEFAULT_DAYS),[h,O]=n.useState(""),[be,Re]=n.useState(1),[we,Ne]=n.useState(25);n.useEffect(()=>{R(),C.get("action")==="upload"&&(g("upload"),C.delete("action"),A(C))},[]);const R=async()=>{try{F(!0);const[t,s]=await Promise.all([j.getAll(),Se.getAll()]);q(t.data||[]),K(s.data||s.cas||[])}catch{c("Failed to load CSRs")}finally{F(!1)}},W=async t=>{try{const s=await j.getById(t.id),r=ce(s);p({...r})}catch{p(t)}},G=async t=>{try{const r=await t[0].text();await j.upload(r),x("CSR uploaded successfully"),f("upload"),R()}catch(s){c(s.message||"Failed to upload CSR")}},J=async()=>{if(!b){c("Please select a CA");return}try{await j.sign(u.id,b,M),x("CSR signed successfully"),f("sign"),R(),p(null)}catch(t){c(t.message||"Failed to sign CSR")}},$=async t=>{if(await z("Are you sure you want to delete this CSR?",{title:"Delete CSR",confirmText:"Delete",variant:"danger"}))try{await j.delete(t),x("CSR deleted successfully"),R(),p(null)}catch(r){c(r.message||"Failed to delete CSR")}},E=async t=>{try{const s=await j.download(t),r=URL.createObjectURL(s),l=document.createElement("a");l.href=r,l.download="csr.pem",l.click(),x("CSR downloaded")}catch(s){c(s.message||"Failed to download CSR")}},Q=n.useMemo(()=>{let t=o.map(s=>({...s,cn:s.common_name||s.subject||"Unnamed CSR"}));return h&&(t=t.filter(s=>s.status===h)),t},[o,h]),X=n.useMemo(()=>{const t=o.filter(l=>l.status==="pending"||!l.status).length,s=o.filter(l=>l.status==="signed").length,r=o.filter(l=>l.status==="rejected").length;return[{icon:ie,label:"Pending",value:t,variant:"warning"},{icon:le,label:"Signed",value:s,variant:"success"},{icon:oe,label:"Rejected",value:r,variant:"danger"},{icon:S,label:"Total",value:o.length,variant:"primary"}]},[o]),Z=n.useMemo(()=>[{key:"cn",header:"Common Name",priority:1,render:(t,s)=>e.jsxs("div",{className:"flex items-center gap-2",children:[e.jsx(S,{size:16,className:"text-accent-primary shrink-0"}),e.jsx("span",{className:"font-medium truncate",children:t})]})},{key:"status",header:"Status",priority:2,render:t=>e.jsx(k,{variant:t==="signed"?"success":t==="rejected"?"danger":"warning",size:"sm",children:t||"pending"})},{key:"created_at",header:"Created",priority:3,hideOnMobile:!0,render:t=>e.jsx("span",{className:"text-xs text-text-secondary whitespace-nowrap",children:N(t)})},{key:"key_algorithm",header:"Key",priority:4,hideOnMobile:!0,render:(t,s)=>e.jsxs("span",{className:"text-xs font-mono text-text-secondary",children:[t||"RSA"," ",s.key_size?`(${s.key_size})`:""]})}],[]);n.useMemo(()=>[{key:"status",label:"Status",type:"select",value:h,onChange:O,placeholder:"All Status",options:[{value:"pending",label:"Pending"},{value:"signed",label:"Signed"},{value:"rejected",label:"Rejected"}]}],[h]);const ee=n.useCallback(t=>[{label:"Download",icon:L,onClick:()=>E(t.id)},...m("csrs")&&(!t.status||t.status==="pending")?[{label:"Sign",icon:U,onClick:()=>{p(t),g("sign")}}]:[],...y("csrs")?[{label:"Delete",icon:T,variant:"danger",onClick:()=>$(t.id)}]:[]],[m,y]),te=e.jsxs("div",{className:"space-y-3",children:[e.jsx(D,{title:"About CSRs",variant:"info",children:"A Certificate Signing Request contains the public key and identity information needed to issue a certificate."}),e.jsx(D,{title:"Status Legend",variant:"info",children:e.jsxs("div",{className:"space-y-1 mt-2",children:[e.jsxs("div",{className:"flex items-center gap-2",children:[e.jsx(k,{variant:"warning",size:"sm",children:"Pending"}),e.jsx("span",{className:"text-xs",children:"Awaiting signature"})]}),e.jsxs("div",{className:"flex items-center gap-2",children:[e.jsx(k,{variant:"success",size:"sm",children:"Signed"}),e.jsx("span",{className:"text-xs",children:"Certificate issued"})]})]})}),e.jsx(D,{title:"Workflow",variant:"tip",children:"1. Upload CSR → 2. Review details → 3. Sign with CA → 4. Download certificate"})]});return e.jsxs(e.Fragment,{children:[e.jsx(je,{title:"Certificate Signing Requests",subtitle:`${o.length} request${o.length!==1?"s":""}`,icon:S,stats:X,helpContent:te,splitView:!0,splitEmptyContent:e.jsxs("div",{className:"h-full flex flex-col items-center justify-center p-6 text-center",children:[e.jsx("div",{className:"w-14 h-14 rounded-xl bg-bg-tertiary flex items-center justify-center mb-3",children:e.jsx(S,{size:24,className:"text-text-tertiary"})}),e.jsx("p",{className:"text-sm text-text-secondary",children:"Select a CSR to view details"})]}),slideOverOpen:!!u,onSlideOverClose:()=>p(null),slideOverTitle:"CSR Details",slideOverContent:u&&e.jsx(ve,{csr:u,canWrite:m,canDelete:y,onSign:()=>g("sign"),onDownload:()=>E(u.id),onDelete:()=>$(u.id)}),children:e.jsx(he,{data:Q,columns:Z,loading:B,selectedId:u?.id,onRowClick:t=>t?W(t):p(null),rowActions:ee,searchable:!0,searchPlaceholder:"Search CSRs...",searchKeys:["cn","common_name","subject","organization"],toolbarFilters:[{key:"status",value:h,onChange:O,placeholder:"All Status",options:[{value:"pending",label:"Pending"},{value:"signed",label:"Signed"},{value:"rejected",label:"Rejected"}]}],toolbarActions:m("csrs")&&(a?e.jsx(d,{size:"lg",onClick:()=>g("upload"),className:"w-11 h-11 p-0",children:e.jsx(_,{size:22,weight:"bold"})}):e.jsxs(d,{size:"sm",onClick:()=>g("upload"),children:[e.jsx(_,{size:14,weight:"bold"}),"Upload"]})),sortable:!0,emptyIcon:S,emptyTitle:"No CSRs",emptyDescription:"Upload a CSR to get started",emptyAction:m("csrs")&&e.jsxs(d,{onClick:()=>g("upload"),children:[e.jsx(_,{size:16})," Upload CSR"]})})}),e.jsx(I,{open:v.upload,onOpenChange:()=>f("upload"),title:"Upload CSR",children:e.jsxs("div",{className:"p-4 space-y-4",children:[e.jsx("p",{className:"text-sm text-text-secondary",children:"Upload a Certificate Signing Request file (.pem, .csr)"}),e.jsx(pe,{accept:".pem,.csr",onUpload:G,maxSize:1024*1024})]})}),e.jsx(I,{open:v.sign,onOpenChange:()=>f("sign"),title:"Sign CSR",children:e.jsxs("div",{className:"p-4 space-y-4",children:[e.jsx("p",{className:"text-sm text-text-secondary",children:"Sign this CSR with a Certificate Authority to issue a certificate"}),e.jsx(ue,{label:"Certificate Authority",options:V.map(t=>({value:t.id,label:t.descr||t.name||t.common_name})),value:b,onChange:H,placeholder:"Select CA..."}),e.jsx(re,{label:"Validity Period (days)",type:"number",value:M,onChange:t=>Y(parseInt(t.target.value)),min:"1",max:"3650"}),e.jsxs("div",{className:"flex justify-end gap-2 pt-4 border-t border-border",children:[e.jsx(d,{variant:"secondary",onClick:()=>f("sign"),children:"Cancel"}),e.jsxs(d,{onClick:J,disabled:!b,children:[e.jsx(U,{size:16})," Sign CSR"]})]})]})})]})}function ve({csr:a,canWrite:x,canDelete:c,onSign:z,onDownload:m,onDelete:y}){const C=a.status==="signed"?"success":a.status==="rejected"?"danger":"warning";return e.jsxs("div",{className:"p-3 space-y-3",children:[e.jsx(xe,{icon:S,iconClass:"bg-accent-primary/20",title:a.common_name||a.cn||"Unnamed CSR",subtitle:a.organization,badge:e.jsx(k,{variant:C,size:"sm",children:a.status||"pending"})}),e.jsx(ge,{stats:[{icon:me,value:a.created_at?N(a.created_at,"short"):"—"},{icon:de,value:`${a.key_algorithm||"RSA"} ${a.key_size||""}`}]}),e.jsxs("div",{className:"flex gap-2",children:[e.jsxs(d,{size:"sm",variant:"secondary",className:"flex-1",onClick:m,children:[e.jsx(L,{size:14})," Download"]}),x("csrs")&&(!a.status||a.status==="pending")&&e.jsxs(d,{size:"sm",onClick:z,children:[e.jsx(U,{size:14})," Sign"]}),c("csrs")&&e.jsx(d,{size:"sm",variant:"danger",onClick:y,children:e.jsx(T,{size:14})})]}),e.jsx(w,{title:"Subject",children:e.jsxs(P,{children:[e.jsx(i,{label:"Common Name",value:a.common_name||a.cn,className:"col-span-2"}),e.jsx(i,{label:"Organization",value:a.organization}),e.jsx(i,{label:"Org Unit",value:a.organizational_unit}),e.jsx(i,{label:"Country",value:a.country}),e.jsx(i,{label:"State",value:a.state}),e.jsx(i,{label:"Locality",value:a.locality}),e.jsx(i,{label:"Email",value:a.email})]})}),e.jsx(w,{title:"Key Information",children:e.jsxs(P,{children:[e.jsx(i,{label:"Algorithm",value:a.key_algorithm||"RSA"}),e.jsx(i,{label:"Key Size",value:a.key_size}),e.jsx(i,{label:"Signature",value:a.signature_algorithm})]})}),(a.san||a.subject_alternative_names)&&e.jsx(w,{title:"Subject Alternative Names",children:e.jsx("div",{className:"text-xs text-text-secondary space-y-1",children:(a.san||a.subject_alternative_names||[]).map((A,v)=>e.jsx("div",{className:"font-mono bg-bg-tertiary px-2 py-1 rounded",children:A},v))})}),e.jsx(w,{title:"Timeline",children:e.jsxs(P,{children:[e.jsx(i,{label:"Created",value:a.created_at?N(a.created_at):"—"}),a.signed_at&&e.jsx(i,{label:"Signed",value:N(a.signed_at)})]})})]})}export{Xe as default};

import{j as e}from"./radix-B6Y-MRu0.js";import{a as i}from"./vendor-DEQSVNfj.js";import{m as N}from"./ArrowsClockwise.es-DS70dwCP.js";import{n as se,e as ae,b as R,c as U,d as c,s as q}from"./DetailCard-BKBzFg8i.js";import{b as re}from"./Globe.es-CtUoIY1T.js";import{s as ie}from"./Download.es-Bp_lE9WD.js";import{c as ne,h as ce,r as d,j as F,f,C as I,B as m,t as le,L as oe,a as S}from"./index-vswyqp58.js";import{c as de}from"./Link.es-DqHpjeM6.js";import{i as _}from"./Pulse.es-DcGwjDre.js";import{B as L}from"./Badge-CZ5NzBfK.js";import{H as w}from"./HelpCard-BINCqYIf.js";import{S as xe}from"./StatusIndicator-59tXXk5o.js";import{R as me}from"./ResponsiveDataTable-kYvH3TtM.js";import{R as ue}from"./ResponsiveLayout-BgG2EW8C.js";import{c as pe}from"./cas.service-CAbj5j2-.js";import{c as he}from"./crl.service-Z976FtHj.js";import{u as je}from"./usePermission-B5db8pNS.js";import"./CaretDown.es-DuThAI6u.js";import"./Fingerprint.es-a52JDt2Q.js";import"./CaretUp.es-CYK8cpGg.js";import"./CaretRight.es-B3hFfvz_.js";import"./ArrowLeft.es-CZcTzWfI.js";import"./UnifiedPageHeader-Cbwye_R6.js";const u={...he,regenerate:g=>S.post(`/crl/${g}/regenerate`),getOcspStatus:()=>S.get("/ocsp/status"),getOcspStats:()=>S.get("/ocsp/stats")};function Te(){const{showSuccess:g,showError:k,showInfo:E}=ne(),{canWrite:T}=je(),[H,A]=i.useState(!0),[p,B]=i.useState([]),[o,M]=i.useState([]),[a,O]=i.useState(null),[r,b]=i.useState(null),[n,W]=i.useState({enabled:!1,running:!1}),[x,G]=i.useState({total_requests:0,cache_hits:0}),[v,z]=i.useState(!1),[h,fe]=i.useState("");i.useEffect(()=>{j()},[]);const j=async()=>{A(!0);try{const[t,s,l,te]=await Promise.all([pe.getAll(),u.getAll(),u.getOcspStatus(),u.getOcspStats()]);B(t.data||[]),M(s.data||[]),W(l.data||{enabled:!1,running:!1}),G(te.data||{total_requests:0,cache_hits:0})}catch(t){k(t.message||"Failed to load CRL/OCSP data")}finally{A(!1)}},$=async t=>{try{const s=await u.getForCA(t);b(s.data||null)}catch{b(null)}},Q=t=>{O(t),$(t.id)},K=async()=>{if(a){z(!0);try{await u.regenerate(a.id),g("CRL regenerated successfully"),$(a.id),j()}catch(t){k(t.message||"Failed to regenerate CRL")}finally{z(!1)}}},V=()=>{if(!r?.crl_pem)return;const t=new Blob([r.crl_pem],{type:"application/x-pem-file"}),s=URL.createObjectURL(t),l=document.createElement("a");l.href=s,l.download=`${a?.descr||"crl"}.crl`,l.click(),URL.revokeObjectURL(s)},P=t=>{navigator.clipboard.writeText(t),E("Copied to clipboard")},y=o.reduce((t,s)=>t+(s.revoked_count||0),0),D=x.total_requests>0?Math.round(x.cache_hits/x.total_requests*100):0,C=i.useMemo(()=>p.map(t=>{const s=o.find(l=>l.ca_id===t.id||l.caref===t.refid);return{...t,crl_number:s?.crl_number,revoked_count:s?.revoked_count||0,crl_updated:s?.updated_at,crl_next_update:s?.next_update,has_crl:!!s}}),[p,o]),J=i.useMemo(()=>h?C.filter(t=>t.descr?.toLowerCase().includes(h.toLowerCase())||t.name?.toLowerCase().includes(h.toLowerCase())):C,[C,h]),X=i.useMemo(()=>[{icon:ce,label:"CAs",value:p.length},{icon:d,label:"CRLs",value:o.length,variant:"info"},{icon:F,label:"Revoked",value:y,variant:"danger"},{icon:_,label:"OCSP",value:n.running?"Online":"Offline",variant:n.running?"success":"warning"}],[p.length,o.length,y,n.running]),Y=i.useMemo(()=>[{key:"descr",label:"CA Name",render:(t,s)=>e.jsxs("div",{className:"flex items-center gap-2",children:[e.jsx(d,{size:14,className:s.has_crl?"status-success-text":"text-text-tertiary"}),e.jsx("span",{className:"font-medium",children:t||s.name})]})},{key:"has_crl",label:"Status",width:"100px",render:(t,s)=>e.jsx(L,{variant:t?"success":"secondary",size:"sm",children:t?"Active":"No CRL"})},{key:"revoked_count",label:"Revoked",width:"80px",render:t=>e.jsx("span",{className:t>0?"status-danger-text font-medium":"text-text-secondary",children:t||0})},{key:"crl_updated",label:"Updated",width:"120px",render:t=>e.jsx("span",{className:"text-text-secondary text-xs",children:t?f(t,"short"):"-"})}],[]);i.useCallback((t,s)=>e.jsx("div",{className:`p-4 ${s?"mobile-row-selected":""}`,children:e.jsx("div",{className:"flex items-center justify-between gap-3",children:e.jsxs("div",{className:"flex items-center gap-3 flex-1 min-w-0",children:[e.jsx("div",{className:`w-10 h-10 rounded-lg flex items-center justify-center ${t.has_crl?"status-success-bg":"bg-bg-tertiary"}`,children:e.jsx(d,{size:20,className:t.has_crl?"status-success-text":"text-text-tertiary"})}),e.jsxs("div",{className:"flex-1 min-w-0",children:[e.jsxs("div",{className:"flex items-center gap-2",children:[e.jsx("span",{className:"font-medium text-text-primary truncate",children:t.descr||t.name}),e.jsx(L,{variant:t.has_crl?"success":"secondary",size:"sm",children:t.has_crl?"Active":"No CRL"})]}),e.jsx("div",{className:"flex items-center gap-2 text-xs text-text-secondary mt-0.5",children:t.has_crl?e.jsxs(e.Fragment,{children:[e.jsxs("span",{children:[t.revoked_count||0," revoked"]}),e.jsx("span",{children:"â€¢"}),e.jsxs("span",{children:["CRL #",t.crl_number||"-"]})]}):e.jsx("span",{children:t.has_private_key===!1?"Read-only (no key)":"Not generated"})})]})]})})}),[]);const Z=e.jsxs("div",{className:"p-4 space-y-4",children:[e.jsxs(I,{className:"p-4 space-y-3 bg-gradient-to-br from-accent-primary/5 to-transparent",children:[e.jsxs("h3",{className:"text-sm font-semibold text-text-primary flex items-center gap-2",children:[e.jsx(re,{size:16,className:"text-accent-primary"}),"CRL Statistics"]}),e.jsxs("div",{className:"grid grid-cols-2 gap-3",children:[e.jsxs("div",{className:"text-center p-3 bg-bg-tertiary rounded-lg",children:[e.jsx("p",{className:"text-2xl font-bold text-text-primary",children:o.length}),e.jsx("p",{className:"text-xs text-text-secondary",children:"Active CRLs"})]}),e.jsxs("div",{className:"text-center p-3 bg-bg-tertiary rounded-lg",children:[e.jsx("p",{className:"text-2xl font-bold text-status-error",children:y}),e.jsx("p",{className:"text-xs text-text-secondary",children:"Revoked Certs"})]})]})]}),e.jsxs(I,{className:`p-4 space-y-3 ${n.enabled?"stat-card-success":"stat-card-warning"}`,children:[e.jsxs("h3",{className:"text-sm font-semibold text-text-primary flex items-center gap-2",children:[e.jsx(_,{size:16,className:"text-accent-primary"}),"OCSP Responder"]}),e.jsxs("div",{className:"space-y-2",children:[e.jsxs("div",{className:"flex items-center justify-between",children:[e.jsx("span",{className:"text-sm text-text-secondary",children:"Status"}),e.jsx(xe,{status:n.enabled&&n.running?"success":"warning",children:n.enabled?n.running?"Running":"Stopped":"Disabled"})]}),e.jsxs("div",{className:"flex items-center justify-between",children:[e.jsx("span",{className:"text-sm text-text-secondary",children:"Total Requests"}),e.jsx("span",{className:"text-sm font-medium text-text-primary",children:x.total_requests})]}),e.jsxs("div",{className:"flex items-center justify-between",children:[e.jsx("span",{className:"text-sm text-text-secondary",children:"Cache Hit Rate"}),e.jsxs("span",{className:"text-sm font-medium text-text-primary",children:[D,"%"]})]})]})]}),e.jsxs("div",{className:"space-y-3",children:[e.jsx(w,{variant:"info",title:"About CRLs",children:"Certificate Revocation Lists (CRLs) contain serial numbers of revoked certificates. They are periodically published and cached by clients for offline verification."}),e.jsx(w,{variant:"tip",title:"OCSP vs CRL",children:"OCSP provides real-time revocation status checks. CRL is a periodic snapshot. Enable both for maximum compatibility with all clients and applications."}),e.jsx(w,{variant:"warning",title:"Distribution Points",children:"Include CDP (CRL Distribution Point) and AIA (Authority Information Access) URLs in your CA settings to enable automatic revocation checking."})]})]}),ee=a&&e.jsxs("div",{className:"p-4 space-y-4",children:[e.jsxs("div",{className:"flex items-start justify-between gap-3 pb-3 border-b border-border",children:[e.jsxs("div",{className:"flex items-center gap-3",children:[e.jsx("div",{className:"w-10 h-10 rounded-lg status-primary-bg flex items-center justify-center",children:e.jsx(d,{size:20,className:"text-accent-primary",weight:"duotone"})}),e.jsxs("div",{children:[e.jsx("h3",{className:"text-sm font-semibold text-text-primary",children:a.descr||a.name}),e.jsx("p",{className:"text-xs text-text-secondary",children:"CRL & OCSP Configuration"})]})]}),e.jsx(L,{variant:r?"success":"secondary",size:"sm",children:r?"Active":"No CRL"})]}),e.jsxs("div",{className:"grid grid-cols-3 gap-2",children:[e.jsxs("div",{className:"bg-bg-tertiary/40 rounded-lg p-2 text-center",children:[e.jsx(se,{size:14,className:"mx-auto text-text-tertiary mb-1"}),e.jsx("div",{className:"text-sm font-semibold text-text-primary",children:r?.crl_number||"-"}),e.jsx("div",{className:"text-[10px] text-text-tertiary",children:"CRL #"})]}),e.jsxs("div",{className:"bg-bg-tertiary/40 rounded-lg p-2 text-center",children:[e.jsx(F,{size:14,className:"mx-auto text-text-tertiary mb-1"}),e.jsx("div",{className:"text-sm font-semibold text-text-primary",children:r?.revoked_count||0}),e.jsx("div",{className:"text-[10px] text-text-tertiary",children:"Revoked"})]}),e.jsxs("div",{className:"bg-bg-tertiary/40 rounded-lg p-2 text-center",children:[e.jsx(ae,{size:14,className:"mx-auto text-text-tertiary mb-1"}),e.jsx("div",{className:"text-sm font-semibold text-text-primary",children:r?.updated_at?f(r.updated_at,"short"):"-"}),e.jsx("div",{className:"text-[10px] text-text-tertiary",children:"Updated"})]})]}),e.jsxs("div",{className:"flex gap-2",children:[T("certificates")&&a.has_private_key!==!1&&e.jsxs(m,{size:"sm",variant:"primary",onClick:K,disabled:v,className:"flex-1",children:[e.jsx(N,{size:14,className:v?"animate-spin":""}),v?"Regenerating...":"Regenerate CRL"]}),r?.crl_pem&&e.jsxs(m,{size:"sm",variant:"secondary",onClick:V,children:[e.jsx(ie,{size:14}),"Download"]})]}),e.jsx(R,{title:"CRL Configuration",icon:le,children:e.jsxs(U,{cols:2,children:[e.jsx(c,{label:"CA Name",value:a.descr||a.name}),e.jsx(c,{label:"Status",value:r?"Active":"Not Generated"}),e.jsx(c,{label:"CRL Number",value:r?.crl_number||"-"}),e.jsx(c,{label:"Revoked Count",value:r?.revoked_count||0}),e.jsx(c,{label:"Last Updated",value:r?.updated_at?f(r.updated_at):"-"}),e.jsx(c,{label:"Next Update",value:r?.next_update?f(r.next_update):"-"})]})}),e.jsx(R,{title:"OCSP Configuration",icon:_,children:e.jsxs(U,{cols:2,children:[e.jsx(c,{label:"Status",value:n.enabled?n.running?"Running":"Stopped":"Disabled"}),e.jsx(c,{label:"Total Requests",value:x.total_requests}),e.jsx(c,{label:"Cache Hits",value:x.cache_hits}),e.jsx(c,{label:"Hit Rate",value:`${D}%`})]})}),e.jsx(R,{title:"Distribution Points",icon:de,children:e.jsxs("div",{className:"space-y-3",children:[e.jsxs("div",{children:[e.jsx("p",{className:"text-xs text-text-secondary mb-1",children:"CDP (CRL Distribution Point)"}),e.jsxs("div",{className:"flex items-center gap-2",children:[e.jsx("code",{className:"flex-1 text-xs font-mono text-text-primary bg-bg-tertiary p-2 rounded break-all",children:`${window.location.origin}/crl/${a.refid}.crl`}),e.jsx(m,{size:"sm",variant:"ghost",onClick:()=>P(`${window.location.origin}/crl/${a.refid}.crl`),children:e.jsx(q,{size:14})})]})]}),e.jsxs("div",{children:[e.jsx("p",{className:"text-xs text-text-secondary mb-1",children:"AIA (OCSP Responder)"}),e.jsxs("div",{className:"flex items-center gap-2",children:[e.jsx("code",{className:"flex-1 text-xs font-mono text-text-primary bg-bg-tertiary p-2 rounded break-all",children:`${window.location.origin}/ocsp/${a.refid}`}),e.jsx(m,{size:"sm",variant:"ghost",onClick:()=>P(`${window.location.origin}/ocsp/${a.refid}`),children:e.jsx(q,{size:14})})]})]}),e.jsx("p",{className:"text-xs text-text-tertiary",children:"Include these URLs in CA settings for automatic revocation checking."})]})})]});return H?e.jsx("div",{className:"flex items-center justify-center h-full",children:e.jsx(oe,{})}):e.jsx(ue,{title:"CRL & OCSP",icon:d,subtitle:`${o.length} active CRLs`,stats:X,helpContent:Z,splitView:!0,splitEmptyContent:e.jsxs("div",{className:"h-full flex flex-col items-center justify-center p-6 text-center",children:[e.jsx("div",{className:"w-14 h-14 rounded-xl bg-bg-tertiary flex items-center justify-center mb-3",children:e.jsx(d,{size:24,className:"text-text-tertiary"})}),e.jsx("p",{className:"text-sm text-text-secondary",children:"Select a CA to manage CRLs"})]}),slideOverOpen:!!a,onSlideOverClose:()=>{O(null),b(null)},slideOverTitle:"CRL Details",slideOverContent:ee,slideOverWidth:"md",children:e.jsx(me,{data:J,columns:Y,keyField:"id",searchable:!0,searchPlaceholder:"Search CAs...",searchKeys:["name","common_name","cn"],toolbarActions:e.jsxs(e.Fragment,{children:[e.jsx(m,{variant:"secondary",size:"sm",onClick:j,className:"hidden md:inline-flex",children:e.jsx(N,{size:14})}),e.jsx(m,{variant:"secondary",size:"lg",onClick:j,className:"md:hidden h-11 w-11 p-0",children:e.jsx(N,{size:22})})]}),selectedId:a?.id,onRowClick:Q,sortable:!0,emptyState:{icon:d,title:"No Certificate Authorities",description:"Create a CA first to manage CRLs"}})})}export{Te as default};

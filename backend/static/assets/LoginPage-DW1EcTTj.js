import{j as e}from"./radix-B6Y-MRu0.js";import{e as H,a as h}from"./vendor-DEQSVNfj.js";import{s as J}from"./ArrowLeft.es-CZcTzWfI.js";import{a as f,w as G,c as V,C as Y,D as q,n as W,E as P,L as S,I as _,B as T,h as $,k as B}from"./index-vswyqp58.js";import{p as C}from"./Fingerprint.es-a52JDt2Q.js";class Q{async detectMethods(r=null){return r?(await f.post("/auth/methods",{username:r})).data:(await f.get("/auth/methods")).data}async loginPassword(r,n){return(await f.post("/auth/login/password",{username:r,password:n})).data}async loginMTLS(){return(await f.post("/auth/login/mtls",{})).data}async startWebAuthn(r){return(await f.post("/auth/login/webauthn/start",{username:r})).data}async verifyWebAuthn(r,n){return(await f.post("/auth/login/webauthn/verify",{username:r,response:n})).data}isWebAuthnSupported(){return window.PublicKeyCredential!==void 0&&navigator.credentials!==void 0}async authenticateWebAuthn(r){if(!this.isWebAuthnSupported())throw new Error("WebAuthn not supported by this browser");const{options:n}=await this.startWebAuthn(r),i={...n,timeout:1e4,challenge:this.base64urlToBuffer(n.challenge),allowCredentials:n.allowCredentials?.map(a=>({...a,id:this.base64urlToBuffer(a.id)}))},m=new AbortController,l=setTimeout(()=>m.abort(),12e3);let s;try{s=await navigator.credentials.get({publicKey:i,signal:m.signal})}finally{clearTimeout(l)}if(!s)throw new Error("No credential returned from authenticator");const y={id:s.id,rawId:this.bufferToBase64url(s.rawId),type:s.type,response:{authenticatorData:this.bufferToBase64url(s.response.authenticatorData),clientDataJSON:this.bufferToBase64url(s.response.clientDataJSON),signature:this.bufferToBase64url(s.response.signature),userHandle:s.response.userHandle?this.bufferToBase64url(s.response.userHandle):null}};return await this.verifyWebAuthn(r,y)}base64urlToBuffer(r){const n="=".repeat((4-r.length%4)%4),i=r.replace(/-/g,"+").replace(/_/g,"/")+n,m=atob(i),l=new Uint8Array(m.length);for(let s=0;s<m.length;s++)l[s]=m.charCodeAt(s);return l.buffer}bufferToBase64url(r){const n=new Uint8Array(r);let i="";for(let l=0;l<n.length;l++)i+=String.fromCharCode(n[l]);return btoa(i).replace(/\+/g,"-").replace(/\//g,"_").replace(/=/g,"")}}const g=new Q,k="ucm_last_username";function ae(){const j=H(),{login:r}=G(),{showError:n,showSuccess:i,showInfo:m}=V(),l=h.useRef(null),[s,y]=h.useState("username"),[a,v]=h.useState(""),[w,A]=h.useState(""),[o,b]=h.useState(!1),[c,x]=h.useState(null),[p,U]=h.useState(null),[E,d]=h.useState(""),[F,I]=h.useState(!1);h.useEffect(()=>{const t=localStorage.getItem(k);t&&(v(t),I(!0))},[]),h.useEffect(()=>{c==="password"&&s==="auth"&&l.current&&l.current.focus()},[c,s]);const N=t=>{t&&localStorage.setItem(k,t)},M=async t=>{if(t?.preventDefault(),!a.trim()){n("Please enter your username");return}b(!0),d("Checking authentication methods...");try{N(a);const u=await g.detectMethods(a);if(U(u),y("auth"),u.mtls&&u.mtls_status==="enrolled"){x("mtls"),d("Verifying client certificate..."),await K();return}if(u.webauthn&&u.webauthn_credentials>0&&g.isWebAuthnSupported()){x("webauthn"),d("Waiting for security key..."),await z();return}x("password"),d("")}catch(u){console.error("Auth detection failed:",u),y("auth"),x("password"),U({password:!0}),d("")}finally{b(!1)}},K=async()=>{try{const t=await g.loginMTLS();N(t.user.username),await r(t.user.username,null,t),i(`Welcome back, ${t.user.username}!`),j("/dashboard")}catch{p?.webauthn&&p.webauthn_credentials>0&&g.isWebAuthnSupported()?(x("webauthn"),d("Waiting for security key..."),await z()):(x("password"),d(""),b(!1))}},z=async()=>{try{d("Touch your security key...");const t=await g.authenticateWebAuthn(a);N(a),await r(a,null,t),i(`Welcome back, ${a}!`),j("/dashboard")}catch(t){x("password"),d(""),b(!1),(t.message?.includes("cancelled")||t.message?.includes("abort"))&&m("Security key cancelled. Use password instead.")}},L=async()=>{b(!0),await z()},O=async t=>{if(t.preventDefault(),!w){n("Please enter your password");return}b(!0),d("Signing in...");try{const u=await g.loginPassword(a,w);N(a),await r(a,w,u),i(`Welcome back, ${a}!`),j("/dashboard")}catch(u){n(u.message||"Invalid credentials"),A("")}finally{b(!1),d("")}},D=()=>{y("username"),x(null),A(""),d("")},R=()=>{v(""),localStorage.removeItem(k),D()};return e.jsx("div",{className:"min-h-screen flex items-center justify-center bg-gradient-to-br from-bg-primary via-bg-secondary to-bg-tertiary p-4",children:e.jsxs(Y,{className:"w-full max-w-md p-8 space-y-6",children:[e.jsx("div",{className:"flex justify-center mb-2",children:e.jsx(q,{variant:"horizontal",size:"lg"})}),e.jsxs("div",{className:"text-center",children:[e.jsx("h1",{className:"text-2xl font-bold text-text-primary mb-2",children:s==="username"?a?"Welcome Back":"Sign In":"Welcome Back"}),e.jsx("p",{className:"text-sm text-text-secondary",children:s==="username"?a?"Click to continue to your account":"Enter your username to continue":E||(c==="password"?"Enter your password to continue":"Choose how to authenticate")})]}),s==="username"&&e.jsx("div",{className:"space-y-4",children:F&&a?e.jsxs(e.Fragment,{children:[e.jsxs("button",{onClick:M,disabled:o,className:"w-full text-left relative overflow-hidden rounded-xl border border-border bg-gradient-to-br from-bg-secondary to-bg-tertiary p-4 hover:border-accent/50 hover:shadow-lg transition-all group",children:[e.jsx("div",{className:"absolute top-0 right-0 w-24 h-24 bg-accent/5 rounded-full -translate-y-1/2 translate-x-1/2 group-hover:bg-accent/10 transition-colors"}),e.jsxs("div",{className:"flex items-center gap-3",children:[e.jsx("div",{className:"w-12 h-12 rounded-full bg-gradient-to-br from-accent to-accent/70 flex items-center justify-center shadow-lg group-hover:scale-105 transition-transform",children:e.jsx(W,{size:24,className:"text-white",weight:"bold"})}),e.jsxs("div",{className:"flex-1 min-w-0",children:[e.jsx("p",{className:"text-xs text-text-secondary uppercase tracking-wider font-medium",children:"Continue as"}),e.jsx("p",{className:"text-lg font-semibold text-text-primary truncate",children:a})]}),e.jsx("div",{className:"text-accent group-hover:translate-x-1 transition-transform",children:e.jsx(P,{size:24,weight:"bold"})})]}),o&&e.jsx("div",{className:"absolute inset-0 bg-bg-primary/50 flex items-center justify-center rounded-xl",children:e.jsx(S,{size:"md"})})]}),e.jsx("button",{onClick:()=>{v(""),I(!1),localStorage.removeItem(k)},className:"w-full text-sm text-text-secondary hover:text-accent transition-colors py-2",disabled:o,children:"Use a different account"})]}):e.jsxs("form",{onSubmit:M,className:"space-y-4",children:[e.jsx(_,{label:"Username",type:"text",value:a,onChange:t=>v(t.target.value),placeholder:"Enter your username",disabled:o,autoComplete:"username",autoFocus:!0,icon:e.jsx(W,{size:18})}),e.jsx(T,{type:"submit",className:"w-full",disabled:o||!a.trim(),children:o?e.jsxs(e.Fragment,{children:[e.jsx(S,{size:"sm"}),e.jsx("span",{children:"Checking..."})]}):e.jsxs(e.Fragment,{children:[e.jsx("span",{children:"Continue"}),e.jsx(P,{size:18,weight:"bold"})]})})]})}),s==="auth"&&e.jsxs("div",{className:"space-y-5",children:[e.jsxs("div",{className:"relative overflow-hidden rounded-xl border border-border bg-gradient-to-br from-bg-secondary to-bg-tertiary p-4",children:[e.jsx("div",{className:"absolute top-0 right-0 w-24 h-24 bg-accent/5 rounded-full -translate-y-1/2 translate-x-1/2"}),e.jsxs("div",{className:"flex items-center gap-3",children:[e.jsx("div",{className:"w-12 h-12 rounded-full bg-gradient-to-br from-accent to-accent/70 flex items-center justify-center shadow-lg",children:e.jsx(W,{size:24,className:"text-white",weight:"bold"})}),e.jsxs("div",{className:"flex-1 min-w-0",children:[e.jsx("p",{className:"text-xs text-text-secondary uppercase tracking-wider font-medium",children:"Signing in as"}),e.jsx("p",{className:"text-lg font-semibold text-text-primary truncate",children:a})]}),e.jsx("button",{onClick:R,className:"px-3 py-1.5 text-xs font-medium text-text-secondary hover:text-accent hover:bg-accent/10 rounded-lg transition-all",disabled:o,children:"Change"})]})]}),o&&(c==="mtls"||c==="webauthn")&&e.jsxs("div",{className:"flex flex-col items-center gap-4 py-6",children:[e.jsxs("div",{className:"relative",children:[e.jsx(S,{size:"lg"}),c==="mtls"&&e.jsx($,{size:24,className:"absolute inset-0 m-auto text-accent"}),c==="webauthn"&&e.jsx(C,{size:24,className:"absolute inset-0 m-auto text-accent"})]}),e.jsx("p",{className:"text-sm text-text-secondary animate-pulse",children:E})]}),c==="webauthn"&&!o&&e.jsxs("div",{className:"space-y-3",children:[e.jsxs(T,{onClick:L,className:"w-full",variant:"secondary",disabled:o,children:[e.jsx(C,{size:20,weight:"fill"}),e.jsx("span",{children:"Try Security Key Again"})]}),e.jsx("button",{onClick:()=>x("password"),className:"w-full text-sm text-text-secondary hover:text-accent transition-colors py-2",children:"Use password instead"})]}),c==="password"&&e.jsxs("form",{onSubmit:O,className:"space-y-4",children:[e.jsx("input",{type:"text",name:"username",autoComplete:"username",value:a,readOnly:!0,className:"sr-only",tabIndex:-1}),e.jsx(_,{ref:l,label:"Password",type:"password",value:w,onChange:t=>A(t.target.value),placeholder:"Enter your password",disabled:o,autoComplete:"current-password",autoFocus:!0,icon:e.jsx(B,{size:18})}),e.jsx(T,{type:"submit",className:"w-full",disabled:o||!w,children:o?e.jsxs(e.Fragment,{children:[e.jsx(S,{size:"sm"}),e.jsx("span",{children:"Signing in..."})]}):e.jsxs(e.Fragment,{children:[e.jsx(B,{size:18,weight:"fill"}),e.jsx("span",{children:"Sign In"})]})}),p?.webauthn&&p.webauthn_credentials>0&&g.isWebAuthnSupported()&&e.jsxs("button",{onClick:()=>{x("webauthn"),L()},className:"w-full text-sm text-text-secondary hover:text-accent transition-colors py-2 flex items-center justify-center gap-2",type:"button",disabled:o,children:[e.jsx(C,{size:16}),e.jsx("span",{children:"Use security key instead"})]})]}),e.jsxs("button",{onClick:D,className:"w-full text-sm text-text-secondary hover:text-text-primary transition-colors py-2 flex items-center justify-center gap-1",disabled:o,children:[e.jsx(J,{size:14}),e.jsx("span",{children:"Back"})]})]}),s==="auth"&&p&&e.jsxs("div",{className:"flex justify-center gap-2 pt-2",children:[p.mtls&&e.jsxs("div",{className:`flex items-center gap-1 px-2 py-1 rounded text-xs ${c==="mtls"?"bg-accent text-white":"bg-bg-secondary text-text-secondary"}`,children:[e.jsx($,{size:12,weight:"fill"}),e.jsx("span",{children:"mTLS"})]}),p.webauthn&&p.webauthn_credentials>0&&e.jsxs("div",{className:`flex items-center gap-1 px-2 py-1 rounded text-xs ${c==="webauthn"?"bg-accent text-white":"bg-bg-secondary text-text-secondary"}`,children:[e.jsx(C,{size:12,weight:"fill"}),e.jsx("span",{children:"Key"})]}),e.jsxs("div",{className:`flex items-center gap-1 px-2 py-1 rounded text-xs ${c==="password"?"bg-accent text-white":"bg-bg-secondary text-text-secondary"}`,children:[e.jsx(B,{size:12,weight:"fill"}),e.jsx("span",{children:"Password"})]})]}),e.jsx("div",{className:"text-center text-xs text-text-secondary pt-4 border-t border-border",children:e.jsx("p",{children:"Ultimate Certificate Manager v2"})})]})})}export{ae as default};

#!/bin/bash
#
# UCM Pre-commit Quality Checks
# Install: cp scripts/pre-commit .git/hooks/pre-commit && chmod +x .git/hooks/pre-commit
# Or: ln -sf ../../scripts/pre-commit .git/hooks/pre-commit
#
# Checks:
#   1. i18n locale sync (all 9 files have same keys)
#   2. Frontend tests (Vitest ‚Äî component smoke tests)
#   3. Backend tests (pytest ‚Äî API logic tests)
#   4. No 'icon: undefined' in navigation components
#

set -e

ROOT="$(git rev-parse --show-toplevel)"
RED='\033[0;31m'
GREEN='\033[0;32m'
YELLOW='\033[1;33m'
NC='\033[0m'
FAILED=0

echo "üîç UCM Pre-commit Checks"
echo "========================"

# ‚îÄ‚îÄ 1. i18n sync ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ
echo -n "  i18n sync check... "
if node "$ROOT/scripts/check-i18n-sync.js" > /tmp/ucm-i18n-check.log 2>&1; then
    echo -e "${GREEN}‚úÖ${NC}"
else
    echo -e "${RED}‚ùå${NC}"
    echo -e "${YELLOW}    $(tail -1 /tmp/ucm-i18n-check.log)${NC}"
    FAILED=1
fi

# ‚îÄ‚îÄ 2. Frontend unit tests ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ
echo -n "  Frontend tests... "
FRONT_OUT=$(cd "$ROOT/frontend" && npx vitest run --no-coverage 2>&1)
if echo "$FRONT_OUT" | grep -q "Tests.*passed"; then
    RESULT=$(echo "$FRONT_OUT" | grep "Tests" | tail -1)
    echo -e "${GREEN}‚úÖ${NC} $RESULT"
else
    echo -e "${RED}‚ùå${NC}"
    echo -e "${YELLOW}    Run 'cd frontend && npx vitest run' for details${NC}"
    FAILED=1
fi

# ‚îÄ‚îÄ 3. Backend tests ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ
echo -n "  Backend tests... "
if cd "$ROOT/backend" && python3 -m pytest tests/ -q --tb=no 2>&1 | tail -1 | grep -q "passed"; then
    RESULT=$(python3 -m pytest tests/ -q --tb=no 2>&1 | tail -1)
    echo -e "${GREEN}‚úÖ${NC} $RESULT"
else
    echo -e "${RED}‚ùå${NC}"
    echo -e "${YELLOW}    Run 'cd backend && python3 -m pytest tests/ -v' for details${NC}"
    FAILED=1
fi

# ‚îÄ‚îÄ 4. Quick grep checks ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ
echo -n "  No 'icon: undefined'... "
# Exclude test files from this check
if grep -rn "icon:\s*undefined" "$ROOT/frontend/src/" --include='*.jsx' --include='*.tsx' --include='*.js' \
    | grep -v '__tests__/' | grep -v '.test.' | grep -v '.spec.' 2>/dev/null; then
    echo -e "${RED}‚ùå Found 'icon: undefined' ‚Äî will cause React Error #130${NC}"
    FAILED=1
else
    echo -e "${GREEN}‚úÖ${NC}"
fi

echo "========================"
if [ $FAILED -ne 0 ]; then
    echo -e "${RED}‚ùå Pre-commit checks FAILED ‚Äî fix issues before committing${NC}"
    echo -e "   Use ${YELLOW}git commit --no-verify${NC} to bypass (not recommended)"
    exit 1
else
    echo -e "${GREEN}‚úÖ All checks passed${NC}"
fi
